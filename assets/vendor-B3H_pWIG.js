class Di{constructor(e,t){this.items=e||[],this._lastUniqueId=(t||0)+1}addItem(){let e;if(arguments.length===2){const t=arguments[0];if(e=arguments[1],this.items[t])throw"ID clash: '"+t+"'";return this.items[t]=e,t}else for(e=arguments[0]||{};;){const t=this._lastUniqueId++;if(!this.items[t])return this.items[t]=e,t}}removeItem(e){const t=this.items[e];return delete this.items[e],t}}const $c=new Di;class Og{constructor(e){this.id=e,this.parentItem=null,this.groups=[],this.menuElement=null,this.shown=!1,this.mouseOver=0}}class kg{constructor(){this.items=[]}}class Ng{constructor(e,t,i,s,o){this.id=e,this.getTitle=t,this.doAction=i,this.getEnabled=s,this.getShown=o,this.itemElement=null,this.subMenu=null,this.enabled=!0}}class NF{constructor(e={}){this._id=$c.addItem(),this._context=null,this._enabled=!1,this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={},this._shown=!1,this._nextId=0,this._eventSubs={},e.hideOnMouseDown!==!1&&(document.addEventListener("mousedown",t=>{t.target.classList.contains("xeokit-context-menu-item")||this.hide()}),document.addEventListener("touchstart",this._canvasTouchStartHandler=t=>{t.target.classList.contains("xeokit-context-menu-item")||this.hide()})),e.items&&(this.items=e.items),this._hideOnAction=e.hideOnAction!==!1,this.context=e.context,this.enabled=e.enabled!==!1,this.hide()}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let s=0,o=i.length;s<o;s++)i[s](t)}set items(e){this._clear(),this._itemsCfg=e||[],this._parseItems(e),this._createUI()}get items(){return this._itemsCfg}set enabled(e){e=!!e,e!==this._enabled&&(this._enabled=e,this._enabled||this.hide())}get enabled(){return this._enabled}set context(e){this._context=e}get context(){return this._context}show(e,t){if(!this._context){console.error("ContextMenu cannot be shown without a context - set context first");return}this._enabled&&(this._shown||(this._hideAllMenus(),this._updateItemsTitles(),this._updateItemsEnabledStatus(),this._showMenu(this._rootMenu.id,e,t),this._updateSubMenuInfo(),this._shown=!0,this.fire("shown",{})))}get shown(){return this._shown}hide(){this._enabled&&this._shown&&(this._hideAllMenus(),this._shown=!1,this.fire("hidden",{}))}destroy(){this._context=null,this._clear(),this._id!==null&&($c.removeItem(this._id),this._id=null)}_clear(){for(let e=0,t=this._menuList.length;e<t;e++){const s=this._menuList[e].menuElement;s.parentElement.removeChild(s)}this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={}}_parseItems(e){const t=i=>{const s=this._getNextId(),o=new Og(s);for(let a=0,n=i.length;a<n;a++){const l=i[a],c=new kg;o.groups.push(c);for(let h=0,d=l.length;h<d;h++){const p=l[h],m=p.items,g=m&&m.length>0,u=this._getNextId(),x=p.getTitle||(()=>p.title||""),y=p.doAction||p.callback||(()=>{}),P=p.getEnabled||(()=>!0),_=p.getShown||(()=>!0),b=new Ng(u,x,y,P,_);if(b.parentMenu=o,c.items.push(b),g){const B=t(m);b.subMenu=B,B.parentItem=b}this._itemList.push(b),this._itemMap[b.id]=b}}return this._menuList.push(o),this._menuMap[o.id]=o,o};this._rootMenu=t(e)}_getNextId(){return"ContextMenu_"+this._id+"_"+this._nextId++}_createUI(){const e=t=>{this._createMenuUI(t);const i=t.groups;for(let s=0,o=i.length;s<o;s++){const n=i[s].items;for(let l=0,c=n.length;l<c;l++){const d=n[l].subMenu;d&&e(d)}}};e(this._rootMenu)}_createMenuUI(e){const t=e.groups,i=[];if(i.push('<div class="xeokit-context-menu '+e.id+'" style="z-index:300000; position: absolute;">'),i.push("<ul>"),t)for(let l=0,c=t.length;l<c;l++){const h=t[l],d=l,p=c,m=h.items;if(m)for(let g=0,u=m.length;g<u;g++){const x=m[g],y=x.subMenu,P=x.title||"";y?(i.push('<li id="'+x.id+'" class="xeokit-context-menu-item xeokit-context-menu-submenu">'+P+"</li>"),d===p-1||g<u-1||i.push('<li id="'+x.id+'" class="xeokit-context-menu-item-separator"></li>')):(i.push('<li id="'+x.id+'" class="xeokit-context-menu-item">'+P+"</li>"),d===p-1||g<u-1||i.push('<li id="'+x.id+'" class="xeokit-context-menu-item-separator"></li>'))}}i.push("</ul>"),i.push("</div>");const s=i.join("");document.body.insertAdjacentHTML("beforeend",s);const o=document.querySelector("."+e.id);e.menuElement=o,o.style["border-radius"]="4px",o.style.display="none",o.style["z-index"]=3e5,o.style.background="white",o.style.border="1px solid black",o.style["box-shadow"]="0 4px 5px 0 gray",o.oncontextmenu=l=>{l.preventDefault()};const a=this;let n=null;if(t)for(let l=0,c=t.length;l<c;l++){const d=t[l].items;if(d)for(let p=0,m=d.length;p<m;p++){const g=d[p],u=g.subMenu;if(g.itemElement=document.getElementById(g.id),!g.itemElement){console.error("ContextMenu item element not found: "+g.id);continue}g.itemElement.addEventListener("mouseenter",x=>{x.preventDefault();const y=g.subMenu;if(!y){n&&(a._hideMenu(n.id),n=null);return}if(n&&n.id!==y.id&&(a._hideMenu(n.id),n=null),g.enabled===!1)return;const P=g.itemElement,_=y.menuElement,b=P.getBoundingClientRect();_.getBoundingClientRect();const B=200;b.right+B>window.innerWidth?a._showMenu(y.id,b.left-B,b.top-1):a._showMenu(y.id,b.right-5,b.top-1),n=y}),u||(g.itemElement.addEventListener("click",x=>{x.preventDefault(),a._context&&g.enabled!==!1&&(g.doAction&&g.doAction(a._context),this._hideOnAction?a.hide():(a._updateItemsTitles(),a._updateItemsEnabledStatus()))}),g.itemElement.addEventListener("mouseup",x=>{x.which===3&&(x.preventDefault(),a._context&&g.enabled!==!1&&(g.doAction&&g.doAction(a._context),this._hideOnAction?a.hide():(a._updateItemsTitles(),a._updateItemsEnabledStatus())))}),g.itemElement.addEventListener("mouseenter",x=>{x.preventDefault(),g.enabled!==!1&&g.doHover&&g.doHover(a._context)}))}}}_updateItemsTitles(){if(this._context)for(let e=0,t=this._itemList.length;e<t;e++){const i=this._itemList[e],s=i.itemElement;if(!s)continue;const o=i.getShown;if(!o||!o(this._context))continue;const a=i.getTitle(this._context);i.subMenu,s.innerText=a}}_updateItemsEnabledStatus(){if(this._context)for(let e=0,t=this._itemList.length;e<t;e++){const i=this._itemList[e],s=i.itemElement;if(!s)continue;const o=i.getEnabled;if(!o)continue;const a=i.getShown;if(!a)continue;const n=a(this._context);if(i.shown=n,n)s.style.display="";else{s.style.display="none";continue}const l=o(this._context);i.enabled=l,l?s.classList.remove("disabled"):s.classList.add("disabled")}}_updateSubMenuInfo(){if(!this._context)return;let e,t,i,s,o,a;this._itemList.forEach(n=>{n.subMenu&&(e=n.itemElement,t=e.getBoundingClientRect(),i=n.subMenu.menuElement,s={visibility:i.style.visibility,display:i.style.display},i.style.display="block",i.style.visibility="hidden",a=n.subMenu.menuElement.getBoundingClientRect().width,i.style.visibility=s.visibility,i.style.display=s.display,o=t.right+a>window.innerWidth,e.setAttribute("data-submenuposition",o?"left":"right"))})}_showMenu(e,t,i){const s=this._menuMap[e];if(!s){console.error("Menu not found: "+e);return}if(s.shown)return;const o=s.menuElement;o&&(this._showMenuElement(o,t,i),s.shown=!0)}_hideMenu(e){const t=this._menuMap[e];if(!t){console.error("Menu not found: "+e);return}if(!t.shown)return;const i=t.menuElement;i&&(this._hideMenuElement(i),t.shown=!1)}_hideAllMenus(){for(let e=0,t=this._menuList.length;e<t;e++){const i=this._menuList[e];this._hideMenu(i.id)}}_showMenuElement(e,t,i){e.style.display="block";const s=e.offsetHeight,o=e.offsetWidth;i+s>window.innerHeight&&(i=window.innerHeight-s),t+o>window.innerWidth&&(t=window.innerWidth-o),e.style.left=t+"px",e.style.top=i+"px"}_hideMenuElement(e){e.style.display="none"}}let sa=!0,Ie=sa?Float64Array:Float32Array;const Xs=new Ie(3),Zo=new Ie(16),qo=new Ie(16),Qg=new Ie(4),A={setDoublePrecisionEnabled(r){sa=r,Ie=sa?Float64Array:Float32Array},getDoublePrecisionEnabled(){return sa},MIN_DOUBLE:-Number.MAX_SAFE_INTEGER,MAX_DOUBLE:Number.MAX_SAFE_INTEGER,MAX_INT:1e7,DEGTORAD:.0174532925,RADTODEG:57.295779513,unglobalizeObjectId(r,e){const t=e.indexOf("#");return t===r.length&&e.startsWith(r)?e.substring(t+1):e},globalizeObjectId(r,e){return r+"#"+e},safeInv(r){const e=1/r;return isNaN(e)||!isFinite(e)?1:e},vec2(r){return new Ie(r||2)},vec3(r){return new Ie(r||3)},vec4(r){return new Ie(r||4)},mat3(r){return new Ie(r||9)},mat3ToMat4(r,e=new Ie(16)){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=0,e[4]=r[3],e[5]=r[4],e[6]=r[5],e[7]=0,e[8]=r[6],e[9]=r[7],e[10]=r[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},mat4(r){return new Ie(r||16)},mat4ToMat3(r,e){},doublesToFloats(r,e,t){const i=new Ie(2);for(let s=0,o=r.length;s<o;s++)A.splitDouble(r[s],i),e[s]=i[0],t[s]=i[1]},splitDouble(r,e){const t=Ie.from([r])[0],i=r-t;e[0]=t,e[1]=i},createUUID:(()=>{const r=[];for(let e=0;e<256;e++)r[e]=(e<16?"0":"")+e.toString(16);return()=>{const e=Math.random()*4294967295|0,t=Math.random()*4294967295|0,i=Math.random()*4294967295|0,s=Math.random()*4294967295|0;return`${r[e&255]+r[e>>8&255]+r[e>>16&255]+r[e>>24&255]}-${r[t&255]}${r[t>>8&255]}-${r[t>>16&15|64]}${r[t>>24&255]}-${r[i&63|128]}${r[i>>8&255]}-${r[i>>16&255]}${r[i>>24&255]}${r[s&255]}${r[s>>8&255]}${r[s>>16&255]}${r[s>>24&255]}`}})(),clamp(r,e,t){return Math.max(e,Math.min(t,r))},fmod(r,e){if(r<e)return console.error("math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),r;for(;e<=r;)r-=e;return r},compareVec3(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]},negateVec3(r,e){return e||(e=r),e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e},negateVec4(r,e){return e||(e=r),e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e[3]=-r[3],e},addVec4(r,e,t){return t||(t=r),t[0]=r[0]+e[0],t[1]=r[1]+e[1],t[2]=r[2]+e[2],t[3]=r[3]+e[3],t},addVec4Scalar(r,e,t){return t||(t=r),t[0]=r[0]+e,t[1]=r[1]+e,t[2]=r[2]+e,t[3]=r[3]+e,t},addVec3(r,e,t){return t||(t=r),t[0]=r[0]+e[0],t[1]=r[1]+e[1],t[2]=r[2]+e[2],t},addVec3Scalar(r,e,t){return t||(t=r),t[0]=r[0]+e,t[1]=r[1]+e,t[2]=r[2]+e,t},subVec4(r,e,t){return t||(t=r),t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],t[3]=r[3]-e[3],t},subVec3(r,e,t){return t||(t=r),t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],t},subVec2(r,e,t){return t||(t=r),t[0]=r[0]-e[0],t[1]=r[1]-e[1],t},geometricMeanVec2(...r){const e=new Ie(r[0]);for(let t=1;t<r.length;t++)e[0]+=r[t][0],e[1]+=r[t][1];return e[0]/=r.length,e[1]/=r.length,e},subVec4Scalar(r,e,t){return t||(t=r),t[0]=r[0]-e,t[1]=r[1]-e,t[2]=r[2]-e,t[3]=r[3]-e,t},subScalarVec4(r,e,t){return t||(t=r),t[0]=e-r[0],t[1]=e-r[1],t[2]=e-r[2],t[3]=e-r[3],t},mulVec4(r,e,t){return t||(t=r),t[0]=r[0]*e[0],t[1]=r[1]*e[1],t[2]=r[2]*e[2],t[3]=r[3]*e[3],t},mulVec4Scalar(r,e,t){return t||(t=r),t[0]=r[0]*e,t[1]=r[1]*e,t[2]=r[2]*e,t[3]=r[3]*e,t},mulVec3Scalar(r,e,t){return t||(t=r),t[0]=r[0]*e,t[1]=r[1]*e,t[2]=r[2]*e,t},mulVec2Scalar(r,e,t){return t||(t=r),t[0]=r[0]*e,t[1]=r[1]*e,t},divVec3(r,e,t){return t||(t=r),t[0]=r[0]/e[0],t[1]=r[1]/e[1],t[2]=r[2]/e[2],t},divVec4(r,e,t){return t||(t=r),t[0]=r[0]/e[0],t[1]=r[1]/e[1],t[2]=r[2]/e[2],t[3]=r[3]/e[3],t},divScalarVec3(r,e,t){return t||(t=e),t[0]=r/e[0],t[1]=r/e[1],t[2]=r/e[2],t},divVec3Scalar(r,e,t){return t||(t=r),t[0]=r[0]/e,t[1]=r[1]/e,t[2]=r[2]/e,t},divVec4Scalar(r,e,t){return t||(t=r),t[0]=r[0]/e,t[1]=r[1]/e,t[2]=r[2]/e,t[3]=r[3]/e,t},divScalarVec4(r,e,t){return t||(t=e),t[0]=r/e[0],t[1]=r/e[1],t[2]=r/e[2],t[3]=r/e[3],t},dotVec4(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]+r[3]*e[3]},cross3Vec4(r,e){const t=r[0],i=r[1],s=r[2],o=e[0],a=e[1],n=e[2];return[i*n-s*a,s*o-t*n,t*a-i*o,0]},cross3Vec3(r,e,t){t||(t=r);const i=r[0],s=r[1],o=r[2],a=e[0],n=e[1],l=e[2];return t[0]=s*l-o*n,t[1]=o*a-i*l,t[2]=i*n-s*a,t},sqLenVec4(r){return A.dotVec4(r,r)},lenVec4(r){return Math.sqrt(A.sqLenVec4(r))},dotVec3(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]},dotVec2(r,e){return r[0]*e[0]+r[1]*e[1]},sqLenVec3(r){return A.dotVec3(r,r)},sqLenVec2(r){return A.dotVec2(r,r)},lenVec3(r){return Math.sqrt(A.sqLenVec3(r))},distVec3:(()=>{const r=new Ie(3);return(e,t)=>A.lenVec3(A.subVec3(e,t,r))})(),lenVec2(r){return Math.sqrt(A.sqLenVec2(r))},distVec2:(()=>{const r=new Ie(2);return(e,t)=>A.lenVec2(A.subVec2(e,t,r))})(),rcpVec3(r,e){return A.divScalarVec3(1,r,e)},normalizeVec4(r,e){const t=1/A.lenVec4(r);return A.mulVec4Scalar(r,t,e)},normalizeVec3(r,e){const t=1/A.lenVec3(r);return A.mulVec3Scalar(r,t,e)},normalizeVec2(r,e){const t=1/A.lenVec2(r);return A.mulVec2Scalar(r,t,e)},angleVec3(r,e){let t=A.dotVec3(r,e)/Math.sqrt(A.sqLenVec3(r)*A.sqLenVec3(e));return t=t<-1?-1:t>1?1:t,Math.acos(t)},vec3FromMat4Scale:(()=>{const r=new Ie(3);return(e,t)=>(r[0]=e[0],r[1]=e[1],r[2]=e[2],t[0]=A.lenVec3(r),r[0]=e[4],r[1]=e[5],r[2]=e[6],t[1]=A.lenVec3(r),r[0]=e[8],r[1]=e[9],r[2]=e[10],t[2]=A.lenVec3(r),t)})(),vecToArray:(()=>{function r(e){return Math.round(e*1e5)/1e5}return e=>{e=Array.prototype.slice.call(e);for(let t=0,i=e.length;t<i;t++)e[t]=r(e[t]);return e}})(),xyzArrayToObject(r){return{x:r[0],y:r[1],z:r[2]}},xyzObjectToArray(r,e){return e=e||A.vec3(),e[0]=r.x,e[1]=r.y,e[2]=r.z,e},dupMat4(r){return r.slice(0,16)},mat4To3(r){return[r[0],r[1],r[2],r[4],r[5],r[6],r[8],r[9],r[10]]},m4s(r){return[r,r,r,r,r,r,r,r,r,r,r,r,r,r,r,r]},setMat4ToZeroes(){return A.m4s(0)},setMat4ToOnes(){return A.m4s(1)},diagonalMat4v(r){return new Ie([r[0],0,0,0,0,r[1],0,0,0,0,r[2],0,0,0,0,r[3]])},diagonalMat4c(r,e,t,i){return A.diagonalMat4v([r,e,t,i])},diagonalMat4s(r){return A.diagonalMat4c(r,r,r,r)},identityMat4(r=new Ie(16)){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},identityMat3(r=new Ie(9)){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r},isIdentityMat4(r){return!(r[0]!==1||r[1]!==0||r[2]!==0||r[3]!==0||r[4]!==0||r[5]!==1||r[6]!==0||r[7]!==0||r[8]!==0||r[9]!==0||r[10]!==1||r[11]!==0||r[12]!==0||r[13]!==0||r[14]!==0||r[15]!==1)},negateMat4(r,e){return e||(e=r),e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e[3]=-r[3],e[4]=-r[4],e[5]=-r[5],e[6]=-r[6],e[7]=-r[7],e[8]=-r[8],e[9]=-r[9],e[10]=-r[10],e[11]=-r[11],e[12]=-r[12],e[13]=-r[13],e[14]=-r[14],e[15]=-r[15],e},addMat4(r,e,t){return t||(t=r),t[0]=r[0]+e[0],t[1]=r[1]+e[1],t[2]=r[2]+e[2],t[3]=r[3]+e[3],t[4]=r[4]+e[4],t[5]=r[5]+e[5],t[6]=r[6]+e[6],t[7]=r[7]+e[7],t[8]=r[8]+e[8],t[9]=r[9]+e[9],t[10]=r[10]+e[10],t[11]=r[11]+e[11],t[12]=r[12]+e[12],t[13]=r[13]+e[13],t[14]=r[14]+e[14],t[15]=r[15]+e[15],t},addMat4Scalar(r,e,t){return t||(t=r),t[0]=r[0]+e,t[1]=r[1]+e,t[2]=r[2]+e,t[3]=r[3]+e,t[4]=r[4]+e,t[5]=r[5]+e,t[6]=r[6]+e,t[7]=r[7]+e,t[8]=r[8]+e,t[9]=r[9]+e,t[10]=r[10]+e,t[11]=r[11]+e,t[12]=r[12]+e,t[13]=r[13]+e,t[14]=r[14]+e,t[15]=r[15]+e,t},addScalarMat4(r,e,t){return A.addMat4Scalar(e,r,t)},subMat4(r,e,t){return t||(t=r),t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],t[3]=r[3]-e[3],t[4]=r[4]-e[4],t[5]=r[5]-e[5],t[6]=r[6]-e[6],t[7]=r[7]-e[7],t[8]=r[8]-e[8],t[9]=r[9]-e[9],t[10]=r[10]-e[10],t[11]=r[11]-e[11],t[12]=r[12]-e[12],t[13]=r[13]-e[13],t[14]=r[14]-e[14],t[15]=r[15]-e[15],t},subMat4Scalar(r,e,t){return t||(t=r),t[0]=r[0]-e,t[1]=r[1]-e,t[2]=r[2]-e,t[3]=r[3]-e,t[4]=r[4]-e,t[5]=r[5]-e,t[6]=r[6]-e,t[7]=r[7]-e,t[8]=r[8]-e,t[9]=r[9]-e,t[10]=r[10]-e,t[11]=r[11]-e,t[12]=r[12]-e,t[13]=r[13]-e,t[14]=r[14]-e,t[15]=r[15]-e,t},subScalarMat4(r,e,t){return t||(t=e),t[0]=r-e[0],t[1]=r-e[1],t[2]=r-e[2],t[3]=r-e[3],t[4]=r-e[4],t[5]=r-e[5],t[6]=r-e[6],t[7]=r-e[7],t[8]=r-e[8],t[9]=r-e[9],t[10]=r-e[10],t[11]=r-e[11],t[12]=r-e[12],t[13]=r-e[13],t[14]=r-e[14],t[15]=r-e[15],t},mulMat4(r,e,t){t||(t=r);const i=r[0],s=r[1],o=r[2],a=r[3],n=r[4],l=r[5],c=r[6],h=r[7],d=r[8],p=r[9],m=r[10],g=r[11],u=r[12],x=r[13],y=r[14],P=r[15],_=e[0],b=e[1],B=e[2],w=e[3],C=e[4],E=e[5],I=e[6],R=e[7],F=e[8],z=e[9],Q=e[10],H=e[11],ae=e[12],pe=e[13],ge=e[14],fe=e[15];return t[0]=_*i+b*n+B*d+w*u,t[1]=_*s+b*l+B*p+w*x,t[2]=_*o+b*c+B*m+w*y,t[3]=_*a+b*h+B*g+w*P,t[4]=C*i+E*n+I*d+R*u,t[5]=C*s+E*l+I*p+R*x,t[6]=C*o+E*c+I*m+R*y,t[7]=C*a+E*h+I*g+R*P,t[8]=F*i+z*n+Q*d+H*u,t[9]=F*s+z*l+Q*p+H*x,t[10]=F*o+z*c+Q*m+H*y,t[11]=F*a+z*h+Q*g+H*P,t[12]=ae*i+pe*n+ge*d+fe*u,t[13]=ae*s+pe*l+ge*p+fe*x,t[14]=ae*o+pe*c+ge*m+fe*y,t[15]=ae*a+pe*h+ge*g+fe*P,t},mulMat3(r,e,t){t||(t=new Ie(9));const i=r[0],s=r[3],o=r[6],a=r[1],n=r[4],l=r[7],c=r[2],h=r[5],d=r[8],p=e[0],m=e[3],g=e[6],u=e[1],x=e[4],y=e[7],P=e[2],_=e[5],b=e[8];return t[0]=i*p+s*u+o*P,t[3]=i*m+s*x+o*_,t[6]=i*g+s*y+o*b,t[1]=a*p+n*u+l*P,t[4]=a*m+n*x+l*_,t[7]=a*g+n*y+l*b,t[2]=c*p+h*u+d*P,t[5]=c*m+h*x+d*_,t[8]=c*g+h*y+d*b,t},mulMat4Scalar(r,e,t){return t||(t=r),t[0]=r[0]*e,t[1]=r[1]*e,t[2]=r[2]*e,t[3]=r[3]*e,t[4]=r[4]*e,t[5]=r[5]*e,t[6]=r[6]*e,t[7]=r[7]*e,t[8]=r[8]*e,t[9]=r[9]*e,t[10]=r[10]*e,t[11]=r[11]*e,t[12]=r[12]*e,t[13]=r[13]*e,t[14]=r[14]*e,t[15]=r[15]*e,t},mulMat4v4(r,e,t=A.vec4()){const i=e[0],s=e[1],o=e[2],a=e[3];return t[0]=r[0]*i+r[4]*s+r[8]*o+r[12]*a,t[1]=r[1]*i+r[5]*s+r[9]*o+r[13]*a,t[2]=r[2]*i+r[6]*s+r[10]*o+r[14]*a,t[3]=r[3]*i+r[7]*s+r[11]*o+r[15]*a,t},transposeMat4(r,e){const t=r[4],i=r[14],s=r[8],o=r[13],a=r[12],n=r[9];if(!e||r===e){const l=r[1],c=r[2],h=r[3],d=r[6],p=r[7],m=r[11];return r[1]=t,r[2]=s,r[3]=a,r[4]=l,r[6]=n,r[7]=o,r[8]=c,r[9]=d,r[11]=i,r[12]=h,r[13]=p,r[14]=m,r}return e[0]=r[0],e[1]=t,e[2]=s,e[3]=a,e[4]=r[1],e[5]=r[5],e[6]=n,e[7]=o,e[8]=r[2],e[9]=r[6],e[10]=r[10],e[11]=i,e[12]=r[3],e[13]=r[7],e[14]=r[11],e[15]=r[15],e},transposeMat3(r,e){if(e===r){const t=r[1],i=r[2],s=r[5];e[1]=r[3],e[2]=r[6],e[3]=t,e[5]=r[7],e[6]=i,e[7]=s}else e[0]=r[0],e[1]=r[3],e[2]=r[6],e[3]=r[1],e[4]=r[4],e[5]=r[7],e[6]=r[2],e[7]=r[5],e[8]=r[8];return e},determinantMat4(r){const e=r[0],t=r[1],i=r[2],s=r[3],o=r[4],a=r[5],n=r[6],l=r[7],c=r[8],h=r[9],d=r[10],p=r[11],m=r[12],g=r[13],u=r[14],x=r[15];return m*h*n*s-c*g*n*s-m*a*d*s+o*g*d*s+c*a*u*s-o*h*u*s-m*h*i*l+c*g*i*l+m*t*d*l-e*g*d*l-c*t*u*l+e*h*u*l+m*a*i*p-o*g*i*p-m*t*n*p+e*g*n*p+o*t*u*p-e*a*u*p-c*a*i*x+o*h*i*x+c*t*n*x-e*h*n*x-o*t*d*x+e*a*d*x},inverseMat4(r,e){e||(e=r);const t=r[0],i=r[1],s=r[2],o=r[3],a=r[4],n=r[5],l=r[6],c=r[7],h=r[8],d=r[9],p=r[10],m=r[11],g=r[12],u=r[13],x=r[14],y=r[15],P=t*n-i*a,_=t*l-s*a,b=t*c-o*a,B=i*l-s*n,w=i*c-o*n,C=s*c-o*l,E=h*u-d*g,I=h*x-p*g,R=h*y-m*g,F=d*x-p*u,z=d*y-m*u,Q=p*y-m*x,H=1/(P*Q-_*z+b*F+B*R-w*I+C*E);return e[0]=(n*Q-l*z+c*F)*H,e[1]=(-i*Q+s*z-o*F)*H,e[2]=(u*C-x*w+y*B)*H,e[3]=(-d*C+p*w-m*B)*H,e[4]=(-a*Q+l*R-c*I)*H,e[5]=(t*Q-s*R+o*I)*H,e[6]=(-g*C+x*b-y*_)*H,e[7]=(h*C-p*b+m*_)*H,e[8]=(a*z-n*R+c*E)*H,e[9]=(-t*z+i*R-o*E)*H,e[10]=(g*w-u*b+y*P)*H,e[11]=(-h*w+d*b-m*P)*H,e[12]=(-a*F+n*I-l*E)*H,e[13]=(t*F-i*I+s*E)*H,e[14]=(-g*B+u*_-x*P)*H,e[15]=(h*B-d*_+p*P)*H,e},traceMat4(r){return r[0]+r[5]+r[10]+r[15]},translationMat4v(r,e){const t=e||A.identityMat4();return t[12]=r[0],t[13]=r[1],t[14]=r[2],t},translationMat3v(r,e){const t=e||A.identityMat3();return t[6]=r[0],t[7]=r[1],t},translationMat4c:(()=>{const r=new Ie(3);return(e,t,i,s)=>(r[0]=e,r[1]=t,r[2]=i,A.translationMat4v(r,s))})(),translationMat4s(r,e){return A.translationMat4c(r,r,r,e)},translateMat4v(r,e){return A.translateMat4c(r[0],r[1],r[2],e)},translateMat4c(r,e,t,i){const s=i[3];i[0]+=s*r,i[1]+=s*e,i[2]+=s*t;const o=i[7];i[4]+=o*r,i[5]+=o*e,i[6]+=o*t;const a=i[11];i[8]+=a*r,i[9]+=a*e,i[10]+=a*t;const n=i[15];return i[12]+=n*r,i[13]+=n*e,i[14]+=n*t,i},setMat4Translation(r,e,t){return t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=r[3],t[4]=r[4],t[5]=r[5],t[6]=r[6],t[7]=r[7],t[8]=r[8],t[9]=r[9],t[10]=r[10],t[11]=r[11],t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=r[15],t},rotationMat4v(r,e,t){const i=A.normalizeVec4([e[0],e[1],e[2],0],[]),s=Math.sin(r),o=Math.cos(r),a=1-o,n=i[0],l=i[1],c=i[2];let h,d,p,m,g,u;return h=n*l,d=l*c,p=c*n,m=n*s,g=l*s,u=c*s,t=t||A.mat4(),t[0]=a*n*n+o,t[1]=a*h+u,t[2]=a*p-g,t[3]=0,t[4]=a*h-u,t[5]=a*l*l+o,t[6]=a*d+m,t[7]=0,t[8]=a*p+g,t[9]=a*d-m,t[10]=a*c*c+o,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},rotationMat4c(r,e,t,i,s){return A.rotationMat4v(r,[e,t,i],s)},scalingMat4v(r,e=A.identityMat4()){return e[0]=r[0],e[5]=r[1],e[10]=r[2],e},scalingMat3v(r,e=A.identityMat3()){return e[0]=r[0],e[4]=r[1],e},scalingMat4c:(()=>{const r=new Ie(3);return(e,t,i,s)=>(r[0]=e,r[1]=t,r[2]=i,A.scalingMat4v(r,s))})(),scaleMat4c(r,e,t,i){return i[0]*=r,i[4]*=e,i[8]*=t,i[1]*=r,i[5]*=e,i[9]*=t,i[2]*=r,i[6]*=e,i[10]*=t,i[3]*=r,i[7]*=e,i[11]*=t,i},scaleMat4v(r,e){const t=r[0],i=r[1],s=r[2];return e[0]*=t,e[4]*=i,e[8]*=s,e[1]*=t,e[5]*=i,e[9]*=s,e[2]*=t,e[6]*=i,e[10]*=s,e[3]*=t,e[7]*=i,e[11]*=s,e},scalingMat4s(r){return A.scalingMat4c(r,r,r)},rotationTranslationMat4(r,e,t=A.mat4()){const i=r[0],s=r[1],o=r[2],a=r[3],n=i+i,l=s+s,c=o+o,h=i*n,d=i*l,p=i*c,m=s*l,g=s*c,u=o*c,x=a*n,y=a*l,P=a*c;return t[0]=1-(m+u),t[1]=d+P,t[2]=p-y,t[3]=0,t[4]=d-P,t[5]=1-(h+u),t[6]=g+x,t[7]=0,t[8]=p+y,t[9]=g-x,t[10]=1-(h+m),t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},mat4ToEuler(r,e,t=A.vec4()){const i=A.clamp,s=r[0],o=r[4],a=r[8],n=r[1],l=r[5],c=r[9],h=r[2],d=r[6],p=r[10];return e==="XYZ"?(t[1]=Math.asin(i(a,-1,1)),Math.abs(a)<.99999?(t[0]=Math.atan2(-c,p),t[2]=Math.atan2(-o,s)):(t[0]=Math.atan2(d,l),t[2]=0)):e==="YXZ"?(t[0]=Math.asin(-i(c,-1,1)),Math.abs(c)<.99999?(t[1]=Math.atan2(a,p),t[2]=Math.atan2(n,l)):(t[1]=Math.atan2(-h,s),t[2]=0)):e==="ZXY"?(t[0]=Math.asin(i(d,-1,1)),Math.abs(d)<.99999?(t[1]=Math.atan2(-h,p),t[2]=Math.atan2(-o,l)):(t[1]=0,t[2]=Math.atan2(n,s))):e==="ZYX"?(t[1]=Math.asin(-i(h,-1,1)),Math.abs(h)<.99999?(t[0]=Math.atan2(d,p),t[2]=Math.atan2(n,s)):(t[0]=0,t[2]=Math.atan2(-o,l))):e==="YZX"?(t[2]=Math.asin(i(n,-1,1)),Math.abs(n)<.99999?(t[0]=Math.atan2(-c,l),t[1]=Math.atan2(-h,s)):(t[0]=0,t[1]=Math.atan2(a,p))):e==="XZY"&&(t[2]=Math.asin(-i(o,-1,1)),Math.abs(o)<.99999?(t[0]=Math.atan2(d,l),t[1]=Math.atan2(a,s)):(t[0]=Math.atan2(-c,p),t[1]=0)),t},composeMat4(r,e,t,i=A.mat4()){return A.quaternionToRotationMat4(e,i),A.scaleMat4v(t,i),A.translateMat4v(r,i),i},decomposeMat4:(()=>{const r=new Ie(3),e=new Ie(16);return function(i,s,o,a){r[0]=i[0],r[1]=i[1],r[2]=i[2];let n=A.lenVec3(r);r[0]=i[4],r[1]=i[5],r[2]=i[6];const l=A.lenVec3(r);r[8]=i[8],r[9]=i[9],r[10]=i[10];const c=A.lenVec3(r);A.determinantMat4(i)<0&&(n=-n),s[0]=i[12],s[1]=i[13],s[2]=i[14],e.set(i);const d=1/n,p=1/l,m=1/c;return e[0]*=d,e[1]*=d,e[2]*=d,e[4]*=p,e[5]*=p,e[6]*=p,e[8]*=m,e[9]*=m,e[10]*=m,A.mat4ToQuaternion(e,o),a[0]=n,a[1]=l,a[2]=c,this}})(),getColMat4(r,e){const t=e*4;return[r[t],r[t+1],r[t+2],r[t+3]]},setRowMat4(r,e,t){r[e]=t[0],r[e+4]=t[1],r[e+8]=t[2],r[e+12]=t[3]},lookAtMat4v(r,e,t,i){i||(i=A.mat4());const s=r[0],o=r[1],a=r[2],n=t[0],l=t[1],c=t[2],h=e[0],d=e[1],p=e[2];if(s===h&&o===d&&a===p)return A.identityMat4();let m,g,u,x,y,P,_,b,B,w;return m=s-h,g=o-d,u=a-p,w=1/Math.sqrt(m*m+g*g+u*u),m*=w,g*=w,u*=w,x=l*u-c*g,y=c*m-n*u,P=n*g-l*m,w=Math.sqrt(x*x+y*y+P*P),w?(w=1/w,x*=w,y*=w,P*=w):(x=0,y=0,P=0),_=g*P-u*y,b=u*x-m*P,B=m*y-g*x,w=Math.sqrt(_*_+b*b+B*B),w?(w=1/w,_*=w,b*=w,B*=w):(_=0,b=0,B=0),i[0]=x,i[1]=_,i[2]=m,i[3]=0,i[4]=y,i[5]=b,i[6]=g,i[7]=0,i[8]=P,i[9]=B,i[10]=u,i[11]=0,i[12]=-(x*s+y*o+P*a),i[13]=-(_*s+b*o+B*a),i[14]=-(m*s+g*o+u*a),i[15]=1,i},lookAtMat4c(r,e,t,i,s,o,a,n,l){return A.lookAtMat4v([r,e,t],[i,s,o],[a,n,l],[])},orthoMat4c(r,e,t,i,s,o,a){a||(a=A.mat4());const n=e-r,l=i-t,c=o-s;return a[0]=2/n,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/l,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/c,a[11]=0,a[12]=-(r+e)/n,a[13]=-(i+t)/l,a[14]=-(o+s)/c,a[15]=1,a},frustumMat4v(r,e,t){t||(t=A.mat4());const i=[r[0],r[1],r[2],0],s=[e[0],e[1],e[2],0];A.addVec4(s,i,Zo),A.subVec4(s,i,qo);const o=2*i[2],a=qo[0],n=qo[1],l=qo[2];return t[0]=o/a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o/n,t[6]=0,t[7]=0,t[8]=Zo[0]/a,t[9]=Zo[1]/n,t[10]=-Zo[2]/l,t[11]=-1,t[12]=0,t[13]=0,t[14]=-o*s[2]/l,t[15]=0,t},frustumMat4(r,e,t,i,s,o,a){a||(a=A.mat4());const n=e-r,l=i-t,c=o-s;return a[0]=s*2/n,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=s*2/l,a[6]=0,a[7]=0,a[8]=(e+r)/n,a[9]=(i+t)/l,a[10]=-(o+s)/c,a[11]=-1,a[12]=0,a[13]=0,a[14]=-(o*s*2)/c,a[15]=0,a},perspectiveMat4(r,e,t,i,s){const o=[],a=[];return o[2]=t,a[2]=i,a[1]=o[2]*Math.tan(r/2),o[1]=-a[1],a[0]=a[1]*e,o[0]=-a[0],A.frustumMat4v(o,a,s)},compareMat4(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]&&r[3]===e[3]&&r[4]===e[4]&&r[5]===e[5]&&r[6]===e[6]&&r[7]===e[7]&&r[8]===e[8]&&r[9]===e[9]&&r[10]===e[10]&&r[11]===e[11]&&r[12]===e[12]&&r[13]===e[13]&&r[14]===e[14]&&r[15]===e[15]},transformPoint3(r,e,t=A.vec3()){const i=e[0],s=e[1],o=e[2];return t[0]=r[0]*i+r[4]*s+r[8]*o+r[12],t[1]=r[1]*i+r[5]*s+r[9]*o+r[13],t[2]=r[2]*i+r[6]*s+r[10]*o+r[14],t},transformPoint4(r,e,t=A.vec4()){return t[0]=r[0]*e[0]+r[4]*e[1]+r[8]*e[2]+r[12]*e[3],t[1]=r[1]*e[0]+r[5]*e[1]+r[9]*e[2]+r[13]*e[3],t[2]=r[2]*e[0]+r[6]*e[1]+r[10]*e[2]+r[14]*e[3],t[3]=r[3]*e[0]+r[7]*e[1]+r[11]*e[2]+r[15]*e[3],t},transformPoints3(r,e,t){const i=t||[],s=e.length;let o,a,n,l;const c=r[0],h=r[1],d=r[2],p=r[3],m=r[4],g=r[5],u=r[6],x=r[7],y=r[8],P=r[9],_=r[10],b=r[11],B=r[12],w=r[13],C=r[14],E=r[15];let I;for(let R=0;R<s;++R)l=e[R],o=l[0],a=l[1],n=l[2],I=i[R]||(i[R]=[0,0,0]),I[0]=c*o+m*a+y*n+B,I[1]=h*o+g*a+P*n+w,I[2]=d*o+u*a+_*n+C,I[3]=p*o+x*a+b*n+E;return i.length=s,i},transformPositions3(r,e,t=e){let i;const s=e.length;let o,a,n;const l=r[0],c=r[1],h=r[2];r[3];const d=r[4],p=r[5],m=r[6];r[7];const g=r[8],u=r[9],x=r[10];r[11];const y=r[12],P=r[13],_=r[14];for(r[15],i=0;i<s;i+=3)o=e[i+0],a=e[i+1],n=e[i+2],t[i+0]=l*o+d*a+g*n+y,t[i+1]=c*o+p*a+u*n+P,t[i+2]=h*o+m*a+x*n+_;return t},transformPositions4(r,e,t=e){let i;const s=e.length;let o,a,n;const l=r[0],c=r[1],h=r[2],d=r[3],p=r[4],m=r[5],g=r[6],u=r[7],x=r[8],y=r[9],P=r[10],_=r[11],b=r[12],B=r[13],w=r[14],C=r[15];for(i=0;i<s;i+=4)o=e[i+0],a=e[i+1],n=e[i+2],t[i+0]=l*o+p*a+x*n+b,t[i+1]=c*o+m*a+y*n+B,t[i+2]=h*o+g*a+P*n+w,t[i+3]=d*o+u*a+_*n+C;return t},transformVec3(r,e,t){const i=e[0],s=e[1],o=e[2];return t=t||this.vec3(),t[0]=r[0]*i+r[4]*s+r[8]*o,t[1]=r[1]*i+r[5]*s+r[9]*o,t[2]=r[2]*i+r[6]*s+r[10]*o,t},transformVec4(r,e,t){const i=e[0],s=e[1],o=e[2],a=e[3];return t=t||A.vec4(),t[0]=r[0]*i+r[4]*s+r[8]*o+r[12]*a,t[1]=r[1]*i+r[5]*s+r[9]*o+r[13]*a,t[2]=r[2]*i+r[6]*s+r[10]*o+r[14]*a,t[3]=r[3]*i+r[7]*s+r[11]*o+r[15]*a,t},rotateVec2(r,e,t,i=r){const s=Math.cos(t),o=Math.sin(t),a=r[0]-e[0],n=r[1]-e[1];return i[0]=a*s-n*o+e[0],i[1]=a*o+n*s+e[1],r},rotateVec3X(r,e,t,i){const s=[],o=[];return s[0]=r[0]-e[0],s[1]=r[1]-e[1],s[2]=r[2]-e[2],o[0]=s[0],o[1]=s[1]*Math.cos(t)-s[2]*Math.sin(t),o[2]=s[1]*Math.sin(t)+s[2]*Math.cos(t),i[0]=o[0]+e[0],i[1]=o[1]+e[1],i[2]=o[2]+e[2],i},rotateVec3Y(r,e,t,i){const s=[],o=[];return s[0]=r[0]-e[0],s[1]=r[1]-e[1],s[2]=r[2]-e[2],o[0]=s[2]*Math.sin(t)+s[0]*Math.cos(t),o[1]=s[1],o[2]=s[2]*Math.cos(t)-s[0]*Math.sin(t),i[0]=o[0]+e[0],i[1]=o[1]+e[1],i[2]=o[2]+e[2],i},rotateVec3Z(r,e,t,i){const s=[],o=[];return s[0]=r[0]-e[0],s[1]=r[1]-e[1],s[2]=r[2]-e[2],o[0]=s[0]*Math.cos(t)-s[1]*Math.sin(t),o[1]=s[0]*Math.sin(t)+s[1]*Math.cos(t),o[2]=s[2],i[0]=o[0]+e[0],i[1]=o[1]+e[1],i[2]=o[2]+e[2],i},projectVec4(r,e){const t=1/r[3];return e=e||A.vec2(),e[0]=r[0]*t,e[1]=r[1]*t,e},unprojectVec3:(()=>{const r=new Ie(16),e=new Ie(16),t=new Ie(16);return function(i,s,o,a){return this.transformVec3(this.mulMat4(this.inverseMat4(s,r),this.inverseMat4(o,e),t),i,a)}})(),lerpVec3(r,e,t,i,s,o){const a=o||A.vec3(),n=(r-e)/(t-e);return a[0]=i[0]+n*(s[0]-i[0]),a[1]=i[1]+n*(s[1]-i[1]),a[2]=i[2]+n*(s[2]-i[2]),a},lerpMat4(r,e,t,i,s,o){const a=o||A.mat4(),n=(r-e)/(t-e);return a[0]=i[0]+n*(s[0]-i[0]),a[1]=i[1]+n*(s[1]-i[1]),a[2]=i[2]+n*(s[2]-i[2]),a[3]=i[3]+n*(s[3]-i[3]),a[4]=i[4]+n*(s[4]-i[4]),a[5]=i[5]+n*(s[5]-i[5]),a[6]=i[6]+n*(s[6]-i[6]),a[7]=i[7]+n*(s[7]-i[7]),a[8]=i[8]+n*(s[8]-i[8]),a[9]=i[9]+n*(s[9]-i[9]),a[10]=i[10]+n*(s[10]-i[10]),a[11]=i[11]+n*(s[11]-i[11]),a[12]=i[12]+n*(s[12]-i[12]),a[13]=i[13]+n*(s[13]-i[13]),a[14]=i[14]+n*(s[14]-i[14]),a[15]=i[15]+n*(s[15]-i[15]),a},flatten(r){const e=[];let t,i,s,o,a;for(t=0,i=r.length;t<i;t++)for(a=r[t],s=0,o=a.length;s<o;s++)e.push(a[s]);return e},identityQuaternion(r=A.vec4()){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r},eulerToQuaternion(r,e,t=A.vec4()){const i=r[0]*A.DEGTORAD/2,s=r[1]*A.DEGTORAD/2,o=r[2]*A.DEGTORAD/2,a=Math.cos(i),n=Math.cos(s),l=Math.cos(o),c=Math.sin(i),h=Math.sin(s),d=Math.sin(o);return e==="XYZ"?(t[0]=c*n*l+a*h*d,t[1]=a*h*l-c*n*d,t[2]=a*n*d+c*h*l,t[3]=a*n*l-c*h*d):e==="YXZ"?(t[0]=c*n*l+a*h*d,t[1]=a*h*l-c*n*d,t[2]=a*n*d-c*h*l,t[3]=a*n*l+c*h*d):e==="ZXY"?(t[0]=c*n*l-a*h*d,t[1]=a*h*l+c*n*d,t[2]=a*n*d+c*h*l,t[3]=a*n*l-c*h*d):e==="ZYX"?(t[0]=c*n*l-a*h*d,t[1]=a*h*l+c*n*d,t[2]=a*n*d-c*h*l,t[3]=a*n*l+c*h*d):e==="YZX"?(t[0]=c*n*l+a*h*d,t[1]=a*h*l+c*n*d,t[2]=a*n*d-c*h*l,t[3]=a*n*l-c*h*d):e==="XZY"&&(t[0]=c*n*l-a*h*d,t[1]=a*h*l-c*n*d,t[2]=a*n*d+c*h*l,t[3]=a*n*l+c*h*d),t},mat4ToQuaternion(r,e=A.vec4()){const t=r[0],i=r[4],s=r[8],o=r[1],a=r[5],n=r[9],l=r[2],c=r[6],h=r[10];let d;const p=t+a+h;return p>0?(d=.5/Math.sqrt(p+1),e[3]=.25/d,e[0]=(c-n)*d,e[1]=(s-l)*d,e[2]=(o-i)*d):t>a&&t>h?(d=2*Math.sqrt(1+t-a-h),e[3]=(c-n)/d,e[0]=.25*d,e[1]=(i+o)/d,e[2]=(s+l)/d):a>h?(d=2*Math.sqrt(1+a-t-h),e[3]=(s-l)/d,e[0]=(i+o)/d,e[1]=.25*d,e[2]=(n+c)/d):(d=2*Math.sqrt(1+h-t-a),e[3]=(o-i)/d,e[0]=(s+l)/d,e[1]=(n+c)/d,e[2]=.25*d),e},vec3PairToQuaternion(r,e,t=A.vec4()){const i=Math.sqrt(A.dotVec3(r,r)*A.dotVec3(e,e));let s=i+A.dotVec3(r,e);return s<1e-8*i?(s=0,Math.abs(r[0])>Math.abs(r[2])?(t[0]=-r[1],t[1]=r[0],t[2]=0):(t[0]=0,t[1]=-r[2],t[2]=r[1])):A.cross3Vec3(r,e,t),t[3]=s,A.normalizeQuaternion(t)},angleAxisToQuaternion(r,e=A.vec4()){const t=r[3]/2,i=Math.sin(t);return e[0]=i*r[0],e[1]=i*r[1],e[2]=i*r[2],e[3]=Math.cos(t),e},quaternionToEuler:(()=>{const r=new Ie(16);return(e,t,i)=>(i=i||A.vec3(),A.quaternionToRotationMat4(e,r),A.mat4ToEuler(r,t,i),i)})(),mulQuaternions(r,e,t=A.vec4()){const i=r[0],s=r[1],o=r[2],a=r[3],n=e[0],l=e[1],c=e[2],h=e[3];return t[0]=a*n+i*h+s*c-o*l,t[1]=a*l+s*h+o*n-i*c,t[2]=a*c+o*h+i*l-s*n,t[3]=a*h-i*n-s*l-o*c,t},vec3ApplyQuaternion(r,e,t=A.vec3()){const i=e[0],s=e[1],o=e[2],a=r[0],n=r[1],l=r[2],c=r[3],h=c*i+n*o-l*s,d=c*s+l*i-a*o,p=c*o+a*s-n*i,m=-a*i-n*s-l*o;return t[0]=h*c+m*-a+d*-l-p*-n,t[1]=d*c+m*-n+p*-a-h*-l,t[2]=p*c+m*-l+h*-n-d*-a,t},quaternionToMat4(r,e){e=A.identityMat4(e);const t=r[0],i=r[1],s=r[2],o=r[3],a=2*t,n=2*i,l=2*s,c=a*o,h=n*o,d=l*o,p=a*t,m=n*t,g=l*t,u=n*i,x=l*i,y=l*s;return e[0]=1-(u+y),e[1]=m+d,e[2]=g-h,e[4]=m-d,e[5]=1-(p+y),e[6]=x+c,e[8]=g+h,e[9]=x-c,e[10]=1-(p+u),e},quaternionToRotationMat4(r,e){const t=r[0],i=r[1],s=r[2],o=r[3],a=t+t,n=i+i,l=s+s,c=t*a,h=t*n,d=t*l,p=i*n,m=i*l,g=s*l,u=o*a,x=o*n,y=o*l;return e[0]=1-(p+g),e[4]=h-y,e[8]=d+x,e[1]=h+y,e[5]=1-(c+g),e[9]=m-u,e[2]=d-x,e[6]=m+u,e[10]=1-(c+p),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},normalizeQuaternion(r,e=r){const t=A.lenVec4([r[0],r[1],r[2],r[3]]);return e[0]=r[0]/t,e[1]=r[1]/t,e[2]=r[2]/t,e[3]=r[3]/t,e},conjugateQuaternion(r,e=r){return e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e[3]=r[3],e},inverseQuaternion(r,e){return A.normalizeQuaternion(A.conjugateQuaternion(r,e))},quaternionToAngleAxis(r,e=A.vec4()){r=A.normalizeQuaternion(r,Qg);const t=r[3],i=2*Math.acos(t),s=Math.sqrt(1-t*t);return s<.001?(e[0]=r[0],e[1]=r[1],e[2]=r[2]):(e[0]=r[0]/s,e[1]=r[1]/s,e[2]=r[2]/s),e[3]=i,e},AABB3(r){return new Ie(r||6)},AABB2(r){return new Ie(r||4)},OBB3(r){return new Ie(r||32)},OBB2(r){return new Ie(r||16)},Sphere3(r,e,t,i){return new Ie([r,e,t,i])},transformOBB3(r,e,t=e){let i;const s=e.length;let o,a,n;const l=r[0],c=r[1],h=r[2],d=r[3],p=r[4],m=r[5],g=r[6],u=r[7],x=r[8],y=r[9],P=r[10],_=r[11],b=r[12],B=r[13],w=r[14],C=r[15];for(i=0;i<s;i+=4)o=e[i+0],a=e[i+1],n=e[i+2],t[i+0]=l*o+p*a+x*n+b,t[i+1]=c*o+m*a+y*n+B,t[i+2]=h*o+g*a+P*n+w,t[i+3]=d*o+u*a+_*n+C;return t},containsAABB3:function(r,e){return r[0]<=e[0]&&e[3]<=r[3]&&r[1]<=e[1]&&e[4]<=r[4]&&r[2]<=e[2]&&e[5]<=r[5]},getAABB3Diag:(()=>{const r=new Ie(3),e=new Ie(3),t=new Ie(3);return i=>(r[0]=i[0],r[1]=i[1],r[2]=i[2],e[0]=i[3],e[1]=i[4],e[2]=i[5],A.subVec3(e,r,t),Math.abs(A.lenVec3(t)))})(),getAABB3DiagPoint:(()=>{const r=new Ie(3),e=new Ie(3),t=new Ie(3);return(i,s)=>{r[0]=i[0],r[1]=i[1],r[2]=i[2],e[0]=i[3],e[1]=i[4],e[2]=i[5];const o=A.subVec3(e,r,t),a=s[0]-i[0],n=i[3]-s[0],l=s[1]-i[1],c=i[4]-s[1],h=s[2]-i[2],d=i[5]-s[2];return o[0]+=a>n?a:n,o[1]+=l>c?l:c,o[2]+=h>d?h:d,Math.abs(A.lenVec3(o))}})(),getAABB3Area(r){const e=r[3]-r[0],t=r[4]-r[1],i=r[5]-r[2];return e*t*i},getAABB3Center(r,e){const t=e||A.vec3();return t[0]=(r[0]+r[3])/2,t[1]=(r[1]+r[4])/2,t[2]=(r[2]+r[5])/2,t},getAABB2Center(r,e){const t=e||A.vec2();return t[0]=(r[2]+r[0])/2,t[1]=(r[3]+r[1])/2,t},collapseAABB3(r=A.AABB3()){return r[0]=A.MAX_DOUBLE,r[1]=A.MAX_DOUBLE,r[2]=A.MAX_DOUBLE,r[3]=A.MIN_DOUBLE,r[4]=A.MIN_DOUBLE,r[5]=A.MIN_DOUBLE,r},AABB3ToOBB3(r,e=A.OBB3()){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=1,e[4]=r[3],e[5]=r[1],e[6]=r[2],e[7]=1,e[8]=r[3],e[9]=r[4],e[10]=r[2],e[11]=1,e[12]=r[0],e[13]=r[4],e[14]=r[2],e[15]=1,e[16]=r[0],e[17]=r[1],e[18]=r[5],e[19]=1,e[20]=r[3],e[21]=r[1],e[22]=r[5],e[23]=1,e[24]=r[3],e[25]=r[4],e[26]=r[5],e[27]=1,e[28]=r[0],e[29]=r[4],e[30]=r[5],e[31]=1,e},positions3ToAABB3:(()=>{const r=new Ie(3);return(e,t,i)=>{t=t||A.AABB3();let s=A.MAX_DOUBLE,o=A.MAX_DOUBLE,a=A.MAX_DOUBLE,n=A.MIN_DOUBLE,l=A.MIN_DOUBLE,c=A.MIN_DOUBLE,h,d,p;for(let m=0,g=e.length;m<g;m+=3)i?(r[0]=e[m+0],r[1]=e[m+1],r[2]=e[m+2],A.decompressPosition(r,i,r),h=r[0],d=r[1],p=r[2]):(h=e[m+0],d=e[m+1],p=e[m+2]),h<s&&(s=h),d<o&&(o=d),p<a&&(a=p),h>n&&(n=h),d>l&&(l=d),p>c&&(c=p);return t[0]=s,t[1]=o,t[2]=a,t[3]=n,t[4]=l,t[5]=c,t}})(),OBB3ToAABB3(r,e=A.AABB3()){let t=A.MAX_DOUBLE,i=A.MAX_DOUBLE,s=A.MAX_DOUBLE,o=A.MIN_DOUBLE,a=A.MIN_DOUBLE,n=A.MIN_DOUBLE,l,c,h;for(let d=0,p=r.length;d<p;d+=4)l=r[d+0],c=r[d+1],h=r[d+2],l<t&&(t=l),c<i&&(i=c),h<s&&(s=h),l>o&&(o=l),c>a&&(a=c),h>n&&(n=h);return e[0]=t,e[1]=i,e[2]=s,e[3]=o,e[4]=a,e[5]=n,e},points3ToAABB3(r,e=A.AABB3()){let t=A.MAX_DOUBLE,i=A.MAX_DOUBLE,s=A.MAX_DOUBLE,o=A.MIN_DOUBLE,a=A.MIN_DOUBLE,n=A.MIN_DOUBLE,l,c,h;for(let d=0,p=r.length;d<p;d++)l=r[d][0],c=r[d][1],h=r[d][2],l<t&&(t=l),c<i&&(i=c),h<s&&(s=h),l>o&&(o=l),c>a&&(a=c),h>n&&(n=h);return e[0]=t,e[1]=i,e[2]=s,e[3]=o,e[4]=a,e[5]=n,e},points3ToSphere3:(()=>{const r=new Ie(3);return(e,t)=>{t=t||A.vec4();let i=0,s=0,o=0,a;const n=e.length;for(a=0;a<n;a++)i+=e[a][0],s+=e[a][1],o+=e[a][2];t[0]=i/n,t[1]=s/n,t[2]=o/n;let l=0,c;for(a=0;a<n;a++)c=Math.abs(A.lenVec3(A.subVec3(e[a],t,r))),c>l&&(l=c);return t[3]=l,t}})(),positions3ToSphere3:(()=>{const r=new Ie(3),e=new Ie(3);return(t,i)=>{i=i||A.vec4();let s=0,o=0,a=0,n;const l=t.length;let c=0;for(n=0;n<l;n+=3)s+=t[n],o+=t[n+1],a+=t[n+2];const h=l/3;i[0]=s/h,i[1]=o/h,i[2]=a/h;let d;for(n=0;n<l;n+=3)r[0]=t[n],r[1]=t[n+1],r[2]=t[n+2],d=Math.abs(A.lenVec3(A.subVec3(r,i,e))),d>c&&(c=d);return i[3]=c,i}})(),OBB3ToSphere3:(()=>{const r=new Ie(3),e=new Ie(3);return(t,i)=>{i=i||A.vec4();let s=0,o=0,a=0,n;const l=t.length,c=l/4;for(n=0;n<l;n+=4)s+=t[n+0],o+=t[n+1],a+=t[n+2];i[0]=s/c,i[1]=o/c,i[2]=a/c;let h=0,d;for(n=0;n<l;n+=4)r[0]=t[n+0],r[1]=t[n+1],r[2]=t[n+2],d=Math.abs(A.lenVec3(A.subVec3(r,i,e))),d>h&&(h=d);return i[3]=h,i}})(),getSphere3Center(r,e=A.vec3()){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e},getPositionsCenter(r,e=A.vec3()){let t=0,i=0,s=0;for(var o=0,a=r.length;o<a;o+=3)t+=r[o+0],i+=r[o+1],s+=r[o+2];const n=r.length/3;return e[0]=t/n,e[1]=i/n,e[2]=s/n,e},expandAABB3(r,e){return r[0]>e[0]&&(r[0]=e[0]),r[1]>e[1]&&(r[1]=e[1]),r[2]>e[2]&&(r[2]=e[2]),r[3]<e[3]&&(r[3]=e[3]),r[4]<e[4]&&(r[4]=e[4]),r[5]<e[5]&&(r[5]=e[5]),r},expandAABB3Point3(r,e){return r[0]>e[0]&&(r[0]=e[0]),r[1]>e[1]&&(r[1]=e[1]),r[2]>e[2]&&(r[2]=e[2]),r[3]<e[0]&&(r[3]=e[0]),r[4]<e[1]&&(r[4]=e[1]),r[5]<e[2]&&(r[5]=e[2]),r},expandAABB3Points3(r,e){for(var t,i,s,o=0,a=e.length;o<a;o+=3)t=e[o],i=e[o+1],s=e[o+2],r[0]>t&&(r[0]=t),r[1]>i&&(r[1]=i),r[2]>s&&(r[2]=s),r[3]<t&&(r[3]=t),r[4]<i&&(r[4]=i),r[5]<s&&(r[5]=s);return r},collapseAABB2(r=A.AABB2()){return r[0]=A.MAX_DOUBLE,r[1]=A.MAX_DOUBLE,r[2]=A.MIN_DOUBLE,r[3]=A.MIN_DOUBLE,r},point3AABB3Intersect(r,e){return r[0]>e[0]||r[3]<e[0]||r[1]>e[1]||r[4]<e[1]||r[2]>e[2]||r[5]<e[2]},point3AABB3AbsoluteIntersect(r,e){return r[0]<=e[0]&&r[3]>=e[0]&&r[1]<=e[1]&&r[4]>=e[1]&&r[2]<=e[2]&&r[5]>=e[2]},planeAABB3Intersect(r,e,t){let i,s;return r[0]>0?(i=r[0]*t[0],s=r[0]*t[3]):(i=r[0]*t[3],s=r[0]*t[0]),r[1]>0?(i+=r[1]*t[1],s+=r[1]*t[4]):(i+=r[1]*t[4],s+=r[1]*t[1]),r[2]>0?(i+=r[2]*t[2],s+=r[2]*t[5]):(i+=r[2]*t[5],s+=r[2]*t[2]),i<=-e&&s<=-e?-1:i>=-e&&s>=-e?1:0},OBB3ToAABB2(r,e=A.AABB2()){let t=A.MAX_DOUBLE,i=A.MAX_DOUBLE,s=A.MIN_DOUBLE,o=A.MIN_DOUBLE,a,n,l,c;for(let h=0,d=r.length;h<d;h+=4)a=r[h+0],n=r[h+1],l=r[h+3]||1,c=1/l,a*=c,n*=c,a<t&&(t=a),n<i&&(i=n),a>s&&(s=a),n>o&&(o=n);return e[0]=t,e[1]=i,e[2]=s,e[3]=o,e},expandAABB2(r,e){return r[0]>e[0]&&(r[0]=e[0]),r[1]>e[1]&&(r[1]=e[1]),r[2]<e[2]&&(r[2]=e[2]),r[3]<e[3]&&(r[3]=e[3]),r},expandAABB2Point2(r,e){return r[0]>e[0]&&(r[0]=e[0]),r[1]>e[1]&&(r[1]=e[1]),r[2]<e[0]&&(r[2]=e[0]),r[3]<e[1]&&(r[3]=e[1]),r},AABB2ToCanvas(r,e,t,i=r){const s=(r[0]+1)*.5,o=(r[1]+1)*.5,a=(r[2]+1)*.5,n=(r[3]+1)*.5;return i[0]=Math.floor(s*e),i[1]=t-Math.floor(n*t),i[2]=Math.floor(a*e),i[3]=t-Math.floor(o*t),i},tangentQuadraticBezier(r,e,t,i){return 2*(1-r)*(t-e)+2*r*(i-t)},tangentQuadraticBezier3(r,e,t,i,s){return-3*e*(1-r)*(1-r)+3*t*(1-r)*(1-r)-6*r*t*(1-r)+6*r*i*(1-r)-3*r*r*i+3*r*r*s},tangentSpline(r){const e=6*r*r-6*r,t=3*r*r-4*r+1,i=-6*r*r+6*r,s=3*r*r-2*r;return e+t+i+s},catmullRomInterpolate(r,e,t,i,s){const o=(t-r)*.5,a=(i-e)*.5,n=s*s,l=s*n;return(2*e-2*t+o+a)*l+(-3*e+3*t-2*o-a)*n+o*s+e},b2p0(r,e){const t=1-r;return t*t*e},b2p1(r,e){return 2*(1-r)*r*e},b2p2(r,e){return r*r*e},b2(r,e,t,i){return this.b2p0(r,e)+this.b2p1(r,t)+this.b2p2(r,i)},b3p0(r,e){const t=1-r;return t*t*t*e},b3p1(r,e){const t=1-r;return 3*t*t*r*e},b3p2(r,e){return 3*(1-r)*r*r*e},b3p3(r,e){return r*r*r*e},b3(r,e,t,i,s){return this.b3p0(r,e)+this.b3p1(r,t)+this.b3p2(r,i)+this.b3p3(r,s)},triangleNormal(r,e,t,i=A.vec3()){const s=e[0]-r[0],o=e[1]-r[1],a=e[2]-r[2],n=t[0]-r[0],l=t[1]-r[1],c=t[2]-r[2],h=o*c-a*l,d=a*n-s*c,p=s*l-o*n,m=Math.sqrt(h*h+d*d+p*p);return m===0?(i[0]=0,i[1]=0,i[2]=0):(i[0]=h/m,i[1]=d/m,i[2]=p/m),i},rayTriangleIntersect:(()=>{const r=new Ie(3),e=new Ie(3),t=new Ie(3),i=new Ie(3),s=new Ie(3);return(o,a,n,l,c,h)=>{h=h||A.vec3();const d=1e-6,p=A.subVec3(l,n,r),m=A.subVec3(c,n,e),g=A.cross3Vec3(a,m,t),u=A.dotVec3(p,g);if(u<d)return null;const x=A.subVec3(o,n,i),y=A.dotVec3(x,g);if(y<0||y>u)return null;const P=A.cross3Vec3(x,p,s),_=A.dotVec3(a,P);if(_<0||y+_>u)return null;const b=A.dotVec3(m,P)/u;return h[0]=o[0]+b*a[0],h[1]=o[1]+b*a[1],h[2]=o[2]+b*a[2],h}})(),rayPlaneIntersect:(()=>{const r=new Ie(3),e=new Ie(3),t=new Ie(3),i=new Ie(3);return(s,o,a,n,l,c)=>{c=c||A.vec3(),o=A.normalizeVec3(o,r);const h=A.subVec3(n,a,e),d=A.subVec3(l,a,t),p=A.cross3Vec3(h,d,i);A.normalizeVec3(p,p);const m=-A.dotVec3(a,p),g=-(A.dotVec3(s,p)+m)/A.dotVec3(o,p);return c[0]=s[0]+g*o[0],c[1]=s[1]+g*o[1],c[2]=s[2]+g*o[2],c}})(),cartesianToBarycentric:(()=>{const r=new Ie(3),e=new Ie(3),t=new Ie(3);return(i,s,o,a,n)=>{const l=A.subVec3(a,s,r),c=A.subVec3(o,s,e),h=A.subVec3(i,s,t),d=A.dotVec3(l,l),p=A.dotVec3(l,c),m=A.dotVec3(l,h),g=A.dotVec3(c,c),u=A.dotVec3(c,h),x=d*g-p*p;if(x===0)return null;const y=1/x,P=(g*m-p*u)*y,_=(d*u-p*m)*y;return n[0]=1-P-_,n[1]=_,n[2]=P,n}})(),barycentricInsideTriangle(r){const e=r[1],t=r[2];return t>=0&&e>=0&&t+e<1},barycentricToCartesian(r,e,t,i,s=A.vec3()){const o=r[0],a=r[1],n=r[2];return s[0]=e[0]*o+t[0]*a+i[0]*n,s[1]=e[1]*o+t[1]*a+i[1]*n,s[2]=e[2]*o+t[2]*a+i[2]*n,s},mergeVertices(r,e,t,i){const s={},o=[],a=[],n=e?[]:null,l=t?[]:null,c=[];let h,d,p,m;const u=10**4;let x,y,P=0;for(x=0,y=r.length;x<y;x+=3)h=r[x],d=r[x+1],p=r[x+2],m=`${Math.round(h*u)}_${Math.round(d*u)}_${Math.round(p*u)}`,s[m]===void 0&&(s[m]=a.length/3,a.push(h),a.push(d),a.push(p),e&&(n.push(e[x]),n.push(e[x+1]),n.push(e[x+2])),t&&(l.push(t[P]),l.push(t[P+1]))),o[x/3]=s[m],P+=2;for(x=0,y=i.length;x<y;x++)c[x]=o[i[x]];const _={positions:a,indices:c};return n&&(_.normals=n),l&&(_.uv=l),_},buildNormals:(()=>{const r=new Ie(3),e=new Ie(3),t=new Ie(3),i=new Ie(3),s=new Ie(3),o=new Ie(3);return(a,n,l)=>{let c,h;const d=new Array(a.length/3);let p,m,g;for(c=0,h=n.length;c<h;c+=3){p=n[c],m=n[c+1],g=n[c+2],r[0]=a[p*3],r[1]=a[p*3+1],r[2]=a[p*3+2],e[0]=a[m*3],e[1]=a[m*3+1],e[2]=a[m*3+2],t[0]=a[g*3],t[1]=a[g*3+1],t[2]=a[g*3+2],A.subVec3(e,r,i),A.subVec3(t,r,s);const _=A.vec3();A.normalizeVec3(A.cross3Vec3(i,s,o),_),d[p]||(d[p]=[]),d[m]||(d[m]=[]),d[g]||(d[g]=[]),d[p].push(_),d[m].push(_),d[g].push(_)}l=l&&l.length===a.length?l:new Float32Array(a.length);let u,x,y,P;for(c=0,h=d.length;c<h;c++){u=d[c].length,x=0,y=0,P=0;for(let _=0;_<u;_++)x+=d[c][_][0],y+=d[c][_][1],P+=d[c][_][2];l[c*3]=x/u,l[c*3+1]=y/u,l[c*3+2]=P/u}return l}})(),buildTangents:(()=>{const r=new Ie(3),e=new Ie(3),t=new Ie(3),i=new Ie(3),s=new Ie(3),o=new Ie(3),a=new Ie(3);return(n,l,c)=>{const h=new Float32Array(n.length);for(let d=0;d<l.length;d+=3){let p=l[d];const m=n.subarray(p*3,p*3+3),g=c.subarray(p*2,p*2+2);p=l[d+1];const u=n.subarray(p*3,p*3+3),x=c.subarray(p*2,p*2+2);p=l[d+2];const y=n.subarray(p*3,p*3+3),P=c.subarray(p*2,p*2+2),_=A.subVec3(u,m,r),b=A.subVec3(y,m,e),B=A.subVec2(x,g,t),w=A.subVec2(P,g,i),C=1/(B[0]*w[1]-B[1]*w[0]),E=A.mulVec3Scalar(A.subVec3(A.mulVec3Scalar(_,w[1],s),A.mulVec3Scalar(b,B[1],o),a),C,o);let I;for(let R=0;R<3;R++)I=l[d+R]*3,h[I]+=E[0],h[I+1]+=E[1],h[I+2]+=E[2]}return h}})(),buildPickTriangles(r,e,t){const i=e.length,s=t?new Uint16Array(i*9):new Float32Array(i*9),o=new Uint8Array(i*12);let a=0,n,l=0,c=0,h,d,p,m,g;for(let u=0;u<i;u+=3)g=a>>24&255,m=a>>16&255,p=a>>8&255,d=a&255,h=e[u],n=h*3,s[l++]=r[n],s[l++]=r[n+1],s[l++]=r[n+2],o[c++]=d,o[c++]=p,o[c++]=m,o[c++]=g,h=e[u+1],n=h*3,s[l++]=r[n],s[l++]=r[n+1],s[l++]=r[n+2],o[c++]=d,o[c++]=p,o[c++]=m,o[c++]=g,h=e[u+2],n=h*3,s[l++]=r[n],s[l++]=r[n+1],s[l++]=r[n+2],o[c++]=d,o[c++]=p,o[c++]=m,o[c++]=g,a++;return{positions:s,colors:o}},faceToVertexNormals(r,e,t={}){const i=t.smoothNormalsAngleThreshold||20,s={},o=[],a={};let n,l,c,h,d;const m=10**4;let g,u,x,y,P,_;for(u=0,y=r.length;u<y;u+=3){g=u/3,l=r[u],c=r[u+1],h=r[u+2],d=`${Math.round(l*m)}_${Math.round(c*m)}_${Math.round(h*m)}`,s[d]===void 0?s[d]=[g]:s[d].push(g);const b=A.normalizeVec3([e[u],e[u+1],e[u+2]]);o[g]=b,n=A.vec4([b[0],b[1],b[2],1]),a[g]=n}for(d in s)if(s.hasOwnProperty(d)){const b=s[d],B=b.length;for(u=0;u<B;u++){const w=b[u];for(n=a[w],x=0;x<B;x++){if(u===x)continue;const C=b[x];P=o[w],_=o[C],Math.abs(A.angleVec3(P,_)/A.DEGTORAD)<i&&(n[0]+=_[0],n[1]+=_[1],n[2]+=_[2],n[3]+=1)}}}for(u=0,y=e.length;u<y;u+=3)n=a[u/3],e[u+0]=n[0]/n[3],e[u+1]=n[1]/n[3],e[u+2]=n[2]/n[3]},transformRay:(()=>{const r=new Ie(4),e=new Ie(4);return(t,i,s,o,a)=>{r[0]=i[0],r[1]=i[1],r[2]=i[2],r[3]=1,A.transformVec4(t,r,e),o[0]=e[0],o[1]=e[1],o[2]=e[2],r[0]=s[0],r[1]=s[1],r[2]=s[2],A.transformVec3(t,r,e),A.normalizeVec3(e),a[0]=e[0],a[1]=e[1],a[2]=e[2]}})(),canvasPosToWorldRay:(()=>{const r=new Ie(16),e=new Ie(4),t=new Ie(4),i=(s,o,a,n,l)=>{l[0]=s,l[1]=o,l[2]=a,l[3]=1,A.transformVec4(r,l,l),n||A.mulVec4Scalar(l,1/l[3])};return(s,o,a,n,l,c,h)=>{const d=n==="ortho";A.mulMat4(a,o,r),A.inverseMat4(r,r);const p=2*l[0]/s.width-1,m=1-2*l[1]/s.height;i(p,m,-1,d,e),i(p,m,1,d,t),c[0]=e[0],c[1]=e[1],c[2]=e[2],A.subVec3(t,e,h),A.normalizeVec3(h)}})(),canvasPosToLocalRay:(()=>{const r=new Ie(3),e=new Ie(3);return(t,i,s,o,a,n,l,c)=>{A.canvasPosToWorldRay(t,i,s,o,n,r,e),A.worldRayToLocalRay(a,r,e,l,c)}})(),worldRayToLocalRay:(()=>{const r=new Ie(16),e=new Ie(4),t=new Ie(4);return(i,s,o,a,n)=>{const l=A.inverseMat4(i,r);e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=1,A.transformVec4(l,e,t),a[0]=t[0],a[1]=t[1],a[2]=t[2],A.transformVec3(l,o,n)}})(),buildKDTree:(()=>{const t=new Float32Array;function i(s,o,a,n){const l=new Ie(6),c={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:l};l[0]=l[1]=l[2]=Number.POSITIVE_INFINITY,l[3]=l[4]=l[5]=Number.NEGATIVE_INFINITY;let h,d;for(h=0,d=s.length;h<d;++h){var p=s[h]*3;for(let _=0;_<3;++_){const b=o[p+_]*3;a[b]<l[0]&&(l[0]=a[b]),a[b]>l[3]&&(l[3]=a[b]),a[b+1]<l[1]&&(l[1]=a[b+1]),a[b+1]>l[4]&&(l[4]=a[b+1]),a[b+2]<l[2]&&(l[2]=a[b+2]),a[b+2]>l[5]&&(l[5]=a[b+2])}}if(s.length<20||n>10)return c.triangles=s,c.leaf=!0,c;t[0]=l[3]-l[0],t[1]=l[4]-l[1],t[2]=l[5]-l[2];let m=0;t[1]>t[m]&&(m=1),t[2]>t[m]&&(m=2),c.splitDim=m;const g=(l[m]+l[m+3])/2,u=new Array(s.length);let x=0;const y=new Array(s.length);let P=0;for(h=0,d=s.length;h<d;++h){var p=s[h]*3;const b=o[p],B=o[p+1],w=o[p+2],C=b*3,E=B*3,I=w*3;a[C+m]<=g||a[E+m]<=g||a[I+m]<=g?u[x++]=s[h]:y[P++]=s[h]}return u.length=x,y.length=P,c.left=i(u,o,a,n+1),c.right=i(y,o,a,n+1),c}return(s,o)=>{const a=s.length/3,n=new Array(a);for(let l=0;l<a;++l)n[l]=l;return i(n,s,o,0)}})(),decompressPosition(r,e,t){t=t||r,t[0]=r[0]*e[0]+e[12],t[1]=r[1]*e[5]+e[13],t[2]=r[2]*e[10]+e[14]},decompressPositions(r,e,t=new Float32Array(r.length)){for(let i=0,s=r.length;i<s;i+=3)t[i+0]=r[i+0]*e[0]+e[12],t[i+1]=r[i+1]*e[5]+e[13],t[i+2]=r[i+2]*e[10]+e[14];return t},decompressUV(r,e,t){t[0]=r[0]*e[0]+e[6],t[1]=r[1]*e[4]+e[7]},decompressUVs(r,e,t=new Float32Array(r.length)){for(let i=0,s=r.length;i<s;i+=3)t[i+0]=r[i+0]*e[0]+e[6],t[i+1]=r[i+1]*e[4]+e[7];return t},octDecodeVec2(r,e){let t=r[0],i=r[1];t=(2*t+1)/255,i=(2*i+1)/255;const s=1-Math.abs(t)-Math.abs(i);s<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));const o=Math.sqrt(t*t+i*i+s*s);return e[0]=t/o,e[1]=i/o,e[2]=s/o,e},octDecodeVec2s(r,e){for(let t=0,i=0,s=r.length;t<s;t+=2){let o=r[t+0],a=r[t+1];o=(2*o+1)/255,a=(2*a+1)/255;const n=1-Math.abs(o)-Math.abs(a);n<0&&(o=(1-Math.abs(a))*(o>=0?1:-1),a=(1-Math.abs(o))*(a>=0?1:-1));const l=Math.sqrt(o*o+a*a+n*n);e[i+0]=o/l,e[i+1]=a/l,e[i+2]=n/l,i+=3}return e}};A.buildEdgeIndices=function(){const r=[],e=[],t=[],i=[],s=[];let o=0;const a=new Uint16Array(3),n=new Uint16Array(3),l=new Uint16Array(3),c=A.vec3(),h=A.vec3(),d=A.vec3(),p=A.vec3(),m=A.vec3(),g=A.vec3(),u=A.vec3();function x(P,_){const b={};let B,w,C,E;const R=Math.pow(10,4);let F,z,Q=0;for(F=0,z=P.length;F<z;F+=3)B=P[F],w=P[F+1],C=P[F+2],E=Math.round(B*R)+"_"+Math.round(w*R)+"_"+Math.round(C*R),b[E]===void 0&&(b[E]=Q/3,r[Q++]=B,r[Q++]=w,r[Q++]=C),e[F/3]=b[E];for(F=0,z=_.length;F<z;F++)i[F]=e[_[F]],t[i[F]]=_[F]}function y(P,_){o=0;for(let b=0,B=P;b<B;b+=3){const w=i[b]*3,C=i[b+1]*3,E=i[b+2]*3;_?(a[0]=r[w],a[1]=r[w+1],a[2]=r[w+2],n[0]=r[C],n[1]=r[C+1],n[2]=r[C+2],l[0]=r[E],l[1]=r[E+1],l[2]=r[E+2],A.decompressPosition(a,_,c),A.decompressPosition(n,_,h),A.decompressPosition(l,_,d)):(c[0]=r[w],c[1]=r[w+1],c[2]=r[w+2],h[0]=r[C],h[1]=r[C+1],h[2]=r[C+2],d[0]=r[E],d[1]=r[E+1],d[2]=r[E+2]),A.subVec3(d,h,p),A.subVec3(c,h,m),A.cross3Vec3(p,m,g),A.normalizeVec3(g,u);const I=s[o]||(s[o]={normal:A.vec3()});I.normal[0]=u[0],I.normal[1]=u[1],I.normal[2]=u[2],o++}}return function(P,_,b,B){x(P,_),y(_.length,b);const w=[],C=Math.cos(A.DEGTORAD*B),E={};let I,R,F,z,Q,H=!1,ae,pe,ge,fe,Me,be;for(let Fe=0,Re=_.length;Fe<Re;Fe+=3){const Te=Fe/3;for(let Ne=0;Ne<3;Ne++)I=i[Fe+Ne],R=i[Fe+(Ne+1)%3],F=Math.min(I,R),z=Math.max(I,R),Q=F+","+z,E[Q]===void 0?E[Q]={index1:F,index2:z,face1:Te,face2:void 0}:E[Q].face2=Te}for(Q in E)ae=E[Q],!(ae.face2!==void 0&&(pe=s[ae.face1].normal,ge=s[ae.face2].normal,fe=A.dotVec3(pe,ge),fe>C))&&(Me=t[ae.index1],be=t[ae.index2],(!H&&Me>65535||be>65535)&&(H=!0),w.push(Me),w.push(be));return H?new Uint32Array(w):new Uint16Array(w)}}();A.planeClipsPositions3=function(r,e,t,i=3){for(let s=0,o=t.length;s<o;s+=i)if(Xs[0]=t[s+0]-r[0],Xs[1]=t[s+1]-r[1],Xs[2]=t[s+2]-r[2],Xs[0]*e[0]+Xs[1]*e[1]+Xs[2]*e[2]<0)return!0;return!1};class Vg{constructor(){this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}get length(){return this._length}shift(){if(this._index>=this._headLength){const t=this._head;if(t.length=0,this._head=this._tail,this._tail=t,this._index=0,this._headLength=this._head.length,!this._headLength)return}const e=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,e}push(e){return this._length++,this._tail.push(e),this}unshift(e){return this._head[--this._index]=e,this._length++,this}}const _t={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}};function Af(r,e){if(r.nodeType===r.TEXT_NODE){var t=r.nodeValue;if(t.match(/^\s+$/)===null)return t}else if(r.nodeType===r.ELEMENT_NODE||r.nodeType===r.DOCUMENT_NODE){var i={type:r.nodeName,children:[]};if(r.nodeType===r.ELEMENT_NODE)for(var s=0;s<r.attributes.length;s++){var o=r.attributes[s],a=e[o.nodeName]||o.nodeName;i[a]=o.nodeValue}for(var n=0;n<r.childNodes.length;n++){var l=r.childNodes[n],s=Af(l,e);s&&i.children.push(s)}return i}}function Hg(r){return JSON.parse(JSON.stringify(r))}var jg=[["0",10],["A",26],["a",26],["_",1],["$",1]].map(function(r){for(var e=[],t=r[0].charCodeAt(0),i=t+r[1],s=t;s<i;++s)e.push(s);return String.fromCharCode.apply(null,e)}).join("");function Zc(r,e){var t=!e||e===4?[0,6,12,18]:[0,6];return t.map(function(i){return jg.substr(parseInt(r/(1<<i))%64,1)}).reverse().join("")}function zg(r){var e=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map(function(t){return parseInt(r.substr(t,2),16)});return Zc(e[0],2)+[1,4,7,10,13].map(function(t){return Zc((e[t]<<16)+(e[t+1]<<8)+e[t+2])}).join("")}function Gg(r,e){var t=[],i=function(s){s.type===e&&t.push(s),(s.children||[]).forEach(function(o){i(o)})};return i(r),t}function Wg(r){return new Promise(function(e,t){setTimeout(e,r)})}function Kg(r){return new Promise(function(e,t){var i=new XMLHttpRequest;i.open(r.method||"GET",r.url,!0),i.onload=function(s){i.readyState===4&&(i.status===200?e(i.responseXML):t(i.statusText))},i.send(null)})}const Xg=function(){for(var r={},e=window.location.search.substring(1),t=e.split("&"),i=0;i<t.length;i++){var s=t[i].split("=");if(typeof r[s[0]]>"u")r[s[0]]=decodeURIComponent(s[1]);else if(typeof r[s[0]]=="string"){var o=[r[s[0]],decodeURIComponent(s[1])];r[s[0]]=o}else r[s[0]].push(decodeURIComponent(s[1]))}return r}();function Yg(r,e,t){var i=o=>{};e=e||i,t=t||i;var s=new XMLHttpRequest;s.overrideMimeType("application/json"),s.open("GET",r,!0),s.addEventListener("load",function(o){var a=o.target.response;if(this.status===200){var n;try{n=JSON.parse(a)}catch(l){t(`utils.loadJSON(): Failed to parse JSON response - ${l}`)}e(n)}else if(this.status===0){console.warn("loadFile: HTTP Status 0 received.");try{e(JSON.parse(a))}catch(l){t(`utils.loadJSON(): Failed to parse JSON response - ${l}`)}}else t(o)},!1),s.addEventListener("error",function(o){t(o)},!1),s.send(null)}function $g(r,e,t){var i=l=>{};e=e||i,t=t||i;const s=/^data:(.*?)(;base64)?,(.*)$/,o=r.match(s);if(o){const l=!!o[2];var a=o[3];a=window.decodeURIComponent(a),l&&(a=window.atob(a));try{const c=new ArrayBuffer(a.length),h=new Uint8Array(c);for(var n=0;n<a.length;n++)h[n]=a.charCodeAt(n);It.scheduleTask(()=>{e(c)})}catch(c){It.scheduleTask(()=>{t(c)})}}else{const l=new XMLHttpRequest;l.open("GET",r,!0),l.responseType="arraybuffer",l.onreadystatechange=function(){l.readyState===4&&(l.status===200?e(l.response):t("loadArrayBuffer error : "+l.response))},l.send(null)}}function Zg(r){return r&&!r.propertyIsEnumerable("length")&&typeof r=="object"&&typeof r.length=="number"}function qg(r){return typeof r=="string"||r instanceof String}function Jg(r){return!isNaN(parseFloat(r))&&isFinite(r)}function e_(r){return we.isString(r)||we.isNumeric(r)}function t_(r,e){if(!r||!e)return!1;const t=we.isNumeric(r)||we.isString(r)?`${r}`:r.id,i=we.isNumeric(e)||we.isString(e)?`${e}`:e.id;return t===i}function i_(r){return typeof r=="function"}function s_(r){const e={}.constructor;return!!r&&r.constructor===e}function r_(r){return we.apply(r,{})}function o_(r,e){for(const t in r)r.hasOwnProperty(t)&&(e[t]=r[t]);return e}function n_(r,e){for(const t in r)r.hasOwnProperty(t)&&r[t]!==void 0&&r[t]!==null&&(e[t]=r[t]);return e}function a_(r,e){for(const t in r)r.hasOwnProperty(t)&&(e[t]===void 0||e[t]===null)&&(e[t]=r[t]);return e}function l_(r){for(const e in r)if(r.hasOwnProperty(e))return!1;return!0}function A_(r){return we.isNumeric(r)?`${r}`:`'${r}'`}function c_(r,e){const t=new r.constructor(r.length+e.length);return t.set(r),t.set(e,r.length),t}function h_(r){var e=[];function t(i){i.id=i.uuid,delete i.oid,e.push(i);var s=i.children;if(s)for(var o=0,a=s.length;o<a;o++){const n=s[o];n.parent=i.id,t(s[o])}i.children=[]}return t(r),e}const we={xmlToJson:Af,clone:Hg,compressGuid:zg,findNodeOfType:Gg,timeout:Wg,httpRequest:Kg,loadJSON:Yg,loadArraybuffer:$g,queryString:Xg,isArray:Zg,isString:qg,isNumeric:Jg,isID:e_,isSameComponent:t_,isFunction:i_,isObject:s_,copy:r_,apply:o_,apply2:n_,applyIf:a_,isEmptyObject:l_,inQuotes:A_,concat:c_,flattenParentChildHierarchy:h_},fa={},qc=new Di,Ys=new Vg,Yi={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},Jc=10,vs=[],cf=30;let vo=0,br,Br=0;function u_(){this.version="1.0.0",this.scenes={},this._superTypes={},this._addScene=function(r){if(r.id){if(It.scenes[r.id]){console.error(`[ERROR] Scene ${we.inQuotes(r.id)} already exists`);return}}else r.id=qc.addItem({});It.scenes[r.id]=r;const e=r.ticksPerOcclusionTest,t=r.ticksPerRender;fa[r.id]={ticksPerOcclusionTest:e,ticksPerRender:t,renderCountdown:t},_t.components.scenes++,r.once("destroyed",()=>{qc.removeItem(r.id),delete It.scenes[r.id],delete fa[r.id],_t.components.scenes--})},this.clear=function(){let r;for(const e in It.scenes)It.scenes.hasOwnProperty(e)&&(r=It.scenes[e],e==="default.scene"?r.clear():(r.destroy(),delete It.scenes[r.id]))},this.scheduleTask=function(r,e=null){Ys.push(r),Ys.push(e)},this.runTasks=function(r=-1){let e=new Date().getTime(),t,i,s=0;for(;Ys.length>0&&(r<0||e<r);)t=Ys.shift(),i=Ys.shift(),i?t.call(i):t(),e=new Date().getTime(),s++;return s},this.getNumTasks=function(){return Ys.length}}const It=new u_,hf=function(){let r=Date.now();if(br=r-vo,vo>0&&br>0){var e=1e3/br;Br+=e,vs.push(e),vs.length>=cf&&(Br-=vs.shift()),_t.frame.fps=Math.round(Br/vs.length)}for(let t in It.scenes)It.scenes[t].compile();df(r),vo=r};function d_(r,e){let t=Date.now()+e;function i(){const s=Date.now()-t;r(),t+=e,setTimeout(i,Math.max(0,e-s))}return i(),{cancel:function(){}}}d_(()=>{hf()},100);const uf=function(){let r=Date.now();if(br=r-vo,vo>0&&br>0){var e=1e3/br;Br+=e,vs.push(e),vs.length>=cf&&(Br-=vs.shift()),_t.frame.fps=Math.round(Br/vs.length)}df(r),p_(r),f_(),window.requestPostAnimationFrame!==void 0?window.requestPostAnimationFrame(hf):requestAnimationFrame(uf)};uf();function df(r){const e=It.runTasks(r+Jc),t=It.getNumTasks();_t.frame.tasksRun=e,_t.frame.tasksScheduled=t,_t.frame.tasksBudget=Jc}function p_(r){Yi.time=r;for(var e in It.scenes)if(It.scenes.hasOwnProperty(e)){var t=It.scenes[e];Yi.sceneId=e,Yi.startTime=t.startTime,Yi.deltaTime=Yi.prevTime!=null?Yi.time-Yi.prevTime:0,t.fire("tick",Yi,!0)}Yi.prevTime=r}function f_(){const r=It.scenes,e=!1;let t,i,s,o,a;for(a in r)r.hasOwnProperty(a)&&(t=r[a],i=fa[a],i||(i=fa[a]={}),s=t.ticksPerOcclusionTest,i.ticksPerOcclusionTest!==s&&(i.ticksPerOcclusionTest=s,i.renderCountdown=s),--t.occlusionTestCountdown<=0&&(t.doOcclusionTest(),t.occlusionTestCountdown=s),o=t.ticksPerRender,i.ticksPerRender!==o&&(i.ticksPerRender=o,i.renderCountdown=o),--i.renderCountdown===0&&(t.render(e),i.renderCountdown=o))}class vt{get type(){return"Component"}get isComponent(){return!0}constructor(e=null,t={}){if(this.scene=null,this.type==="Scene")this.scene=this,this.viewer=t.viewer;else{if(e.type==="Scene")this.scene=e;else if(e instanceof vt)this.scene=e.scene;else throw"Invalid param: owner must be a Component";this._owner=e}this._dontClear=!!t.dontClear,this._renderer=this.scene._renderer,this.meta=t.meta||{},this.id=t.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,e&&e._own(this)}glRedraw(){this._renderer&&(this._renderer.imageDirty(),this.castsShadow&&this._renderer.shadowsDirty())}glResort(){this._renderer&&this._renderer.needStateSort()}get owner(){return this._owner}isType(e){return this.type===e}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),i!==!0&&(this._events[e]=t||!0);const s=this._eventSubs[e];let o;if(s)for(const a in s)s.hasOwnProperty(a)&&(o=s[a],this._eventCallDepth++,this._eventCallDepth<300?o.callback.call(o.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}on(e,t,i){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new Di),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});let s=this._eventSubs[e];s?this._eventSubsNum[e]++:(s={},this._eventSubs[e]=s,this._eventSubsNum[e]=1);const o=this._subIdMap.addItem();s[o]={callback:t,scope:i||this},this._subIdEvents[o]=e;const a=this._events[e];return a!==void 0&&t.call(i||this,a),o}off(e){if(e==null||!this._subIdEvents)return;const t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];const i=this._eventSubs[t];i&&(delete i[e],this._eventSubsNum[t]--),this._subIdMap.removeItem(e)}}once(e,t,i){const s=this,o=this.on(e,function(a){s.off(o),t.call(i||this,a)},i)}hasSubs(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}log(e){e="[LOG]"+this._message(e),window.console.log(e),this.scene.fire("log",e)}_message(e){return" ["+this.type+" "+we.inQuotes(this.id)+"]: "+e}warn(e){e="[WARN]"+this._message(e),window.console.warn(e),this.scene.fire("warn",e)}error(e){e="[ERROR]"+this._message(e),window.console.error(e),this.scene.fire("error",e)}_attach(e){const t=e.name;if(!t){this.error("Component 'name' expected");return}let i=e.component;const s=e.sceneDefault,o=e.sceneSingleton,a=e.type,n=e.on,l=e.recompiles!==!1;let c=!1;if(i&&(we.isNumeric(i)||we.isString(i))){const g=i;if(i=this.scene.components[g],!i){this.error("Component not found: "+we.inQuotes(g));return}}if(!i){if(o===!0){const g=this.scene.types[a];for(const u in g)if(g.hasOwnProperty){i=g[u];break}if(!i)return this.error("Scene has no default component for '"+t+"'"),null}else if(s===!0&&(i=this.scene[t],!i))return this.error("Scene has no default component for '"+t+"'"),null}if(i){if(i.scene.id!==this.scene.id){this.error("Not in same scene: "+i.type+" "+we.inQuotes(i.id));return}if(a&&!i.isType(a)){this.error("Expected a "+a+" type or subtype: "+i.type+" "+we.inQuotes(i.id));return}}this._attachments||(this._attachments={});const h=this._attached[t];let d,p,m;if(h){if(i&&h.id===i.id)return;const g=this._attachments[h.id];for(d=g.subs,p=0,m=d.length;p<m;p++)h.off(d[p]);delete this._attached[t],delete this._attachments[h.id];const u=g.params.onDetached;u&&(we.isFunction(u)?u(h):u.scope?u.callback.call(u.scope,h):u.callback(h)),g.managingLifecycle&&h.destroy()}if(i){const g={params:e,component:i,subs:[],managingLifecycle:c};g.subs.push(i.once("destroyed",function(){g.params.component=null,this._attach(g.params)},this)),l&&g.subs.push(i.on("dirty",function(){this.fire("dirty",this)},this)),this._attached[t]=i,this._attachments[i.id]=g;const u=e.onAttached;if(u&&(we.isFunction(u)?u(i):u.scope?u.callback.call(u.scope,i):u.callback(i)),n){let x,y,P,_;for(x in n)if(n.hasOwnProperty(x)){if(y=n[x],we.isFunction(y)?(P=y,_=null):(P=y.callback,_=y.scope),!P)continue;g.subs.push(i.on(x,P,_))}}}return l&&this.fire("dirty",this),this.fire(t,i),i}_checkComponent(e,t){if(!t.isComponent)if(we.isID(t)){const i=t;if(t=this.scene.components[i],!t){this.error("Component not found: "+i);return}}else{this.error("Expected a Component or ID");return}if(e!==t.type){this.error("Expected a "+e+" Component");return}if(t.scene.id!==this.scene.id){this.error("Not in same scene: "+t.type);return}return t}_checkComponent2(e,t){if(!t.isComponent)if(we.isID(t)){const o=t;if(t=this.scene.components[o],!t){this.error("Component not found: "+o);return}}else{this.error("Expected a Component or ID");return}if(t.scene.id!==this.scene.id){this.error("Not in same scene: "+t.type);return}for(var i=0,s=e.length;i<s;i++)if(e[i]===t.type)return t;return this.error("Expected component types: "+e),null}_own(e){this._ownedComponents||(this._ownedComponents={}),this._ownedComponents[e.id]||(this._ownedComponents[e.id]=e),e.once("destroyed",()=>{delete this._ownedComponents[e.id]},this)}_needUpdate(e){this._updateScheduled||(this._updateScheduled=!0,e===0?this._doUpdate():It.scheduleTask(this._doUpdate,this))}_doUpdate(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())}scheduleTask(e){It.scheduleTask(e,null)}_update(){}clear(){if(this._ownedComponents)for(var e in this._ownedComponents)this._ownedComponents.hasOwnProperty(e)&&(this._ownedComponents[e].destroy(),delete this._ownedComponents[e])}destroy(){if(this.destroyed)return;this.fire("destroyed",this.destroyed=!0);let e,t,i,s,o,a;if(this._attachments){for(e in this._attachments)if(this._attachments.hasOwnProperty(e)){for(t=this._attachments[e],i=t.component,s=t.subs,o=0,a=s.length;o<a;o++)i.off(s[o]);t.managingLifecycle&&i.destroy()}}if(this._ownedComponents)for(e in this._ownedComponents)this._ownedComponents.hasOwnProperty(e)&&(i=this._ownedComponents[e],i.destroy(),delete this._ownedComponents[e]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this._updateScheduled=!1}}const m_=A.vec3(),g_=A.vec3(),__=A.mat4();class $s{constructor(){this.normal=A.vec3(),this.offset=0,this.testVertex=A.vec3()}set(e,t,i,s){const o=1/Math.sqrt(e*e+t*t+i*i);this.normal[0]=e*o,this.normal[1]=t*o,this.normal[2]=i*o,this.offset=s*o,this.testVertex[0]=this.normal[0]>=0?1:0,this.testVertex[1]=this.normal[1]>=0?1:0,this.testVertex[2]=this.normal[2]>=0?1:0}}class Ci{constructor(){this.planes=[new $s,new $s,new $s,new $s,new $s,new $s]}}Ci.INSIDE=0;Ci.INTERSECT=1;Ci.OUTSIDE=2;function v_(r,e,t){const i=A.mulMat4(t,e,__),s=i[0],o=i[1],a=i[2],n=i[3],l=i[4],c=i[5],h=i[6],d=i[7],p=i[8],m=i[9],g=i[10],u=i[11],x=i[12],y=i[13],P=i[14],_=i[15];r.planes[0].set(n-s,d-l,u-p,_-x),r.planes[1].set(n+s,d+l,u+p,_+x),r.planes[2].set(n-o,d-c,u-m,_-y),r.planes[3].set(n+o,d+c,u+m,_+y),r.planes[4].set(n-a,d-h,u-g,_-P),r.planes[5].set(n+a,d+h,u+g,_+P)}function sl(r,e){let t=Ci.INSIDE;const i=m_,s=g_;i[0]=e[0],i[1]=e[1],i[2]=e[2],s[0]=e[3],s[1]=e[4],s[2]=e[5];const o=[i,s];for(let a=0;a<6;++a){const n=r.planes[a];if(n.normal[0]*o[n.testVertex[0]][0]+n.normal[1]*o[n.testVertex[1]][1]+n.normal[2]*o[n.testVertex[2]][2]+n.offset<0)return Ci.OUTSIDE;n.normal[0]*o[1-n.testVertex[0]][0]+n.normal[1]*o[1-n.testVertex[1]][1]+n.normal[2]*o[1-n.testVertex[2]][2]+n.offset<0&&(t=Ci.INTERSECT)}return t}class Qs extends vt{constructor(e={}){if(!e.viewer)throw"[MarqueePicker] Missing config: viewer";if(!e.objectsKdTree3)throw"[MarqueePicker] Missing config: objectsKdTree3";super(e.viewer.scene,e),this.viewer=e.viewer,this._objectsKdTree3=e.objectsKdTree3,this._canvasMarqueeCorner1=A.vec2(),this._canvasMarqueeCorner2=A.vec2(),this._canvasMarquee=A.AABB2(),this._marqueeFrustum=new Ci,this._marqueeFrustumProjMat=A.mat4(),this._pickMode=!1,this._marqueeElement=document.createElement("div"),document.body.appendChild(this._marqueeElement),this._marqueeElement.style.position="absolute",this._marqueeElement.style["z-index"]="40000005",this._marqueeElement.style.width="8px",this._marqueeElement.style.height="8px",this._marqueeElement.style.visibility="hidden",this._marqueeElement.style.top="0px",this._marqueeElement.style.left="0px",this._marqueeElement.style["box-shadow"]="0 2px 5px 0 #182A3D;",this._marqueeElement.style.opacity=1,this._marqueeElement.style["pointer-events"]="none"}setMarqueeCorner1(e){this._canvasMarqueeCorner1.set(e),this._canvasMarqueeCorner2.set(e),this._updateMarquee()}setMarqueeCorner2(e){this._canvasMarqueeCorner2.set(e),this._updateMarquee()}setMarquee(e,t){this._canvasMarqueeCorner1.set(e),this._canvasMarqueeCorner2.set(t),this._updateMarquee()}setMarqueeVisible(e){this._marqueVisible=e,this._marqueeElement.style.visibility=e?"visible":"hidden"}getMarqueeVisible(){return this._marqueVisible}setPickMode(e){if(e!==Qs.PICK_MODE_INSIDE&&e!==Qs.PICK_MODE_INTERSECTS)throw"Illegal MarqueePicker pickMode: must be MarqueePicker.PICK_MODE_INSIDE or MarqueePicker.PICK_MODE_INTERSECTS";e!==this._pickMode&&(this._marqueeElement.style["background-image"]=e===Qs.PICK_MODE_INSIDE?`url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='6' ry='6' stroke='%23333' stroke-width='4'/%3e%3c/svg%3e")`:`url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='6' ry='6' stroke='%23333' stroke-width='4' stroke-dasharray='6%2c 14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e")`,this._pickMode=e)}getPickMode(){return this._pickMode}clear(){this.fire("clear",{})}pick(){this._updateMarquee(),this._buildMarqueeFrustum();const e=[],t=(i,s=Ci.INTERSECT)=>{if(s===Ci.INTERSECT&&(s=sl(this._marqueeFrustum,i.aabb)),s!==Ci.OUTSIDE){if(i.entities){const o=i.entities;for(let a=0,n=o.length;a<n;a++){const l=o[a];if(!l.visible)continue;const c=l.aabb;this._pickMode===Qs.PICK_MODE_INSIDE?sl(this._marqueeFrustum,c)===Ci.INSIDE&&e.push(l.id):sl(this._marqueeFrustum,c)!==Ci.OUTSIDE&&e.push(l.id)}}i.left&&t(i.left,s),i.right&&t(i.right,s)}};return(this._canvasMarquee[2]-this._canvasMarquee[0]>3||this._canvasMarquee[3]-this._canvasMarquee[1]>3)&&t(this._objectsKdTree3.root),this.fire("picked",e),e}_updateMarquee(){this._canvasMarquee[0]=Math.min(this._canvasMarqueeCorner1[0],this._canvasMarqueeCorner2[0]),this._canvasMarquee[1]=Math.min(this._canvasMarqueeCorner1[1],this._canvasMarqueeCorner2[1]),this._canvasMarquee[2]=Math.max(this._canvasMarqueeCorner1[0],this._canvasMarqueeCorner2[0]),this._canvasMarquee[3]=Math.max(this._canvasMarqueeCorner1[1],this._canvasMarqueeCorner2[1]),this._marqueeElement.style.width=`${this._canvasMarquee[2]-this._canvasMarquee[0]}px`,this._marqueeElement.style.height=`${this._canvasMarquee[3]-this._canvasMarquee[1]}px`,this._marqueeElement.style.left=`${this._canvasMarquee[0]}px`,this._marqueeElement.style.top=`${this._canvasMarquee[1]}px`}_buildMarqueeFrustum(){const e=this.viewer.scene.canvas.canvas,t=e.clientWidth,i=e.clientHeight,s=e.clientLeft,o=e.clientTop,a=2/t,n=2/i,l=17,c=e.clientHeight/e.clientWidth,h=1e4,d=(this._canvasMarquee[0]-s)*a+-1,p=(this._canvasMarquee[2]-s)*a+-1,m=-(this._canvasMarquee[3]-o)*n+1,g=-(this._canvasMarquee[1]-o)*n+1,u=this.viewer.scene.camera.frustum.near*(l*c),x=h;A.frustumMat4(d,p,m*c,g*c,u,x,this._marqueeFrustumProjMat),v_(this._marqueeFrustum,this.viewer.scene.camera.viewMatrix,this._marqueeFrustumProjMat)}destroy(){super.destroy(),this._marqueeElement.parentElement&&(this._marqueeElement.parentElement.removeChild(this._marqueeElement),this._marqueeElement=null,this._objectsKdTree3=null)}}Qs.PICK_MODE_INTERSECTS=0;Qs.PICK_MODE_INSIDE=1;class Ro{constructor(e,t,i){this.id=i&&i.id?i.id:e,this.viewer=t,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,t.addPlugin(this)}scheduleTask(e){It.scheduleTask(e,null)}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),i!==!0&&(this._events[e]=t||!0);const s=this._eventSubs[e];let o;if(s)for(const a in s)s.hasOwnProperty(a)&&(o=s[a],this._eventCallDepth++,this._eventCallDepth<300?o.callback.call(o.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}on(e,t,i){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new Di),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});let s=this._eventSubs[e];s?this._eventSubsNum[e]++:(s={},this._eventSubs[e]=s,this._eventSubsNum[e]=1);const o=this._subIdMap.addItem();s[o]={callback:t,scope:i||this},this._subIdEvents[o]=e;const a=this._events[e];return a!==void 0&&t.call(i||this,a),o}off(e){if(e==null||!this._subIdEvents)return;const t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];const i=this._eventSubs[t];i&&(delete i[e],this._eventSubsNum[t]--),this._subIdMap.removeItem(e)}}once(e,t,i){const s=this,o=this.on(e,function(a){s.off(o),t.call(i||this,a)},i)}hasSubs(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}log(e){console.log(`[xeokit plugin ${this.id}]: ${e}`)}warn(e){console.warn(`[xeokit plugin ${this.id}]: ${e}`)}error(e){console.error(`[xeokit plugin ${this.id}]: ${e}`)}send(e,t){}destroy(){this.viewer.removePlugin(this)}}const eh={isIphoneSafari(){const r=window.navigator.userAgent,e=/iPhone/i.test(r),t=/Safari/i.test(r)&&!/Chrome/i.test(r);return e&&t},isTouchDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.mxMaxTouchPoints>0}};function oc(r,e){if(!r||!e)return;let t=null;const i=500,s=3;let o,a;const n=d=>{d.preventDefault();const p=d.touches[0];o=p.clientX,a=p.clientY,t&&(clearTimeout(t),t=null),t=setTimeout(()=>{d.clientX=p.clientX,d.clientY=p.clientY,e(d),clearTimeout(t),t=null},i)},l=d=>{if(!t)return;const p=d.touches[0],m=Math.abs(p.clientX-o),g=Math.abs(p.clientY-a);(m>s||g>s)&&(clearTimeout(t),t=null)},c=d=>{d.preventDefault(),t&&(clearTimeout(t),t=null)},h=d=>{e(d),d.preventDefault(),d.stopPropagation()};return eh.isIphoneSafari()?(r.addEventListener("touchstart",n),r.addEventListener("touchmove",l),r.addEventListener("touchend",c)):r.addEventListener("contextmenu",h),function(){eh.isIphoneSafari()?(r.removeEventListener("touchstart",n),r.removeEventListener("touchmove",l),r.removeEventListener("touchend",c)):r.removeEventListener("contextmenu",h)}}class P_{constructor(e,t={}){this._highlightClass="viewer-ruler-dot-highlighted",this._x=0,this._y=0,this._dot=document.createElement("div"),this._dot.className+=this._dot.className?" viewer-ruler-dot":"viewer-ruler-dot",this._dotClickable=document.createElement("div"),this._dotClickable.className+=this._dotClickable.className?" viewer-ruler-dot-clickable":"viewer-ruler-dot-clickable",this._visible=t.visible!==!1,this._culled=!1;var i=this._dot,s=i.style;s["border-radius"]="25px",s.border="solid 2px white",s.background="lightgreen",s.position="absolute",s["z-index"]=t.zIndex===void 0?"40000005":t.zIndex,s.width="8px",s.height="8px",s.visibility=this._visible?"visible":"hidden",s.top="0px",s.left="0px",s["box-shadow"]="0 2px 5px 0 #182A3D;",s.opacity=1,s["pointer-events"]="none",t.onContextMenu,e.appendChild(i);var o=this._dotClickable,a=o.style;a["border-radius"]="35px",a.border="solid 10px white",a.position="absolute",a["z-index"]=t.zIndex===void 0?"40000007":t.zIndex+1,a.width="8px",a.height="8px",a.visibility="visible",a.top="0px",a.left="0px",a.opacity=0,a["pointer-events"]="none",t.onContextMenu,e.appendChild(o),o.addEventListener("click",n=>{e.dispatchEvent(new MouseEvent("mouseover",n))}),t.onMouseOver&&o.addEventListener("mouseover",n=>{t.onMouseOver(n,this),e.dispatchEvent(new MouseEvent("mouseover",n))}),t.onMouseLeave&&o.addEventListener("mouseleave",n=>{t.onMouseLeave(n,this)}),t.onMouseWheel&&o.addEventListener("wheel",n=>{t.onMouseWheel(n,this)}),t.onMouseDown&&o.addEventListener("mousedown",n=>{t.onMouseDown(n,this)}),t.onMouseUp&&o.addEventListener("mouseup",n=>{t.onMouseUp(n,this)}),t.onMouseMove&&o.addEventListener("mousemove",n=>{t.onMouseMove(n,this)}),t.onTouchstart&&o.addEventListener("touchstart",n=>{t.onTouchstart(n,this)}),t.onTouchmove&&o.addEventListener("touchmove",n=>{t.onTouchmove(n,this)}),t.onTouchend&&o.addEventListener("touchend",n=>{t.onTouchend(n,this)}),t.onContextMenu&&oc(o,l=>{t.onContextMenu(l,this)}),this.setPos(t.x||0,t.y||0),this.setFillColor(t.fillColor),this.setBorderColor(t.borderColor)}setPos(e,t){this._x=e,this._y=t;var i=this._dot.style;i.left=Math.round(e)-6+"px",i.top=Math.round(t)-6+"px";var s=this._dotClickable.style;s.left=Math.round(e)-14+"px",s.top=Math.round(t)-14+"px"}setFillColor(e){this._dot.style.background=e||"lightgreen"}setBorderColor(e){this._dot.style.border="solid 2px"+(e||"black")}setOpacity(e){this._dot.style.opacity=e}_updateVisibility(){this._dot.style.visibility=this._dotClickable.style.visibility=this._visible&&!this._culled?"visible":"hidden"}setVisible(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}setCulled(e){this._culled!==e&&(this._culled=!!e,this._updateVisibility())}setClickable(e){this._dotClickable.style["pointer-events"]=e?"all":"none"}setHighlighted(e){this._highlighted!==e&&(this._highlighted=!!e,this._highlighted?this._dot.classList.add(this._highlightClass):this._dot.classList.remove(this._highlightClass))}destroy(){this.setVisible(!1),this._dot.parentElement&&this._dot.parentElement.removeChild(this._dot),this._dotClickable.parentElement&&this._dotClickable.parentElement.removeChild(this._dotClickable)}}class x_{constructor(e,t={}){this._highlightClass="viewer-ruler-label-highlighted",this._prefix=t.prefix||"",this._x=0,this._y=0,this._visible=!0,this._culled=!1,this._label=document.createElement("div"),this._label.className+=this._label.className?" viewer-ruler-label":"viewer-ruler-label",this._timeout=null;var i=this._label,s=i.style;s["border-radius"]="5px",s.color="white",s.padding="4px",s.border="solid 1px",s.background="lightgreen",s.position="absolute",s["z-index"]=t.zIndex===void 0?"5000005":t.zIndex,s.width="auto",s.height="auto",s.visibility="visible",s.top="0px",s.left="0px",s["pointer-events"]="all",s.opacity=1,t.onContextMenu,i.innerText="",e.appendChild(i),this.setPos(t.x||0,t.y||0),this.setFillColor(t.fillColor),this.setBorderColor(t.fillColor),this.setText(t.text),t.onMouseOver&&i.addEventListener("mouseover",o=>{t.onMouseOver(o,this),o.preventDefault()}),t.onMouseLeave&&i.addEventListener("mouseleave",o=>{t.onMouseLeave(o,this),o.preventDefault()}),t.onMouseWheel&&i.addEventListener("wheel",o=>{t.onMouseWheel(o,this)}),t.onMouseDown&&i.addEventListener("mousedown",o=>{t.onMouseDown(o,this),o.stopPropagation()}),t.onMouseUp&&i.addEventListener("mouseup",o=>{t.onMouseUp(o,this),o.stopPropagation()}),t.onMouseMove&&i.addEventListener("mousemove",o=>{t.onMouseMove(o,this)}),t.onContextMenu&&oc(i,a=>{t.onContextMenu(a,this)})}setPos(e,t){this._x=e,this._y=t;var i=this._label.style;i.left=Math.round(e)-20+"px",i.top=Math.round(t)-12+"px"}setPosOnWire(e,t,i,s){var o=e+(i-e)*.5,a=t+(s-t)*.5,n=this._label.style;n.left=Math.round(o)-20+"px",n.top=Math.round(a)-12+"px"}setPosBetweenWires(e,t,i,s,o,a){var n=(e+i+o)/3,l=(t+s+a)/3,c=this._label.style;c.left=Math.round(n)-20+"px",c.top=Math.round(l)-12+"px"}setText(e){this._label.innerHTML=this._prefix+(e||"")}setFillColor(e){this._fillColor=e||"lightgreen",this._label.style.background=this._fillColor}setBorderColor(e){this._borderColor=e||"black",this._label.style.border="solid 1px "+this._borderColor}setOpacity(e){this._label.style.opacity=e}_updateVisibility(){this._label.style.visibility=this._visible&&!this._culled?"visible":"hidden"}setVisible(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}setCulled(e){this._culled!==e&&(this._culled=!!e,this._updateVisibility())}setHighlighted(e){this._highlighted!==e&&(this._highlighted=!!e,this._highlighted?this._label.classList.add(this._highlightClass):this._label.classList.remove(this._highlightClass))}setClickable(e){this._label.style["pointer-events"]=e?"all":"none"}setPrefix(e){this._prefix!==e&&(this._prefix=e)}destroy(){this._label.parentElement&&this._label.parentElement.removeChild(this._label)}}class y_{constructor(e,t={}){this._color=t.color||"black",this._highlightClass="viewer-ruler-wire-highlighted",this._wire=document.createElement("div"),this._wire.className+=this._wire.className?" viewer-ruler-wire":"viewer-ruler-wire",this._wireClickable=document.createElement("div"),this._wireClickable.className+=this._wireClickable.className?" viewer-ruler-wire-clickable":"viewer-ruler-wire-clickable",this._thickness=t.thickness||1,this._thicknessClickable=t.thicknessClickable||6,this._visible=!0,this._culled=!1;var i=this._wire,s=i.style;s.border="solid "+this._thickness+"px "+this._color,s.position="absolute",s["z-index"]=t.zIndex===void 0?"2000001":t.zIndex,s.width="0px",s.height="0px",s.visibility="visible",s.top="0px",s.left="0px",s["-webkit-transform-origin"]="0 0",s["-moz-transform-origin"]="0 0",s["-ms-transform-origin"]="0 0",s["-o-transform-origin"]="0 0",s["transform-origin"]="0 0",s["-webkit-transform"]="rotate(0deg)",s["-moz-transform"]="rotate(0deg)",s["-ms-transform"]="rotate(0deg)",s["-o-transform"]="rotate(0deg)",s.transform="rotate(0deg)",s.opacity=1,s["pointer-events"]="none",t.onContextMenu,e.appendChild(i);var o=this._wireClickable,a=o.style;a.border="solid "+this._thicknessClickable+"px "+this._color,a.position="absolute",a["z-index"]=t.zIndex===void 0?"2000002":t.zIndex+1,a.width="0px",a.height="0px",a.visibility="visible",a.top="0px",a.left="0px",a["-webkit-transform-origin"]="0 0",a["-moz-transform-origin"]="0 0",a["-ms-transform-origin"]="0 0",a["-o-transform-origin"]="0 0",a["transform-origin"]="0 0",a["-webkit-transform"]="rotate(0deg)",a["-moz-transform"]="rotate(0deg)",a["-ms-transform"]="rotate(0deg)",a["-o-transform"]="rotate(0deg)",a.transform="rotate(0deg)",a.opacity=0,a["pointer-events"]="none",t.onContextMenu,e.appendChild(o),t.onMouseOver&&o.addEventListener("mouseover",n=>{t.onMouseOver(n,this)}),t.onMouseLeave&&o.addEventListener("mouseleave",n=>{t.onMouseLeave(n,this)}),t.onMouseWheel&&o.addEventListener("wheel",n=>{t.onMouseWheel(n,this)}),t.onMouseDown&&o.addEventListener("mousedown",n=>{t.onMouseDown(n,this)}),t.onMouseUp&&o.addEventListener("mouseup",n=>{t.onMouseUp(n,this)}),t.onMouseMove&&o.addEventListener("mousemove",n=>{t.onMouseMove(n,this)}),t.onContextMenu&&oc(o,l=>{t.onContextMenu(l,this)}),this._x1=0,this._y1=0,this._x2=0,this._y2=0,this._update()}get visible(){return this._wire.style.visibility==="visible"}_update(){var e=Math.abs(Math.sqrt((this._x1-this._x2)*(this._x1-this._x2)+(this._y1-this._y2)*(this._y1-this._y2))),t=Math.atan2(this._y2-this._y1,this._x2-this._x1)*180/Math.PI,i=this._wire.style;i.width=Math.round(e)+"px",i.left=Math.round(this._x1)+"px",i.top=Math.round(this._y1)+"px",i["-webkit-transform"]=i["-moz-transform"]=i["-ms-transform"]=i["-o-transform"]=i.transform="rotate("+t+"deg) translate(-"+this._thickness+"px, -"+this._thickness+"px)";var s=this._wireClickable.style;s.width=Math.round(e)+"px",s.left=Math.round(this._x1)+"px",s.top=Math.round(this._y1)+"px",s["-webkit-transform"]=s["-moz-transform"]=s["-ms-transform"]=s["-o-transform"]=s.transform="rotate("+t+"deg) translate(-"+this._thicknessClickable+"px, -"+this._thicknessClickable+"px)"}setStartAndEnd(e,t,i,s){this._x1=e,this._y1=t,this._x2=i,this._y2=s,this._update()}setColor(e){this._color=e||"black",this._wire.style.border="solid "+this._thickness+"px "+this._color}setOpacity(e){this._wire.style.opacity=e}_updateVisibility(){this._wire.style.visibility=this._wireClickable.style.visibility=this._visible&&!this._culled?"visible":"hidden"}setVisible(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}setCulled(e){this._culled!==e&&(this._culled=!!e,this._updateVisibility())}setClickable(e){this._wireClickable.style["pointer-events"]=e?"all":"none"}setHighlighted(e){this._highlighted!==e&&(this._highlighted=!!e,this._highlighted?this._wire.classList.add(this._highlightClass):this._wire.classList.remove(this._highlightClass))}destroy(e){this._wire.parentElement&&this._wire.parentElement.removeChild(this._wire),this._wireClickable.parentElement&&this._wireClickable.parentElement.removeChild(this._wireClickable)}}const pf=A.vec3(),Jo=A.vec4(),Pt=function(){const r=new Float64Array(16),e=new Float64Array(4),t=new Float64Array(4);return function(i,s,o){return o=o||r,e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=1,A.transformVec4(i,e,t),A.setMat4Translation(i,t,o),o.slice()}}();function ma(r,e,t){const i=Float32Array.from([r[0]])[0],s=r[0]-i,o=Float32Array.from([r[1]])[0],a=r[1]-o,n=Float32Array.from([r[2]])[0],l=r[2]-n;e[0]=i,e[1]=o,e[2]=n,t[0]=s,t[1]=a,t[2]=l}function th(r,e,t,i=1e3){const s=A.getPositionsCenter(r,pf),o=Math.round(s[0]/i)*i,a=Math.round(s[1]/i)*i,n=Math.round(s[2]/i)*i;t[0]=o,t[1]=a,t[2]=n;const l=t[0]!==0||t[1]!==0||t[2]!==0;if(l)for(let c=0,h=r.length;c<h;c+=3)e[c+0]=r[c+0]-o,e[c+1]=r[c+1]-a,e[c+2]=r[c+2]-n;return l}function kt(r,e,t,i,s){const o=s?(Jo.set(t,0),Jo[3]=1,A.mulMat4v4(s,Jo,Jo)):t,a=A.dotVec3(e,o)+r,n=A.normalizeVec3(e,pf);return A.mulVec3Scalar(n,-a,i),i}const N={VISIBLE:1,CULLED:4,PICKABLE:8,CLIPPABLE:16,COLLIDABLE:32,CAST_SHADOW:64,RECEIVE_SHADOW:128,XRAYED:256,HIGHLIGHTED:512,SELECTED:1024,EDGES:2048,BACKFACES:4096,TRANSPARENT:8192},en=new Float32Array([0,0,0]),tn=new Uint16Array([0,0,0]);A.OBB3();class b_{constructor(e,t,i,s,o,a){this._isObject=t,this.scene=e.scene,this.model=e,this.isSceneModelEntity=!0,this.meshes=s,this._numPrimitives=0;for(let n=0,l=this.meshes.length;n<l;n++){const c=this.meshes[n];c.parent=this,c.entity=this,this._numPrimitives+=c.numPrimitives}this.id=i,this.originalSystemId=A.unglobalizeObjectId(e.id,i),this._flags=o,this._aabb=A.AABB3(),this._aabbDirty=!0,this._offset=A.vec3(),this._colorizeUpdated=!1,this._opacityUpdated=!1,this._lodCullable=!!a,this._culled=!1,this._culledVFC=!1,this._culledLOD=!1,this._isObject&&e.scene._registerObject(this)}_transformDirty(){this._aabbDirty=!0,this.model._transformDirty()}_sceneModelDirty(){this._aabbDirty=!0;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._sceneModelDirty()}get aabb(){if(this._aabbDirty){A.collapseAABB3(this._aabb);for(let e=0,t=this.meshes.length;e<t;e++)A.expandAABB3(this._aabb,this.meshes[e].aabb);this._aabbDirty=!1}return this._aabb}get isEntity(){return!0}get isModel(){return!1}get isObject(){return this._isObject}get numPrimitives(){return this._numPrimitives}get numTriangles(){return this._numPrimitives}get visible(){return this._getFlag(N.VISIBLE)}set visible(e){if(!!(this._flags&N.VISIBLE)!==e){e?this._flags=this._flags|N.VISIBLE:this._flags=this._flags&~N.VISIBLE;for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw()}}get highlighted(){return this._getFlag(N.HIGHLIGHTED)}set highlighted(e){if(!!(this._flags&N.HIGHLIGHTED)!==e){e?this._flags=this._flags|N.HIGHLIGHTED:this._flags=this._flags&~N.HIGHLIGHTED;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw()}}get xrayed(){return this._getFlag(N.XRAYED)}set xrayed(e){if(!!(this._flags&N.XRAYED)!==e){e?this._flags=this._flags|N.XRAYED:this._flags=this._flags&~N.XRAYED;for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw()}}get selected(){return this._getFlag(N.SELECTED)}set selected(e){if(!!(this._flags&N.SELECTED)!==e){e?this._flags=this._flags|N.SELECTED:this._flags=this._flags&~N.SELECTED;for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw()}}get edges(){return this._getFlag(N.EDGES)}set edges(e){if(!!(this._flags&N.EDGES)!==e){e?this._flags=this._flags|N.EDGES:this._flags=this._flags&~N.EDGES;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setEdges(this._flags);this.model.glRedraw()}}get culledVFC(){return!!this._culledVFC}set culledVFC(e){this._culledVFC=e,this._setCulled()}get culledLOD(){return!!this._culledLOD}set culledLOD(e){this._culledLOD=e,this._setCulled()}get culled(){return!!this._culled}set culled(e){this._culled=e,this._setCulled()}_setCulled(){let e=!!this._culled||!!(this._culledLOD&&this._lodCullable)||!!this._culledVFC;if(!!(this._flags&N.CULLED)!==e){e?this._flags=this._flags|N.CULLED:this._flags=this._flags&~N.CULLED;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCulled(this._flags);this.model.glRedraw()}}get clippable(){return this._getFlag(N.CLIPPABLE)}set clippable(e){if(!!(this._flags&N.CLIPPABLE)!==e){e?this._flags=this._flags|N.CLIPPABLE:this._flags=this._flags&~N.CLIPPABLE;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setClippable(this._flags);this.model.glRedraw()}}get collidable(){return this._getFlag(N.COLLIDABLE)}set collidable(e){if(!!(this._flags&N.COLLIDABLE)!==e){e?this._flags=this._flags|N.COLLIDABLE:this._flags=this._flags&~N.COLLIDABLE;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCollidable(this._flags)}}get pickable(){return this._getFlag(N.PICKABLE)}set pickable(e){if(!!(this._flags&N.PICKABLE)!==e){e?this._flags=this._flags|N.PICKABLE:this._flags=this._flags&~N.PICKABLE;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setPickable(this._flags)}}get colorize(){if(this.meshes.length===0)return null;const e=this.meshes[0]._colorize;return en[0]=e[0]/255,en[1]=e[1]/255,en[2]=e[2]/255,en}set colorize(e){if(e){tn[0]=Math.floor(e[0]*255),tn[1]=Math.floor(e[1]*255),tn[2]=Math.floor(e[2]*255);for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setColorize(tn)}else for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setColorize(null);if(this._isObject){const t=!!e;this.scene._objectColorizeUpdated(this,t),this._colorizeUpdated=t}this.model.glRedraw()}get opacity(){return this.meshes.length>0?this.meshes[0]._colorize[3]/255:1}set opacity(e){if(this.meshes.length===0)return;const t=e!=null,i=this.meshes[0]._colorize[3];let s=255;if(t){if(e<0?e=0:e>1&&(e=1),s=Math.floor(e*255),i===s)return}else if(s=255,i===s)return;for(let o=0,a=this.meshes.length;o<a;o++)this.meshes[o]._setOpacity(s,this._flags);this._isObject&&(this.scene._objectOpacityUpdated(this,t),this._opacityUpdated=t),this.model.glRedraw()}get offset(){return this._offset}set offset(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setOffset(this._offset);this._aabbDirty=!0,this.model._aabbDirty=!0,this.scene._aabbDirty=!0,this.scene._objectOffsetUpdated(this,e),this.model.glRedraw()}get saoEnabled(){return this.model.saoEnabled}getEachVertex(e){for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t].getEachVertex(e)}getEachIndex(e){for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t].getEachIndex(e)}get volume(){let e=0;for(let t=0,i=this.meshes.length;t<i;t++){const s=this.meshes[t].volume;if(s<0)return-1;e+=s}return e}get surfaceArea(){let e=0;for(let t=0,i=this.meshes.length;t<i;t++){const s=this.meshes[t].surfaceArea;s>=0&&(e+=s)}return e>0?e:-1}_getFlag(e){return!!(this._flags&e)}_finalize(){const e=this.model.scene;this._isObject&&(this.visible&&e._objectVisibilityUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this));for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._finalize(this._flags)}_finalize2(){for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._finalize2()}_destroy(){const e=this.model.scene;this._isObject&&(e._deregisterObject(this),this.visible&&e._deRegisterVisibleObject(this),this.xrayed&&e._deRegisterXRayedObject(this),this.selected&&e._deRegisterSelectedObject(this),this.highlighted&&e._deRegisterHighlightedObject(this),this._colorizeUpdated&&this.scene._deRegisterColorizedObject(this),this._opacityUpdated&&this.scene._deRegisterOpacityObject(this),this._offset&&(this._offset[0]!==0||this._offset[1]!==0||this._offset[2]!==0)&&this.scene._deRegisterOffsetObject(this));for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._destroy();e._aabbDirty=!0}}const rl=A.vec4(),Vr=A.vec4();class B_ extends vt{constructor(e,t){super(e,t),this._entity=null,this._visible=null,this._worldPos=A.vec3(),this._origin=A.vec3(),this._rtcPos=A.vec3(),this._viewPos=A.vec3(),this._canvasPos=A.vec2(),this._occludable=!1,this._onCameraViewMatrix=this.scene.camera.on("matrix",()=>{this._viewPosDirty=!0,this._needUpdate()}),this._onCameraProjMatrix=this.scene.camera.on("projMatrix",()=>{this._canvasPosDirty=!0,this._needUpdate()}),this._onEntityDestroyed=null,this._onEntityModelDestroyed=null,this._renderer.addMarker(this),this.entity=t.entity,this.worldPos=t.worldPos,this.occludable=t.occludable}_update(){if(this._viewPosDirty&&(A.transformPoint3(this.scene.camera.viewMatrix,this._worldPos,this._viewPos),this._viewPosDirty=!1,this._canvasPosDirty=!0,this.fire("viewPos",this._viewPos)),this._canvasPosDirty){rl.set(this._viewPos),rl[3]=1,A.transformPoint4(this.scene.camera.projMatrix,rl,Vr);const e=this.scene.canvas.boundary;this._canvasPos[0]=Math.floor((1+Vr[0]/Vr[3])*e[2]/2),this._canvasPos[1]=Math.floor((1-Vr[1]/Vr[3])*e[3]/2),this._canvasPosDirty=!1,this.fire("canvasPos",this._canvasPos)}}_setVisible(e){this._visible,this._visible=e,this.fire("visible",this._visible)}set entity(e){this._entity!==e&&(this._cleanupDestroyedHandlers(),this._entity=e,this._entity&&(this._entity.isSceneModelEntity?this._onEntityModelDestroyed=this._entity.model.on("destroyed",()=>{this._entity=null,this._onEntityModelDestroyed=null}):this._onEntityDestroyed=this._entity.on("destroyed",()=>{this._entity=null,this._onEntityDestroyed=null})),this.fire("entity",this._entity,!0))}get entity(){return this._entity}set occludable(e){e=!!e,e!==this._occludable&&(this._occludable=e,this._occludable&&this._renderer.markerWorldPosUpdated(this))}get occludable(){return this._occludable}set worldPos(e){this._worldPos.set(e||[0,0,0]),ma(this._worldPos,this._origin,this._rtcPos),this._occludable&&this._renderer.markerWorldPosUpdated(this),this._viewPosDirty=!0,this.fire("worldPos",this._worldPos),this._needUpdate()}get worldPos(){return this._worldPos}get origin(){return this._origin}get rtcPos(){return this._rtcPos}get viewPos(){return this._update(),this._viewPos}get canvasPos(){return this._update(),this._canvasPos}get visible(){return!!this._visible}destroy(){this.fire("destroyed",!0),this.scene.camera.off(this._onCameraViewMatrix),this.scene.camera.off(this._onCameraProjMatrix),this._cleanupDestroyedHandlers(),this._renderer.removeMarker(this),super.destroy()}_cleanupDestroyedHandlers(){this._entity&&(this._onEntityDestroyed!==null&&(this._entity.model?this._entity.model.off(this._onEntityDestroyed):this._entity.off(this._onEntityDestroyed),this._onEntityDestroyed=null),this._onEntityModelDestroyed!==null&&(this._entity.model&&this._entity.model.off(this._onEntityModelDestroyed),this._onEntityModelDestroyed=null))}}const Vi=A.vec2(),Jt=A.vec2(),sn=A.vec2(),rn=A.vec2(),ff=A.vec3(),Ss=A.vec3(),w_=A.vec4(),C_=A.vec4(),PA=A.vec4(),ih=A.vec4(),sh=A.mat4();function Da(r,e,t){const i=r.getBoundingClientRect(),s=e.getBoundingClientRect();t[0]+=i.left-s.left,t[1]+=i.top-s.top}const rh=(r,e,t)=>{sh.set(r.viewMatrix),sh.set(r.projMatrix),t.set(e),t[3]=1,A.mulMat4v4(r.viewMatrix,t,t),A.mulMat4v4(r.projMatrix,t,t)},oh=(r,e,t,i)=>{i[0]=(1+t[0])*.5*r.offsetWidth,i[1]=(1-t[1])*.5*r.offsetHeight,Da(r,e,i)},ra=(r,e,t,i,s,o)=>{const a=r.camera,n=r.canvas.canvas;if(A.distVec3(t,i)<.001)return!1;const l=A.subVec3(i,t,ff);let c=0,h=1;for(let _ of r._sectionPlanesState.sectionPlanes){const b=A.dotVec3(_.dir,A.subVec3(_.pos,i,Ss)),B=A.dotVec3(_.dir,A.subVec3(_.pos,t,Ss));if(B>0&&b>0)return!1;if(B>0||b>0){const w=A.dotVec3(_.dir,l);if(Math.abs(w)>=1e-6){const C=A.dotVec3(_.dir,Ss)/w;B>0?c=Math.max(c,C):h=Math.min(h,C)}}}const d=w_,p=C_;rh(a,c>0?A.addVec3(t,A.mulVec3Scalar(l,c,Ss),Ss):t,d),rh(a,h<1?A.addVec3(t,A.mulVec3Scalar(l,h,Ss),Ss):i,p);const m=d[2]/d[3]<-1||d[3]<0,g=p[2]/p[3]<-1||p[3]<0;if(m&&g)return!1;const u=(d[3]+d[2])/(d[3]+d[2]-(p[3]+p[2]));if(u>0&&u<1){const _=A.subVec4(p,d,PA);A.mulVec4Scalar(_,u,_),A.addVec4(d,_,m?d:p)}A.mulVec4Scalar(d,1/d[3]),A.mulVec4Scalar(p,1/p[3]);let x=0,y=1;for(let _=0;_<2;++_){const b=p[_]-d[_],B=(-d[3]-d[_])/b,w=(d[3]-d[_])/b;b>0?(x=Math.max(x,B),y=Math.min(y,w)):(x=Math.max(x,w),y=Math.min(y,B))}if(x>=y)return!1;const P=A.subVec4(p,d,PA);return A.addVec4(d,A.mulVec4Scalar(P,y,ih),p),A.addVec4(d,A.mulVec4Scalar(P,x,ih),d),A.mulVec4Scalar(d,1/d[3]),A.mulVec4Scalar(p,1/p[3]),oh(n,e,d,s),oh(n,e,p,o),!0};class mf extends B_{constructor(e,t,i,s={}){const o=e.camera;super(e,t),this.__visible=!0;const a=(g,u)=>x=>{g&&g(x),this.fire(u,x,!0)};this._dot=new P_(i,{borderColor:s.borderColor,fillColor:s.fillColor,zIndex:s.zIndex,onMouseOver:a(s.onMouseOver,"mouseover"),onMouseLeave:a(s.onMouseLeave,"mouseleave"),onMouseWheel:a(s.onMouseWheel,"wheel"),onMouseDown:a(s.onMouseDown,"mousedown"),onMouseUp:a(s.onMouseUp,"mouseup"),onMouseMove:a(s.onMouseMove,"mousemove"),onTouchstart:a(s.onTouchstart,"touchstart"),onTouchmove:a(s.onTouchmove,"touchmove"),onTouchend:a(s.onTouchend,"touchend"),onContextMenu:a(s.onContextMenu,"contextmenu")});const n=(g,u)=>{u.set(g),u[3]=1,A.mulMat4v4(o.viewMatrix,u,u),A.mulMat4v4(o.projMatrix,u,u)},l=g=>{const u=e.canvas.canvas;g[0]=(1+g[0])*.5*u.offsetWidth,g[1]=(1-g[1])*.5*u.offsetHeight,Da(u,i,g)},c=()=>{if(!this.__visible)return;const g=PA;n(this.worldPos,g),A.mulVec3Scalar(g,1/g[3]);const x=g[3]<0||g[0]<-1||g[0]>1||g[1]<-1||g[1]>1||g[2]<-1||g[2]>1||e._sectionPlanesState.sectionPlanes.some(y=>A.dotVec3(y.dir,A.subVec3(y.pos,this.worldPos,ff))>0);this._dot.setCulled(x),x||(l(g),this._dot.setPos(g[0],g[1]))};this.on("worldPos",c);const h=o.on("viewMatrix",c),d=o.on("projMatrix",c),p=e.canvas.on("boundary",c),m=e.on("sectionPlaneUpdated",c);this._updatePosition=c,this._cleanup=()=>{o.off(h),o.off(d),e.canvas.off(p),e.off(m),this._dot.destroy()}}setClickable(e){this._dot.setClickable(e)}setFillColor(e){this._dot.setFillColor(e)}setBorderColor(e){this._dot.setBorderColor(e)}setHighlighted(e){this._dot.setHighlighted(e)}setOpacity(e){this._dot.setOpacity(e)}setVisible(e){this.__visible!=e&&(this.__visible=e,this._updatePosition(),this._dot.setVisible(e))}destroy(){this._cleanup(),super.destroy()}}class gf{constructor(e,t,i){const s=e.camera;this._label=new x_(t,i),this._start=A.vec3(),this._mid=A.vec3(),this._end=A.vec3(),this._yOff=0,this._betweenWires=!1,this.__visible=!0;const o=(h,d,p)=>{h[0]+=d[0],h[1]+=d[1],A.mulVec2Scalar(h,.5),this._label.setPos(h[0],h[1]+p)};this._updatePositions=()=>{if(this.__visible)if(this._betweenWires){const h=ra(e,t,this._start,this._mid,Vi,Jt),d=ra(e,t,this._end,this._mid,sn,rn);this._label.setCulled(!(h||d)),h&&d?(Jt[0]+=rn[0],Jt[1]+=rn[1],A.mulVec2Scalar(Jt,.5),Jt[0]+=Vi[0]+sn[0],Jt[1]+=Vi[1]+sn[1],A.mulVec2Scalar(Jt,1/3),this._label.setPos(Jt[0],Jt[1])):h?o(Vi,Jt,0):d&&o(sn,rn,0)}else{const h=ra(e,t,this._start,this._end,Vi,Jt)&&A.distVec2(Vi,Jt)>=this._labelMinAxisLength;this._label.setCulled(!h),h&&o(Vi,Jt,this._yOff)}};const a=s.on("viewMatrix",this._updatePositions),n=s.on("projMatrix",this._updatePositions),l=e.canvas.on("boundary",this._updatePositions),c=e.on("sectionPlaneUpdated",this._updatePositions);this._cleanup=()=>{s.off(a),s.off(n),e.canvas.off(l),e.off(c),this._label.destroy()}}setPosOnWire(e,t,i,s){this._start.set(e),this._end.set(t),this._yOff=i,this._labelMinAxisLength=s,this._betweenWires=!1,this._updatePositions()}setPosBetween(e,t,i){this._start.set(e),this._mid.set(t),this._end.set(i),this._betweenWires=!0,this._updatePositions()}setFillColor(e){this._label.setFillColor(e)}setHighlighted(e){this._label.setHighlighted(e)}setText(e){this._label.setText(e)}setClickable(e){this._label.setClickable(e)}setVisible(e){this.__visible!=e&&(this.__visible=e,this._updatePositions(),this._label.setVisible(e))}destroy(){this._cleanup()}}class _f{constructor(e,t,i){const s=e.camera;this._wire=new y_(t,i),this._start=A.vec3(),this._end=A.vec3(),this.__visible=!0,this._updatePositions=()=>{if(!this.__visible)return;const c=ra(e,t,this._start,this._end,Vi,Jt);this._wire.setCulled(!c),c&&this._wire.setStartAndEnd(Vi[0],Vi[1],Jt[0],Jt[1])};const o=s.on("viewMatrix",this._updatePositions),a=s.on("projMatrix",this._updatePositions),n=e.canvas.on("boundary",this._updatePositions),l=e.on("sectionPlaneUpdated",this._updatePositions);this._cleanup=()=>{s.off(o),s.off(a),e.canvas.off(n),e.off(l),this._wire.destroy()}}setEnds(e,t){this._start.set(e),this._end.set(t),this._updatePositions()}setClickable(e){this._wire.setClickable(e)}setColor(e){this._wire.setColor(e)}setHighlighted(e){this._wire.setHighlighted(e)}setOpacity(e){this._wire.setOpacity(e)}setVisible(e){this.__visible!=e&&(this.__visible=e,this._updatePositions(),this._wire.setVisible(e))}destroy(){this._cleanup()}}const on=A.vec3(),nn=A.vec3();class M_ extends vt{constructor(e,t={}){const i=e.viewer.scene;super(i,t),this.plugin=e;const s=t.container;if(!s)throw"config missing: container";this._color=t.color||e.defaultColor;const o=function(P){const _=[];let b=P!==!1;return{reg:B=>_.push(B),get:()=>b,set:B=>{b=B!==!1,_.forEach(w=>w(b))}}};this._visible=o(t.visible),this._originVisible=o(t.originVisible),this._cornerVisible=o(t.cornerVisible),this._targetVisible=o(t.targetVisible),this._originWireVisible=o(t.originWireVisible),this._targetWireVisible=o(t.targetWireVisible),this._angleVisible=o(t.angleVisible),this._labelsVisible=o(),this.labelsVisible=t.labelsVisible,this._clickable=o(!1),this.approximate=t.approximate;const a=i.canvas.canvas,n=t.onMouseOver?P=>{t.onMouseOver(P,this),a.dispatchEvent(new MouseEvent("mouseover",P))}:null,l=t.onMouseLeave?P=>{t.onMouseLeave(P,this),a.dispatchEvent(new MouseEvent("mouseleave",P))}:null,c=t.onContextMenu?P=>{t.onContextMenu(P,this)}:null,h=P=>a.dispatchEvent(new MouseEvent("mousedown",P)),d=P=>a.dispatchEvent(new MouseEvent("mouseup",P)),p=P=>a.dispatchEvent(new MouseEvent("mousemove",P)),m=P=>a.dispatchEvent(new WheelEvent("wheel",P));this._cleanups=[],this._drawables=[];const g=(P,_)=>{const b=()=>P.setVisible(_.every(B=>B.get()));_.forEach(B=>B.reg(b)),this._drawables.push(P),this._cleanups.push(()=>P.destroy())},u=(P,_,b)=>{const B=new _f(i,s,{color:P,thickness:_,thicknessClickable:6,zIndex:e.zIndex!==void 0?e.zIndex+1:void 0,onMouseOver:n,onMouseLeave:l,onMouseWheel:m,onMouseDown:h,onMouseUp:d,onMouseMove:p,onContextMenu:c});return g(B,b),{setEnds:(w,C)=>B.setEnds(w,C),setColor:w=>B.setColor(w)}};this._originWire=u(this._color||"blue",1,[this._visible,this._originWireVisible]),this._targetWire=u(this._color||"red",1,[this._visible,this._targetWireVisible]);const x=(P,_,b)=>{const B=new gf(i,s,{fillColor:P,zIndex:e.zIndex+_,onMouseOver:n,onMouseLeave:l,onMouseWheel:m,onMouseDown:h,onMouseUp:d,onMouseMove:p,onContextMenu:c});return g(B,b),{setFillColor:w=>B.setFillColor(w),setPosOnWire:(w,C,E)=>B.setPosOnWire(w,C,E),setPosBetween:(w,C,E)=>B.setPosBetween(w,C,E),setText:w=>B.setText(w)}};this._angleLabel=x(this._color||"#00BBFF",2,[this._visible,this._angleVisible,this._labelsVisible]);const y=(P,_)=>{const b=new mf(i,P,s,{fillColor:this._color,zIndex:e.zIndex!==void 0?e.zIndex+2:void 0,onMouseOver:n,onMouseLeave:l,onMouseWheel:m,onMouseDown:h,onMouseUp:d,onMouseMove:p,onContextMenu:c});return b.on("worldPos",()=>this._update()),g(b,_),b};this._originDot=y(t.origin,[this._visible,this._originVisible]),this._cornerDot=y(t.corner,[this._visible,this._cornerVisible]),this._targetDot=y(t.target,[this._visible,this._targetVisible]),this._update()}_update(){if(!this._targetDot)return;const e=this._originDot.worldPos,t=this._cornerDot.worldPos,i=this._targetDot.worldPos;this._originWire.setEnds(e,t),this._targetWire.setEnds(t,i),this._angleLabel.setPosBetween(e,t,i),A.subVec3(e,t,on),A.subVec3(i,t,nn),A.lenVec3(on)>0&&A.lenVec3(nn)>0?(A.normalizeVec3(on),A.normalizeVec3(nn),this._angle=Math.abs(A.angleVec3(on,nn))*A.RADTODEG,this._angleLabel.setText((this._approximate?" ~ ":" = ")+this._angle.toFixed(2)+"°")):(this._angle=void 0,this._angleLabel.setText(""))}set approximate(e){e=e!==!1,this._approximate!==e&&(this._approximate=e,this._update())}get approximate(){return this._approximate}get origin(){return this._originDot}get corner(){return this._cornerDot}get target(){return this._targetDot}get angle(){return this._angle}get color(){return this._color}set color(e){this._color=e,this._originDot.setFillColor(e),this._cornerDot.setFillColor(e),this._targetDot.setFillColor(e),this._originWire.setColor(e||"blue"),this._targetWire.setColor(e||"red"),this._angleLabel.setFillColor(e||"#00BBFF")}set visible(e){this._visible.set(e)}get visible(){return this._visible.get()}set originVisible(e){this._originVisible.set(e)}get originVisible(){return this._originVisible.get()}set cornerVisible(e){this._cornerVisible.set(e)}get cornerVisible(){return this._cornerVisible.get()}set targetVisible(e){this._targetVisible.set(e)}get targetVisible(){return this._targetVisible.get()}set originWireVisible(e){this._originWireVisible.set(e)}get originWireVisible(){return this._originWireVisible.get()}set targetWireVisible(e){this._targetWireVisible.set(e)}get targetWireVisible(){return this._targetWireVisible.get()}set angleVisible(e){this._angleVisible.set(e)}get angleVisible(){return this._angleVisible.get()}set labelsVisible(e){this._labelsVisible.set(e!==void 0?!!e:this.plugin.defaultLabelsVisible)}get labelsVisible(){return this._labelsVisible.get()}setHighlighted(e){this._drawables.forEach(t=>t.setHighlighted(e))}set clickable(e){this._clickable.set(!!e),this._drawables.forEach(t=>t.setClickable(this._clickable.get()))}get clickable(){return this._clickable.get()}destroy(){this._cleanups.forEach(e=>e()),super.destroy()}}class E_ extends vt{get active(){}set snapping(e){}get snapping(){return!0}activate(){}deactivate(){}reset(){}get currentMeasurement(){return null}destroy(){}}const cs=0,an=1,ln=2;class I_ extends E_{constructor(e,t={}){super(e.viewer.scene),this._canvasToPagePos=t.canvasToPagePos,this.pointerLens=t.pointerLens,this._active=!1,this._currentAngleMeasurement=null,this._initMarkerDiv(),this._snapping=t.snapping!==!1,this._mouseState=cs,this._attachPlugin(e,t)}_initMarkerDiv(){const e=document.createElement("div"),t=this.scene.canvas.canvas;t.parentNode.insertBefore(e,t),e.style.background="black",e.style.border="2px solid blue",e.style.borderRadius="10px",e.style.width="5px",e.style.height="5px",e.style.top="-200px",e.style.left="-200px",e.style.margin="0 0",e.style.zIndex="100",e.style.position="absolute",e.style.pointerEvents="none",this.markerDiv=e}_destroyMarkerDiv(){this.markerDiv&&(this.markerDiv.parentNode.removeChild(this.markerDiv),this.markerDiv=null)}_attachPlugin(e,t={}){this.angleMeasurementsPlugin=e,this.plugin=e}get active(){return this._active}set snapping(e){this._snapping=e}get snapping(){return this._snapping}activate(){if(this._active)return;this.markerDiv||this._initMarkerDiv(),this.angleMeasurementsPlugin;const e=this.scene;e.input;const t=e.canvas.canvas,i=20,s=this.angleMeasurementsPlugin.viewer.cameraControl,o=this.pointerLens;let a=!1,n=null,l=0,c=0;const h=A.vec3(),d=A.vec2();this._currentAngleMeasurement=null;const p=A.vec2(),m=u=>{u.snappedToVertex||u.snappedToEdge?(o&&(o.visible=!0,o.canvasPos=u.canvasPos,o.snappedCanvasPos=u.snappedCanvasPos||u.canvasPos,o.snapped=!0),this.markerDiv.style.background="greenyellow",this.markerDiv.style.border="2px solid green"):(o&&(o.visible=!0,o.canvasPos=u.canvasPos,o.snappedCanvasPos=u.canvasPos,o.snapped=!1),this.markerDiv.style.background="pink",this.markerDiv.style.border="2px solid red");const x=u.snappedCanvasPos||u.canvasPos;switch(a=!0,n=u.entity,h.set(u.worldPos),d.set(x),this._mouseState){case cs:if(this._canvasToPagePos)this._canvasToPagePos(t,x,p),this.markerDiv.style.left=`${p[0]-5}px`,this.markerDiv.style.top=`${p[1]-5}px`;else{const y=A.vec2(x);Da(t,this.markerDiv.parentNode,y),this.markerDiv.style.left=`${y[0]-5}px`,this.markerDiv.style.top=`${y[1]-5}px`}break;case an:this._currentAngleMeasurement&&(this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.cornerVisible=!0,this._currentAngleMeasurement.angleVisible=!1,this._currentAngleMeasurement.corner.worldPos=u.worldPos,this._currentAngleMeasurement.corner.entity=u.entity),this.markerDiv.style.left="-10000px",this.markerDiv.style.top="-10000px",t.style.cursor="pointer";break;case ln:this._currentAngleMeasurement&&(this._currentAngleMeasurement.targetWireVisible=!0,this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.angleVisible=!0,this._currentAngleMeasurement.target.worldPos=u.worldPos,this._currentAngleMeasurement.target.entity=u.entity),this.markerDiv.style.left="-10000px",this.markerDiv.style.top="-10000px",t.style.cursor="pointer";break}};this._onHoverSnapOrSurface=s.on("hoverSnapOrSurface",u=>{this._snapping&&m(u)}),this._onHoverSurface=s.on("hoverSurface",u=>{this._snapping||m(u)}),t.addEventListener("mousedown",this._onMouseDown=u=>{u.which===1&&(l=u.clientX,c=u.clientY)}),t.addEventListener("mouseup",this._onMouseUp=u=>{if(u.which===1&&!(u.clientX>l+i||u.clientX<l-i||u.clientY>c+i||u.clientY<c-i))switch(this._mouseState){case cs:a&&(this._currentAngleMeasurement=this.angleMeasurementsPlugin.createMeasurement({id:A.createUUID(),origin:{worldPos:h,entity:n},corner:{worldPos:h,entity:n},target:{worldPos:h,entity:n},approximate:!0}),this._currentAngleMeasurement.clickable=!1,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.cornerVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.angleVisible=!1,this._currentAngleMeasurement.origin.entity=n,this._mouseState=an,this.angleMeasurementsPlugin.fire("measurementStart",this._currentAngleMeasurement));break;case an:a?(this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.angleVisible=!0,this._currentAngleMeasurement.corner.entity=n,this._mouseState=ln):this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null,n=null,this._mouseState=cs,this.angleMeasurementsPlugin.fire("measurementCancel",this._currentAngleMeasurement));break;case ln:a?(this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.angleVisible=!0,this._currentAngleMeasurement.target.entity=n,this._currentAngleMeasurement.clickable=!0,n=null,this.angleMeasurementsPlugin.fire("measurementEnd",this._currentAngleMeasurement),this._currentAngleMeasurement=null,this._mouseState=cs):this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null,n=null,this._mouseState=cs,this.angleMeasurementsPlugin.fire("measurementCancel",this._currentAngleMeasurement));break}});const g=u=>{if(a=!1,o&&(o.visible=!0,o.canvasPos=u.canvasPos,o.snappedCanvasPos=u.snappedCanvasPos||u.canvasPos,o.snapped=!1),this.markerDiv.style.left="-100px",this.markerDiv.style.top="-100px",this._currentAngleMeasurement){switch(this._mouseState){case cs:this._currentAngleMeasurement.originVisible=!1;break;case an:this._currentAngleMeasurement.cornerVisible=!1,this._currentAngleMeasurement.originWireVisible=!1,this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.angleVisible=!1;break;case ln:this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.angleVisible=!1;break}t.style.cursor="default"}};this._onHoverSnapOrSurfaceOff=s.on("hoverSnapOrSurfaceOff",u=>{this._snapping&&g(u)}),this._onHoverOff=s.on("hoverOff",u=>{this._snapping||g(u)}),this._active=!0}deactivate(){if(!this._active)return;this.pointerLens&&(this.pointerLens.visible=!1),this.reset();const e=this.scene.canvas.canvas;e.removeEventListener("mousedown",this._onMouseDown),e.removeEventListener("mouseup",this._onMouseUp);const t=this.angleMeasurementsPlugin.viewer.cameraControl;t.off(this._onHoverSnapOrSurface),t.off(this._onHoverSurface),t.off(this._onHoverSnapOrSurfaceOff),t.off(this._onHoverOff),this._active=!1}reset(){this._active&&(this._destroyMarkerDiv(),this._initMarkerDiv(),this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null),this._mouseState=cs)}get currentMeasurement(){return this._currentAngleMeasurement}destroy(){this.deactivate(),super.destroy()}}class QF extends Ro{constructor(e,t={}){super("AngleMeasurements",e),this._container=t.container||document.body,this._defaultControl=null,this._measurements={},this.defaultColor=t.defaultColor!==void 0?t.defaultColor:"#00BBFF",this.defaultLabelsVisible=t.defaultLabelsVisible!==!1,this.zIndex=t.zIndex||1e4,this._onMouseOver=(i,s)=>{this.fire("mouseOver",{plugin:this,angleMeasurement:s,measurement:s,event:i})},this._onMouseLeave=(i,s)=>{this.fire("mouseLeave",{plugin:this,angleMeasurement:s,measurement:s,event:i})},this._onContextMenu=(i,s)=>{this.fire("contextMenu",{plugin:this,angleMeasurement:s,measurement:s,event:i})}}getContainerElement(){return this._container}send(e,t){}get control(){return this._defaultControl||(this._defaultControl=new I_(this,{})),this._defaultControl}get measurements(){return this._measurements}createMeasurement(e={}){this.viewer.scene.components[e.id]&&(this.error("Viewer scene component with this ID already exists: "+e.id),delete e.id);const t=e.origin,i=e.corner,s=e.target,o=new M_(this,{id:e.id,plugin:this,container:this._container,origin:{entity:t.entity,worldPos:t.worldPos},corner:{entity:i.entity,worldPos:i.worldPos},target:{entity:s.entity,worldPos:s.worldPos},visible:e.visible,originVisible:!0,originWireVisible:!0,cornerVisible:!0,targetWireVisible:!0,targetVisible:!0,onMouseOver:this._onMouseOver,onMouseLeave:this._onMouseLeave,onContextMenu:this._onContextMenu});return this._measurements[o.id]=o,o.on("destroyed",()=>{delete this._measurements[o.id]}),o.clickable=!0,this.fire("measurementCreated",o),o}destroyMeasurement(e){const t=this._measurements[e];if(!t){this.log("AngleMeasurement not found: "+e);return}t.destroy(),this.fire("measurementDestroyed",t)}setLabelsShown(e){for(const[t,i]of Object.entries(this.measurements))i.labelShown=e}clear(){const e=Object.keys(this._measurements);for(var t=0,i=e.length;t<i;t++)this.destroyMeasurement(e[t])}destroy(){this.clear(),super.destroy()}}A.vec3();A.vec3();A.vec3();const F_=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }";class S_ extends vt{get type(){return"Spinner"}constructor(e,t={}){super(e,t),this._canvas=t.canvas,this._element=null,this._isCustom=!1,t.elementId&&(this._element=document.getElementById(t.elementId),this._element?this._adjustPosition():this.error("Can't find given Spinner HTML element: '"+t.elementId+"' - will automatically create default element")),this._element||this._createDefaultSpinner(),this.processes=0}_createDefaultSpinner(){this._injectDefaultCSS();const e=document.createElement("div"),t=e.style;t["z-index"]="9000",t.position="absolute",e.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(e),this._element=e,this._isCustom=!1,this._adjustPosition()}_injectDefaultCSS(){const e="xeokit-spinner-css";if(document.getElementById(e))return;const t=document.createElement("style");t.innerHTML=F_,t.id=e,document.body.appendChild(t)}_adjustPosition(){if(this._isCustom)return;const e=this._canvas,t=this._element,i=t.style;i.left=e.offsetLeft+e.clientWidth*.5-t.clientWidth*.5+"px",i.top=e.offsetTop+e.clientHeight*.5-t.clientHeight*.5+"px"}set processes(e){if(e=e||0,this._processes===e||e<0)return;const t=this._processes;this._processes=e;const i=this._element;i&&(i.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),this._processes===0&&this._processes!==t&&this.fire("zeroProcesses",this._processes)}get processes(){return this._processes}_destroy(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null);const e=document.getElementById("xeokit-spinner-css");e&&e.parentNode.removeChild(e)}}const nh=["webgl2","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];class T_ extends vt{constructor(e,t={}){super(e,t),this._backgroundColor=A.vec3([t.backgroundColor?t.backgroundColor[0]:1,t.backgroundColor?t.backgroundColor[1]:1,t.backgroundColor?t.backgroundColor[2]:1]),this._backgroundColorFromAmbientLight=!!t.backgroundColorFromAmbientLight,this.canvas=t.canvas,this.gl=null,this.webgl2=!1,this.transparent=!!t.transparent,this.contextAttr=t.contextAttr||{},this.contextAttr.alpha=this.transparent,this.contextAttr.preserveDrawingBuffer=!!this.contextAttr.preserveDrawingBuffer,this.contextAttr.stencil=!1,this.contextAttr.premultipliedAlpha=!!this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=this.contextAttr.antialias!==!1,this.resolutionScale=t.resolutionScale,this.canvas.width=Math.round(this.canvas.clientWidth*this._resolutionScale),this.canvas.height=Math.round(this.canvas.clientHeight*this._resolutionScale),this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._initWebGL(t);const i=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(a){console.time("webglcontextrestored"),i.scene._webglContextLost(),i.fire("webglcontextlost"),a.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(a){i._initWebGL(),i.gl&&(i.scene._webglContextRestored(i.gl),i.fire("webglcontextrestored",i.gl),a.preventDefault()),console.timeEnd("webglcontextrestored")},!1);let s=!0;new ResizeObserver(a=>{for(const n of a)n.contentBoxSize&&(s=!0)}).observe(this.canvas),this._tick=this.scene.on("tick",()=>{s&&(s=!1,i.canvas.width=Math.round(i.canvas.clientWidth*i._resolutionScale),i.canvas.height=Math.round(i.canvas.clientHeight*i._resolutionScale),i.boundary[0]=i.canvas.offsetLeft,i.boundary[1]=i.canvas.offsetTop,i.boundary[2]=i.canvas.clientWidth,i.boundary[3]=i.canvas.clientHeight,i.fire("boundary",i.boundary))}),this._spinner=new S_(this.scene,{canvas:this.canvas,elementId:t.spinnerElementId})}get type(){return"Canvas"}get backgroundColorFromAmbientLight(){return this._backgroundColorFromAmbientLight}set backgroundColorFromAmbientLight(e){this._backgroundColorFromAmbientLight=e!==!1,this.glRedraw()}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){e?(this._backgroundColor[0]=e[0],this._backgroundColor[1]=e[1],this._backgroundColor[2]=e[2]):(this._backgroundColor[0]=1,this._backgroundColor[1]=1,this._backgroundColor[2]=1),this.glRedraw()}get resolutionScale(){return this._resolutionScale}set resolutionScale(e){if(e=e||1,e===this._resolutionScale)return;this._resolutionScale=e;const t=this.canvas;t.width=Math.round(t.clientWidth*this._resolutionScale),t.height=Math.round(t.clientHeight*this._resolutionScale),this.glRedraw()}get spinner(){return this._spinner}_createCanvas(){const e="xeokit-canvas-"+A.createUUID(),t=document.getElementsByTagName("body")[0],i=document.createElement("div"),s=i.style;s.height="100%",s.width="100%",s.padding="0",s.margin="0",s.background="rgba(0,0,0,0);",s.float="left",s.left="0",s.top="0",s.position="absolute",s.opacity="1.0",s["z-index"]="-10000",i.innerHTML+='<canvas id="'+e+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',t.appendChild(i),this.canvas=document.getElementById(e)}_getElementXY(e){let t=0,i=0;for(;e;)t+=e.offsetLeft-e.scrollLeft,i+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{x:t,y:i}}_initWebGL(){if(!this.gl)for(let e=0;!this.gl&&e<nh.length;e++)try{this.gl=this.canvas.getContext(nh[e],this.contextAttr)}catch{}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0));{const e=this.gl;let t="__",i=e.activeTexture;e.activeTexture=function(a){t!==a&&(t=a,i.call(this,a))};let s={},o=e.bindTexture;e.bindTexture=function(a,n){s[t]!==n&&(s[t]=n,o.call(this,a,n))}}this.gl&&this.webgl2&&(this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST),this.gl instanceof WebGL2RenderingContext)}getSnapshot(e){throw"Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."}readPixels(e,t,i,s){return this.scene._renderer.readPixels(e,t,i,s)}loseWebGLContext(){this.canvas.loseContext&&this.canvas.loseContext()}destroy(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.gl=null,super.destroy()}}class D_{constructor(e){this._scene=e,this._matPool=[],this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.reset()}reset(){this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.gl=this._scene.canvas.gl,this.lastProgramId=null,this.pbrEnabled=!1,this.colorTextureEnabled=!1,this.withSAO=!1,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickZNear=.01,this.pickZFar=5e3,this.pickInvisible=!1,this.pickElementsCount=null,this.pickElementsOffset=null,this.lineWidth=1,this.snapPickLayerParams={},this.snapPickLayerNumber=0,this.snapPickCoordinateScale=A.vec3(),this.snapPickOrigin=A.vec3()}getRTCViewMatrix(e,t){let i=this._rtcViewMats[e];return i||(i=this._getNewMat(),Pt(this._scene.camera.viewMatrix,t,i),this._rtcViewMats[e]=i),i}getRTCPickViewMatrix(e,t){let i=this._rtcPickViewMats[e];if(!i){i=this._getNewMat();const s=this.pickViewMatrix||this._scene.camera.viewMatrix;Pt(s,t,i),this._rtcPickViewMats[e]=i}return i}_getNewMat(){let e=this._matPool[this._matPoolNextFreeIndex];return e||(e=A.mat4(),this._matPool[this._matPoolNextFreeIndex]=e),this._matPoolNextFreeIndex++,e}}const yt={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},ol=document.createElement("canvas");if(ol){const r=ol.getContext("webgl",{antialias:!0})||ol.getContext("experimental-webgl",{antialias:!0});yt.WEBGL=!!r,yt.WEBGL&&(yt.ANTIALIAS=r.getContextAttributes().antialias,r.getShaderPrecisionFormat?r.getShaderPrecisionFormat(r.FRAGMENT_SHADER,r.HIGH_FLOAT).precision>0?yt.FS_MAX_FLOAT_PRECISION="highp":r.getShaderPrecisionFormat(r.FRAGMENT_SHADER,r.MEDIUM_FLOAT).precision>0?yt.FS_MAX_FLOAT_PRECISION="mediump":yt.FS_MAX_FLOAT_PRECISION="lowp":yt.FS_MAX_FLOAT_PRECISION="mediump",yt.DEPTH_BUFFER_BITS=r.getParameter(r.DEPTH_BITS),yt.MAX_TEXTURE_SIZE=r.getParameter(r.MAX_TEXTURE_SIZE),yt.MAX_CUBE_MAP_SIZE=r.getParameter(r.MAX_CUBE_MAP_TEXTURE_SIZE),yt.MAX_RENDERBUFFER_SIZE=r.getParameter(r.MAX_RENDERBUFFER_SIZE),yt.MAX_TEXTURE_UNITS=r.getParameter(r.MAX_COMBINED_TEXTURE_IMAGE_UNITS),yt.MAX_TEXTURE_IMAGE_UNITS=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS),yt.MAX_VERTEX_ATTRIBS=r.getParameter(r.MAX_VERTEX_ATTRIBS),yt.MAX_VERTEX_UNIFORM_VECTORS=r.getParameter(r.MAX_VERTEX_UNIFORM_VECTORS),yt.MAX_FRAGMENT_UNIFORM_VECTORS=r.getParameter(r.MAX_FRAGMENT_UNIFORM_VECTORS),yt.MAX_VARYING_VECTORS=r.getParameter(r.MAX_VARYING_VECTORS),r.getSupportedExtensions().forEach(function(e){yt.SUPPORTED_EXTENSIONS[e]=!0}))}class xA{constructor(){this.entity=null,this.primitive=null,this.primIndex=-1,this.pickSurfacePrecision=!1,this.touchInput=!1,this.snappedToEdge=!1,this.snappedToVertex=!1,this._origin=new Float64Array([0,0,0]),this._direction=new Float64Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float64Array([0,0,0]),this._worldPos=new Float64Array([0,0,0]),this._viewPos=new Float64Array([0,0,0]),this._canvasPos=new Int16Array([0,0]),this._snappedCanvasPos=new Int16Array([0,0]),this._bary=new Float64Array([0,0,0]),this._worldNormal=new Float64Array([0,0,0]),this._uv=new Float64Array([0,0]),this.reset()}get canvasPos(){return this._gotCanvasPos?this._canvasPos:null}set canvasPos(e){e?(this._canvasPos[0]=e[0],this._canvasPos[1]=e[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1}get origin(){return this._gotOrigin?this._origin:null}set origin(e){e?(this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this._gotOrigin=!0):this._gotOrigin=!1}get direction(){return this._gotDirection?this._direction:null}set direction(e){e?(this._direction[0]=e[0],this._direction[1]=e[1],this._direction[2]=e[2],this._gotDirection=!0):this._gotDirection=!1}get indices(){return this.entity&&this._gotIndices?this._indices:null}set indices(e){e?(this._indices[0]=e[0],this._indices[1]=e[1],this._indices[2]=e[2],this._gotIndices=!0):this._gotIndices=!1}get localPos(){return this.entity&&this._gotLocalPos?this._localPos:null}set localPos(e){e?(this._localPos[0]=e[0],this._localPos[1]=e[1],this._localPos[2]=e[2],this._gotLocalPos=!0):this._gotLocalPos=!1}get snappedCanvasPos(){return this._gotSnappedCanvasPos?this._snappedCanvasPos:null}set snappedCanvasPos(e){e?(this._snappedCanvasPos[0]=e[0],this._snappedCanvasPos[1]=e[1],this._gotSnappedCanvasPos=!0):this._gotSnappedCanvasPos=!1}get worldPos(){return this._gotWorldPos?this._worldPos:null}set worldPos(e){e?(this._worldPos[0]=e[0],this._worldPos[1]=e[1],this._worldPos[2]=e[2],this._gotWorldPos=!0):this._gotWorldPos=!1}get viewPos(){return this.entity&&this._gotViewPos?this._viewPos:null}set viewPos(e){e?(this._viewPos[0]=e[0],this._viewPos[1]=e[1],this._viewPos[2]=e[2],this._gotViewPos=!0):this._gotViewPos=!1}get bary(){return this.entity&&this._gotBary?this._bary:null}set bary(e){e?(this._bary[0]=e[0],this._bary[1]=e[1],this._bary[2]=e[2],this._gotBary=!0):this._gotBary=!1}get worldNormal(){return this.entity&&this._gotWorldNormal?this._worldNormal:null}set worldNormal(e){e?(this._worldNormal[0]=e[0],this._worldNormal[1]=e[1],this._worldNormal[2]=e[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1}get uv(){return this.entity&&this._gotUV?this._uv:null}set uv(e){e?(this._uv[0]=e[0],this._uv[1]=e[1],this._gotUV=!0):this._gotUV=!1}get snapped(){return this.snappedToEdge||this.snappedToVertex}reset(){this.entity=null,this.primIndex=-1,this.primitive=null,this.pickSurfacePrecision=!1,this._gotCanvasPos=!1,this._gotSnappedCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1,this.touchInput=!1,this.snappedToEdge=!1,this.snappedToVertex=!1}}class ah{constructor(e,t,i){if(this.allocated=!1,this.compiled=!1,this.handle=e.createShader(t),!this.handle){this.errors=["Failed to allocate"];return}if(this.allocated=!0,e.shaderSource(this.handle,i),e.compileShader(this.handle),this.compiled=e.getShaderParameter(this.handle,e.COMPILE_STATUS),!this.compiled&&!e.isContextLost()){const s=i.split(`
`),o=[];for(let a=0;a<s.length;a++)o.push(a+1+": "+s[a]+`
`);this.errors=[],this.errors.push(""),this.errors.push(e.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(o.join(""))}}destroy(){}}class lh{constructor(e,t){this.bindTexture=function(i,s){return i.bind(s)?(e.uniform1i(t,s),!0):!1}}}class R_{constructor(e,t){this._gl=e,this.location=t}bindArrayBuffer(e){e&&(e.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,e.itemSize,e.itemType,e.normalized,e.stride,e.offset))}}const Ah=new Di({});function ch(r){const e=[];let t,i;for(let s=0,o=r.length;s<o;s++)t=r[s],i=t.indexOf("/"),i>0&&t.charAt(i+1)==="/"&&(t=t.substring(0,i)),e.push(t);return e.join(`
`)}function Hr(r){console.error(r.join(`
`))}class Tt{constructor(e,t){this.id=Ah.addItem({}),this.source=t,this.init(e)}init(e){if(this.gl=e,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new ah(e,e.VERTEX_SHADER,ch(this.source.vertex)),this._fragmentShader=new ah(e,e.FRAGMENT_SHADER,ch(this.source.fragment)),!this._vertexShader.allocated){this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors),Hr(this.errors);return}if(!this._fragmentShader.allocated){this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors),Hr(this.errors);return}if(this.allocated=!0,!this._vertexShader.compiled){this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors),Hr(this.errors);return}if(!this._fragmentShader.compiled){this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors),Hr(this.errors);return}this.compiled=!0;let t,i,s,o,a;if(this.handle=e.createProgram(),!this.handle){this.errors=["Failed to allocate program"];return}if(e.attachShader(this.handle,this._vertexShader.handle),e.attachShader(this.handle,this._fragmentShader.handle),e.linkProgram(this.handle),this.linked=e.getProgramParameter(this.handle,e.LINK_STATUS),this.validated=!0,!this.linked||!this.validated){this.errors=[],this.errors.push(""),this.errors.push(e.getProgramInfoLog(this.handle)),this.errors.push(`
Vertex shader:
`),this.errors=this.errors.concat(this.source.vertex),this.errors.push(`
Fragment shader:
`),this.errors=this.errors.concat(this.source.fragment),Hr(this.errors);return}const n=e.getProgramParameter(this.handle,e.ACTIVE_UNIFORMS);for(i=0;i<n;++i)s=e.getActiveUniform(this.handle,i),s&&(o=s.name,o[o.length-1]==="\0"&&(o=o.substr(0,o.length-1)),a=e.getUniformLocation(this.handle,o),s.type===e.SAMPLER_2D||s.type===e.SAMPLER_CUBE||s.type===35682?this.samplers[o]=new lh(e,a):e instanceof WebGL2RenderingContext&&(s.type===e.UNSIGNED_INT_SAMPLER_2D||s.type===e.INT_SAMPLER_2D)?this.samplers[o]=new lh(e,a):this.uniforms[o]=a);const l=e.getProgramParameter(this.handle,e.ACTIVE_ATTRIBUTES);for(i=0;i<l;i++)t=e.getActiveAttrib(this.handle,i),t&&(a=e.getAttribLocation(this.handle,t.name),this.attributes[t.name]=new R_(e,a));this.allocated=!0}bind(){this.allocated&&this.gl.useProgram(this.handle)}getLocation(e){if(this.allocated)return this.uniforms[e]}getAttribute(e){if(this.allocated)return this.attributes[e]}bindTexture(e,t,i){if(!this.allocated)return!1;const s=this.samplers[e];return s?s.bindTexture(t,i):!1}destroy(){this.allocated&&(Ah.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}class Oe{constructor(e,t,i,s,o,a,n,l,c){switch(this._gl=e,this.type=t,this.allocated=!1,i.constructor){case Uint8Array:this.itemType=e.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=e.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=e.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=e.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=e.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=e.INT,this.itemByteSize=4;break;default:this.itemType=e.FLOAT,this.itemByteSize=4}this.usage=a,this.length=0,this.dataLength=s,this.numItems=0,this.itemSize=o,this.normalized=!!n,this.stride=l||0,this.offset=c||0,this._allocate(i)}_allocate(e){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,e.length>this.dataLength?e.slice(0,this.dataLength):e,this.usage),this._gl.bindBuffer(this.type,null),this.length=e.length,this.numItems=this.length/this.itemSize,this.allocated=!0)}setData(e,t){this.allocated&&(e.length+(t||0)>this.length?(this.destroy(),this._allocate(e)):(this._gl.bindBuffer(this.type,this._handle),t||t===0?this._gl.bufferSubData(this.type,t*this.itemByteSize,e):this._gl.bufferData(this.type,e,this.usage),this._gl.bindBuffer(this.type,null)))}bind(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)}unbind(){this.allocated&&this._gl.bindBuffer(this.type,null)}destroy(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}class hh{constructor(e,t){this.scene=e,this.aabb=A.AABB3(),this.origin=A.vec3(t),this.originHash=this.origin.join(),this.numMarkers=0,this.markers={},this.markerList=[],this.markerIndices={},this.positions=[],this.indices=[],this.positionsBuf=null,this.lenPositionsBuf=0,this.indicesBuf=null,this.sectionPlanesActive=[],this.culledBySectionPlanes=!1,this.occlusionTestList=[],this.lenOcclusionTestList=0,this.pixels=[],this.aabbDirty=!1,this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!1}addMarker(e){this.markers[e.id]=e,this.markerListDirty=!0,this.numMarkers++}markerWorldPosUpdated(e){if(!this.markers[e.id])return;const t=this.markerIndices[e.id];this.positions[t*3+0]=e.worldPos[0],this.positions[t*3+1]=e.worldPos[1],this.positions[t*3+2]=e.worldPos[2],this.positionsDirty=!0}removeMarker(e){delete this.markers[e.id],this.markerListDirty=!0,this.numMarkers--}update(){this.markerListDirty&&(this._buildMarkerList(),this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!0),this.positionsDirty&&(this._buildPositions(),this.positionsDirty=!1,this.aabbDirty=!0,this.vbosDirty=!0),this.aabbDirty&&(this._buildAABB(),this.aabbDirty=!1),this.vbosDirty&&(this._buildVBOs(),this.vbosDirty=!1),this.occlusionTestListDirty&&this._buildOcclusionTestList(),this._updateActiveSectionPlanes()}_buildMarkerList(){this.numMarkers=0;for(var e in this.markers)this.markers.hasOwnProperty(e)&&(this.markerList[this.numMarkers]=this.markers[e],this.markerIndices[e]=this.numMarkers,this.numMarkers++);this.markerList.length=this.numMarkers}_buildPositions(){let e=0;for(let t=0;t<this.numMarkers;t++)if(this.markerList[t]){const s=this.markerList[t].rtcPos;this.positions[e++]=s[0],this.positions[e++]=s[1],this.positions[e++]=s[2],this.indices[t]=t}this.positions.length=this.numMarkers*3,this.indices.length=this.numMarkers}_buildAABB(){const e=this.aabb;A.collapseAABB3(e),A.expandAABB3Points3(e,this.positions);const t=this.origin;e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[0],e[4]+=t[1],e[5]+=t[2]}_buildVBOs(){if(this.positionsBuf){if(this.lenPositionsBuf===this.positions.length){this.positionsBuf.setData(new Float32Array(this.positions));return}this.positionsBuf.destroy(),this.positionsBuf=null,this.indicesBuf.destroy(),this.indicesBuf=null}const e=this.scene.canvas.gl,t=this.numMarkers*3,i=this.numMarkers;this.positionsBuf=new Oe(e,e.ARRAY_BUFFER,new Float32Array(this.positions),t,3,e.STATIC_DRAW),this.indicesBuf=new Oe(e,e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),i,1,e.STATIC_DRAW),this.lenPositionsBuf=this.positions.length}_buildOcclusionTestList(){const e=this.scene.canvas,t=this.scene.camera.perspective.near,i=e.boundary,s=i[2],o=i[3];let a=0;this.lenOcclusionTestList=0;for(let n=0;n<this.numMarkers;n++){const l=this.markerList[n];if(l.viewPos[2]>-t){l._setVisible(!1);continue}const h=l.canvasPos,d=h[0],p=h[1];if(d+10<0||p+10<0||d-10>s||p-10>o){l._setVisible(!1);continue}if(l.entity&&!l.entity.visible){l._setVisible(!1);continue}if(l.occludable){this.occlusionTestList[this.lenOcclusionTestList++]=l,this.pixels[a++]=d,this.pixels[a++]=p;continue}l._setVisible(!0)}}_updateActiveSectionPlanes(){const e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(let i=0;i<t;i++){const s=e[i];if(!s.active)this.sectionPlanesActive[i]=!1;else{const o=A.planeAABB3Intersect(s.dir,s.dist,this.aabb);if(o===-1){this.culledBySectionPlanes=!0;return}const n=o===0;this.sectionPlanesActive[i]=n}}this.culledBySectionPlanes=!1}destroy(){this.markers={},this.markerList.length=0,this.positionsBuf&&this.positionsBuf.destroy(),this.indicesBuf&&this.indicesBuf.destroy()}}const nl=A.vec3([1,0,0]),L_=20,U_=A.vec3();class O_{constructor(e,t){this._scene=e,this._renderBufferManager=t,this._occlusionLayers={},this._occlusionLayersList=[],this._occlusionLayersListDirty=!1,this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markersToOcclusionLayersMap={},this._onCameraViewMatrix=e.camera.on("viewMatrix",()=>{this._occlusionTestListDirty=!0}),this._onCameraProjMatrix=e.camera.on("projMatrix",()=>{this._occlusionTestListDirty=!0}),this._onCanvasBoundary=e.canvas.on("boundary",()=>{this._occlusionTestListDirty=!0})}addMarker(e){const t=e.origin.join();let i=this._occlusionLayers[t];i||(i=new hh(this._scene,e.origin),this._occlusionLayers[i.originHash]=i,this._occlusionLayersListDirty=!0),i.addMarker(e),this._markersToOcclusionLayersMap[e.id]=i,this._occlusionTestListDirty=!0}markerWorldPosUpdated(e){const t=this._markersToOcclusionLayersMap[e.id];if(!t)return;const i=e.origin.join();if(i!==t.originHash){t.numMarkers===1?(t.destroy(),delete this._occlusionLayers[t.originHash],this._occlusionLayersListDirty=!0):t.removeMarker(e);let s=this._occlusionLayers[i];s||(s=new hh(this._scene,e.origin),this._occlusionLayers[i]=s,this._occlusionLayersListDirty=!0),s.addMarker(e),this._markersToOcclusionLayersMap[e.id]=s}else t.markerWorldPosUpdated(e)}removeMarker(e){const t=e.origin.join();let i=this._occlusionLayers[t];i&&(i.numMarkers===1?(i.destroy(),delete this._occlusionLayers[i.originHash],this._occlusionLayersListDirty=!0):i.removeMarker(e),delete this._markersToOcclusionLayersMap[e.id])}get needOcclusionTest(){return this._occlusionTestListDirty}bindRenderBuf(){const e=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");if(e!==this._shaderSourceHash&&(this._shaderSourceHash=e,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._occlusionLayersListDirty&&(this._buildOcclusionLayersList(),this._occlusionLayersListDirty=!1),this._occlusionTestListDirty){for(let t=0,i=this._occlusionLayersList.length;t<i;t++){const s=this._occlusionLayersList[t];s.occlusionTestListDirty=!0}this._occlusionTestListDirty=!1}this._readPixelBuf=this._renderBufferManager.getRenderBuffer("occlusionReadPix"),this._readPixelBuf.bind(),this._readPixelBuf.clear()}_buildOcclusionLayersList(){let e=0;for(let t in this._occlusionLayers)this._occlusionLayers.hasOwnProperty(t)&&(this._occlusionLayersList[e++]=this._occlusionLayers[t]);this._occlusionLayersList.length=e}_buildShaderSource(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()}}_buildVertexShaderSource(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// OcclusionTester vertex shader"),i.push("in vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&i.push("out vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("vec4 worldPosition = vec4(position, 1.0); "),i.push("   vec4 viewPosition = viewMatrix * worldPosition;"),t&&i.push("   vWorldPosition = worldPosition;"),i.push("   vec4 clipPos = projMatrix * viewPosition;"),i.push("   gl_PointSize = "+L_+".0;"),e.logarithmicDepthBufferEnabled?i.push("vFragDepth = 1.0 + clipPos.w;"):e.markerZOffset<0&&i.push("clipPos.z += "+e.markerZOffset+";"),i.push("   gl_Position = clipPos;"),i.push("}"),i}_buildFragmentShaderSource(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// OcclusionTester fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;");for(let a=0;a<t.sectionPlanes.length;a++)s.push("uniform bool sectionPlaneActive"+a+";"),s.push("uniform vec3 sectionPlanePos"+a+";"),s.push("uniform vec3 sectionPlaneDir"+a+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  float dist = 0.0;");for(var o=0;o<t.sectionPlanes.length;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vec4(1.0, 0.0, 0.0, 1.0); "),s.push("}"),s}_buildProgram(){this._program&&this._program.destroy();const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new Tt(t,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];const o=i.sectionPlanes;for(let a=0,n=o.length;a<n;a++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+a),pos:s.getLocation("sectionPlanePos"+a),dir:s.getLocation("sectionPlaneDir"+a)});this._aPosition=s.getAttribute("position"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}drawMarkers(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e._sectionPlanesState,o=e.camera,a=e.camera.project;if(i.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,o._project._state.matrix),e.logarithmicDepthBufferEnabled){const n=2/(Math.log(a.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,n)}for(let n=0,l=this._occlusionLayersList.length;n<l;n++){const c=this._occlusionLayersList[n];if(c.update(),c.culledBySectionPlanes)continue;const h=c.origin;t.uniformMatrix4fv(this._uViewMatrix,!1,Pt(o.viewMatrix,h));const d=s.sectionPlanes.length;if(d>0){const m=s.sectionPlanes;for(let g=0;g<d;g++){const u=this._uSectionPlanes[g];if(u){const x=c.sectionPlanesActive[g];if(t.uniform1i(u.active,x?1:0),x){const y=m[g];t.uniform3fv(u.pos,kt(y.dist,y.dir,h,U_)),t.uniform3fv(u.dir,y.dir)}}}}this._aPosition.bindArrayBuffer(c.positionsBuf);const p=c.indicesBuf;p.bind(),t.drawElements(t.POINTS,p.numItems,p.itemType,0)}}doOcclusionTest(){{const e=this._scene.canvas.resolutionScale,t=nl[0]*255,i=nl[1]*255,s=nl[2]*255;for(let o=0,a=this._occlusionLayersList.length;o<a;o++){const n=this._occlusionLayersList[o];for(let l=0;l<n.lenOcclusionTestList;l++){const c=n.occlusionTestList[l],h=l*2,d=this._readPixelBuf.read(Math.round(n.pixels[h]*e),Math.round(n.pixels[h+1]*e)),p=d[0]===t&&d[1]===i&&d[2]===s;c._setVisible(p)}}}}unbindRenderBuf(){this._readPixelBuf.unbind()}destroy(){if(!this.destroyed){for(let e=0,t=this._occlusionLayersList.length;e<t;e++)this._occlusionLayersList[e].destroy();this._program&&this._program.destroy(),this._scene.camera.off(this._onCameraViewMatrix),this._scene.camera.off(this._onCameraProjMatrix),this._scene.canvas.off(this._onCanvasBoundary),this.destroyed=!0}}}const al=A.vec2();class k_{constructor(e){this._scene=e,this._numSamples=null,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uRandomSeed=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null}render(e){if(this._build(),this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let x=!0;this._scene.camera.on("projMatrix",function(){x=!0});const y=A.mat4();return()=>(x&&A.inverseMat4(s.camera.projMatrix,y),y)})());const t=this._scene.canvas.gl,i=this._program,s=this._scene,o=s.sao,a=t.drawingBufferWidth,n=t.drawingBufferHeight,l=s.camera.project._state,c=l.near,h=l.far,d=l.matrix,p=this._getInverseProjectMat(),m=Math.random(),g=s.camera.projection==="perspective";al[0]=a,al[1]=n,t.viewport(0,0,a,n),t.clearColor(0,0,0,1),t.disable(t.DEPTH_TEST),t.disable(t.BLEND),t.frontFace(t.CCW),t.clear(t.COLOR_BUFFER_BIT),i.bind(),t.uniform1f(this._uCameraNear,c),t.uniform1f(this._uCameraFar,h),t.uniformMatrix4fv(this._uCameraProjectionMatrix,!1,d),t.uniformMatrix4fv(this._uCameraInverseProjectionMatrix,!1,p),t.uniform1i(this._uPerspective,g),t.uniform1f(this._uScale,o.scale*(h/5)),t.uniform1f(this._uIntensity,o.intensity),t.uniform1f(this._uBias,o.bias),t.uniform1f(this._uKernelRadius,o.kernelRadius),t.uniform1f(this._uMinResolution,o.minResolution),t.uniform2fv(this._uViewport,al),t.uniform1f(this._uRandomSeed,m);const u=e.getDepthTexture();i.bindTexture(this._uDepthTexture,u,0),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),t.drawElements(t.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}_build(){let e=!1;const t=this._scene.sao;if(t.numSamples!==this._numSamples&&(this._numSamples=Math.floor(t.numSamples),e=!0),!e)return;const i=this._scene.canvas.gl;if(this._program&&(this._program.destroy(),this._program=null),this._program=new Tt(i,{vertex:[`#version 300 es
                    precision highp float;
                    precision highp int;
                    
                    in vec3 aPosition;
                    in vec2 aUV;            
                    
                    out vec2 vUV;
                    
                    void main () {
                        gl_Position = vec4(aPosition, 1.0);
                        vUV = aUV;
                    }`],fragment:[`#version 300 es      
                precision highp float;
                precision highp int;           
                
                #define NORMAL_TEXTURE 0
                #define PI 3.14159265359
                #define PI2 6.28318530718
                #define EPSILON 1e-6
                #define NUM_SAMPLES ${this._numSamples}
                #define NUM_RINGS 4              
            
                in vec2        vUV;
            
                uniform sampler2D   uDepthTexture;
               
                uniform float       uCameraNear;
                uniform float       uCameraFar;
                uniform mat4        uProjectMatrix;
                uniform mat4        uInverseProjectMatrix;
                
                uniform bool        uPerspective;

                uniform float       uScale;
                uniform float       uIntensity;
                uniform float       uBias;
                uniform float       uKernelRadius;
                uniform float       uMinResolution;
                uniform vec2        uViewport;
                uniform float       uRandomSeed;

                float pow2( const in float x ) { return x*x; }
                
                highp float rand( const in vec2 uv ) {
                    const highp float a = 12.9898, b = 78.233, c = 43758.5453;
                    highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );
                    return fract(sin(sn) * c);
                }

                vec3 packNormalToRGB( const in vec3 normal ) {
                    return normalize( normal ) * 0.5 + 0.5;
                }

                vec3 unpackRGBToNormal( const in vec3 rgb ) {
                    return 2.0 * rgb.xyz - 1.0;
                }

                const float packUpscale = 256. / 255.;
                const float unpackDownScale = 255. / 256.; 

                const vec3 packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );
                const vec4 unPackFactors = unpackDownScale / vec4( packFactors, 1. );   

                const float shiftRights = 1. / 256.;

                vec4 packFloatToRGBA( const in float v ) {
                    vec4 r = vec4( fract( v * packFactors ), v );
                    r.yzw -= r.xyz * shiftRights; 
                    return r * packUpscale;
                }

                float unpackRGBAToFloat( const in vec4 v ) {                   
                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unPackFactors );
                }
                
                float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {
                    return ( near * far ) / ( ( far - near ) * invClipZ - far );
                }

                float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {
                    return linearClipZ * ( near - far ) - near;
                }
                
                float getDepth( const in vec2 screenPosition ) {
                    return vec4(texture(uDepthTexture, screenPosition)).r;
                }

                float getViewZ( const in float depth ) {
                     if (uPerspective) {
                         return perspectiveDepthToViewZ( depth, uCameraNear, uCameraFar );
                     } else {
                        return orthographicDepthToViewZ( depth, uCameraNear, uCameraFar );
                     }
                }

                vec3 getViewPos( const in vec2 screenPos, const in float depth, const in float viewZ ) {
                	float clipW = uProjectMatrix[2][3] * viewZ + uProjectMatrix[3][3];
                	vec4 clipPosition = vec4( ( vec3( screenPos, depth ) - 0.5 ) * 2.0, 1.0 );
                	clipPosition *= clipW; 
                	return ( uInverseProjectMatrix * clipPosition ).xyz;
                }

                vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPos ) {               
                    return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );
                }

                float scaleDividedByCameraFar;
                float minResolutionMultipliedByCameraFar;

                float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {
                	vec3 viewDelta = sampleViewPosition - centerViewPosition;
                	float viewDistance = length( viewDelta );
                	float scaledScreenDistance = scaleDividedByCameraFar * viewDistance;
                	return max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - uBias) / (1.0 + pow2( scaledScreenDistance ) );
                }

                const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );
                const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );

                float getAmbientOcclusion( const in vec3 centerViewPosition ) {
            
                	scaleDividedByCameraFar = uScale / uCameraFar;
                	minResolutionMultipliedByCameraFar = uMinResolution * uCameraFar;
                	vec3 centerViewNormal = getViewNormal( centerViewPosition, vUV );

                	float angle = rand( vUV + uRandomSeed ) * PI2;
                	vec2 radius = vec2( uKernelRadius * INV_NUM_SAMPLES ) / uViewport;
                	vec2 radiusStep = radius;

                	float occlusionSum = 0.0;
                	float weightSum = 0.0;

                	for( int i = 0; i < NUM_SAMPLES; i ++ ) {
                		vec2 sampleUv = vUV + vec2( cos( angle ), sin( angle ) ) * radius;
                		radius += radiusStep;
                		angle += ANGLE_STEP;

                		float sampleDepth = getDepth( sampleUv );
                		if( sampleDepth >= ( 1.0 - EPSILON ) ) {
                			continue;
                		}

                		float sampleViewZ = getViewZ( sampleDepth );
                		vec3 sampleViewPosition = getViewPos( sampleUv, sampleDepth, sampleViewZ );
                		occlusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );
                		weightSum += 1.0;
                	}

                	if( weightSum == 0.0 ) discard;

                	return occlusionSum * ( uIntensity / weightSum );
                }

                out vec4 outColor;
   
                void main() {
                
                	float centerDepth = getDepth( vUV );
                	
                	if( centerDepth >= ( 1.0 - EPSILON ) ) {
                		discard;
                	}

                	float centerViewZ = getViewZ( centerDepth );
                	vec3 viewPosition = getViewPos( vUV, centerDepth, centerViewZ );

                	float ambientOcclusion = getAmbientOcclusion( viewPosition );
                
                	outColor = packFloatToRGBA(  1.0- ambientOcclusion );
                }`]}),this._program.errors){console.error(this._program.errors.join(`
`)),this._programError=!0;return}const s=new Float32Array([1,1,0,1,0,0,1,0]),o=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),a=new Uint32Array([0,1,2,0,2,3]);this._positionsBuf=new Oe(i,i.ARRAY_BUFFER,o,o.length,3,i.STATIC_DRAW),this._uvBuf=new Oe(i,i.ARRAY_BUFFER,s,s.length,2,i.STATIC_DRAW),this._indicesBuf=new Oe(i,i.ELEMENT_ARRAY_BUFFER,a,a.length,1,i.STATIC_DRAW),this._program.bind(),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uCameraProjectionMatrix=this._program.getLocation("uProjectMatrix"),this._uCameraInverseProjectionMatrix=this._program.getLocation("uInverseProjectMatrix"),this._uPerspective=this._program.getLocation("uPerspective"),this._uScale=this._program.getLocation("uScale"),this._uIntensity=this._program.getLocation("uIntensity"),this._uBias=this._program.getLocation("uBias"),this._uKernelRadius=this._program.getLocation("uKernelRadius"),this._uMinResolution=this._program.getLocation("uMinResolution"),this._uViewport=this._program.getLocation("uViewport"),this._uRandomSeed=this._program.getLocation("uRandomSeed"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV"),this._dirty=!1}destroy(){this._program&&(this._program.destroy(),this._program=null)}}const N_=4,Q_=.01,Ra=16,V_=new Float32Array(vf(Ra+1,[0,1])),H_=new Float32Array(vf(Ra+1,[1,0])),j_=new Float32Array(G_(Ra+1,N_)),ll=new Float32Array(2);class z_{constructor(e){this._scene=e,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uOcclusionTexture="uOcclusionTexture",this._uViewport=null,this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init()}init(){const e=this._scene.canvas.gl;if(this._program=new Tt(e,{vertex:[`#version 300 es
                precision highp float;
                precision highp int;
                    
                in vec3 aPosition;
                in vec2 aUV;
                uniform vec2 uViewport;
                out vec2 vUV;
                out vec2 vInvSize;
                void main () {
                    vUV = aUV;
                    vInvSize = 1.0 / uViewport;
                    gl_Position = vec4(aPosition, 1.0);
                }`],fragment:[`#version 300 es
                precision highp float;
                precision highp int;
                    
                #define PI 3.14159265359
                #define PI2 6.28318530718
                #define EPSILON 1e-6

                #define KERNEL_RADIUS ${Ra}

                in vec2        vUV;
                in vec2        vInvSize;
            
                uniform sampler2D   uDepthTexture;
                uniform sampler2D   uOcclusionTexture;              
               
                uniform float       uCameraNear;
                uniform float       uCameraFar;               
                uniform float       uDepthCutoff;

                uniform vec2        uSampleOffsets[ KERNEL_RADIUS + 1 ];
                uniform float       uSampleWeights[ KERNEL_RADIUS + 1 ];

                const float         unpackDownscale = 255. / 256.; 

                const vec3          packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );
                const vec4          unpackFactors = unpackDownscale / vec4( packFactors, 1. );   

                const float packUpscale = 256. / 255.;
       
                const float shiftRights = 1. / 256.;
                
                float unpackRGBAToFloat( const in vec4 v ) {
                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unpackFactors );
                }               

                vec4 packFloatToRGBA( const in float v ) {
                    vec4 r = vec4( fract( v * packFactors ), v );
                    r.yzw -= r.xyz * shiftRights; 
                    return r * packUpscale;
                }

                float viewZToOrthographicDepth( const in float viewZ) {
                    return ( viewZ + uCameraNear ) / ( uCameraNear - uCameraFar );
                }
              
                float orthographicDepthToViewZ( const in float linearClipZ) {
                    return linearClipZ * ( uCameraNear - uCameraFar ) - uCameraNear;
                }

                float viewZToPerspectiveDepth( const in float viewZ) {
                    return (( uCameraNear + viewZ ) * uCameraFar ) / (( uCameraFar - uCameraNear ) * viewZ );
                }
                
                float perspectiveDepthToViewZ( const in float invClipZ) {
                    return ( uCameraNear * uCameraFar ) / ( ( uCameraFar - uCameraNear ) * invClipZ - uCameraFar );
                }

                float getDepth( const in vec2 screenPosition ) {
                    return vec4(texture(uDepthTexture, screenPosition)).r;
                }

                float getViewZ( const in float depth ) {
                     return perspectiveDepthToViewZ( depth );
                }

                out vec4 outColor;
        
                void main() {
                
                    float depth = getDepth( vUV );
                    if( depth >= ( 1.0 - EPSILON ) ) {
                        discard;
                    }

                    float centerViewZ = -getViewZ( depth );
                    bool rBreak = false;
                    bool lBreak = false;

                    float weightSum = uSampleWeights[0];
                    float occlusionSum = unpackRGBAToFloat(texture( uOcclusionTexture, vUV )) * weightSum;

                    for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {

                        float sampleWeight = uSampleWeights[i];
                        vec2 sampleUVOffset = uSampleOffsets[i] * vInvSize;

                        vec2 sampleUV = vUV + sampleUVOffset;
                        float viewZ = -getViewZ( getDepth( sampleUV ) );

                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {
                            rBreak = true;
                        }

                        if( ! rBreak ) {
                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;
                            weightSum += sampleWeight;
                        }

                        sampleUV = vUV - sampleUVOffset;
                        viewZ = -getViewZ( getDepth( sampleUV ) );

                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {
                            lBreak = true;
                        }

                        if( ! lBreak ) {
                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;
                            weightSum += sampleWeight;
                        }
                    }

                    outColor = packFloatToRGBA(occlusionSum / weightSum);
                }`]}),this._program.errors){console.error(this._program.errors.join(`
`)),this._programError=!0;return}const t=new Float32Array([1,1,0,1,0,0,1,0]),i=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),s=new Uint32Array([0,1,2,0,2,3]);this._positionsBuf=new Oe(e,e.ARRAY_BUFFER,i,i.length,3,e.STATIC_DRAW),this._uvBuf=new Oe(e,e.ARRAY_BUFFER,t,t.length,2,e.STATIC_DRAW),this._indicesBuf=new Oe(e,e.ELEMENT_ARRAY_BUFFER,s,s.length,1,e.STATIC_DRAW),this._program.bind(),this._uViewport=this._program.getLocation("uViewport"),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uDepthCutoff=this._program.getLocation("uDepthCutoff"),this._uSampleOffsets=e.getUniformLocation(this._program.handle,"uSampleOffsets"),this._uSampleWeights=e.getUniformLocation(this._program.handle,"uSampleWeights"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV")}render(e,t,i){if(this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let g=!0;this._scene.camera.on("projMatrix",function(){g=!0});const u=A.mat4();return()=>(g&&A.inverseMat4(a.camera.projMatrix,u),u)})());const s=this._scene.canvas.gl,o=this._program,a=this._scene,n=s.drawingBufferWidth,l=s.drawingBufferHeight,c=a.camera.project._state,h=c.near,d=c.far;s.viewport(0,0,n,l),s.clearColor(0,0,0,1),s.enable(s.DEPTH_TEST),s.disable(s.BLEND),s.frontFace(s.CCW),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),o.bind(),ll[0]=n,ll[1]=l,s.uniform2fv(this._uViewport,ll),s.uniform1f(this._uCameraNear,h),s.uniform1f(this._uCameraFar,d),s.uniform1f(this._uDepthCutoff,Q_),i===0?s.uniform2fv(this._uSampleOffsets,H_):s.uniform2fv(this._uSampleOffsets,V_),s.uniform1fv(this._uSampleWeights,j_);const p=e.getDepthTexture(),m=t.getTexture();o.bindTexture(this._uDepthTexture,p,0),o.bindTexture(this._uOcclusionTexture,m,1),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),s.drawElements(s.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}destroy(){this._program.destroy()}}function G_(r,e){const t=[];for(let i=0;i<=r;i++)t.push(W_(i,e));return t}function W_(r,e){return Math.exp(-(r*r)/(2*(e*e)))/(Math.sqrt(2*Math.PI)*e)}function vf(r,e){const t=[];for(let i=0;i<=r;i++)t.push(e[0]*i),t.push(e[1]*i);return t}class nc{constructor(e,t,i){i=i||{},this.gl=t,this.allocated=!1,this.canvas=e,this.buffer=null,this.bound=!1,this.size=i.size,this._hasDepthTexture=!!i.depthTexture}setSize(e){this.size=e}webglContextRestored(e){this.gl=e,this.buffer=null,this.allocated=!1,this.bound=!1}bind(...e){if(this._touch(...e),this.bound)return;const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}createTexture(e,t,i=null){const s=this.gl,o=s.createTexture();return s.bindTexture(s.TEXTURE_2D,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),i?s.texStorage2D(s.TEXTURE_2D,1,i,e,t):s.texImage2D(s.TEXTURE_2D,0,s.RGBA,e,t,0,s.RGBA,s.UNSIGNED_BYTE,null),o}_touch(...e){let t,i;const s=this.gl;if(this.size?(t=this.size[0],i=this.size[1]):(t=s.drawingBufferWidth,i=s.drawingBufferHeight),this.buffer){if(this.buffer.width===t&&this.buffer.height===i)return;this.buffer.textures.forEach(h=>s.deleteTexture(h)),s.deleteFramebuffer(this.buffer.framebuf),s.deleteRenderbuffer(this.buffer.renderbuf)}const o=[];e.length>0?o.push(...e.map(h=>this.createTexture(t,i,h))):o.push(this.createTexture(t,i));let a;this._hasDepthTexture&&(a=s.createTexture(),s.bindTexture(s.TEXTURE_2D,a),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_COMPONENT32F,t,i,0,s.DEPTH_COMPONENT,s.FLOAT,null));const n=s.createRenderbuffer();s.bindRenderbuffer(s.RENDERBUFFER,n),s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_COMPONENT32F,t,i);const l=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,l);for(let h=0;h<o.length;h++)s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+h,s.TEXTURE_2D,o[h],0);if(e.length>0&&s.drawBuffers(o.map((h,d)=>s.COLOR_ATTACHMENT0+d)),this._hasDepthTexture?s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.TEXTURE_2D,a,0):s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,n),s.bindTexture(s.TEXTURE_2D,null),s.bindRenderbuffer(s.RENDERBUFFER,null),s.bindFramebuffer(s.FRAMEBUFFER,null),s.bindFramebuffer(s.FRAMEBUFFER,l),!s.isFramebuffer(l))throw"Invalid framebuffer";s.bindFramebuffer(s.FRAMEBUFFER,null);const c=s.checkFramebufferStatus(s.FRAMEBUFFER);switch(c){case s.FRAMEBUFFER_COMPLETE:break;case s.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case s.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case s.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case s.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+c}this.buffer={framebuf:l,renderbuf:n,texture:o[0],textures:o,depthTexture:a,width:t,height:i},this.bound=!1}clear(){if(!this.bound)throw"Render buffer not bound";const e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}read(e,t,i=null,s=null,o=Uint8Array,a=4,n=0){const l=e,c=this.buffer.height?this.buffer.height-t-1:this.gl.drawingBufferHeight-t,h=new o(a),d=this.gl;return d.readBuffer(d.COLOR_ATTACHMENT0+n),d.readPixels(l,c,1,1,i||d.RGBA,s||d.UNSIGNED_BYTE,h,0),h}readArray(e=null,t=null,i=Uint8Array,s=4,o=0){const a=new i(this.buffer.width*this.buffer.height*s),n=this.gl;return n.readBuffer(n.COLOR_ATTACHMENT0+o),n.readPixels(0,0,this.buffer.width,this.buffer.height,e||n.RGBA,t||n.UNSIGNED_BYTE,a,0),a}readImageAsCanvas(){const e=this.gl,t=this._getImageDataCache(),i=t.pixelData,s=t.canvas,o=t.imageData,a=t.context;e.readPixels(0,0,this.buffer.width,this.buffer.height,e.RGBA,e.UNSIGNED_BYTE,i);const n=this.buffer.width,l=this.buffer.height,c=l/2|0,h=n*4,d=new Uint8Array(n*4);for(let p=0;p<c;++p){const m=p*h,g=(l-p-1)*h;d.set(i.subarray(m,m+h)),i.copyWithin(m,g,g+h),i.set(d,g)}return o.data.set(i),a.putImageData(o,0,0),s}readImage(e){const t=this.gl,i=this._getImageDataCache(),s=i.pixelData,o=i.canvas,a=i.imageData,n=i.context,{width:l,height:c}=this.buffer;t.readPixels(0,0,l,c,t.RGBA,t.UNSIGNED_BYTE,s),a.data.set(s),n.putImageData(a,0,0),n.save(),n.globalCompositeOperation="copy",n.scale(1,-1),n.drawImage(o,0,-c,l,c),n.restore();let h=e.format||"png";return h!=="jpeg"&&h!=="png"&&h!=="bmp"&&(console.error("Unsupported image format: '"+h+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'png'"),h="png"),o.toDataURL(`image/${h}`)}_getImageDataCache(e=Uint8Array,t=4){const i=this.buffer.width,s=this.buffer.height;let o=this._imageDataCache;if(o&&(o.width!==i||o.height!==s)&&(this._imageDataCache=null,o=null),!o){const a=document.createElement("canvas"),n=a.getContext("2d");a.width=i,a.height=s,o={pixelData:new e(i*s*t),canvas:a,context:n,imageData:n.createImageData(i,s),width:i,height:s},this._imageDataCache=o}return o.context.resetTransform(),o}unbind(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this.bound=!1}getTexture(e=0){const t=this;return this._texture||(this._texture={renderBuffer:this,bind:function(i){return t.buffer&&t.buffer.textures[e]?(t.gl.activeTexture(t.gl["TEXTURE"+i]),t.gl.bindTexture(t.gl.TEXTURE_2D,t.buffer.textures[e]),!0):!1},unbind:function(i){t.buffer&&t.buffer.textures[e]&&(t.gl.activeTexture(t.gl["TEXTURE"+i]),t.gl.bindTexture(t.gl.TEXTURE_2D,null))}})}hasDepthTexture(){return this._hasDepthTexture}getDepthTexture(){if(!this._hasDepthTexture)return null;const e=this;return this._depthTexture||(this._dethTexture={renderBuffer:this,bind:function(t){return e.buffer&&e.buffer.depthTexture?(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.depthTexture),!0):!1},unbind:function(t){e.buffer&&e.buffer.depthTexture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}})}destroy(){if(this.allocated){const e=this.gl;this.buffer.textures.forEach(t=>e.deleteTexture(t)),e.deleteTexture(this.buffer.depthTexture),e.deleteFramebuffer(this.buffer.framebuf),e.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}this._imageDataCache=null,this._texture=null,this._depthTexture=null}}class K_{constructor(e){this.scene=e,this._renderBuffersBasic={},this._renderBuffersScaled={}}getRenderBuffer(e,t){const i=this.scene.canvas.resolutionScale===1?this._renderBuffersBasic:this._renderBuffersScaled;let s=i[e];return s||(s=new nc(this.scene.canvas.canvas,this.scene.canvas.gl,t),i[e]=s),s}destroy(){for(let e in this._renderBuffersBasic)this._renderBuffersBasic[e].destroy();for(let e in this._renderBuffersScaled)this._renderBuffersScaled[e].destroy()}}function hi(r,e){if(r._cachedExtensions===void 0&&(r._cachedExtensions={}),r._cachedExtensions[e]!==void 0)return r._cachedExtensions[e];let t;switch(e){case"WEBGL_depth_texture":t=r.getExtension("WEBGL_depth_texture")||r.getExtension("MOZ_WEBGL_depth_texture")||r.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":t=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":t=r.getExtension("WEBGL_compressed_texture_s3tc")||r.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":t=r.getExtension("WEBGL_compressed_texture_pvrtc")||r.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:t=r.getExtension(e)}return r._cachedExtensions[e]=t,t}const X_=function(r,e){e=e||{};const t=new D_(r),i=r.canvas.canvas,s=r.canvas.gl,o=!!e.transparent,a=e.alphaDepthMask,n=new Di({});let l={},c={},h=[],d=[],p=!0,m=!0,g=!0,u=!0,x=!0,y=!0,P=!0,_=!0;const b=new K_(r);let B=!1;const w=new k_(r),C=new z_(r);this.scene=r,this._occlusionTester=null,this.capabilities={astcSupported:!!hi(s,"WEBGL_compressed_texture_astc"),etc1Supported:!0,etc2Supported:!!hi(s,"WEBGL_compressed_texture_etc"),dxtSupported:!!hi(s,"WEBGL_compressed_texture_s3tc"),bptcSupported:!!hi(s,"EXT_texture_compression_bptc"),pvrtcSupported:!!(hi(s,"WEBGL_compressed_texture_pvrtc")||hi(s,"WEBKIT_WEBGL_compressed_texture_pvrtc"))},this.setTransparentEnabled=function(S){u=S,g=!0},this.setEdgesEnabled=function(S){x=S,g=!0},this.setSAOEnabled=function(S){y=S,g=!0},this.setPBREnabled=function(S){P=S,g=!0},this.setColorTextureEnabled=function(S){_=S,g=!0},this.needStateSort=function(){m=!0},this.shadowsDirty=function(){},this.imageDirty=function(){g=!0},this.webglContextLost=function(){},this.webglContextRestored=function(S){w.init(),C.init(),g=!0},this.addDrawable=function(S,k){const D=k.type;if(!D){console.error("Renderer#addDrawable() : drawable with ID "+S+" has no 'type' - ignoring");return}let G=l[D];G||(G={type:k.type,count:0,isStateSortable:k.isStateSortable,stateSortCompare:k.stateSortCompare,drawableMap:{},drawableListPreCull:[],drawableList:[]},l[D]=G),G.count++,G.drawableMap[S]=k,c[S]=k,p=!0},this.removeDrawable=function(S){const k=c[S];if(!k){console.error("Renderer#removeDrawable() : drawable not found with ID "+S+" - ignoring");return}const D=k.type,G=l[D];--G.count<=0?delete l[D]:delete G.drawableMap[S],delete c[S],p=!0},this.getPickID=function(S){return n.addItem(S)},this.putPickID=function(S){n.removeItem(S)},this.clear=function(S){if(s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),o)s.clearColor(1,1,1,1);else{const k=r.canvas.backgroundColorFromAmbientLight?this.lights.getAmbientColorAndIntensity():r.canvas.backgroundColor;s.clearColor(k[0],k[1],k[2],1)}s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)},this.needsRender=function(){return g||p||m},this.render=function(S){S=S||{},S.force&&(g=!0),E(),g&&(z(S),_t.frame.frameCount++,g=!1)};function E(){p&&(I(),p=!1,m=!0),m&&(R(),m=!1,g=!0),g&&F()}function I(){for(let S in l)if(l.hasOwnProperty(S)){const k=l[S],D=k.drawableMap,G=k.drawableListPreCull;let se=0;for(let le in D)D.hasOwnProperty(le)&&(G[se++]=D[le]);G.length=se}}function R(){let S=0;for(let k in l)if(l.hasOwnProperty(k)){const G=l[k].drawableListPreCull;for(let se=0,le=G.length;se<le;se++){const te=G[se];h[S++]=te}}h.length=S,h.sort((k,D)=>k.renderOrder-D.renderOrder)}function F(){let S=0;for(let k=0,D=h.length;k<D;k++){const G=h[k];G.rebuildRenderFlags(),G.renderFlags.culled||(d[S++]=G)}d.length=S}function z(S){const k=r.sao;y&&k.possible&&Q(S),ae(),ge(S)}function Q(S){const k=r.sao,D=b.getRenderBuffer("saoDepth",{depthTexture:!0});D.bind(),D.clear(),H(S),D.unbind();const G=b.getRenderBuffer("saoOcclusion");if(G.bind(),G.clear(),w.render(D),G.unbind(),k.blur){const se=b.getRenderBuffer("saoOcclusion2");se.bind(),se.clear(),C.render(D,G,0),se.unbind(),G.bind(),G.clear(),C.render(D,se,1),G.unbind()}}function H(S){t.reset(),t.pass=S.pass,s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.clearColor(0,0,0,0),s.enable(s.DEPTH_TEST),s.frontFace(s.CCW),s.enable(s.CULL_FACE),s.depthMask(!0),S.clear!==!1&&s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);for(let k=0,D=d.length;k<D;k++){const G=d[k];G.culled===!0||G.visible===!1||!G.drawDepth||!G.saoEnabled||G.renderFlags.colorOpaque&&G.drawDepth(t)}}function ae(){let S=r._lightsState.lights;for(let k=0,D=S.length;k<D;k++){const G=S[k];G.castsShadow&&pe(G)}}function pe(S){if(!S.castsShadow)return;const D=S.getShadowRenderBuf();if(D){D.bind(),t.reset(),t.backfaces=!0,t.frontface=!0,t.shadowViewMatrix=S.getShadowViewMatrix(),t.shadowProjMatrix=S.getShadowProjMatrix(),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.clearColor(0,0,0,1),s.enable(s.DEPTH_TEST),s.disable(s.BLEND),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);for(let G in l)if(l.hasOwnProperty(G)){const le=l[G].drawableList;for(let te=0,oe=le.length;te<oe;te++){const Y=le[te];Y.visible===!1||!Y.castsShadow||!Y.drawShadow||Y.renderFlags.colorOpaque&&Y.drawShadow(t)}}D.unbind()}}function ge(S){const k=[],D=[],G=[],se=[],le=[],te=[],oe=[],Y=[],ne=[],Ae=[],$=[],J=[],_e=[],re=[],he=[],ce=[],xe=r._lightsState.getAmbientColorAndIntensity();if(t.reset(),t.pass=S.pass,t.withSAO=!1,t.pbrEnabled=P&&!!r.pbrEnabled,t.colorTextureEnabled=_&&!!r.colorTextureEnabled,s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),o)s.clearColor(0,0,0,0);else{const We=r.canvas.backgroundColorFromAmbientLight?xe:r.canvas.backgroundColor;s.clearColor(We[0],We[1],We[2],1)}s.enable(s.DEPTH_TEST),s.frontFace(s.CCW),s.enable(s.CULL_FACE),s.depthMask(!0),s.lineWidth(1),t.lineWidth=1;const De=r.sao.possible;if(y&&De){const We=b.getRenderBuffer("saoOcclusion");t.occlusionTexture=We?We.getTexture():null}else t.occlusionTexture=null;let ie,de;const me=Date.now();S.clear!==!1&&s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);let ye=0,K=0,Le=0,je=0,Z=0,qe=0,$e=0,Ke=0,ot=0,nt=0,ht=0,Ce=0,He=0,Qe=0,ue=0,X=0;for(let We=0,Pi=d.length;We<Pi;We++){if(de=d[We],de.culled===!0||de.visible===!1)continue;const wt=de.renderFlags;wt.colorOpaque&&(y&&De&&de.saoEnabled?k[ye++]=de:de.drawColorOpaque(t)),u&&wt.colorTransparent&&(G[Le++]=de),wt.xrayedSilhouetteTransparent&&(oe[$e++]=de),wt.xrayedSilhouetteOpaque&&(le[Z++]=de),wt.highlightedSilhouetteTransparent&&($[ht++]=de),wt.highlightedSilhouetteOpaque&&(ne[ot++]=de),wt.selectedSilhouetteTransparent&&(he[ue++]=de),wt.selectedSilhouetteOpaque&&(_e[He++]=de),de.edges&&x&&(wt.edgesOpaque&&(D[K++]=de),wt.edgesTransparent&&(se[je++]=de),wt.selectedEdgesTransparent&&(ce[X++]=de),wt.selectedEdgesOpaque&&(re[Qe++]=de),wt.xrayedEdgesTransparent&&(Y[Ke++]=de),wt.xrayedEdgesOpaque&&(te[qe++]=de),wt.highlightedEdgesTransparent&&(J[Ce++]=de),wt.highlightedEdgesOpaque&&(Ae[nt++]=de))}if(ye>0)for(t.withSAO=!0,ie=0;ie<ye;ie++)k[ie].drawColorOpaque(t);if(K>0)for(ie=0;ie<K;ie++)D[ie].drawEdgesColorOpaque(t);if(Z>0)for(ie=0;ie<Z;ie++)le[ie].drawSilhouetteXRayed(t);if(qe>0)for(ie=0;ie<qe;ie++)te[ie].drawEdgesXRayed(t);if($e>0||Ke>0||Le>0||je>0){if(s.enable(s.CULL_FACE),s.enable(s.BLEND),o?(s.blendEquation(s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA)):(s.blendEquation(s.FUNC_ADD),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA)),t.backfaces=!1,a||s.depthMask(!1),(Le>0||je>0)&&s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),je>0)for(ie=0;ie<je;ie++)de=se[ie],de.drawEdgesColorTransparent(t);if(Le>0)for(ie=0;ie<Le;ie++)de=G[ie],de.drawColorTransparent(t);if(Ke>0)for(ie=0;ie<Ke;ie++)Y[ie].drawEdgesXRayed(t);if($e>0)for(ie=0;ie<$e;ie++)oe[ie].drawSilhouetteXRayed(t);s.disable(s.BLEND),a||s.depthMask(!0)}if(ot>0||nt>0){if(t.lastProgramId=null,r.highlightMaterial.glowThrough&&s.clear(s.DEPTH_BUFFER_BIT),nt>0)for(ie=0;ie<nt;ie++)Ae[ie].drawEdgesHighlighted(t);if(ot>0)for(ie=0;ie<ot;ie++)ne[ie].drawSilhouetteHighlighted(t)}if(ht>0||Ce>0||ot>0){if(t.lastProgramId=null,r.selectedMaterial.glowThrough&&s.clear(s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),o?(s.blendEquation(s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA)):s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.enable(s.CULL_FACE),Ce>0)for(ie=0;ie<Ce;ie++)J[ie].drawEdgesHighlighted(t);if(ht>0)for(ie=0;ie<ht;ie++)$[ie].drawSilhouetteHighlighted(t);s.disable(s.BLEND)}if(He>0||Qe>0){if(t.lastProgramId=null,r.selectedMaterial.glowThrough&&s.clear(s.DEPTH_BUFFER_BIT),Qe>0)for(ie=0;ie<Qe;ie++)re[ie].drawEdgesSelected(t);if(He>0)for(ie=0;ie<He;ie++)_e[ie].drawSilhouetteSelected(t)}if(ue>0||X>0){if(t.lastProgramId=null,r.selectedMaterial.glowThrough&&s.clear(s.DEPTH_BUFFER_BIT),s.enable(s.CULL_FACE),s.enable(s.BLEND),o?(s.blendEquation(s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA)):s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),X>0)for(ie=0;ie<X;ie++)ce[ie].drawEdgesSelected(t);if(ue>0)for(ie=0;ie<ue;ie++)he[ie].drawSilhouetteSelected(t);s.disable(s.BLEND)}const Ze=Date.now(),et=_t.frame;et.renderTime=(Ze-me)/1e3,et.drawElements=t.drawElements,et.drawArrays=t.drawArrays,et.useProgram=t.useProgram,et.bindTexture=t.bindTexture,et.bindArray=t.bindArray;const Ge=yt.MAX_TEXTURE_IMAGE_UNITS;for(let We=0;We<Ge;We++)s.activeTexture(s.TEXTURE0+We);s.bindTexture(s.TEXTURE_CUBE_MAP,null),s.bindTexture(s.TEXTURE_2D,null);const Bt=yt.MAX_VERTEX_ATTRIBS;for(let We=0;We<Bt;We++)s.disableVertexAttribArray(We)}this.pick=function(){const S=A.vec3();A.mat4();const k=A.mat4(),D=A.vec3(),G=A.vec3([0,1,0]),se=new xA,le=A.vec2(),te=A.vec3(),oe=A.vec3(),Y=A.vec3();return A.vec3(),A.vec3(),function(ne,Ae=se){Ae.reset(),E();let $,J=null,_e=null,re=null;Ae.pickSurface=ne.pickSurface,ne.canvasPos?(te[0]=ne.canvasPos[0],te[1]=ne.canvasPos[1],J=r.camera.viewMatrix,_e=r.camera.projMatrix,re=r.camera.projection,Ae.canvasPos=ne.canvasPos):(ne.matrix?(J=ne.matrix,_e=r.camera.projMatrix,re=r.camera.projection):(oe.set(ne.origin||[0,0,0]),Y.set(ne.direction||[0,0,1]),$=A.addVec3(oe,Y,S),D[0]=Math.random(),D[1]=Math.random(),D[2]=Math.random(),A.normalizeVec3(D),A.cross3Vec3(Y,D,G),J=A.lookAtMat4v(oe,$,G,k),_e=r.camera.ortho.matrix,re="ortho",Ae.origin=oe,Ae.direction=Y),te[0]=i.clientWidth*.5,te[1]=i.clientHeight*.5);for(let De in l)if(l.hasOwnProperty(De)){const ie=l[De].drawableList;for(let de=0,me=ie.length;de<me;de++){const ye=ie[de];ye.setPickMatrices&&ye.setPickMatrices(J,_e)}}const he=b.getRenderBuffer("pick",{size:[1,1]});he.bind();const ce=fe(he,te,J,_e,ne,Ae);if(!ce)return he.unbind(),null;const xe=ce.delegatePickedEntity?ce.delegatePickedEntity():ce;return xe?(ne.pickSurface&&(ce.canPickTriangle&&ce.canPickTriangle()?(Me(he,ce,te,J,_e,Ae),ce.pickTriangleSurface(J,_e,re,Ae),Ae.pickSurfacePrecision=!1):ce.canPickWorldPos&&ce.canPickWorldPos()&&(le[0]=r.camera.project.near,le[1]=r.camera.project.far,be(he,ce,te,J,_e,le,Ae),ne.pickSurfaceNormal!==!1&&Se(he,ce,te,J,_e,Ae),Ae.pickSurfacePrecision=!1)),he.unbind(),Ae.entity=xe,Ae):(he.unbind(),null)}}();function fe(S,k,D,G,se,le){const te=r.canvas.resolutionScale;t.reset(),t.backfaces=!0,t.frontface=!0,t.pickOrigin=le.origin,t.pickViewMatrix=D,t.pickProjMatrix=G,t.pickInvisible=!!se.pickInvisible,t.pickClipPos=[Te(k[0]*te,s.drawingBufferWidth),Ne(k[1]*te,s.drawingBufferHeight)],s.viewport(0,0,1,1),s.depthMask(!0),s.enable(s.DEPTH_TEST),s.disable(s.CULL_FACE),s.disable(s.BLEND),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);const oe=se.includeEntityIds,Y=se.excludeEntityIds;for(let J=0,_e=d.length;J<_e;J++){const re=d[J];re.culled===!0||re.visible===!1||!re.drawPickMesh||se.pickInvisible!==!0&&re.visible===!1||re.pickable===!1||oe&&!oe[re.id]||Y&&Y[re.id]||re.drawPickMesh(t)}const ne=S.read(0,0),Ae=ne[0]+(ne[1]<<8)+(ne[2]<<16)+(ne[3]<<24);return Ae<0?void 0:n.items[Ae]}function Me(S,k,D,G,se,le){if(!k.drawPickTriangles)return;const te=r.canvas.resolutionScale;t.reset(),t.backfaces=!0,t.frontface=!0,t.pickOrigin=le.origin,t.pickViewMatrix=G,t.pickProjMatrix=se,t.pickClipPos=[Te(D[0]*te,s.drawingBufferWidth),Ne(D[1]*te,s.drawingBufferHeight)],s.viewport(0,0,1,1),s.clearColor(0,0,0,0),s.enable(s.DEPTH_TEST),s.disable(s.CULL_FACE),s.disable(s.BLEND),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),k.drawPickTriangles(t);const oe=S.read(0,0);let Y=oe[0]+oe[1]*256+oe[2]*256*256+oe[3]*256*256*256;Y*=3,le.primIndex=Y}const be=function(){const S=A.vec4(),k=A.vec4(),D=A.vec4(),G=A.vec4(),se=A.vec4(),le=A.mat4(),te=A.mat4(),oe=A.mat4();return function(Y,ne,Ae,$,J,_e,re){const he=r.canvas.resolutionScale;t.reset(),t.backfaces=!0,t.frontface=!0,t.pickOrigin=re.origin,t.pickViewMatrix=$,t.pickProjMatrix=J,t.pickZNear=_e[0],t.pickZFar=_e[1],t.pickElementsCount=ne.pickElementsCount,t.pickElementsOffset=ne.pickElementsOffset,t.pickClipPos=[Te(Ae[0]*he,s.drawingBufferWidth),Ne(Ae[1]*he,s.drawingBufferHeight)],s.viewport(0,0,1,1),s.clearColor(0,0,0,0),s.depthMask(!0),s.enable(s.DEPTH_TEST),s.disable(s.CULL_FACE),s.disable(s.BLEND),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),ne.drawPickDepths(t);const ce=Y.read(0,0),xe=Be(ce),De=(Ae[0]-i.clientWidth/2)/(i.clientWidth/2),ie=-(Ae[1]-i.clientHeight/2)/(i.clientHeight/2),de=ne.origin;let me;if(de){const qe=Pt($,de,le);me=A.mulMat4(J,qe,te)}else me=A.mulMat4(J,$,te);const ye=A.inverseMat4(me,oe);S[0]=De,S[1]=ie,S[2]=-1,S[3]=1;let K=A.transformVec4(ye,S);K=A.mulVec4Scalar(K,1/K[3]),k[0]=De,k[1]=ie,k[2]=1,k[3]=1;let Le=A.transformVec4(ye,k);Le=A.mulVec4Scalar(Le,1/Le[3]);const je=A.subVec3(Le,K,D),Z=A.addVec3(K,A.mulVec4Scalar(je,xe,G),se);de&&A.addVec3(Z,de),re.worldPos=Z}}();function Fe(S){S.snapPickLayerParams=[],S.snapPickLayerNumber=0;for(let k=0,D=d.length;k<D;k++){const G=d[k];G.drawSnapInit&&!G.culled&&G.visible&&G.pickable&&G.drawSnapInit(S)}return S.snapPickLayerParams}function Re(S){S.snapPickLayerParams=S.snapPickLayerParams||[],S.snapPickLayerNumber=S.snapPickLayerParams.length;for(let k=0,D=d.length;k<D;k++){const G=d[k];G.drawSnapInit&&G.drawSnap&&!G.culled&&G.visible&&G.pickable&&G.drawSnap(S)}return S.snapPickLayerParams}function Te(S,k){return 2*(S/k)-1}function Ne(S,k){return 1-2*(S/k)}this.snapPick=function(){const S=new xA;return function(k,D=S){const{canvasPos:G,origin:se,direction:le,snapRadius:te,snapToVertex:oe,snapToEdge:Y}=k;if(!oe&&!Y)return this.pick({canvasPos:G,pickSurface:!0});const ne=r.canvas.resolutionScale;t.reset(),t.backfaces=!0,t.frontface=!0,t.pickZNear=r.camera.project.near,t.pickZFar=r.camera.project.far;const Ae=te||30,$=b.getRenderBuffer("uniquePickColors-aabs",{depthTexture:!0,size:[2*Ae+1,2*Ae+1]});t.snapVectorA=[G?Te(G[0]*ne,s.drawingBufferWidth):0,G?Ne(G[1]*ne,s.drawingBufferHeight):0],t.snapInvVectorAB=[s.drawingBufferWidth/(2*Ae),s.drawingBufferHeight/(2*Ae)],$.bind(s.RGBA32I,s.RGBA32I,s.RGBA8UI),s.viewport(0,0,$.size[0],$.size[1]),s.enable(s.DEPTH_TEST),s.frontFace(s.CCW),s.disable(s.CULL_FACE),s.depthMask(!0),s.disable(s.BLEND),s.depthFunc(s.LEQUAL),s.clear(s.DEPTH_BUFFER_BIT),s.clearBufferiv(s.COLOR,0,new Int32Array([0,0,0,0])),s.clearBufferiv(s.COLOR,1,new Int32Array([0,0,0,0])),s.clearBufferuiv(s.COLOR,2,new Uint32Array([0,0,0,0])),t.pickViewMatrix=G?r.camera.viewMatrix:A.lookAtMat4v(se,A.addVec3(se,le,A.vec3()),A.vec3([0,1,0]),A.mat4());const J=r.camera.projMatrix;for(let He in l)if(l.hasOwnProperty(He)){const Qe=l[He].drawableList;for(let ue=0,X=Qe.length;ue<X;ue++){const Ze=Qe[ue];Ze.setPickMatrices&&Ze.setPickMatrices(t.pickViewMatrix,J)}}s.drawBuffers([s.COLOR_ATTACHMENT0,s.COLOR_ATTACHMENT1,s.COLOR_ATTACHMENT2]);const _e=Fe(t),re=[];t.snapPickLayerParams=re,s.depthMask(!1),s.drawBuffers([s.COLOR_ATTACHMENT0]),oe&&Y?(t.snapMode="edge",Re(t),t.snapMode="vertex",t.snapPickLayerNumber++,Re(t)):(t.snapMode=oe?"vertex":"edge",Re(t)),s.depthMask(!0);const he=$.readArray(s.RGBA_INTEGER,s.INT,Int32Array,4),ce=$.readArray(s.RGBA_INTEGER,s.INT,Int32Array,4,1),xe=$.readArray(s.RGBA_INTEGER,s.UNSIGNED_INT,Uint32Array,4,2);$.unbind();let De=null,ie=null,de=null;const me=Ae,ye=Ae,K=me*4+ye*$.size[0]*4,Le=he.slice(K,K+4),je=ce.slice(K,K+4),Z=xe.slice(K,K+4);if(Le[3]!==0){const He=_e[Math.abs(Le[3])%_e.length],Qe=He.origin,ue=He.coordinateScale;De=[Le[0]*ue[0]+Qe[0],Le[1]*ue[1]+Qe[1],Le[2]*ue[2]+Qe[2]],ie=A.normalizeVec3([je[0]/A.MAX_INT,je[1]/A.MAX_INT,je[2]/A.MAX_INT]);const X=Z[0]+(Z[1]<<8)+(Z[2]<<16)+(Z[3]<<24);de=n.items[X]}let qe=[];for(let He=0;He<he.length;He+=4)if(he[He+3]>0){const Qe=Math.floor(He/4),ue=$.size[0],X=Qe%ue-Math.floor(ue/2),Ze=Math.floor(Qe/ue)-Math.floor(ue/2),et=Math.sqrt(Math.pow(X,2)+Math.pow(Ze,2));qe.push({x:X,y:Ze,dist:et,isVertex:oe&&Y?he[He+3]>re.length/2:oe,result:[he[He+0],he[He+1],he[He+2],he[He+3]],normal:[ce[He+0],ce[He+1],ce[He+2],ce[He+3]],id:[xe[He+0],xe[He+1],xe[He+2],xe[He+3]]})}let $e=null,Ke=null,ot=null,nt=null;if(qe.length>0){qe.sort((Ge,Bt)=>Ge.isVertex!==Bt.isVertex?Ge.isVertex?-1:1:Ge.dist-Bt.dist),nt=qe[0].isVertex?"vertex":"edge";const He=qe[0].result,Qe=qe[0].normal,ue=qe[0].id,X=re[He[3]],Ze=X.origin,et=X.coordinateScale;Ke=A.normalizeVec3([Qe[0]/A.MAX_INT,Qe[1]/A.MAX_INT,Qe[2]/A.MAX_INT]),$e=[He[0]*et[0]+Ze[0],He[1]*et[1]+Ze[1],He[2]*et[2]+Ze[2]],ot=n.items[ue[0]+(ue[1]<<8)+(ue[2]<<16)+(ue[3]<<24)]}if(De===null&&$e==null)return null;let ht=null;$e!==null&&(ht=r.camera.projectWorldPos($e));const Ce=ot&&ot.delegatePickedEntity?ot.delegatePickedEntity():ot;return!Ce&&de&&(de=de.delegatePickedEntity?de.delegatePickedEntity():de),D.reset(),D.snappedToEdge=nt==="edge",D.snappedToVertex=nt==="vertex",D.worldPos=$e||De,D.worldNormal=Ke||ie,D.entity=Ce||de,D.canvasPos=G||r.camera.projectWorldPos(De||$e),D.snappedCanvasPos=ht||G,D}}();function Be(S){const k=[S[0]/256,S[1]/256,S[2]/256,S[3]/256],D=[1/(256*256*256),1/(256*256),1/256,1];return A.dotVec4(k,D)}function Se(S,k,D,G,se,le){const te=r.canvas.resolutionScale;t.reset(),t.backfaces=!0,t.frontface=!0,t.pickOrigin=le.origin,t.pickViewMatrix=G,t.pickProjMatrix=se,t.pickClipPos=[Te(D[0]*te,s.drawingBufferWidth),Ne(D[1]*te,s.drawingBufferHeight)];const oe=b.getRenderBuffer("pick-normal",{size:[3,3]});oe.bind(s.RGBA32I),s.viewport(0,0,oe.size[0],oe.size[1]),s.enable(s.DEPTH_TEST),s.disable(s.CULL_FACE),s.disable(s.BLEND),s.clear(s.DEPTH_BUFFER_BIT),s.clearBufferiv(s.COLOR,0,new Int32Array([0,0,0,0])),k.drawPickNormals(t);const Y=oe.read(1,1,s.RGBA_INTEGER,s.INT,Int32Array,4);oe.unbind();const ne=[Y[0]/A.MAX_INT,Y[1]/A.MAX_INT,Y[2]/A.MAX_INT];A.normalizeVec3(ne),le.worldNormal=ne}this.addMarker=function(S){this._occlusionTester=this._occlusionTester||new O_(r,b),this._occlusionTester.addMarker(S),r.occlusionTestCountdown=0},this.markerWorldPosUpdated=function(S){this._occlusionTester.markerWorldPosUpdated(S)},this.removeMarker=function(S){this._occlusionTester.removeMarker(S)},this.doOcclusionTest=function(){if(this._occlusionTester&&this._occlusionTester.needOcclusionTest){E(),this._occlusionTester.bindRenderBuf(),t.reset(),t.backfaces=!0,t.frontface=!0,s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.clearColor(0,0,0,0),s.enable(s.DEPTH_TEST),s.disable(s.CULL_FACE),s.disable(s.BLEND),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);for(let S=0,k=d.length;S<k;S++){const D=d[S];!D.drawOcclusion||D.culled===!0||D.visible===!1||D.pickable===!1||D.drawOcclusion(t)}this._occlusionTester.drawMarkers(t),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf()}},this.readPixels=function(S,k,D,G){const se=b.getRenderBuffer("snapshot");se.bind(),se.clear(),this.render({force:!0,opaqueOnly:G});let le,te,oe,Y;for(te=0;te<D;te++)oe=te*2,Y=te*4,le=se.read(S[oe],S[oe+1]),k[Y]=le[0],k[Y+1]=le[1],k[Y+2]=le[2],k[Y+3]=le[3];se.unbind(),g=!0},this.beginSnapshot=function(S={}){const k=b.getRenderBuffer("snapshot");S.width&&S.height&&k.setSize([S.width,S.height]),k.bind(),k.clear(),B=!0},this.renderSnapshot=function(){if(!B)return;b.getRenderBuffer("snapshot").clear(),this.render({force:!0,opaqueOnly:!1}),g=!0},this.readSnapshot=function(S){return b.getRenderBuffer("snapshot").readImage(S)},this.readSnapshotAsCanvas=function(){return b.getRenderBuffer("snapshot").readImageAsCanvas()},this.endSnapshot=function(){if(!B)return;b.getRenderBuffer("snapshot").unbind(),B=!1},this.destroy=function(){l={},c={},b.destroy(),w.destroy(),C.destroy(),this._occlusionTester&&this._occlusionTester.destroy()}};class Y_ extends vt{constructor(e,t={}){super(e,t),this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this.MOUSE_LEFT_BUTTON=260,this.MOUSE_MIDDLE_BUTTON=261,this.MOUSE_RIGHT_BUTTON=262,this.element=t.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.keyboardEnabled=!0,this.mouseover=!1,this.mouseCanvasPos=A.vec2(),this._keyboardEventsElement=t.keyboardEventsElement||document,this._bindEvents()}_bindEvents(){if(this._eventsBound)return;this._keyboardEventsElement.addEventListener("keydown",this._keyDownListener=i=>{!this.enabled||!this.keyboardEnabled||i.target.tagName!=="INPUT"&&i.target.tagName!=="TEXTAREA"&&(i.keyCode===this.KEY_CTRL?this.ctrlDown=!0:i.keyCode===this.KEY_ALT?this.altDown=!0:i.keyCode===this.KEY_SHIFT&&(this.shiftDown=!0),this.keyDown[i.keyCode]=!0,this.fire("keydown",i.keyCode,!0))},!1),this._keyboardEventsElement.addEventListener("keyup",this._keyUpListener=i=>{!this.enabled||!this.keyboardEnabled||i.target.tagName!=="INPUT"&&i.target.tagName!=="TEXTAREA"&&(i.keyCode===this.KEY_CTRL?this.ctrlDown=!1:i.keyCode===this.KEY_ALT?this.altDown=!1:i.keyCode===this.KEY_SHIFT&&(this.shiftDown=!1),this.keyDown[i.keyCode]=!1,this.fire("keyup",i.keyCode,!0))}),this.element.addEventListener("mouseenter",this._mouseEnterListener=i=>{this.enabled&&(this.mouseover=!0,this._getMouseCanvasPos(i),this.fire("mouseenter",this.mouseCanvasPos,!0))}),this.element.addEventListener("mouseleave",this._mouseLeaveListener=i=>{this.enabled&&(this.mouseover=!1,this._getMouseCanvasPos(i),this.fire("mouseleave",this.mouseCanvasPos,!0))}),this.element.addEventListener("mousedown",this._mouseDownListener=i=>{if(this.enabled){switch(i.which){case 1:this.mouseDownLeft=!0;break;case 2:this.mouseDownMiddle=!0;break;case 3:this.mouseDownRight=!0;break}this._getMouseCanvasPos(i),this.element.focus(),this.fire("mousedown",this.mouseCanvasPos,!0),this.mouseover&&i.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=i=>{if(this.enabled){switch(i.which){case 1:this.mouseDownLeft=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownRight=!1;break}this.fire("mouseup",this.mouseCanvasPos,!0)}},!0),document.addEventListener("click",this._clickListener=i=>{if(this.enabled){switch(i.which){case 1:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break}this._getMouseCanvasPos(i),this.fire("click",this.mouseCanvasPos,!0),this.mouseover&&i.preventDefault()}}),document.addEventListener("dblclick",this._dblClickListener=i=>{if(this.enabled){switch(i.which){case 1:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break}this._getMouseCanvasPos(i),this.fire("dblclick",this.mouseCanvasPos,!0),this.mouseover&&i.preventDefault()}});const e=this.scene.tickify(()=>this.fire("mousemove",this.mouseCanvasPos,!0));this.element.addEventListener("mousemove",this._mouseMoveListener=i=>{this.enabled&&(this._getMouseCanvasPos(i),e(),this.mouseover&&i.preventDefault())}),this.element.addEventListener("contextmenu",this._contextmenuListener=i=>{this.enabled&&(this._getMouseCanvasPos(i),this.fire("contextmenu",this.mouseCanvasPos,!0))});const t=this.scene.tickify(i=>{this.fire("mousewheel",i,!0)});this.element.addEventListener("wheel",this._mouseWheelListener=(i,s)=>{if(!this.enabled)return;const o=Math.max(-1,Math.min(1,-i.deltaY*40));t(o)},{passive:!0});{let i,s;this.on("mousedown",a=>{i=a[0],s=a[1]}),this.on("mouseup",a=>{i>=a[0]-2&&i<=a[0]+2&&s>=a[1]-2&&s<=a[1]+2&&this.fire("mouseclicked",a,!0)})}this.element.addEventListener("touchstart",this._touchstartListener=i=>{this.enabled&&[...i.changedTouches].forEach(s=>{this.fire("touchstart",[s.identifier,this._getTouchCanvasPos(s)],!0)})}),this.element.addEventListener("touchend",this._touchendListener=i=>{this.enabled&&[...i.changedTouches].forEach(s=>{this.fire("touchend",[s.identifier,this._getTouchCanvasPos(s)],!0)})}),this._eventsBound=!0}_unbindEvents(){this._eventsBound&&(this._keyboardEventsElement.removeEventListener("keydown",this._keyDownListener),this._keyboardEventsElement.removeEventListener("keyup",this._keyUpListener),this.element.removeEventListener("mouseenter",this._mouseEnterListener),this.element.removeEventListener("mouseleave",this._mouseLeaveListener),this.element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("click",this._clickListener),document.removeEventListener("dblclick",this._dblClickListener),this.element.removeEventListener("mousemove",this._mouseMoveListener),this.element.removeEventListener("contextmenu",this._contextmenuListener),this.element.removeEventListener("wheel",this._mouseWheelListener),this.element.removeEventListener("touchstart",this._touchstartListener),this.element.removeEventListener("touchend",this._touchendListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener),this._eventsBound=!1)}_getTouchCanvasPos(e){let t=e.target,i=0,s=0;for(;t.offsetParent;)i+=t.offsetLeft,s+=t.offsetTop,t=t.offsetParent;return[e.pageX-i,e.pageY-s]}_getMouseCanvasPos(e){if(!e)e=window.event,this.mouseCanvasPos[0]=e.x,this.mouseCanvasPos[1]=e.y;else{const i=e.target.getBoundingClientRect();this.mouseCanvasPos[0]=e.clientX-i.left,this.mouseCanvasPos[1]=e.clientY-i.top}}setEnabled(e){this.enabled!==e&&this.fire("enabled",this.enabled=e)}getEnabled(){return this.enabled}setKeyboardEnabled(e){this.keyboardEnabled=e}getKeyboardEnabled(){return this.keyboardEnabled}destroy(){super.destroy(),this._unbindEvents()}}const uh=new Di({});class Mt{constructor(e){this.id=uh.addItem({});for(const t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}destroy(){uh.removeItem(this.id)}}class $_ extends vt{get type(){return"Viewport"}constructor(e,t={}){super(e,t),this._state=new Mt({boundary:[0,0,100,100]}),this.boundary=t.boundary,this.autoBoundary=t.autoBoundary}set boundary(e){if(!this._autoBoundary){if(!e){const t=this.scene.canvas.boundary,i=t[2],s=t[3];e=[0,0,i,s]}this._state.boundary=e,this.glRedraw(),this.fire("boundary",this._state.boundary)}}get boundary(){return this._state.boundary}set autoBoundary(e){e=!!e,e!==this._autoBoundary&&(this._autoBoundary=e,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",function(t){const i=t[2],s=t[3];this._state.boundary=[0,0,i,s],this.glRedraw(),this.fire("boundary",this._state.boundary)},this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))}get autoBoundary(){return this._autoBoundary}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}class Z_ extends vt{get type(){return"Perspective"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Mt({matrix:A.mat4(),inverseMatrix:A.mat4(),transposedMatrix:A.mat4(),near:.1,far:1e4}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this._fov=60,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=t.fov,this.fovAxis=t.fovAxis,this.near=t.near,this.far=t.far}_update(){const i=this.scene.canvas.boundary,s=i[2]/i[3],o=this._fovAxis;let a=this._fov;(o==="x"||o==="min"&&s<1||o==="max"&&s>1)&&(a=a/s),a=Math.min(a,120),A.perspectiveMat4(a*(Math.PI/180),s,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.camera._updateScheduled=!0,this.fire("matrix",this._state.matrix)}set fov(e){e=e??60,e!==this._fov&&(this._fov=e,this._needUpdate(0),this.fire("fov",this._fov))}get fov(){return this._fov}set fovAxis(e){e=e||"min",this._fovAxis!==e&&(e!=="x"&&e!=="y"&&e!=="min"&&(this.error("Unsupported value for 'fovAxis': "+e+" - defaulting to 'min'"),e="min"),this._fovAxis=e,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))}get fovAxis(){return this._fovAxis}set near(e){const t=e??.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(e){const t=e??1e4;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(A.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(A.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,o){const a=this.scene.canvas.canvas,n=a.offsetWidth/2,l=a.offsetHeight/2;return i[0]=(e[0]-n)/n,i[1]=(e[1]-l)/l,i[2]=t,i[3]=1,A.mulMat4v4(this.inverseMatrix,i,s),A.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,A.mulMat4v4(this.camera.inverseViewMatrix,s,o),o}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._canvasResized)}}class q_ extends vt{get type(){return"Ortho"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Mt({matrix:A.mat4(),inverseMatrix:A.mat4(),transposedMatrix:A.mat4(),near:.1,far:1e4}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.scale=t.scale,this.near=t.near,this.far=t.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)}_update(){const i=this.scene,o=.5*this._scale,a=i.canvas.boundary,n=a[2],l=a[3],c=n/l;let h,d,p,m;n>l?(h=-o,d=o,p=o/c,m=-o/c):(h=-o*c,d=o*c,p=o,m=-o),A.orthoMat4c(h,d,m,p,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set scale(e){e==null&&(e=1),e<=0&&(e=.01),this._scale=e,this._needUpdate(0),this.fire("scale",this._scale)}get scale(){return this._scale}set near(e){const t=e??.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(e){const t=e??1e4;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(A.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(A.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,o){const a=this.scene.canvas.canvas,n=a.offsetWidth/2,l=a.offsetHeight/2;return i[0]=(e[0]-n)/n,i[1]=(e[1]-l)/l,i[2]=t,i[3]=1,A.mulMat4v4(this.inverseMatrix,i,s),A.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,A.mulMat4v4(this.camera.inverseViewMatrix,s,o),o}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}}class J_ extends vt{get type(){return"Frustum"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Mt({matrix:A.mat4(),inverseMatrix:A.mat4(),transposedMatrix:A.mat4(),near:.1,far:1e4}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.left=t.left,this.right=t.right,this.bottom=t.bottom,this.top=t.top,this.near=t.near,this.far=t.far}_update(){A.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set left(e){this._left=e??-1,this._needUpdate(0),this.fire("left",this._left)}get left(){return this._left}set right(e){this._right=e??1,this._needUpdate(0),this.fire("right",this._right)}get right(){return this._right}set top(e){this._top=e??1,this._needUpdate(0),this.fire("top",this._top)}get top(){return this._top}set bottom(e){this._bottom=e??-1,this._needUpdate(0),this.fire("bottom",this._bottom)}get bottom(){return this._bottom}set near(e){this._state.near=e??.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(e){this._state.far=e??1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(A.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(A.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,o){const a=this.scene.canvas.canvas,n=a.offsetWidth/2,l=a.offsetHeight/2;return i[0]=(e[0]-n)/n,i[1]=(e[1]-l)/l,i[2]=t,i[3]=1,A.mulMat4v4(this.inverseMatrix,i,s),A.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,A.mulMat4v4(this.camera.inverseViewMatrix,s,o),o}destroy(){super.destroy(),this._state.destroy(),super.destroy()}}class e0 extends vt{get type(){return"CustomProjection"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Mt({matrix:A.mat4(),inverseMatrix:A.mat4(),transposedMatrix:A.mat4()}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!1,this.matrix=t.matrix}set matrix(e){this._state.matrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}get matrix(){return this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(A.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(A.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,o){const a=this.scene.canvas.canvas,n=a.offsetWidth/2,l=a.offsetHeight/2;return i[0]=(e[0]-n)/n,i[1]=(e[1]-l)/l,i[2]=t,i[3]=1,A.mulMat4v4(this.inverseMatrix,i,s),A.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,A.mulMat4v4(this.camera.inverseViewMatrix,s,o),o}destroy(){super.destroy(),this._state.destroy()}}const Ts=A.vec3(),Zs=A.vec3(),qs=A.vec3(),Js=A.vec3(),Al=A.vec3(),cl=A.vec3(),t0=A.vec4(),i0=A.vec4(),s0=A.vec4(),yi=A.mat4(),dh=A.mat4(),ph=A.vec3(),fh=A.vec3(),mh=A.vec3(),gh=A.vec3();class r0 extends vt{get type(){return"Camera"}constructor(e,t={}){super(e,t),this._state=new Mt({deviceMatrix:A.mat4(),hasDeviceMatrix:!1,matrix:A.mat4(),normalMatrix:A.mat4(),inverseMatrix:A.mat4()}),this._perspective=new Z_(this),this._ortho=new q_(this),this._frustum=new J_(this),this._customProjection=new e0(this),this._project=this._perspective,this._eye=A.vec3([0,0,10]),this._look=A.vec3([0,0,0]),this._up=A.vec3([0,1,0]),this._worldUp=A.vec3([0,1,0]),this._worldRight=A.vec3([1,0,0]),this._worldForward=A.vec3([0,0,-1]),this.deviceMatrix=t.deviceMatrix,this.eye=t.eye,this.look=t.look,this.up=t.up,this.worldAxis=t.worldAxis,this.gimbalLock=t.gimbalLock,this.constrainPitch=t.constrainPitch,this.projection=t.projection,this._perspective.on("matrix",()=>{this._projectionType==="perspective"&&this.fire("projMatrix",this._perspective.matrix)}),this._ortho.on("matrix",()=>{this._projectionType==="ortho"&&this.fire("projMatrix",this._ortho.matrix)}),this._frustum.on("matrix",()=>{this._projectionType==="frustum"&&this.fire("projMatrix",this._frustum.matrix)}),this._customProjection.on("matrix",()=>{this._projectionType==="customProjection"&&this.fire("projMatrix",this._customProjection.matrix)})}_update(){const e=this._state;let t;this.projection==="ortho"?(A.subVec3(this._eye,this._look,ph),A.normalizeVec3(ph,fh),A.mulVec3Scalar(fh,1e3,mh),A.addVec3(this._look,mh,gh),t=gh):t=this._eye,e.hasDeviceMatrix?(A.lookAtMat4v(t,this._look,this._up,dh),A.mulMat4(e.deviceMatrix,dh,e.matrix)):A.lookAtMat4v(t,this._look,this._up,e.matrix),A.inverseMat4(this._state.matrix,this._state.inverseMatrix),A.transposeMat4(this._state.inverseMatrix,this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}orbitYaw(e){let t=A.subVec3(this._eye,this._look,Ts);A.rotationMat4v(e*.0174532925,this._gimbalLock?this._worldUp:this._up,yi),t=A.transformPoint3(yi,t,Zs),this.eye=A.addVec3(this._look,t,qs),this.up=A.transformPoint3(yi,this._up,Js)}orbitPitch(e){if(this._constrainPitch&&(e=A.dotVec3(this._up,this._worldUp)/A.DEGTORAD,e<1))return;let t=A.subVec3(this._eye,this._look,Ts);const i=A.cross3Vec3(A.normalizeVec3(t,Zs),A.normalizeVec3(this._up,qs));A.rotationMat4v(e*.0174532925,i,yi),t=A.transformPoint3(yi,t,Js),this.up=A.transformPoint3(yi,this._up,Al),this.eye=A.addVec3(t,this._look,cl)}yaw(e){let t=A.subVec3(this._look,this._eye,Ts);A.rotationMat4v(e*.0174532925,this._gimbalLock?this._worldUp:this._up,yi),t=A.transformPoint3(yi,t,Zs),this.look=A.addVec3(t,this._eye,qs),this._gimbalLock&&(this.up=A.transformPoint3(yi,this._up,Js))}pitch(e){if(this._constrainPitch&&(e=A.dotVec3(this._up,this._worldUp)/A.DEGTORAD,e<1))return;let t=A.subVec3(this._look,this._eye,Ts);const i=A.cross3Vec3(A.normalizeVec3(t,Zs),A.normalizeVec3(this._up,qs));A.rotationMat4v(e*.0174532925,i,yi),this.up=A.transformPoint3(yi,this._up,cl),t=A.transformPoint3(yi,t,Js),this.look=A.addVec3(t,this._eye,Al)}pan(e){const t=A.subVec3(this._eye,this._look,Ts),i=[0,0,0];let s;if(e[0]!==0){const o=A.cross3Vec3(A.normalizeVec3(t,[]),A.normalizeVec3(this._up,Zs));s=A.mulVec3Scalar(o,e[0]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]}e[1]!==0&&(s=A.mulVec3Scalar(A.normalizeVec3(this._up,qs),e[1]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),e[2]!==0&&(s=A.mulVec3Scalar(A.normalizeVec3(t,Js),e[2]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),this.eye=A.addVec3(this._eye,i,Al),this.look=A.addVec3(this._look,i,cl)}zoom(e){const t=A.subVec3(this._eye,this._look,Ts),i=Math.abs(A.lenVec3(t,Zs)),s=Math.abs(i+e);if(s<.5)return;const o=A.normalizeVec3(t,qs);this.eye=A.addVec3(this._look,A.mulVec3Scalar(o,s),Js)}set eye(e){this._eye.set(e||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)}get eye(){return this._eye}set look(e){this._look.set(e||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)}get look(){return this._look}set up(e){this._up.set(e||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)}get up(){return this._up}set deviceMatrix(e){this._state.deviceMatrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!e,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)}get deviceMatrix(){return this._state.deviceMatrix}set worldAxis(e){e=e||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(e):this._worldAxis=A.vec3(e),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)}get worldAxis(){return this._worldAxis}get worldUp(){return this._worldUp}get xUp(){return this._worldUp[0]>this._worldUp[1]&&this._worldUp[0]>this._worldUp[2]}get yUp(){return this._worldUp[1]>this._worldUp[0]&&this._worldUp[1]>this._worldUp[2]}get zUp(){return this._worldUp[2]>this._worldUp[0]&&this._worldUp[2]>this._worldUp[1]}get worldRight(){return this._worldRight}get worldForward(){return this._worldForward}set gimbalLock(e){this._gimbalLock=e!==!1,this.fire("gimbalLock",this._gimbalLock)}get gimbalLock(){return this._gimbalLock}set constrainPitch(e){this._constrainPitch=!!e,this.fire("constrainPitch",this._constrainPitch)}get eyeLookDist(){return A.lenVec3(A.subVec3(this._look,this._eye,Ts))}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get viewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get normalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get viewNormalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get inverseViewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.inverseMatrix}get projMatrix(){return this[this.projection].matrix}get perspective(){return this._perspective}get ortho(){return this._ortho}get frustum(){return this._frustum}get customProjection(){return this._customProjection}set projection(e){e=e||"perspective",this._projectionType!==e&&(e==="perspective"?this._project=this._perspective:e==="ortho"?this._project=this._ortho:e==="frustum"?this._project=this._frustum:e==="customProjection"?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+e+" defaulting to 'perspective'"),this._project=this._perspective,e="perspective"),this._project._update(),this._projectionType=e,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType),this.fire("projMatrix",this._project.matrix))}get projection(){return this._projectionType}get project(){return this._project}projectWorldPos(e){const t=t0,i=i0,s=s0;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,A.mulMat4v4(this.viewMatrix,t,i),A.mulMat4v4(this.projMatrix,i,s),A.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1;const o=this.scene.canvas.canvas,a=o.offsetWidth/2,n=o.offsetHeight/2;return[s[0]*a+a,s[1]*n+n]}destroy(){super.destroy(),this._state.destroy()}}class ac extends vt{get type(){return"Light"}get isLight(){return!0}constructor(e,t={}){super(e,t)}}class bs extends ac{get type(){return"DirLight"}constructor(e,t={}){super(e,t),this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;const i=this.scene.camera,s=this.scene.canvas;this._onCameraViewMatrix=i.on("viewMatrix",()=>{this._shadowViewMatrixDirty=!0}),this._onCameraProjMatrix=i.on("projMatrix",()=>{this._shadowProjMatrixDirty=!0}),this._onCanvasBoundary=s.on("boundary",()=>{this._shadowProjMatrixDirty=!0}),this._state=new Mt({type:"dir",dir:A.vec3([1,1,1]),color:A.vec3([.7,.7,.8]),intensity:1,space:t.space||"view",castsShadow:!1,getShadowViewMatrix:()=>{if(this._shadowViewMatrixDirty){this._shadowViewMatrix||(this._shadowViewMatrix=A.identityMat4());const o=this.scene.camera,a=this._state.dir,n=o.look,l=[n[0]-a[0],n[1]-a[1],n[2]-a[2]],c=[0,1,0];A.lookAtMat4v(l,n,c,this._shadowViewMatrix),this._shadowViewMatrixDirty=!1}return this._shadowViewMatrix},getShadowProjMatrix:()=>(this._shadowProjMatrixDirty&&(this._shadowProjMatrix||(this._shadowProjMatrix=A.identityMat4()),A.orthoMat4c(-40,40,-40,40,-40,80,this._shadowProjMatrix),this._shadowProjMatrixDirty=!1),this._shadowProjMatrix),getShadowRenderBuf:()=>(this._shadowRenderBuf||(this._shadowRenderBuf=new nc(this.scene.canvas.canvas,this.scene.canvas.gl,{size:[1024,1024]})),this._shadowRenderBuf)}),this.dir=t.dir,this.color=t.color,this.intensity=t.intensity,this.castsShadow=t.castsShadow,this.scene._lightCreated(this)}set dir(e){this._state.dir.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}get dir(){return this._state.dir}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){e=e!==void 0?e:1,this._state.intensity=e,this.glRedraw()}get intensity(){return this._state.intensity}set castsShadow(e){e=!!e,this._state.castsShadow!==e&&(this._state.castsShadow=e,this._shadowViewMatrixDirty=!0,this.glRedraw())}get castsShadow(){return this._state.castsShadow}destroy(){const e=this.scene.camera,t=this.scene.canvas;e.off(this._onCameraViewMatrix),e.off(this._onCameraProjMatrix),t.off(this._onCanvasBoundary),super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}class o0 extends ac{get type(){return"AmbientLight"}constructor(e,t={}){super(e,t),this._state={type:"ambient",color:A.vec3([.7,.7,.7]),intensity:1},this.color=t.color,this.intensity=t.intensity,this.scene._lightCreated(this)}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){this._state.intensity=e!==void 0?e:1,this.glRedraw()}get intensity(){return this._state.intensity}destroy(){super.destroy(),this.scene._lightDestroyed(this)}}class Pf extends vt{get type(){return"Geometry"}get isGeometry(){return!0}constructor(e,t={}){super(e,t),_t.memory.meshes++}destroy(){super.destroy(),_t.memory.meshes--}}var ps=function(){const r=[],e=[],t=[],i=[],s=[];let o=0;const a=new Uint16Array(3),n=new Uint16Array(3),l=new Uint16Array(3),c=A.vec3(),h=A.vec3(),d=A.vec3(),p=A.vec3(),m=A.vec3(),g=A.vec3(),u=A.vec3();function x(P,_){const b={};let B,w,C,E;const R=Math.pow(10,4);let F,z,Q=0;for(F=0,z=P.length;F<z;F+=3)B=P[F],w=P[F+1],C=P[F+2],E=Math.round(B*R)+"_"+Math.round(w*R)+"_"+Math.round(C*R),b[E]===void 0&&(b[E]=Q/3,r[Q++]=B,r[Q++]=w,r[Q++]=C),e[F/3]=b[E];for(F=0,z=_.length;F<z;F++)i[F]=e[_[F]],t[i[F]]=_[F]}function y(P,_){o=0;for(let b=0,B=P;b<B;b+=3){const w=i[b]*3,C=i[b+1]*3,E=i[b+2]*3;_?(a[0]=r[w],a[1]=r[w+1],a[2]=r[w+2],n[0]=r[C],n[1]=r[C+1],n[2]=r[C+2],l[0]=r[E],l[1]=r[E+1],l[2]=r[E+2],A.decompressPosition(a,_,c),A.decompressPosition(n,_,h),A.decompressPosition(l,_,d)):(c[0]=r[w],c[1]=r[w+1],c[2]=r[w+2],h[0]=r[C],h[1]=r[C+1],h[2]=r[C+2],d[0]=r[E],d[1]=r[E+1],d[2]=r[E+2]),A.subVec3(d,h,p),A.subVec3(c,h,m),A.cross3Vec3(p,m,g),A.normalizeVec3(g,u);const I=s[o]||(s[o]={normal:A.vec3()});I.normal[0]=u[0],I.normal[1]=u[1],I.normal[2]=u[2],o++}}return function(P,_,b,B){x(P,_),y(_.length,b);const w=[],C=Math.cos(A.DEGTORAD*B),E={};let I,R,F,z,Q,H=!1,ae,pe,ge,fe,Me,be;for(let Fe=0,Re=_.length;Fe<Re;Fe+=3){const Te=Fe/3;for(let Ne=0;Ne<3;Ne++)I=i[Fe+Ne],R=i[Fe+(Ne+1)%3],F=Math.min(I,R),z=Math.max(I,R),Q=F+","+z,E[Q]===void 0?E[Q]={index1:F,index2:z,face1:Te,face2:void 0}:E[Q].face2=Te}for(Q in E)ae=E[Q],!(ae.face2!==void 0&&(pe=s[ae.face1].normal,ge=s[ae.face2].normal,fe=A.dotVec3(pe,ge),fe>C))&&(Me=t[ae.index1],be=t[ae.index2],(!H&&Me>65535||be>65535)&&(H=!0),w.push(Me),w.push(be));return H?new Uint32Array(w):new Uint16Array(w)}}();function n0(r){const e=new Float32Array(3),t=new Float32Array(3);let i,s;for(i=0;i<3;i++)e[i]=Number.MAX_VALUE,t[i]=-Number.MAX_VALUE;for(i=0;i<r.length;i+=3)for(s=0;s<3;s++)e[s]=Math.min(e[s],r[i+s]),t[s]=Math.max(t[s],r[i+s]);return{min:e,max:t}}const a0=function(){const r=A.mat4(),e=A.mat4();return function(t,i){i=i||A.mat4();const s=t[0],o=t[1],a=t[2],n=t[3]-s,l=t[4]-o,c=t[5]-a,h=65535;return A.identityMat4(r),A.translationMat4v(t,r),A.identityMat4(e),A.scalingMat4v([n/h,l/h,c/h],e),A.mulMat4(r,e,i),i}}();var l0=function(){const r=A.mat4(),e=A.mat4();return function(t,i,s){const o=new Uint16Array(t.length),a=new Float32Array([s[0]!==i[0]?65535/(s[0]-i[0]):0,s[1]!==i[1]?65535/(s[1]-i[1]):0,s[2]!==i[2]?65535/(s[2]-i[2]):0]);let n;for(n=0;n<t.length;n+=3)o[n+0]=Math.max(0,Math.min(65535,Math.floor((t[n+0]-i[0])*a[0]))),o[n+1]=Math.max(0,Math.min(65535,Math.floor((t[n+1]-i[1])*a[1]))),o[n+2]=Math.max(0,Math.min(65535,Math.floor((t[n+2]-i[2])*a[2])));A.identityMat4(r),A.translationMat4v(i,r),A.identityMat4(e),A.scalingMat4v([(s[0]-i[0])/65535,(s[1]-i[1])/65535,(s[2]-i[2])/65535],e);const l=A.mulMat4(r,e,A.identityMat4());return{quantized:o,decodeMatrix:l}}}();function A0(r,e,t){const i=new Float32Array([e[3]!==e[0]?65535/(e[3]-e[0]):0,e[4]!==e[1]?65535/(e[4]-e[1]):0,e[5]!==e[2]?65535/(e[5]-e[2]):0]);t[0]=Math.max(0,Math.min(65535,Math.floor((r[0]-e[0])*i[0]))),t[1]=Math.max(0,Math.min(65535,Math.floor((r[1]-e[1])*i[1]))),t[2]=Math.max(0,Math.min(65535,Math.floor((r[2]-e[2])*i[2])))}function c0(r,e,t){return t[0]=r[0]*e[0]+e[12],t[1]=r[1]*e[5]+e[13],t[2]=r[2]*e[10]+e[14],t}function h0(r,e,t=r){return t[0]=r[0]*e[0]+e[12],t[1]=r[1]*e[5]+e[13],t[2]=r[2]*e[10]+e[14],t[3]=r[3]*e[0]+e[12],t[4]=r[4]*e[5]+e[13],t[5]=r[5]*e[10]+e[14],t}function u0(r,e,t=new Float32Array(r.length)){for(let i=0,s=r.length;i<s;i+=3)t[i+0]=r[i+0]*e[0]+e[12],t[i+1]=r[i+1]*e[5]+e[13],t[i+2]=r[i+2]*e[10]+e[14];return t}function d0(r){const e=new Float32Array(2),t=new Float32Array(2);let i,s;for(i=0;i<2;i++)e[i]=Number.MAX_VALUE,t[i]=-Number.MAX_VALUE;for(i=0;i<r.length;i+=2)for(s=0;s<2;s++)e[s]=Math.min(e[s],r[i+s]),t[s]=Math.max(t[s],r[i+s]);return{min:e,max:t}}var p0=function(){const r=A.mat3(),e=A.mat3();return function(t,i,s){const o=new Uint16Array(t.length),a=new Float32Array([65535/(s[0]-i[0]),65535/(s[1]-i[1])]);let n;for(n=0;n<t.length;n+=2)o[n+0]=Math.max(0,Math.min(65535,Math.floor((t[n+0]-i[0])*a[0]))),o[n+1]=Math.max(0,Math.min(65535,Math.floor((t[n+1]-i[1])*a[1])));A.identityMat3(r),A.translationMat3v(i,r),A.identityMat3(e),A.scalingMat3v([(s[0]-i[0])/65535,(s[1]-i[1])/65535],e);const l=A.mulMat3(r,e,A.identityMat3());return{quantized:o,decodeMatrix:l}}}();function f0(r){const e=new Int8Array(r.length);let t,i,s,o,a;for(let n=0;n<r.length;n+=3)s=t=An(r,n,"floor","floor"),i=cn(t),o=a=hn(r,n,i),t=An(r,n,"ceil","floor"),i=cn(t),o=hn(r,n,i),o>a&&(s=t,a=o),t=An(r,n,"floor","ceil"),i=cn(t),o=hn(r,n,i),o>a&&(s=t,a=o),t=An(r,n,"ceil","ceil"),i=cn(t),o=hn(r,n,i),o>a&&(s=t,a=o),e[n]=s[0],e[n+1]=s[1];return e}function An(r,e,t,i){let s=r[e]/(Math.abs(r[e])+Math.abs(r[e+1])+Math.abs(r[e+2])),o=r[e+1]/(Math.abs(r[e])+Math.abs(r[e+1])+Math.abs(r[e+2]));if(r[e+2]<0){let a=(1-Math.abs(o))*(s>=0?1:-1),n=(1-Math.abs(s))*(o>=0?1:-1);s=a,o=n}return new Int8Array([Math[t](s*127.5+(s<0?-1:0)),Math[i](o*127.5+(o<0?-1:0))])}function cn(r){let e=r[0],t=r[1];e/=e<0?127:128,t/=t<0?127:128;const i=1-Math.abs(e)-Math.abs(t);i<0&&(e=(1-Math.abs(t))*(e>=0?1:-1),t=(1-Math.abs(e))*(t>=0?1:-1));const s=Math.sqrt(e*e+t*t+i*i);return[e/s,t/s,i/s]}function hn(r,e,t){return r[e]*t[0]+r[e+1]*t[1]+r[e+2]*t[2]}function m0(r,e,t){t[0]=r[0]*e[0]+e[6],t[1]=r[1]*e[4]+e[7]}function g0(r,e,t=new Float32Array(r.length)){for(let i=0,s=r.length;i<s;i+=3)t[i+0]=r[i+0]*e[0]+e[6],t[i+1]=r[i+1]*e[4]+e[7];return t}function _0(r,e){let t=r[0],i=r[1];t=(2*t+1)/255,i=(2*i+1)/255;const s=1-Math.abs(t)-Math.abs(i);s<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));const o=Math.sqrt(t*t+i*i+s*s);return e[0]=t/o,e[1]=i/o,e[2]=s/o,e}function v0(r,e){for(let t=0,i=0,s=r.length;t<s;t+=2){let o=r[t+0],a=r[t+1];o=(2*o+1)/255,a=(2*a+1)/255;const n=1-Math.abs(o)-Math.abs(a);n<0&&(o=(1-Math.abs(a))*(o>=0?1:-1),a=(1-Math.abs(o))*(a>=0?1:-1));const l=Math.sqrt(o*o+a*a+n*n);e[i+0]=o/l,e[i+1]=a/l,e[i+2]=n/l,i+=3}return e}const at={getPositionsBounds:n0,createPositionsDecodeMatrix:a0,compressPositions:l0,compressPosition:A0,decompressPositions:u0,decompressPosition:c0,decompressAABB:h0,getUVBounds:d0,compressUVs:p0,decompressUVs:g0,decompressUV:m0,compressNormals:f0,decompressNormals:v0,decompressNormal:_0},Li=_t.memory,_h=A.AABB3();class ti extends Pf{get type(){return"ReadableGeometry"}get isReadableGeometry(){return!0}constructor(e,t={}){super(e,t),this._state=new Mt({compressGeometry:!!t.compressGeometry,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=t.edgeThreshold||10,this._edgeIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._aabbDirty=!0,this._boundingSphere=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;const i=this._state,s=this.scene.canvas.gl;switch(t.primitive=t.primitive||"triangles",t.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=t.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=t.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=t.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=t.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=t.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=t.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=t.primitive;break;default:this.error("Unsupported value for 'primitive': '"+t.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=t.primitive}if(t.positions)if(this._state.compressGeometry){const o=at.getPositionsBounds(t.positions),a=at.compressPositions(t.positions,o.min,o.max);i.positions=a.quantized,i.positionsDecodeMatrix=a.decodeMatrix}else i.positions=t.positions.constructor===Float32Array?t.positions:new Float32Array(t.positions);if(t.colors&&(i.colors=t.colors.constructor===Float32Array?t.colors:new Float32Array(t.colors)),t.uv)if(this._state.compressGeometry){const o=at.getUVBounds(t.uv),a=at.compressUVs(t.uv,o.min,o.max);i.uv=a.quantized,i.uvDecodeMatrix=a.decodeMatrix}else i.uv=t.uv.constructor===Float32Array?t.uv:new Float32Array(t.uv);t.normals&&(this._state.compressGeometry?i.normals=at.compressNormals(t.normals):i.normals=t.normals.constructor===Float32Array?t.normals:new Float32Array(t.normals)),t.indices&&(i.indices=t.indices.constructor===Uint32Array||t.indices.constructor===Uint16Array?t.indices:new Uint32Array(t.indices),this._state.primitiveName==="triangles"&&(this._numTriangles=t.indices.length/3)),this._buildHash(),Li.meshes++,this._buildVBOs()}_buildVBOs(){const e=this._state,t=this.scene.canvas.gl;if(e.indices&&(e.indicesBuf=new Oe(t,t.ELEMENT_ARRAY_BUFFER,e.indices,e.indices.length,1,t.STATIC_DRAW),Li.indices+=e.indicesBuf.numItems),e.positions&&(e.positionsBuf=new Oe(t,t.ARRAY_BUFFER,e.positions,e.positions.length,3,t.STATIC_DRAW),Li.positions+=e.positionsBuf.numItems),e.normals){let i=e.compressGeometry;e.normalsBuf=new Oe(t,t.ARRAY_BUFFER,e.normals,e.normals.length,3,t.STATIC_DRAW,i),Li.normals+=e.normalsBuf.numItems}e.colors&&(e.colorsBuf=new Oe(t,t.ARRAY_BUFFER,e.colors,e.colors.length,4,t.STATIC_DRAW),Li.colors+=e.colorsBuf.numItems),e.uv&&(e.uvBuf=new Oe(t,t.ARRAY_BUFFER,e.uv,e.uv.length,2,t.STATIC_DRAW),Li.uvs+=e.uvBuf.numItems)}_buildHash(){const e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positions&&t.push("p"),e.colors&&t.push("c"),(e.normals||e.autoVertexNormals)&&t.push("n"),e.uv&&t.push("u"),e.compressGeometry&&t.push("cp"),t.push(";"),e.hash=t.join("")}_getEdgeIndices(){return this._edgeIndicesBuf||this._buildEdgeIndices(),this._edgeIndicesBuf}_getPickTrianglePositions(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf}_getPickTriangleColors(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf}_buildEdgeIndices(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,i=ps(e.positions,e.indices,e.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new Oe(t,t.ELEMENT_ARRAY_BUFFER,i,i.length,1,t.STATIC_DRAW),Li.indices+=this._edgeIndicesBuf.numItems}_buildPickTriangleVBOs(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,i=A.buildPickTriangles(e.positions,e.indices,e.compressGeometry),s=i.positions,o=i.colors;this._pickTrianglePositionsBuf=new Oe(t,t.ARRAY_BUFFER,s,s.length,3,t.STATIC_DRAW),this._pickTriangleColorsBuf=new Oe(t,t.ARRAY_BUFFER,o,o.length,4,t.STATIC_DRAW,!0),Li.positions+=this._pickTrianglePositionsBuf.numItems,Li.colors+=this._pickTriangleColorsBuf.numItems}_buildPickVertexVBOs(){}_webglContextLost(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()}_webglContextRestored(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgeIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null}get primitive(){return this._state.primitiveName}get compressGeometry(){return this._state.compressGeometry}get positions(){return this._state.positions?this._state.compressGeometry?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),at.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions:null}set positions(e){const t=this._state,i=t.positions;if(!i){this.error("can't update geometry positions - geometry has no positions");return}if(i.length!==e.length){this.error("can't update geometry positions - new positions are wrong length");return}if(this._state.compressGeometry){const s=at.getPositionsBounds(e),o=at.compressPositions(e,s.min,s.max);e=o.quantized,t.positionsDecodeMatrix=o.decodeMatrix}i.set(e),t.positionsBuf&&t.positionsBuf.setData(i),this._setAABBDirty(),this.glRedraw()}get normals(){if(this._state.normals){if(!this._state.compressGeometry)return this._state.normals;if(!this._decompressedNormals){const e=this._state.normals.length,t=e+e/2;this._decompressedNormals=new Float32Array(t),at.decompressNormals(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}}set normals(e){if(this._state.compressGeometry){this.error("can't update geometry normals - quantized geometry is immutable");return}const t=this._state,i=t.normals;if(!i){this.error("can't update geometry normals - geometry has no normals");return}if(i.length!==e.length){this.error("can't update geometry normals - new normals are wrong length");return}i.set(e),t.normalsBuf&&t.normalsBuf.setData(i),this.glRedraw()}get uv(){return this._state.uv?this._state.compressGeometry?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),at.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv:null}set uv(e){if(this._state.compressGeometry){this.error("can't update geometry UVs - quantized geometry is immutable");return}const t=this._state,i=t.uv;if(!i){this.error("can't update geometry UVs - geometry has no UVs");return}if(i.length!==e.length){this.error("can't update geometry UVs - new UVs are wrong length");return}i.set(e),t.uvBuf&&t.uvBuf.setData(i),this.glRedraw()}get colors(){return this._state.colors}set colors(e){if(this._state.compressGeometry){this.error("can't update geometry colors - quantized geometry is immutable");return}const t=this._state,i=t.colors;if(!i){this.error("can't update geometry colors - geometry has no colors");return}if(i.length!==e.length){this.error("can't update geometry colors - new colors are wrong length");return}i.set(e),t.colorsBuf&&t.colorsBuf.setData(i),this.glRedraw()}get indices(){return this._state.indices}get aabb(){return this._aabbDirty&&(this._aabb||(this._aabb=A.AABB3()),A.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}get obb(){return this._obbDirty&&(this._obb||(this._obb=A.OBB3()),A.positions3ToAABB3(this._state.positions,_h,this._state.positionsDecodeMatrix),A.AABB3ToOBB3(_h,this._obb),this._obbDirty=!1),this._obb}get numTriangles(){return this._numTriangles}_setAABBDirty(){this._aabbDirty||(this._aabbDirty=!0,this._aabbDirty=!0,this._obbDirty=!0)}_getState(){return this._state}destroy(){super.destroy();const e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),e.destroy(),Li.meshes--}}function xf(r={}){let e=r.xSize||1;e<0&&(console.error("negative xSize not allowed - will invert"),e*=-1);let t=r.ySize||1;t<0&&(console.error("negative ySize not allowed - will invert"),t*=-1);let i=r.zSize||1;i<0&&(console.error("negative zSize not allowed - will invert"),i*=-1);const s=r.center,o=s?s[0]:0,a=s?s[1]:0,n=s?s[2]:0,l=-e+o,c=-t+a,h=-i+n,d=e+o,p=t+a,m=i+n;return we.apply(r,{positions:[d,p,m,l,p,m,l,c,m,d,c,m,d,p,m,d,c,m,d,c,h,d,p,h,d,p,m,d,p,h,l,p,h,l,p,m,l,p,m,l,p,h,l,c,h,l,c,m,l,c,h,d,c,h,d,c,m,l,c,m,d,c,h,l,c,h,l,p,h,d,p,h],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}class Lo extends vt{get type(){return"Material"}constructor(e,t={}){super(e,t),_t.memory.materials++}destroy(){super.destroy(),_t.memory.materials--}}const P0={opaque:0,mask:1,blend:2},x0=["opaque","mask","blend"];class gi extends Lo{get type(){return"PhongMaterial"}constructor(e,t={}){super(e,t),this._state=new Mt({type:"PhongMaterial",ambient:A.vec3([1,1,1]),diffuse:A.vec3([1,1,1]),specular:A.vec3([1,1,1]),emissive:A.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=t.ambient,this.diffuse=t.diffuse,this.specular=t.specular,this.emissive=t.emissive,this.alpha=t.alpha,this.shininess=t.shininess,this.reflectivity=t.reflectivity,this.lineWidth=t.lineWidth,this.pointSize=t.pointSize,t.ambientMap&&(this._ambientMap=this._checkComponent("Texture",t.ambientMap)),t.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",t.diffuseMap)),t.specularMap&&(this._specularMap=this._checkComponent("Texture",t.specularMap)),t.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",t.emissiveMap)),t.alphaMap&&(this._alphaMap=this._checkComponent("Texture",t.alphaMap)),t.reflectivityMap&&(this._reflectivityMap=this._checkComponent("Texture",t.reflectivityMap)),t.normalMap&&(this._normalMap=this._checkComponent("Texture",t.normalMap)),t.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",t.occlusionMap)),t.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("Fresnel",t.diffuseFresnel)),t.specularFresnel&&(this._specularFresnel=this._checkComponent("Fresnel",t.specularFresnel)),t.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("Fresnel",t.emissiveFresnel)),t.alphaFresnel&&(this._alphaFresnel=this._checkComponent("Fresnel",t.alphaFresnel)),t.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("Fresnel",t.reflectivityFresnel)),this.alphaMode=t.alphaMode,this.alphaCutoff=t.alphaCutoff,this.backfaces=t.backfaces,this.frontface=t.frontface,this._makeHash()}_makeHash(){const e=this._state,t=["/p"];this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._ambientMap&&(t.push("/am"),this._ambientMap.hasMatrix&&t.push("/mat"),t.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat"),t.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),this._reflectivityMap&&(t.push("/rm"),this._reflectivityMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._diffuseFresnel&&t.push("/df"),this._specularFresnel&&t.push("/sf"),this._emissiveFresnel&&t.push("/ef"),this._alphaFresnel&&t.push("/of"),this._reflectivityFresnel&&t.push("/rf"),t.push(";"),e.hash=t.join("")}set ambient(e){let t=this._state.ambient;if(!t)t=this._state.ambient=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get ambient(){return this._state.ambient}set diffuse(e){let t=this._state.diffuse;if(!t)t=this._state.diffuse=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get diffuse(){return this._state.diffuse}set specular(e){let t=this._state.specular;if(!t)t=this._state.specular=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get specular(){return this._state.specular}set emissive(e){let t=this._state.emissive;if(!t)t=this._state.emissive=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}set alpha(e){e=e??1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}get alpha(){return this._state.alpha}set shininess(e){this._state.shininess=e!==void 0?e:80,this.glRedraw()}get shininess(){return this._state.shininess}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this.glRedraw()}get pointSize(){return this._state.pointSize}set reflectivity(e){this._state.reflectivity=e!==void 0?e:1,this.glRedraw()}get reflectivity(){return this._state.reflectivity}get normalMap(){return this._normalMap}get ambientMap(){return this._ambientMap}get diffuseMap(){return this._diffuseMap}get specularMap(){return this._specularMap}get emissiveMap(){return this._emissiveMap}get alphaMap(){return this._alphaMap}get reflectivityMap(){return this._reflectivityMap}get occlusionMap(){return this._occlusionMap}get diffuseFresnel(){return this._diffuseFresnel}get specularFresnel(){return this._specularFresnel}get emissiveFresnel(){return this._emissiveFresnel}get alphaFresnel(){return this._alphaFresnel}get reflectivityFresnel(){return this._reflectivityFresnel}set alphaMode(e){e=e||"opaque";let t=P0[e];t===void 0&&(this.error("Unsupported value for 'alphaMode': "+e+" - defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw())}get alphaMode(){return x0[this._state.alphaMode]}set alphaCutoff(e){e==null&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(e){e=e!=="cw",this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}destroy(){super.destroy(),this._state.destroy()}}const hl={default:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}};class _i extends Lo{get type(){return"EmphasisMaterial"}get presets(){return hl}constructor(e,t={}){super(e,t),this._state=new Mt({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0,glowThrough:!0}),this._preset="default",t.preset?(this.preset=t.preset,t.fill!==void 0&&(this.fill=t.fill),t.fillColor&&(this.fillColor=t.fillColor),t.fillAlpha!==void 0&&(this.fillAlpha=t.fillAlpha),t.edges!==void 0&&(this.edges=t.edges),t.edgeColor&&(this.edgeColor=t.edgeColor),t.edgeAlpha!==void 0&&(this.edgeAlpha=t.edgeAlpha),t.edgeWidth!==void 0&&(this.edgeWidth=t.edgeWidth),t.backfaces!==void 0&&(this.backfaces=t.backfaces),t.glowThrough!==void 0&&(this.glowThrough=t.glowThrough)):(this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.backfaces=t.backfaces,this.glowThrough=t.glowThrough)}set fill(e){e=e!==!1,this._state.fill!==e&&(this._state.fill=e,this.glRedraw())}get fill(){return this._state.fill}set fillColor(e){let t=this._state.fillColor;if(!t)t=this._state.fillColor=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.4,t[1]=.4,t[2]=.4),this.glRedraw()}get fillColor(){return this._state.fillColor}set fillAlpha(e){e=e??.2,this._state.fillAlpha!==e&&(this._state.fillAlpha=e,this.glRedraw())}get fillAlpha(){return this._state.fillAlpha}set edges(e){e=e!==!1,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(e){let t=this._state.edgeColor;if(!t)t=this._state.edgeColor=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=e??.5,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set glowThrough(e){e=e!==!1,this._state.glowThrough!==e&&(this._state.glowThrough=e,this.glRedraw())}get glowThrough(){return this._state.glowThrough}set preset(e){if(e=e||"default",this._preset===e)return;const t=hl[e];if(!t){this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(hl).join(", "));return}this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.glowThrough=t.glowThrough,this._preset=e}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const ul={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}};class yf extends Lo{get type(){return"EdgeMaterial"}get presets(){return ul}constructor(e,t={}){super(e,t),this._state=new Mt({type:"EdgeMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",t.preset?(this.preset=t.preset,t.edgeColor&&(this.edgeColor=t.edgeColor),t.edgeAlpha!==void 0&&(this.edgeAlpha=t.edgeAlpha),t.edgeWidth!==void 0&&(this.edgeWidth=t.edgeWidth)):(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth),this.edges=t.edges!==!1}set edges(e){e=e!==!1,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(e){let t=this._state.edgeColor;if(!t)t=this._state.edgeColor=new Float32Array(3);else if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=e??1,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set preset(e){if(e=e||"default",this._preset===e)return;const t=ul[e];if(!t){this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(ul).join(", "));return}this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this._preset=e}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const vh={meters:{abbrev:"m"},metres:{abbrev:"m"},centimeters:{abbrev:"cm"},centimetres:{abbrev:"cm"},millimeters:{abbrev:"mm"},millimetres:{abbrev:"mm"},yards:{abbrev:"yd"},feet:{abbrev:"ft"},inches:{abbrev:"in"}};class y0 extends vt{constructor(e,t={}){super(e,t),this._units="meters",this._scale=1,this._origin=A.vec3([0,0,0]),this.units=t.units,this.scale=t.scale,this.origin=t.origin}get unitsInfo(){return vh}set units(e){e||(e="meters"),vh[e]||(this.error("Unsupported value for 'units': "+e+" defaulting to 'meters'"),e="meters"),this._units=e,this.fire("units",this._units)}get units(){return this._units}set scale(e){if(e=e||1,e<=0){this.error("scale value should be larger than zero");return}this._scale=e,this.fire("scale",this._scale)}get scale(){return this._scale}set origin(e){if(!e){this._origin[0]=0,this._origin[1]=0,this._origin[2]=0;return}this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this.fire("origin",this._origin)}get origin(){return this._origin}worldToRealPos(e,t=A.vec3(3)){t[0]=this._origin[0]+this._scale*e[0],t[1]=this._origin[1]+this._scale*e[1],t[2]=this._origin[2]+this._scale*e[2]}realToWorldPos(e,t=A.vec3(3)){return t[0]=(e[0]-this._origin[0])/this._scale,t[1]=(e[1]-this._origin[1])/this._scale,t[2]=(e[2]-this._origin[2])/this._scale,t}}class b0 extends vt{constructor(e,t={}){super(e,t),this._supported=yt.SUPPORTED_EXTENSIONS.OES_standard_derivatives,this.enabled=t.enabled,this.kernelRadius=t.kernelRadius,this.intensity=t.intensity,this.bias=t.bias,this.scale=t.scale,this.minResolution=t.minResolution,this.numSamples=t.numSamples,this.blur=t.blur,this.blendCutoff=t.blendCutoff,this.blendFactor=t.blendFactor}get supported(){return this._supported}set enabled(e){e=!!e,this._enabled!==e&&(this._enabled=e,this.glRedraw())}get enabled(){return this._enabled}get possible(){if(!this._supported||!this._enabled)return!1;const e=this.scene.camera.projection;return!(e==="customProjection"||e==="frustum")}get active(){return this._active}set kernelRadius(e){e==null&&(e=100),this._kernelRadius!==e&&(this._kernelRadius=e,this.glRedraw())}get kernelRadius(){return this._kernelRadius}set intensity(e){e==null&&(e=.15),this._intensity!==e&&(this._intensity=e,this.glRedraw())}get intensity(){return this._intensity}set bias(e){e==null&&(e=.5),this._bias!==e&&(this._bias=e,this.glRedraw())}get bias(){return this._bias}set scale(e){e==null&&(e=1),this._scale!==e&&(this._scale=e,this.glRedraw())}get scale(){return this._scale}set minResolution(e){e==null&&(e=0),this._minResolution!==e&&(this._minResolution=e,this.glRedraw())}get minResolution(){return this._minResolution}set numSamples(e){e==null&&(e=10),this._numSamples!==e&&(this._numSamples=e,this.glRedraw())}get numSamples(){return this._numSamples}set blur(e){e=e!==!1,this._blur!==e&&(this._blur=e,this.glRedraw())}get blur(){return this._blur}set blendCutoff(e){e==null&&(e=.3),this._blendCutoff!==e&&(this._blendCutoff=e,this.glRedraw())}get blendCutoff(){return this._blendCutoff}set blendFactor(e){e==null&&(e=1),this._blendFactor!==e&&(this._blendFactor=e,this.glRedraw())}get blendFactor(){return this._blendFactor}destroy(){super.destroy()}}class B0 extends vt{constructor(e,t={}){super(e,t),this.sliceColor=t.sliceColor,this.sliceThickness=t.sliceThickness}set sliceThickness(e){e==null&&(e=0),this._sliceThickness!==e&&(this._sliceThickness=e,this.glRedraw())}get sliceThickness(){return this._sliceThickness}set sliceColor(e){e==null&&(e=[0,0,0,1]),this._sliceColor!==e&&(this._sliceColor=e,this.glRedraw())}get sliceColor(){return this._sliceColor}destroy(){super.destroy()}}const dl={default:{pointSize:4,roundPoints:!0,perspectivePoints:!0},square:{pointSize:4,roundPoints:!1,perspectivePoints:!0},round:{pointSize:4,roundPoints:!0,perspectivePoints:!0}};class w0 extends Lo{get type(){return"PointsMaterial"}get presets(){return dl}constructor(e,t={}){super(e,t),this._state=new Mt({type:"PointsMaterial",pointSize:null,roundPoints:null,perspectivePoints:null,minPerspectivePointSize:null,maxPerspectivePointSize:null,filterIntensity:null,minIntensity:null,maxIntensity:null}),t.preset?(this.preset=t.preset,t.pointSize!==void 0&&(this.pointSize=t.pointSize),t.roundPoints!==void 0&&(this.roundPoints=t.roundPoints),t.perspectivePoints!==void 0&&(this.perspectivePoints=t.perspectivePoints),t.minPerspectivePointSize!==void 0&&(this.minPerspectivePointSize=t.minPerspectivePointSize),t.maxPerspectivePointSize!==void 0&&(this.maxPerspectivePointSize=t.minPerspectivePointSize)):(this._preset="default",this.pointSize=t.pointSize,this.roundPoints=t.roundPoints,this.perspectivePoints=t.perspectivePoints,this.minPerspectivePointSize=t.minPerspectivePointSize,this.maxPerspectivePointSize=t.maxPerspectivePointSize),this.filterIntensity=t.filterIntensity,this.minIntensity=t.minIntensity,this.maxIntensity=t.maxIntensity}set pointSize(e){this._state.pointSize=e||2,this.glRedraw()}get pointSize(){return this._state.pointSize}set roundPoints(e){e=e!==!1,this._state.roundPoints!==e&&(this._state.roundPoints=e,this.scene._needRecompile=!0,this.glRedraw())}get roundPoints(){return this._state.roundPoints}set perspectivePoints(e){e=e!==!1,this._state.perspectivePoints!==e&&(this._state.perspectivePoints=e,this.scene._needRecompile=!0,this.glRedraw())}get perspectivePoints(){return this._state.perspectivePoints}set minPerspectivePointSize(e){this._state.minPerspectivePointSize=e||1,this.scene._needRecompile=!0,this.glRedraw()}get minPerspectivePointSize(){return this._state.minPerspectivePointSize}set maxPerspectivePointSize(e){this._state.maxPerspectivePointSize=e||6,this.scene._needRecompile=!0,this.glRedraw()}get maxPerspectivePointSize(){return this._state.maxPerspectivePointSize}set filterIntensity(e){e=e!==!1,this._state.filterIntensity!==e&&(this._state.filterIntensity=e,this.scene._needRecompile=!0,this.glRedraw())}get filterIntensity(){return this._state.filterIntensity}set minIntensity(e){this._state.minIntensity=e??0,this.glRedraw()}get minIntensity(){return this._state.minIntensity}set maxIntensity(e){this._state.maxIntensity=e??1,this.glRedraw()}get maxIntensity(){return this._state.maxIntensity}set preset(e){if(e=e||"default",this._preset===e)return;const t=dl[e];if(!t){this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(dl).join(", "));return}this.pointSize=t.pointSize,this.roundPoints=t.roundPoints,this.perspectivePoints=t.perspectivePoints,this.minPerspectivePointSize=t.minPerspectivePointSize,this.maxPerspectivePointSize=t.maxPerspectivePointSize,this._preset=e}get preset(){return this._preset}get hash(){return[this.pointSize,this.roundPoints,this.perspectivePoints,this.minPerspectivePointSize,this.maxPerspectivePointSize,this.filterIntensity].join(";")}destroy(){super.destroy(),this._state.destroy()}}const pl={default:{lineWidth:1},thick:{lineWidth:2},thicker:{lineWidth:4}};class C0 extends Lo{get type(){return"LinesMaterial"}get presets(){return pl}constructor(e,t={}){super(e,t),this._state=new Mt({type:"LinesMaterial",lineWidth:null}),t.preset?(this.preset=t.preset,t.lineWidth!==void 0&&(this.lineWidth=t.lineWidth)):(this._preset="default",this.lineWidth=t.lineWidth)}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set preset(e){if(e=e||"default",this._preset===e)return;const t=pl[e];if(!t){this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(pl).join(", "));return}this.lineWidth=t.lineWidth,this._preset=e}get preset(){return this._preset}get hash(){return[""+this.lineWidth].join(";")}destroy(){super.destroy(),this._state.destroy()}}function Ph(r,e){const t={};let i,s;for(let o=0,a=e.length;o<a;o++){if(i=e[o],s=r.components[i],!s){r.warn("pick(): Component not found: "+i);continue}if(!s.isEntity){r.warn("pick(): Component is not an Entity: "+i);continue}t[i]=!0}return t}class lc extends vt{get type(){return"Scene"}constructor(e,t={}){super(null,t);const i=t.canvasElement||document.getElementById(t.canvasId);if(!(i instanceof HTMLCanvasElement))throw"Mandatory config expected: valid canvasId or canvasElement";this._tickifiedFunctions={};const s=!!t.transparent,o=!!t.alphaDepthMask;this._aabbDirty=!0,this._readableGeometry=!!t.readableGeometryEnabled,this.viewer=e,this.occlusionTestCountdown=0,this.loading=0,this.startTime=new Date().getTime(),this.models={},this.objects={},this._numObjects=0,this.visibleObjects={},this._numVisibleObjects=0,this.xrayedObjects={},this._numXRayedObjects=0,this.highlightedObjects={},this._numHighlightedObjects=0,this.selectedObjects={},this._numSelectedObjects=0,this.colorizedObjects={},this._numColorizedObjects=0,this.opacityObjects={},this._numOpacityObjects=0,this.offsetObjects={},this._numOffsetObjects=0,this._modelIds=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this._opacityObjectIds=null,this._offsetObjectIds=null,this._collidables={},this._compilables={},this._needRecompile=!1,this.types={},this.components={},this.sectionPlanes={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.bitmaps={},this.lineSets={},this.realWorldOffset=t.realWorldOffset||new Float64Array([0,0,0]),this.canvas=new T_(this,{dontClear:!0,canvas:i,spinnerElementId:t.spinnerElementId,transparent:s,webgl2:t.webgl2!==!1,contextAttr:t.contextAttr||{},backgroundColor:t.backgroundColor,backgroundColorFromAmbientLight:t.backgroundColorFromAmbientLight,premultipliedAlpha:t.premultipliedAlpha}),this.canvas.on("boundary",()=>{this.glRedraw()}),this.canvas.on("webglContextFailed",()=>{alert("xeokit failed to find WebGL!")}),this._renderer=new X_(this,{transparent:s,alphaDepthMask:o}),this._sectionPlanesState=new function(){this.sectionPlanes=[],this.clippingCaps=!1,this._numCachedSectionPlanes=0;let a=null;this.getHash=function(){if(a)return a;const n=this.getNumAllocatedSectionPlanes();if(this.sectionPlanes,n===0)return this.hash=";";const l=[];for(let c=0,h=n;c<h;c++)l.push("cp");return l.push(";"),a=l.join(""),a},this.addSectionPlane=function(n){this.sectionPlanes.push(n),a=null},this.removeSectionPlane=function(n){for(let l=0,c=this.sectionPlanes.length;l<c;l++)if(this.sectionPlanes[l].id===n.id){this.sectionPlanes.splice(l,1),a=null;return}},this.setNumCachedSectionPlanes=function(n){this._numCachedSectionPlanes=n,a=null},this.getNumCachedSectionPlanes=function(){return this._numCachedSectionPlanes},this.getNumAllocatedSectionPlanes=function(){const n=this.sectionPlanes.length;return n>this._numCachedSectionPlanes?n:this._numCachedSectionPlanes}},this._sectionPlanesState.setNumCachedSectionPlanes(t.numCachedSectionPlanes||0),this._lightsState=new function(){const a=A.vec4([0,0,0,0]),n=A.vec4();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];let l=null,c=null;this.getHash=function(){if(l)return l;const h=[],d=this.lights;let p;for(let m=0,g=d.length;m<g;m++)p=d[m],h.push("/"),h.push(p.type),h.push(p.space==="world"?"w":"v"),p.castsShadow&&h.push("sh");return this.lightMaps.length>0&&h.push("/lm"),this.reflectionMaps.length>0&&h.push("/rm"),h.push(";"),l=h.join(""),l},this.addLight=function(h){this.lights.push(h),c=null,l=null},this.removeLight=function(h){for(let d=0,p=this.lights.length;d<p;d++)if(this.lights[d].id===h.id){this.lights.splice(d,1),c&&c.id===h.id&&(c=null),l=null;return}},this.addReflectionMap=function(h){this.reflectionMaps.push(h),l=null},this.removeReflectionMap=function(h){for(let d=0,p=this.reflectionMaps.length;d<p;d++)if(this.reflectionMaps[d].id===h.id){this.reflectionMaps.splice(d,1),l=null;return}},this.addLightMap=function(h){this.lightMaps.push(h),l=null},this.removeLightMap=function(h){for(let d=0,p=this.lightMaps.length;d<p;d++)if(this.lightMaps[d].id===h.id){this.lightMaps.splice(d,1),l=null;return}},this.getAmbientColorAndIntensity=function(){if(!c)for(let h=0,d=this.lights.length;h<d;h++){const p=this.lights[h];if(p.type==="ambient"){c=p;break}}if(c){const h=c.color,d=c.intensity;return n[0]=h[0],n[1]=h[1],n[2]=h[2],n[3]=d,n}else return a}},this.input=new Y_(this,{dontClear:!0,element:this.canvas.canvas,keyboardEventsElement:t.keyboardEventsElement}),this.metrics=new y0(this,{units:t.units,scale:t.scale,origin:t.origin}),this.sao=new b0(this,{enabled:t.saoEnabled}),this.crossSections=new B0(this,{}),this.ticksPerRender=t.ticksPerRender,this.ticksPerOcclusionTest=t.ticksPerOcclusionTest,this.passes=t.passes,this.clearEachPass=t.clearEachPass,this.gammaInput=t.gammaInput,this.gammaOutput=t.gammaOutput,this.gammaFactor=t.gammaFactor,this._entityOffsetsEnabled=!!t.entityOffsetsEnabled,this._logarithmicDepthBufferEnabled=!!t.logarithmicDepthBufferEnabled,this._dtxEnabled=t.dtxEnabled!==!1,this._pbrEnabled=!!t.pbrEnabled,this._colorTextureEnabled=t.colorTextureEnabled!==!1,this._dtxEnabled=!!t.dtxEnabled,this._markerZOffset=t.markerZOffset,It._addScene(this),this._initDefaults(),this._viewport=new $_(this,{id:"default.viewport",autoBoundary:!0,dontClear:!0}),this._camera=new r0(this,{id:"default.camera",dontClear:!0}),new o0(this,{color:[1,1,1],intensity:.7}),new bs(this,{dir:[.8,-.5,-.5],color:[.67,.67,1],intensity:.7,space:"world"}),new bs(this,{dir:[-.8,-1,.5],color:[1,1,.9],intensity:.9,space:"world"}),this._camera.on("dirty",()=>{this._renderer.imageDirty()})}_initDefaults(){}_addComponent(e){if(e.id&&this.components[e.id]&&(this.error("Component "+we.inQuotes(e.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),e.id=null),!e.id)for(window.nextID===void 0&&(window.nextID=0),e.id="__"+window.nextID++;this.components[e.id];)e.id=A.createUUID();this.components[e.id]=e;const t=e.type;let i=this.types[e.type];i||(i=this.types[t]={}),i[e.id]=e,e.compile&&(this._compilables[e.id]=e),e.isDrawable&&(this._renderer.addDrawable(e.id,e),this._collidables[e.id]=e)}_removeComponent(e){var t=e.id,i=e.type;delete this.components[t];const s=this.types[i];s&&(delete s[t],we.isEmptyObject(s)&&delete this.types[i]),e.compile&&delete this._compilables[e.id],e.isDrawable&&(this._renderer.removeDrawable(e.id),delete this._collidables[e.id])}_sectionPlaneCreated(e){this.sectionPlanes[e.id]=e,this.scene._sectionPlanesState.addSectionPlane(e._state),this.scene.fire("sectionPlaneCreated",e,!0),this._needRecompile=!0}_bitmapCreated(e){this.bitmaps[e.id]=e,this.scene.fire("bitmapCreated",e,!0)}_lineSetCreated(e){this.lineSets[e.id]=e,this.scene.fire("lineSetCreated",e,!0)}_lightCreated(e){this.lights[e.id]=e,this.scene._lightsState.addLight(e._state),this._needRecompile=!0}_lightMapCreated(e){this.lightMaps[e.id]=e,this.scene._lightsState.addLightMap(e._state),this._needRecompile=!0}_reflectionMapCreated(e){this.reflectionMaps[e.id]=e,this.scene._lightsState.addReflectionMap(e._state),this._needRecompile=!0}_sectionPlaneDestroyed(e){delete this.sectionPlanes[e.id],this.scene._sectionPlanesState.removeSectionPlane(e._state),this.scene.fire("sectionPlaneDestroyed",e,!0),this._needRecompile=!0}_bitmapDestroyed(e){delete this.bitmaps[e.id],this.scene.fire("bitmapDestroyed",e,!0)}_lineSetDestroyed(e){delete this.lineSets[e.id],this.scene.fire("lineSetDestroyed",e,!0)}_lightDestroyed(e){delete this.lights[e.id],this.scene._lightsState.removeLight(e._state),this._needRecompile=!0}_lightMapDestroyed(e){delete this.lightMaps[e.id],this.scene._lightsState.removeLightMap(e._state),this._needRecompile=!0}_reflectionMapDestroyed(e){delete this.reflectionMaps[e.id],this.scene._lightsState.removeReflectionMap(e._state),this._needRecompile=!0}_registerModel(e){this.models[e.id]=e,this._modelIds=null}_deregisterModel(e){const t=e.id;delete this.models[t],this._modelIds=null,this.fire("modelUnloaded",t)}_registerObject(e){this.objects[e.id]=e,this._numObjects++,this._objectIds=null}_deregisterObject(e){delete this.objects[e.id],this._numObjects--,this._objectIds=null}_objectVisibilityUpdated(e,t=!0){e.visible?(this.visibleObjects[e.id]=e,this._numVisibleObjects++):(delete this.visibleObjects[e.id],this._numVisibleObjects--),this._visibleObjectIds=null,t&&this.fire("objectVisibility",e,!0)}_deRegisterVisibleObject(e){delete this.visibleObjects[e.id],this._numVisibleObjects--,this._visibleObjectIds=null}_objectXRayedUpdated(e,t=!0){e.xrayed?(this.xrayedObjects[e.id]=e,this._numXRayedObjects++):(delete this.xrayedObjects[e.id],this._numXRayedObjects--),this._xrayedObjectIds=null,t&&this.fire("objectXRayed",e,!0)}_deRegisterXRayedObject(e){delete this.xrayedObjects[e.id],this._numXRayedObjects--,this._xrayedObjectIds=null}_objectHighlightedUpdated(e){e.highlighted?(this.highlightedObjects[e.id]=e,this._numHighlightedObjects++):(delete this.highlightedObjects[e.id],this._numHighlightedObjects--),this._highlightedObjectIds=null}_deRegisterHighlightedObject(e){delete this.highlightedObjects[e.id],this._numHighlightedObjects--,this._highlightedObjectIds=null}_objectSelectedUpdated(e,t=!0){e.selected?(this.selectedObjects[e.id]=e,this._numSelectedObjects++):(delete this.selectedObjects[e.id],this._numSelectedObjects--),this._selectedObjectIds=null,t&&this.fire("objectSelected",e,!0)}_deRegisterSelectedObject(e){delete this.selectedObjects[e.id],this._numSelectedObjects--,this._selectedObjectIds=null}_objectColorizeUpdated(e,t){t?(this.colorizedObjects[e.id]=e,this._numColorizedObjects++):(delete this.colorizedObjects[e.id],this._numColorizedObjects--),this._colorizedObjectIds=null}_deRegisterColorizedObject(e){delete this.colorizedObjects[e.id],this._numColorizedObjects--,this._colorizedObjectIds=null}_objectOpacityUpdated(e,t){t?(this.opacityObjects[e.id]=e,this._numOpacityObjects++):(delete this.opacityObjects[e.id],this._numOpacityObjects--),this._opacityObjectIds=null}_deRegisterOpacityObject(e){delete this.opacityObjects[e.id],this._numOpacityObjects--,this._opacityObjectIds=null}_objectOffsetUpdated(e,t){!t||t[0]===0&&t[1]===0&&t[2]===0?(this.offsetObjects[e.id]=e,this._numOffsetObjects++):(delete this.offsetObjects[e.id],this._numOffsetObjects--),this._offsetObjectIds=null}_deRegisterOffsetObject(e){delete this.offsetObjects[e.id],this._numOffsetObjects--,this._offsetObjectIds=null}_webglContextLost(){this.canvas.spinner.processes++;for(const e in this.components)if(this.components.hasOwnProperty(e)){const t=this.components[e];t._webglContextLost&&t._webglContextLost()}this._renderer.webglContextLost()}_webglContextRestored(){const e=this.canvas.gl;for(const t in this.components)if(this.components.hasOwnProperty(t)){const i=this.components[t];i._webglContextRestored&&i._webglContextRestored(e)}this._renderer.webglContextRestored(e),this.canvas.spinner.processes--}get capabilities(){return this._renderer.capabilities}get entityOffsetsEnabled(){return this._entityOffsetsEnabled}get readableGeometryEnabled(){return this._readableGeometry}get pickSurfacePrecisionEnabled(){return this._readableGeometry}get logarithmicDepthBufferEnabled(){return this._logarithmicDepthBufferEnabled}set numCachedSectionPlanes(e){e=e||0,this._sectionPlanesState.getNumCachedSectionPlanes()!==e&&(this._sectionPlanesState.setNumCachedSectionPlanes(e),this._needRecompile=!0,this.glRedraw())}get numCachedSectionPlanes(){return this._sectionPlanesState.getNumCachedSectionPlanes()}set pbrEnabled(e){this._pbrEnabled=!!e,this.glRedraw()}get pbrEnabled(){return this._pbrEnabled}set dtxEnabled(e){e=!!e,this._dtxEnabled!==e&&(this._dtxEnabled=e)}get dtxEnabled(){return this._dtxEnabled}set colorTextureEnabled(e){this._colorTextureEnabled=!!e,this.glRedraw()}get colorTextureEnabled(){return this._colorTextureEnabled}get markerZOffset(){return this._markerZOffset==null?-.001:this._markerZOffset}doOcclusionTest(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest()}render(e){e&&It.runTasks();const t={sceneId:null,pass:0};if(this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),!e&&!this._renderer.needsRender())return;t.sceneId=this.id;const i=this._passes,s=this._clearEachPass;let o,a;for(o=0;o<i;o++)t.pass=o,this.fire("rendering",t,!0),a=s||o===0,this._renderer.render({pass:o,clear:a,force:e}),this.fire("rendered",t,!0);this._saveAmbientColor()}compile(){this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1)}_recompile(){for(const e in this._compilables)this._compilables.hasOwnProperty(e)&&this._compilables[e].compile();this._renderer.shadowsDirty(),this.fire("compile",this,!0)}_saveAmbientColor(){const e=this.canvas;if(!e.transparent&&!e.backgroundImage&&!e.backgroundColor){const t=this._lightsState.getAmbientColorAndIntensity();(!this._lastAmbientColor||this._lastAmbientColor[0]!==t[0]||this._lastAmbientColor[1]!==t[1]||this._lastAmbientColor[2]!==t[2]||this._lastAmbientColor[3]!==t[3])&&(e.backgroundColor=t,this._lastAmbientColor||(this._lastAmbientColor=A.vec4([0,0,0,1])),this._lastAmbientColor.set(t))}else this._lastAmbientColor=null}get modelIds(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds}get numObjects(){return this._numObjects}get objectIds(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds}get numVisibleObjects(){return this._numVisibleObjects}get visibleObjectIds(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds}get numXRayedObjects(){return this._numXRayedObjects}get xrayedObjectIds(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds}get numHighlightedObjects(){return this._numHighlightedObjects}get highlightedObjectIds(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds}get numSelectedObjects(){return this._numSelectedObjects}get selectedObjectIds(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds}get numColorizedObjects(){return this._numColorizedObjects}get colorizedObjectIds(){return this._colorizedObjectIds||(this._colorizedObjectIds=Object.keys(this.colorizedObjects)),this._colorizedObjectIds}get opacityObjectIds(){return this._opacityObjectIds||(this._opacityObjectIds=Object.keys(this.opacityObjects)),this._opacityObjectIds}get offsetObjectIds(){return this._offsetObjectIds||(this._offsetObjectIds=Object.keys(this.offsetObjects)),this._offsetObjectIds}set ticksPerRender(e){e==null?e=1:(!we.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._ticksPerRender&&(this._ticksPerRender=e)}get ticksPerRender(){return this._ticksPerRender}set ticksPerOcclusionTest(e){e==null?e=20:(!we.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+e+"' - should be an integer greater than zero."),e=20),e!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=e)}get ticksPerOcclusionTest(){return this._ticksPerOcclusionTest}set passes(e){e==null?e=1:(!we.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'passes': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._passes&&(this._passes=e,this.glRedraw())}get passes(){return this._passes}set clearEachPass(e){e=!!e,e!==this._clearEachPass&&(this._clearEachPass=e,this.glRedraw())}get clearEachPass(){return this._clearEachPass}set gammaInput(e){e=e!==!1,e!==this._renderer.gammaInput&&(this._renderer.gammaInput=e,this._needRecompile=!0,this.glRedraw())}get gammaInput(){return this._renderer.gammaInput}set gammaOutput(e){e=!!e,e!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=e,this._needRecompile=!0,this.glRedraw())}get gammaOutput(){return this._renderer.gammaOutput}set gammaFactor(e){e=e??2.2,e!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=e,this.glRedraw())}get gammaFactor(){return this._renderer.gammaFactor}get geometry(){return this.components["default.geometry"]||xf(ti)}get material(){return this.components["default.material"]||new gi(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}get xrayMaterial(){return this.components["default.xrayMaterial"]||new _i(this,{id:"default.xrayMaterial",preset:"sepia",dontClear:!0})}get highlightMaterial(){return this.components["default.highlightMaterial"]||new _i(this,{id:"default.highlightMaterial",preset:"yellowHighlight",dontClear:!0})}get selectedMaterial(){return this.components["default.selectedMaterial"]||new _i(this,{id:"default.selectedMaterial",preset:"greenSelected",dontClear:!0})}get edgeMaterial(){return this.components["default.edgeMaterial"]||new yf(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get pointsMaterial(){return this.components["default.pointsMaterial"]||new w0(this,{id:"default.pointsMaterial",preset:"default",dontClear:!0})}get linesMaterial(){return this.components["default.linesMaterial"]||new C0(this,{id:"default.linesMaterial",preset:"default",dontClear:!0})}get viewport(){return this._viewport}get camera(){return this._camera}get center(){if(this._aabbDirty||!this._center){const e=this.aabb;this._center||(this._center=A.vec3()),this._center[0]=(e[0]+e[3])/2,this._center[1]=(e[1]+e[4])/2,this._center[2]=(e[2]+e[5])/2}return this._center}get aabb(){if(this._aabbDirty){this._aabb||(this._aabb=A.AABB3());let e=A.MAX_DOUBLE,t=A.MAX_DOUBLE,i=A.MAX_DOUBLE,s=A.MIN_DOUBLE,o=A.MIN_DOUBLE,a=A.MIN_DOUBLE,n;const l=this._collidables;let c,h=!1;for(const d in l)if(l.hasOwnProperty(d)){if(c=l[d],c.collidable===!1)continue;n=c.aabb,n[0]<e&&(e=n[0]),n[1]<t&&(t=n[1]),n[2]<i&&(i=n[2]),n[3]>s&&(s=n[3]),n[4]>o&&(o=n[4]),n[5]>a&&(a=n[5]),h=!0}h||(e=-100,t=-100,i=-100,s=100,o=100,a=100),this._aabb[0]=e,this._aabb[1]=t,this._aabb[2]=i,this._aabb[3]=s,this._aabb[4]=o,this._aabb[5]=a,this._aabbDirty=!1,this._center=null}return this._aabb}_setAABBDirty(){this._aabbDirty=!0,this.fire("boundary")}pick(e,t){if(this.canvas.boundary[2]===0||this.canvas.boundary[3]===0)return this.error("Picking not allowed while canvas has zero width or height"),null;e=e||{},e.pickSurface=e.pickSurface||e.rayPick,!e.canvasPos&&!e.matrix&&(!e.origin||!e.direction)&&this.warn("picking without canvasPos, matrix, or ray origin and direction");const i=e.includeEntities||e.include;i&&(e.includeEntityIds=Ph(this,i));const s=e.excludeEntities||e.exclude;return s&&(e.excludeEntityIds=Ph(this,s)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),e.snapToEdge||e.snapToVertex?t=this._renderer.snapPick(e,t):t=this._renderer.pick(e,t),t&&t.entity&&t.entity.fire&&t.entity.fire("picked",t),t}snapPick(e){if(this._warnSnapPickDeprecated===void 0&&(this._warnSnapPickDeprecated=!0,this.warn("Scene.snapPick() is deprecated since v2.4.2 - use Scene.pick() instead")),!e.canvasPos){this.error("Scene.snapPick() canvasPos parameter expected");return}return this._renderer.snapPick(e)}clear(){var e;for(const t in this.components)this.components.hasOwnProperty(t)&&(e=this.components[t],e._dontClear||e.destroy())}clearLights(){const e=Object.keys(this.lights);for(let t=0,i=e.length;t<i;t++)this.lights[e[t]].destroy()}clearSectionPlanes(){const e=Object.keys(this.sectionPlanes);for(let t=0,i=e.length;t<i;t++)this.sectionPlanes[e[t]].destroy()}clearBitmaps(){const e=Object.keys(this.bitmaps);for(let t=0,i=e.length;t<i;t++)this.bitmaps[e[t]].destroy()}clearLines(){const e=Object.keys(this.lineSets);for(let t=0,i=e.length;t<i;t++)this.lineSets[e[t]].destroy()}getAABB(e){if(e===void 0)return this.aabb;if(we.isString(e)){const c=this.objects[e];if(c&&c.aabb)return c.aabb;e=[e]}if(e.length===0)return this.aabb;let t=A.MAX_DOUBLE,i=A.MAX_DOUBLE,s=A.MAX_DOUBLE,o=A.MIN_DOUBLE,a=A.MIN_DOUBLE,n=A.MIN_DOUBLE,l;if(this.withObjects(e,c=>{if(c.collidable){const h=c.aabb;h[0]<t&&(t=h[0]),h[1]<i&&(i=h[1]),h[2]<s&&(s=h[2]),h[3]>o&&(o=h[3]),h[4]>a&&(a=h[4]),h[5]>n&&(n=h[5]),l=!0}}),l){const c=A.AABB3();return c[0]=t,c[1]=i,c[2]=s,c[3]=o,c[4]=a,c[5]=n,c}else return this.aabb}setObjectsVisible(e,t){return this.withObjects(e,i=>{const s=i.visible!==t;return i.visible=t,s})}setObjectsCollidable(e,t){return this.withObjects(e,i=>{const s=i.collidable!==t;return i.collidable=t,s})}setObjectsCulled(e,t){return this.withObjects(e,i=>{const s=i.culled!==t;return i.culled=t,s})}setObjectsSelected(e,t){return this.withObjects(e,i=>{const s=i.selected!==t;return i.selected=t,s})}setObjectsHighlighted(e,t){return this.withObjects(e,i=>{const s=i.highlighted!==t;return i.highlighted=t,s})}setObjectsXRayed(e,t){return this.withObjects(e,i=>{const s=i.xrayed!==t;return i.xrayed=t,s})}setObjectsEdges(e,t){return this.withObjects(e,i=>{const s=i.edges!==t;return i.edges=t,s})}setObjectsColorized(e,t){return this.withObjects(e,i=>{i.colorize=t})}setObjectsOpacity(e,t){return this.withObjects(e,i=>{const s=i.opacity!==t;return i.opacity=t,s})}setObjectsPickable(e,t){return this.withObjects(e,i=>{const s=i.pickable!==t;return i.pickable=t,s})}setObjectsOffset(e,t){this.withObjects(e,i=>{i.offset=t})}withObjects(e,t){we.isString(e)&&(e=[e]);let i=!1;for(let s=0,o=e.length;s<o;s++){const a=e[s];let n=this.objects[a];if(n)i=t(n)||i;else{const l=this.modelIds;for(let c=0,h=l.length;c<h;c++){const d=l[c],p=A.globalizeObjectId(d,a);n=this.objects[p],n&&(i=t(n)||i)}}}return i}tickify(e){const t=e.toString();if(t in this._tickifiedFunctions)return this._tickifiedFunctions[t].wrapperFunc;let i=0,s=0,o;const a=function(...l){o=l,s++},n=this.on("tick",()=>{const l=s;l>i&&(i=l,e(...o))});return this._tickifiedFunctions[t]={tickSubId:n,wrapperFunc:a},a}destroy(){super.destroy();for(const e in this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.colorizedObjects=null,this.opacityObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}}const Vt=1e3,Bs=1001,Po=1002,La=1003,Ac=1004,M0=1004,E0=1005,cc=1005,Si=1006,hc=1007,xo=1008,oa=1008,bf=1009,I0=1010,F0=1011,S0=1012,T0=1013,D0=1014,R0=1015,L0=1016,U0=1017,O0=1018,k0=1020,N0=1021,Q0=1022,ga=1023,V0=1024,H0=1025,j0=1026,z0=1027,G0=1028,W0=1029,K0=1030,X0=1031,Y0=1033,na=33776,fl=33777,ml=33778,aa=33779,yA=35840,xh=35841,bA=35842,yh=35843,Bf=36196,BA=37492,wA=37496,CA=37808,bh=37809,Bh=37810,wh=37811,Ch=37812,Mh=37813,Eh=37814,Ih=37815,Fh=37816,Sh=37817,Th=37818,Dh=37819,Rh=37820,Lh=37821,MA=36492,os=3e3,Et=3001,wf=10001,Cf=10002,$0=function(r){r._material._state.type==="LambertMaterial"?(this.vertex=q0(r),this.fragment=J0(r)):(this.vertex=ev(r),this.fragment=tv(r))},fs={};fs[os]="linearToLinear";fs[Et]="sRGBToLinear";function Mf(r){if(!r.receivesShadow)return!1;const e=r.scene._lightsState.lights;if(!e||e.length===0)return!1;for(let t=0,i=e.length;t<i;t++)if(e[t].castsShadow)return!0;return!1}function Z0(r){if(!r._geometry._state.uvBuf)return!1;const e=r._material;return!!(e._ambientMap||e._occlusionMap||e._baseColorMap||e._diffuseMap||e._alphaMap||e._specularMap||e._glossinessMap||e._specularGlossinessMap||e._emissiveMap||e._metallicMap||e._roughnessMap||e._metallicRoughnessMap||e._reflectivityMap||e._normalMap)}function Ef(r){const e=r._geometry._state.primitiveName;return!!((r._geometry._state.autoVertexNormals||r._geometry._state.normalsBuf)&&(e==="triangles"||e==="triangle-strip"||e==="triangle-fan"))}function q0(r){const e=r.scene,t=r.scene._sectionPlanesState,i=r.scene._lightsState,s=r._geometry._state,o=r._state.billboard,a=r._state.stationary,n=t.getNumAllocatedSectionPlanes()>0,l=!!s.compressGeometry,c=[];if(c.push("#version 300 es"),c.push("// Lambertian drawing vertex shader"),c.push("in vec3 position;"),c.push("uniform mat4 modelMatrix;"),c.push("uniform mat4 viewMatrix;"),c.push("uniform mat4 projMatrix;"),c.push("uniform vec4 colorize;"),c.push("uniform vec3 offset;"),l&&c.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(c.push("uniform float logDepthBufFC;"),c.push("out float vFragDepth;"),c.push("bool isPerspectiveMatrix(mat4 m) {"),c.push("    return (m[2][3] == - 1.0);"),c.push("}"),c.push("out float isPerspective;")),n&&c.push("out vec4 vWorldPosition;"),c.push("uniform vec4 lightAmbient;"),c.push("uniform vec4 materialColor;"),c.push("uniform vec3 materialEmissive;"),s.normalsBuf){c.push("in vec3 normal;"),c.push("uniform mat4 modelNormalMatrix;"),c.push("uniform mat4 viewNormalMatrix;");for(let h=0,d=i.lights.length;h<d;h++){const p=i.lights[h];p.type!=="ambient"&&(c.push("uniform vec4 lightColor"+h+";"),p.type==="dir"&&c.push("uniform vec3 lightDir"+h+";"),p.type==="point"&&c.push("uniform vec3 lightPos"+h+";"),p.type==="spot"&&(c.push("uniform vec3 lightPos"+h+";"),c.push("uniform vec3 lightDir"+h+";")))}l&&(c.push("vec3 octDecode(vec2 oct) {"),c.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),c.push("    if (v.z < 0.0) {"),c.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),c.push("    }"),c.push("    return normalize(v);"),c.push("}"))}if(c.push("out vec4 vColor;"),s.primitiveName==="points"&&c.push("uniform float pointSize;"),(o==="spherical"||o==="cylindrical")&&(c.push("void billboard(inout mat4 mat) {"),c.push("   mat[0][0] = 1.0;"),c.push("   mat[0][1] = 0.0;"),c.push("   mat[0][2] = 0.0;"),o==="spherical"&&(c.push("   mat[1][0] = 0.0;"),c.push("   mat[1][1] = 1.0;"),c.push("   mat[1][2] = 0.0;")),c.push("   mat[2][0] = 0.0;"),c.push("   mat[2][1] = 0.0;"),c.push("   mat[2][2] =1.0;"),c.push("}")),c.push("void main(void) {"),c.push("vec4 localPosition = vec4(position, 1.0); "),c.push("vec4 worldPosition;"),l&&c.push("localPosition = positionsDecodeMatrix * localPosition;"),s.normalsBuf&&(l?c.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):c.push("vec4 localNormal = vec4(normal, 0.0); "),c.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),c.push("mat4 viewNormalMatrix2 = viewNormalMatrix;")),c.push("mat4 viewMatrix2 = viewMatrix;"),c.push("mat4 modelMatrix2 = modelMatrix;"),a&&c.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),o==="spherical"||o==="cylindrical"?(c.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),c.push("billboard(modelMatrix2);"),c.push("billboard(viewMatrix2);"),c.push("billboard(modelViewMatrix);"),s.normalsBuf&&(c.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),c.push("billboard(modelNormalMatrix2);"),c.push("billboard(viewNormalMatrix2);"),c.push("billboard(modelViewNormalMatrix);")),c.push("worldPosition = modelMatrix2 * localPosition;"),c.push("worldPosition.xyz = worldPosition.xyz + offset;"),c.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(c.push("worldPosition = modelMatrix2 * localPosition;"),c.push("worldPosition.xyz = worldPosition.xyz + offset;"),c.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),s.normalsBuf&&c.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);"),c.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),c.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),c.push("float lambertian = 1.0;"),s.normalsBuf)for(let h=0,d=i.lights.length;h<d;h++){const p=i.lights[h];if(p.type!=="ambient"){if(p.type==="dir")p.space==="view"?c.push("viewLightDir = normalize(lightDir"+h+");"):c.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+h+", 0.0)).xyz);");else if(p.type==="point")p.space==="view"?c.push("viewLightDir = -normalize(lightPos"+h+" - viewPosition.xyz);"):c.push("viewLightDir = -normalize((viewMatrix2 * vec4(lightPos"+h+", 0.0)).xyz);");else if(p.type==="spot")p.space==="view"?c.push("viewLightDir = normalize(lightDir"+h+");"):c.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+h+", 0.0)).xyz);");else continue;c.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),c.push("reflectedColor += lambertian * (lightColor"+h+".rgb * lightColor"+h+".a);")}}return c.push("vColor = vec4((lightAmbient.rgb * lightAmbient.a * materialColor.rgb) + materialEmissive.rgb + (reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),n&&c.push("vWorldPosition = worldPosition;"),s.primitiveName==="points"&&c.push("gl_PointSize = pointSize;"),c.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(c.push("vFragDepth = 1.0 + clipPos.w;"),c.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),c.push("gl_Position = clipPos;"),c.push("}"),c}function J0(r){const e=r.scene,t=e._sectionPlanesState;r._material._state;const i=r._geometry._state,s=t.getNumAllocatedSectionPlanes()>0,o=e.gammaOutput,a=[];if(a.push("#version 300 es"),a.push("// Lambertian drawing fragment shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&(a.push("in float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("in float vFragDepth;")),s){a.push("in vec4 vWorldPosition;"),a.push("uniform bool clippable;");for(let n=0,l=t.getNumAllocatedSectionPlanes();n<l;n++)a.push("uniform bool sectionPlaneActive"+n+";"),a.push("uniform vec3 sectionPlanePos"+n+";"),a.push("uniform vec3 sectionPlaneDir"+n+";")}if(a.push("in vec4 vColor;"),o&&(a.push("uniform float gammaFactor;"),a.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}")),a.push("out vec4 outColor;"),a.push("void main(void) {"),s){a.push("if (clippable) {"),a.push("  float dist = 0.0;");for(let n=0,l=t.getNumAllocatedSectionPlanes();n<l;n++)a.push("if (sectionPlaneActive"+n+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}return i.primitiveName==="points"&&(a.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),a.push("float r = dot(cxy, cxy);"),a.push("if (r > 1.0) {"),a.push("   discard;"),a.push("}")),e.logarithmicDepthBufferEnabled&&a.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o?a.push("outColor = linearToGamma(vColor, gammaFactor);"):a.push("outColor = vColor;"),a.push("}"),a}function ev(r){const e=r.scene;r._material;const t=r._state,i=e._sectionPlanesState,s=r._geometry._state,o=e._lightsState;let a;const n=t.billboard,l=t.background,c=t.stationary,h=Z0(r),d=Ef(r),p=i.getNumAllocatedSectionPlanes()>0,m=Mf(r),g=!!s.compressGeometry,u=[];if(u.push("#version 300 es"),u.push("// Drawing vertex shader"),u.push("in  vec3 position;"),g&&u.push("uniform mat4 positionsDecodeMatrix;"),u.push("uniform  mat4 modelMatrix;"),u.push("uniform  mat4 viewMatrix;"),u.push("uniform  mat4 projMatrix;"),u.push("out  vec3 vViewPosition;"),u.push("uniform  vec3 offset;"),p&&u.push("out vec4 vWorldPosition;"),e.logarithmicDepthBufferEnabled&&(u.push("uniform float logDepthBufFC;"),u.push("out float vFragDepth;"),u.push("bool isPerspectiveMatrix(mat4 m) {"),u.push("    return (m[2][3] == - 1.0);"),u.push("}"),u.push("out float isPerspective;")),o.lightMaps.length>0&&u.push("out    vec3 vWorldNormal;"),d){u.push("in  vec3 normal;"),u.push("uniform    mat4 modelNormalMatrix;"),u.push("uniform    mat4 viewNormalMatrix;"),u.push("out    vec3 vViewNormal;");for(let x=0,y=o.lights.length;x<y;x++)a=o.lights[x],a.type!=="ambient"&&(a.type==="dir"&&u.push("uniform vec3 lightDir"+x+";"),a.type==="point"&&u.push("uniform vec3 lightPos"+x+";"),a.type==="spot"&&(u.push("uniform vec3 lightPos"+x+";"),u.push("uniform vec3 lightDir"+x+";")),a.type==="dir"&&a.space==="view"||u.push("out vec4 vViewLightReverseDirAndDist"+x+";"));g&&(u.push("vec3 octDecode(vec2 oct) {"),u.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),u.push("    if (v.z < 0.0) {"),u.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),u.push("    }"),u.push("    return normalize(v);"),u.push("}"))}if(h&&(u.push("in vec2 uv;"),u.push("out vec2 vUV;"),g&&u.push("uniform mat3 uvDecodeMatrix;")),s.colors&&(u.push("in vec4 color;"),u.push("out vec4 vColor;")),s.primitiveName==="points"&&u.push("uniform float pointSize;"),(n==="spherical"||n==="cylindrical")&&(u.push("void billboard(inout mat4 mat) {"),u.push("   mat[0][0] = 1.0;"),u.push("   mat[0][1] = 0.0;"),u.push("   mat[0][2] = 0.0;"),n==="spherical"&&(u.push("   mat[1][0] = 0.0;"),u.push("   mat[1][1] = 1.0;"),u.push("   mat[1][2] = 0.0;")),u.push("   mat[2][0] = 0.0;"),u.push("   mat[2][1] = 0.0;"),u.push("   mat[2][2] =1.0;"),u.push("}")),m){u.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");for(let x=0,y=o.lights.length;x<y;x++)o.lights[x].castsShadow&&(u.push("uniform mat4 shadowViewMatrix"+x+";"),u.push("uniform mat4 shadowProjMatrix"+x+";"),u.push("out vec4 vShadowPosFromLight"+x+";"))}if(u.push("void main(void) {"),u.push("vec4 localPosition = vec4(position, 1.0); "),u.push("vec4 worldPosition;"),g&&u.push("localPosition = positionsDecodeMatrix * localPosition;"),d&&(g?u.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):u.push("vec4 localNormal = vec4(normal, 0.0); "),u.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),u.push("mat4 viewNormalMatrix2     = viewNormalMatrix;")),u.push("mat4 viewMatrix2           = viewMatrix;"),u.push("mat4 modelMatrix2          = modelMatrix;"),c?u.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"):l&&u.push("viewMatrix2[3] = vec4(0.0, 0.0, 0.0 ,1.0);"),n==="spherical"||n==="cylindrical"?(u.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),u.push("billboard(modelMatrix2);"),u.push("billboard(viewMatrix2);"),u.push("billboard(modelViewMatrix);"),d&&(u.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),u.push("billboard(modelNormalMatrix2);"),u.push("billboard(viewNormalMatrix2);"),u.push("billboard(modelViewNormalMatrix);")),u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("worldPosition.xyz = worldPosition.xyz + offset;"),u.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(u.push("worldPosition = modelMatrix2 * localPosition;"),u.push("worldPosition.xyz = worldPosition.xyz + offset;"),u.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),d){u.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),o.lightMaps.length>0&&u.push("vWorldNormal = worldNormal;"),u.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),u.push("vec3 tmpVec3;"),u.push("float lightDist;");for(let x=0,y=o.lights.length;x<y;x++)a=o.lights[x],a.type!=="ambient"&&(a.type==="dir"&&a.space==="world"&&(u.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+x+", 0.0) ).xyz;"),u.push("vViewLightReverseDirAndDist"+x+" = vec4(-tmpVec3, 0.0);")),a.type==="point"&&(a.space==="world"?(u.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+x+", 1.0)).xyz - viewPosition.xyz;"),u.push("lightDist = abs(length(tmpVec3));")):(u.push("tmpVec3 = lightPos"+x+".xyz - viewPosition.xyz;"),u.push("lightDist = abs(length(tmpVec3));")),u.push("vViewLightReverseDirAndDist"+x+" = vec4(tmpVec3, lightDist);")))}if(h&&(g?u.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):u.push("vUV = uv;")),s.colors&&u.push("vColor = color;"),s.primitiveName==="points"&&u.push("gl_PointSize = pointSize;"),p&&u.push("vWorldPosition = worldPosition;"),u.push("   vViewPosition = viewPosition.xyz;"),u.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(u.push("vFragDepth = 1.0 + clipPos.w;"),u.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),l&&u.push("clipPos.z = clipPos.w;"),u.push("gl_Position = clipPos;"),m){u.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),u.push("vec4 tempx; ");for(let x=0,y=o.lights.length;x<y;x++)o.lights[x].castsShadow&&u.push("vShadowPosFromLight"+x+" = texUnitConverter * shadowProjMatrix"+x+" * (shadowViewMatrix"+x+" * worldPosition); ")}return u.push("}"),u}function tv(r){const e=r.scene;e.canvas.gl;const t=r._material,i=r._geometry._state,s=r.scene._sectionPlanesState,o=r.scene._lightsState,a=r._material._state,n=s.getNumAllocatedSectionPlanes()>0,l=Ef(r),c=i.uvBuf,h=a.type==="PhongMaterial",d=a.type==="MetallicMaterial",p=a.type==="SpecularMaterial",m=Mf(r);e.gammaInput;const g=e.gammaOutput,u=[];if(u.push("#version 300 es"),u.push("// Drawing fragment shader"),u.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),u.push("precision highp float;"),u.push("precision highp int;"),u.push("#else"),u.push("precision mediump float;"),u.push("precision mediump int;"),u.push("#endif"),e.logarithmicDepthBufferEnabled&&(u.push("in float isPerspective;"),u.push("uniform float logDepthBufFC;"),u.push("in float vFragDepth;")),m&&(u.push("float unpackDepth (vec4 color) {"),u.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),u.push("  return dot(color, bitShift);"),u.push("}")),u.push("uniform float gammaFactor;"),u.push("vec4 linearToLinear( in vec4 value ) {"),u.push("  return value;"),u.push("}"),u.push("vec4 sRGBToLinear( in vec4 value ) {"),u.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),u.push("}"),u.push("vec4 gammaToLinear( in vec4 value) {"),u.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),u.push("}"),g&&(u.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),u.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),u.push("}")),n){u.push("in vec4 vWorldPosition;"),u.push("uniform bool clippable;");for(var x=0;x<s.getNumAllocatedSectionPlanes();x++)u.push("uniform bool sectionPlaneActive"+x+";"),u.push("uniform vec3 sectionPlanePos"+x+";"),u.push("uniform vec3 sectionPlaneDir"+x+";")}if(l&&(o.lightMaps.length>0&&(u.push("uniform samplerCube lightMap;"),u.push("uniform mat4 viewNormalMatrix;")),o.reflectionMaps.length>0&&u.push("uniform samplerCube reflectionMap;"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&u.push("uniform mat4 viewMatrix;"),u.push("#define PI 3.14159265359"),u.push("#define RECIPROCAL_PI 0.31830988618"),u.push("#define RECIPROCAL_PI2 0.15915494"),u.push("#define EPSILON 1e-6"),u.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),u.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),u.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),u.push("}"),u.push("struct IncidentLight {"),u.push("   vec3 color;"),u.push("   vec3 direction;"),u.push("};"),u.push("struct ReflectedLight {"),u.push("   vec3 diffuse;"),u.push("   vec3 specular;"),u.push("};"),u.push("struct Geometry {"),u.push("   vec3 position;"),u.push("   vec3 viewNormal;"),u.push("   vec3 worldNormal;"),u.push("   vec3 viewEyeDir;"),u.push("};"),u.push("struct Material {"),u.push("   vec3    diffuseColor;"),u.push("   float   specularRoughness;"),u.push("   vec3    specularColor;"),u.push("   float   shine;"),u.push("};"),h&&((o.lightMaps.length>0||o.reflectionMaps.length>0)&&(u.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(u.push("   vec3 irradiance = "+fs[o.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),u.push("   irradiance *= PI;"),u.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),u.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(u.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),u.push("   vec3 radiance               = texture(reflectionMap, reflectVec).rgb * 0.2;"),u.push("   radiance *= PI;"),u.push("   reflectedLight.specular     += radiance;")),u.push("}")),u.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),u.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),u.push("   vec3 irradiance = dotNL * directLight.color * PI;"),u.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),u.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),u.push("}")),(d||p)&&(u.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),u.push("   float r = ggxRoughness + 0.0001;"),u.push("   return (2.0 / (r * r) - 2.0);"),u.push("}"),u.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),u.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),u.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),u.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),u.push("}"),o.reflectionMaps.length>0&&(u.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),u.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),u.push("   vec3 envMapColor = "+fs[o.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),u.push("  return envMapColor;"),u.push("}")),u.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),u.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),u.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),u.push("}"),u.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),u.push("   float a2 = ( alpha * alpha );"),u.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),u.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),u.push("   return 1.0 / ( gl * gv );"),u.push("}"),u.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),u.push("   float a2 = ( alpha * alpha );"),u.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),u.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),u.push("   return 0.5 / max( gv + gl, EPSILON );"),u.push("}"),u.push("float D_GGX(const in float alpha, const in float dotNH) {"),u.push("   float a2 = ( alpha * alpha );"),u.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),u.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),u.push("}"),u.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),u.push("   float alpha = ( roughness * roughness );"),u.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),u.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),u.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),u.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),u.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),u.push("   vec3  F = F_Schlick( specularColor, dotLH );"),u.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),u.push("   float D = D_GGX( alpha, dotNH );"),u.push("   return F * (G * D);"),u.push("}"),u.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),u.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),u.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),u.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),u.push("   vec4 r = roughness * c0 + c1;"),u.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),u.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),u.push("   return specularColor * AB.x + AB.y;"),u.push("}"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&(u.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(u.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),u.push("   irradiance *= PI;"),u.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),u.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(u.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),u.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),u.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),u.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),u.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),u.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),u.push("}")),u.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),u.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),u.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),u.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),u.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),u.push("}"))),u.push("in vec3 vViewPosition;"),i.colors&&u.push("in vec4 vColor;"),c&&(l&&t._normalMap||t._ambientMap||t._baseColorMap||t._diffuseMap||t._emissiveMap||t._metallicMap||t._roughnessMap||t._metallicRoughnessMap||t._specularMap||t._glossinessMap||t._specularGlossinessMap||t._occlusionMap||t._alphaMap)&&u.push("in vec2 vUV;"),l&&(o.lightMaps.length>0&&u.push("in vec3 vWorldNormal;"),u.push("in vec3 vViewNormal;")),a.ambient&&u.push("uniform vec3 materialAmbient;"),a.baseColor&&u.push("uniform vec3 materialBaseColor;"),a.alpha!==void 0&&a.alpha!==null&&u.push("uniform vec4 materialAlphaModeCutoff;"),a.emissive&&u.push("uniform vec3 materialEmissive;"),a.diffuse&&u.push("uniform vec3 materialDiffuse;"),a.glossiness!==void 0&&a.glossiness!==null&&u.push("uniform float materialGlossiness;"),a.shininess!==void 0&&a.shininess!==null&&u.push("uniform float materialShininess;"),a.specular&&u.push("uniform vec3 materialSpecular;"),a.metallic!==void 0&&a.metallic!==null&&u.push("uniform float materialMetallic;"),a.roughness!==void 0&&a.roughness!==null&&u.push("uniform float materialRoughness;"),a.specularF0!==void 0&&a.specularF0!==null&&u.push("uniform float materialSpecularF0;"),c&&t._ambientMap&&(u.push("uniform sampler2D ambientMap;"),t._ambientMap._state.matrix&&u.push("uniform mat4 ambientMapMatrix;")),c&&t._baseColorMap&&(u.push("uniform sampler2D baseColorMap;"),t._baseColorMap._state.matrix&&u.push("uniform mat4 baseColorMapMatrix;")),c&&t._diffuseMap&&(u.push("uniform sampler2D diffuseMap;"),t._diffuseMap._state.matrix&&u.push("uniform mat4 diffuseMapMatrix;")),c&&t._emissiveMap&&(u.push("uniform sampler2D emissiveMap;"),t._emissiveMap._state.matrix&&u.push("uniform mat4 emissiveMapMatrix;")),l&&c&&t._metallicMap&&(u.push("uniform sampler2D metallicMap;"),t._metallicMap._state.matrix&&u.push("uniform mat4 metallicMapMatrix;")),l&&c&&t._roughnessMap&&(u.push("uniform sampler2D roughnessMap;"),t._roughnessMap._state.matrix&&u.push("uniform mat4 roughnessMapMatrix;")),l&&c&&t._metallicRoughnessMap&&(u.push("uniform sampler2D metallicRoughnessMap;"),t._metallicRoughnessMap._state.matrix&&u.push("uniform mat4 metallicRoughnessMapMatrix;")),l&&t._normalMap&&(u.push("uniform sampler2D normalMap;"),t._normalMap._state.matrix&&u.push("uniform mat4 normalMapMatrix;"),u.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),u.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),u.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),u.push("      vec2 st0 = dFdx( uv.st );"),u.push("      vec2 st1 = dFdy( uv.st );"),u.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),u.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),u.push("      vec3 N = normalize( surf_norm );"),u.push("      vec3 mapN = texture( normalMap, uv ).xyz * 2.0 - 1.0;"),u.push("      mat3 tsn = mat3( S, T, N );"),u.push("      return normalize( tsn * mapN );"),u.push("}")),c&&t._occlusionMap&&(u.push("uniform sampler2D occlusionMap;"),t._occlusionMap._state.matrix&&u.push("uniform mat4 occlusionMapMatrix;")),c&&t._alphaMap&&(u.push("uniform sampler2D alphaMap;"),t._alphaMap._state.matrix&&u.push("uniform mat4 alphaMapMatrix;")),l&&c&&t._specularMap&&(u.push("uniform sampler2D specularMap;"),t._specularMap._state.matrix&&u.push("uniform mat4 specularMapMatrix;")),l&&c&&t._glossinessMap&&(u.push("uniform sampler2D glossinessMap;"),t._glossinessMap._state.matrix&&u.push("uniform mat4 glossinessMapMatrix;")),l&&c&&t._specularGlossinessMap&&(u.push("uniform sampler2D materialSpecularGlossinessMap;"),t._specularGlossinessMap._state.matrix&&u.push("uniform mat4 materialSpecularGlossinessMapMatrix;")),l&&(t._diffuseFresnel||t._specularFresnel||t._alphaFresnel||t._emissiveFresnel||t._reflectivityFresnel)&&(u.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),u.push("    float fr = abs(dot(eyeDir, normal));"),u.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),u.push("    return pow(finalFr, power);"),u.push("}"),t._diffuseFresnel&&(u.push("uniform float  diffuseFresnelCenterBias;"),u.push("uniform float  diffuseFresnelEdgeBias;"),u.push("uniform float  diffuseFresnelPower;"),u.push("uniform vec3   diffuseFresnelCenterColor;"),u.push("uniform vec3   diffuseFresnelEdgeColor;")),t._specularFresnel&&(u.push("uniform float  specularFresnelCenterBias;"),u.push("uniform float  specularFresnelEdgeBias;"),u.push("uniform float  specularFresnelPower;"),u.push("uniform vec3   specularFresnelCenterColor;"),u.push("uniform vec3   specularFresnelEdgeColor;")),t._alphaFresnel&&(u.push("uniform float  alphaFresnelCenterBias;"),u.push("uniform float  alphaFresnelEdgeBias;"),u.push("uniform float  alphaFresnelPower;"),u.push("uniform vec3   alphaFresnelCenterColor;"),u.push("uniform vec3   alphaFresnelEdgeColor;")),t._reflectivityFresnel&&(u.push("uniform float  materialSpecularF0FresnelCenterBias;"),u.push("uniform float  materialSpecularF0FresnelEdgeBias;"),u.push("uniform float  materialSpecularF0FresnelPower;"),u.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),u.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),t._emissiveFresnel&&(u.push("uniform float  emissiveFresnelCenterBias;"),u.push("uniform float  emissiveFresnelEdgeBias;"),u.push("uniform float  emissiveFresnelPower;"),u.push("uniform vec3   emissiveFresnelCenterColor;"),u.push("uniform vec3   emissiveFresnelEdgeColor;"))),u.push("uniform vec4   lightAmbient;"),l)for(let y=0,P=o.lights.length;y<P;y++){const _=o.lights[y];_.type!=="ambient"&&(u.push("uniform vec4 lightColor"+y+";"),_.type==="point"&&u.push("uniform vec3 lightAttenuation"+y+";"),_.type==="dir"&&_.space==="view"&&u.push("uniform vec3 lightDir"+y+";"),_.type==="point"&&_.space==="view"?u.push("uniform vec3 lightPos"+y+";"):u.push("in vec4 vViewLightReverseDirAndDist"+y+";"))}if(m)for(let y=0,P=o.lights.length;y<P;y++)o.lights[y].castsShadow&&(u.push("in vec4 vShadowPosFromLight"+y+";"),u.push("uniform sampler2D shadowMap"+y+";"));if(u.push("uniform vec4 colorize;"),u.push("out vec4 outColor;"),u.push("void main(void) {"),n){u.push("if (clippable) {"),u.push("  float dist = 0.0;");for(var x=0;x<s.getNumAllocatedSectionPlanes();x++)u.push("if (sectionPlaneActive"+x+") {"),u.push("   dist += clamp(dot(-sectionPlaneDir"+x+".xyz, vWorldPosition.xyz - sectionPlanePos"+x+".xyz), 0.0, 1000.0);"),u.push("}");u.push("  if (dist > 0.0) { discard; }"),u.push("}")}if(i.primitiveName==="points"&&(u.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),u.push("float r = dot(cxy, cxy);"),u.push("if (r > 1.0) {"),u.push("   discard;"),u.push("}")),u.push("float occlusion = 1.0;"),a.ambient?u.push("vec3 ambientColor = materialAmbient;"):u.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);"),a.diffuse?u.push("vec3 diffuseColor = materialDiffuse;"):a.baseColor?u.push("vec3 diffuseColor = materialBaseColor;"):u.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);"),i.colors&&u.push("diffuseColor *= vColor.rgb;"),a.emissive?u.push("vec3 emissiveColor = materialEmissive;"):u.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);"),a.specular?u.push("vec3 specular = materialSpecular;"):u.push("vec3 specular = vec3(1.0, 1.0, 1.0);"),a.alpha!==void 0?u.push("float alpha = materialAlphaModeCutoff[0];"):u.push("float alpha = 1.0;"),i.colors&&u.push("alpha *= vColor.a;"),a.glossiness!==void 0?u.push("float glossiness = materialGlossiness;"):u.push("float glossiness = 1.0;"),a.metallic!==void 0?u.push("float metallic = materialMetallic;"):u.push("float metallic = 1.0;"),a.roughness!==void 0?u.push("float roughness = materialRoughness;"):u.push("float roughness = 1.0;"),a.specularF0!==void 0?u.push("float specularF0 = materialSpecularF0;"):u.push("float specularF0 = 1.0;"),c&&(l&&t._normalMap||t._ambientMap||t._baseColorMap||t._diffuseMap||t._occlusionMap||t._emissiveMap||t._metallicMap||t._roughnessMap||t._metallicRoughnessMap||t._specularMap||t._glossinessMap||t._specularGlossinessMap||t._alphaMap)&&(u.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),u.push("vec2 textureCoord;")),c&&t._ambientMap&&(t._ambientMap._state.matrix?u.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 ambientTexel = texture(ambientMap, textureCoord).rgb;"),u.push("ambientTexel = "+fs[t._ambientMap._state.encoding]+"(ambientTexel);"),u.push("ambientColor *= ambientTexel.rgb;")),c&&t._diffuseMap&&(t._diffuseMap._state.matrix?u.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 diffuseTexel = texture(diffuseMap, textureCoord);"),u.push("diffuseTexel = "+fs[t._diffuseMap._state.encoding]+"(diffuseTexel);"),u.push("diffuseColor *= diffuseTexel.rgb;"),u.push("alpha *= diffuseTexel.a;")),c&&t._baseColorMap&&(t._baseColorMap._state.matrix?u.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 baseColorTexel = texture(baseColorMap, textureCoord);"),u.push("baseColorTexel = "+fs[t._baseColorMap._state.encoding]+"(baseColorTexel);"),u.push("diffuseColor *= baseColorTexel.rgb;"),u.push("alpha *= baseColorTexel.a;")),c&&t._emissiveMap&&(t._emissiveMap._state.matrix?u.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 emissiveTexel = texture(emissiveMap, textureCoord);"),u.push("emissiveTexel = "+fs[t._emissiveMap._state.encoding]+"(emissiveTexel);"),u.push("emissiveColor = emissiveTexel.rgb;")),c&&t._alphaMap&&(t._alphaMap._state.matrix?u.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("alpha *= texture(alphaMap, textureCoord).r;")),c&&t._occlusionMap&&(t._occlusionMap._state.matrix?u.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("occlusion *= texture(occlusionMap, textureCoord).r;")),l&&(o.lights.length>0||o.lightMaps.length>0||o.reflectionMaps.length>0)){c&&t._normalMap?(t._normalMap._state.matrix?u.push("textureCoord = (normalMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):u.push("vec3 viewNormal = normalize(vViewNormal);"),c&&t._specularMap&&(t._specularMap._state.matrix?u.push("textureCoord = (specularMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("specular *= texture(specularMap, textureCoord).rgb;")),c&&t._glossinessMap&&(t._glossinessMap._state.matrix?u.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("glossiness *= texture(glossinessMap, textureCoord).r;")),c&&t._specularGlossinessMap&&(t._specularGlossinessMap._state.matrix?u.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec4 specGlossRGB = texture(materialSpecularGlossinessMap, textureCoord).rgba;"),u.push("specular *= specGlossRGB.rgb;"),u.push("glossiness *= specGlossRGB.a;")),c&&t._metallicMap&&(t._metallicMap._state.matrix?u.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("metallic *= texture(metallicMap, textureCoord).r;")),c&&t._roughnessMap&&(t._roughnessMap._state.matrix?u.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("roughness *= texture(roughnessMap, textureCoord).r;")),c&&t._metallicRoughnessMap&&(t._metallicRoughnessMap._state.matrix?u.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):u.push("textureCoord = texturePos.xy;"),u.push("vec3 metalRoughRGB = texture(metallicRoughnessMap, textureCoord).rgb;"),u.push("metallic *= metalRoughRGB.b;"),u.push("roughness *= metalRoughRGB.g;")),u.push("vec3 viewEyeDir = normalize(-vViewPosition);"),t._diffuseFresnel&&(u.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),u.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),t._specularFresnel&&(u.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),u.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),t._alphaFresnel&&(u.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),u.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),t._emissiveFresnel&&(u.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),u.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),u.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),u.push("   discard;"),u.push("}"),u.push("IncidentLight  light;"),u.push("Material       material;"),u.push("Geometry       geometry;"),u.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),u.push("vec3           viewLightDir;"),h&&(u.push("material.diffuseColor      = diffuseColor;"),u.push("material.specularColor     = specular;"),u.push("material.shine             = materialShininess;")),p&&(u.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),u.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),u.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),u.push("material.specularColor     = specular;")),d&&(u.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),u.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),u.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),u.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),u.push("geometry.position      = vViewPosition;"),o.lightMaps.length>0&&u.push("geometry.worldNormal   = normalize(vWorldNormal);"),u.push("geometry.viewNormal    = viewNormal;"),u.push("geometry.viewEyeDir    = viewEyeDir;"),h&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&u.push("computePhongLightMapping(geometry, material, reflectedLight);"),(p||d)&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&u.push("computePBRLightMapping(geometry, material, reflectedLight);"),u.push("float shadow = 1.0;"),u.push("float shadowAcneRemover = 0.007;"),u.push("vec3 fragmentDepth;"),u.push("float texelSize = 1.0 / 1024.0;"),u.push("float amountInLight = 0.0;"),u.push("vec3 shadowCoord;"),u.push("vec4 rgbaDepth;"),u.push("float depth;");for(let y=0,P=o.lights.length;y<P;y++){const _=o.lights[y];_.type!=="ambient"&&(_.type==="dir"&&_.space==="view"?u.push("viewLightDir = -normalize(lightDir"+y+");"):_.type==="point"&&_.space==="view"?u.push("viewLightDir = normalize(lightPos"+y+" - vViewPosition);"):u.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+y+".xyz);"),m&&_.castsShadow?(u.push("shadow = 0.0;"),u.push("fragmentDepth = vShadowPosFromLight"+y+".xyz;"),u.push("fragmentDepth.z -= shadowAcneRemover;"),u.push("for (int x = -3; x <= 3; x++) {"),u.push("  for (int y = -3; y <= 3; y++) {"),u.push("      float texelDepth = unpackDepth(texture(shadowMap"+y+", fragmentDepth.xy + vec2(x, y) * texelSize));"),u.push("      if (fragmentDepth.z < texelDepth) {"),u.push("          shadow += 1.0;"),u.push("      }"),u.push("  }"),u.push("}"),u.push("shadow = shadow / 9.0;"),u.push("light.color =  lightColor"+y+".rgb * (lightColor"+y+".a * shadow);")):u.push("light.color =  lightColor"+y+".rgb * (lightColor"+y+".a );"),u.push("light.direction = viewLightDir;"),h&&u.push("computePhongLighting(light, geometry, material, reflectedLight);"),(p||d)&&u.push("computePBRLighting(light, geometry, material, reflectedLight);"))}h?u.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * diffuseColor) + ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;"):u.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (occlusion * reflectedLight.specular) + emissiveColor;")}else u.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),u.push("vec3 outgoingLight = emissiveColor + ambientColor;");return u.push("vec4 fragColor = vec4(outgoingLight, alpha) * colorize;"),g&&u.push("fragColor = linearToGamma(fragColor, gammaFactor);"),u.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&u.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),u.push("}"),u}const iv=A.vec3(),If=new Di({}),ji=function(r,e){this.id=If.addItem({}),this._hash=r,this._scene=e.scene,this._useCount=0,this._shaderSource=new $0(e),this._allocate(e)},EA={};ji.get=function(r){const e=r.scene,t=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash(),r._geometry._state.hash,r._material._state.hash,r._state.drawHash].join(";");let i=EA[t];if(!i){if(i=new ji(t,r),i.errors)return console.log(i.errors.join(`
`)),null;EA[t]=i,_t.memory.programs++}return i._useCount++,i};ji.prototype.put=function(){--this._useCount===0&&(If.removeItem(this.id),this._program&&this._program.destroy(),delete EA[this._hash],_t.memory.programs--)};ji.prototype.webglContextRestored=function(){this._program=null};ji.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const t=yt.MAX_TEXTURE_UNITS,i=e.scene,s=e._material,o=i.canvas.gl,a=this._program,n=e._state,l=e._material._state,c=e._geometry._state,h=i.camera,d=e.origin,p=n.background;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,p&&o.depthFunc(o.LEQUAL),this._bindProgram(r)),o.uniformMatrix4fv(this._uViewMatrix,!1,d?r.getRTCViewMatrix(n.originHash,d):h.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,h.viewNormalMatrix),n.clippable){const y=i._sectionPlanesState.getNumAllocatedSectionPlanes(),P=i._sectionPlanesState.sectionPlanes.length;if(y>0){const _=i._sectionPlanesState.sectionPlanes,b=e.renderFlags;for(let B=0;B<y;B++){const w=this._uSectionPlanes[B];if(w)if(B<P){const C=b.sectionPlanesActivePerLayer[B];if(o.uniform1i(w.active,C?1:0),C){const E=_[B];if(d){const I=kt(E.dist,E.dir,d,iv);o.uniform3fv(w.pos,I)}else o.uniform3fv(w.pos,E.pos);o.uniform3fv(w.dir,E.dir)}}else o.uniform1i(w.active,0)}}}if(l.id!==this._lastMaterialId){r.textureUnit=this._baseTextureUnit;const y=l.backfaces;r.backfaces!==y&&(y?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),r.backfaces=y);const P=l.frontface;switch(r.frontface!==P&&(P?o.frontFace(o.CCW):o.frontFace(o.CW),r.frontface=P),r.lineWidth!==l.lineWidth&&(o.lineWidth(l.lineWidth),r.lineWidth=l.lineWidth),this._uPointSize&&o.uniform1f(this._uPointSize,l.pointSize),l.type){case"LambertMaterial":this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialColor&&o.uniform4f(this._uMaterialColor,l.color[0],l.color[1],l.color[2],l.alpha),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive);break;case"PhongMaterial":this._uMaterialShininess&&o.uniform1f(this._uMaterialShininess,l.shininess),this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,l.alphaMode===1?1:0,l.alphaCutoff,0),s._ambientMap&&s._ambientMap._state.texture&&this._uMaterialAmbientMap&&(a.bindTexture(this._uMaterialAmbientMap,s._ambientMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uMaterialAmbientMapMatrix&&o.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,s._ambientMap._state.matrix)),s._diffuseMap&&s._diffuseMap._state.texture&&this._uDiffuseMap&&(a.bindTexture(this._uDiffuseMap,s._diffuseMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,s._diffuseMap._state.matrix)),s._specularMap&&s._specularMap._state.texture&&this._uSpecularMap&&(a.bindTexture(this._uSpecularMap,s._specularMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,s._specularMap._state.matrix)),s._emissiveMap&&s._emissiveMap._state.texture&&this._uEmissiveMap&&(a.bindTexture(this._uEmissiveMap,s._emissiveMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,s._emissiveMap._state.matrix)),s._alphaMap&&s._alphaMap._state.texture&&this._uAlphaMap&&(a.bindTexture(this._uAlphaMap,s._alphaMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,s._alphaMap._state.matrix)),s._reflectivityMap&&s._reflectivityMap._state.texture&&this._uReflectivityMap&&(a.bindTexture(this._uReflectivityMap,s._reflectivityMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,this._uReflectivityMapMatrix&&o.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,s._reflectivityMap._state.matrix)),s._normalMap&&s._normalMap._state.texture&&this._uNormalMap&&(a.bindTexture(this._uNormalMap,s._normalMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,s._normalMap._state.matrix)),s._occlusionMap&&s._occlusionMap._state.texture&&this._uOcclusionMap&&(a.bindTexture(this._uOcclusionMap,s._occlusionMap._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,s._occlusionMap._state.matrix)),s._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&o.uniform1f(this._uDiffuseFresnelEdgeBias,s._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&o.uniform1f(this._uDiffuseFresnelCenterBias,s._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&o.uniform3fv(this._uDiffuseFresnelEdgeColor,s._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&o.uniform3fv(this._uDiffuseFresnelCenterColor,s._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&o.uniform1f(this._uDiffuseFresnelPower,s._diffuseFresnel.power)),s._specularFresnel&&(this._uSpecularFresnelEdgeBias&&o.uniform1f(this._uSpecularFresnelEdgeBias,s._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&o.uniform1f(this._uSpecularFresnelCenterBias,s._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&o.uniform3fv(this._uSpecularFresnelEdgeColor,s._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&o.uniform3fv(this._uSpecularFresnelCenterColor,s._specularFresnel.centerColor),this._uSpecularFresnelPower&&o.uniform1f(this._uSpecularFresnelPower,s._specularFresnel.power)),s._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&o.uniform1f(this._uAlphaFresnelEdgeBias,s._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&o.uniform1f(this._uAlphaFresnelCenterBias,s._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&o.uniform3fv(this._uAlphaFresnelEdgeColor,s._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&o.uniform3fv(this._uAlphaFresnelCenterColor,s._alphaFresnel.centerColor),this._uAlphaFresnelPower&&o.uniform1f(this._uAlphaFresnelPower,s._alphaFresnel.power)),s._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&o.uniform1f(this._uReflectivityFresnelEdgeBias,s._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&o.uniform1f(this._uReflectivityFresnelCenterBias,s._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&o.uniform3fv(this._uReflectivityFresnelEdgeColor,s._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&o.uniform3fv(this._uReflectivityFresnelCenterColor,s._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&o.uniform1f(this._uReflectivityFresnelPower,s._reflectivityFresnel.power)),s._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&o.uniform1f(this._uEmissiveFresnelEdgeBias,s._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&o.uniform1f(this._uEmissiveFresnelCenterBias,s._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&o.uniform3fv(this._uEmissiveFresnelEdgeColor,s._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&o.uniform3fv(this._uEmissiveFresnelCenterColor,s._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&o.uniform1f(this._uEmissiveFresnelPower,s._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&o.uniform3fv(this._uBaseColor,l.baseColor),this._uMaterialMetallic&&o.uniform1f(this._uMaterialMetallic,l.metallic),this._uMaterialRoughness&&o.uniform1f(this._uMaterialRoughness,l.roughness),this._uMaterialSpecularF0&&o.uniform1f(this._uMaterialSpecularF0,l.specularF0),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,l.alphaMode===1?1:0,l.alphaCutoff,0);const _=s._baseColorMap;_&&_._state.texture&&this._uBaseColorMap&&(a.bindTexture(this._uBaseColorMap,_._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uBaseColorMapMatrix&&o.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,_._state.matrix));const b=s._metallicMap;b&&b._state.texture&&this._uMetallicMap&&(a.bindTexture(this._uMetallicMap,b._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uMetallicMapMatrix&&o.uniformMatrix4fv(this._uMetallicMapMatrix,!1,b._state.matrix));const B=s._roughnessMap;B&&B._state.texture&&this._uRoughnessMap&&(a.bindTexture(this._uRoughnessMap,B._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uRoughnessMapMatrix&&o.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,B._state.matrix));const w=s._metallicRoughnessMap;w&&w._state.texture&&this._uMetallicRoughnessMap&&(a.bindTexture(this._uMetallicRoughnessMap,w._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uMetallicRoughnessMapMatrix&&o.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,w._state.matrix));var m=s._emissiveMap;m&&m._state.texture&&this._uEmissiveMap&&(a.bindTexture(this._uEmissiveMap,m._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,m._state.matrix));var g=s._occlusionMap;g&&s._occlusionMap._state.texture&&this._uOcclusionMap&&(a.bindTexture(this._uOcclusionMap,g._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,g._state.matrix));var u=s._alphaMap;u&&u._state.texture&&this._uAlphaMap&&(a.bindTexture(this._uAlphaMap,u._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,u._state.matrix));var x=s._normalMap;x&&x._state.texture&&this._uNormalMap&&(a.bindTexture(this._uNormalMap,x._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,x._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialGlossiness&&o.uniform1f(this._uMaterialGlossiness,l.glossiness),this._uMaterialReflectivity&&o.uniform1f(this._uMaterialReflectivity,l.reflectivity),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,l.alphaMode===1?1:0,l.alphaCutoff,0);const C=s._diffuseMap;C&&C._state.texture&&this._uDiffuseMap&&(a.bindTexture(this._uDiffuseMap,C._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,C._state.matrix));const E=s._specularMap;E&&E._state.texture&&this._uSpecularMap&&(a.bindTexture(this._uSpecularMap,E._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,E._state.matrix));const I=s._glossinessMap;I&&I._state.texture&&this._uGlossinessMap&&(a.bindTexture(this._uGlossinessMap,I._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uGlossinessMapMatrix&&o.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,I._state.matrix));const R=s._specularGlossinessMap;R&&R._state.texture&&this._uSpecularGlossinessMap&&(a.bindTexture(this._uSpecularGlossinessMap,R._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uSpecularGlossinessMapMatrix&&o.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,R._state.matrix));var m=s._emissiveMap;m&&m._state.texture&&this._uEmissiveMap&&(a.bindTexture(this._uEmissiveMap,m._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,m._state.matrix));var g=s._occlusionMap;g&&g._state.texture&&this._uOcclusionMap&&(a.bindTexture(this._uOcclusionMap,g._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,g._state.matrix));var u=s._alphaMap;u&&u._state.texture&&this._uAlphaMap&&(a.bindTexture(this._uAlphaMap,u._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,u._state.matrix));var x=s._normalMap;x&&x._state.texture&&this._uNormalMap&&(a.bindTexture(this._uNormalMap,x._state.texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%t,r.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,x._state.matrix));break}this._lastMaterialId=l.id}if(o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,e.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,n.clippable),this._uColorize){const y=n.colorize,P=this._lastColorize;(P[0]!==y[0]||P[1]!==y[1]||P[2]!==y[2]||P[3]!==y[3])&&(o.uniform4fv(this._uColorize,y),P[0]=y[0],P[1]=y[1],P[2]=y[2],P[3]=y[3])}o.uniform3fv(this._uOffset,n.offset),c.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,c.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,c.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(c.positionsBuf),r.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(c.normalsBuf),r.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(c.uvBuf),r.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(c.colorsBuf),r.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(c.flagsBuf),r.bindArray++),c.indicesBuf&&(c.indicesBuf.bind(),r.bindArray++),this._lastGeometryId=c.id),c.indicesBuf?(o.drawElements(c.primitive,c.indicesBuf.numItems,c.indicesBuf.itemType,0),r.drawElements++):c.positions&&(o.drawArrays(o.TRIANGLES,0,c.positions.numItems),r.drawArrays++),p&&o.depthFunc(o.LESS)};ji.prototype._allocate=function(r){const e=r.scene,t=e.canvas.gl,i=r._material,s=e._lightsState,o=e._sectionPlanesState,a=r._material._state;if(this._program=new Tt(t,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const n=this._program;this._uPositionsDecodeMatrix=n.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=n.getLocation("uvDecodeMatrix"),this._uModelMatrix=n.getLocation("modelMatrix"),this._uModelNormalMatrix=n.getLocation("modelNormalMatrix"),this._uViewMatrix=n.getLocation("viewMatrix"),this._uViewNormalMatrix=n.getLocation("viewNormalMatrix"),this._uProjMatrix=n.getLocation("projMatrix"),this._uGammaFactor=n.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[],e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=n.getLocation("logDepthBufFC"));const l=s.lights;let c;for(var h=0,d=l.length;h<d;h++){switch(c=l[h],c.type){case"ambient":this._uLightAmbient[h]=n.getLocation("lightAmbient");break;case"dir":this._uLightColor[h]=n.getLocation("lightColor"+h),this._uLightPos[h]=null,this._uLightDir[h]=n.getLocation("lightDir"+h);break;case"point":this._uLightColor[h]=n.getLocation("lightColor"+h),this._uLightPos[h]=n.getLocation("lightPos"+h),this._uLightDir[h]=null,this._uLightAttenuation[h]=n.getLocation("lightAttenuation"+h);break;case"spot":this._uLightColor[h]=n.getLocation("lightColor"+h),this._uLightPos[h]=n.getLocation("lightPos"+h),this._uLightDir[h]=n.getLocation("lightDir"+h),this._uLightAttenuation[h]=n.getLocation("lightAttenuation"+h);break}c.castsShadow&&(this._uShadowViewMatrix[h]=n.getLocation("shadowViewMatrix"+h),this._uShadowProjMatrix[h]=n.getLocation("shadowProjMatrix"+h))}s.lightMaps.length>0&&(this._uLightMap="lightMap"),s.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uSectionPlanes=[];const p=o.sectionPlanes;for(var h=0,d=p.length;h<d;h++)this._uSectionPlanes.push({active:n.getLocation("sectionPlaneActive"+h),pos:n.getLocation("sectionPlanePos"+h),dir:n.getLocation("sectionPlaneDir"+h)});switch(this._uPointSize=n.getLocation("pointSize"),a.type){case"LambertMaterial":this._uMaterialColor=n.getLocation("materialColor"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=n.getLocation("materialAmbient"),this._uMaterialDiffuse=n.getLocation("materialDiffuse"),this._uMaterialSpecular=n.getLocation("materialSpecular"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=n.getLocation("materialShininess"),i._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=n.getLocation("ambientMapMatrix")),i._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=n.getLocation("diffuseMapMatrix")),i._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=n.getLocation("specularMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),i._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=n.getLocation("reflectivityMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),i._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=n.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=n.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=n.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=n.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=n.getLocation("diffuseFresnelPower")),i._specularFresnel&&(this._uSpecularFresnelEdgeBias=n.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=n.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=n.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=n.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=n.getLocation("specularFresnelPower")),i._alphaFresnel&&(this._uAlphaFresnelEdgeBias=n.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=n.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=n.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=n.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=n.getLocation("alphaFresnelPower")),i._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=n.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=n.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=n.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=n.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=n.getLocation("reflectivityFresnelPower")),i._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=n.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=n.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=n.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=n.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=n.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=n.getLocation("materialBaseColor"),this._uMaterialMetallic=n.getLocation("materialMetallic"),this._uMaterialRoughness=n.getLocation("materialRoughness"),this._uMaterialSpecularF0=n.getLocation("materialSpecularF0"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),i._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=n.getLocation("baseColorMapMatrix")),i._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=n.getLocation("metallicMapMatrix")),i._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=n.getLocation("roughnessMapMatrix")),i._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=n.getLocation("metallicRoughnessMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=n.getLocation("materialDiffuse"),this._uMaterialSpecular=n.getLocation("materialSpecular"),this._uMaterialGlossiness=n.getLocation("materialGlossiness"),this._uMaterialReflectivity=n.getLocation("reflectivityFresnel"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),i._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=n.getLocation("diffuseMapMatrix")),i._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=n.getLocation("specularMapMatrix")),i._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=n.getLocation("glossinessMapMatrix")),i._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=n.getLocation("materialSpecularGlossinessMapMatrix")),i._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),i._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),i._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),i._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix"));break}this._aPosition=n.getAttribute("position"),this._aNormal=n.getAttribute("normal"),this._aUV=n.getAttribute("uv"),this._aColor=n.getAttribute("color"),this._aFlags=n.getAttribute("flags"),this._uClippable=n.getLocation("clippable"),this._uColorize=n.getLocation("colorize"),this._uOffset=n.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0};ji.prototype._bindProgram=function(r){const e=yt.MAX_TEXTURE_UNITS,t=this._scene,i=t.canvas.gl,s=t._lightsState,o=t.camera.project;let a;const n=this._program;if(n.bind(),r.useProgram++,r.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1,i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),t.logarithmicDepthBufferEnabled){const h=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,h)}for(var l=0,c=s.lights.length;l<c;l++)if(a=s.lights[l],this._uLightAmbient[l])i.uniform4f(this._uLightAmbient[l],a.color[0],a.color[1],a.color[2],a.intensity);else if(this._uLightColor[l]&&i.uniform4f(this._uLightColor[l],a.color[0],a.color[1],a.color[2],a.intensity),this._uLightPos[l]&&(i.uniform3fv(this._uLightPos[l],a.pos),this._uLightAttenuation[l]&&i.uniform1f(this._uLightAttenuation[l],a.attenuation)),this._uLightDir[l]&&i.uniform3fv(this._uLightDir[l],a.dir),a.castsShadow){this._uShadowViewMatrix[l]&&i.uniformMatrix4fv(this._uShadowViewMatrix[l],!1,a.getShadowViewMatrix()),this._uShadowProjMatrix[l]&&i.uniformMatrix4fv(this._uShadowProjMatrix[l],!1,a.getShadowProjMatrix());const h=a.getShadowRenderBuf();h&&(n.bindTexture("shadowMap"+l,h.getTexture(),r.textureUnit),r.textureUnit=(r.textureUnit+1)%e,r.bindTexture++)}s.lightMaps.length>0&&s.lightMaps[0].texture&&this._uLightMap&&(n.bindTexture(this._uLightMap,s.lightMaps[0].texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%e,r.bindTexture++),s.reflectionMaps.length>0&&s.reflectionMaps[0].texture&&this._uReflectionMap&&(n.bindTexture(this._uReflectionMap,s.reflectionMaps[0].texture,r.textureUnit),r.textureUnit=(r.textureUnit+1)%e,r.bindTexture++),this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor),this._baseTextureUnit=r.textureUnit};class sv{constructor(e){this.vertex=rv(e),this.fragment=nv(e)}}function rv(r){const e=r.scene,t=e._lightsState,i=ov(r),o=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,a=!!r._geometry._state.compressGeometry,n=r._state.billboard,l=r._state.stationary,c=[];if(c.push("#version 300 es"),c.push("// EmphasisFillShaderSource vertex shader"),c.push("in vec3 position;"),c.push("uniform mat4 modelMatrix;"),c.push("uniform mat4 viewMatrix;"),c.push("uniform mat4 projMatrix;"),c.push("uniform vec4 colorize;"),c.push("uniform vec3 offset;"),a&&c.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(c.push("uniform float logDepthBufFC;"),c.push("out float vFragDepth;"),c.push("bool isPerspectiveMatrix(mat4 m) {"),c.push("    return (m[2][3] == - 1.0);"),c.push("}"),c.push("out float isPerspective;")),o&&c.push("out vec4 vWorldPosition;"),c.push("uniform vec4   lightAmbient;"),c.push("uniform vec4   fillColor;"),i){c.push("in vec3 normal;"),c.push("uniform mat4 modelNormalMatrix;"),c.push("uniform mat4 viewNormalMatrix;");for(let h=0,d=t.lights.length;h<d;h++){const p=t.lights[h];p.type!=="ambient"&&(c.push("uniform vec4 lightColor"+h+";"),p.type==="dir"&&c.push("uniform vec3 lightDir"+h+";"),p.type==="point"&&c.push("uniform vec3 lightPos"+h+";"),p.type==="spot"&&c.push("uniform vec3 lightPos"+h+";"))}a&&(c.push("vec3 octDecode(vec2 oct) {"),c.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),c.push("    if (v.z < 0.0) {"),c.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),c.push("    }"),c.push("    return normalize(v);"),c.push("}"))}if(c.push("out vec4 vColor;"),(n==="spherical"||n==="cylindrical")&&(c.push("void billboard(inout mat4 mat) {"),c.push("   mat[0][0] = 1.0;"),c.push("   mat[0][1] = 0.0;"),c.push("   mat[0][2] = 0.0;"),n==="spherical"&&(c.push("   mat[1][0] = 0.0;"),c.push("   mat[1][1] = 1.0;"),c.push("   mat[1][2] = 0.0;")),c.push("   mat[2][0] = 0.0;"),c.push("   mat[2][1] = 0.0;"),c.push("   mat[2][2] =1.0;"),c.push("}")),c.push("void main(void) {"),c.push("vec4 localPosition = vec4(position, 1.0); "),c.push("vec4 worldPosition;"),a&&c.push("localPosition = positionsDecodeMatrix * localPosition;"),i&&(a?c.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):c.push("vec4 localNormal = vec4(normal, 0.0); "),c.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),c.push("mat4 viewNormalMatrix2 = viewNormalMatrix;")),c.push("mat4 viewMatrix2 = viewMatrix;"),c.push("mat4 modelMatrix2 = modelMatrix;"),l&&c.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),n==="spherical"||n==="cylindrical"?(c.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),c.push("billboard(modelMatrix2);"),c.push("billboard(viewMatrix2);"),c.push("billboard(modelViewMatrix);"),i&&(c.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),c.push("billboard(modelNormalMatrix2);"),c.push("billboard(viewNormalMatrix2);"),c.push("billboard(modelViewNormalMatrix);")),c.push("worldPosition = modelMatrix2 * localPosition;"),c.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(c.push("worldPosition = modelMatrix2 * localPosition;"),c.push("worldPosition.xyz = worldPosition.xyz + offset;"),c.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),i&&c.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);"),c.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),c.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),c.push("float lambertian = 1.0;"),i)for(let h=0,d=t.lights.length;h<d;h++){const p=t.lights[h];if(p.type!=="ambient"){if(p.type==="dir")p.space==="view"?c.push("viewLightDir = normalize(lightDir"+h+");"):c.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+h+", 0.0)).xyz);");else if(p.type==="point")p.space==="view"?c.push("viewLightDir = normalize(lightPos"+h+" - viewPosition.xyz);"):c.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+h+", 0.0)).xyz);");else continue;c.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),c.push("reflectedColor += lambertian * (lightColor"+h+".rgb * lightColor"+h+".a);")}}return c.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),o&&c.push("vWorldPosition = worldPosition;"),r._geometry._state.primitiveName==="points"&&c.push("gl_PointSize = pointSize;"),c.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(c.push("vFragDepth = 1.0 + clipPos.w;"),c.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),c.push("gl_Position = clipPos;"),c.push("}"),c}function ov(r){const e=r._geometry._state.primitiveName;return!!((r._geometry._state.autoVertexNormals||r._geometry._state.normalsBuf)&&(e==="triangles"||e==="triangle-strip"||e==="triangle-fan"))}function nv(r){const e=r.scene,t=r.scene._sectionPlanesState,i=r.scene.gammaOutput,s=t.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Lambertian drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),i&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}")),s){o.push("in vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let a=0,n=t.getNumAllocatedSectionPlanes();a<n;a++)o.push("uniform bool sectionPlaneActive"+a+";"),o.push("uniform vec3 sectionPlanePos"+a+";"),o.push("uniform vec3 sectionPlaneDir"+a+";")}if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),s){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let a=0,n=t.getNumAllocatedSectionPlanes();a<n;a++)o.push("if (sectionPlaneActive"+a+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return r._geometry._state.primitiveName==="points"&&(o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}")),e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i?o.push("outColor = linearToGamma(vColor, gammaFactor);"):o.push("outColor = vColor;"),o.push("}"),o}const Ff=new Di({}),av=A.vec3(),Ti=function(r,e){this.id=Ff.addItem({}),this._hash=r,this._scene=e.scene,this._useCount=0,this._shaderSource=new sv(e),this._allocate(e)},IA={};Ti.get=function(r){const e=[r.scene.id,r.scene.gammaOutput?"go":"",r.scene._sectionPlanesState.getHash(),r._geometry._state.normalsBuf?"n":"",r._geometry._state.compressGeometry?"cp":"",r._state.hash].join(";");let t=IA[e];return t||(t=new Ti(e,r),IA[e]=t,_t.memory.programs++),t._useCount++,t};Ti.prototype.put=function(){--this._useCount===0&&(Ff.removeItem(this.id),this._program&&this._program.destroy(),delete IA[this._hash],_t.memory.programs--)};Ti.prototype.webglContextRestored=function(){this._program=null};Ti.prototype.drawMesh=function(r,e,t){this._program||this._allocate(e);const i=this._scene,s=i.camera,o=i.canvas.gl,a=t===0?e._xrayMaterial._state:t===1?e._highlightMaterial._state:e._selectedMaterial._state,n=e._state,l=e._geometry._state,c=e.origin;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),o.uniformMatrix4fv(this._uViewMatrix,!1,c?r.getRTCViewMatrix(n.originHash,c):s.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.viewNormalMatrix),n.clippable){const h=i._sectionPlanesState.getNumAllocatedSectionPlanes(),d=i._sectionPlanesState.sectionPlanes.length;if(h>0){const p=i._sectionPlanesState.sectionPlanes,m=e.renderFlags;for(let g=0;g<h;g++){const u=this._uSectionPlanes[g];if(u)if(g<d){const x=m.sectionPlanesActivePerLayer[g];if(o.uniform1i(u.active,x?1:0),x){const y=p[g];if(c){const P=kt(y.dist,y.dir,c,av);o.uniform3fv(u.pos,P)}else o.uniform3fv(u.pos,y.pos);o.uniform3fv(u.dir,y.dir)}}else o.uniform1i(u.active,0)}}}if(a.id!==this._lastMaterialId){const h=a.fillColor,d=a.backfaces;r.backfaces!==d&&(d?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),r.backfaces=d),o.uniform4f(this._uFillColor,h[0],h[1],h[2],a.fillAlpha),this._lastMaterialId=a.id}o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,e.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,n.clippable),o.uniform3fv(this._uOffset,n.offset),l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf),r.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(l.normalsBuf),r.bindArray++),l.indicesBuf?(l.indicesBuf.bind(),r.bindArray++):l.positionsBuf,this._lastGeometryId=l.id),l.indicesBuf?(o.drawElements(l.primitive,l.indicesBuf.numItems,l.indicesBuf.itemType,0),r.drawElements++):l.positionsBuf&&(o.drawArrays(o.TRIANGLES,0,l.positionsBuf.numItems),r.drawArrays++)};Ti.prototype._allocate=function(r){const e=r.scene,t=e._lightsState,i=e._sectionPlanesState,s=e.canvas.gl;if(this._program=new Tt(s,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const o=this._program;this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uModelMatrix=o.getLocation("modelMatrix"),this._uModelNormalMatrix=o.getLocation("modelNormalMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(let a=0,n=t.lights.length;a<n;a++)switch(t.lights[a].type){case"ambient":this._uLightAmbient[a]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[a]=o.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=o.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=o.getLocation("lightColor"+a),this._uLightPos[a]=o.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=o.getLocation("lightAttenuation"+a);break}this._uSectionPlanes=[];for(let a=0,n=i.getNumAllocatedSectionPlanes();a<n;a++)this._uSectionPlanes.push({active:o.getLocation("sectionPlaneActive"+a),pos:o.getLocation("sectionPlanePos"+a),dir:o.getLocation("sectionPlaneDir"+a)});this._uFillColor=o.getLocation("fillColor"),this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._uClippable=o.getLocation("clippable"),this._uGammaFactor=o.getLocation("gammaFactor"),this._uOffset=o.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=o.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};Ti.prototype._bindProgram=function(r){const e=this._scene,t=e.canvas.gl,i=e._lightsState,s=e.camera,o=s.project;if(this._program.bind(),r.useProgram++,r.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,t.uniformMatrix4fv(this._uViewNormalMatrix,!1,s.normalMatrix),t.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),e.logarithmicDepthBufferEnabled){const n=2/(Math.log(o.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,n)}for(let n=0,l=i.lights.length;n<l;n++){const c=i.lights[n];this._uLightAmbient[n]?t.uniform4f(this._uLightAmbient[n],c.color[0],c.color[1],c.color[2],c.intensity):(this._uLightColor[n]&&t.uniform4f(this._uLightColor[n],c.color[0],c.color[1],c.color[2],c.intensity),this._uLightPos[n]&&(t.uniform3fv(this._uLightPos[n],c.pos),this._uLightAttenuation[n]&&t.uniform1f(this._uLightAttenuation[n],c.attenuation)),this._uLightDir[n]&&t.uniform3fv(this._uLightDir[n],c.dir))}this._uGammaFactor&&t.uniform1f(this._uGammaFactor,e.gammaFactor)};class lv{constructor(e){this.vertex=Av(e),this.fragment=cv(e)}}function Av(r){const e=r.scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=!!r._geometry._state.compressGeometry,o=r._state.billboard,a=r._state.stationary,n=[];return n.push("#version 300 es"),n.push("// Edges drawing vertex shader"),n.push("in vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform vec4 edgeColor;"),n.push("uniform vec3 offset;"),s&&n.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;")),i&&n.push("out vec4 vWorldPosition;"),n.push("out vec4 vColor;"),(o==="spherical"||o==="cylindrical")&&(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = 1.0;"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),o==="spherical"&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = 1.0;"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}")),n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),n.push("vec4 worldPosition;"),s&&n.push("localPosition = positionsDecodeMatrix * localPosition;"),n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),a&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),o==="spherical"||o==="cylindrical"?(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);"),n.push("billboard(modelViewMatrix);"),n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),n.push("vColor = edgeColor;"),i&&n.push("vWorldPosition = worldPosition;"),n.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),n.push("gl_Position = clipPos;"),n.push("}"),n}function cv(r){const e=r.scene,t=r.scene._sectionPlanesState,i=r.scene.gammaOutput,s=t.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Edges drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),i&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}")),s){o.push("in vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let a=0,n=t.getNumAllocatedSectionPlanes();a<n;a++)o.push("uniform bool sectionPlaneActive"+a+";"),o.push("uniform vec3 sectionPlanePos"+a+";"),o.push("uniform vec3 sectionPlaneDir"+a+";")}if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),s){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let a=0,n=t.getNumAllocatedSectionPlanes();a<n;a++)o.push("if (sectionPlaneActive"+a+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i?o.push("outColor = linearToGamma(vColor, gammaFactor);"):o.push("outColor = vColor;"),o.push("}"),o}const Sf=new Di({}),hv=A.vec3(),vi=function(r,e){this.id=Sf.addItem({}),this._hash=r,this._scene=e.scene,this._useCount=0,this._shaderSource=new lv(e),this._allocate(e)},FA={};vi.get=function(r){const e=[r.scene.id,r.scene.gammaOutput?"go":"",r.scene._sectionPlanesState.getHash(),r._geometry._state.compressGeometry?"cp":"",r._state.hash].join(";");let t=FA[e];return t||(t=new vi(e,r),FA[e]=t,_t.memory.programs++),t._useCount++,t};vi.prototype.put=function(){--this._useCount===0&&(Sf.removeItem(this.id),this._program&&this._program.destroy(),delete FA[this._hash],_t.memory.programs--)};vi.prototype.webglContextRestored=function(){this._program=null};vi.prototype.drawMesh=function(r,e,t){this._program||this._allocate(e);const i=this._scene,s=i.camera,o=i.canvas.gl;let a;const n=e._state,l=e._geometry,c=l._state,h=e.origin;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),o.uniformMatrix4fv(this._uViewMatrix,!1,h?r.getRTCViewMatrix(n.originHash,h):s.viewMatrix),n.clippable){const p=i._sectionPlanesState.getNumAllocatedSectionPlanes(),m=i._sectionPlanesState.sectionPlanes.length;if(p>0){const g=i._sectionPlanesState.sectionPlanes,u=e.renderFlags;for(let x=0;x<p;x++){const y=this._uSectionPlanes[x];if(y)if(x<m){const P=u.sectionPlanesActivePerLayer[x];if(o.uniform1i(y.active,P?1:0),P){const _=g[x];if(h){const b=kt(_.dist,_.dir,h,hv);o.uniform3fv(y.pos,b)}else o.uniform3fv(y.pos,_.pos);o.uniform3fv(y.dir,_.dir)}}else o.uniform1i(y.active,0)}}}switch(t){case 0:a=e._xrayMaterial._state;break;case 1:a=e._highlightMaterial._state;break;case 2:a=e._selectedMaterial._state;break;case 3:default:a=e._edgeMaterial._state;break}if(a.id!==this._lastMaterialId){const p=a.backfaces;if(r.backfaces!==p&&(p?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),r.backfaces=p),r.lineWidth!==a.edgeWidth&&(o.lineWidth(a.edgeWidth),r.lineWidth=a.edgeWidth),this._uEdgeColor){const m=a.edgeColor,g=a.edgeAlpha;o.uniform4f(this._uEdgeColor,m[0],m[1],m[2],g)}this._lastMaterialId=a.id}o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uClippable&&o.uniform1i(this._uClippable,n.clippable),o.uniform3fv(this._uOffset,n.offset);let d;c.primitive===o.TRIANGLES?d=l._getEdgeIndices():c.primitive===o.LINES&&(d=c.indicesBuf),d&&(c.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,c.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(c.positionsBuf,c.compressGeometry?o.UNSIGNED_SHORT:o.FLOAT),r.bindArray++),d.bind(),r.bindArray++,this._lastGeometryId=c.id),o.drawElements(o.LINES,d.numItems,d.itemType,0),r.drawElements++)};vi.prototype._allocate=function(r){const e=r.scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new Tt(t,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let o=0,a=i.getNumAllocatedSectionPlanes();o<a;o++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+o),pos:s.getLocation("sectionPlanePos"+o),dir:s.getLocation("sectionPlaneDir"+o)});this._uEdgeColor=s.getLocation("edgeColor"),this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uGammaFactor=s.getLocation("gammaFactor"),this._uOffset=s.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};vi.prototype._bindProgram=function(r){const e=this._program,t=this._scene,i=t.canvas.gl,o=t.camera.project;if(e.bind(),r.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),t.logarithmicDepthBufferEnabled){const a=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,a)}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)};class uv{constructor(e){this.vertex=dv(e),this.fragment=pv(e)}}function dv(r){const e=r.scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=!!r._geometry._state.compressGeometry,o=r._state.billboard,a=r._state.stationary,n=[];return n.push("#version 300 es"),n.push("// Mesh picking vertex shader"),n.push("in vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("out vec4 vViewPosition;"),n.push("uniform vec3 offset;"),s&&n.push("uniform mat4 positionsDecodeMatrix;"),i&&n.push("out vec4 vWorldPosition;"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;")),(o==="spherical"||o==="cylindrical")&&(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = 1.0;"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),o==="spherical"&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = 1.0;"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}")),n.push("uniform vec2 pickClipPos;"),n.push("vec4 remapClipPos(vec4 clipPos) {"),n.push("    clipPos.xy /= clipPos.w;"),n.push("    clipPos.xy -= pickClipPos;"),n.push("    clipPos.xy *= clipPos.w;"),n.push("    return clipPos;"),n.push("}"),n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),s&&n.push("localPosition = positionsDecodeMatrix * localPosition;"),n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),a&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),(o==="spherical"||o==="cylindrical")&&(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);")),n.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),n.push("   worldPosition.xyz = worldPosition.xyz + offset;"),n.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&n.push("   vWorldPosition = worldPosition;"),n.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),n.push("gl_Position = remapClipPos(clipPos);"),n.push("}"),n}function pv(r){const e=r.scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Mesh picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform vec4 pickColor;"),i){s.push("uniform bool clippable;"),s.push("in vec4 vWorldPosition;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = pickColor; "),s.push("}"),s}const fv=A.vec3(),as=function(r,e){this._hash=r,this._shaderSource=new uv(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},SA={};as.get=function(r){const e=[r.scene.canvas.canvas.id,r.scene._sectionPlanesState.getHash(),r._geometry._state.hash,r._state.hash].join(";");let t=SA[e];if(!t){if(t=new as(e,r),t.errors)return console.log(t.errors.join(`
`)),null;SA[e]=t,_t.memory.programs++}return t._useCount++,t};as.prototype.put=function(){--this._useCount===0&&(this._program&&this._program.destroy(),delete SA[this._hash],_t.memory.programs--)};as.prototype.webglContextRestored=function(){this._program=null};as.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const t=this._scene,i=t.canvas.gl,s=e._state,o=e._material._state,a=e._geometry._state,n=e.origin;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),i.uniformMatrix4fv(this._uViewMatrix,!1,n?r.getRTCPickViewMatrix(s.originHash,n):r.pickViewMatrix),s.clippable){const m=t._sectionPlanesState.getNumAllocatedSectionPlanes(),g=t._sectionPlanesState.sectionPlanes.length;if(m>0){const u=t._sectionPlanesState.sectionPlanes,x=e.renderFlags;for(let y=0;y<m;y++){const P=this._uSectionPlanes[y];if(P)if(y<g){const _=x.sectionPlanesActivePerLayer[y];if(i.uniform1i(P.active,_?1:0),_){const b=u[y];if(n){const B=kt(b.dist,b.dir,n,fv);i.uniform3fv(P.pos,B)}else i.uniform3fv(P.pos,b.pos);i.uniform3fv(P.dir,b.dir)}}else i.uniform1i(P.active,0)}}}if(o.id!==this._lastMaterialId){const m=o.backfaces;r.backfaces!==m&&(m?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),r.backfaces=m);const g=o.frontface;r.frontface!==g&&(g?i.frontFace(i.CCW):i.frontFace(i.CW),r.frontface=g),this._lastMaterialId=o.id}i.uniformMatrix4fv(this._uProjMatrix,!1,r.pickProjMatrix),i.uniformMatrix4fv(this._uModelMatrix,!1,e.worldMatrix),this._uClippable&&i.uniform1i(this._uClippable,e._state.clippable),i.uniform3fv(this._uOffset,e._state.offset),a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),r.bindArray++),a.indicesBuf&&(a.indicesBuf.bind(),r.bindArray++),this._lastGeometryId=a.id);var l=e._state.pickID;const c=l>>24&255,h=l>>16&255,d=l>>8&255,p=l&255;i.uniform4f(this._uPickColor,p/255,d/255,h/255,c/255),i.uniform2fv(this._uPickClipPos,r.pickClipPos),a.indicesBuf?(i.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),r.drawElements++):a.positions&&i.drawArrays(i.TRIANGLES,0,a.positions.numItems)};as.prototype._allocate=function(r){const e=r.scene,t=e.canvas.gl;if(this._program=new Tt(t,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];const s=e._sectionPlanesState.sectionPlanes;for(let o=0,a=s.length;o<a;o++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+o),pos:i.getLocation("sectionPlanePos"+o),dir:i.getLocation("sectionPlaneDir"+o)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._uPickColor=i.getLocation("pickColor"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uOffset=i.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastGeometryId=null};as.prototype._bindProgram=function(r){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),r.useProgram++,e.logarithmicDepthBufferEnabled){const s=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,s)}this._lastMaterialId=null,this._lastGeometryId=null};class mv{constructor(e){this.vertex=gv(e),this.fragment=_v(e)}}function gv(r){const e=r.scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=!!r._geometry._state.compressGeometry,o=[];return o.push("#version 300 es"),o.push("// Surface picking vertex shader"),o.push("in vec3 position;"),o.push("in vec4 color;"),o.push("uniform mat4 modelMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform vec3 offset;"),i&&(o.push("uniform bool clippable;"),o.push("out vec4 vWorldPosition;")),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;")),o.push("uniform vec2 pickClipPos;"),o.push("vec4 remapClipPos(vec4 clipPos) {"),o.push("    clipPos.xy /= clipPos.w;"),o.push("    clipPos.xy -= pickClipPos;"),o.push("    clipPos.xy *= clipPos.w;"),o.push("    return clipPos;"),o.push("}"),o.push("out vec4 vColor;"),s&&o.push("uniform mat4 positionsDecodeMatrix;"),o.push("void main(void) {"),o.push("vec4 localPosition = vec4(position, 1.0); "),s&&o.push("localPosition = positionsDecodeMatrix * localPosition;"),o.push("   vec4 worldPosition = modelMatrix * localPosition; "),o.push("   worldPosition.xyz = worldPosition.xyz + offset;"),o.push("   vec4 viewPosition = viewMatrix * worldPosition;"),i&&o.push("   vWorldPosition = worldPosition;"),o.push("   vColor = color;"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),o.push("gl_Position = remapClipPos(clipPos);"),o.push("}"),o}function _v(r){const e=r.scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Surface picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in vec4 vColor;"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("uniform bool clippable;"),s.push("in vec4 vWorldPosition;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vColor;"),s.push("}"),s}const vv=A.vec3(),Ws=function(r,e){this._hash=r,this._scene=e.scene,this._useCount=0,this._shaderSource=new mv(e),this._allocate(e)},TA={};Ws.get=function(r){const e=[r.scene.canvas.canvas.id,r.scene._sectionPlanesState.getHash(),r._geometry._state.compressGeometry?"cp":"",r._state.hash].join(";");let t=TA[e];if(!t){if(t=new Ws(e,r),t.errors)return console.log(t.errors.join(`
`)),null;TA[e]=t,_t.memory.programs++}return t._useCount++,t};Ws.prototype.put=function(){--this._useCount===0&&(this._program&&this._program.destroy(),delete TA[this._hash],_t.memory.programs--)};Ws.prototype.webglContextRestored=function(){this._program=null};Ws.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const t=this._scene,i=t.canvas.gl,s=e._state,o=e._material._state,a=e._geometry,n=e._geometry._state,l=e.origin,c=o.backfaces,h=o.frontface,d=t.camera.project,p=a._getPickTrianglePositions(),m=a._getPickTriangleColors();if(this._program.bind(),r.useProgram++,t.logarithmicDepthBufferEnabled){const g=2/(Math.log(d.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,g)}if(i.uniformMatrix4fv(this._uViewMatrix,!1,l?r.getRTCPickViewMatrix(s.originHash,l):r.pickViewMatrix),s.clippable){const g=t._sectionPlanesState.getNumAllocatedSectionPlanes(),u=t._sectionPlanesState.sectionPlanes.length;if(g>0){const x=t._sectionPlanesState.sectionPlanes,y=e.renderFlags;for(let P=0;P<g;P++){const _=this._uSectionPlanes[P];if(_)if(P<u){const b=y.sectionPlanesActivePerLayer[P];if(i.uniform1i(_.active,b?1:0),b){const B=x[P];if(l){const w=kt(B.dist,B.dir,l,vv);i.uniform3fv(_.pos,w)}else i.uniform3fv(_.pos,B.pos);i.uniform3fv(_.dir,B.dir)}}else i.uniform1i(_.active,0)}}}i.uniformMatrix4fv(this._uProjMatrix,!1,r.pickProjMatrix),t.logarithmicDepthBufferEnabled&&i.uniform1f(this._uZFar,t.camera.project.far),r.backfaces!==c&&(c?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),r.backfaces=c),r.frontface!==h&&(h?i.frontFace(i.CCW):i.frontFace(i.CW),r.frontface=h),i.uniformMatrix4fv(this._uModelMatrix,!1,e.worldMatrix),this._uClippable&&i.uniform1i(this._uClippable,e._state.clippable),i.uniform3fv(this._uOffset,e._state.offset),this._uPositionsDecodeMatrix?(i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(p,n.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT)):this._aPosition.bindArrayBuffer(p),i.uniform2fv(this._uPickClipPos,r.pickClipPos),m.bind(),i.enableVertexAttribArray(this._aColor.location),i.vertexAttribPointer(this._aColor.location,m.itemSize,m.itemType,!0,0,0),i.drawArrays(n.primitive,0,p.numItems/3)};Ws.prototype._allocate=function(r){const e=r.scene,t=e.canvas.gl;if(this._program=new Tt(t,this._shaderSource),this._useCount=0,this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];const s=e._sectionPlanesState.sectionPlanes;for(let o=0,a=s.length;o<a;o++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+o),pos:i.getLocation("sectionPlanePos"+o),dir:i.getLocation("sectionPlaneDir"+o)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uClippable=i.getLocation("clippable"),this._uOffset=i.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))};class Pv{constructor(e){this.vertex=xv(e),this.fragment=yv(e)}}function xv(r){const e=r.scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=!!r._geometry._state.compressGeometry,o=r._state.billboard,a=r._state.stationary,n=[];return n.push("#version 300 es"),n.push("// Mesh occlusion vertex shader"),n.push("in vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform vec3 offset;"),s&&n.push("uniform mat4 positionsDecodeMatrix;"),i&&n.push("out vec4 vWorldPosition;"),e.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;")),(o==="spherical"||o==="cylindrical")&&(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = 1.0;"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),o==="spherical"&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = 1.0;"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}")),n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),n.push("vec4 worldPosition;"),s&&n.push("localPosition = positionsDecodeMatrix * localPosition;"),n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),a&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"),o==="spherical"||o==="cylindrical"?(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);"),n.push("billboard(modelViewMatrix);"),n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix2 * worldPosition; ")),i&&n.push("   vWorldPosition = worldPosition;"),n.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),n.push("gl_Position = clipPos;"),n.push("}"),n}function yv(r){const e=r.scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Mesh occlusion fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("uniform bool clippable;"),s.push("in vec4 vWorldPosition;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}const bv=A.vec3(),ls=function(r,e){this._hash=r,this._shaderSource=new Pv(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},DA={};ls.get=function(r){const e=[r.scene.canvas.canvas.id,r.scene._sectionPlanesState.getHash(),r._geometry._state.hash,r._state.occlusionHash].join(";");let t=DA[e];if(!t){if(t=new ls(e,r),t.errors)return console.log(t.errors.join(`
`)),null;DA[e]=t,_t.memory.programs++}return t._useCount++,t};ls.prototype.put=function(){--this._useCount===0&&(this._program&&this._program.destroy(),delete DA[this._hash],_t.memory.programs--)};ls.prototype.webglContextRestored=function(){this._program=null};ls.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const t=this._scene,i=t.canvas.gl,s=e._material._state,o=e._state,a=e._geometry._state,n=e.origin;if(s.alpha<1)return;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),s.id!==this._lastMaterialId){const c=s.backfaces;r.backfaces!==c&&(c?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),r.backfaces=c);const h=s.frontface;r.frontface!==h&&(h?i.frontFace(i.CCW):i.frontFace(i.CW),r.frontface=h),this._lastMaterialId=s.id}const l=t.camera;if(i.uniformMatrix4fv(this._uViewMatrix,!1,n?r.getRTCViewMatrix(o.originHash,n):l.viewMatrix),o.clippable){const c=t._sectionPlanesState.getNumAllocatedSectionPlanes(),h=t._sectionPlanesState.sectionPlanes.length;if(c>0){const d=t._sectionPlanesState.sectionPlanes,p=e.renderFlags;for(let m=0;m<c;m++){const g=this._uSectionPlanes[m];if(g)if(m<h){const u=p.sectionPlanesActivePerLayer[m];if(i.uniform1i(g.active,u?1:0),u){const x=d[m];if(n){const y=kt(x.dist,x.dir,n,bv);i.uniform3fv(g.pos,y)}else i.uniform3fv(g.pos,x.pos);i.uniform3fv(g.dir,x.dir)}}else i.uniform1i(g.active,0)}}}i.uniformMatrix4fv(this._uProjMatrix,!1,l._project._state.matrix),i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,e.worldMatrix),this._uClippable&&i.uniform1i(this._uClippable,e._state.clippable),i.uniform3fv(this._uOffset,e._state.offset),a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),r.bindArray++),a.indicesBuf&&(a.indicesBuf.bind(),r.bindArray++),this._lastGeometryId=a.id),a.indicesBuf?(i.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),r.drawElements++):a.positions&&i.drawArrays(i.TRIANGLES,0,a.positions.numItems)};ls.prototype._allocate=function(r){const e=r.scene,t=e.canvas.gl;if(this._program=new Tt(t,this._shaderSource),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];const s=e._sectionPlanesState.sectionPlanes;for(let o=0,a=s.length;o<a;o++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+o),pos:i.getLocation("sectionPlanePos"+o),dir:i.getLocation("sectionPlaneDir"+o)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._uOffset=i.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};ls.prototype._bindProgram=function(r){const e=this._scene,t=e.camera.project,i=e.canvas.gl;if(this._program.bind(),r.useProgram++,i.uniformMatrix4fv(this._uProjMatrix,!1,t.matrix),e.logarithmicDepthBufferEnabled){const s=2/(Math.log(t.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,s)}this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};class Bv{constructor(e){this.vertex=wv(e),this.fragment=Cv(e)}}function wv(r){const t=r.scene._sectionPlanesState.sectionPlanes.length>0,i=!!r._geometry._state.compressGeometry,s=[];return s.push("// Mesh shadow vertex shader"),s.push("in vec3 position;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),s.push("uniform vec3 offset;"),i&&s.push("uniform mat4 positionsDecodeMatrix;"),t&&s.push("out vec4 vWorldPosition;"),s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),s.push("vec4 worldPosition;"),i&&s.push("localPosition = positionsDecodeMatrix * localPosition;"),s.push("worldPosition = modelMatrix * localPosition;"),s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&s.push("vWorldPosition = worldPosition;"),s.push("   gl_Position = shadowProjMatrix * viewPosition;"),s.push("}"),s}function Cv(r){const e=r.scene;e.canvas.gl;const t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("// Mesh shadow fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i){s.push("uniform bool clippable;"),s.push("in vec4 vWorldPosition;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("vec4 encodeFloat( const in float depth ) {"),s.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),s.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),s.push("  vec4 comp = fract(depth * bitShift);"),s.push("  comp -= comp.xxyz * bitMask;"),s.push("  return comp;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("if (clippable) {"),s.push("  float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("outColor = encodeFloat(gl_FragCoord.z);"),s.push("}"),s}const Ms=function(r,e){this._hash=r,this._shaderSource=new Bv(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},RA={};Ms.get=function(r){const e=r.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash(),r._geometry._state.hash,r._state.hash].join(";");let i=RA[t];if(!i){if(i=new Ms(t,r),i.errors)return console.log(i.errors.join(`
`)),null;RA[t]=i,_t.memory.programs++}return i._useCount++,i};Ms.prototype.put=function(){--this._useCount===0&&(this._program&&this._program.destroy(),delete RA[this._hash],_t.memory.programs--)};Ms.prototype.webglContextRestored=function(){this._program=null};Ms.prototype.drawMesh=function(r,e){this._program||this._allocate(e);const i=this._scene.canvas.gl,s=e._material._state,o=e._geometry._state;if(r.lastProgramId!==this._program.id&&(r.lastProgramId=this._program.id,this._bindProgram(r)),s.id!==this._lastMaterialId){const a=s.backfaces;r.backfaces!==a&&(a?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),r.backfaces=a);const n=s.frontface;r.frontface!==n&&(n?i.frontFace(i.CCW):i.frontFace(i.CW),r.frontface=n),r.lineWidth!==s.lineWidth&&(i.lineWidth(s.lineWidth),r.lineWidth=s.lineWidth),this._uPointSize&&i.uniform1i(this._uPointSize,s.pointSize),this._lastMaterialId=s.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,e.worldMatrix),o.combineGeometry){const a=e.vertexBufs;a.id!==this._lastVertexBufsId&&(a.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),r.bindArray++),this._lastVertexBufsId=a.id)}this._uClippable&&i.uniform1i(this._uClippable,e._state.clippable),i.uniform3fv(this._uOffset,e._state.offset),o.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,o.positionsDecodeMatrix),o.combineGeometry?o.indicesBufCombined&&(o.indicesBufCombined.bind(),r.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(o.positionsBuf,o.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),r.bindArray++),o.indicesBuf&&(o.indicesBuf.bind(),r.bindArray++)),this._lastGeometryId=o.id),o.combineGeometry?o.indicesBufCombined&&(i.drawElements(o.primitive,o.indicesBufCombined.numItems,o.indicesBufCombined.itemType,0),r.drawElements++):o.indicesBuf?(i.drawElements(o.primitive,o.indicesBuf.numItems,o.indicesBuf.itemType,0),r.drawElements++):o.positions&&(i.drawArrays(i.TRIANGLES,0,o.positions.numItems),r.drawArrays++)};Ms.prototype._allocate=function(r){const e=r.scene,t=e.canvas.gl;if(this._program=new Tt(t,this._shaderSource),this._scene=e,this._useCount=0,this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uModelMatrix=i.getLocation("modelMatrix"),this._uShadowViewMatrix=i.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=i.getLocation("shadowProjMatrix"),this._uSectionPlanes={};const s=e._sectionPlanesState.sectionPlanes;for(let o=0,a=s.length;o<a;o++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+o),pos:i.getLocation("sectionPlanePos"+o),dir:i.getLocation("sectionPlaneDir"+o)});this._aPosition=i.getAttribute("position"),this._uClippable=i.getLocation("clippable"),this._uOffset=i.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};Ms.prototype._bindProgram=function(r){this._program||this._allocate(mesh);const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program.bind(),r.useProgram++,t.uniformMatrix4fv(this._uShadowViewMatrix,!1,r.shadowViewMatrix),t.uniformMatrix4fv(this._uShadowProjMatrix,!1,r.shadowProjMatrix),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,i.getNumAllocatedSectionPlanes()>0){let s,o,a,n,l;for(let c=0,h=this._uSectionPlanes.length;c<h;c++)s=this._uSectionPlanes[c],o=s.active,a=i.sectionPlanes[c],o&&t.uniform1i(o,a.active),n=s.pos,n&&t.uniform3fv(s.pos,a.pos),l=s.dir,l&&t.uniform3fv(s.dir,a.dir)}};class Tf{constructor(){this.visibleLayers=[],this.sectionPlanesActivePerLayer=[],this.reset()}reset(){this.culled=!1,this.sectioned=!1,this.numLayers=0,this.numVisibleLayers=0,this.colorOpaque=!1,this.colorTransparent=!1,this.edgesOpaque=!1,this.edgesTransparent=!1,this.xrayedSilhouetteOpaque=!1,this.xrayedEdgesOpaque=!1,this.xrayedSilhouetteTransparent=!1,this.xrayedEdgesTransparent=!1,this.highlightedSilhouetteOpaque=!1,this.highlightedEdgesOpaque=!1,this.highlightedSilhouetteTransparent=!1,this.highlightedEdgesTransparent=!1,this.selectedSilhouetteOpaque=!1,this.selectedEdgesOpaque=!1,this.selectedSilhouetteTransparent=!1,this.selectedEdgesTransparent=!1}}const Uh=A.OBB3(),Ui=A.vec4(),jr=A.vec4(),Oh=A.vec4(),kh=A.vec3([1,0,0]),Nh=A.vec3([0,1,0]),Qh=A.vec3([0,0,1]),Vh=A.vec3(3),Hh=A.vec3(3),Mv=A.identityMat4();class ct extends vt{constructor(e,t={}){super(e,t),this.renderOrder=t.renderOrder||0,this.originalSystemId=t.originalSystemId||this.id,this.renderFlags=new Tf,this._state=new Mt({visible:!0,culled:!1,pickable:null,clippable:null,collidable:null,occluder:t.occluder!==!1,castsShadow:null,receivesShadow:null,xrayed:!1,highlighted:!1,selected:!1,edges:!1,stationary:!!t.stationary,background:!!t.background,billboard:this._checkBillboard(t.billboard),layer:null,colorize:null,pickID:this.scene._renderer.getPickID(this),drawHash:"",pickHash:"",offset:A.vec3(),origin:null,originHash:null}),this._drawRenderer=null,this._shadowRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._occlusionRenderer=null,this._geometry=t.geometry?this._checkComponent2(["ReadableGeometry","VBOGeometry"],t.geometry):this.scene.geometry,this._material=t.material?this._checkComponent2(["PhongMaterial","MetallicMaterial","SpecularMaterial","LambertMaterial"],t.material):this.scene.material,this._xrayMaterial=t.xrayMaterial?this._checkComponent("EmphasisMaterial",t.xrayMaterial):this.scene.xrayMaterial,this._highlightMaterial=t.highlightMaterial?this._checkComponent("EmphasisMaterial",t.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=t.selectedMaterial?this._checkComponent("EmphasisMaterial",t.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=t.edgeMaterial?this._checkComponent("EdgeMaterial",t.edgeMaterial):this.scene.edgeMaterial,this._parentNode=null,this._aabb=null,this._aabbDirty=!0,this._numTriangles=this._geometry?this._geometry.numTriangles:0,this.scene._aabbDirty=!0,this._scale=A.vec3(),this._quaternion=A.identityQuaternion(),this._rotation=A.vec3(),this._position=A.vec3(),this._worldMatrix=A.identityMat4(),this._worldNormalMatrix=A.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0;const i=t.origin||t.rtcCenter;if(i&&(this._state.origin=A.vec3(i),this._state.originHash=i.join()),t.matrix?this.matrix=t.matrix:(this.scale=t.scale,this.position=t.position,t.quaternion||(this.rotation=t.rotation)),this._isObject=t.isObject,this._isObject&&this.scene._registerObject(this),this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.layer=t.layer,this.colorize=t.colorize,this.opacity=t.opacity,this.offset=t.offset,t.parentId){const s=this.scene.components[t.parentId];s?s.isNode?s.addChild(this):this.error("Parent is not a Node: '"+t.parentId+"'"):this.error("Parent not found: '"+t.parentId+"'"),this._parentNode=s}else t.parent&&(t.parent.isNode||this.error("Parent is not a Node"),t.parent.addChild(this),this._parentNode=t.parent);this.compile()}get type(){return"Mesh"}get isMesh(){return!0}get parent(){return this._parentNode}get geometry(){return this._geometry}get material(){return this._material}get position(){return this._position}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set rotation(e){this._rotation.set(e||[0,0,0]),A.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),A.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=A.identityMat4()),A.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix}set matrix(e){this.__localMatrix||(this.__localMatrix=A.identityMat4()),this.__localMatrix.set(e||Mv),A.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}get origin(){return this._state.origin}set origin(e){e?(this._state.origin||(this._state.origin=A.vec3()),this._state.origin.set(e),this._state.originHash=e.join(),this._setAABBDirty(),this.scene._aabbDirty=!0):this._state.origin&&(this._state.origin=null,this._state.originHash=null,this._setAABBDirty(),this.scene._aabbDirty=!0)}get rtcCenter(){return this.origin}set rtcCenter(e){this.origin=e}get numTriangles(){return this._numTriangles}get visible(){return this._state.visible}set visible(e){e=e!==!1,this._state.visible=e,this._isObject&&this.scene._objectVisibilityUpdated(this,e),this.glRedraw()}get xrayed(){return this._state.xrayed}set xrayed(e){e=!!e,this._state.xrayed!==e&&(this._state.xrayed=e,this._isObject&&this.scene._objectXRayedUpdated(this,e),this.glRedraw())}get highlighted(){return this._state.highlighted}set highlighted(e){e=!!e,e!==this._state.highlighted&&(this._state.highlighted=e,this._isObject&&this.scene._objectHighlightedUpdated(this,e),this.glRedraw())}get selected(){return this._state.selected}set selected(e){e=!!e,e!==this._state.selected&&(this._state.selected=e,this._isObject&&this.scene._objectSelectedUpdated(this,e),this.glRedraw())}get edges(){return this._state.edges}set edges(e){e=!!e,e!==this._state.edges&&(this._state.edges=e,this.glRedraw())}get culled(){return this._state.culled}set culled(e){this._state.culled=!!e,this.glRedraw()}get clippable(){return this._state.clippable}set clippable(e){e=e!==!1,this._state.clippable!==e&&(this._state.clippable=e,this.glRedraw())}get collidable(){return this._state.collidable}set collidable(e){e=e!==!1,e!==this._state.collidable&&(this._state.collidable=e,this._setAABBDirty(),this.scene._aabbDirty=!0)}get pickable(){return this._state.pickable}set pickable(e){e=e!==!1,this._state.pickable!==e&&(this._state.pickable=e)}get castsShadow(){return this._state.castsShadow}set castsShadow(e){e=e!==!1,e!==this._state.castsShadow&&(this._state.castsShadow=e,this.glRedraw())}get receivesShadow(){return this._state.receivesShadow}set receivesShadow(e){e=e!==!1,e!==this._state.receivesShadow&&(this._state.receivesShadow=e,this._state.hash=e?"/mod/rs;":"/mod;",this.fire("dirty",this))}get saoEnabled(){return!1}get colorize(){return this._state.colorize}set colorize(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);const i=!!e;this.scene._objectColorizeUpdated(this,i),this.glRedraw()}get opacity(){return this._state.colorize[3]}set opacity(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[0]=1,t[1]=1,t[2]=1);const i=e!=null;t[3]=i?e:1,this.scene._objectOpacityUpdated(this,i),this.glRedraw()}get transparent(){return this._material.alphaMode===2||this._state.colorize[3]<1}get layer(){return this._state.layer}set layer(e){e=e||0,e=Math.round(e),e!==this._state.layer&&(this._state.layer=e,this._renderer.needStateSort())}get stationary(){return this._state.stationary}get billboard(){return this._state.billboard}get offset(){return this._state.offset}set offset(e){this._state.offset.set(e||[0,0,0]),this._setAABBDirty(),this.glRedraw()}get isDrawable(){return!0}get isStateSortable(){return!0}get xrayMaterial(){return this._xrayMaterial}get highlightMaterial(){return this._highlightMaterial}get selectedMaterial(){return this._selectedMaterial}get edgeMaterial(){return this._edgeMaterial}_checkBillboard(e){return e=e||"none",e!=="spherical"&&e!=="cylindrical"&&e!=="none"&&(this.error("Unsupported value for 'billboard': "+e+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),e="none"),e}compile(){const e=this._makeDrawHash();this._state.drawHash!==e&&(this._state.drawHash=e,this._putDrawRenderers(),this._drawRenderer=ji.get(this),this._emphasisFillRenderer=Ti.get(this),this._emphasisEdgesRenderer=vi.get(this));const t=this._makePickHash();if(this._state.pickHash!==t&&(this._state.pickHash=t,this._putPickRenderers(),this._pickMeshRenderer=as.get(this)),this._state.occluder){const i=this._makeOcclusionHash();this._state.occlusionHash!==i&&(this._state.occlusionHash=i,this._putOcclusionRenderer(),this._occlusionRenderer=ls.get(this))}}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0}_buildWorldMatrix(){const e=this.matrix;if(this._parentNode)A.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_buildWorldNormalMatrix(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=A.mat4()),A.transposeMat4(this._worldMatrix,this._worldNormalMatrix),A.inverseMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1}_setAABBDirty(){if(this.collidable)for(let e=this;e;e=e._parentNode)e._aabbDirty=!0}_updateAABB(){this.scene._aabbDirty=!0,this._aabb||(this._aabb=A.AABB3()),this._buildAABB(this.worldMatrix,this._aabb),this._aabbDirty=!1}_webglContextRestored(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._shadowRenderer&&this._shadowRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored(),this._occlusionRenderer&&this._occlusionRenderer.webglContextRestored()}_makeDrawHash(){const e=this.scene,t=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),i.billboard==="none"?t.push("/n"):i.billboard==="spherical"?t.push("/s"):i.billboard==="cylindrical"&&t.push("/c"),i.receivesShadow&&t.push("/rs"),t.push(";"),t.join("")}_makePickHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),i.billboard==="none"?t.push("/n"):i.billboard==="spherical"?t.push("/s"):i.billboard==="cylindrical"&&t.push("/c"),t.push(";"),t.join("")}_makeOcclusionHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),i.billboard==="none"?t.push("/n"):i.billboard==="spherical"?t.push("/s"):i.billboard==="cylindrical"&&t.push("/c"),t.push(";"),t.join("")}_buildAABB(e,t){A.transformOBB3(e,this._geometry.obb,Uh),A.OBB3ToAABB3(Uh,t);const i=this._state.offset;if(t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[0],t[4]+=i[1],t[5]+=i[2],this._state.origin){const s=this._state.origin;t[0]+=s[0],t[1]+=s[1],t[2]+=s[2],t[3]+=s[0],t[4]+=s[1],t[5]+=s[2]}}rotate(e,t){return Ui[0]=e[0],Ui[1]=e[1],Ui[2]=e[2],Ui[3]=t*A.DEGTORAD,A.angleAxisToQuaternion(Ui,jr),A.mulQuaternions(this.quaternion,jr,Oh),this.quaternion=Oh,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(e,t){return Ui[0]=e[0],Ui[1]=e[1],Ui[2]=e[2],Ui[3]=t*A.DEGTORAD,A.angleAxisToQuaternion(Ui,jr),A.mulQuaternions(jr,this.quaternion,jr),this}rotateX(e){return this.rotate(kh,e)}rotateY(e){return this.rotate(Nh,e)}rotateZ(e){return this.rotate(Qh,e)}translate(e,t){return A.vec3ApplyQuaternion(this.quaternion,e,Vh),A.mulVec3Scalar(Vh,t,Hh),A.addVec3(this.position,Hh,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(e){return this.translate(kh,e)}translateY(e){return this.translate(Nh,e)}translateZ(e){return this.translate(Qh,e)}_putDrawRenderers(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null)}_putPickRenderers(){this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null)}_putOcclusionRenderer(){this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null)}stateSortCompare(e,t){return e._state.layer-t._state.layer||e._drawRenderer.id-t._drawRenderer.id||e._material._state.id-t._material._state.id||e._geometry._state.id-t._geometry._state.id}rebuildRenderFlags(){if(this.renderFlags.reset(),!this._getActiveSectionPlanes()){this.renderFlags.culled=!0;return}this.renderFlags.numLayers=1,this.renderFlags.numVisibleLayers=1,this.renderFlags.visibleLayers[0]=0,this._updateRenderFlags()}_updateRenderFlags(){const e=this.renderFlags,t=this._state;if(t.xrayed){const i=this._xrayMaterial._state;i.fill&&(i.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),i.edges&&(i.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}else if(this._material._state.alpha<1||t.colorize[3]<1?e.colorTransparent=!0:e.colorOpaque=!0,t.edges&&(this._edgeMaterial._state.alpha<1?e.edgesTransparent=!0:e.edgesOpaque=!0),t.selected){const s=this._selectedMaterial._state;s.fill&&(s.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),s.edges&&(s.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}else if(t.highlighted){const s=this._highlightMaterial._state;s.fill&&(s.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),s.edges&&(s.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}_getActiveSectionPlanes(){if(this._state.clippable){const e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(let i=0;i<t;i++){const s=e[i],o=this.renderFlags;if(!s.active)o.sectionPlanesActivePerLayer[i]=!1;else if(this._state.origin){const a=A.planeAABB3Intersect(s.dir,s.dist,this.aabb);if(a===-1)return!1;const l=a===0;o.sectionPlanesActivePerLayer[i]=l}else o.sectionPlanesActivePerLayer[i]=!0}}return!0}drawColorOpaque(e){(this._drawRenderer||(this._drawRenderer=ji.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawColorTransparent(e){(this._drawRenderer||(this._drawRenderer=ji.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawSilhouetteXRayed(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Ti.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,0)}drawSilhouetteHighlighted(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Ti.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,1)}drawSilhouetteSelected(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Ti.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,2)}drawEdgesColorOpaque(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawEdgesColorTransparent(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawEdgesXRayed(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,0)}drawEdgesHighlighted(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,1)}drawEdgesSelected(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=vi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,2)}drawOcclusion(e){(this._state.occluder&&this._occlusionRenderer||(this._occlusionRenderer=ls.get(this)))&&this._occlusionRenderer.drawMesh(e,this)}drawShadow(e){(this._shadowRenderer||(this._shadowRenderer=Ms.get(this)))&&this._shadowRenderer.drawMesh(e,this)}drawPickMesh(e){(this._pickMeshRenderer||(this._pickMeshRenderer=as.get(this)))&&this._pickMeshRenderer.drawMesh(e,this)}canPickTriangle(){return this._geometry.isReadableGeometry}drawPickTriangles(e){(this._pickTriangleRenderer||(this._pickTriangleRenderer=Ws.get(this)))&&this._pickTriangleRenderer.drawMesh(e,this)}pickTriangleSurface(e,t,i,s){Ev(this,e,t,i,s)}drawPickVertices(e){}delegatePickedEntity(){return this}destroy(){super.destroy(),this._putDrawRenderers(),this._putPickRenderers(),this._putOcclusionRenderer(),this.scene._renderer.putPickID(this._state.pickID),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.offset.some(e=>e!==0)&&this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this.glRedraw()}}const Ev=function(){const r=A.vec3(),e=A.vec3(),t=A.vec3(),i=A.vec3(),s=A.vec3(),o=A.vec3(),a=A.vec4(),n=A.vec3(),l=A.vec3(),c=A.vec3(),h=A.vec3(),d=A.vec3(),p=A.vec3(),m=A.vec3(),g=A.vec3(),u=A.vec3(),x=A.vec4(),y=A.vec4(),P=A.vec4(),_=A.vec3(),b=A.vec3(),B=A.vec3(),w=A.vec3(),C=A.vec3(),E=A.vec3(),I=A.vec3(),R=A.vec3(),F=A.vec3(),z=A.vec3(),Q=A.vec3();return function(H,ae,pe,ge,fe){var Me=fe.primIndex;if(Me!=null&&Me>-1){const Te=H.geometry._state,Ne=H.scene,Be=Ne.camera,Se=Ne.canvas;if(Te.primitiveName==="triangles"){fe.primitive="triangle";const S=Me,k=Te.indices,D=Te.positions;let G,se,le;if(k){var be=k[S+0],Fe=k[S+1],Re=k[S+2];o[0]=be,o[1]=Fe,o[2]=Re,fe.indices=o,G=be*3,se=Fe*3,le=Re*3}else G=S*3,se=G+3,le=se+3;if(t[0]=D[G+0],t[1]=D[G+1],t[2]=D[G+2],i[0]=D[se+0],i[1]=D[se+1],i[2]=D[se+2],s[0]=D[le+0],s[1]=D[le+1],s[2]=D[le+2],Te.compressGeometry){const Y=Te.positionsDecodeMatrix;Y&&(at.decompressPosition(t,Y,t),at.decompressPosition(i,Y,i),at.decompressPosition(s,Y,s))}fe.canvasPos?A.canvasPosToLocalRay(Se.canvas,H.origin?Pt(ae,H.origin):ae,pe,ge,H.worldMatrix,fe.canvasPos,r,e):fe.origin&&fe.direction&&A.worldRayToLocalRay(H.worldMatrix,fe.origin,fe.direction,r,e),A.normalizeVec3(e),A.rayPlaneIntersect(r,e,t,i,s,a),fe.localPos=a,fe.position=a,x[0]=a[0],x[1]=a[1],x[2]=a[2],x[3]=1,A.transformVec4(H.worldMatrix,x,y),n[0]=y[0],n[1]=y[1],n[2]=y[2],fe.canvasPos&&H.origin&&(n[0]+=H.origin[0],n[1]+=H.origin[1],n[2]+=H.origin[2]),fe.worldPos=n,A.transformVec4(Be.matrix,y,P),l[0]=P[0],l[1]=P[1],l[2]=P[2],fe.viewPos=l,A.cartesianToBarycentric(a,t,i,s,c),fe.bary=c;const te=Te.normals;if(te){if(Te.compressGeometry){const ne=be*3,Ae=Fe*3,$=Re*3;at.decompressNormal(te.subarray(ne,ne+2),h),at.decompressNormal(te.subarray(Ae,Ae+2),d),at.decompressNormal(te.subarray($,$+2),p)}else h[0]=te[G],h[1]=te[G+1],h[2]=te[G+2],d[0]=te[se],d[1]=te[se+1],d[2]=te[se+2],p[0]=te[le],p[1]=te[le+1],p[2]=te[le+2];const Y=A.addVec3(A.addVec3(A.mulVec3Scalar(h,c[0],_),A.mulVec3Scalar(d,c[1],b),B),A.mulVec3Scalar(p,c[2],w),C);fe.worldNormal=A.normalizeVec3(A.transformVec3(H.worldNormalMatrix,Y,E))}const oe=Te.uv;if(oe){if(m[0]=oe[be*2],m[1]=oe[be*2+1],g[0]=oe[Fe*2],g[1]=oe[Fe*2+1],u[0]=oe[Re*2],u[1]=oe[Re*2+1],Te.compressGeometry){const Y=Te.uvDecodeMatrix;Y&&(at.decompressUV(m,Y,m),at.decompressUV(g,Y,g),at.decompressUV(u,Y,u))}fe.uv=A.addVec3(A.addVec3(A.mulVec2Scalar(m,c[0],I),A.mulVec2Scalar(g,c[1],R),F),A.mulVec2Scalar(u,c[2],z),Q)}}}}}();function _r(r={}){let e=r.radiusTop||1;e<0&&(console.error("negative radiusTop not allowed - will invert"),e*=-1);let t=r.radiusBottom||1;t<0&&(console.error("negative radiusBottom not allowed - will invert"),t*=-1);let i=r.height||1;i<0&&(console.error("negative height not allowed - will invert"),i*=-1);let s=r.radialSegments||32;s<0&&(console.error("negative radialSegments not allowed - will invert"),s*=-1),s<3&&(s=3);let o=r.heightSegments||1;o<0&&(console.error("negative heightSegments not allowed - will invert"),o*=-1),o<1&&(o=1);const a=!!r.openEnded;let n=r.center;const l=n?n[0]:0,c=n?n[1]:0,h=n?n[2]:0,d=i/2,p=i/o,m=2*Math.PI/s,g=1/s,u=(e-t)/o,x=[],y=[],P=[],_=[];let b,B,w,C,E,I,R,F,z,Q,H;const ae=(90-Math.atan(i/(t-e))*180/Math.PI)/90;for(b=0;b<=o;b++)for(E=e-b*u,I=d-b*p,B=0;B<=s;B++)w=Math.sin(B*m),C=Math.cos(B*m),y.push(E*w),y.push(ae),y.push(E*C),P.push(B*g),P.push(b*1/o),x.push(E*w+l),x.push(I+c),x.push(E*C+h);for(b=0;b<o;b++)for(B=0;B<=s;B++)R=b*(s+1)+B,F=R+s,_.push(R),_.push(F),_.push(F+1),_.push(R),_.push(F+1),_.push(R+1);if(!a&&e>0){for(z=x.length/3,y.push(0),y.push(1),y.push(0),P.push(.5),P.push(.5),x.push(0+l),x.push(d+c),x.push(0+h),B=0;B<=s;B++)w=Math.sin(B*m),C=Math.cos(B*m),Q=.5*Math.sin(B*m)+.5,H=.5*Math.cos(B*m)+.5,y.push(e*w),y.push(1),y.push(e*C),P.push(Q),P.push(H),x.push(e*w+l),x.push(d+c),x.push(e*C+h);for(B=0;B<s;B++)n=z,R=z+1+B,_.push(R),_.push(R+1),_.push(n)}if(!a&&t>0){for(z=x.length/3,y.push(0),y.push(-1),y.push(0),P.push(.5),P.push(.5),x.push(0+l),x.push(0-d+c),x.push(0+h),B=0;B<=s;B++)w=Math.sin(B*m),C=Math.cos(B*m),Q=.5*Math.sin(B*m)+.5,H=.5*Math.cos(B*m)+.5,y.push(t*w),y.push(-1),y.push(t*C),P.push(Q),P.push(H),x.push(t*w+l),x.push(0-d+c),x.push(t*C+h);for(B=0;B<s;B++)n=z,R=z+1+B,_.push(n),_.push(R+1),_.push(R)}return we.apply(r,{positions:x,normals:y,uv:P,indices:_})}function Df(r={}){const e=r.lod||1,t=r.center?r.center[0]:0,i=r.center?r.center[1]:0,s=r.center?r.center[2]:0;let o=r.radius||1;o<0&&(console.error("negative radius not allowed - will invert"),o*=-1);let a=r.heightSegments||18;a<0&&(console.error("negative heightSegments not allowed - will invert"),a*=-1),a=Math.floor(e*a),a<18&&(a=18);let n=r.widthSegments||18;n<0&&(console.error("negative widthSegments not allowed - will invert"),n*=-1),n=Math.floor(e*n),n<18&&(n=18);const l=[],c=[],h=[],d=[];let p,m,g,u,x,y,P,_,b,B,w,C,E,I,R;for(p=0;p<=a;p++)for(g=p*Math.PI/a,u=Math.sin(g),x=Math.cos(g),m=0;m<=n;m++)y=m*2*Math.PI/n,P=Math.sin(y),_=Math.cos(y),b=_*u,B=x,w=P*u,C=1-m/n,E=p/a,c.push(b),c.push(B),c.push(w),h.push(C),h.push(E),l.push(t+o*b),l.push(i+o*B),l.push(s+o*w);for(p=0;p<a;p++)for(m=0;m<n;m++)I=p*(n+1)+m,R=I+n+1,d.push(I+1),d.push(R+1),d.push(R),d.push(I+1),d.push(R),d.push(I);return we.apply(r,{positions:l,normals:c,uv:h,indices:d})}A.vec3();class Iv extends vt{get type(){return"SectionPlane"}constructor(e,t={}){super(e,t),this._state=new Mt({active:!0,pos:A.vec3(),dir:A.vec3(),dist:0}),this.active=t.active,this.pos=t.pos,this.dir=t.dir,this.scene._sectionPlaneCreated(this)}set active(e){this._state.active=e!==!1,this.glRedraw(),this.fire("active",this._state.active),this.scene.fire("sectionPlaneUpdated",this)}get active(){return this._state.active}set pos(e){this._state.pos.set(e||[0,0,0]),this._state.dist=-A.dotVec3(this._state.pos,this._state.dir),this.fire("pos",this._state.pos),this.scene.fire("sectionPlaneUpdated",this)}get pos(){return this._state.pos}set dir(e){this._state.dir.set(e||[0,0,-1]),this._state.dist=-A.dotVec3(this._state.pos,this._state.dir),this.glRedraw(),this.fire("dir",this._state.dir),this.scene.fire("sectionPlaneUpdated",this)}get dir(){return this._state.dir}get dist(){return this._state.dist}flipDir(){A.mulVec3Scalar(this._state.dir,-1,this._state.dir),this.dir=this._state.dir}destroy(){this._state.destroy(),this.scene._sectionPlaneDestroyed(this),super.destroy()}}const Oi=A.vec4(4),zr=A.vec4(),jh=A.vec4(),zh=A.vec3([1,0,0]),Gh=A.vec3([0,1,0]),Wh=A.vec3([0,0,1]),Kh=A.vec3(3),Xh=A.vec3(3),Fv=A.identityMat4();class Sv extends vt{constructor(e,t={}){if(super(e,t),this._parentNode=null,this._children=[],this._aabb=null,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._numTriangles=0,this._scale=A.vec3(),this._quaternion=A.identityQuaternion(),this._rotation=A.vec3(),this._position=A.vec3(),this._offset=A.vec3(),this._localMatrix=A.identityMat4(),this._worldMatrix=A.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,t.matrix?this.matrix=t.matrix:(this.scale=t.scale,this.position=t.position,t.quaternion||(this.rotation=t.rotation)),this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this._isObject=t.isObject,this._isObject&&this.scene._registerObject(this),this.origin=t.origin,this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.colorize=t.colorize,this.opacity=t.opacity,this.offset=t.offset,t.children){const i=t.children;for(let s=0,o=i.length;s<o;s++)this.addChild(i[s],t.inheritStates)}if(t.parentId){const i=this.scene.components[t.parentId];i?i.isNode?i.addChild(this):this.error("Parent is not a Node: '"+t.parentId+"'"):this.error("Parent not found: '"+t.parentId+"'")}else t.parent&&(t.parent.isNode||this.error("Parent is not a Node"),t.parent.addChild(this))}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}set origin(e){e?(this._origin||(this._origin=A.vec3()),this._origin.set(e)):this._origin&&(this._origin=null);for(let t=0,i=this._children.length;t<i;t++)this._children[t].origin=e;this.glRedraw()}get origin(){return this._origin}set rtcCenter(e){this.origin=e}get rtcCenter(){return this.origin}get numTriangles(){return this._numTriangles}set visible(e){e=e!==!1,this._visible=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].visible=e;this._isObject&&this.scene._objectVisibilityUpdated(this,e)}get visible(){return this._visible}set xrayed(e){e=!!e,this._xrayed=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].xrayed=e;this._isObject&&this.scene._objectXRayedUpdated(this,e)}get xrayed(){return this._xrayed}set highlighted(e){e=!!e,this._highlighted=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].highlighted=e;this._isObject&&this.scene._objectHighlightedUpdated(this,e)}get highlighted(){return this._highlighted}set selected(e){e=!!e,this._selected=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].selected=e;this._isObject&&this.scene._objectSelectedUpdated(this,e)}get selected(){return this._selected}set edges(e){e=!!e,this._edges=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].edges=e}get edges(){return this._edges}set culled(e){e=!!e,this._culled=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].culled=e}get culled(){return this._culled}set clippable(e){e=e!==!1,this._clippable=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].clippable=e}get clippable(){return this._clippable}set collidable(e){e=e!==!1,this._collidable=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].collidable=e}get collidable(){return this._collidable}set pickable(e){e=e!==!1,this._pickable=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].pickable=e}get pickable(){return this._pickable}set colorize(e){let t=this._colorize;t||(t=this._colorize=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);for(let i=0,s=this._children.length;i<s;i++)this._children[i].colorize=t;if(this._isObject){const i=!!e;this.scene._objectColorizeUpdated(this,i)}}get colorize(){return this._colorize.slice(0,3)}set opacity(e){let t=this._colorize;t||(t=this._colorize=new Float32Array(4),t[0]=1,t[1]=1,t[2]=1),t[3]=e??1;for(let i=0,s=this._children.length;i<s;i++)this._children[i].opacity=e;if(this._isObject){const i=e!=null;this.scene._objectOpacityUpdated(this,i)}}get opacity(){return this._colorize[3]}set castsShadow(e){e=!!e,this._castsShadow=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].castsShadow=e}get castsShadow(){return this._castsShadow}set receivesShadow(e){e=!!e,this._receivesShadow=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].receivesShadow=e}get receivesShadow(){return this._receivesShadow}get saoEnabled(){return!1}set offset(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let t=0,i=this._children.length;t<i;t++)this._children[t].offset=this._offset;this._isObject&&this.scene._objectOffsetUpdated(this,e)}get offset(){return this._offset}get isNode(){return!0}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._setWorldMatrixDirty()}_buildWorldMatrix(){const e=this.matrix;if(this._parentNode)A.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_setSubtreeAABBsDirty(e){if(e._aabbDirty=!0,e._children)for(let t=0,i=e._children.length;t<i;t++)this._setSubtreeAABBsDirty(e._children[t])}_setAABBDirty(){if(this._setSubtreeAABBsDirty(this),this.collidable)for(let e=this;e;e=e._parentNode)e._aabbDirty=!0}_updateAABB(){if(this.scene._aabbDirty=!0,this._aabb||(this._aabb=A.AABB3()),this._buildAABB)this._buildAABB(this.worldMatrix,this._aabb);else{A.collapseAABB3(this._aabb);let e;for(let t=0,i=this._children.length;t<i;t++)e=this._children[t],e.collidable&&A.expandAABB3(this._aabb,e.aabb)}this._aabbDirty=!1}addChild(e,t){if(we.isNumeric(e)||we.isString(e)){const i=e;if(e=this.scene.component[i],!e){this.warn("Component not found: "+we.inQuotes(i));return}if(!e.isNode&&!e.isMesh){this.error("Not a Node or Mesh: "+i);return}}else{if(!e.isNode&&!e.isMesh){this.error("Not a Node or Mesh: "+e.id);return}if(e._parentNode){if(e._parentNode.id===this.id){this.warn("Already a child: "+e.id);return}e._parentNode.removeChild(e)}}if(e.id,e.scene.id!==this.scene.id){this.error("Child not in same Scene: "+e.id);return}return this._children.push(e),e._parentNode=this,t&&(e.visible=this.visible,e.culled=this.culled,e.xrayed=this.xrayed,e.highlited=this.highlighted,e.selected=this.selected,e.edges=this.edges,e.clippable=this.clippable,e.pickable=this.pickable,e.collidable=this.collidable,e.castsShadow=this.castsShadow,e.receivesShadow=this.receivesShadow,e.colorize=this.colorize,e.opacity=this.opacity,e.offset=this.offset),e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles+=e.numTriangles,e}removeChild(e){for(let t=0,i=this._children.length;t<i;t++)if(this._children[t].id===e.id){e._parentNode=null,this._children=this._children.splice(t,1),e._setWorldMatrixDirty(),e._setAABBDirty(),this._setAABBDirty(),this._numTriangles-=e.numTriangles;return}}removeChildren(){let e;for(let t=0,i=this._children.length;t<i;t++)e=this._children[t],e._parentNode=null,e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles-=e.numTriangles;this._children=[],this._setAABBDirty()}get numChildren(){return this._children.length}get children(){return this._children}set parent(e){if(we.isNumeric(e)||we.isString(e)){const t=e;if(e=this.scene.components[t],!e){this.warn("Node not found: "+we.inQuotes(t));return}if(!e.isNode){this.error("Not a Node: "+e.id);return}}if(e.scene.id!==this.scene.id){this.error("Node not in same Scene: "+e.id);return}if(this._parentNode&&this._parentNode.id===e.id){this.warn("Already a child of Node: "+e.id);return}e.addChild(this)}get parent(){return this._parentNode}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),A.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),A.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set matrix(e){this._localMatrix||(this._localMatrix=A.identityMat4()),this._localMatrix.set(e||Fv),A.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=A.identityMat4()),A.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}rotate(e,t){return Oi[0]=e[0],Oi[1]=e[1],Oi[2]=e[2],Oi[3]=t*A.DEGTORAD,A.angleAxisToQuaternion(Oi,zr),A.mulQuaternions(this.quaternion,zr,jh),this.quaternion=jh,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(e,t){return Oi[0]=e[0],Oi[1]=e[1],Oi[2]=e[2],Oi[3]=t*A.DEGTORAD,A.angleAxisToQuaternion(Oi,zr),A.mulQuaternions(zr,this.quaternion,zr),this}rotateX(e){return this.rotate(zh,e)}rotateY(e){return this.rotate(Gh,e)}rotateZ(e){return this.rotate(Wh,e)}translate(e,t){return A.vec3ApplyQuaternion(this.quaternion,e,Kh),A.mulVec3Scalar(Kh,t,Xh),A.addVec3(this.position,Xh,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(e){return this.translate(zh,e)}translateY(e){return this.translate(Gh,e)}translateZ(e){return this.translate(Wh,e)}get type(){return"Node"}destroy(){if(super.destroy(),this._parentNode&&this._parentNode.removeChild(this),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.offset.some(e=>e!==0)&&this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this._children.length){const e=this._children.splice();let t;for(let i=0,s=e.length;i<s;i++)t=e[i],t.destroy()}this._children=[],this._setAABBDirty(),this.scene._aabbDirty=!0}}function Xt(r,e,t=null){let i;const s=e;if(s===bf)return r.UNSIGNED_BYTE;if(s===U0)return r.UNSIGNED_SHORT_4_4_4_4;if(s===O0)return r.UNSIGNED_SHORT_5_5_5_1;if(s===I0)return r.BYTE;if(s===F0)return r.SHORT;if(s===S0)return r.UNSIGNED_SHORT;if(s===T0)return r.INT;if(s===D0)return r.UNSIGNED_INT;if(s===R0)return r.FLOAT;if(s===L0)return r.HALF_FLOAT;if(s===N0)return r.ALPHA;if(s===ga)return r.RGBA;if(s===V0)return r.LUMINANCE;if(s===H0)return r.LUMINANCE_ALPHA;if(s===j0)return r.DEPTH_COMPONENT;if(s===z0)return r.DEPTH_STENCIL;if(s===G0)return r.RED;if(s===Q0)return r.RGBA;if(s===W0)return r.RED_INTEGER;if(s===K0)return r.RG;if(s===X0)return r.RG_INTEGER;if(s===Y0)return r.RGBA_INTEGER;if(s===na||s===fl||s===ml||s===aa)if(t===Et){const o=hi(r,"WEBGL_compressed_texture_s3tc_srgb");if(o!==null){if(s===na)return o.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(s===fl)return o.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(s===ml)return o.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(s===aa)return o.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else return null}else if(i=hi(r,"WEBGL_compressed_texture_s3tc"),i!==null){if(s===na)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(s===fl)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(s===ml)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(s===aa)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}else return null;if(s===yA||s===xh||s===bA||s===yh){const o=hi(r,"WEBGL_compressed_texture_pvrtc");if(o!==null){if(s===yA)return o.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(s===xh)return o.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(s===bA)return o.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(s===yh)return o.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}else return null}if(s===Bf){const o=hi(r,"WEBGL_compressed_texture_etc1");return o!==null?o.COMPRESSED_RGB_ETC1_WEBGL:null}if(s===BA||s===wA){const o=hi(r,"WEBGL_compressed_texture_etc");if(o!==null){if(s===BA)return t===Et?o.COMPRESSED_SRGB8_ETC2:o.COMPRESSED_RGB8_ETC2;if(s===wA)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:o.COMPRESSED_RGBA8_ETC2_EAC}else return null}if(s===CA||s===bh||s===Bh||s===wh||s===Ch||s===Mh||s===Eh||s===Ih||s===Fh||s===Sh||s===Th||s===Dh||s===Rh||s===Lh){const o=hi(r,"WEBGL_compressed_texture_astc");if(o!==null){if(s===CA)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:o.COMPRESSED_RGBA_ASTC_4x4_KHR;if(s===bh)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:o.COMPRESSED_RGBA_ASTC_5x4_KHR;if(s===Bh)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:o.COMPRESSED_RGBA_ASTC_5x5_KHR;if(s===wh)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:o.COMPRESSED_RGBA_ASTC_6x5_KHR;if(s===Ch)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:o.COMPRESSED_RGBA_ASTC_6x6_KHR;if(s===Mh)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:o.COMPRESSED_RGBA_ASTC_8x5_KHR;if(s===Eh)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:o.COMPRESSED_RGBA_ASTC_8x6_KHR;if(s===Ih)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:o.COMPRESSED_RGBA_ASTC_8x8_KHR;if(s===Fh)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:o.COMPRESSED_RGBA_ASTC_10x5_KHR;if(s===Sh)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:o.COMPRESSED_RGBA_ASTC_10x6_KHR;if(s===Th)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:o.COMPRESSED_RGBA_ASTC_10x8_KHR;if(s===Dh)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:o.COMPRESSED_RGBA_ASTC_10x10_KHR;if(s===Rh)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:o.COMPRESSED_RGBA_ASTC_12x10_KHR;if(s===Lh)return t===Et?o.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:o.COMPRESSED_RGBA_ASTC_12x12_KHR}else return null}if(s===MA){const o=hi(r,"EXT_texture_compression_bptc");if(o!==null){if(s===MA)return t===Et?o.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:o.COMPRESSED_RGBA_BPTC_UNORM_EXT}else return null}return s===k0?r.UNSIGNED_INT_24_8:s===Vt?r.REPEAT:s===Bs?r.CLAMP_TO_EDGE:s===Ac||s===cc?r.NEAREST_MIPMAP_LINEAR:s===hc?r.LINEAR_MIPMAP_NEAREST:s===oa?r.LINEAR_MIPMAP_LINEAR:s===La?r.NEAREST:s===Si?r.LINEAR:null}const ki=new Uint8Array([0,0,0,1]);class ms{constructor({gl:e,target:t,format:i,type:s,wrapS:o,wrapT:a,wrapR:n,encoding:l,preloadColor:c,premultiplyAlpha:h,flipY:d}){this.gl=e,this.target=t||e.TEXTURE_2D,this.format=i||ga,this.type=s||bf,this.internalFormat=null,this.premultiplyAlpha=!!h,this.flipY=!!d,this.unpackAlignment=4,this.wrapS=o||Vt,this.wrapT=a||Vt,this.wrapR=n||Vt,this.encoding=l||Et,this.texture=e.createTexture(),c&&this.setPreloadColor(c),this.allocated=!0}setPreloadColor(e){e?(ki[0]=Math.floor(e[0]*255),ki[1]=Math.floor(e[1]*255),ki[2]=Math.floor(e[2]*255),ki[3]=Math.floor((e[3]!==void 0?e[3]:1)*255)):(ki[0]=0,ki[1]=0,ki[2]=0,ki[3]=255);const t=this.gl;if(t.bindTexture(this.target,this.texture),this.target===t.TEXTURE_CUBE_MAP){const i=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let s=0,o=i.length;s<o;s++)t.texImage2D(i[s],0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,ki)}else t.texImage2D(this.target,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,ki);t.bindTexture(this.target,null)}setTarget(e){this.target=e||this.gl.TEXTURE_2D}setImage(e,t={}){const i=this.gl;t.format!==void 0&&(this.format=t.format),t.internalFormat!==void 0&&(this.internalFormat=t.internalFormat),t.encoding!==void 0&&(this.encoding=t.encoding),t.type!==void 0&&(this.type=t.type),t.flipY!==void 0&&(this.flipY=t.flipY),t.premultiplyAlpha!==void 0&&(this.premultiplyAlpha=t.premultiplyAlpha),t.unpackAlignment!==void 0&&(this.unpackAlignment=t.unpackAlignment),t.minFilter!==void 0&&(this.minFilter=t.minFilter),t.magFilter!==void 0&&(this.magFilter=t.magFilter),t.wrapS!==void 0&&(this.wrapS=t.wrapS),t.wrapT!==void 0&&(this.wrapT=t.wrapT),t.wrapR!==void 0&&(this.wrapR=t.wrapR);let s=!1;i.bindTexture(this.target,this.texture);const o=i.getParameter(i.UNPACK_FLIP_Y_WEBGL);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,this.flipY);const a=i.getParameter(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL);i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha);const n=i.getParameter(i.UNPACK_ALIGNMENT);i.pixelStorei(i.UNPACK_ALIGNMENT,this.unpackAlignment);const l=i.getParameter(i.UNPACK_COLORSPACE_CONVERSION_WEBGL);i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE);const c=Xt(i,this.minFilter);i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,c),(c===i.NEAREST_MIPMAP_NEAREST||c===i.LINEAR_MIPMAP_NEAREST||c===i.NEAREST_MIPMAP_LINEAR||c===i.LINEAR_MIPMAP_LINEAR)&&(s=!0);const h=Xt(i,this.magFilter);h&&i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,h);const d=Xt(i,this.wrapS);d&&i.texParameteri(this.target,i.TEXTURE_WRAP_S,d);const p=Xt(i,this.wrapT);p&&i.texParameteri(this.target,i.TEXTURE_WRAP_T,p);const m=Xt(i,this.format,this.encoding),g=Xt(i,this.type),u=Yh(i,this.internalFormat,m,g,this.encoding,!1);if(this.target===i.TEXTURE_CUBE_MAP){if(we.isArray(e)){const x=e,y=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let P=0,_=y.length;P<_;P++)i.texImage2D(y[P],0,u,m,g,x[P])}}else i.texImage2D(i.TEXTURE_2D,0,u,m,g,e);s&&i.generateMipmap(this.target),i.bindTexture(this.target,null),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,o),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a),i.pixelStorei(i.UNPACK_ALIGNMENT,n),i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,l)}setCompressedData({mipmaps:e,props:t={}}){const i=this.gl,s=e.length;t.format!==void 0&&(this.format=t.format),t.internalFormat!==void 0&&(this.internalFormat=t.internalFormat),t.encoding!==void 0&&(this.encoding=t.encoding),t.type!==void 0&&(this.type=t.type),t.flipY!==void 0&&(this.flipY=t.flipY),t.premultiplyAlpha!==void 0&&(this.premultiplyAlpha=t.premultiplyAlpha),t.unpackAlignment!==void 0&&(this.unpackAlignment=t.unpackAlignment),t.minFilter!==void 0&&(this.minFilter=t.minFilter),t.magFilter!==void 0&&(this.magFilter=t.magFilter),t.wrapS!==void 0&&(this.wrapS=t.wrapS),t.wrapT!==void 0&&(this.wrapT=t.wrapT),t.wrapR!==void 0&&(this.wrapR=t.wrapR),i.activeTexture(i.TEXTURE0+0),i.bindTexture(this.target,this.texture);let o=e.length>1;i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,this.flipY),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),i.pixelStorei(i.UNPACK_ALIGNMENT,this.unpackAlignment),i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE);const a=Xt(i,this.wrapS);a&&i.texParameteri(this.target,i.TEXTURE_WRAP_S,a);const n=Xt(i,this.wrapT);if(n&&i.texParameteri(this.target,i.TEXTURE_WRAP_T,n),this.type===i.TEXTURE_3D||this.type===i.TEXTURE_2D_ARRAY){const d=Xt(i,this.wrapR);d&&i.texParameteri(this.target,i.TEXTURE_WRAP_R,d),i.texParameteri(this.type,i.TEXTURE_WRAP_R,d)}o?(i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,$h(i,this.minFilter)),i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,$h(i,this.magFilter))):(i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,Xt(i,this.minFilter)),i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,Xt(i,this.magFilter)));const l=Xt(i,this.format,this.encoding),c=Xt(i,this.type),h=Yh(i,this.internalFormat,l,c,this.encoding,!1);i.texStorage2D(i.TEXTURE_2D,s,h,e[0].width,e[0].height);for(let d=0,p=e.length;d<p;d++){const m=e[d];this.format!==ga?l!==null?i.compressedTexSubImage2D(i.TEXTURE_2D,d,0,0,m.width,m.height,l,m.data):console.warn("Attempt to load unsupported compressed texture format in .setCompressedData()"):i.texSubImage2D(i.TEXTURE_2D,d,0,0,m.width,m.height,l,c,m.data)}i.bindTexture(this.target,null)}setProps(e){const t=this.gl;t.bindTexture(this.target,this.texture),this._uploadProps(e),t.bindTexture(this.target,null)}_uploadProps(e){const t=this.gl;if(e.format!==void 0&&(this.format=e.format),e.internalFormat!==void 0&&(this.internalFormat=e.internalFormat),e.encoding!==void 0&&(this.encoding=e.encoding),e.type!==void 0&&(this.type=e.type),e.minFilter!==void 0){const i=Xt(t,e.minFilter);i&&(this.minFilter=e.minFilter,t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,i),(i===t.NEAREST_MIPMAP_NEAREST||i===t.LINEAR_MIPMAP_NEAREST||i===t.NEAREST_MIPMAP_LINEAR||i===t.LINEAR_MIPMAP_LINEAR)&&t.generateMipmap(this.target))}if(e.magFilter!==void 0){const i=Xt(t,e.magFilter);i&&(this.magFilter=e.magFilter,t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,i))}if(e.wrapS!==void 0){const i=Xt(t,e.wrapS);i&&(this.wrapS=e.wrapS,t.texParameteri(this.target,t.TEXTURE_WRAP_S,i))}if(e.wrapT!==void 0){const i=Xt(t,e.wrapT);i&&(this.wrapT=e.wrapT,t.texParameteri(this.target,t.TEXTURE_WRAP_T,i))}}bind(e){if(this.allocated){if(this.texture){const t=this.gl;return t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,this.texture),!0}return!1}}unbind(e){if(this.allocated&&this.texture){const t=this.gl;t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,null)}}destroy(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}function Yh(r,e,t,i,s,o=!1){if(e!==null){if(r[e]!==void 0)return r[e];console.warn("Attempt to use non-existing WebGL internal format '"+e+"'")}let a=t;return t===r.RED&&(i===r.FLOAT&&(a=r.R32F),i===r.HALF_FLOAT&&(a=r.R16F),i===r.UNSIGNED_BYTE&&(a=r.R8)),t===r.RG&&(i===r.FLOAT&&(a=r.RG32F),i===r.HALF_FLOAT&&(a=r.RG16F),i===r.UNSIGNED_BYTE&&(a=r.RG8)),t===r.RGBA&&(i===r.FLOAT&&(a=r.RGBA32F),i===r.HALF_FLOAT&&(a=r.RGBA16F),i===r.UNSIGNED_BYTE&&(a=s===Et&&o===!1?r.SRGB8_ALPHA8:r.RGBA8),i===r.UNSIGNED_SHORT_4_4_4_4&&(a=r.RGBA4),i===r.UNSIGNED_SHORT_5_5_5_1&&(a=r.RGB5_A1)),(a===r.R16F||a===r.R32F||a===r.RG16F||a===r.RG32F||a===r.RGBA16F||a===r.RGBA32F)&&hi(r,"EXT_color_buffer_float"),a}function $h(r,e){return e===La||e===M0||e===E0?r.NEAREST:r.LINEAR}function Zh(r){if(!qh(r.width)||!qh(r.height)){const e=document.createElement("canvas");e.width=Jh(r.width),e.height=Jh(r.height),e.getContext("2d").drawImage(r,0,0,r.width,r.height,0,0,e.width,e.height),r=e}return r}function qh(r){return(r&r-1)===0}function Jh(r){--r;for(let e=1;e<32;e<<=1)r=r|r>>e;return r+1}class Tv extends vt{get type(){return"Texture"}constructor(e,t={}){super(e,t),this._state=new Mt({texture:new ms({gl:this.scene.canvas.gl}),matrix:A.identityMat4(),hasMatrix:t.translate&&(t.translate[0]!==0||t.translate[1]!==0)||!!t.rotate||t.scale&&(t.scale[0]!==0||t.scale[1]!==0),minFilter:this._checkMinFilter(t.minFilter),magFilter:this._checkMagFilter(t.magFilter),wrapS:this._checkWrapS(t.wrapS),wrapT:this._checkWrapT(t.wrapT),flipY:this._checkFlipY(t.flipY),encoding:this._checkEncoding(t.encoding)}),this._src=null,this._image=null,this._translate=A.vec2([0,0]),this._scale=A.vec2([1,1]),this._rotate=A.vec2([0,0]),this._matrixDirty=!1,this.translate=t.translate,this.scale=t.scale,this.rotate=t.rotate,t.src?this.src=t.src:t.image&&(this.image=t.image),_t.memory.textures++}_checkMinFilter(e){return e=e||oa,e!==Si&&e!==hc&&e!==oa&&e!==cc&&e!==Ac&&(this.error("Unsupported value for 'minFilter' - supported values are LinearFilter, LinearMipMapNearestFilter, NearestMipMapNearestFilter, NearestMipMapLinearFilter and LinearMipMapLinearFilter. Defaulting to LinearMipMapLinearFilter."),e=oa),e}_checkMagFilter(e){return e=e||Si,e!==Si&&e!==La&&(this.error("Unsupported value for 'magFilter' - supported values are LinearFilter and NearestFilter. Defaulting to LinearFilter."),e=Si),e}_checkWrapS(e){return e=e||Vt,e!==Bs&&e!==Po&&e!==Vt&&(this.error("Unsupported value for 'wrapS' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),e=Vt),e}_checkWrapT(e){return e=e||Vt,e!==Bs&&e!==Po&&e!==Vt&&(this.error("Unsupported value for 'wrapT' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),e=Vt),e}_checkFlipY(e){return!!e}_checkEncoding(e){return e=e||os,e!==os&&e!==Et&&(this.error("Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),e=os),e}_webglContextRestored(){this._state.texture=new ms({gl:this.scene.canvas.gl}),this._image?this.image=this._image:this._src&&(this.src=this._src)}_update(){const e=this._state;if(this._matrixDirty){let t,i;(this._translate[0]!==0||this._translate[1]!==0)&&(t=A.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),(this._scale[0]!==1||this._scale[1]!==1)&&(i=A.scalingMat4v([this._scale[0],this._scale[1],1]),t=t?A.mulMat4(t,i):i),this._rotate!==0&&(i=A.rotationMat4v(this._rotate*.0174532925,[0,0,1]),t=t?A.mulMat4(t,i):i),t&&(e.matrix=t),this._matrixDirty=!1}this.glRedraw()}set image(e){this._image=Zh(e),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._src=null,this.glRedraw()}get image(){return this._image}set src(e){this.scene.loading++,this.scene.canvas.spinner.processes++;const t=this;let i=new Image;i.onload=function(){i=Zh(i),t._state.texture.setImage(i,t._state),t.scene.loading--,t.glRedraw(),t.scene.canvas.spinner.processes--},i.src=e,this._src=e,this._image=null}get src(){return this._src}set translate(e){this._translate.set(e||[0,0]),this._matrixDirty=!0,this._needUpdate()}get translate(){return this._translate}set scale(e){this._scale.set(e||[1,1]),this._matrixDirty=!0,this._needUpdate()}get scale(){return this._scale}set rotate(e){e=e||0,this._rotate!==e&&(this._rotate=e,this._matrixDirty=!0,this._needUpdate())}get rotate(){return this._rotate}get minFilter(){return this._state.minFilter}get magFilter(){return this._state.magFilter}get wrapS(){return this._state.wrapS}get wrapT(){return this._state.wrapT}get flipY(){return this._state.flipY}get encoding(){return this._state.encoding}destroy(){super.destroy(),this._state.texture&&this._state.texture.destroy(),this._state.destroy(),_t.memory.textures--}}const Ds=_t.memory,eu=A.AABB3();class Dv extends Pf{get type(){return"VBOGeometry"}get isVBOGeometry(){return!0}constructor(e,t={}){super(e,t),this._state=new Mt({compressGeometry:!0,primitive:null,primitiveName:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=t.edgeThreshold||10,this._aabb=null,this._obb=A.OBB3();const i=this._state,s=this.scene.canvas.gl;switch(t.primitive=t.primitive||"triangles",t.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=t.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=t.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=t.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=t.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=t.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=t.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=t.primitive;break;default:this.error("Unsupported value for 'primitive': '"+t.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=t.primitive}if(!t.positions){this.error("Config expected: positions");return}if(!t.indices){this.error("Config expected: indices");return}var o;if(!t.positionsDecodeMatrix){const n=at.getPositionsBounds(t.positions),l=at.compressPositions(t.positions,n.min,n.max);o=l.quantized,i.positionsDecodeMatrix=l.decodeMatrix,i.positionsBuf=new Oe(s,s.ARRAY_BUFFER,o,o.length,3,s.STATIC_DRAW),Ds.positions+=i.positionsBuf.numItems,A.positions3ToAABB3(t.positions,this._aabb),A.positions3ToAABB3(o,eu,i.positionsDecodeMatrix),A.AABB3ToOBB3(eu,this._obb)}if(t.colors){const a=t.colors.constructor===Float32Array?t.colors:new Float32Array(t.colors);i.colorsBuf=new Oe(s,s.ARRAY_BUFFER,a,a.length,4,s.STATIC_DRAW),Ds.colors+=i.colorsBuf.numItems}if(t.uv){const a=at.getUVBounds(t.uv),n=at.compressUVs(t.uv,a.min,a.max),l=n.quantized;i.uvDecodeMatrix=n.decodeMatrix,i.uvBuf=new Oe(s,s.ARRAY_BUFFER,l,l.length,2,s.STATIC_DRAW),Ds.uvs+=i.uvBuf.numItems}if(t.normals){const a=at.compressNormals(t.normals);let n=i.compressGeometry;i.normalsBuf=new Oe(s,s.ARRAY_BUFFER,a,a.length,3,s.STATIC_DRAW,n),Ds.normals+=i.normalsBuf.numItems}{const a=t.indices.constructor===Uint32Array||t.indices.constructor===Uint16Array?t.indices:new Uint32Array(t.indices);i.indicesBuf=new Oe(s,s.ELEMENT_ARRAY_BUFFER,a,a.length,1,s.STATIC_DRAW),Ds.indices+=i.indicesBuf.numItems;const n=ps(o,a,i.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new Oe(s,s.ELEMENT_ARRAY_BUFFER,n,n.length,1,s.STATIC_DRAW),this._state.primitiveName==="triangles"&&(this._numTriangles=t.indices.length/3)}this._buildHash(),Ds.meshes++}_buildHash(){const e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positionsBuf&&t.push("p"),e.colorsBuf&&t.push("c"),(e.normalsBuf||e.autoVertexNormals)&&t.push("n"),e.uvBuf&&t.push("u"),t.push("cp"),t.push(";"),e.hash=t.join("")}_getEdgeIndices(){return this._edgeIndicesBuf}get primitive(){return this._state.primitiveName}get aabb(){return this._aabb}get obb(){return this._obb}get numTriangles(){return this._numTriangles}_getState(){return this._state}destroy(){super.destroy();const e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),e.destroy(),Ds.meshes--}}var W={};W.load=function(r,e){var t=new XMLHttpRequest;t.open("GET",r,!0),t.responseType="arraybuffer",t.onload=function(i){e(i.target.response)},t.send()};W.save=function(r,e){var t="data:application/octet-stream;base64,"+btoa(W.parse._buffToStr(r));window.location.href=t};W.clone=function(r){return JSON.parse(JSON.stringify(r))};W.bin={};W.bin.f=new Float32Array(1);W.bin.fb=new Uint8Array(W.bin.f.buffer);W.bin.rf=function(r,e){for(var t=W.bin.f,i=W.bin.fb,s=0;s<4;s++)i[s]=r[e+s];return t[0]};W.bin.rsl=function(r,e){return r[e]|r[e+1]<<8};W.bin.ril=function(r,e){return r[e]|r[e+1]<<8|r[e+2]<<16|r[e+3]<<24};W.bin.rASCII0=function(r,e){for(var t="";r[e]!=0;)t+=String.fromCharCode(r[e++]);return t};W.bin.wf=function(r,e,t){var i=new Float32Array(r.buffer,e,1);i[0]=t};W.bin.wsl=function(r,e,t){r[e]=t,r[e+1]=t>>8};W.bin.wil=function(r,e,t){r[e]=t,r[e+1]=t>>8,r[e+2]=t>>16,r[e+3]>>24};W.parse={};W.parse._buffToStr=function(r){for(var e=new Uint8Array(r),t="",i=0;i<e.length;i++)t=t.concat(String.fromCharCode(e[i]));return t};W.parse._strToBuff=function(r){for(var e=new ArrayBuffer(r.length),t=new Uint8Array(e),i=0;i<r.length;i++)t[i]=r.charCodeAt(i);return e};W.parse._readLine=function(r,e){for(var t="";r[e]!=10;)t+=String.fromCharCode(r[e++]);return t};W.parse.fromJSON=function(r){var e=JSON.parse(W.parse._buffToStr(r));return e};W.parse.toJSON=function(r){var e=JSON.stringify(r);return W.parse._strToBuff(e)};W.parse.fromOBJ=function(r){var e={};e.groups={},e.c_verts=[],e.c_uvt=[],e.c_norms=[],e.i_verts=[],e.i_uvt=[],e.i_norms=[];for(var t={from:0,to:0},i=0,s=new Uint8Array(r);i<s.length;){var o=W.parse._readLine(s,i);i+=o.length+1,o=o.replace(/ +(?= )/g,""),o=o.replace(/(^\s+|\s+$)/g,"");var a=o.split(" ");if(a[0]=="g"&&(t.to=e.i_verts.length,e.groups[a[1]]==null&&(e.groups[a[1]]={from:e.i_verts.length,to:0}),t=e.groups[a[1]]),a[0]=="v"){var n=parseFloat(a[1]),l=parseFloat(a[2]),c=parseFloat(a[3]);e.c_verts.push(n,l,c)}if(a[0]=="vt"){var n=parseFloat(a[1]),l=1-parseFloat(a[2]);e.c_uvt.push(n,l)}if(a[0]=="vn"){var n=parseFloat(a[1]),l=parseFloat(a[2]),c=parseFloat(a[3]);e.c_norms.push(n,l,c)}if(a[0]=="f"){var h=a[1].split("/"),d=a[2].split("/"),p=a[3].split("/"),m=parseInt(h[0])-1,g=parseInt(d[0])-1,u=parseInt(p[0])-1,x=parseInt(h[1])-1,y=parseInt(d[1])-1,P=parseInt(p[1])-1,_=parseInt(h[2])-1,b=parseInt(d[2])-1,B=parseInt(p[2])-1,w=e.c_verts.length/3,C=e.c_uvt.length/2,E=e.c_norms.length/3;if(m<0&&(m=w+m+1),g<0&&(g=w+g+1),u<0&&(u=w+u+1),x<0&&(x=C+x+1),y<0&&(y=C+y+1),P<0&&(P=C+P+1),_<0&&(_=E+_+1),b<0&&(b=E+b+1),B<0&&(B=E+B+1),e.i_verts.push(m,g,u),e.i_uvt.push(x,y,P),e.i_norms.push(_,b,B),a.length==5){var I=a[4].split("/"),R=parseInt(I[0])-1,F=parseInt(I[1])-1,z=parseInt(I[2])-1;R<0&&(R=w+R+1),F<0&&(F=C+F+1),z<0&&(z=E+z+1),e.i_verts.push(m,u,R),e.i_uvt.push(x,P,F),e.i_norms.push(_,B,z)}}}return t.to=e.i_verts.length,e};W.parse.fromMD2=function(r){r=new Uint8Array(r);var e={},t={};t.ident=W.bin.ril(r,0),t.version=W.bin.ril(r,4),t.skinwidth=W.bin.ril(r,8),t.skinheight=W.bin.ril(r,12),t.framesize=W.bin.ril(r,16),t.num_skins=W.bin.ril(r,20),t.num_vertices=W.bin.ril(r,24),t.num_st=W.bin.ril(r,28),t.num_tris=W.bin.ril(r,32),t.num_glcmds=W.bin.ril(r,36),t.num_frames=W.bin.ril(r,40),t.offset_skins=W.bin.ril(r,44),t.offset_st=W.bin.ril(r,48),t.offset_tris=W.bin.ril(r,52),t.offset_frames=W.bin.ril(r,56),t.offset_glcmds=W.bin.ril(r,60),t.offset_end=W.bin.ril(r,64);var l=t.offset_st;e.c_uvt=[];for(var i=0;i<t.num_st;i++){var s=W.bin.rsl(r,l)/t.skinwidth,o=W.bin.rsl(r,l+2)/t.skinheight;e.c_uvt.push(s,o),l+=4}var l=t.offset_tris,a=[],n=[];e.i_verts=a,e.i_uvt=n;for(var i=0;i<t.num_tris;i++)a.push(W.bin.rsl(r,l),W.bin.rsl(r,l+2),W.bin.rsl(r,l+4)),n.push(W.bin.rsl(r,l+6),W.bin.rsl(r,l+8),W.bin.rsl(r,l+10)),l+=12;var l=t.offset_skins;e.skins=[];for(var i=0;i<t.num_skins;i++)e.skins.push(W.bin.rASCII0(r,l)),l+=64;var l=t.offset_frames;e.frames=[];for(var c=W.parse.fromMD2._normals,i=0;i<t.num_frames;i++){var h={},d=W.bin.rf(r,l),p=W.bin.rf(r,l+4),m=W.bin.rf(r,l+8);l+=12;var g=W.bin.rf(r,l),u=W.bin.rf(r,l+4),x=W.bin.rf(r,l+8);l+=12,h.name=W.bin.rASCII0(r,l),l+=16,h.verts=[],h.norms=[];for(var y=0;y<t.num_vertices;y++)h.verts.push(r[l]*d+g,r[l+1]*p+u,r[l+2]*m+x),h.norms.push(c[3*r[l+3]],c[3*r[l+3]+1],c[3*r[l+3]+2]),l+=4;e.frames.push(h)}return e};W.parse.fromMD2._normals=[-.525731,0,.850651,-.442863,.238856,.864188,-.295242,0,.955423,-.309017,.5,.809017,-.16246,.262866,.951056,0,0,1,0,.850651,.525731,-.147621,.716567,.681718,.147621,.716567,.681718,0,.525731,.850651,.309017,.5,.809017,.525731,0,.850651,.295242,0,.955423,.442863,.238856,.864188,.16246,.262866,.951056,-.681718,.147621,.716567,-.809017,.309017,.5,-.587785,.425325,.688191,-.850651,.525731,0,-.864188,.442863,.238856,-.716567,.681718,.147621,-.688191,.587785,.425325,-.5,.809017,.309017,-.238856,.864188,.442863,-.425325,.688191,.587785,-.716567,.681718,-.147621,-.5,.809017,-.309017,-.525731,.850651,0,0,.850651,-.525731,-.238856,.864188,-.442863,0,.955423,-.295242,-.262866,.951056,-.16246,0,1,0,0,.955423,.295242,-.262866,.951056,.16246,.238856,.864188,.442863,.262866,.951056,.16246,.5,.809017,.309017,.238856,.864188,-.442863,.262866,.951056,-.16246,.5,.809017,-.309017,.850651,.525731,0,.716567,.681718,.147621,.716567,.681718,-.147621,.525731,.850651,0,.425325,.688191,.587785,.864188,.442863,.238856,.688191,.587785,.425325,.809017,.309017,.5,.681718,.147621,.716567,.587785,.425325,.688191,.955423,.295242,0,1,0,0,.951056,.16246,.262866,.850651,-.525731,0,.955423,-.295242,0,.864188,-.442863,.238856,.951056,-.16246,.262866,.809017,-.309017,.5,.681718,-.147621,.716567,.850651,0,.525731,.864188,.442863,-.238856,.809017,.309017,-.5,.951056,.16246,-.262866,.525731,0,-.850651,.681718,.147621,-.716567,.681718,-.147621,-.716567,.850651,0,-.525731,.809017,-.309017,-.5,.864188,-.442863,-.238856,.951056,-.16246,-.262866,.147621,.716567,-.681718,.309017,.5,-.809017,.425325,.688191,-.587785,.442863,.238856,-.864188,.587785,.425325,-.688191,.688191,.587785,-.425325,-.147621,.716567,-.681718,-.309017,.5,-.809017,0,.525731,-.850651,-.525731,0,-.850651,-.442863,.238856,-.864188,-.295242,0,-.955423,-.16246,.262866,-.951056,0,0,-1,.295242,0,-.955423,.16246,.262866,-.951056,-.442863,-.238856,-.864188,-.309017,-.5,-.809017,-.16246,-.262866,-.951056,0,-.850651,-.525731,-.147621,-.716567,-.681718,.147621,-.716567,-.681718,0,-.525731,-.850651,.309017,-.5,-.809017,.442863,-.238856,-.864188,.16246,-.262866,-.951056,.238856,-.864188,-.442863,.5,-.809017,-.309017,.425325,-.688191,-.587785,.716567,-.681718,-.147621,.688191,-.587785,-.425325,.587785,-.425325,-.688191,0,-.955423,-.295242,0,-1,0,.262866,-.951056,-.16246,0,-.850651,.525731,0,-.955423,.295242,.238856,-.864188,.442863,.262866,-.951056,.16246,.5,-.809017,.309017,.716567,-.681718,.147621,.525731,-.850651,0,-.238856,-.864188,-.442863,-.5,-.809017,-.309017,-.262866,-.951056,-.16246,-.850651,-.525731,0,-.716567,-.681718,-.147621,-.716567,-.681718,.147621,-.525731,-.850651,0,-.5,-.809017,.309017,-.238856,-.864188,.442863,-.262866,-.951056,.16246,-.864188,-.442863,.238856,-.809017,-.309017,.5,-.688191,-.587785,.425325,-.681718,-.147621,.716567,-.442863,-.238856,.864188,-.587785,-.425325,.688191,-.309017,-.5,.809017,-.147621,-.716567,.681718,-.425325,-.688191,.587785,-.16246,-.262866,.951056,.442863,-.238856,.864188,.16246,-.262866,.951056,.309017,-.5,.809017,.147621,-.716567,.681718,0,-.525731,.850651,.425325,-.688191,.587785,.587785,-.425325,.688191,.688191,-.587785,.425325,-.955423,.295242,0,-.951056,.16246,.262866,-1,0,0,-.850651,0,.525731,-.955423,-.295242,0,-.951056,-.16246,.262866,-.864188,.442863,-.238856,-.951056,.16246,-.262866,-.809017,.309017,-.5,-.864188,-.442863,-.238856,-.951056,-.16246,-.262866,-.809017,-.309017,-.5,-.681718,.147621,-.716567,-.681718,-.147621,-.716567,-.850651,0,-.525731,-.688191,.587785,-.425325,-.587785,.425325,-.688191,-.425325,.688191,-.587785,-.425325,-.688191,-.587785,-.587785,-.425325,-.688191,-.688191,-.587785,-.425325];W.parse.fromCollada=function(r){var e=W.parse._buffToStr(r),t=new DOMParser().parseFromString(e,"text/xml");t=t.childNodes[0];var i={},s=t.getElementsByTagName("asset")[0],o=t.getElementsByTagName("library_geometries")[0],a=t.getElementsByTagName("library_images")[0],n=t.getElementsByTagName("library_materials")[0],l=t.getElementsByTagName("library_effects")[0];return s&&(i.asset=W.parse.fromCollada._asset(s)),o&&(i.geometries=W.parse.fromCollada._libGeometries(o)),a&&(i.images=W.parse.fromCollada._libImages(a)),n&&(i.materials=W.parse.fromCollada._libMaterials(n)),l&&(i.effects=W.parse.fromCollada._libEffects(l)),i};W.parse.fromCollada._asset=function(r){return{created:r.getElementsByTagName("created")[0].textContent,modified:r.getElementsByTagName("modified")[0].textContent,up_axis:r.getElementsByTagName("up_axis")[0].textContent}};W.parse.fromCollada._libGeometries=function(r){r=r.getElementsByTagName("geometry");for(var e=[],t=0;t<r.length;t++){var i=r[t],s=W.parse.fromCollada._getMesh(i.getElementsByTagName("mesh")[0]);e.push(s)}return e};W.parse.fromCollada._getMesh=function(r){for(var e={},t=r.getElementsByTagName("source"),i=e.sources={},s=0;s<t.length;s++){for(var o=t[s].getElementsByTagName("float_array")[0].textContent.split(" "),a=o.length-(o[o.length-1]==""?1:0),n=new Array(a),l=0;l<a;l++)n[l]=parseFloat(o[l]);i[t[s].getAttribute("id")]=n}e.triangles=[];var c=r.getElementsByTagName("triangles");if(c==null)return e;for(var s=0;s<c.length;s++){var h={},d=c[s];h.material=d.getAttribute("material");for(var p=d.getElementsByTagName("input"),m=[],l=0;l<p.length;l++){var g=p[l],n=[];m[parseInt(g.getAttribute("offset"))]=n;var u=g.getAttribute("semantic");h["s_"+u]=u=="VERTEX"?r.getElementsByTagName("vertices")[0].getElementsByTagName("input")[0].getAttribute("source").substring(1):g.getAttribute("source").substring(1),h["i_"+u]=n,i[h["s_"+u]]}for(var x=d.getElementsByTagName("p")[0].textContent.split(" "),y=3*Math.floor(x.length/3),l=0;l<y;l++)m[l%p.length].push(parseInt(x[l]));e.triangles.push(h)}return e};W.parse.fromCollada._libImages=function(r){r=r.getElementsByTagName("image");for(var e={},t=0;t<r.length;t++)e[r[t].getAttribute("id")]=r[t].getElementsByTagName("init_from")[0].textContent;return e};W.parse.fromCollada._libMaterials=function(r){r=r.getElementsByTagName("material");for(var e={},t=0;t<r.length;t++)e[r[t].getAttribute("name")]=r[t].getElementsByTagName("instance_effect")[0].getAttribute("url").substring(1);return e};W.parse.fromCollada._libEffects=function(r){r=r.getElementsByTagName("effect");for(var e={},t=0;t<r.length;t++){for(var i={},s=r[t].getElementsByTagName("newparam"),o=0;o<s.length;o++){var a=s[o].getElementsByTagName("surface")[0];a&&(i.surface=a.getElementsByTagName("init_from")[0].textContent)}e[r[t].getAttribute("id")]=i}return e};W.parse.from3DS=function(r){r=new Uint8Array(r);var e={};if(W.bin.rsl(r,0)!=19789)return null;for(var t=W.bin.ril(r,2),i=6;i<t;){var s=W.bin.rsl(r,i),o=W.bin.ril(r,i+2);s==15677&&(e.edit=W.parse.from3DS._edit3ds(r,i,o)),s==45056&&(e.keyf=W.parse.from3DS._keyf3ds(r,i,o)),i+=o}return e};W.parse.from3DS._edit3ds=function(r,e,t){for(var i={},s=e+6;s<e+t;){var o=W.bin.rsl(r,s),a=W.bin.ril(r,s+2);o==16384&&(i.objects==null&&(i.objects=[]),i.objects.push(W.parse.from3DS._edit_object(r,s,a))),s+=a}return i};W.parse.from3DS._keyf3ds=function(r,e,t){for(var i={},s=e+6;s<e+t;){var o=W.bin.rsl(r,s),a=W.bin.ril(r,s+2);o==45058&&(i.desc==null&&(i.desc=[]),i.desc.push(W.parse.from3DS._keyf_objdes(r,s,a))),s+=a}return i};W.parse.from3DS._keyf_objdes=function(r,e,t){for(var i={},s=e+6;s<e+t;){var o=W.bin.rsl(r,s),a=W.bin.ril(r,s+2);o==45072&&(i.hierarchy=W.parse.from3DS._keyf_objhierarch(r,s,a)),o==45073&&(i.dummy_name=W.bin.rASCII0(r,s+6)),s+=a}return i};W.parse.from3DS._keyf_objhierarch=function(r,e,t){var i={},s=e+6;return i.name=W.bin.rASCII0(r,s),s+=i.name.length+1,i.hierarchy=W.bin.rsl(r,s+4),i};W.parse.from3DS._edit_object=function(r,e,t){var i={},s=e+6;for(i.name=W.bin.rASCII0(r,s),s+=i.name.length+1;s<e+t;){var o=W.bin.rsl(r,s),a=W.bin.ril(r,s+2);o==16640&&(i.mesh=W.parse.from3DS._obj_trimesh(r,s,a)),s+=a}return i};W.parse.from3DS._obj_trimesh=function(r,e,t){for(var i={},s=e+6;s<e+t;){var o=W.bin.rsl(r,s),a=W.bin.ril(r,s+2);o==16656&&(i.vertices=W.parse.from3DS._tri_vertexl(r,s,a)),o==16672&&(i.indices=W.parse.from3DS._tri_facel1(r,s,a)),o==16704&&(i.uvt=W.parse.from3DS._tri_mappingcoors(r,s,a)),o==16736&&(i.local=W.parse.from3DS._tri_local(r,s,a)),s+=a}return i};W.parse.from3DS._tri_vertexl=function(r,e,t){var i=[],s=e+6,o=W.bin.rsl(r,s);s+=2;for(var a=0;a<o;a++)i.push(W.bin.rf(r,s)),i.push(W.bin.rf(r,s+4)),i.push(W.bin.rf(r,s+8)),s+=12;return i};W.parse.from3DS._tri_facel1=function(r,e,t){var i=[],s=e+6,o=W.bin.rsl(r,s);s+=2;for(var a=0;a<o;a++)i.push(W.bin.rsl(r,s)),i.push(W.bin.rsl(r,s+2)),i.push(W.bin.rsl(r,s+4)),s+=8;return i};W.parse.from3DS._tri_mappingcoors=function(r,e,t){var i=[],s=e+6,o=W.bin.rsl(r,s);s+=2;for(var a=0;a<o;a++)i.push(W.bin.rf(r,s)),i.push(1-W.bin.rf(r,s+4)),s+=8;return i};W.parse.from3DS._tri_local=function(r,e,t){var i={},s=e+6;return i.X=[W.bin.rf(r,s),W.bin.rf(r,s+4),W.bin.rf(r,s+8)],s+=12,i.Y=[W.bin.rf(r,s),W.bin.rf(r,s+4),W.bin.rf(r,s+8)],s+=12,i.Z=[W.bin.rf(r,s),W.bin.rf(r,s+4),W.bin.rf(r,s+8)],s+=12,i.C=[W.bin.rf(r,s),W.bin.rf(r,s+4),W.bin.rf(r,s+8)],s+=12,i};W.parse.fromBIV=function(r){r=new Uint8Array(r);var e={},t={};return t.id=W.bin.ril(r,0),t.verS=W.bin.ril(r,4),t.texS=W.bin.ril(r,8),t.indS=W.bin.ril(r,12),t.verO=W.bin.ril(r,16),t.verL=W.bin.ril(r,20),t.texO=W.bin.ril(r,24),t.texL=W.bin.ril(r,28),t.indO=W.bin.ril(r,32),t.indL=W.bin.ril(r,36),t.verO!=0&&(e.vertices=W.parse.fromBIV._readFloats(r,t.verO,t.verL)),t.texO!=0&&(e.uvt=W.parse.fromBIV._readFloats(r,t.texO,t.texL)),t.indO!=0&&(e.indices=W.parse.fromBIV._readInts(r,t.indO,t.indL,t.indS)),e};W.parse.toBIV=function(r){for(var e=0,t=0;t<r.indices.length;t++)e=Math.max(e,r.indices[t]);var i=32;e<=65535&&(i=16);var s=40;r.vertices&&(s+=r.vertices.length*4),r.uvt&&(s+=r.uvt.length*4),r.indices&&(s+=r.indices.length*i/8);var o=new Uint8Array(s);W.bin.wil(o,0,1769365870),W.bin.wil(o,4,32),W.bin.wil(o,8,32),W.bin.wil(o,12,i);var a=40;return r.vertices&&(W.bin.wil(o,16,a),W.bin.wil(o,20,4*r.vertices.length),W.parse.fromBIV._writeFloats(o,a,r.vertices),a+=4*r.vertices.length),r.uvt&&(W.bin.wil(o,24,a),W.bin.wil(o,28,4*r.uvt.length),W.parse.fromBIV._writeFloats(o,a,r.uvt),a+=4*r.uvt.length),r.indices&&(W.bin.wil(o,32,a),W.bin.wil(o,36,4*r.indices.length),W.parse.fromBIV._writeInts(o,a,r.indices,i)),o.buffer};W.parse.fromBIV._readFloats=function(r,e,t){for(var i=[],s=0;s<t/4;s++)i.push(W.bin.rf(r,e+4*s));return i};W.parse.fromBIV._writeFloats=function(r,e,t){for(var i=0;i<t.length;i++)W.bin.wf(r,e+4*i,t[i])};W.parse.fromBIV._readInts=function(r,e,t,i){for(var s=[],o=0;o<t/4;o++)i==16&&s.push(W.bin.rsl(r,e+2*o)),i==32&&s.push(W.bin.ril(r,e+4*o));return s};W.parse.fromBIV._writeInts=function(r,e,t,i){for(var s=0;s<t.length;s++)i==16&&W.bin.wsl(r,e+2*s,t[s]),i==32&&W.bin.wil(r,e+4*s,t[s])};W.gen={};W.gen.Plane=function(r,e,t,i){t||(t=1),i||(i=1);for(var s={verts:[],inds:[],uvt:[]},o=r+1,a=e+1,n=0;n<a;n++)for(var l=0;l<o;l++){var c=-1+l*(2/r),h=-1+n*(2/e);s.verts.push(c,h,0),s.uvt.push(t*l/r,i*n/e),n<e&&l<r&&s.inds.push(n*o+l,n*o+l+1,(n+1)*o+l,n*o+l+1,(n+1)*o+l,(n+1)*o+l+1)}return s};W.gen.Cube=function(){var r={verts:[-1,1,-1,1,1,-1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],inds:[0,1,2,1,2,3,4,5,6,5,6,7,8,9,10,9,10,11,12,13,14,13,14,15,16,17,18,17,18,19,20,21,22,21,22,23],uvt:[.25,.25,.5,.25,.25,.5,.5,.5,1,.25,.75,.25,1,.5,.75,.5,0,.25,.25,.25,0,.5,.25,.5,.75,.25,.5,.25,.75,.5,.5,.5,.25,.25,.5,.25,.25,0,.5,0,.25,.5,.5,.5,.25,.75,.5,.75]};return r};W.gen.Sphere=function(r,e){for(var t={verts:[],inds:[],uvt:[]},i=r+1,s=e+1,o=0;o<s;o++)for(var a=0;a<i;a++){var n=-Math.PI/2+o*Math.PI/e,l=a*2*Math.PI/r,c=Math.cos(n)*Math.cos(l),h=Math.sin(n),d=Math.cos(n)*Math.sin(l);t.verts.push(c,h,d),t.uvt.push(a/r,o/e),o<e&&a<r&&t.inds.push(i*o+a,i*o+a+1,i*(o+1)+a,i*o+a+1,i*(o+1)+a,i*(o+1)+a+1)}return t};W.mat={};W.mat.scale=function(r,e,t){return[r,0,0,0,0,e,0,0,0,0,t,0,0,0,0,1]};W.mat.translate=function(r,e,t){return[1,0,0,0,0,1,0,0,0,0,1,0,r,e,t,1]};W.mat.rotateDeg=function(r,e,t){var i=Math.PI/180;return W.mat.rotate(r*i,e*i,t*i)};W.mat.rotate=function(r,e,t){var i=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],s=r,o=e,a=t,n=Math.cos(s),l=Math.cos(o),c=Math.cos(a),h=Math.sin(s),d=Math.sin(o),p=Math.sin(a);return i[0]=l*c,i[1]=-l*p,i[2]=d,i[4]=n*p+h*d*c,i[5]=n*c-h*d*p,i[6]=-h*l,i[8]=h*p-n*d*c,i[9]=h*c+n*d*p,i[10]=n*l,i};W.edit={};W.edit.interpolate=function(r,e,t,i){for(var s=0;s<r.length;s++)t[s]=r[s]+i*(e[s]-r[s])};W.edit.transform=function(r,e){for(var t=0;t<r.length;t+=3){var i=r[t],s=r[t+1],o=r[t+2];r[t+0]=e[0]*i+e[4]*s+e[8]*o+e[12],r[t+1]=e[1]*i+e[5]*s+e[9]*o+e[13],r[t+2]=e[2]*i+e[6]*s+e[10]*o+e[14]}};W.edit.unwrap=function(r,e,t){for(var i=new Array(Math.floor(r.length/3)*t),s=0;s<r.length;s++)for(var o=0;o<t;o++)i[s*t+o]=e[r[s]*t+o];return i};W.edit.remap=function(r,e,t,i){for(var s=new Array(t.length),o=0;o<r.length;o++)for(var a=0;a<i;a++)s[e[o]*i+a]=t[r[o]*i+a];return s};W.utils={};W.utils.getAABB=function(r){var e,t,i,s,o,a;e=t=i=999999999,s=o=a=-e;for(var n=0;n<r.length;n+=3){var l=r[n+0],c=r[n+1],h=r[n+2];l<e&&(e=l),l>s&&(s=l),c<t&&(t=c),c>o&&(o=c),h<i&&(i=h),c>a&&(a=h)}return{min:{x:e,y:t,z:i},max:{x:s,y:o,z:a}}};function Gr(r={}){let e=r.radius||1;e<0&&(console.error("negative radius not allowed - will invert"),e*=-1),e*=.5;let t=r.tube||.3;t<0&&(console.error("negative tube not allowed - will invert"),t*=-1);let i=r.radialSegments||32;i<0&&(console.error("negative radialSegments not allowed - will invert"),i*=-1),i<4&&(i=4);let s=r.tubeSegments||24;s<0&&(console.error("negative tubeSegments not allowed - will invert"),s*=-1),s<4&&(s=4);let o=r.arc||Math.PI*2;o<0&&(console.warn("negative arc not allowed - will invert"),o*=-1),o>360&&(o=360);const a=r.center;let n=a?a[0]:0,l=a?a[1]:0;const c=a?a[2]:0,h=[],d=[],p=[],m=[];let g,u,x,y,P,_,b,B;for(B=0;B<=s;B++)for(b=0;b<=i;b++)g=b/i*o,u=.785398+B/s*Math.PI*2,n=e*Math.cos(g),l=e*Math.sin(g),x=(e+t*Math.cos(u))*Math.cos(g),y=(e+t*Math.cos(u))*Math.sin(g),P=t*Math.sin(u),h.push(x+n),h.push(y+l),h.push(P+c),p.push(1-b/i),p.push(B/s),_=A.normalizeVec3(A.subVec3([x,y,P],[n,l,c],[]),[]),d.push(_[0]),d.push(_[1]),d.push(_[2]);let w,C,E,I;for(B=1;B<=s;B++)for(b=1;b<=i;b++)w=(i+1)*B+b-1,C=(i+1)*(B-1)+b-1,E=(i+1)*(B-1)+b,I=(i+1)*B+b,m.push(w),m.push(C),m.push(E),m.push(E),m.push(I),m.push(w);return we.apply(r,{positions:h,normals:d,uv:p,indices:m})}const Rv=(r,e)=>{const t=[];let i=[];function s(c,h){let d,p;for(let m=0;m<3;m++)if(d=e[c*3+m],p=e[h*3+m],d!==p)return p-d;return 0}let o=r.slice().sort(s),a=null;for(let c=0,h=o.length;c<h;c++)(c===0||s(o[c],o[c-1])!==0)&&(a=o[c]),t[o[c]]=a;for(let c=0,h=r.length;c<h;c+=3){const d=t[r[c]],p=t[r[c+1]],m=t[r[c+2]];let g=d,u=p,x=m;if(d>p&&d>m?p>m?(g=d,u=p,x=m):(g=d,u=m,x=p):p>d&&p>m?d>m?(g=p,u=d,x=m):(g=p,u=m,x=d):m>d&&m>p&&(d>p?(g=m,u=d,x=p):(g=m,u=p,x=d)),i[c+0]=[g,u],i[c+1]=[u,x],g>x){const y=x;x=g,g=y}i[c+2]=[x,g]}function n(c,h){let d,p;for(let m=0;m<2;m++)if(d=c[m],p=h[m],p!==d)return p-d;return 0}i=i.slice(0,r.length),i.sort(n);let l=0;for(let c=0;c<i.length;c++)if(c===0||n(i[c],i[c-1])!==0){if(c!==0&&l!==2)return!1;l=1}else l++;return!(i.length>0&&l!==2)},er=A.vec3(),un=A.vec3(),dn=A.vec3();class Lv{constructor(){this.vertices=[],this.indices=[],this.reset()}reset(){this.lenVertices=0,this.lenIndices=0,this.primitive=null}setPrimitive(e){this.primitive=e}addVertex(e){this.vertices[this.lenVertices++]=e[0],this.vertices[this.lenVertices++]=e[1],this.vertices[this.lenVertices++]=e[2]}addIndex(e){this.indices[this.lenIndices++]=e}get volume(){const e=this.vertices,t=this.indices;if(this.primitive!=="solid"&&this.primitive!=="surface"&&this.primitive!=="triangles"||this.primitive!=="solid"&&!Rv(t,e))return-1;let i=0;for(let s=0;s<this.lenIndices;s+=3){const o=t[s]*3,a=t[s+1]*3,n=t[s+2]*3;er[0]=e[o],er[1]=e[o+1],er[2]=e[o+2],un[0]=e[a],un[1]=e[a+1],un[2]=e[a+2],dn[0]=e[n],dn[1]=e[n+1],dn[2]=e[n+2],A.cross3Vec3(er,un,er),i+=A.dotVec3(er,dn)}return i/6}}const Wr=new Lv,pn=A.vec3(),Kr=A.vec3(),fn=A.vec3(),tu=A.vec3(),iu=A.vec3(),Uv=A.vec3();class Ov{constructor(){this.vertices=[],this.indices=[],this.reset()}reset(){this.lenVertices=0,this.lenIndices=0}addVertex(e){this.vertices[this.lenVertices++]=e[0],this.vertices[this.lenVertices++]=e[1],this.vertices[this.lenVertices++]=e[2]}addIndex(e){this.indices[this.lenIndices++]=e}get surfaceArea(){const e=this.vertices,t=this.indices;let i=0;for(let s=0;s<this.lenIndices;s+=3){const o=t[s]*3,a=t[s+1]*3,n=t[s+2]*3;pn[0]=e[o],pn[1]=e[o+1],pn[2]=e[o+2],Kr[0]=e[a],Kr[1]=e[a+1],Kr[2]=e[a+2],fn[0]=e[n],fn[1]=e[n+1],fn[2]=e[n+2],A.subVec3(pn,Kr,tu),A.subVec3(fn,Kr,iu),i+=A.lenVec3(A.cross3Vec3(tu,iu,Uv))*.5}return i}}const mn=new Ov,gl=A.OBB3(),gn=A.OBB3(),su=A.OBB3();class kv{constructor(e,t,i,s,o,a,n=null,l=0){this.model=e,this.object=null,this.parent=null,this.transform=o,this.textureSet=a,this._matrixDirty=!1,this._matrixUpdateScheduled=!1,this.id=t,this.obb=null,this._aabbLocal=null,this._aabbWorld=A.AABB3(),this._aabbWorldDirty=!1,this.layer=n,this.portionId=l,this._color=new Uint8Array([i[0],i[1],i[2],s]),this._colorize=new Uint8Array([i[0],i[1],i[2],s]),this._colorizing=!1,this._transparent=s<255,this.numTriangles=0,this.origin=null,this.entity=null,o&&o._addMesh(this),this._volume=null,this._surfaceArea=null}_sceneModelDirty(){this._aabbWorldDirty=!0,this.layer.aabbDirty=!0}_transformDirty(){!this._matrixDirty&&!this._matrixUpdateScheduled&&(this.model._meshMatrixDirty(this),this._matrixDirty=!0,this._matrixUpdateScheduled=!0),this._aabbWorldDirty=!0,this.layer.aabbDirty=!0,this.entity&&this.entity._transformDirty()}_updateMatrix(){this.transform&&this._matrixDirty&&this.layer.setMatrix(this.portionId,this.transform.worldMatrix),this._matrixDirty=!1,this._matrixUpdateScheduled=!1}_finalize(e){this.layer.initFlags(this.portionId,e,this._transparent)}_finalize2(){this.layer.flushInitFlags&&this.layer.flushInitFlags()}_setVisible(e){this.layer.setVisible(this.portionId,e,this._transparent)}_setColor(e){this._color[0]=e[0],this._color[1]=e[1],this._color[2]=e[2],this._colorizing||this.layer.setColor(this.portionId,this._color,!1)}_setColorize(e){e?(this._colorize[0]=e[0],this._colorize[1]=e[1],this._colorize[2]=e[2],this.layer.setColor(this.portionId,this._colorize,!1),this._colorizing=!0):(this.layer.setColor(this.portionId,this._color,!1),this._colorizing=!1)}_setOpacity(e,t){const i=e<255,o=this._transparent!==i;this._color[3]=e,this._colorize[3]=e,this._transparent=i,this._colorizing?this.layer.setColor(this.portionId,this._colorize):this.layer.setColor(this.portionId,this._color),o&&this.layer.setTransparent(this.portionId,t,i)}_setOffset(e){this.layer.setOffset(this.portionId,e)}_setHighlighted(e){this.layer.setHighlighted(this.portionId,e,this._transparent)}_setXRayed(e){this.layer.setXRayed(this.portionId,e,this._transparent)}_setSelected(e){this.layer.setSelected(this.portionId,e,this._transparent)}_setEdges(e){this.layer.setEdges(this.portionId,e,this._transparent)}_setClippable(e){this.layer.setClippable(this.portionId,e,this._transparent)}_setCollidable(e){this.layer.setCollidable(this.portionId,e)}_setPickable(e){this.layer.setPickable(this.portionId,e,this._transparent)}_setCulled(e){this.layer.setCulled(this.portionId,e,this._transparent)}canPickTriangle(){return!1}drawPickTriangles(e,t){}pickTriangleSurface(e){}precisionRayPickSurface(e,t,i,s){return this.layer.precisionRayPickSurface?this.layer.precisionRayPickSurface(this.portionId,e,t,i,s):!1}canPickWorldPos(){return!0}drawPickDepths(e){this.model.drawPickDepths(e)}drawPickNormals(e){this.model.drawPickNormals(e)}delegatePickedEntity(){return this.parent}getEachVertex(e){this.layer.getEachVertex&&this.layer.getEachVertex(this.portionId,e)}getEachIndex(e){this.layer.getEachIndex&&this.layer.getEachIndex(this.portionId,e)}get volume(){if(this._volume!==null)return this._volume;switch(this.layer.primitive){case"solid":case"surface":case"triangles":Wr.reset(),Wr.setPrimitive(this.layer.primitive),this.getEachVertex(e=>{Wr.addVertex(e)}),this.getEachIndex(e=>{Wr.addIndex(e)}),this._volume=Wr.volume;break;default:this._volume=0;break}return this._volume}get surfaceArea(){if(this._surfaceArea!==null)return this._surfaceArea;switch(this.layer.primitive){case"solid":case"surface":case"triangles":mn.reset(),this.getEachVertex(e=>{mn.addVertex(e)}),this.getEachIndex(e=>{mn.addIndex(e)}),this._surfaceArea=mn.surfaceArea;break;default:this._surfaceArea=0;break}return this._surfaceArea}set aabb(e){if(this._aabbLocal=e,this.origin){this._aabbLocal=e.slice(0);const t=this.origin;this._aabbLocal[0]+=t[0],this._aabbLocal[1]+=t[1],this._aabbLocal[2]+=t[2],this._aabbLocal[3]+=t[0],this._aabbLocal[4]+=t[1],this._aabbLocal[5]+=t[2]}}get aabb(){return this._aabbWorldDirty&&(A.AABB3ToOBB3(this._aabbLocal,gl),this.transform?(A.transformOBB3(this.transform.worldMatrix,gl,gn),A.transformOBB3(this.model.worldMatrix,gn,su),A.OBB3ToAABB3(su,this._aabbWorld)):(A.transformOBB3(this.model.worldMatrix,gl,gn),A.OBB3ToAABB3(gn,this._aabbWorld)),this._aabbWorldDirty=!1),this._aabbWorld}_destroy(){this.model.scene._renderer.putPickID(this.pickId)}}class Nv{constructor(){this._uint8Arrays={},this._float32Arrays={}}_clear(){this._uint8Arrays={},this._float32Arrays={}}getUInt8Array(e){let t=this._uint8Arrays[e];return t||(t=new Uint8Array(e),this._uint8Arrays[e]=t),t}getFloat32Array(e){let t=this._float32Arrays[e];return t||(t=new Float32Array(e),this._float32Arrays[e]=t),t}}const Rf=new Nv;let la=0;function Qv(){return la++,Rf}function Vv(){la!==0&&(la--,la===0&&Rf._clear())}const O={NOT_RENDERED:0,COLOR_OPAQUE:1,COLOR_TRANSPARENT:2,SILHOUETTE_HIGHLIGHTED:3,SILHOUETTE_SELECTED:4,SILHOUETTE_XRAYED:5,EDGES_COLOR_OPAQUE:6,EDGES_COLOR_TRANSPARENT:7,EDGES_HIGHLIGHTED:8,EDGES_SELECTED:9,EDGES_XRAYED:10,PICK:11},Hv=new Float32Array([1,1,1,1]),jv=new Float32Array([0,0,0,1]),Xr=A.vec4(),ru=A.vec3(),zv=A.vec3(),Gv=A.mat4();class Kt{constructor(e,t=!1,{instancing:i=!1,edges:s=!1,useAlphaCutoff:o=!1}={}){this._scene=e,this._withSAO=t,this._instancing=i,this._edges=s,this._useAlphaCutoff=o,this._hash=this._getHash(),this._matricesUniformBlockBufferBindingPoint=0,this._matricesUniformBlockBuffer=this._scene.canvas.gl.createBuffer(),this._matricesUniformBlockBufferData=new Float32Array(4*4*6),this._vaoCache=new WeakMap,this._allocate()}_getHash(){return this._scene._sectionPlanesState.getHash()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){return[""]}_buildFragmentShader(){return[""]}_addMatricesUniformBlockLines(e,t=!1){return e.push("uniform Matrices {"),e.push("    mat4 worldMatrix;"),e.push("    mat4 viewMatrix;"),e.push("    mat4 projMatrix;"),e.push("    mat4 positionsDecodeMatrix;"),t&&(e.push("    mat4 worldNormalMatrix;"),e.push("    mat4 viewNormalMatrix;")),e.push("};"),e}_addRemapClipPosLines(e,t=1){return e.push("uniform vec2 drawingBufferSize;"),e.push("uniform vec2 pickClipPos;"),e.push("vec4 remapClipPos(vec4 clipPos) {"),e.push("    clipPos.xy /= clipPos.w;"),t===1?e.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"):e.push(`    clipPos.xy = (clipPos.xy - pickClipPos) * (drawingBufferSize / float(${t}));`),e.push("    clipPos.xy *= clipPos.w;"),e.push("    return clipPos;"),e.push("}"),e}getValid(){return this._hash===this._getHash()}setSectionPlanesStateUniforms(e){const t=this._scene,{gl:i}=t.canvas,{model:s,layerIndex:o}=e,a=t._sectionPlanesState.getNumAllocatedSectionPlanes(),n=t._sectionPlanesState.sectionPlanes.length;if(a>0){const l=t._sectionPlanesState.sectionPlanes,c=o*n,h=s.renderFlags;t.crossSections&&(i.uniform4fv(this._uSliceColor,t.crossSections.sliceColor),i.uniform1f(this._uSliceThickness,t.crossSections.sliceThickness));for(let d=0;d<a;d++){const p=this._uSectionPlanes[d];if(p)if(d<n){const m=h.sectionPlanesActivePerLayer[c+d];if(i.uniform1i(p.active,m?1:0),m){const g=l[d],u=e._state.origin;if(u){const x=kt(g.dist,g.dir,u,ru,s.matrix);i.uniform3fv(p.pos,x)}else i.uniform3fv(p.pos,g.pos);i.uniform3fv(p.dir,g.dir)}}else i.uniform1i(p.active,0)}}}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uColor=s.getLocation("color"),this._uColor||(this._uColor=s.getLocation("silhouetteColor")),this._uUVDecodeMatrix=s.getLocation("uvDecodeMatrix"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uGammaFactor=s.getLocation("gammaFactor"),t.uniformBlockBinding(s.handle,t.getUniformBlockIndex(s.handle,"Matrices"),this._matricesUniformBlockBufferBindingPoint),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),e.logarithmicDepthBufferEnabled&&(this._uZFar=s.getLocation("zFar")),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const o=i.lights;let a;for(let n=0,l=o.length;n<l;n++)switch(a=o[n],a.type){case"dir":this._uLightColor[n]=s.getLocation("lightColor"+n),this._uLightPos[n]=null,this._uLightDir[n]=s.getLocation("lightDir"+n);break;case"point":this._uLightColor[n]=s.getLocation("lightColor"+n),this._uLightPos[n]=s.getLocation("lightPos"+n),this._uLightDir[n]=null,this._uLightAttenuation[n]=s.getLocation("lightAttenuation"+n);break;case"spot":this._uLightColor[n]=s.getLocation("lightColor"+n),this._uLightPos[n]=s.getLocation("lightPos"+n),this._uLightDir[n]=s.getLocation("lightDir"+n),this._uLightAttenuation[n]=s.getLocation("lightAttenuation"+n);break}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(let n=0,l=e._sectionPlanesState.getNumAllocatedSectionPlanes();n<l;n++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+n),pos:s.getLocation("sectionPlanePos"+n),dir:s.getLocation("sectionPlaneDir"+n)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aUV=s.getAttribute("uv"),this._aColor=s.getAttribute("color"),this._aMetallicRoughness=s.getAttribute("metallicRoughness"),this._aFlags=s.getAttribute("flags"),this._aPickColor=s.getAttribute("pickColor"),this._uPickZNear=s.getLocation("pickZNear"),this._uPickZFar=s.getLocation("pickZFar"),this._uPickClipPos=s.getLocation("pickClipPos"),this._uDrawingBufferSize=s.getLocation("drawingBufferSize"),this._uColorMap="uColorMap",this._uMetallicRoughMap="uMetallicRoughMap",this._uEmissiveMap="uEmissiveMap",this._uNormalMap="uNormalMap",this._uAOMap="uAOMap",this._instancing&&(this._aModelMatrix=s.getAttribute("modelMatrix"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=s.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=s.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=s.getAttribute("modelNormalMatrixCol2")),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),this._useAlphaCutoff&&(this._alphaCutoffLocation=s.getLocation("materialAlphaCutoff")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),e.pointsMaterial._state.filterIntensity&&(this._uIntensityRange=s.getLocation("intensityRange")),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.crossSections&&(this._uSliceColor=s.getLocation("sliceColor"),this._uSliceThickness=s.getLocation("sliceThickness"))}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,o=t._lightsState,a=o.lights;s.bind(),e.textureUnit=0,this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,o.getAmbientColorAndIntensity()),this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor);for(let n=0,l=a.length;n<l;n++){const c=a[n];this._uLightColor[n]&&i.uniform4f(this._uLightColor[n],c.color[0],c.color[1],c.color[2],c.intensity),this._uLightPos[n]&&(i.uniform3fv(this._uLightPos[n],c.pos),this._uLightAttenuation[n]&&i.uniform1f(this._uLightAttenuation[n],c.attenuation)),this._uLightDir[n]&&i.uniform3fv(this._uLightDir[n],c.dir)}}_makeVAO(e){const t=this._scene.canvas.gl,i=t.createVertexArray();return t.bindVertexArray(i),this._instancing&&(this._aModelMatrixCol0.bindArrayBuffer(e.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(e.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(e.modelMatrixCol2Buf),t.vertexAttribDivisor(this._aModelMatrixCol0.location,1),t.vertexAttribDivisor(this._aModelMatrixCol1.location,1),t.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0&&(this._aModelNormalMatrixCol0.bindArrayBuffer(e.modelNormalMatrixCol0Buf),t.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,1)),this._aModelNormalMatrixCol1&&(this._aModelNormalMatrixCol1.bindArrayBuffer(e.modelNormalMatrixCol1Buf),t.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,1)),this._aModelNormalMatrixCol2&&(this._aModelNormalMatrixCol2.bindArrayBuffer(e.modelNormalMatrixCol2Buf),t.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,1))),this._aPosition.bindArrayBuffer(e.positionsBuf),this._aUV&&this._aUV.bindArrayBuffer(e.uvBuf),this._aNormal&&this._aNormal.bindArrayBuffer(e.normalsBuf),this._aMetallicRoughness&&(this._aMetallicRoughness.bindArrayBuffer(e.metallicRoughnessBuf),this._instancing&&t.vertexAttribDivisor(this._aMetallicRoughness.location,1)),this._aColor&&(this._aColor.bindArrayBuffer(e.colorsBuf),this._instancing&&e.colorsBuf&&t.vertexAttribDivisor(this._aColor.location,1)),this._aFlags&&(this._aFlags.bindArrayBuffer(e.flagsBuf),this._instancing&&t.vertexAttribDivisor(this._aFlags.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(e.offsetsBuf),this._instancing&&t.vertexAttribDivisor(this._aOffset.location,1)),this._aPickColor&&(this._aPickColor.bindArrayBuffer(e.pickColorsBuf),this._instancing&&t.vertexAttribDivisor(this._aPickColor.location,1)),this._instancing?this._edges?e.edgeIndicesBuf.bind():e.indicesBuf&&e.indicesBuf.bind():this._edges?e.edgeIndicesBuf.bind():e.indicesBuf&&e.indicesBuf.bind(),i}drawLayer(e,t,i,{colorUniform:s=!1,incrementDrawState:o=!1}={}){const a=yt.MAX_TEXTURE_IMAGE_UNITS,n=this._scene,l=n.canvas.gl,{_state:c,model:h}=t,{textureSet:d,origin:p,positionsDecodeMatrix:m}=c,g=n._lightsState,u=n.pointsMaterial,{camera:x}=h.scene,{viewNormalMatrix:y,project:P}=x,_=e.pickViewMatrix||x.viewMatrix,{position:b,rotationMatrix:B,worldNormalMatrix:w}=h;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),this._vaoCache.has(t)?l.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(c));let C=0;const E=4*4;this._matricesUniformBlockBufferData.set(B,0);const I=p[0]!==0||p[1]!==0||p[2]!==0,R=b[0]!==0||b[1]!==0||b[2]!==0;if(I||R){const F=ru;if(I){const z=A.transformPoint3(B,p,zv);F[0]=z[0],F[1]=z[1],F[2]=z[2]}else F[0]=0,F[1]=0,F[2]=0;F[0]+=b[0],F[1]+=b[1],F[2]+=b[2],this._matricesUniformBlockBufferData.set(Pt(_,F,Gv),C+=E)}else this._matricesUniformBlockBufferData.set(_,C+=E);if(this._matricesUniformBlockBufferData.set(e.pickProjMatrix||P.matrix,C+=E),this._matricesUniformBlockBufferData.set(m,C+=E),this._matricesUniformBlockBufferData.set(w,C+=E),this._matricesUniformBlockBufferData.set(y,C+=E),l.bindBuffer(l.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),l.bufferData(l.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,l.DYNAMIC_DRAW),l.bindBufferBase(l.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer),l.uniform1i(this._uRenderPass,i),this.setSectionPlanesStateUniforms(t),n.logarithmicDepthBufferEnabled){if(this._uLogDepthBufFC){const F=2/(Math.log(e.pickZFar+1)/Math.LN2);l.uniform1f(this._uLogDepthBufFC,F)}this._uZFar&&l.uniform1f(this._uZFar,n.camera.project.far)}if(this._uPickInvisible&&l.uniform1i(this._uPickInvisible,e.pickInvisible),this._uPickZNear&&l.uniform1f(this._uPickZNear,e.pickZNear),this._uPickZFar&&l.uniform1f(this._uPickZFar,e.pickZFar),this._uPickClipPos&&l.uniform2fv(this._uPickClipPos,e.pickClipPos),this._uDrawingBufferSize&&l.uniform2f(this._uDrawingBufferSize,l.drawingBufferWidth,l.drawingBufferHeight),this._uUVDecodeMatrix&&l.uniformMatrix3fv(this._uUVDecodeMatrix,!1,c.uvDecodeMatrix),this._uIntensityRange&&u.filterIntensity&&l.uniform2f(this._uIntensityRange,u.minIntensity,u.maxIntensity),this._uPointSize&&l.uniform1f(this._uPointSize,u.pointSize),this._uNearPlaneHeight){const F=n.camera.projection==="ortho"?1:l.drawingBufferHeight/(2*Math.tan(.5*n.camera.perspective.fov*Math.PI/180));l.uniform1f(this._uNearPlaneHeight,F)}if(d){const{colorTexture:F,metallicRoughnessTexture:z,emissiveTexture:Q,normalsTexture:H,occlusionTexture:ae}=d;this._uColorMap&&F&&(this._program.bindTexture(this._uColorMap,F.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%a),this._uMetallicRoughMap&&z&&(this._program.bindTexture(this._uMetallicRoughMap,z.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%a),this._uEmissiveMap&&Q&&(this._program.bindTexture(this._uEmissiveMap,Q.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%a),this._uNormalMap&&H&&(this._program.bindTexture(this._uNormalMap,H.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%a),this._uAOMap&&ae&&(this._program.bindTexture(this._uAOMap,ae.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%a)}if(g.reflectionMaps.length>0&&g.reflectionMaps[0].texture&&this._uReflectionMap&&(this._program.bindTexture(this._uReflectionMap,g.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%a,e.bindTexture++),g.lightMaps.length>0&&g.lightMaps[0].texture&&this._uLightMap&&(this._program.bindTexture(this._uLightMap,g.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%a,e.bindTexture++),this._withSAO){const F=n.sao;if(F.possible){const Q=l.drawingBufferWidth,H=l.drawingBufferHeight;Xr[0]=Q,Xr[1]=H,Xr[2]=F.blendCutoff,Xr[3]=F.blendFactor,l.uniform4fv(this._uSAOParams,Xr),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%a,e.bindTexture++}}if(this._useAlphaCutoff&&l.uniform1f(this._alphaCutoffLocation,d.alphaCutoff),s){const F=this._edges?"edgeColor":"fillColor",z=this._edges?"edgeAlpha":"fillAlpha";if(i===O[`${this._edges?"EDGES":"SILHOUETTE"}_XRAYED`]){const Q=n.xrayMaterial._state,H=Q[F],ae=Q[z];l.uniform4f(this._uColor,H[0],H[1],H[2],ae)}else if(i===O[`${this._edges?"EDGES":"SILHOUETTE"}_HIGHLIGHTED`]){const Q=n.highlightMaterial._state,H=Q[F],ae=Q[z];l.uniform4f(this._uColor,H[0],H[1],H[2],ae)}else if(i===O[`${this._edges?"EDGES":"SILHOUETTE"}_SELECTED`]){const Q=n.selectedMaterial._state,H=Q[F],ae=Q[z];l.uniform4f(this._uColor,H[0],H[1],H[2],ae)}else l.uniform4fv(this._uColor,this._edges?jv:Hv)}this._draw({state:c,frameCtx:e,incrementDrawState:o}),l.bindVertexArray(null)}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null,_t.memory.programs--}}class pi extends Kt{constructor(e,t,{edges:i=!1,useAlphaCutoff:s=!1}={}){super(e,t,{instancing:!1,edges:i,useAlphaCutoff:s})}_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:o}=e;if(this._edges)t.drawElements(t.LINES,i.edgeIndicesBuf.numItems,i.edgeIndicesBuf.itemType,0);else{const a=s.pickElementsCount||i.indicesBuf.numItems,n=s.pickElementsOffset?s.pickElementsOffset*i.indicesBuf.itemByteSize:0;t.drawElements(t.TRIANGLES,a,i.indicesBuf.itemType,n),o&&s.drawElements++}}}class ou extends pi{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0;let o;const a=[];a.push("#version 300 es"),a.push("// Triangles batching draw vertex shader"),a.push("uniform int renderPass;"),a.push("in vec3 position;"),a.push("in vec3 normal;"),a.push("in vec4 color;"),a.push("in float flags;"),e.entityOffsetsEnabled&&a.push("in vec3 offset;"),this._addMatricesUniformBlockLines(a,!0),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("out float isPerspective;")),a.push("uniform vec4 lightAmbient;");for(let n=0,l=i.lights.length;n<l;n++)o=i.lights[n],o.type!=="ambient"&&(a.push("uniform vec4 lightColor"+n+";"),o.type==="dir"&&a.push("uniform vec3 lightDir"+n+";"),o.type==="point"&&a.push("uniform vec3 lightPos"+n+";"),o.type==="spot"&&(a.push("uniform vec3 lightPos"+n+";"),a.push("uniform vec3 lightDir"+n+";")));a.push("vec3 octDecode(vec2 oct) {"),a.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),a.push("    if (v.z < 0.0) {"),a.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),a.push("    }"),a.push("    return normalize(v);"),a.push("}"),s&&(a.push("out vec4 vWorldPosition;"),a.push("out float vFlags;")),a.push("out vec4 vColor;"),a.push("void main(void) {"),a.push("int colorFlag = int(flags) & 0xF;"),a.push("if (colorFlag != renderPass) {"),a.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),a.push("} else {"),a.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix * worldPosition; "),a.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),a.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),a.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),a.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),a.push("float lambertian = 1.0;");for(let n=0,l=i.lights.length;n<l;n++)if(o=i.lights[n],o.type!=="ambient"){if(o.type==="dir")o.space==="view"?a.push("viewLightDir = normalize(lightDir"+n+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+n+", 0.0)).xyz);");else if(o.type==="point")o.space==="view"?a.push("viewLightDir = -normalize(lightPos"+n+" - viewPosition.xyz);"):a.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+n+", 0.0)).xyz);");else if(o.type==="spot")o.space==="view"?a.push("viewLightDir = normalize(lightDir"+n+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+n+", 0.0)).xyz);");else continue;a.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),a.push("reflectedColor += lambertian * (lightColor"+n+".rgb * lightColor"+n+".a);")}return a.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),a.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("vFragDepth = 1.0 + clipPos.w;"),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(a.push("vWorldPosition = worldPosition;"),a.push("vFlags = flags;")),a.push("gl_Position = clipPos;"),a.push("}"),a.push("}"),a}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching draw fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";");s.push("uniform float sliceThickness;"),s.push("uniform vec4 sliceColor;")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec4 newColor;"),s.push("  newColor = vColor;"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > sliceThickness) { "),s.push("      discard;"),s.push("  }"),s.push("  if (dist > 0.0) { "),s.push("      newColor = sliceColor;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),s.push("   outColor            = vec4(newColor.rgb * ambient, 1.0);")):s.push("   outColor            = newColor;"),s.push("}"),s}}class nu extends pi{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching flat-shading draw vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vViewPosition = viewPosition;"),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._lightsState,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Triangles batching flat-shading draw fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),this._withSAO&&(o.push("uniform sampler2D uOcclusionTexture;"),o.push("uniform vec4      uSAOParams;"),o.push("const float       packUpscale = 256. / 255.;"),o.push("const float       unpackDownScale = 255. / 256.;"),o.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),o.push("float unpackRGBToFloat( const in vec4 v ) {"),o.push("    return dot( v, unPackFactors );"),o.push("}")),s){o.push("in vec4 vWorldPosition;"),o.push("in float vFlags;");for(let a=0,n=i.getNumAllocatedSectionPlanes();a<n;a++)o.push("uniform bool sectionPlaneActive"+a+";"),o.push("uniform vec3 sectionPlanePos"+a+";"),o.push("uniform vec3 sectionPlaneDir"+a+";");o.push("uniform float sliceThickness;"),o.push("uniform vec4 sliceColor;")}this._addMatricesUniformBlockLines(o),o.push("uniform vec4 lightAmbient;");for(let a=0,n=t.lights.length;a<n;a++){const l=t.lights[a];l.type!=="ambient"&&(o.push("uniform vec4 lightColor"+a+";"),l.type==="dir"&&o.push("uniform vec3 lightDir"+a+";"),l.type==="point"&&o.push("uniform vec3 lightPos"+a+";"),l.type==="spot"&&(o.push("uniform vec3 lightPos"+a+";"),o.push("uniform vec3 lightDir"+a+";")))}if(o.push("in vec4 vViewPosition;"),o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),o.push("  vec4 newColor;"),o.push("  newColor = vColor;"),s){o.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;");for(let a=0,n=i.getNumAllocatedSectionPlanes();a<n;a++)o.push("if (sectionPlaneActive"+a+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > sliceThickness) { "),o.push("      discard;"),o.push("  }"),o.push("  if (dist > 0.0) { "),o.push("      newColor = sliceColor;"),o.push("  }"),o.push("}")}o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;"),o.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),o.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),o.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let a=0,n=t.lights.length;a<n;a++){const l=t.lights[a];if(l.type!=="ambient"){if(l.type==="dir")l.space==="view"?o.push("viewLightDir = normalize(lightDir"+a+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else if(l.type==="point")l.space==="view"?o.push("viewLightDir = -normalize(lightPos"+a+" - viewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+a+", 0.0)).xyz);");else if(l.type==="spot")l.space==="view"?o.push("viewLightDir = normalize(lightDir"+a+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+a+", 0.0)).xyz);");else continue;o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+a+".rgb * lightColor"+a+".a);")}}return o.push("vec4 fragColor =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),o.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):o.push("   outColor            = fragColor;"),e.logarithmicDepthBufferEnabled&&o.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}}class au extends pi{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 color;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec4 silhouetteColor;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),s.push("if (silhouetteFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vColor = vec4(silhouetteColor.r, silhouetteColor.g, silhouetteColor.b, min(silhouetteColor.a, color.a ));"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const o=t.getNumAllocatedSectionPlanes()>0,a=[];if(a.push("#version 300 es"),a.push("// Triangles batching silhouette fragment shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&(a.push("in float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("in float vFragDepth;")),o){for(a.push("in vec4 vWorldPosition;"),a.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)a.push("uniform bool sectionPlaneActive"+i+";"),a.push("uniform vec3 sectionPlanePos"+i+";"),a.push("uniform vec3 sectionPlaneDir"+i+";");a.push("uniform float sliceThickness;"),a.push("uniform vec4 sliceColor;")}if(a.push("in vec4 vColor;"),a.push("out vec4 outColor;"),a.push("void main(void) {"),a.push("  vec4 newColor;"),a.push("  newColor = vColor;"),o){a.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(let n=0,l=t.getNumAllocatedSectionPlanes();n<l;n++)a.push("if (sectionPlaneActive"+n+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+n+".xyz, vWorldPosition.xyz - sectionPlanePos"+n+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > sliceThickness) { "),a.push("      discard;"),a.push("  }"),a.push("  if (dist > 0.0) { "),a.push("      newColor = sliceColor;"),a.push("  }"),a.push("}")}return e.logarithmicDepthBufferEnabled&&a.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("outColor = newColor;"),a.push("}"),a}}class Lf extends pi{constructor(e){super(e,!1,{instancing:!1,edges:!0})}}class Wv extends Lf{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// EdgesEmphasisRenderer vertex shader"),s.push("uniform int renderPass;"),s.push("uniform vec4 color;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int edgeFlag = int(flags) >> 8 & 0xF;"),s.push("if (edgeFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vColor = vec4(color.r, color.g, color.b, color.a);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// EdgesEmphasisRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class Kv extends Lf{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!1})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Batched geometry edges drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int edgeFlag = int(flags) >> 8 & 0xF;"),s.push("if (edgeFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry edges drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class lu extends pi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry picking vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 pickColor;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),this._addRemapClipPosLines(i),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("      if (sectionPlaneActive"+a+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vPickColor; "),s.push("}"),s}}class Au extends pi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),this._addRemapClipPosLines(i),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("      if (sectionPlaneActive"+a+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}}class Xv extends pi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec3 normal;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i,3),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec3 vWorldNormal;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vec3 worldNormal =  octDecode(normal.xy); "),i.push("      vWorldNormal = worldNormal;"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching pick normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec3 vWorldNormal;"),s.push("out highp ivec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("      if (sectionPlaneActive"+a+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push(`    outNormal = ivec4(vWorldNormal * float(${A.MAX_INT}), 1.0);`),s.push("}"),s}}class Yv extends pi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching occlusion vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching occlusion fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}}class $v extends pi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching depth fragment shader"),s.push("precision highp float;"),s.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("uniform bool sectionPlaneActive"+a+";"),s.push("uniform vec3 sectionPlanePos"+a+";"),s.push("uniform vec3 sectionPlaneDir"+a+";")}if(s.push("in vec2 vHighPrecisionZW;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),s.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),s.push("}"),s}}class Zv extends pi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec3 normal;"),i.push("in vec4 color;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i,!0),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec3 vViewNormal;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags         = flags;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("uniform bool sectionPlaneActive"+a+";"),s.push("uniform vec3 sectionPlanePos"+a+";"),s.push("uniform vec3 sectionPlaneDir"+a+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}}class qv extends pi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry shadow vertex shader"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(i),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("  int colorFlag = int(flags) & 0xF;"),i.push("  bool visible        = (colorFlag > 0);"),i.push("  bool transparent    = ((float(color.a) / 255.0) < 1.0);"),i.push("  if (!visible || transparent) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("      vViewPosition = viewPosition;"),i.push("      gl_Position = shadowProjMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry shadow fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("uniform bool sectionPlaneActive"+a+";"),s.push("uniform vec3 sectionPlanePos"+a+";"),s.push("uniform vec3 sectionPlaneDir"+a+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 encodeFloat( const in float v ) {"),s.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),s.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),s.push("  vec4 comp = fract(v * bitShift);"),s.push("  comp -= comp.xxyz * bitMask;"),s.push("  return comp;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    outColor = encodeFloat( gl_FragCoord.z); "),s.push("}"),s}}class cu extends pi{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0,o=t.clippingCaps,a=[];return a.push("#version 300 es"),a.push("// Triangles batching quality draw vertex shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("precision highp usampler2D;"),a.push("precision highp isampler2D;"),a.push("precision highp sampler2D;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("precision mediump usampler2D;"),a.push("precision mediump isampler2D;"),a.push("precision mediump sampler2D;"),a.push("#endif"),a.push("uniform int renderPass;"),a.push("in vec3 position;"),a.push("in vec3 normal;"),a.push("in vec4 color;"),a.push("in vec2 uv;"),a.push("in vec2 metallicRoughness;"),a.push("in float flags;"),e.entityOffsetsEnabled&&a.push("in vec3 offset;"),this._addMatricesUniformBlockLines(a,!0),a.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("out float isPerspective;")),a.push("vec3 octDecode(vec2 oct) {"),a.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),a.push("    if (v.z < 0.0) {"),a.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),a.push("    }"),a.push("    return normalize(v);"),a.push("}"),a.push("out vec4 vViewPosition;"),a.push("out vec3 vViewNormal;"),a.push("out vec4 vColor;"),a.push("out vec2 vUV;"),a.push("out vec2 vMetallicRoughness;"),i.lightMaps.length>0&&a.push("out vec3 vWorldNormal;"),s&&(a.push("out vec4 vWorldPosition;"),a.push("out float vFlags;"),o&&a.push("out vec4 vClipPosition;")),a.push("void main(void) {"),a.push("int colorFlag = int(flags) & 0xF;"),a.push("if (colorFlag != renderPass) {"),a.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),a.push("} else {"),a.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix * worldPosition; "),a.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),a.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),a.push("vFragDepth = 1.0 + clipPos.w;")),s&&(a.push("vWorldPosition = worldPosition;"),a.push("vFlags = flags;"),o&&a.push("vClipPosition = clipPos;")),a.push("vViewPosition = viewPosition;"),a.push("vViewNormal = viewNormal;"),a.push("vColor = color;"),a.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),a.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&a.push("vWorldNormal = worldNormal.xyz;"),a.push("gl_Position = clipPos;"),a.push("}"),a.push("}"),a}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,s=e._lightsState,o=i.getNumAllocatedSectionPlanes()>0,a=i.clippingCaps,n=[];n.push("#version 300 es"),n.push("// Triangles batching quality draw fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uColorMap;"),n.push("uniform sampler2D uMetallicRoughMap;"),n.push("uniform sampler2D uEmissiveMap;"),n.push("uniform sampler2D uNormalMap;"),n.push("uniform sampler2D uAOMap;"),n.push("in vec4 vViewPosition;"),n.push("in vec3 vViewNormal;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("in vec2 vMetallicRoughness;"),s.lightMaps.length>0&&n.push("in vec3 vWorldNormal;"),this._addMatricesUniformBlockLines(n,!0),s.reflectionMaps.length>0&&n.push("uniform samplerCube reflectionMap;"),s.lightMaps.length>0&&n.push("uniform samplerCube lightMap;"),n.push("uniform vec4 lightAmbient;");for(let l=0,c=s.lights.length;l<c;l++){const h=s.lights[l];h.type!=="ambient"&&(n.push("uniform vec4 lightColor"+l+";"),h.type==="dir"&&n.push("uniform vec3 lightDir"+l+";"),h.type==="point"&&n.push("uniform vec3 lightPos"+l+";"),h.type==="spot"&&(n.push("uniform vec3 lightPos"+l+";"),n.push("uniform vec3 lightDir"+l+";")))}if(this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),o){n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),a&&n.push("in vec4 vClipPosition;");for(let l=0,c=i.getNumAllocatedSectionPlanes();l<c;l++)n.push("uniform bool sectionPlaneActive"+l+";"),n.push("uniform vec3 sectionPlanePos"+l+";"),n.push("uniform vec3 sectionPlaneDir"+l+";")}if(n.push("#define PI 3.14159265359"),n.push("#define RECIPROCAL_PI 0.31830988618"),n.push("#define RECIPROCAL_PI2 0.15915494"),n.push("#define EPSILON 1e-6"),n.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),n.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),n.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),n.push("       if (texel.x == 0.0 && texel.y == 0.0 && texel.z == 0.0) {"),n.push("              return surf_norm;"),n.push("       }"),n.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),n.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),n.push("      vec2 st0 = dFdx( uv.st );"),n.push("      vec2 st1 = dFdy( uv.st );"),n.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),n.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),n.push("      vec3 N = normalize( surf_norm );"),n.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),n.push("      mat3 tsn = mat3( S, T, N );"),n.push("      return normalize( tsn * mapN );"),n.push("}"),n.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),n.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),n.push("}"),n.push("struct IncidentLight {"),n.push("   vec3 color;"),n.push("   vec3 direction;"),n.push("};"),n.push("struct ReflectedLight {"),n.push("   vec3 diffuse;"),n.push("   vec3 specular;"),n.push("};"),n.push("struct Geometry {"),n.push("   vec3 position;"),n.push("   vec3 viewNormal;"),n.push("   vec3 worldNormal;"),n.push("   vec3 viewEyeDir;"),n.push("};"),n.push("struct Material {"),n.push("   vec3  diffuseColor;"),n.push("   float specularRoughness;"),n.push("   vec3  specularColor;"),n.push("   float shine;"),n.push("};"),n.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),n.push("   float r = ggxRoughness + 0.0001;"),n.push("   return (2.0 / (r * r) - 2.0);"),n.push("}"),n.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),n.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),n.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),n.push("}"),s.reflectionMaps.length>0&&(n.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),n.push("   vec3 envMapColor = sRGBToLinear(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),n.push("  return envMapColor;"),n.push("}")),n.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),n.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),n.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),n.push("}"),n.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   return 1.0 / ( gl * gv );"),n.push("}"),n.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   return 0.5 / max( gv + gl, EPSILON );"),n.push("}"),n.push("float D_GGX(const in float alpha, const in float dotNH) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),n.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float alpha = ( roughness * roughness );"),n.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),n.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),n.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),n.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),n.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),n.push("   vec3  F = F_Schlick( specularColor, dotLH );"),n.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),n.push("   float D = D_GGX( alpha, dotNH );"),n.push("   return F * (G * D);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),n.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),n.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),n.push("   vec4 r = roughness * c0 + c1;"),n.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),n.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),n.push("   return specularColor * AB.x + AB.y;"),n.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(n.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(n.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),n.push("   irradiance *= PI;"),n.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.diffuse +=  irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(n.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),n.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),n.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),n.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),n.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),n.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),n.push("}")),n.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),n.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),n.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),n.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),n.push("}"),n.push("out vec4 outColor;"),n.push("void main(void) {"),o){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let l=0,c=i.getNumAllocatedSectionPlanes();l<c;l++)n.push("if (sectionPlaneActive"+l+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+l+".xyz, vWorldPosition.xyz - sectionPlanePos"+l+".xyz), 0.0, 1000.0);"),n.push("}");a?(n.push("  if (dist > (0.002 * vClipPosition.w)) {"),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&n.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("  return;"),n.push("}")):(n.push("  if (dist > 0.0) { "),n.push("      discard;"),n.push("  }")),n.push("}")}n.push("IncidentLight  light;"),n.push("Material       material;"),n.push("Geometry       geometry;"),n.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),n.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),n.push("float opacity = float(vColor.a) / 255.0;"),n.push("vec3  baseColor = rgb;"),n.push("float specularF0 = 1.0;"),n.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),n.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),n.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),n.push("vec4 colorTexel = sRGBToLinear(texture(uColorMap, vUV));"),n.push("baseColor *= colorTexel.rgb;"),n.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),n.push("metallic *= metalRoughTexel.b;"),n.push("roughness *= metalRoughTexel.g;"),n.push("vec3 viewNormal = perturbNormal2Arb(vViewPosition.xyz, normalize(vViewNormal), vUV );"),n.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),n.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),n.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),n.push("geometry.position      = vViewPosition.xyz;"),n.push("geometry.viewNormal    = -normalize(viewNormal);"),n.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),s.lightMaps.length>0&&n.push("geometry.worldNormal   = normalize(vWorldNormal);"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&n.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let l=0,c=s.lights.length;l<c;l++){const h=s.lights[l];if(h.type!=="ambient"){if(h.type==="dir")h.space==="view"?n.push("light.direction =  normalize(lightDir"+l+");"):n.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);");else if(h.type==="point")h.space==="view"?n.push("light.direction =  normalize(lightPos"+l+" - vViewPosition.xyz);"):n.push("light.direction =  normalize((viewMatrix * vec4(lightPos"+l+", 0.0)).xyz);");else if(h.type==="spot")h.space==="view"?n.push("light.direction =  normalize(lightDir"+l+");"):n.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);");else continue;n.push("light.color =  lightColor"+l+".rgb * lightColor"+l+".a;"),n.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return n.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),n.push("float aoFactor = texture(uAOMap, vUV).r;"),n.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),n.push("vec4 fragColor;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   fragColor               = vec4(outgoingLight.rgb * ambient * aoFactor, opacity);")):n.push("   fragColor            = vec4(outgoingLight.rgb * aoFactor, opacity);"),t&&n.push("fragColor = linearToGamma(fragColor, gammaFactor);"),n.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}class Jv extends pi{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick flat normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i,3),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching pick flat normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("in vec4 vWorldPosition;"),i){s.push("in float vFlags;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out highp ivec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("      if (sectionPlaneActive"+a+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`  outNormal = ivec4(worldNormal * float(${A.MAX_INT}), 1.0);`),s.push("}"),s}}class _n extends pi{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Triangles batching color texture vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in vec2 uv;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),this._addMatricesUniformBlockLines(s),s.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 vColor;"),s.push("out vec2 vUV;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vViewPosition = viewPosition;"),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),s.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._lightsState,s=e._sectionPlanesState,o=s.getNumAllocatedSectionPlanes()>0,a=this._useAlphaCutoff,n=[];if(n.push("#version 300 es"),n.push("// Triangles batching color texture fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uColorMap;"),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),o){n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;");for(let l=0,c=s.getNumAllocatedSectionPlanes();l<c;l++)n.push("uniform bool sectionPlaneActive"+l+";"),n.push("uniform vec3 sectionPlanePos"+l+";"),n.push("uniform vec3 sectionPlaneDir"+l+";");n.push("uniform float sliceThickness;"),n.push("uniform vec4 sliceColor;")}this._addMatricesUniformBlockLines(n),n.push("uniform vec4 lightAmbient;");for(let l=0,c=i.lights.length;l<c;l++){const h=i.lights[l];h.type!=="ambient"&&(n.push("uniform vec4 lightColor"+l+";"),h.type==="dir"&&n.push("uniform vec3 lightDir"+l+";"),h.type==="point"&&n.push("uniform vec3 lightPos"+l+";"),h.type==="spot"&&(n.push("uniform vec3 lightPos"+l+";"),n.push("uniform vec3 lightDir"+l+";")))}if(a&&n.push("uniform float materialAlphaCutoff;"),n.push("in vec4 vViewPosition;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),n.push("  vec4 newColor;"),n.push("  newColor = vColor;"),o){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let l=0,c=s.getNumAllocatedSectionPlanes();l<c;l++)n.push("if (sectionPlaneActive"+l+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+l+".xyz, vWorldPosition.xyz - sectionPlanePos"+l+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > sliceThickness) { "),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      newColor = sliceColor;"),n.push("  }"),n.push("}")}n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),n.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),n.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),n.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let l=0,c=i.lights.length;l<c;l++){const h=i.lights[l];if(h.type!=="ambient"){if(h.type==="dir")h.space==="view"?n.push("viewLightDir = normalize(lightDir"+l+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);");else if(h.type==="point")h.space==="view"?n.push("viewLightDir = -normalize(lightPos"+l+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+l+", 0.0)).xyz);");else if(h.type==="spot")h.space==="view"?n.push("viewLightDir = normalize(lightDir"+l+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);");else continue;n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+l+".rgb * lightColor"+l+".a);")}}return n.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),n.push("vec4 sampleColor = texture(uColorMap, vUV);"),a&&(n.push("if (sampleColor.a < materialAlphaCutoff) {"),n.push("   discard;"),n.push("}")),t&&n.push("sampleColor = sRGBToLinear(sampleColor);"),n.push("vec4 colorTexel = color * sampleColor;"),n.push("float opacity = color.a;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor                = vec4(colorTexel.rgb * ambient, opacity);")):n.push("   outColor                = vec4(colorTexel.rgb, opacity);"),t&&n.push("outColor = linearToGamma(outColor, gammaFactor);"),e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}const eP=A.vec3(),tP=A.vec3(),iP=A.vec3(),sP=A.vec3(),rP=A.mat4();class hu extends Kt{drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=t._state.origin,{position:h,rotationMatrix:d}=s,p=t.aabb,m=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));const g=eP;g[0]=A.safeInv(p[3]-p[0])*A.MAX_INT,g[1]=A.safeInv(p[4]-p[1])*A.MAX_INT,g[2]=A.safeInv(p[5]-p[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(g[0]),e.snapPickCoordinateScale[1]=A.safeInv(g[1]),e.snapPickCoordinateScale[2]=A.safeInv(g[2]);let u,x;if(c||h[0]!==0||h[1]!==0||h[2]!==0){const _=tP;if(c){const b=iP;A.transformPoint3(d,c,b),_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=h[0],_[1]+=h[1],_[2]+=h[2],u=Pt(m,_,rP),x=sP,x[0]=a.eye[0]-_[0],x[1]=a.eye[1]-_[1],x[2]=a.eye[2]-_[2],e.snapPickOrigin[0]=_[0],e.snapPickOrigin[1]=_[1],e.snapPickOrigin[2]=_[2]}else u=m,x=a.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,x),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,g),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const P=4*4;this._matricesUniformBlockBufferData.set(d,0),this._matricesUniformBlockBufferData.set(u,y+=P),this._matricesUniformBlockBufferData.set(a.projMatrix,y+=P),this._matricesUniformBlockBufferData.set(l.positionsDecodeMatrix,y+=P),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const _=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,_)}this.setSectionPlanesStateUniforms(t),l.indicesBuf.bind(),n.drawElements(n.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0),l.indicesBuf.unbind()}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// VBO SnapBatchingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// VBO SnapBatchingDepthBufInitRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),s.push("in vec4 vWorldPosition;"),s.push("flat in vec4 vPickColor;"),i){s.push("in float vFlags;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("uniform bool sectionPlaneActive"+a+";"),s.push("uniform vec3 sectionPlanePos"+a+";"),s.push("uniform vec3 sectionPlaneDir"+a+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("layout(location = 0) out highp ivec4 outCoords;"),s.push("layout(location = 1) out highp ivec4 outNormal;"),s.push("layout(location = 2) out lowp uvec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),s.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`outNormal = ivec4(worldNormal * float(${A.MAX_INT}), 1.0);`),s.push("outPickColor = uvec4(vPickColor);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const oP=A.vec3(),nP=A.vec3(),aP=A.vec3(),lP=A.vec3(),AP=A.mat4();class uu extends Kt{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=t._state.origin,{position:h,rotationMatrix:d}=s,p=t.aabb,m=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));const g=oP;g[0]=A.safeInv(p[3]-p[0])*A.MAX_INT,g[1]=A.safeInv(p[4]-p[1])*A.MAX_INT,g[2]=A.safeInv(p[5]-p[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(g[0]),e.snapPickCoordinateScale[1]=A.safeInv(g[1]),e.snapPickCoordinateScale[2]=A.safeInv(g[2]);let u,x;if(c||h[0]!==0||h[1]!==0||h[2]!==0){const _=nP;if(c){const b=aP;A.transformPoint3(d,c,b),_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=h[0],_[1]+=h[1],_[2]+=h[2],u=Pt(m,_,AP),x=lP,x[0]=a.eye[0]-_[0],x[1]=a.eye[1]-_[1],x[2]=a.eye[2]-_[2],e.snapPickOrigin[0]=_[0],e.snapPickOrigin[1]=_[1],e.snapPickOrigin[2]=_[2]}else u=m,x=a.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,x),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,g),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const P=4*4;this._matricesUniformBlockBufferData.set(d,0),this._matricesUniformBlockBufferData.set(u,y+=P),this._matricesUniformBlockBufferData.set(a.projMatrix,y+=P),this._matricesUniformBlockBufferData.set(l.positionsDecodeMatrix,y+=P),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const _=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,_)}this.setSectionPlanesStateUniforms(t),e.snapMode==="edge"?(l.edgeIndicesBuf.bind(),n.drawElements(n.LINES,l.edgeIndicesBuf.numItems,l.edgeIndicesBuf.itemType,0),l.edgeIndicesBuf.unbind()):n.drawArrays(n.POINTS,0,l.positionsBuf.numItems)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;const i=[];return i.push("#version 300 es"),i.push("// SnapBatchingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(2.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// SnapBatchingDepthRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("uniform bool sectionPlaneActive"+a+";"),s.push("uniform vec3 sectionPlanePos"+a+";"),s.push("uniform vec3 sectionPlaneDir"+a+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("out highp ivec4 outCoords;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class cP{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._colorTextureRendererAlphaCutoff&&!this._colorTextureRendererAlphaCutoff.getValid()&&(this._colorTextureRendererAlphaCutoff.destroy(),this._colorTextureRendererAlphaCutoff=null),this._colorTextureRendererWithSAOAlphaCutoff&&!this._colorTextureRendererWithSAOAlphaCutoff.getValid()&&(this._colorTextureRendererWithSAOAlphaCutoff.destroy(),this._colorTextureRendererWithSAOAlphaCutoff=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&this._pickNormalsRenderer.getValid()===!1&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.getValid()===!1&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}eagerCreateRenders(){this._silhouetteRenderer||(this._silhouetteRenderer=new au(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new lu(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new Au(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new hu(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new uu(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new ou(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new ou(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new nu(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new nu(this._scene,!0)),this._flatColorRendererWithSAO}get colorTextureRenderer(){return this._colorTextureRenderer||(this._colorTextureRenderer=new _n(this._scene,!1)),this._colorTextureRenderer}get colorTextureRendererWithSAO(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new _n(this._scene,!0)),this._colorTextureRendererWithSAO}get colorTextureRendererAlphaCutoff(){return this._colorTextureRendererAlphaCutoff||(this._colorTextureRendererAlphaCutoff=new _n(this._scene,!1,{useAlphaCutoff:!0})),this._colorTextureRendererAlphaCutoff}get colorTextureRendererWithSAOAlphaCutoff(){return this._colorTextureRendererWithSAOAlphaCutoff||(this._colorTextureRendererWithSAOAlphaCutoff=new _n(this._scene,!0,{useAlphaCutoff:!0})),this._colorTextureRendererWithSAOAlphaCutoff}get pbrRenderer(){return this._pbrRenderer||(this._pbrRenderer=new cu(this._scene,!1)),this._pbrRenderer}get pbrRendererWithSAO(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new cu(this._scene,!0)),this._pbrRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new au(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new $v(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new Zv(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new Wv(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Kv(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new lu(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Xv(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Jv(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Au(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Yv(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new qv(this._scene)),this._shadowRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new uu(this._scene)),this._snapRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new hu(this._scene)),this._snapInitRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererAlphaCutoff&&this._colorTextureRendererAlphaCutoff.destroy(),this._colorTextureRendererWithSAOAlphaCutoff&&this._colorTextureRendererWithSAOAlphaCutoff.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const _l={};function hP(r){const e=r.id;let t=_l[e];return t||(t=new cP(r),_l[e]=t,t._compile(),t.eagerCreateRenders(),r.on("compile",()=>{t._compile(),t.eagerCreateRenders()}),r.on("destroyed",()=>{delete _l[e],t._destroy()})),t}let du=65536,pu=5e6;class uc{constructor(){}set doublePrecisionEnabled(e){A.setDoublePrecisionEnabled(e)}get doublePrecisionEnabled(){return A.getDoublePrecisionEnabled()}set maxDataTextureHeight(e){e=Math.ceil(e/1024)*1024,e>4096?e=4096:e<1024&&(e=1024),du=e}get maxDataTextureHeight(){return du}set maxGeometryBatchSize(e){e<1e5?e=1e5:e>5e6&&(e=5e6),pu=e}get maxGeometryBatchSize(){return pu}}const uP=new uc;class dP{constructor(e=uP.maxGeometryBatchSize){this.maxVerts=e,this.maxIndices=e*3,this.positions=[],this.colors=[],this.uv=[],this.metallicRoughness=[],this.normals=[],this.pickColors=[],this.offsets=[],this.indices=[],this.edgeIndices=[]}}const wr=A.mat4(),Cr=A.mat4();function Io(r,e,t){const i=r.length,s=new Uint16Array(i),o=e[0],a=e[1],n=e[2],l=e[3]-o,c=e[4]-a,h=e[5]-n,d=65525,p=d/l,m=d/c,g=d/h,u=x=>x>=0?x:0;for(let x=0;x<i;x+=3)s[x+0]=Math.floor(u(r[x+0]-o)*p),s[x+1]=Math.floor(u(r[x+1]-a)*m),s[x+2]=Math.floor(u(r[x+2]-n)*g);return A.identityMat4(wr),A.translationMat4v(e,wr),A.identityMat4(Cr),A.scalingMat4v([l/d,c/d,h/d],Cr),A.mulMat4(wr,Cr,t),s}function vl(r,e){const t=r[0],i=r[1],s=r[2],o=r[3]-t,a=r[4]-i,n=r[5]-s,l=65525;return A.identityMat4(wr),A.translationMat4v(r,wr),A.identityMat4(Cr),A.scalingMat4v([o/l,a/l,n/l],Cr),A.mulMat4(wr,Cr,e),e}function pP(r,e,t,i,s){function o(g,u){return g[0]*u[0]+g[1]*u[1]+g[2]*u[2]}let a,n,l,c,h,d,p=new Float32Array([0,0,0,0]),m=new Float32Array([0,0,0,0]);for(d=0;d<t;d+=3)p[0]=e[d],p[1]=e[d+1],p[2]=e[d+2],A.transformVec3(r,p,m),A.normalizeVec3(m,m),l=a=vn(m,"floor","floor"),n=Pn(a),c=h=o(m,n),a=vn(m,"ceil","floor"),n=Pn(a),c=o(m,n),c>h&&(l=a,h=c),a=vn(m,"floor","ceil"),n=Pn(a),c=o(m,n),c>h&&(l=a,h=c),a=vn(m,"ceil","ceil"),n=Pn(a),c=o(m,n),c>h&&(l=a,h=c),i[s+d+0]=l[0],i[s+d+1]=l[1],i[s+d+2]=0;return s+=t,s}function vn(r,e,t){let i=r[0]/(Math.abs(r[0])+Math.abs(r[1])+Math.abs(r[2])),s=r[1]/(Math.abs(r[0])+Math.abs(r[1])+Math.abs(r[2]));if(r[2]<0){let o=i,a=s;o=(1-Math.abs(s))*(i>=0?1:-1),a=(1-Math.abs(i))*(s>=0?1:-1),i=o,s=a}return new Int8Array([Math[e](i*127.5+(i<0?-1:0)),Math[t](s*127.5+(s<0?-1:0))])}function Pn(r){let e=r[0],t=r[1];e/=e<0?127:128,t/=t<0?127:128;const i=1-Math.abs(e)-Math.abs(t);i<0&&(e=(1-Math.abs(t))*(e>=0?1:-1),t=(1-Math.abs(e))*(t>=0?1:-1));const s=Math.sqrt(e*e+t*t+i*i);return[e/s,t/s,i/s]}const fP=A.mat4(),mP=A.mat4(),gP=A.vec4([0,0,0,1]),_P=A.vec3(),vP=A.vec3(),PP=A.vec3(),xP=A.vec3(),yP=A.vec3(),bP=A.vec3(),BP=A.vec3();class Pl{constructor(e){this.model=e.model,this.sortId="TrianglesBatchingLayer"+(e.solid?"-solid":"-surface")+(e.autoNormals?"-autonormals":"-normals")+(e.textureSet&&e.textureSet.colorTexture?"-colorTexture":"")+(e.textureSet&&e.textureSet.metallicRoughnessTexture?"-metallicRoughnessTexture":""),this.layerIndex=e.layerIndex,this._renderers=hP(e.model.scene),this._buffer=new dP(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Mt({origin:A.vec3(),positionsBuf:null,offsetsBuf:null,normalsBuf:null,colorsBuf:null,uvBuf:null,metallicRoughnessBuf:null,flagsBuf:null,indicesBuf:null,edgeIndicesBuf:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,textureSet:e.textureSet,pbrSupported:!1}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=A.collapseAABB3(),this._portions=[],this._meshes=[],this._numVerts=0,this._aabb=A.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,e.positionsDecodeMatrix&&(this._state.positionsDecodeMatrix=A.mat4(e.positionsDecodeMatrix)),e.uvDecodeMatrix?(this._state.uvDecodeMatrix=A.mat3(e.uvDecodeMatrix),this._preCompressedUVsExpected=!0):this._preCompressedUVsExpected=!1,e.origin&&this._state.origin.set(e.origin),this.solid=!!e.solid,this.primitive=e.primitive}get aabb(){if(this.aabbDirty){A.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)A.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e,t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<this._buffer.maxVerts*3&&this._buffer.indices.length+t<this._buffer.maxIndices}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=t.positions,s=t.positionsCompressed,o=t.normals,a=t.normalsCompressed,n=t.uv,l=t.uvCompressed,c=t.colors,h=t.colorsCompressed,d=t.indices,p=t.edgeIndices,m=t.color,g=t.metallic,u=t.roughness,x=t.opacity,y=t.meshMatrix,P=t.pickColor,_=this.model.scene,b=this._buffer,B=b.positions.length/3;let w;if(A.expandAABB3(this._modelAABB,t.aabb),this._state.positionsDecodeMatrix){if(!s)throw"positionsCompressed expected";w=s.length/3;for(let F=0,z=s.length;F<z;F++)b.positions.push(s[F])}else{if(!i)throw"positions expected";w=i.length/3;for(let F=0,z=i.length;F<z;F++)b.positions.push(i[F])}if(a&&a.length>0)for(let F=0,z=a.length;F<z;F++)b.normals.push(a[F]);else if(o&&o.length>0){const F=fP;y?A.inverseMat4(A.transposeMat4(y,mP),F):A.identityMat4(F,F),pP(F,o,o.length,b.normals,b.normals.length)}if(c)for(let F=0,z=c.length;F<z;F+=3)b.colors.push(c[F]*255),b.colors.push(c[F+1]*255),b.colors.push(c[F+2]*255),b.colors.push(255);else if(h)for(let F=0,z=c.length;F<z;F+=3)b.colors.push(c[F]),b.colors.push(c[F+1]),b.colors.push(c[F+2]),b.colors.push(255);else if(m){const F=m[0],z=m[1],Q=m[2],H=x;for(let ae=0;ae<w;ae++)b.colors.push(F),b.colors.push(z),b.colors.push(Q),b.colors.push(H)}const C=g??0,E=u??255;for(let F=0;F<w;F++)b.metallicRoughness.push(C),b.metallicRoughness.push(E);if(n&&n.length>0)for(let F=0,z=n.length;F<z;F++)b.uv.push(n[F]);else if(l&&l.length>0)for(let F=0,z=l.length;F<z;F++)b.uv.push(l[F]);for(let F=0,z=d.length;F<z;F++)b.indices.push(B+d[F]);if(p)for(let F=0,z=p.length;F<z;F++)b.edgeIndices.push(B+p[F]);{const F=b.pickColors.length,z=w*4;for(let Q=F,H=F+z;Q<H;Q+=4)b.pickColors.push(P[0]),b.pickColors.push(P[1]),b.pickColors.push(P[2]),b.pickColors.push(P[3])}if(_.entityOffsetsEnabled)for(let F=0;F<w;F++)b.offsets.push(0),b.offsets.push(0),b.offsets.push(0);const I=this._portions.length,R={vertsBaseIndex:B,numVerts:w,indicesBaseIndex:b.indices.length-d.length,numIndices:d.length};return _.readableGeometryEnabled&&(R.indices=d,_.entityOffsetsEnabled&&(R.offset=new Float32Array(3))),this._portions.push(R),this._numPortions++,this.model.numPortions++,this._numVerts+=R.numVerts,this._meshes.push(e),I}finalize(){if(this._finalized)return;const e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0){const s=this._state.positionsDecodeMatrix?new Uint16Array(i.positions):Io(i.positions,this._modelAABB,this._state.positionsDecodeMatrix=A.mat4());if(e.positionsBuf=new Oe(t,t.ARRAY_BUFFER,s,s.length,3,t.STATIC_DRAW),this.model.scene.readableGeometryEnabled)for(let o=0,a=this._portions.length;o<a;o++){const n=this._portions[o],l=n.vertsBaseIndex*3,c=l+n.numVerts*3;n.quantizedPositions=s.slice(l,c)}}if(i.normals.length>0){const s=new Int8Array(i.normals);let o=!0;e.normalsBuf=new Oe(t,t.ARRAY_BUFFER,s,i.normals.length,3,t.STATIC_DRAW,o)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let o=!1;e.colorsBuf=new Oe(t,t.ARRAY_BUFFER,s,i.colors.length,4,t.DYNAMIC_DRAW,o)}if(i.uv.length>0)if(e.uvDecodeMatrix){let s=!1;e.uvBuf=new Oe(t,t.ARRAY_BUFFER,i.uv,i.uv.length,2,t.STATIC_DRAW,s)}else{const s=at.getUVBounds(i.uv),o=at.compressUVs(i.uv,s.min,s.max),a=o.quantized;let n=!1;e.uvDecodeMatrix=A.mat3(o.decodeMatrix),e.uvBuf=new Oe(t,t.ARRAY_BUFFER,a,a.length,2,t.STATIC_DRAW,n)}if(i.metallicRoughness.length>0){const s=new Uint8Array(i.metallicRoughness);let o=!1;e.metallicRoughnessBuf=new Oe(t,t.ARRAY_BUFFER,s,i.metallicRoughness.length,2,t.STATIC_DRAW,o)}if(i.positions.length>0){const s=i.positions.length/3,o=new Float32Array(s),a=!1;e.flagsBuf=new Oe(t,t.ARRAY_BUFFER,o,o.length,1,t.DYNAMIC_DRAW,a)}if(i.pickColors.length>0){const s=new Uint8Array(i.pickColors);let o=!1;e.pickColorsBuf=new Oe(t,t.ARRAY_BUFFER,s,i.pickColors.length,4,t.STATIC_DRAW,o)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);e.offsetsBuf=new Oe(t,t.ARRAY_BUFFER,s,i.offsets.length,3,t.DYNAMIC_DRAW)}if(i.indices.length>0){const s=new Uint32Array(i.indices);e.indicesBuf=new Oe(t,t.ELEMENT_ARRAY_BUFFER,s,i.indices.length,1,t.STATIC_DRAW)}if(i.edgeIndices.length>0){const s=new Uint32Array(i.edgeIndices);e.edgeIndicesBuf=new Oe(t,t.ELEMENT_ARRAY_BUFFER,s,i.edgeIndices.length,1,t.STATIC_DRAW)}this._state.pbrSupported=!!e.metallicRoughnessBuf&&!!e.uvBuf&&!!e.normalsBuf&&!!e.textureSet&&!!e.textureSet.colorTexture&&!!e.textureSet.metallicRoughnessTexture,this._state.colorTextureSupported=!!e.uvBuf&&!!e.textureSet&&!!e.textureSet.colorTexture,this._buffer=null,this._finalized=!0}isEmpty(){return!this._state.indicesBuf}initFlags(e,t,i){t&N.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&N.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&N.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&N.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&N.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&N.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&N.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i,!0)}flushInitFlags(){this._setDeferredFlags()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&N.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&N.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&N.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&N.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&N.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&N.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&N.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&N.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";const i=e,s=this._portions[i],o=s.vertsBaseIndex,a=s.numVerts,n=o*4,l=a*4,c=this._scratchMemory.getUInt8Array(l),h=t[0],d=t[1],p=t[2],m=t[3];for(let g=0;g<l;g+=4)c[g+0]=h,c[g+1]=d,c[g+2]=p,c[g+3]=m;this._state.colorsBuf&&this._state.colorsBuf.setData(c,n,l)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const o=e,a=this._portions[o],n=a.vertsBaseIndex,l=a.numVerts,c=n,h=l,d=!!(t&N.VISIBLE),p=!!(t&N.XRAYED),m=!!(t&N.HIGHLIGHTED),g=!!(t&N.SELECTED),u=!!(t&N.EDGES),x=!!(t&N.PICKABLE),y=!!(t&N.CULLED);let P;!d||y||p||m&&!this.model.scene.highlightMaterial.glowThrough||g&&!this.model.scene.selectedMaterial.glowThrough?P=O.NOT_RENDERED:i?P=O.COLOR_TRANSPARENT:P=O.COLOR_OPAQUE;let _;!d||y?_=O.NOT_RENDERED:g?_=O.SILHOUETTE_SELECTED:m?_=O.SILHOUETTE_HIGHLIGHTED:p?_=O.SILHOUETTE_XRAYED:_=O.NOT_RENDERED;let b=0;!d||y?b=O.NOT_RENDERED:g?b=O.EDGES_SELECTED:m?b=O.EDGES_HIGHLIGHTED:p?b=O.EDGES_XRAYED:u?i?b=O.EDGES_COLOR_TRANSPARENT:b=O.EDGES_COLOR_OPAQUE:b=O.NOT_RENDERED;let B=d&&!y&&x?O.PICK:O.NOT_RENDERED;const w=t&N.CLIPPABLE?1:0;if(s){this._deferredFlagValues||(this._deferredFlagValues=new Float32Array(this._numVerts));for(let C=c,E=c+h;C<E;C++){let I=0;I|=P,I|=_<<4,I|=b<<8,I|=B<<12,I|=w<<16,this._deferredFlagValues[C]=I}}else if(this._state.flagsBuf){const C=this._scratchMemory.getFloat32Array(h);for(let E=0;E<h;E++){let I=0;I|=P,I|=_<<4,I|=b<<8,I|=B<<12,I|=w<<16,C[E]=I}this._state.flagsBuf.setData(C,c,h)}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}const i=e,s=this._portions[i],o=s.vertsBaseIndex,a=s.numVerts,n=o*3,l=a*3,c=this._scratchMemory.getFloat32Array(l),h=t[0],d=t[1],p=t[2];for(let m=0;m<l;m+=3)c[m+0]=h,c[m+1]=d,c[m+2]=p;this._state.offsetsBuf&&this._state.offsetsBuf.setData(c,n,l),this.model.scene.readableGeometryEnabled&&(s.offset[0]=t[0],s.offset[1]=t[1],s.offset[2]=t[2])}getEachVertex(e,t){if(!this.model.scene.readableGeometryEnabled)return;const i=this._state,s=this._portions[e];if(!s){this.model.error("portion not found: "+e);return}const o=s.quantizedPositions,a=this.model.matrix,n=A.vec4();n.set(i.origin,0),n[3]=1,A.mulMat4v4(a,n,n);const l=n[0],c=n[1],h=n[2],d=gP,p=i.positionsDecodeMatrix;for(let m=0,g=o.length;m<g;m+=3)d[0]=o[m],d[1]=o[m+1],d[2]=o[m+2],d[3]=1,A.decompressPosition(d,p),d[3]=1,A.mulMat4v4(a,d,d),d[0]+=l,d[1]+=c,d[2]+=h,t(d)}getEachIndex(e,t){if(!this.model.scene.readableGeometryEnabled)return;const i=this._portions[e];if(!i){this.model.error("portion not found: "+e);return}const s=i.indices;for(let o=0,a=s.length;o<a;o++)t(s[o])}getElementsCountAndOffset(e){let t=null,i=null;const s=this._portions[e];return s&&(t=s.numIndices,i=s.indicesBaseIndex),{count:t,offset:i}}drawColorOpaque(e,t){if(this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions)return;this._updateBackfaceCull(e,t);const i=this._state.textureSet&&typeof this._state.textureSet.alphaCutoff=="number";t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRendererWithSAO&&this._renderers.pbrRendererWithSAO.drawLayer(t,this,O.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?i?this._renderers.colorTextureRendererWithSAOAlphaCutoff&&this._renderers.colorTextureRendererWithSAOAlphaCutoff.drawLayer(t,this,O.COLOR_OPAQUE):this._renderers.colorTextureRendererWithSAO&&this._renderers.colorTextureRendererWithSAO.drawLayer(t,this,O.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(t,this,O.COLOR_OPAQUE):this._renderers.flatColorRendererWithSAO&&this._renderers.flatColorRendererWithSAO.drawLayer(t,this,O.COLOR_OPAQUE):t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,O.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?i?this._renderers.colorTextureRendererAlphaCutoff&&this._renderers.colorTextureRendererAlphaCutoff.drawLayer(t,this,O.COLOR_OPAQUE):this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,O.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_OPAQUE):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,O.COLOR_OPAQUE)}_updateBackfaceCull(e,t){const i=this.model.backfaces||!this.solid||e.sectioned;if(t.backfaces!==i){const s=t.gl;i?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),t.backfaces=i}}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._state.textureSet&&typeof this._state.textureSet.alphaCutoff=="number"?this._renderers.colorTextureRendererAlphaCutoff&&this._renderers.colorTextureRendererAlphaCutoff.drawLayer(t,this,O.COLOR_TRANSPARENT):this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT))}drawDepth(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(t,this,O.COLOR_OPAQUE))}drawNormals(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(t,this,O.COLOR_OPAQUE))}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_XRAYED))}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_HIGHLIGHTED))}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_SELECTED))}drawEdgesColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,O.EDGES_COLOR_OPAQUE)}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._numTransparentLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,O.EDGES_COLOR_TRANSPARENT)}drawEdgesHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,O.EDGES_HIGHLIGHTED)}drawEdgesSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,O.EDGES_SELECTED)}drawEdgesXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,O.EDGES_XRAYED)}drawOcclusion(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,O.COLOR_OPAQUE))}drawShadow(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(t,this,O.COLOR_OPAQUE))}drawPickMesh(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,O.PICK))}drawPickDepths(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,O.PICK))}drawPickNormals(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickNormalsFlatRenderer&&this._renderers.pickNormalsFlatRenderer.drawLayer(t,this,O.PICK))}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,O.PICK))}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,O.PICK))}precisionRayPickSurface(e,t,i,s,o){if(!this.model.scene.readableGeometryEnabled)return!1;const a=this._state,n=this._portions[e];if(!n)return this.model.error("portion not found: "+e),!1;const l=n.quantizedPositions,c=n.indices,h=a.origin,d=n.offset,p=_P,m=vP;p.set(h?A.subVec3(t,h,PP):t),m.set(i),d&&A.subVec3(p,d),A.transformRay(this.model.worldNormalMatrix,p,m,p,m);const g=xP,u=yP,x=bP;let y=!1,P=0;const _=BP;for(let b=0,B=c.length;b<B;b+=3){const w=c[b]*3,C=c[b+1]*3,E=c[b+2]*3;if(g[0]=l[w],g[1]=l[w+1],g[2]=l[w+2],u[0]=l[C],u[1]=l[C+1],u[2]=l[C+2],x[0]=l[E],x[1]=l[E+1],x[2]=l[E+2],A.decompressPosition(g,a.positionsDecodeMatrix),A.decompressPosition(u,a.positionsDecodeMatrix),A.decompressPosition(x,a.positionsDecodeMatrix),A.rayTriangleIntersect(p,m,g,u,x,_)){A.transformPoint3(this.model.worldMatrix,_,_),d&&A.addVec3(_,d),h&&A.addVec3(_,h);const I=Math.abs(A.lenVec3(A.subVec3(_,t,[])));(!y||I>P)&&(P=I,s.set(_),o&&A.triangleNormal(g,u,x,o),y=!0)}}return y&&o&&(A.transformVec3(this.model.worldNormalMatrix,o,o),A.normalizeVec3(o)),y}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.normalsBuf&&(e.normalsBuf.destroy(),e.normalsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.edgeIndicesBuf&&(e.edgeIndicesBuf.destroy(),e.edgeIndicessBuf=null),e.destroy()}}class fi extends Kt{constructor(e,t,{edges:i=!1,useAlphaCutoff:s=!1}={}){super(e,t,{instancing:!0,edges:i,useAlphaCutoff:s})}_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:o}=e;this._edges?t.drawElementsInstanced(t.LINES,i.edgeIndicesBuf.numItems,i.edgeIndicesBuf.itemType,0,i.numInstances):(t.drawElementsInstanced(t.TRIANGLES,i.indicesBuf.numItems,i.indicesBuf.itemType,0,i.numInstances),o&&s.drawElements++)}}class fu extends fi{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0;let o,a,n;const l=[];for(l.push("#version 300 es"),l.push("// Instancing geometry drawing vertex shader"),l.push("uniform int renderPass;"),l.push("in vec3 position;"),l.push("in vec2 normal;"),l.push("in vec4 color;"),l.push("in float flags;"),e.entityOffsetsEnabled&&l.push("in vec3 offset;"),l.push("in vec4 modelMatrixCol0;"),l.push("in vec4 modelMatrixCol1;"),l.push("in vec4 modelMatrixCol2;"),l.push("in vec4 modelNormalMatrixCol0;"),l.push("in vec4 modelNormalMatrixCol1;"),l.push("in vec4 modelNormalMatrixCol2;"),this._addMatricesUniformBlockLines(l,!0),e.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),l.push("out float vFragDepth;"),l.push("bool isPerspectiveMatrix(mat4 m) {"),l.push("    return (m[2][3] == - 1.0);"),l.push("}"),l.push("out float isPerspective;")),l.push("uniform vec4 lightAmbient;"),o=0,a=i.lights.length;o<a;o++)n=i.lights[o],n.type!=="ambient"&&(l.push("uniform vec4 lightColor"+o+";"),n.type==="dir"&&l.push("uniform vec3 lightDir"+o+";"),n.type==="point"&&l.push("uniform vec3 lightPos"+o+";"),n.type==="spot"&&(l.push("uniform vec3 lightPos"+o+";"),l.push("uniform vec3 lightDir"+o+";")));for(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"),s&&(l.push("out vec4 vWorldPosition;"),l.push("out float vFlags;")),l.push("out vec4 vColor;"),l.push("void main(void) {"),l.push("int colorFlag = int(flags) & 0xF;"),l.push("if (colorFlag != renderPass) {"),l.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),l.push("} else {"),l.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),l.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition  = viewMatrix * worldPosition; "),l.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),l.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),l.push("vec3 viewNormal = normalize(vec4(viewNormalMatrix * worldNormal).xyz);"),l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),o=0,a=i.lights.length;o<a;o++)if(n=i.lights[o],n.type!=="ambient"){if(n.type==="dir")n.space==="view"?l.push("viewLightDir = normalize(lightDir"+o+");"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);");else if(n.type==="point")n.space==="view"?l.push("viewLightDir = -normalize(lightPos"+o+" - viewPosition.xyz);"):l.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+o+", 0.0)).xyz);");else if(n.type==="spot")n.space==="view"?l.push("viewLightDir = normalize(lightDir"+o+");"):l.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+o+", 0.0)).xyz);");else continue;l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+o+".rgb * lightColor"+o+".a);")}return l.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),l.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),l.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(l.push("vFragDepth = 1.0 + clipPos.w;"),l.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(l.push("vWorldPosition = worldPosition;"),l.push("vFlags = flags;")),l.push("gl_Position = clipPos;"),l.push("}"),l.push("}"),l}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";");s.push("uniform float sliceThickness;"),s.push("uniform vec4 sliceColor;")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec4 newColor;"),s.push("  newColor = vColor;"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > sliceThickness) { "),s.push("      discard;"),s.push("  }"),s.push("  if (dist > 0.0) { "),s.push("      newColor = sliceColor;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),s.push("   outColor                = vec4(newColor.rgb * ambient, 1.0);")):s.push("    outColor           = newColor;"),s.push("}"),s}}class mu extends fi{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry flat-shading drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vViewPosition = viewPosition;"),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState;let s,o;const a=t.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Instancing geometry flat-shading drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),a){n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;");for(let l=0,c=t.getNumAllocatedSectionPlanes();l<c;l++)n.push("uniform bool sectionPlaneActive"+l+";"),n.push("uniform vec3 sectionPlanePos"+l+";"),n.push("uniform vec3 sectionPlaneDir"+l+";");n.push("uniform float sliceThickness;"),n.push("uniform vec4 sliceColor;")}for(this._addMatricesUniformBlockLines(n),n.push("uniform vec4 lightAmbient;"),s=0,o=i.lights.length;s<o;s++){const l=i.lights[s];l.type!=="ambient"&&(n.push("uniform vec4 lightColor"+s+";"),l.type==="dir"&&n.push("uniform vec3 lightDir"+s+";"),l.type==="point"&&n.push("uniform vec3 lightPos"+s+";"),l.type==="spot"&&(n.push("uniform vec3 lightPos"+s+";"),n.push("uniform vec3 lightDir"+s+";")))}if(n.push("in vec4 vViewPosition;"),n.push("in vec4 vColor;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),n.push("  vec4 newColor;"),n.push("  newColor = vColor;"),a){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let l=0,c=t.getNumAllocatedSectionPlanes();l<c;l++)n.push("if (sectionPlaneActive"+l+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+l+".xyz, vWorldPosition.xyz - sectionPlanePos"+l+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > sliceThickness) { "),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      newColor = sliceColor;"),n.push("  }"),n.push("}")}for(n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),n.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),n.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),n.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),s=0,o=i.lights.length;s<o;s++){const l=i.lights[s];if(l.type!=="ambient"){if(l.type==="dir")l.space==="view"?n.push("viewLightDir = normalize(lightDir"+s+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+s+", 0.0)).xyz);");else if(l.type==="point")l.space==="view"?n.push("viewLightDir = -normalize(lightPos"+s+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+s+", 0.0)).xyz);");else if(l.type==="spot")l.space==="view"?n.push("viewLightDir = normalize(lightDir"+s+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+s+", 0.0)).xyz);");else continue;n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+s+".rgb * lightColor"+s+".a);")}}return n.push("vec4 fragColor = vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):n.push("    outColor           = fragColor;"),e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}class gu extends fi{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 color;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec4 silhouetteColor;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),s.push("if (silhouetteFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vColor = vec4(silhouetteColor.r, silhouetteColor.g, silhouetteColor.b, min(silhouetteColor.a, float(color.a) / 255.0));"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing fill fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";");s.push("uniform float sliceThickness;"),s.push("uniform vec4 sliceColor;")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec4 newColor;"),s.push("  newColor = vColor;"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > sliceThickness) { "),s.push("      discard;"),s.push("  }"),s.push("  if (dist > 0.0) { "),s.push("      newColor = sliceColor;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = newColor;"),s.push("}"),s}}class Uf extends fi{constructor(e,t){super(e,t,{instancing:!0,edges:!0})}}class wP extends Uf{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// EdgesEmphasisRenderer vertex shader"),s.push("uniform int renderPass;"),s.push("uniform vec4 color;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int edgeFlag = int(flags) >> 8 & 0xF;"),s.push("if (edgeFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vColor = vec4(color.r, color.g, color.b, color.a);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// EdgesEmphasisRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class CP extends Uf{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!1})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// EdgesColorRenderer vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int edgeFlag = int(flags) >> 8 & 0xF;"),s.push("if (edgeFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// EdgesColorRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class _u extends fi{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry picking vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 pickColor;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vPickColor;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = remapClipPos(clipPos);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vPickColor; "),s.push("}"),s}}class vu extends fi{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("  vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = remapClipPos(clipPos);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}}class MP extends fi{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry normals vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec2 normal;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("in vec4 modelNormalMatrixCol0;"),s.push("in vec4 modelNormalMatrixCol1;"),s.push("in vec4 modelNormalMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s,3),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec3 vWorldNormal;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),s.push("  vec3 worldNormal = vec3(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2));"),s.push("  vWorldNormal = worldNormal;"),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = remapClipPos(clipPos);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("uniform bool sectionPlaneActive"+a+";"),s.push("uniform vec3 sectionPlanePos"+a+";"),s.push("uniform vec3 sectionPlaneDir"+a+";")}if(s.push("in vec3 vWorldNormal;"),s.push("out highp ivec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push(`    outNormal = ivec4(vWorldNormal * float(${A.MAX_INT}), 1.0);`),s.push("}"),s}}class EP extends fi{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// TrianglesInstancingOcclusionRenderer vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// TrianglesInstancingOcclusionRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}}class IP extends fi{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry depth drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec2 vHighPrecisionZW;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("vHighPrecisionZW = gl_Position.zw;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const o=t.getNumAllocatedSectionPlanes()>0,a=[];if(a.push("#version 300 es"),a.push("// Instancing geometry depth drawing fragment shader"),a.push("precision highp float;"),a.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&(a.push("in float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("in float vFragDepth;")),o)for(a.push("in vec4 vWorldPosition;"),a.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)a.push("uniform bool sectionPlaneActive"+i+";"),a.push("uniform vec3 sectionPlanePos"+i+";"),a.push("uniform vec3 sectionPlaneDir"+i+";");if(a.push("in vec2 vHighPrecisionZW;"),a.push("out vec4 outColor;"),a.push("void main(void) {"),o){for(a.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)a.push("if (sectionPlaneActive"+i+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),a.push("}");a.push("if (dist > 0.0) { discard; }"),a.push("}")}return e.logarithmicDepthBufferEnabled&&a.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),a.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),a.push("}"),a}}class FP extends fi{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry normals drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec3 normal;"),s.push("in vec4 color;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s,!0),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),s.push("vec3 octDecode(vec2 oct) {"),s.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),s.push("    if (v.z < 0.0) {"),s.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),s.push("    }"),s.push("    return normalize(v);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec3 vViewNormal;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),s.push("  vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("  vViewNormal = viewNormal;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry depth drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}}class SP extends fi{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry shadow drawing vertex shader"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(s),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("bool visible = (colorFlag > 0);"),s.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),s.push("if (!visible || transparent) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("  gl_Position = shadowProjMatrix * viewPosition;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry depth drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}}const _a={};_a[os]="linearToLinear";_a[Et]="sRGBToLinear";class Pu extends fi{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0,o=t.clippingCaps,a=[];return a.push("#version 300 es"),a.push("// Instancing geometry quality drawing vertex shader"),a.push("uniform int renderPass;"),a.push("in vec3 position;"),a.push("in vec3 normal;"),a.push("in vec4 color;"),a.push("in vec2 uv;"),a.push("in vec2 metallicRoughness;"),a.push("in float flags;"),e.entityOffsetsEnabled&&a.push("in vec3 offset;"),a.push("in vec4 modelMatrixCol0;"),a.push("in vec4 modelMatrixCol1;"),a.push("in vec4 modelMatrixCol2;"),a.push("in vec4 modelNormalMatrixCol0;"),a.push("in vec4 modelNormalMatrixCol1;"),a.push("in vec4 modelNormalMatrixCol2;"),this._addMatricesUniformBlockLines(a,!0),a.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("out float isPerspective;")),a.push("vec3 octDecode(vec2 oct) {"),a.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),a.push("    if (v.z < 0.0) {"),a.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),a.push("    }"),a.push("    return normalize(v);"),a.push("}"),a.push("out vec4 vViewPosition;"),a.push("out vec3 vViewNormal;"),a.push("out vec4 vColor;"),a.push("out vec2 vUV;"),a.push("out vec2 vMetallicRoughness;"),i.lightMaps.length>0&&a.push("out vec3 vWorldNormal;"),s&&(a.push("out vec4 vWorldPosition;"),a.push("out float vFlags;"),o&&a.push("out vec4 vClipPosition;")),a.push("void main(void) {"),a.push("int colorFlag = int(flags) & 0xF;"),a.push("if (colorFlag != renderPass) {"),a.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),a.push("} else {"),a.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),a.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&a.push("      worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix * worldPosition; "),a.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),a.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 1.0);"),a.push("vec3 viewNormal = vec4(viewNormalMatrix * worldNormal).xyz;"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("vFragDepth = 1.0 + clipPos.w;"),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(a.push("vWorldPosition = worldPosition;"),a.push("vFlags = flags;"),o&&a.push("vClipPosition = clipPos;")),a.push("vViewPosition = viewPosition;"),a.push("vViewNormal = viewNormal;"),a.push("vColor = color;"),a.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),a.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&a.push("vWorldNormal = worldNormal.xyz;"),a.push("gl_Position = clipPos;"),a.push("}"),a.push("}"),a}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,s=e._lightsState,o=i.getNumAllocatedSectionPlanes()>0,a=i.clippingCaps,n=[];n.push("#version 300 es"),n.push("// Instancing geometry quality drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uColorMap;"),n.push("uniform sampler2D uMetallicRoughMap;"),n.push("uniform sampler2D uEmissiveMap;"),n.push("uniform sampler2D uNormalMap;"),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),s.reflectionMaps.length>0&&n.push("uniform samplerCube reflectionMap;"),s.lightMaps.length>0&&n.push("uniform samplerCube lightMap;"),n.push("uniform vec4 lightAmbient;");for(let l=0,c=s.lights.length;l<c;l++){const h=s.lights[l];h.type!=="ambient"&&(n.push("uniform vec4 lightColor"+l+";"),h.type==="dir"&&n.push("uniform vec3 lightDir"+l+";"),h.type==="point"&&n.push("uniform vec3 lightPos"+l+";"),h.type==="spot"&&(n.push("uniform vec3 lightPos"+l+";"),n.push("uniform vec3 lightDir"+l+";")))}if(n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),o){n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),a&&n.push("in vec4 vClipPosition;");for(let l=0,c=i.getNumAllocatedSectionPlanes();l<c;l++)n.push("uniform bool sectionPlaneActive"+l+";"),n.push("uniform vec3 sectionPlanePos"+l+";"),n.push("uniform vec3 sectionPlaneDir"+l+";")}if(n.push("in vec4 vViewPosition;"),n.push("in vec3 vViewNormal;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("in vec2 vMetallicRoughness;"),s.lightMaps.length>0&&n.push("in vec3 vWorldNormal;"),this._addMatricesUniformBlockLines(n,!0),n.push("#define PI 3.14159265359"),n.push("#define RECIPROCAL_PI 0.31830988618"),n.push("#define RECIPROCAL_PI2 0.15915494"),n.push("#define EPSILON 1e-6"),n.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),n.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),n.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),n.push("       if (texel.r == 0.0 && texel.g == 0.0 && texel.b == 0.0) {"),n.push("              return normalize(surf_norm );"),n.push("       }"),n.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),n.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),n.push("      vec2 st0 = dFdx( uv.st );"),n.push("      vec2 st1 = dFdy( uv.st );"),n.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),n.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),n.push("      vec3 N = normalize( surf_norm );"),n.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),n.push("      mat3 tsn = mat3( S, T, N );"),n.push("      return normalize( tsn * mapN );"),n.push("}"),n.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),n.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),n.push("}"),n.push("struct IncidentLight {"),n.push("   vec3 color;"),n.push("   vec3 direction;"),n.push("};"),n.push("struct ReflectedLight {"),n.push("   vec3 diffuse;"),n.push("   vec3 specular;"),n.push("};"),n.push("struct Geometry {"),n.push("   vec3 position;"),n.push("   vec3 viewNormal;"),n.push("   vec3 worldNormal;"),n.push("   vec3 viewEyeDir;"),n.push("};"),n.push("struct Material {"),n.push("   vec3    diffuseColor;"),n.push("   float   specularRoughness;"),n.push("   vec3    specularColor;"),n.push("   float   shine;"),n.push("};"),n.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),n.push("   float r = ggxRoughness + 0.0001;"),n.push("   return (2.0 / (r * r) - 2.0);"),n.push("}"),n.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),n.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),n.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),n.push("}"),s.reflectionMaps.length>0&&(n.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),n.push("   vec3 envMapColor = "+_a[s.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),n.push("  return envMapColor;"),n.push("}")),n.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),n.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),n.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),n.push("}"),n.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   return 1.0 / ( gl * gv );"),n.push("}"),n.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   return 0.5 / max( gv + gl, EPSILON );"),n.push("}"),n.push("float D_GGX(const in float alpha, const in float dotNH) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),n.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float alpha = ( roughness * roughness );"),n.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),n.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),n.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),n.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),n.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),n.push("   vec3  F = F_Schlick( specularColor, dotLH );"),n.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),n.push("   float D = D_GGX( alpha, dotNH );"),n.push("   return F * (G * D);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),n.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),n.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),n.push("   vec4 r = roughness * c0 + c1;"),n.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),n.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),n.push("   return specularColor * AB.x + AB.y;"),n.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(n.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(n.push("   vec3 irradiance = "+_a[s.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),n.push("   irradiance *= PI;"),n.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(n.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),n.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),n.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),n.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),n.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),n.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),n.push("}")),n.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),n.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),n.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),n.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),n.push("}"),n.push("out vec4 outColor;"),n.push("void main(void) {"),o){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let l=0,c=i.getNumAllocatedSectionPlanes();l<c;l++)n.push("if (sectionPlaneActive"+l+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+l+".xyz, vWorldPosition.xyz - sectionPlanePos"+l+".xyz), 0.0, 1000.0);"),n.push("}");a?(n.push("  if (dist > (0.002 * vClipPosition.w)) {"),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&n.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("  return;"),n.push("}")):(n.push("  if (dist > 0.0) { "),n.push("      discard;"),n.push("  }")),n.push("}")}n.push("IncidentLight  light;"),n.push("Material       material;"),n.push("Geometry       geometry;"),n.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),n.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),n.push("float opacity = float(vColor.a) / 255.0;"),n.push("vec3  baseColor = rgb;"),n.push("float specularF0 = 1.0;"),n.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),n.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),n.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),n.push("vec4 colorTexel = sRGBToLinear(texture(uColorMap, vUV));"),n.push("baseColor *= colorTexel.rgb;"),n.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),n.push("metallic *= metalRoughTexel.b;"),n.push("roughness *= metalRoughTexel.g;"),n.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition.xyz, normalize(vViewNormal), vUV );"),n.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),n.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),n.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),n.push("geometry.position      = vViewPosition.xyz;"),n.push("geometry.viewNormal    = -normalize(viewNormal);"),n.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),s.lightMaps.length>0&&n.push("geometry.worldNormal   = normalize(vWorldNormal);"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&n.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let l=0,c=s.lights.length;l<c;l++){const h=s.lights[l];if(h.type!=="ambient"){if(h.type==="dir")h.space==="view"?n.push("light.direction = normalize(lightDir"+l+");"):n.push("light.direction = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);");else if(h.type==="point")h.space==="view"?n.push("light.direction = normalize(lightPos"+l+" - vViewPosition.xyz);"):n.push("light.direction = normalize((viewMatrix * vec4(lightPos"+l+", 0.0)).xyz);");else if(h.type==="spot")h.space==="view"?n.push("light.direction = normalize(lightDir"+l+");"):n.push("light.direction = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);");else continue;n.push("light.color =  lightColor"+l+".rgb * lightColor"+l+".a;"),n.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return n.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),n.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),n.push("vec4 fragColor;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   fragColor            = vec4(outgoingLight.rgb * ambient, opacity);")):n.push("   fragColor            = vec4(outgoingLight.rgb, opacity);"),t&&n.push("fragColor = linearToGamma(fragColor, gammaFactor);"),n.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}class TP extends fi{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry normals vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s,3),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&s.push("out float vFlags;"),s.push("out vec4 vWorldPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vWorldPosition = worldPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&s.push("vFlags = flags;"),s.push("gl_Position = remapClipPos(clipPos);"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("in vec4 vWorldPosition;"),i){s.push("in float vFlags;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("uniform bool sectionPlaneActive"+a+";"),s.push("uniform vec3 sectionPlanePos"+a+";"),s.push("uniform vec3 sectionPlaneDir"+a+";")}if(s.push("out highp ivec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`  outNormal = ivec4(worldNormal * float(${A.MAX_INT}), 1.0);`),s.push("}"),s}}class xn extends fi{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry drawing vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in vec2 uv;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),s.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("out vec4 vColor;"),s.push("out vec2 vUV;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vViewPosition = viewPosition;"),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),s.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._lightsState,s=e._sectionPlanesState,o=s.getNumAllocatedSectionPlanes()>0,a=this._useAlphaCutoff,n=[];if(n.push("#version 300 es"),n.push("// Instancing geometry drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uColorMap;"),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),o){n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;");for(let l=0,c=s.getNumAllocatedSectionPlanes();l<c;l++)n.push("uniform bool sectionPlaneActive"+l+";"),n.push("uniform vec3 sectionPlanePos"+l+";"),n.push("uniform vec3 sectionPlaneDir"+l+";");n.push("uniform float sliceThickness;"),n.push("uniform vec4 sliceColor;")}this._addMatricesUniformBlockLines(n),n.push("uniform vec4 lightAmbient;");for(let l=0,c=i.lights.length;l<c;l++){const h=i.lights[l];h.type!=="ambient"&&(n.push("uniform vec4 lightColor"+l+";"),h.type==="dir"&&n.push("uniform vec3 lightDir"+l+";"),h.type==="point"&&n.push("uniform vec3 lightPos"+l+";"),h.type==="spot"&&(n.push("uniform vec3 lightPos"+l+";"),n.push("uniform vec3 lightDir"+l+";")))}if(a&&n.push("uniform float materialAlphaCutoff;"),n.push("in vec4 vViewPosition;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),n.push("  vec4 newColor;"),n.push("  newColor = vColor;"),o){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let l=0,c=s.getNumAllocatedSectionPlanes();l<c;l++)n.push("if (sectionPlaneActive"+l+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+l+".xyz, vWorldPosition.xyz - sectionPlanePos"+l+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > sliceThickness) { "),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      newColor = sliceColor;"),n.push("  }"),n.push("}")}n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),n.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),n.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),n.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let l=0,c=i.lights.length;l<c;l++){const h=i.lights[l];if(h.type!=="ambient"){if(h.type==="dir")h.space==="view"?n.push("viewLightDir = normalize(lightDir"+l+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);");else if(h.type==="point")h.space==="view"?n.push("viewLightDir = -normalize(lightPos"+l+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+l+", 0.0)).xyz);");else if(h.type==="spot")h.space==="view"?n.push("viewLightDir = normalize(lightDir"+l+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+l+", 0.0)).xyz);");else continue;n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+l+".rgb * lightColor"+l+".a);")}}return n.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),n.push("vec4 sampleColor = texture(uColorMap, vUV);"),a&&(n.push("if (sampleColor.a < materialAlphaCutoff) {"),n.push("   discard;"),n.push("}")),t&&n.push("sampleColor = sRGBToLinear(sampleColor);"),n.push("vec4 colorTexel = color * sampleColor;"),n.push("float opacity = color.a;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor                = vec4(colorTexel.rgb * ambient, opacity);")):n.push("   outColor                = vec4(colorTexel.rgb, opacity);"),t&&n.push("outColor = linearToGamma(outColor, gammaFactor);"),e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}const DP=A.vec3(),RP=A.vec3(),LP=A.vec3(),UP=A.vec3(),OP=A.mat4();class xu extends Kt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.canvas.gl,n=o.camera,l=t._state,c=t._state.origin,{position:h,rotationMatrix:d}=s,p=t.aabb,m=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?a.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));const g=DP;g[0]=A.safeInv(p[3]-p[0])*A.MAX_INT,g[1]=A.safeInv(p[4]-p[1])*A.MAX_INT,g[2]=A.safeInv(p[5]-p[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(g[0]),e.snapPickCoordinateScale[1]=A.safeInv(g[1]),e.snapPickCoordinateScale[2]=A.safeInv(g[2]);let u,x;if(c||h[0]!==0||h[1]!==0||h[2]!==0){const _=RP;if(c){const b=A.transformPoint3(d,c,LP);_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=h[0],_[1]+=h[1],_[2]+=h[2],u=Pt(m,_,OP),x=UP,x[0]=n.eye[0]-_[0],x[1]=n.eye[1]-_[1],x[2]=n.eye[2]-_[2],e.snapPickOrigin[0]=_[0],e.snapPickOrigin[1]=_[1],e.snapPickOrigin[2]=_[2]}else u=m,x=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform3fv(this._uCameraEyeRtc,x),a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,g),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const P=4*4;this._matricesUniformBlockBufferData.set(d,0),this._matricesUniformBlockBufferData.set(u,y+=P),this._matricesUniformBlockBufferData.set(n.projMatrix,y+=P),this._matricesUniformBlockBufferData.set(l.positionsDecodeMatrix,y+=P),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const _=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,_)}this.setSectionPlanesStateUniforms(t),this._aModelMatrixCol0.bindArrayBuffer(l.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(l.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(l.modelMatrixCol2Buf),a.vertexAttribDivisor(this._aModelMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(l.flagsBuf),a.vertexAttribDivisor(this._aFlags.location,1)),l.indicesBuf.bind(),a.drawElementsInstanced(a.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,l.numInstances),l.indicesBuf.unbind(),a.vertexAttribDivisor(this._aModelMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aFlags&&a.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&a.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// SnapInstancingDepthBufInitRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec4 pickColor;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec3 uCameraEyeRtc;"),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),s.push("flat out vec4 vPickColor;"),s.push("out vec4 vWorldPosition;"),i&&s.push("out float vFlags;"),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vWorldPosition = worldPosition;"),i&&s.push("  vFlags = flags;"),s.push("vPickColor = pickColor;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),s.push("in vec4 vWorldPosition;"),s.push("flat in vec4 vPickColor;"),i){s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("layout(location = 0) out highp ivec4 outCoords;"),s.push("layout(location = 1) out highp ivec4 outNormal;"),s.push("layout(location = 2) out lowp uvec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),s.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`outNormal = ivec4(worldNormal * float(${A.MAX_INT}), 1.0);`),s.push("outPickColor = uvec4(vPickColor);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const kP=A.vec3(),NP=A.vec3(),QP=A.vec3(),VP=A.vec3(),HP=A.mat4();class yu extends Kt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=t._state.origin,{position:h,rotationMatrix:d}=s,p=t.aabb,m=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));const g=kP;g[0]=A.safeInv(p[3]-p[0])*A.MAX_INT,g[1]=A.safeInv(p[4]-p[1])*A.MAX_INT,g[2]=A.safeInv(p[5]-p[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(g[0]),e.snapPickCoordinateScale[1]=A.safeInv(g[1]),e.snapPickCoordinateScale[2]=A.safeInv(g[2]);let u,x;if(c||h[0]!==0||h[1]!==0||h[2]!==0){const _=NP;if(c){const b=A.transformPoint3(d,c,QP);_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=h[0],_[1]+=h[1],_[2]+=h[2],u=Pt(m,_,HP),x=VP,x[0]=a.eye[0]-_[0],x[1]=a.eye[1]-_[1],x[2]=a.eye[2]-_[2],e.snapPickOrigin[0]=_[0],e.snapPickOrigin[1]=_[1],e.snapPickOrigin[2]=_[2]}else u=m,x=a.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,x),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,g),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const P=4*4;this._matricesUniformBlockBufferData.set(d,0),this._matricesUniformBlockBufferData.set(u,y+=P),this._matricesUniformBlockBufferData.set(a.projMatrix,y+=P),this._matricesUniformBlockBufferData.set(l.positionsDecodeMatrix,y+=P),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const _=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,_)}this.setSectionPlanesStateUniforms(t),this._aModelMatrixCol0.bindArrayBuffer(l.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(l.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(l.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(l.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),e.snapMode==="edge"?(l.edgeIndicesBuf.bind(),n.drawElementsInstanced(n.LINES,l.edgeIndicesBuf.numItems,l.edgeIndicesBuf.itemType,0,l.numInstances),l.edgeIndicesBuf.unbind()):n.drawArraysInstanced(n.POINTS,0,l.positionsBuf.numItems,l.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// SnapInstancingDepthRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec3 uCameraEyeRtc;"),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(2.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("gl_PointSize = 1.0;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// SnapInstancingDepthRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("out highp ivec4 outCoords;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class jP{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._colorTextureRendererAlphaCutoff&&!this._colorTextureRendererAlphaCutoff.getValid()&&(this._colorTextureRendererAlphaCutoff.destroy(),this._colorTextureRendererAlphaCutoff=null),this._colorTextureRendererWithSAOAlphaCutoff&&!this._colorTextureRendererWithSAOAlphaCutoff.getValid()&&(this._colorTextureRendererWithSAOAlphaCutoff.destroy(),this._colorTextureRendererWithSAOAlphaCutoff=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&this._pickNormalsRenderer.getValid()===!1&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.getValid()===!1&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}eagerCreateRenders(){this._silhouetteRenderer||(this._silhouetteRenderer=new gu(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new _u(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new vu(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new xu(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new yu(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new fu(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new fu(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new mu(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new mu(this._scene,!0)),this._flatColorRendererWithSAO}get colorTextureRenderer(){return this._colorTextureRenderer||(this._colorTextureRenderer=new xn(this._scene,!1)),this._colorTextureRenderer}get colorTextureRendererWithSAO(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new xn(this._scene,!0)),this._colorTextureRendererWithSAO}get colorTextureRendererAlphaCutoff(){return this._colorTextureRendererAlphaCutoff||(this._colorTextureRendererAlphaCutoff=new xn(this._scene,!1,{useAlphaCutoff:!0})),this._colorTextureRendererAlphaCutoff}get colorTextureRendererWithSAOAlphaCutoff(){return this._colorTextureRendererWithSAOAlphaCutoff||(this._colorTextureRendererWithSAOAlphaCutoff=new xn(this._scene,!0,{useAlphaCutoff:!0})),this._colorTextureRendererWithSAOAlphaCutoff}get pbrRenderer(){return this._pbrRenderer||(this._pbrRenderer=new Pu(this._scene,!1)),this._pbrRenderer}get pbrRendererWithSAO(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new Pu(this._scene,!0)),this._pbrRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new gu(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new IP(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new FP(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new wP(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new CP(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new _u(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new MP(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new TP(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new vu(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new EP(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new SP(this._scene)),this._shadowRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new yu(this._scene)),this._snapRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new xu(this._scene)),this._snapInitRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererAlphaCutoff&&this._colorTextureRendererAlphaCutoff.destroy(),this._colorTextureRendererWithSAOAlphaCutoff&&this._colorTextureRendererWithSAOAlphaCutoff.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const xl={};function zP(r){const e=r.id;let t=xl[e];return t||(t=new jP(r),xl[e]=t,t._compile(),t.eagerCreateRenders(),r.on("compile",()=>{t._compile(),t.eagerCreateRenders()}),r.on("destroyed",()=>{delete xl[e],t._destroy()})),t}const Yr=new Uint8Array(4),bu=new Float32Array(1),GP=A.vec4([0,0,0,1]),yn=new Float32Array(3),WP=A.vec3(),KP=A.vec3(),XP=A.vec3(),YP=A.vec3(),$P=A.vec3(),ZP=A.vec3(),qP=A.vec3(),oi=new Float32Array(4);class yl{constructor(e){this.model=e.model,this.sortId="TrianglesInstancingLayer"+(e.solid?"-solid":"-surface")+(e.normals?"-normals":"-autoNormals"),this.layerIndex=e.layerIndex,this._renderers=zP(e.model.scene),this._aabb=A.collapseAABB3(),this._state=new Mt({numInstances:0,obb:A.OBB3(),origin:A.vec3(),geometry:e.geometry,textureSet:e.textureSet,pbrSupported:!1,positionsDecodeMatrix:e.geometry.positionsDecodeMatrix,colorsBuf:null,metallicRoughnessBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null,modelNormalMatrixCol0Buf:null,modelNormalMatrixCol1Buf:null,modelNormalMatrixCol2Buf:null,pickColorsBuf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._colors=[],this._metallicRoughness=[],this._pickColors=[],this._offsets=[],this._modelMatrix=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=A.collapseAABB3(),this.aabbDirty=!0,e.origin&&this._state.origin.set(e.origin),this._finalized=!1,this.solid=!!e.solid,this.numIndices=e.geometry.numIndices,this.primitive=e.geometry.primitive}get aabb(){if(this.aabbDirty){A.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)A.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}createPortion(e,t){const i=t.color,s=t.metallic,o=t.roughness,a=t.opacity!==null&&t.opacity!==void 0?t.opacity:255,n=t.meshMatrix,l=t.pickColor;if(this._finalized)throw"Already finalized";const c=i[0],h=i[1],d=i[2];if(this._colors.push(c),this._colors.push(h),this._colors.push(d),this._colors.push(a),this._metallicRoughness.push(s??0),this._metallicRoughness.push(o??255),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(n[0]),this._modelMatrixCol0.push(n[4]),this._modelMatrixCol0.push(n[8]),this._modelMatrixCol0.push(n[12]),this._modelMatrixCol1.push(n[1]),this._modelMatrixCol1.push(n[5]),this._modelMatrixCol1.push(n[9]),this._modelMatrixCol1.push(n[13]),this._modelMatrixCol2.push(n[2]),this._modelMatrixCol2.push(n[6]),this._modelMatrixCol2.push(n[10]),this._modelMatrixCol2.push(n[14]),this._state.geometry.normals){let g=A.transposeMat4(n,A.mat4()),u=A.inverseMat4(g);this._modelNormalMatrixCol0.push(u[0]),this._modelNormalMatrixCol0.push(u[4]),this._modelNormalMatrixCol0.push(u[8]),this._modelNormalMatrixCol0.push(u[12]),this._modelNormalMatrixCol1.push(u[1]),this._modelNormalMatrixCol1.push(u[5]),this._modelNormalMatrixCol1.push(u[9]),this._modelNormalMatrixCol1.push(u[13]),this._modelNormalMatrixCol2.push(u[2]),this._modelNormalMatrixCol2.push(u[6]),this._modelNormalMatrixCol2.push(u[10]),this._modelNormalMatrixCol2.push(u[14])}this._pickColors.push(l[0]),this._pickColors.push(l[1]),this._pickColors.push(l[2]),this._pickColors.push(l[3]),this._state.numInstances++;const p=this._portions.length,m={};return this.model.scene.readableGeometryEnabled&&(m.matrix=n.slice(),m.inverseMatrix=null,m.normalMatrix=null),this._portions.push(m),this._numPortions++,this.model.numPortions++,this._meshes.push(e),p}finalize(){if(this._finalized)return;const e=this._state,t=e.geometry,i=e.textureSet,s=this.model.scene.canvas.gl,o=this._colors.length,a=o/4;if(o>0){let n=!1;e.colorsBuf=new Oe(s,s.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,s.DYNAMIC_DRAW,n),this._colors=[]}if(this._metallicRoughness.length>0){const n=new Uint8Array(this._metallicRoughness);let l=!1;e.metallicRoughnessBuf=new Oe(s,s.ARRAY_BUFFER,n,this._metallicRoughness.length,2,s.STATIC_DRAW,l)}if(a>0){let n=!1;e.flagsBuf=new Oe(s,s.ARRAY_BUFFER,new Float32Array(a),a,1,s.DYNAMIC_DRAW,n)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0&&(e.offsetsBuf=new Oe(s,s.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,s.DYNAMIC_DRAW,!1),this._offsets=[]),t.positionsCompressed&&t.positionsCompressed.length>0&&(e.positionsBuf=new Oe(s,s.ARRAY_BUFFER,t.positionsCompressed,t.positionsCompressed.length,3,s.STATIC_DRAW,!1),e.positionsDecodeMatrix=A.mat4(t.positionsDecodeMatrix)),t.colorsCompressed&&t.colorsCompressed.length>0){const n=new Uint8Array(t.colorsCompressed),l=!1;e.colorsBuf=new Oe(s,s.ARRAY_BUFFER,n,n.length,4,s.STATIC_DRAW,l)}if(t.uvCompressed&&t.uvCompressed.length>0){const n=t.uvCompressed;e.uvDecodeMatrix=t.uvDecodeMatrix,e.uvBuf=new Oe(s,s.ARRAY_BUFFER,n,n.length,2,s.STATIC_DRAW,!1)}t.indices&&t.indices.length>0&&(e.indicesBuf=new Oe(s,s.ELEMENT_ARRAY_BUFFER,new Uint32Array(t.indices),t.indices.length,1,s.STATIC_DRAW),e.numIndices=t.indices.length),t.edgeIndices&&t.edgeIndices.length>0&&(e.edgeIndicesBuf=new Oe(s,s.ELEMENT_ARRAY_BUFFER,new Uint32Array(t.edgeIndices),t.edgeIndices.length,1,s.STATIC_DRAW)),this._modelMatrixCol0.length>0&&(e.modelMatrixCol0Buf=new Oe(s,s.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,s.STATIC_DRAW,!1),e.modelMatrixCol1Buf=new Oe(s,s.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,s.STATIC_DRAW,!1),e.modelMatrixCol2Buf=new Oe(s,s.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,s.STATIC_DRAW,!1),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],e.normalsBuf&&(e.modelNormalMatrixCol0Buf=new Oe(s,s.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol0),this._modelNormalMatrixCol0.length,4,s.STATIC_DRAW,!1),e.modelNormalMatrixCol1Buf=new Oe(s,s.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol1),this._modelNormalMatrixCol1.length,4,s.STATIC_DRAW,!1),e.modelNormalMatrixCol2Buf=new Oe(s,s.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol2),this._modelNormalMatrixCol2.length,4,s.STATIC_DRAW,!1),this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[])),this._pickColors.length>0&&(e.pickColorsBuf=new Oe(s,s.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,s.STATIC_DRAW,!1),this._pickColors=[]),e.pbrSupported=!!e.metallicRoughnessBuf&&!!e.uvBuf&&!!e.normalsBuf&&!!i&&!!i.colorTexture&&!!i.metallicRoughnessTexture,e.colorTextureSupported=!!e.uvBuf&&!!i&&!!i.colorTexture,this.model.scene.readableGeometryEnabled||(this._state.geometry=null),this._finalized=!0}initFlags(e,t,i){t&N.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&N.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&N.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&N.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&N.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&N.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&N.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&N.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&N.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&N.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&N.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&N.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&N.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&N.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&N.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";Yr[0]=t[0],Yr[1]=t[1],Yr[2]=t[2],Yr[3]=t[3],this._state.colorsBuf&&this._state.colorsBuf.setData(Yr,e*4)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=!!(t&N.VISIBLE),o=!!(t&N.XRAYED),a=!!(t&N.HIGHLIGHTED),n=!!(t&N.SELECTED),l=!!(t&N.EDGES),c=!!(t&N.PICKABLE),h=!!(t&N.CULLED);let d;!s||h||o||a&&!this.model.scene.highlightMaterial.glowThrough||n&&!this.model.scene.selectedMaterial.glowThrough?d=O.NOT_RENDERED:i?d=O.COLOR_TRANSPARENT:d=O.COLOR_OPAQUE;let p;!s||h?p=O.NOT_RENDERED:n?p=O.SILHOUETTE_SELECTED:a?p=O.SILHOUETTE_HIGHLIGHTED:o?p=O.SILHOUETTE_XRAYED:p=O.NOT_RENDERED;let m=0;!s||h?m=O.NOT_RENDERED:n?m=O.EDGES_SELECTED:a?m=O.EDGES_HIGHLIGHTED:o?m=O.EDGES_XRAYED:l?i?m=O.EDGES_COLOR_TRANSPARENT:m=O.EDGES_COLOR_OPAQUE:m=O.NOT_RENDERED;const g=s&&!h&&c?O.PICK:O.NOT_RENDERED,u=t&N.CLIPPABLE?1:0;let x=0;x|=d,x|=p<<4,x|=m<<8,x|=g<<12,x|=u<<16,bu[0]=x,this._state.flagsBuf&&this._state.flagsBuf.setData(bu,e)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}yn[0]=t[0],yn[1]=t[1],yn[2]=t[2],this._state.offsetsBuf&&this._state.offsetsBuf.setData(yn,e*3)}getEachVertex(e,t){if(!this.model.scene.readableGeometryEnabled)return!1;const i=this._state,s=i.geometry,o=this._portions[e];if(!o){this.model.error("portion not found: "+e);return}const a=s.positionsCompressed,n=this.model.matrix,l=A.vec4();l.set(i.origin,0),l[3]=1,A.mulMat4v4(n,l,l);const c=l[0],h=l[1],d=l[2],p=GP,m=o.matrix,g=i.positionsDecodeMatrix;for(let u=0,x=a.length;u<x;u+=3)p[0]=a[u],p[1]=a[u+1],p[2]=a[u+2],A.decompressPosition(p,g),A.transformPoint3(m,p,p),p[3]=1,A.mulMat4v4(n,p,p),p[0]+=c,p[1]+=h,p[2]+=d,t(p)}getEachIndex(e,t){if(!this.model.scene.readableGeometryEnabled)return!1;const s=this._state.geometry;if(!this._portions[e]){this.model.error("portion not found: "+e);return}const a=s.indices;for(let n=0,l=a.length;n<l;n++)t(a[n])}setMatrix(e,t){if(!this._finalized)throw"Not finalized";var i=e*4;oi[0]=t[0],oi[1]=t[4],oi[2]=t[8],oi[3]=t[12],this._state.modelMatrixCol0Buf.setData(oi,i),oi[0]=t[1],oi[1]=t[5],oi[2]=t[9],oi[3]=t[13],this._state.modelMatrixCol1Buf.setData(oi,i),oi[0]=t[2],oi[1]=t[6],oi[2]=t[10],oi[3]=t[14],this._state.modelMatrixCol2Buf.setData(oi,i)}drawColorOpaque(e,t){if(this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions)return;this._updateBackfaceCull(e,t);const i=this._state.textureSet&&typeof this._state.textureSet.alphaCutoff=="number";t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRendererWithSAO&&this._renderers.pbrRendererWithSAO.drawLayer(t,this,O.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?i?this._renderers.colorTextureRendererWithSAOAlphaCutoff&&this._renderers.colorTextureRendererWithSAOAlphaCutoff.drawLayer(t,this,O.COLOR_OPAQUE):this._renderers.colorTextureRendererWithSAO&&this._renderers.colorTextureRendererWithSAO.drawLayer(t,this,O.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(t,this,O.COLOR_OPAQUE):this._renderers.flatColorRendererWithSAO&&this._renderers.flatColorRendererWithSAO.drawLayer(t,this,O.COLOR_OPAQUE):t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,O.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?i?this._renderers.colorTextureRendererAlphaCutoff&&this._renderers.colorTextureRendererAlphaCutoff.drawLayer(t,this,O.COLOR_OPAQUE):this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,O.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_OPAQUE):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,O.COLOR_OPAQUE)}_updateBackfaceCull(e,t){const i=this.model.backfaces||!this.solid||e.sectioned;if(t.backfaces!==i){const s=t.gl;i?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),t.backfaces=i}}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT))}drawDepth(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(t,this,O.COLOR_OPAQUE))}drawNormals(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(t,this,O.COLOR_OPAQUE))}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_XRAYED))}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_HIGHLIGHTED))}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_SELECTED))}drawEdgesColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,O.EDGES_COLOR_OPAQUE)}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,O.EDGES_COLOR_TRANSPARENT)}drawEdgesXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,O.EDGES_XRAYED)}drawEdgesHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,O.EDGES_HIGHLIGHTED)}drawEdgesSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,O.EDGES_SELECTED)}drawOcclusion(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,O.COLOR_OPAQUE))}drawShadow(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(t,this,O.COLOR_OPAQUE))}drawPickMesh(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,O.PICK))}drawPickDepths(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,O.PICK))}drawPickNormals(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickNormalsFlatRenderer&&this._renderers.pickNormalsFlatRenderer.drawLayer(t,this,O.PICK))}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,O.PICK))}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,O.PICK))}precisionRayPickSurface(e,t,i,s,o){if(!this.model.scene.readableGeometryEnabled)return!1;const a=this._state.geometry,n=this._state,l=this._portions[e];if(!l)return this.model.error("portion not found: "+e),!1;l.inverseMatrix||(l.inverseMatrix=A.inverseMat4(l.matrix,A.mat4())),o&&!l.normalMatrix&&(l.normalMatrix=A.transposeMat4(l.inverseMatrix,A.mat4()));const c=a.quantizedPositions,h=a.indices,d=n.origin,p=l.offset,m=WP,g=KP;m.set(d?A.subVec3(t,d,XP):t),g.set(i),p&&A.subVec3(m,p),A.transformRay(this.model.worldNormalMatrix,m,g,m,g),A.transformRay(l.inverseMatrix,m,g,m,g);const u=YP,x=$P,y=ZP;let P=!1,_=0;const b=qP;for(let B=0,w=h.length;B<w;B+=3){const C=h[B+0]*3,E=h[B+1]*3,I=h[B+2]*3;u[0]=c[C],u[1]=c[C+1],u[2]=c[C+2],x[0]=c[E],x[1]=c[E+1],x[2]=c[E+2],y[0]=c[I],y[1]=c[I+1],y[2]=c[I+2];const{positionsDecodeMatrix:R}=n.geometry;if(A.decompressPosition(u,R),A.decompressPosition(x,R),A.decompressPosition(y,R),A.rayTriangleIntersect(m,g,u,x,y,b)){A.transformPoint3(l.matrix,b,b),A.transformPoint3(this.model.worldMatrix,b,b),p&&A.addVec3(b,p),d&&A.addVec3(b,d);const F=Math.abs(A.lenVec3(A.subVec3(b,t,[])));(!P||F>_)&&(_=F,s.set(b),o&&A.triangleNormal(u,x,y,o),P=!0)}}return P&&o&&(A.transformVec3(l.normalMatrix,o,o),A.transformVec3(this.model.worldNormalMatrix,o,o),A.normalizeVec3(o)),P}destroy(){const e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.modelNormalMatrixCol0Buf&&(e.modelNormalMatrixCol0Buf.destroy(),e.modelNormalMatrixCol0Buf=null),e.modelNormalMatrixCol1Buf&&(e.modelNormalMatrixCol1Buf.destroy(),e.modelNormalMatrixCol1Buf=null),e.modelNormalMatrixCol2Buf&&(e.modelNormalMatrixCol2Buf.destroy(),e.modelNormalMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy(),this._state=null}}class Of extends Kt{_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:o}=e;t.drawElements(t.LINES,i.indicesBuf.numItems,i.indicesBuf.itemType,0),o&&s.drawElements++}}class JP extends Of{drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Lines batching color vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Lines batching color fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor            = vColor;"),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}class ex extends Of{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Lines batching silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),s.push("if (silhouetteFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Lines batching silhouette fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("uniform vec4 color;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = color;"),s.push("}"),s}}const tx=A.vec3(),ix=A.vec3(),sx=A.vec3(),rx=A.vec3(),ox=A.mat4();class nx extends Kt{drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=t._state.origin,{position:h,rotationMatrix:d}=s,p=t.aabb,m=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));const g=tx;g[0]=A.safeInv(p[3]-p[0])*A.MAX_INT,g[1]=A.safeInv(p[4]-p[1])*A.MAX_INT,g[2]=A.safeInv(p[5]-p[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(g[0]),e.snapPickCoordinateScale[1]=A.safeInv(g[1]),e.snapPickCoordinateScale[2]=A.safeInv(g[2]);let u,x;if(c||h[0]!==0||h[1]!==0||h[2]!==0){const _=ix;if(c){const b=sx;A.transformPoint3(d,c,b),_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=h[0],_[1]+=h[1],_[2]+=h[2],u=Pt(m,_,ox),x=rx,x[0]=a.eye[0]-_[0],x[1]=a.eye[1]-_[1],x[2]=a.eye[2]-_[2],e.snapPickOrigin[0]=_[0],e.snapPickOrigin[1]=_[1],e.snapPickOrigin[2]=_[2]}else u=m,x=a.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,x),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,g),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const P=4*4;this._matricesUniformBlockBufferData.set(d,0),this._matricesUniformBlockBufferData.set(u,y+=P),this._matricesUniformBlockBufferData.set(a.projMatrix,y+=P),this._matricesUniformBlockBufferData.set(l.positionsDecodeMatrix,y+=P),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const _=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,_)}this.setSectionPlanesStateUniforms(t),l.indicesBuf.bind(),n.drawElements(n.LINES,l.indicesBuf.numItems,l.indicesBuf.itemType,0),l.indicesBuf.unbind()}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// VBO SnapBatchingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// VBO SnapBatchingDepthBufInitRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),s.push("in vec4 vWorldPosition;"),s.push("flat in vec4 vPickColor;"),i){s.push("in float vFlags;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("uniform bool sectionPlaneActive"+a+";"),s.push("uniform vec3 sectionPlanePos"+a+";"),s.push("uniform vec3 sectionPlaneDir"+a+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("layout(location = 0) out highp ivec4 outCoords;"),s.push("layout(location = 1) out highp ivec4 outNormal;"),s.push("layout(location = 2) out lowp uvec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),s.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`outNormal = ivec4(worldNormal * float(${A.MAX_INT}), 1.0);`),s.push("outPickColor = uvec4(vPickColor);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ax=A.vec3(),lx=A.vec3(),Ax=A.vec3(),cx=A.vec3(),hx=A.mat4();class ux extends Kt{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=t._state.origin,{position:h,rotationMatrix:d}=s,p=t.aabb,m=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));const g=ax;g[0]=A.safeInv(p[3]-p[0])*A.MAX_INT,g[1]=A.safeInv(p[4]-p[1])*A.MAX_INT,g[2]=A.safeInv(p[5]-p[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(g[0]),e.snapPickCoordinateScale[1]=A.safeInv(g[1]),e.snapPickCoordinateScale[2]=A.safeInv(g[2]);let u,x;if(c||h[0]!==0||h[1]!==0||h[2]!==0){const _=lx;if(c){const b=Ax;A.transformPoint3(d,c,b),_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=h[0],_[1]+=h[1],_[2]+=h[2],u=Pt(m,_,hx),x=cx,x[0]=a.eye[0]-_[0],x[1]=a.eye[1]-_[1],x[2]=a.eye[2]-_[2],e.snapPickOrigin[0]=_[0],e.snapPickOrigin[1]=_[1],e.snapPickOrigin[2]=_[2]}else u=m,x=a.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,x),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,g),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const P=4*4;this._matricesUniformBlockBufferData.set(d,0),this._matricesUniformBlockBufferData.set(u,y+=P),this._matricesUniformBlockBufferData.set(a.projMatrix,y+=P),this._matricesUniformBlockBufferData.set(l.positionsDecodeMatrix,y+=P),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const _=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,_)}this.setSectionPlanesStateUniforms(t),e.snapMode==="edge"?(l.indicesBuf.bind(),n.drawElements(n.LINES,l.indicesBuf.numItems,l.indicesBuf.itemType,0),l.indicesBuf.unbind()):n.drawArrays(n.POINTS,0,l.positionsBuf.numItems)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;const i=[];return i.push("#version 300 es"),i.push("// SnapBatchingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(2.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// SnapBatchingDepthRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("uniform bool sectionPlaneActive"+a+";"),s.push("uniform vec3 sectionPlanePos"+a+";"),s.push("uniform vec3 sectionPlaneDir"+a+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("out highp ivec4 outCoords;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class dx{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new JP(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new ex(this._scene)),this._silhouetteRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new nx(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new ux(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const bl={};function px(r){const e=r.id;let t=bl[e];return t||(t=new dx(r),bl[e]=t,t._compile(),r.on("compile",()=>{t._compile()}),r.on("destroyed",()=>{delete bl[e],t._destroy()})),t}class fx{constructor(e=5e6){e>5e6&&(e=5e6),this.maxVerts=e,this.maxIndices=e*3,this.positions=[],this.colors=[],this.offsets=[],this.indices=[]}}class mx{constructor(e){this.layerIndex=e.layerIndex,this._renderers=px(e.model.scene),this.model=e.model,this._buffer=new fx(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Mt({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,indicesBuf:null,positionsDecodeMatrix:A.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=A.collapseAABB3(),this._portions=[],this._meshes=[],this._numVerts=0,this._aabb=A.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.origin&&(this._state.origin=A.vec3(e.origin)),this.primitive=e.primitive}get aabb(){if(this.aabbDirty){A.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)A.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e,t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<this._buffer.maxVerts*3&&this._buffer.indices.length+t<this._buffer.maxIndices}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=t.positions,s=t.positionsCompressed,o=t.indices,a=t.color,n=t.opacity,l=this._buffer,h=l.positions.length/3;let d;if(A.expandAABB3(this._modelAABB,t.aabb),this._preCompressedPositionsExpected){if(!s)throw"positionsCompressed expected";d=s.length/3;for(let m=0,g=s.length;m<g;m++)l.positions.push(s[m])}else{if(!i)throw"positions expected";d=i.length/3;for(let m=0,g=i.length;m<g;m++)l.positions.push(i[m])}if(a){const m=a[0],g=a[1],u=a[2],x=n;for(let y=0;y<d;y++)l.colors.push(m),l.colors.push(g),l.colors.push(u),l.colors.push(x)}if(o)for(let m=0,g=o.length;m<g;m++)l.indices.push(o[m]+h);if(this.model.scene.entityOffsetsEnabled)for(let m=0;m<d;m++)l.offsets.push(0),l.offsets.push(0),l.offsets.push(0);const p=this._portions.length/2;return this._portions.push(h),this._portions.push(d),this._numPortions++,this.model.numPortions++,this._numVerts+=d,this._meshes.push(e),p}finalize(){if(this._finalized)return;const e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressedPositionsExpected){const s=new Uint16Array(i.positions);e.positionsBuf=new Oe(t,t.ARRAY_BUFFER,s,i.positions.length,3,t.STATIC_DRAW)}else{const s=new Float32Array(i.positions),o=Io(s,this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=new Oe(t,t.ARRAY_BUFFER,o,i.positions.length,3,t.STATIC_DRAW)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let o=!1;e.colorsBuf=new Oe(t,t.ARRAY_BUFFER,s,i.colors.length,4,t.DYNAMIC_DRAW,o)}if(i.colors.length>0){const s=i.colors.length/4,o=new Float32Array(s);let a=!1;e.flagsBuf=new Oe(t,t.ARRAY_BUFFER,o,o.length,1,t.DYNAMIC_DRAW,a)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);e.offsetsBuf=new Oe(t,t.ARRAY_BUFFER,s,i.offsets.length,3,t.DYNAMIC_DRAW)}if(i.indices.length>0){const s=new Uint32Array(i.indices);e.indicesBuf=new Oe(t,t.ELEMENT_ARRAY_BUFFER,s,i.indices.length,1,t.STATIC_DRAW)}this._buffer=null,this._finalized=!0}initFlags(e,t,i){t&N.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&N.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&N.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&N.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&N.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&N.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&N.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i,!0)}flushInitFlags(){this._setDeferredFlags()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&N.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&N.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&N.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&N.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&N.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&N.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&N.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&N.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";const i=e*2,s=this._portions[i],o=this._portions[i+1],a=s*4,n=o*4,l=this._scratchMemory.getUInt8Array(n),c=t[0],h=t[1],d=t[2],p=t[3];for(let m=0;m<n;m+=4)l[m+0]=c,l[m+1]=h,l[m+2]=d,l[m+3]=p;this._state.colorsBuf.setData(l,a,n)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const o=e*2,a=this._portions[o],n=this._portions[o+1],l=a,c=n,h=!!(t&N.VISIBLE),d=!!(t&N.XRAYED),p=!!(t&N.HIGHLIGHTED),m=!!(t&N.SELECTED),g=!!(t&N.PICKABLE),u=!!(t&N.CULLED);let x;!h||u||d||p&&!this.model.scene.highlightMaterial.glowThrough||m&&!this.model.scene.selectedMaterial.glowThrough?x=O.NOT_RENDERED:i?x=O.COLOR_TRANSPARENT:x=O.COLOR_OPAQUE;let y;!h||u?y=O.NOT_RENDERED:m?y=O.SILHOUETTE_SELECTED:p?y=O.SILHOUETTE_HIGHLIGHTED:d?y=O.SILHOUETTE_XRAYED:y=O.NOT_RENDERED;let P=h&&!u&&g?O.PICK:O.NOT_RENDERED;const _=t&N.CLIPPABLE?1:0;if(s){this._deferredFlagValues||(this._deferredFlagValues=new Float32Array(this._numVerts));for(let b=l,B=l+c;b<B;b++){let w=0;w|=x,w|=y<<4,w|=P<<12,w|=_<<16,this._deferredFlagValues[b]=w}}else if(this._state.flagsBuf){const b=this._scratchMemory.getFloat32Array(c);for(let B=0;B<c;B++){let w=0;w|=x,w|=y<<4,w|=P<<12,w|=_<<16,b[B]=w}this._state.flagsBuf.setData(b,l,c)}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}const i=e*2,s=this._portions[i],o=this._portions[i+1],a=s*3,n=o*3,l=this._scratchMemory.getFloat32Array(n),c=t[0],h=t[1],d=t[2];for(let p=0;p<n;p+=3)l[p+0]=c,l[p+1]=h,l[p+2]=d;this._state.offsetsBuf.setData(l,a,n)}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawPickMesh(e){}drawPickDepths(e){}drawPickNormals(e){}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,O.PICK)}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,O.PICK)}drawOcclusion(e){}drawShadow(e){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicesBuf=null),e.destroy()}}class kf extends Kt{constructor(e,t){super(e,t,{instancing:!0})}_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:o}=e;t.drawElementsInstanced(t.LINES,i.indicesBuf.numItems,i.indicesBuf.itemType,0,i.numInstances),o&&s.drawElements++}}class gx extends kf{drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Lines instancing color vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),s.push("uniform vec4 lightAmbient;"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0,  float(color.a) / 255.0);"),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const o=t.getNumAllocatedSectionPlanes()>0,a=[];if(a.push("#version 300 es"),a.push("// Lines instancing color fragment shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("in float vFragDepth;")),o)for(a.push("in vec4 vWorldPosition;"),a.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)a.push("uniform bool sectionPlaneActive"+i+";"),a.push("uniform vec3 sectionPlanePos"+i+";"),a.push("uniform vec3 sectionPlaneDir"+i+";");if(a.push("in vec4 vColor;"),a.push("out vec4 outColor;"),a.push("void main(void) {"),o){for(a.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)a.push("if (sectionPlaneActive"+i+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),a.push("}");a.push("if (dist > 0.0) { discard; }"),a.push("}")}return this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture(uOcclusionTexture, uv))) * blendFactor;"),a.push("   outColor            = vec4(vColor.rgb * ambient, vColor.a);")):a.push("    outColor           = vColor;"),e.logarithmicDepthBufferEnabled&&a.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}}class _x extends kf{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Lines instancing silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),s.push("uniform vec4 color;"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),s.push("if (silhouetteFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Lines instancing silhouette fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("uniform vec4 color;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = color;"),s.push("}"),s}}const vx=A.vec3(),Px=A.vec3(),xx=A.vec3();A.vec3();const yx=A.mat4();class Bu extends Kt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.canvas.gl,n=o.camera,l=t._state,c=t._state.origin,{position:h,rotationMatrix:d}=s,p=t.aabb,m=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?a.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));const g=vx;g[0]=A.safeInv(p[3]-p[0])*A.MAX_INT,g[1]=A.safeInv(p[4]-p[1])*A.MAX_INT,g[2]=A.safeInv(p[5]-p[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(g[0]),e.snapPickCoordinateScale[1]=A.safeInv(g[1]),e.snapPickCoordinateScale[2]=A.safeInv(g[2]);let u;if(c||h[0]!==0||h[1]!==0||h[2]!==0){const P=Px;if(c){const _=A.transformPoint3(d,c,xx);P[0]=_[0],P[1]=_[1],P[2]=_[2]}else P[0]=0,P[1]=0,P[2]=0;P[0]+=h[0],P[1]+=h[1],P[2]+=h[2],u=Pt(m,P,yx),e.snapPickOrigin[0]=P[0],e.snapPickOrigin[1]=P[1],e.snapPickOrigin[2]=P[2]}else u=m,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,g),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const y=4*4;this._matricesUniformBlockBufferData.set(d,0),this._matricesUniformBlockBufferData.set(u,x+=y),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=y),this._matricesUniformBlockBufferData.set(l.positionsDecodeMatrix,x+=y),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const P=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,P)}this.setSectionPlanesStateUniforms(t),this._aModelMatrixCol0.bindArrayBuffer(l.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(l.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(l.modelMatrixCol2Buf),a.vertexAttribDivisor(this._aModelMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(l.flagsBuf),a.vertexAttribDivisor(this._aFlags.location,1)),l.indicesBuf.bind(),a.drawElementsInstanced(a.LINES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,l.numInstances),l.indicesBuf.unbind(),a.vertexAttribDivisor(this._aModelMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aFlags&&a.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&a.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// SnapInstancingDepthBufInitRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec4 pickColor;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),s.push("flat out vec4 vPickColor;"),s.push("out vec4 vWorldPosition;"),i&&s.push("out float vFlags;"),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vWorldPosition = worldPosition;"),i&&s.push("  vFlags = flags;"),s.push("vPickColor = pickColor;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),s.push("in vec4 vWorldPosition;"),s.push("flat in vec4 vPickColor;"),i){s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("layout(location = 0) out highp ivec4 outCoords;"),s.push("layout(location = 2) out lowp uvec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),s.push("outPickColor = uvec4(vPickColor);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const bx=A.vec3(),Bx=A.vec3(),wx=A.vec3();A.vec3();const Cx=A.mat4();class wu extends Kt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=t._state.origin,{position:h,rotationMatrix:d}=s,p=t.aabb,m=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));const g=bx;g[0]=A.safeInv(p[3]-p[0])*A.MAX_INT,g[1]=A.safeInv(p[4]-p[1])*A.MAX_INT,g[2]=A.safeInv(p[5]-p[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(g[0]),e.snapPickCoordinateScale[1]=A.safeInv(g[1]),e.snapPickCoordinateScale[2]=A.safeInv(g[2]);let u;if(c||h[0]!==0||h[1]!==0||h[2]!==0){const P=Bx;if(c){const _=A.transformPoint3(d,c,wx);P[0]=_[0],P[1]=_[1],P[2]=_[2]}else P[0]=0,P[1]=0,P[2]=0;P[0]+=h[0],P[1]+=h[1],P[2]+=h[2],u=Pt(m,P,Cx),e.snapPickOrigin[0]=P[0],e.snapPickOrigin[1]=P[1],e.snapPickOrigin[2]=P[2]}else u=m,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,g),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const y=4*4;this._matricesUniformBlockBufferData.set(d,0),this._matricesUniformBlockBufferData.set(u,x+=y),this._matricesUniformBlockBufferData.set(a.projMatrix,x+=y),this._matricesUniformBlockBufferData.set(l.positionsDecodeMatrix,x+=y),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const P=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,P)}this.setSectionPlanesStateUniforms(t),this._aModelMatrixCol0.bindArrayBuffer(l.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(l.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(l.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(l.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),e.snapMode==="edge"?(l.indicesBuf.bind(),n.drawElementsInstanced(n.LINES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,l.numInstances),l.indicesBuf.unbind()):n.drawArraysInstanced(n.POINTS,0,l.positionsBuf.numItems,l.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// SnapInstancingDepthRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(2.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("gl_PointSize = 1.0;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// SnapInstancingDepthRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("out highp ivec4 outCoords;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Mx{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}eagerCreateRenders(){this._snapInitRenderer||(this._snapInitRenderer=new Bu(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new wu(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new gx(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new _x(this._scene)),this._silhouetteRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Bu(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new wu(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const Bl={};function Ex(r){const e=r.id;let t=Bl[e];return t||(t=new Mx(r),Bl[e]=t,t._compile(),r.on("compile",()=>{t._compile()}),r.on("destroyed",()=>{delete Bl[e],t._destroy()})),t}const $r=new Uint8Array(4),Cu=new Float32Array(1),bn=new Float32Array(3),ni=new Float32Array(4);class Ix{constructor(e){this.model=e.model,this.material=e.material,this.sortId="LinesInstancingLayer",this.layerIndex=e.layerIndex,this._renderers=Ex(e.model.scene),this._aabb=A.collapseAABB3(),this._state=new Mt({obb:A.OBB3(),numInstances:0,origin:null,geometry:e.geometry,positionsDecodeMatrix:e.geometry.positionsDecodeMatrix,positionsBuf:null,colorsBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._colors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=A.collapseAABB3(),this.aabbDirty=!0,e.origin&&(this._state.origin=A.vec3(e.origin)),this._finalized=!1,this.primitive=e.primitive}get aabb(){if(this.aabbDirty){A.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)A.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}createPortion(e,t){const i=t.color,s=t.opacity,o=t.meshMatrix;if(this._finalized)throw"Already finalized";const a=i[0],n=i[1],l=i[2];i[3],this._colors.push(a),this._colors.push(n),this._colors.push(l),this._colors.push(s),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(o[0]),this._modelMatrixCol0.push(o[4]),this._modelMatrixCol0.push(o[8]),this._modelMatrixCol0.push(o[12]),this._modelMatrixCol1.push(o[1]),this._modelMatrixCol1.push(o[5]),this._modelMatrixCol1.push(o[9]),this._modelMatrixCol1.push(o[13]),this._modelMatrixCol2.push(o[2]),this._modelMatrixCol2.push(o[6]),this._modelMatrixCol2.push(o[10]),this._modelMatrixCol2.push(o[14]),this._state.numInstances++;const c=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,this._meshes.push(e),c}finalize(){if(this._finalized)throw"Already finalized";const e=this.model.scene.canvas.gl,t=this._state,i=t.geometry,s=this._colors.length,o=s/4;if(s>0){let a=!1;this._state.colorsBuf=new Oe(e,e.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,e.DYNAMIC_DRAW,a),this._colors=[]}if(o>0){let a=!1;this._state.flagsBuf=new Oe(e,e.ARRAY_BUFFER,new Float32Array(o),o,1,e.DYNAMIC_DRAW,a)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0&&(this._state.offsetsBuf=new Oe(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,!1),this._offsets=[]),i.colorsCompressed&&i.colorsCompressed.length>0){const a=new Uint8Array(i.colorsCompressed),n=!1;t.colorsBuf=new Oe(e,e.ARRAY_BUFFER,a,a.length,4,e.STATIC_DRAW,n)}i.positionsCompressed&&i.positionsCompressed.length>0&&(t.positionsBuf=new Oe(e,e.ARRAY_BUFFER,i.positionsCompressed,i.positionsCompressed.length,3,e.STATIC_DRAW,!1),t.positionsDecodeMatrix=A.mat4(i.positionsDecodeMatrix)),i.indices&&i.indices.length>0&&(t.indicesBuf=new Oe(e,e.ELEMENT_ARRAY_BUFFER,new Uint32Array(i.indices),i.indices.length,1,e.STATIC_DRAW),t.numIndices=i.indices.length),this._modelMatrixCol0.length>0&&(this._state.modelMatrixCol0Buf=new Oe(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,!1),this._state.modelMatrixCol1Buf=new Oe(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,!1),this._state.modelMatrixCol2Buf=new Oe(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,!1),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]),this.model.scene.readableGeometryEnabled||(this._state.geometry=null),this._finalized=!0}initFlags(e,t,i){t&N.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&N.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&N.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&N.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&N.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&N.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&N.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&N.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&N.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&N.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&N.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&N.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&N.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&N.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&N.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";$r[0]=t[0],$r[1]=t[1],$r[2]=t[2],$r[3]=t[3],this._state.colorsBuf.setData($r,e*4,4)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=!!(t&N.VISIBLE),o=!!(t&N.XRAYED),a=!!(t&N.HIGHLIGHTED),n=!!(t&N.SELECTED),l=!!(t&N.EDGES),c=!!(t&N.PICKABLE),h=!!(t&N.CULLED);let d;!s||h||o||a&&!this.model.scene.highlightMaterial.glowThrough||n&&!this.model.scene.selectedMaterial.glowThrough?d=O.NOT_RENDERED:i?d=O.COLOR_TRANSPARENT:d=O.COLOR_OPAQUE;let p;!s||h?p=O.NOT_RENDERED:n?p=O.SILHOUETTE_SELECTED:a?p=O.SILHOUETTE_HIGHLIGHTED:o?p=O.SILHOUETTE_XRAYED:p=O.NOT_RENDERED;let m=0;!s||h?m=O.NOT_RENDERED:n?m=O.EDGES_SELECTED:a?m=O.EDGES_HIGHLIGHTED:o?m=O.EDGES_XRAYED:l?i?m=O.EDGES_COLOR_TRANSPARENT:m=O.EDGES_COLOR_OPAQUE:m=O.NOT_RENDERED;let g=s&&!h&&c?O.PICK:O.NOT_RENDERED;const u=t&N.CLIPPABLE?255:0;let x=0;x|=d,x|=p<<4,x|=m<<8,x|=g<<12,x|=u<<16,Cu[0]=x,this._state.flagsBuf.setData(Cu,e)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}bn[0]=t[0],bn[1]=t[1],bn[2]=t[2],this._state.offsetsBuf.setData(bn,e*3,3)}setMatrix(e,t){if(!this._finalized)throw"Not finalized";const i=e*4;ni[0]=t[0],ni[1]=t[4],ni[2]=t[8],ni[3]=t[12],this._state.modelMatrixCol0Buf.setData(ni,i),ni[0]=t[1],ni[1]=t[5],ni[2]=t[9],ni[3]=t[13],this._state.modelMatrixCol1Buf.setData(ni,i),ni[0]=t[2],ni[1]=t[6],ni[2]=t[10],ni[3]=t[14],this._state.modelMatrixCol2Buf.setData(ni,i)}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesXRayed(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,O.PICK)}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,O.PICK)}drawOcclusion(e,t){}drawShadow(e,t){}drawPickMesh(e,t){}drawPickDepths(e,t){}drawPickNormals(e,t){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.destroy()}}class Uo extends Kt{_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:o}=e;t.drawArrays(t.POINTS,0,i.positionsBuf.numItems),o&&s.drawArrays++}}class Fx extends Uo{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial,o=[];return o.push("#version 300 es"),o.push("// Points batching color vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec4 color;"),o.push("in float flags;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),s.filterIntensity&&o.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),s.filterIntensity&&(o.push("float intensity = float(color.a) / 255.0;"),o.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {")),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),i&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),s.filterIntensity&&o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points batching color fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}class Sx extends Uo{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points batching silhouette vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),this._addMatricesUniformBlockLines(o),o.push("uniform vec4 color;"),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("void main(void) {"),o.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),o.push("if (silhouetteFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const o=t.getNumAllocatedSectionPlanes()>0,a=[];if(a.push("#version 300 es"),a.push("// Points batching silhouette vertex shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("in float vFragDepth;")),o)for(a.push("in vec4 vWorldPosition;"),a.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)a.push("uniform bool sectionPlaneActive"+i+";"),a.push("uniform vec3 sectionPlanePos"+i+";"),a.push("uniform vec3 sectionPlaneDir"+i+";");if(a.push("uniform vec4 color;"),a.push("out vec4 outColor;"),a.push("void main(void) {"),e.pointsMaterial.roundPoints&&(a.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),a.push("  float r = dot(cxy, cxy);"),a.push("  if (r > 1.0) {"),a.push("       discard;"),a.push("  }")),o){for(a.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)a.push("if (sectionPlaneActive"+i+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}return e.logarithmicDepthBufferEnabled&&a.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("outColor = color;"),a.push("}"),a}}class Tx extends Uo{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batching pick mesh vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 pickColor;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vPickColor;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = remapClipPos(clipPos);"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("gl_PointSize += 10.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points batching pick mesh vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("      if (sectionPlaneActive"+a+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+a+".xyz, vWorldPosition.xyz - sectionPlanePos"+a+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vPickColor; "),s.push("}"),s}}class Dx extends Uo{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batched pick depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = remapClipPos(clipPos);"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("gl_PointSize += 10.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points batched pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("uniform bool sectionPlaneActive"+a+";"),s.push("uniform vec3 sectionPlanePos"+a+";"),s.push("uniform vec3 sectionPlaneDir"+a+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}}class Rx extends Uo{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batching occlusion vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),this._addMatricesUniformBlockLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("  gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points batching occlusion fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}}const Lx=A.vec3(),Ux=A.vec3(),Ox=A.vec3(),kx=A.vec3(),Nx=A.mat4();class Qx extends Kt{drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=t._state.origin,{position:h,rotationMatrix:d}=s,p=t.aabb,m=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));const g=Lx;g[0]=A.safeInv(p[3]-p[0])*A.MAX_INT,g[1]=A.safeInv(p[4]-p[1])*A.MAX_INT,g[2]=A.safeInv(p[5]-p[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(g[0]),e.snapPickCoordinateScale[1]=A.safeInv(g[1]),e.snapPickCoordinateScale[2]=A.safeInv(g[2]);let u,x;if(c||h[0]!==0||h[1]!==0||h[2]!==0){const _=Ux;if(c){const b=Ox;A.transformPoint3(d,c,b),_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=h[0],_[1]+=h[1],_[2]+=h[2],u=Pt(m,_,Nx),x=kx,x[0]=a.eye[0]-_[0],x[1]=a.eye[1]-_[1],x[2]=a.eye[2]-_[2],e.snapPickOrigin[0]=_[0],e.snapPickOrigin[1]=_[1],e.snapPickOrigin[2]=_[2]}else u=m,x=a.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,x),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,g),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniform1f(this._uPointSize,1);let y=0;const P=4*4;this._matricesUniformBlockBufferData.set(d,0),this._matricesUniformBlockBufferData.set(u,y+=P),this._matricesUniformBlockBufferData.set(a.projMatrix,y+=P),this._matricesUniformBlockBufferData.set(l.positionsDecodeMatrix,y+=P),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const _=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,_)}this.setSectionPlanesStateUniforms(t),n.drawArrays(n.POINTS,0,l.positionsBuf.numItems)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler"),this._uPointSize=e.getLocation("pointSize")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// VBOBatchingPointsSnapInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float pointSize;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = pointSize;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// VBOBatchingPointsSnapInitRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),s.push("in vec4 vWorldPosition;"),s.push("flat in vec4 vPickColor;"),i){s.push("in float vFlags;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("uniform bool sectionPlaneActive"+a+";"),s.push("uniform vec3 sectionPlanePos"+a+";"),s.push("uniform vec3 sectionPlaneDir"+a+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("layout(location = 0) out highp ivec4 outCoords;"),s.push("layout(location = 1) out highp ivec4 outNormal;"),s.push("layout(location = 2) out lowp uvec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),s.push("outNormal = ivec4(1.0, 1.0, 1.0, 1.0);"),s.push("outPickColor = uvec4(vPickColor);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Vx=A.vec3(),Hx=A.vec3(),jx=A.vec3(),zx=A.vec3(),Gx=A.mat4();class Wx extends Kt{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=t._state.origin,{position:h,rotationMatrix:d}=s,p=t.aabb,m=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));const g=Vx;g[0]=A.safeInv(p[3]-p[0])*A.MAX_INT,g[1]=A.safeInv(p[4]-p[1])*A.MAX_INT,g[2]=A.safeInv(p[5]-p[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(g[0]),e.snapPickCoordinateScale[1]=A.safeInv(g[1]),e.snapPickCoordinateScale[2]=A.safeInv(g[2]);let u,x;if(c||h[0]!==0||h[1]!==0||h[2]!==0){const _=Hx;if(c){const b=jx;A.transformPoint3(d,c,b),_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=h[0],_[1]+=h[1],_[2]+=h[2],u=Pt(m,_,Gx),x=zx,x[0]=a.eye[0]-_[0],x[1]=a.eye[1]-_[1],x[2]=a.eye[2]-_[2],e.snapPickOrigin[0]=_[0],e.snapPickOrigin[1]=_[1],e.snapPickOrigin[2]=_[2]}else u=m,x=a.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,x),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,g),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let y=0;const P=4*4;this._matricesUniformBlockBufferData.set(d,0),this._matricesUniformBlockBufferData.set(u,y+=P),this._matricesUniformBlockBufferData.set(a.projMatrix,y+=P),this._matricesUniformBlockBufferData.set(l.positionsDecodeMatrix,y+=P),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const _=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,_)}this.setSectionPlanesStateUniforms(t),n.drawArrays(n.POINTS,0,l.positionsBuf.numItems)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;const i=[];return i.push("#version 300 es"),i.push("// VBOBatchingPointsSnapRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// VBOBatchingPointsSnapRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let a=0;a<t.getNumAllocatedSectionPlanes();a++)s.push("uniform bool sectionPlaneActive"+a+";"),s.push("uniform vec3 sectionPlanePos"+a+";"),s.push("uniform vec3 sectionPlaneDir"+a+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("out highp ivec4 outCoords;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Kx{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Fx(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Sx(this._scene)),this._silhouetteRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Tx(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Dx(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Rx(this._scene)),this._occlusionRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Qx(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new Wx(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const wl={};function Xx(r){const e=r.id;let t=wl[e];return t||(t=new Kx(r),wl[e]=t,t._compile(),r.on("compile",()=>{t._compile()}),r.on("destroyed",()=>{delete wl[e],t._destroy()})),t}class Yx{constructor(e){this.model=e.model,this.sortId="PointsBatchingLayer",this.layerIndex=e.layerIndex,this._renderers=Xx(e.model.scene);const t=e.maxGeometryBatchSize||5e6,i=function(){const s=[];return{append:function(o,a=1,n=1){s.push({data:o,times:a,denormalizeScale:n})},compileBuffer:function(o){let a=0;s.forEach(c=>{a+=c.times*c.data.length});const n=new o(a);let l=0;return s.forEach(c=>{const h=c.data,d=c.denormalizeScale,p=n.subarray(l);if(d===1)p.set(h,0);else for(let u=0;u<h.length;++u)p[u]=h[u]*d;let m=h.length;const g=c.times*h.length;for(;m<g;){const u=Math.min(m,g-m);p.set(p.subarray(0,u),m),m+=u}l+=m}),n}}};this._buffer={maxVerts:t,positions:i(),colors:i(),pickColors:i(),vertsIndex:0},this._scratchMemory=e.scratchMemory,this._state=new Mt({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,positionsDecodeMatrix:A.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=A.collapseAABB3(),this._portions=[],this._meshes=[],this._aabb=A.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.origin&&(this._state.origin=A.vec3(e.origin))}get aabb(){if(this.aabbDirty){A.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)A.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e){if(this._finalized)throw"Already finalized";return this._buffer.vertsIndex+e/3<=this._buffer.maxVerts}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=this._buffer,s=this._preCompressedPositionsExpected?t.positionsCompressed:t.positions;if(!s)throw(this._preCompressedPositionsExpected?"positionsCompressed":"positions")+" expected";i.positions.append(s);const o=s.length/3,a=t.color,n=t.colorsCompressed,l=t.colors,c=t.pickColor;n?i.colors.append(n):l?i.colors.append(l,1,255):a&&i.colors.append([a[0],a[1],a[2],1],o),i.pickColors.append(c.slice(0,4),o),A.expandAABB3(this._modelAABB,t.aabb);const h=this._portions.length/2;return this._portions.push(this._buffer.vertsIndex),this._portions.push(o),this._buffer.vertsIndex+=o,this._numPortions++,this.model.numPortions++,this._meshes.push(e),h}finalize(){if(this._finalized)return;const e=this._state,t=this.model.scene.canvas.gl,i=this._buffer,s=(a,n,l)=>a.length>0?new Oe(t,t.ARRAY_BUFFER,a,a.length,n,l):null,o=this._preCompressedPositionsExpected?i.positions.compileBuffer(Uint16Array):Io(i.positions.compileBuffer(Float32Array),this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=s(o,3,t.STATIC_DRAW),e.flagsBuf=s(new Float32Array(this._buffer.vertsIndex),1,t.DYNAMIC_DRAW),e.colorsBuf=s(i.colors.compileBuffer(Uint8Array),4,t.STATIC_DRAW),e.pickColorsBuf=s(i.pickColors.compileBuffer(Uint8Array),4,t.STATIC_DRAW),e.offsetsBuf=this.model.scene.entityOffsetsEnabled?s(new Float32Array(this._buffer.vertsIndex*3),3,t.DYNAMIC_DRAW):null,this._buffer=null,this._finalized=!0}initFlags(e,t,i){t&N.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&N.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&N.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&N.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&N.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&N.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&N.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&N.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&N.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&N.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized"}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&N.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&N.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&N.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";const i=e*2,s=this._portions[i],o=this._portions[i+1],a=s*4,n=o*4,l=this._scratchMemory.getUInt8Array(n),c=t[0],h=t[1],d=t[2];for(let p=0;p<n;p+=4)l[p+0]=c,l[p+1]=h,l[p+2]=d;this._state.colorsBuf.setData(l,a,n)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=e*2,o=this._portions[s],a=this._portions[s+1],n=o,l=a,c=this._scratchMemory.getFloat32Array(l),h=!!(t&N.VISIBLE),d=!!(t&N.XRAYED),p=!!(t&N.HIGHLIGHTED),m=!!(t&N.SELECTED),g=!!(t&N.PICKABLE),u=!!(t&N.CULLED);let x;!h||u||d||p&&!this.model.scene.highlightMaterial.glowThrough||m&&!this.model.scene.selectedMaterial.glowThrough?x=O.NOT_RENDERED:i?x=O.COLOR_TRANSPARENT:x=O.COLOR_OPAQUE;let y;!h||u?y=O.NOT_RENDERED:m?y=O.SILHOUETTE_SELECTED:p?y=O.SILHOUETTE_HIGHLIGHTED:d?y=O.SILHOUETTE_XRAYED:y=O.NOT_RENDERED;let P=h&&!u&&g?O.PICK:O.NOT_RENDERED;const _=t&N.CLIPPABLE?1:0;for(let b=0;b<l;b++){let B=0;B|=x,B|=y<<4,B|=P<<12,B|=_<<16,c[b]=B}this._state.flagsBuf.setData(c,n)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}const i=e*2,s=this._portions[i],o=this._portions[i+1],a=s*3,n=o*3,l=this._scratchMemory.getFloat32Array(n),c=t[0],h=t[1],d=t[2];for(let p=0;p<n;p+=3)l[p+0]=c,l[p+1]=h,l[p+2]=d;this._state.offsetsBuf.setData(l,a,n)}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawPickMesh(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,O.PICK)}drawPickDepths(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,O.PICK)}drawPickNormals(e,t){}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,O.PICK)}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,O.PICK)}drawOcclusion(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,O.COLOR_OPAQUE)}drawShadow(e,t){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}class Ks extends Kt{constructor(e,t){super(e,t,{instancing:!0})}_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:o}=e;t.drawArraysInstanced(t.POINTS,0,i.positionsBuf.numItems,i.numInstances),o&&s.drawArrays++}}class $x extends Ks{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing color vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec4 color;"),o.push("in float flags;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),s.filterIntensity&&o.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),s.filterIntensity&&(o.push("float intensity = float(color.a) / 255.0;"),o.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {")),o.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),o.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),i&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),s.filterIntensity&&o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing color fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}class Zx extends Ks{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing silhouette vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),o.push("in vec4 color;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),o.push("uniform vec4 silhouetteColor;"),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),o.push("if (silhouetteFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("vColor = vec4(float(silhouetteColor.r) / 255.0, float(silhouetteColor.g) / 255.0, float(silhouetteColor.b) / 255.0, float(color.a) / 255.0);"),o.push("gl_Position = clipPos;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing silhouette fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class qx extends Ks{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing pick mesh vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),o.push("in vec4 pickColor;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),o.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(o),this._addRemapClipPosLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vPickColor;"),o.push("void main(void) {"),o.push("int pickFlag = int(flags) >> 12 & 0xF;"),o.push("if (pickFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),i&&(o.push("  vWorldPosition = worldPosition;"),o.push("  vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),o.push("gl_Position = remapClipPos(clipPos);"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick mesh fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vPickColor; "),s.push("}"),s}}class Jx extends Ks{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing pick depth vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),o.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(o),this._addRemapClipPosLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vViewPosition;"),o.push("void main(void) {"),o.push("int pickFlag = int(flags) >> 12 & 0xF;"),o.push("if (pickFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(o.push("  vWorldPosition = worldPosition;"),o.push("  vFlags = flags;")),o.push("  vViewPosition = viewPosition;"),o.push("vec4 clipPos = projMatrix * viewPosition;"),o.push("gl_Position = remapClipPos(clipPos);"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = remapClipPos(clipPos);"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}}class ey extends Ks{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing occlusion vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in vec4 color;"),o.push("in float flags;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(o.push("  vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing occlusion vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}class ty extends Ks{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=e.pointsMaterial._state,o=[];return o.push("#version 300 es"),o.push("// Points instancing depth vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in float flags;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(o),o.push("uniform float pointSize;"),s.perspectivePoints&&o.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;")),i&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),o.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("gl_Position = clipPos;"),s.perspectivePoints?(o.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),o.push("gl_PointSize = max(gl_PointSize, "+Math.floor(s.minPerspectivePointSize)+".0);"),o.push("gl_PointSize = min(gl_PointSize, "+Math.floor(s.maxPerspectivePointSize)+".0);")):o.push("gl_PointSize = pointSize;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const o=t.getNumAllocatedSectionPlanes()>0,a=[];if(a.push("#version 300 es"),a.push("// Points instancing depth vertex shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("in float vFragDepth;")),o)for(a.push("in vec4 vWorldPosition;"),a.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)a.push("uniform bool sectionPlaneActive"+i+";"),a.push("uniform vec3 sectionPlanePos"+i+";"),a.push("uniform vec3 sectionPlaneDir"+i+";");if(a.push("const float   packUpScale = 256. / 255.;"),a.push("const float   unpackDownscale = 255. / 256.;"),a.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),a.push("const float   shiftRight8 = 1.0 / 256.;"),a.push("vec4 packDepthToRGBA( const in float v ) {"),a.push("    vec4 r = vec4( fract( v * packFactors ), v );"),a.push("    r.yzw -= r.xyz * shiftRight8;"),a.push("    return r * packUpScale;"),a.push("}"),a.push("out vec4 outColor;"),a.push("void main(void) {"),e.pointsMaterial.roundPoints&&(a.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),a.push("  float r = dot(cxy, cxy);"),a.push("  if (r > 1.0) {"),a.push("       discard;"),a.push("  }")),o){for(a.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)a.push("if (sectionPlaneActive"+i+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),a.push("}");a.push("if (dist > 0.0) { discard; }"),a.push("}")}return a.push("    outColor = packDepthToRGBA( gl_FragCoord.z); "),e.logarithmicDepthBufferEnabled&&a.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}}class iy extends Ks{_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// Instancing geometry shadow drawing vertex shader"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(s),s.push("uniform float pointSize;"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int colorFlag     = int(flags) & 0xF;"),s.push("bool visible      = (colorFlag > 0);"),s.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),s.push("if (!visible || transparent) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("  gl_Position = shadowProjMatrix * viewPosition;"),s.push("}"),s.push("gl_PointSize = pointSize;"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry depth drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}}const sy=A.vec3(),ry=A.vec3(),oy=A.vec3();A.vec3();const ny=A.mat4();class ay extends Kt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.canvas.gl,n=o.camera,l=t._state,c=t._state.origin,{position:h,rotationMatrix:d}=s,p=t.aabb,m=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?a.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));const g=sy;g[0]=A.safeInv(p[3]-p[0])*A.MAX_INT,g[1]=A.safeInv(p[4]-p[1])*A.MAX_INT,g[2]=A.safeInv(p[5]-p[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(g[0]),e.snapPickCoordinateScale[1]=A.safeInv(g[1]),e.snapPickCoordinateScale[2]=A.safeInv(g[2]);let u;if(c||h[0]!==0||h[1]!==0||h[2]!==0){const P=ry;if(c){const _=A.transformPoint3(d,c,oy);P[0]=_[0],P[1]=_[1],P[2]=_[2]}else P[0]=0,P[1]=0,P[2]=0;P[0]+=h[0],P[1]+=h[1],P[2]+=h[2],u=Pt(m,P,ny),e.snapPickOrigin[0]=P[0],e.snapPickOrigin[1]=P[1],e.snapPickOrigin[2]=P[2]}else u=m,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;a.uniform2fv(this.uVectorA,e.snapVectorA),a.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),a.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),a.uniform3fv(this._uCoordinateScaler,g),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const y=4*4;this._matricesUniformBlockBufferData.set(d,0),this._matricesUniformBlockBufferData.set(u,x+=y),this._matricesUniformBlockBufferData.set(n.projMatrix,x+=y),this._matricesUniformBlockBufferData.set(l.positionsDecodeMatrix,x+=y),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const P=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,P)}this.setSectionPlanesStateUniforms(t),this._aModelMatrixCol0.bindArrayBuffer(l.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(l.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(l.modelMatrixCol2Buf),a.vertexAttribDivisor(this._aModelMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(l.flagsBuf),a.vertexAttribDivisor(this._aFlags.location,1)),a.drawArraysInstanced(a.POINTS,0,l.positionsBuf.numItems,l.numInstances),a.vertexAttribDivisor(this._aModelMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aFlags&&a.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&a.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// SnapInstancingDepthBufInitRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec4 pickColor;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),s.push("flat out vec4 vPickColor;"),s.push("out vec4 vWorldPosition;"),i&&s.push("out float vFlags;"),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vWorldPosition = worldPosition;"),i&&s.push("  vFlags = flags;"),s.push("vPickColor = pickColor;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),s.push("in vec4 vWorldPosition;"),s.push("flat in vec4 vPickColor;"),i){s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("layout(location = 0) out highp ivec4 outCoords;"),s.push("layout(location = 1) out highp ivec4 outNormal;"),s.push("layout(location = 2) out lowp uvec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),s.push("outNormal = ivec4(1.0, 1.0, 1.0, 1.0);"),s.push("outPickColor = uvec4(vPickColor);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ly=A.vec3(),Ay=A.vec3(),cy=A.vec3();A.vec3();const hy=A.mat4();class uy extends Kt{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=t._state.origin,{position:h,rotationMatrix:d}=s,p=t.aabb,m=e.pickViewMatrix||a.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));const g=ly;g[0]=A.safeInv(p[3]-p[0])*A.MAX_INT,g[1]=A.safeInv(p[4]-p[1])*A.MAX_INT,g[2]=A.safeInv(p[5]-p[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(g[0]),e.snapPickCoordinateScale[1]=A.safeInv(g[1]),e.snapPickCoordinateScale[2]=A.safeInv(g[2]);let u;if(c||h[0]!==0||h[1]!==0||h[2]!==0){const P=Ay;if(c){const _=A.transformPoint3(d,c,cy);P[0]=_[0],P[1]=_[1],P[2]=_[2]}else P[0]=0,P[1]=0,P[2]=0;P[0]+=h[0],P[1]+=h[1],P[2]+=h[2],u=Pt(m,P,hy),e.snapPickOrigin[0]=P[0],e.snapPickOrigin[1]=P[1],e.snapPickOrigin[2]=P[2]}else u=m,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,g),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let x=0;const y=4*4;this._matricesUniformBlockBufferData.set(d,0),this._matricesUniformBlockBufferData.set(u,x+=y),this._matricesUniformBlockBufferData.set(a.projMatrix,x+=y),this._matricesUniformBlockBufferData.set(l.positionsDecodeMatrix,x+=y),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const P=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,P)}this.setSectionPlanesStateUniforms(t),this._aModelMatrixCol0.bindArrayBuffer(l.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(l.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(l.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(l.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),n.drawArraysInstanced(n.POINTS,0,l.positionsBuf.numItems,l.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,i=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=[];return s.push("#version 300 es"),s.push("// SnapInstancingDepthRenderer vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec2 snapVectorA;"),s.push("uniform vec2 snapInvVectorAB;"),s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out float isPerspective;"),s.push("vec2 remapClipPos(vec2 clipPos) {"),s.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),s.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),s.push("    return vec2(x, y);"),s.push("}"),i&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out highp vec3 relativeToOriginPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("relativeToOriginPosition = worldPosition.xyz;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("float tmp = clipPos.w;"),s.push("clipPos.xyzw /= tmp;"),s.push("clipPos.xy = remapClipPos(clipPos.xy);"),s.push("clipPos.xyzw *= tmp;"),s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),s.push("gl_Position = clipPos;"),s.push("gl_PointSize = 1.0;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// SnapInstancingDepthRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;"),s.push("uniform int layerNumber;"),s.push("uniform vec3 coordinateScaler;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in highp vec3 relativeToOriginPosition;"),s.push("out highp ivec4 outCoords;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class dy{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new $x(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Zx(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new ty(this._scene)),this._depthRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new qx(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Jx(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new ey(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new iy(this._scene)),this._shadowRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new ay(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new uy(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const Cl={};function py(r){const e=r.id;let t=Cl[e];return t||(t=new dy(r),Cl[e]=t,t._compile(),r.on("compile",()=>{t._compile()}),r.on("destroyed",()=>{delete Cl[e],t._destroy()})),t}const Bn=new Uint8Array(4),Mu=new Float32Array(1),wn=new Float32Array(3),ai=new Float32Array(4);class fy{constructor(e){this.model=e.model,this.material=e.material,this.sortId="PointsInstancingLayer",this.layerIndex=e.layerIndex,this._renderers=py(e.model.scene),this._aabb=A.collapseAABB3(),this._state=new Mt({obb:A.OBB3(),numInstances:0,origin:e.origin?A.vec3(e.origin):null,geometry:e.geometry,positionsDecodeMatrix:e.geometry.positionsDecodeMatrix,colorsBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null,pickColorsBuf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=A.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,this.primitive=e.geometry.primitive}get aabb(){if(this.aabbDirty){A.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)A.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}createPortion(e,t){const i=t.meshMatrix,s=t.pickColor;if(this._finalized)throw"Already finalized";this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(i[0]),this._modelMatrixCol0.push(i[4]),this._modelMatrixCol0.push(i[8]),this._modelMatrixCol0.push(i[12]),this._modelMatrixCol1.push(i[1]),this._modelMatrixCol1.push(i[5]),this._modelMatrixCol1.push(i[9]),this._modelMatrixCol1.push(i[13]),this._modelMatrixCol2.push(i[2]),this._modelMatrixCol2.push(i[6]),this._modelMatrixCol2.push(i[10]),this._modelMatrixCol2.push(i[14]),this._pickColors.push(s[0]),this._pickColors.push(s[1]),this._pickColors.push(s[2]),this._pickColors.push(s[3]),this._state.numInstances++;const o=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,this._meshes.push(e),o}finalize(){if(this._finalized)throw"Already finalized";const e=this.model.scene.canvas.gl,t=this._pickColors.length/4,i=this._state,s=i.geometry;if(t>0){let o=!1;i.flagsBuf=new Oe(e,e.ARRAY_BUFFER,new Float32Array(t),t,1,e.DYNAMIC_DRAW,o)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0&&(i.offsetsBuf=new Oe(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,!1),this._offsets=[]),s.positionsCompressed&&s.positionsCompressed.length>0&&(i.positionsBuf=new Oe(e,e.ARRAY_BUFFER,s.positionsCompressed,s.positionsCompressed.length,3,e.STATIC_DRAW,!1),i.positionsDecodeMatrix=A.mat4(s.positionsDecodeMatrix)),s.colorsCompressed&&s.colorsCompressed.length>0){const o=new Uint8Array(s.colorsCompressed),a=!1;i.colorsBuf=new Oe(e,e.ARRAY_BUFFER,o,o.length,4,e.STATIC_DRAW,a)}this._modelMatrixCol0.length>0&&(i.modelMatrixCol0Buf=new Oe(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,!1),i.modelMatrixCol1Buf=new Oe(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,!1),i.modelMatrixCol2Buf=new Oe(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,!1),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]),this._pickColors.length>0&&(i.pickColorsBuf=new Oe(e,e.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,e.STATIC_DRAW,!1),this._pickColors=[]),i.geometry=null,this._finalized=!0}initFlags(e,t,i){t&N.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&N.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&N.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&N.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&N.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&N.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&N.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&N.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&N.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&N.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&N.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&N.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&N.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&N.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&N.CULLED?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";Bn[0]=t[0],Bn[1]=t[1],Bn[2]=t[2],this._state.colorsBuf.setData(Bn,e*3)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=!!(t&N.VISIBLE),o=!!(t&N.XRAYED),a=!!(t&N.HIGHLIGHTED),n=!!(t&N.SELECTED),l=!!(t&N.EDGES),c=!!(t&N.PICKABLE),h=!!(t&N.CULLED);let d;!s||h||o||a&&!this.model.scene.highlightMaterial.glowThrough||n&&!this.model.scene.selectedMaterial.glowThrough?d=O.NOT_RENDERED:i?d=O.COLOR_TRANSPARENT:d=O.COLOR_OPAQUE;let p;!s||h?p=O.NOT_RENDERED:n?p=O.SILHOUETTE_SELECTED:a?p=O.SILHOUETTE_HIGHLIGHTED:o?p=O.SILHOUETTE_XRAYED:p=O.NOT_RENDERED;let m=0;!s||h?m=O.NOT_RENDERED:n?m=O.EDGES_SELECTED:a?m=O.EDGES_HIGHLIGHTED:o?m=O.EDGES_XRAYED:l?i?m=O.EDGES_COLOR_TRANSPARENT:m=O.EDGES_COLOR_OPAQUE:m=O.NOT_RENDERED;let g=s&&!h&&c?O.PICK:O.NOT_RENDERED;const u=t&N.CLIPPABLE?255:0;let x=0;x|=d,x|=p<<4,x|=m<<8,x|=g<<12,x|=u<<16,Mu[0]=x,this._state.flagsBuf.setData(Mu,e)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled){this.model.error("Entity#offset not enabled for this Viewer");return}wn[0]=t[0],wn[1]=t[1],wn[2]=t[2],this._state.offsetsBuf.setData(wn,e*3)}setMatrix(e,t){if(!this._finalized)throw"Not finalized";const i=e*4;ai[0]=t[0],ai[1]=t[4],ai[2]=t[8],ai[3]=t[12],this._state.modelMatrixCol0Buf.setData(ai,i),ai[0]=t[1],ai[1]=t[5],ai[2]=t[9],ai[3]=t[13],this._state.modelMatrixCol1Buf.setData(ai,i),ai[0]=t[2],ai[1]=t[6],ai[2]=t[10],ai[3]=t[14],this._state.modelMatrixCol2Buf.setData(ai,i)}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawOcclusion(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,O.COLOR_OPAQUE)}drawShadow(e,t){}drawPickMesh(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,O.PICK)}drawPickDepths(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,O.PICK)}drawPickNormals(e,t){}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,O.PICK)}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,O.PICK)}destroy(){const e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}const Eu=A.vec3(),my=A.vec3(),gy=A.mat4();class _y{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=this._scene,o=s.camera,a=t.model,n=s.canvas.gl,l=t._state,c=l.textureState,h=t._state.origin,{position:d,rotationMatrix:p}=a,m=o.viewMatrix;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,l)),c.bindCommonTextures(this._program,this.uPerObjectDecodeMatrix,this._uPerVertexPosition,this.uPerObjectColorAndFlags,this._uPerObjectMatrix);let g;const u=h[0]!==0||h[1]!==0||h[2]!==0,x=d[0]!==0||d[1]!==0||d[2]!==0;if(u||x){const _=Eu;if(u){const b=A.transformPoint3(p,h,my);_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=d[0],_[1]+=d[1],_[2]+=d[2],g=Pt(m,_,gy)}else g=m;if(n.uniformMatrix4fv(this._uSceneModelMatrix,!1,p),n.uniformMatrix4fv(this._uViewMatrix,!1,g),n.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),n.uniform1i(this._uRenderPass,i),s.logarithmicDepthBufferEnabled){const _=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,_)}const y=s._sectionPlanesState.getNumAllocatedSectionPlanes(),P=s._sectionPlanesState.sectionPlanes.length;if(y>0){const _=s._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,B=a.renderFlags;for(let w=0;w<y;w++){const C=this._uSectionPlanes[w];if(C)if(w<P){const E=B.sectionPlanesActivePerLayer[b+w];if(n.uniform1i(C.active,E?1:0),E){const I=_[w];if(h){const R=kt(I.dist,I.dir,h,Eu,a.matrix);n.uniform3fv(C.pos,R)}else n.uniform3fv(C.pos,I.pos);n.uniform3fv(C.dir,I.dir)}}else n.uniform1i(C.active,0)}}l.numIndices8Bits>0&&(c.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,8),n.drawArrays(n.LINES,0,l.numIndices8Bits)),l.numIndices16Bits>0&&(c.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,16),n.drawArrays(n.LINES,0,l.numIndices16Bits)),l.numIndices32Bits>0&&(c.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,32),n.drawArrays(n.LINES,0,l.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors,console.error(this.errors);return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uPerObjectDecodeMatrix="uPerObjectDecodeMatrix",this.uPerObjectColorAndFlags="uPerObjectColorAndFlags",this._uPerVertexPosition="uPerVertexPosition",this._uPerLineIndices="uPerLineIndices",this._uPerLineObject="uPerLineObject",this._uPerObjectMatrix="uPerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,o=t.camera.project;if(s.bind(),t.logarithmicDepthBufferEnabled){const a=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,a)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// LinesDataTextureColorRenderer"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled,i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uPerObjectDecodeMatrix;"),i.push("uniform highp sampler2D uPerObjectMatrix;"),i.push("uniform lowp usampler2D uPerObjectColorAndFlags;"),i.push("uniform mediump usampler2D uPerVertexPosition;"),i.push("uniform highp usampler2D uPerLineIndices;"),i.push("uniform mediump usampler2D uPerLineObject;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("  int lineIndex = gl_VertexID / 2;"),i.push("  int h_packed_object_id_index = (lineIndex >> 3) & 4095;"),i.push("  int v_packed_object_id_index = (lineIndex >> 3) >> 12;"),i.push("  int objectIndex = int(texelFetch(uPerLineObject, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("  ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("  uvec4 flags = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("  uvec4 flags2 = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("  if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("      return;"),i.push("  } else {"),i.push("      ivec4 packedVertexBase = ivec4(texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("      ivec4 packedLineIndexBaseOffset = ivec4(texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("      int lineIndexBaseOffset = (packedLineIndexBaseOffset.r << 24) + (packedLineIndexBaseOffset.g << 16) + (packedLineIndexBaseOffset.b << 8) + packedLineIndexBaseOffset.a;"),i.push("      int h_index = (lineIndex - lineIndexBaseOffset) & 4095;"),i.push("      int v_index = (lineIndex - lineIndexBaseOffset) >> 12;"),i.push("      ivec3 vertexIndices = ivec3(texelFetch(uPerLineIndices, ivec2(h_index, v_index), 0));"),i.push("      ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("      int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("      int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("      mat4 objectInstanceMatrix = mat4 (texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("      mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("      uvec4 flags = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("      uvec4 flags2 = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("      vec3 position = vec3(texelFetch(uPerVertexPosition, ivec2(indexPositionH, indexPositionV), 0));"),i.push("      uvec4 color = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("      if (color.a == 0u) {"),i.push("          gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("          return;"),i.push("      };"),i.push("      vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2.r;")),i.push("      vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("      vFragDepth = 1.0 + clipPos.w;"),i.push("      isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("      gl_Position = clipPos;"),i.push("      vec4 rgb = vec4(color.rgba);"),i.push("      vColor = vec4(float(rgb.r*0.5) / 255.0, float(rgb.g*0.5) / 255.0, float(rgb.b*0.5) / 255.0, float(rgb.a) / 255.0);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// LinesDataTextureColorRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor            = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class vy{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null)}eagerCreateRenders(){}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new _y(this._scene,!1)),this._colorRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy()}}const Ml={};function Py(r){const e=r.id;let t=Ml[e];return t||(t=new vy(r),Ml[e]=t,t._compile(),t.eagerCreateRenders(),r.on("compile",()=>{t._compile(),t.eagerCreateRenders()}),r.on("destroyed",()=>{delete Ml[e],t._destroy()})),t}class xy{constructor(){this.positionsCompressed=[],this.lenPositionsCompressed=0,this.indices8Bits=[],this.lenIndices8Bits=0,this.indices16Bits=[],this.lenIndices16Bits=0,this.indices32Bits=[],this.lenIndices32Bits=0,this.perObjectColors=[],this.perObjectPickColors=[],this.perObjectSolid=[],this.perObjectOffsets=[],this.perObjectPositionsDecodeMatrices=[],this.perObjectInstancePositioningMatrices=[],this.perObjectVertexBases=[],this.perObjectIndexBaseOffsets=[],this.perLineNumberPortionId8Bits=[],this.perLineNumberPortionId16Bits=[],this.perLineNumberPortionId32Bits=[]}}class yy{constructor(){this.texturePerObjectColorsAndFlags=null,this.texturePerObjectOffsets=null,this.texturePerObjectInstanceMatrices=null,this.texturePerObjectPositionsDecodeMatrix=null,this.texturePerVertexIdCoordinates=null,this.texturePerLineIdPortionIds8Bits=null,this.texturePerLineIdPortionIds16Bits=null,this.texturePerLineIdPortionIds32Bits=null,this.texturePerLineIdIndices8Bits=null,this.texturePerLineIdIndices16Bits=null,this.texturePerLineIdIndices32Bits=null,this.textureModelMatrices=null}finalize(){this.indicesPerBitnessTextures={8:this.texturePerLineIdIndices8Bits,16:this.texturePerLineIdIndices16Bits,32:this.texturePerLineIdIndices32Bits},this.indicesPortionIdsPerBitnessTextures={8:this.texturePerLineIdPortionIds8Bits,16:this.texturePerLineIdPortionIds16Bits,32:this.texturePerLineIdPortionIds32Bits}}bindCommonTextures(e,t,i,s,o){this.texturePerObjectPositionsDecodeMatrix.bindTexture(e,t,1),this.texturePerVertexIdCoordinates.bindTexture(e,i,2),this.texturePerObjectColorsAndFlags.bindTexture(e,s,3),this.texturePerObjectInstanceMatrices.bindTexture(e,o,4)}bindLineIndicesTextures(e,t,i,s){this.indicesPortionIdsPerBitnessTextures[s].bindTexture(e,t,5),this.indicesPerBitnessTextures[s].bindTexture(e,i,6)}}class Ot{constructor(e,t,i,s,o=null){this._gl=e,this._texture=t,this._textureWidth=i,this._textureHeight=s,this._textureData=o}bindTexture(e,t,i){return e.bindTexture(t,this,i)}bind(e){return this._gl.activeTexture(this._gl["TEXTURE"+e]),this._gl.bindTexture(this._gl.TEXTURE_2D,this._texture),!0}unbind(e){}}const ft={sizeDataColorsAndFlags:0,sizeDataPositionDecodeMatrices:0,sizeDataTextureOffsets:0,sizeDataTexturePositions:0,sizeDataTextureIndices:0,sizeDataTexturePortionIds:0,numberOfGeometries:0,numberOfPortions:0,numberOfLayers:0,numberOfTextures:0,totalLines:0,totalLines8Bits:0,totalLines16Bits:0,totalLines32Bits:0,cannotCreatePortion:{because10BitsObjectId:0,becauseTextureSize:0},overheadSizeAlignementIndices:0,overheadSizeAlignementEdgeIndices:0};window.printDataTextureRamStats=function(){console.log(JSON.stringify(ft,null,4));let r=0;Object.keys(ft).forEach(t=>{t.startsWith("size")&&(r+=ft[t])}),console.log(`Total size ${r} bytes (${(r/1e3/1e3).toFixed(2)} MB)`),console.log(`Avg bytes / triangle: ${(r/ft.totalLines).toFixed(2)}`);let e={};Object.keys(ft).forEach(t=>{t.startsWith("size")&&(e[t]=`${(ft[t]/r*100).toFixed(2)} % of total`)}),console.log(JSON.stringify({percentualRamUsage:e},null,4))};class by{disableBindedTextureFiltering(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}generateTextureForColorsAndFlags(e,t,i,s,o){const a=t.length;this.numPortions=a;const n=512*8,l=Math.ceil(a/(n/8));if(l===0)throw"texture height===0";const c=new Uint8Array(4*n*l);ft.sizeDataColorsAndFlags+=c.byteLength,ft.numberOfTextures++;for(let d=0;d<a;d++)c.set(t[d],d*32+0),c.set(i[d],d*32+4),c.set([0,0,0,0],d*32+8),c.set([0,0,0,0],d*32+12),c.set([s[d]>>24&255,s[d]>>16&255,s[d]>>8&255,s[d]&255],d*32+16),c.set([o[d]>>24&255,o[d]>>16&255,o[d]>>8&255,o[d]&255],d*32+20);const h=e.createTexture();return e.bindTexture(e.TEXTURE_2D,h),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8UI,n,l),e.texSubImage2D(e.TEXTURE_2D,0,0,0,n,l,e.RGBA_INTEGER,e.UNSIGNED_BYTE,c,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,h,n,l,c)}generateTextureForObjectOffsets(e,t){const s=Math.ceil(t/512);if(s===0)throw"texture height===0";const o=new Float32Array(3*512*s).fill(0);ft.sizeDataTextureOffsets+=o.byteLength,ft.numberOfTextures++;const a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32F,512,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,512,s,e.RGB,e.FLOAT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,a,512,s,o)}generateTextureForInstancingMatrices(e,t){const i=t.length;if(i===0)throw"num instance matrices===0";const s=512*4,o=Math.ceil(i/(s/4)),a=new Float32Array(4*s*o);ft.numberOfTextures++;for(let l=0;l<t.length;l++)a.set(t[l],l*16);const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGBA,e.FLOAT,a,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,n,s,o,a)}generateTextureForPositionsDecodeMatrices(e,t){const i=t.length;if(i===0)throw"num decode+entity matrices===0";const s=512*4,o=Math.ceil(i/(s/4)),a=new Float32Array(4*s*o);ft.sizeDataPositionDecodeMatrices+=a.byteLength,ft.numberOfTextures++;for(let l=0;l<t.length;l++)a.set(t[l],l*16);const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGBA,e.FLOAT,a,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,n,s,o)}generateTextureFor8BitIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/3/s);if(o===0)throw"texture height===0";const a=s*o*3,n=new Uint8Array(a);ft.sizeDataTextureIndices+=n.byteLength,ft.numberOfTextures++;for(let c=0,h=0,d=t.length;c<d;c++){const p=t[c];n.set(p,h),h+=p.length}const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RGB8UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGB_INTEGER,e.UNSIGNED_BYTE,n,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,l,s,o)}generateTextureFor16BitIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/3/s);if(o===0)throw"texture height===0";const a=s*o*3,n=new Uint16Array(a);ft.sizeDataTextureIndices+=n.byteLength,ft.numberOfTextures++;for(let c=0,h=0,d=t.length;c<d;c++){const p=t[c];n.set(p,h),h+=p.length}const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGB_INTEGER,e.UNSIGNED_SHORT,n,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,l,s,o)}generateTextureFor32BitIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/3/s);if(o===0)throw"texture height===0";const a=s*o*3,n=new Uint32Array(a);ft.sizeDataTextureIndices+=n.byteLength,ft.numberOfTextures++;for(let c=0,h=0,d=t.length;c<d;c++){const p=t[c];n.set(p,h),h+=p.length}const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGB_INTEGER,e.UNSIGNED_INT,n,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,l,s,o)}generateTextureForPositions(e,t,i){const s=i/3,o=4096,a=Math.ceil(s/o);if(a===0)throw"texture height===0";const n=o*a*3,l=new Uint16Array(n);ft.sizeDataTexturePositions+=l.byteLength,ft.numberOfTextures++;for(let h=0,d=0,p=t.length;h<p;h++){const m=t[h];l.set(m,d),d+=m.length}const c=e.createTexture();return e.bindTexture(e.TEXTURE_2D,c),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,o,a),e.texSubImage2D(e.TEXTURE_2D,0,0,0,o,a,e.RGB_INTEGER,e.UNSIGNED_SHORT,l,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,c,o,a)}generateTextureForPackedPortionIds(e,t){if(t.length===0)return{texture:null,textureHeight:0};const i=t.length,s=4096,o=Math.ceil(i/s);if(o===0)throw"texture height===0";const a=s*o,n=new Uint16Array(a);n.set(t,0),ft.sizeDataTexturePortionIds+=n.byteLength,ft.numberOfTextures++;const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.R16UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RED_INTEGER,e.UNSIGNED_SHORT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,l,s,o)}}const By=new uc,Iu=65536,Cn=By.maxDataTextureHeight,El=8,Zr=10,Il=new Float32Array(16),Yt=new Uint8Array(4),qr=new Float32Array(3);let wy=0;const Cy=A.identityMat4();class My{constructor(e,t){ft.numberOfLayers++,this._layerNumber=wy++,this.sortId=`TriDTX-${this._layerNumber}`,this.layerIndex=t.layerIndex,this._renderers=Py(e.scene),this.model=e,this._buffer=new xy,this._dataTextureState=new yy,this._dataTextureGenerator=new by,this._state=new Mt({origin:A.vec3(t.origin),textureState:this._dataTextureState,numIndices8Bits:0,numIndices16Bits:0,numIndices32Bits:0,numVertices:0}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._subPortions=[],this._portionToSubPortionsMap=[],this._bucketGeometries={},this._meshes=[],this._aabb=A.collapseAABB3(),this.aabbDirty=!0,this._numUpdatesInFrame=0,this.primitive=t.primitive,this._finalized=!1}get aabb(){if(this.aabbDirty){A.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)A.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e){if(this._finalized)throw"Already finalized";const t=e.buckets.length;this._numPortions+t>Iu&&ft.cannotCreatePortion.because10BitsObjectId++;let i=this._numPortions+t<=Iu;const s=0,o=e.geometryId!==void 0&&e.geometryId!==null?`${e.geometryId}#${s}`:`${e.id}#${s}`;if(!this._bucketGeometries[o]){const n=Math.max(this._state.numIndices8Bits,this._state.numIndices16Bits,this._state.numIndices32Bits);let l=0,c=0;e.buckets.forEach(h=>{l+=h.positionsCompressed.length/3,c+=h.indices.length/2}),(this._state.numVertices+l>Cn*4096||n+c>Cn*4096)&&ft.cannotCreatePortion.becauseTextureSize++,i&&(i=this._state.numVertices+l<=Cn*4096&&n+c<=Cn*4096)}return i}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=[];t.buckets.forEach((o,a)=>{const n=t.geometryId!==void 0&&t.geometryId!==null?`${t.geometryId}#${a}`:`${t.id}#${a}`;let l=this._bucketGeometries[n];l||(l=this._createBucketGeometry(t,o),this._bucketGeometries[n]=l);const c=this._createSubPortion(t,l,o);i.push(c)});const s=this._portionToSubPortionsMap.length;return this._portionToSubPortionsMap.push(i),this.model.numPortions++,this._meshes.push(e),s}_createBucketGeometry(e,t){if(t.indices){const d=Math.ceil(t.indices.length/2/El)*El*2;ft.overheadSizeAlignementIndices+=2*(d-t.indices.length);const p=new Uint32Array(d);p.fill(0),p.set(t.indices),t.indices=p}const i=t.positionsCompressed,s=t.indices,o=this._buffer;o.positionsCompressed.push(i);const a=o.lenPositionsCompressed/3,n=i.length/3;o.lenPositionsCompressed+=i.length;let l,c=0;if(s){c=s.length/2;let d;n<=256?(d=o.indices8Bits,l=o.lenIndices8Bits/2,o.lenIndices8Bits+=s.length):n<=65536?(d=o.indices16Bits,l=o.lenIndices16Bits/2,o.lenIndices16Bits+=s.length):(d=o.indices32Bits,l=o.lenIndices32Bits/2,o.lenIndices32Bits+=s.length),d.push(s)}return this._state.numVertices+=n,ft.numberOfGeometries++,{vertexBase:a,numVertices:n,numLines:c,indicesBase:l}}_createSubPortion(e,t){const i=e.color,s=e.colors,o=e.opacity,a=e.meshMatrix,n=e.pickColor,l=this._buffer,c=this._state;l.perObjectPositionsDecodeMatrices.push(e.positionsDecodeMatrix),l.perObjectInstancePositioningMatrices.push(a||Cy),l.perObjectSolid.push(!!e.solid),s?l.perObjectColors.push([s[0]*255,s[1]*255,s[2]*255,255]):i&&l.perObjectColors.push([i[0],i[1],i[2],o]),l.perObjectPickColors.push(n),l.perObjectVertexBases.push(t.vertexBase);{let d;t.numVertices<=256?d=c.numIndices8Bits:t.numVertices<=65536?d=c.numIndices16Bits:d=c.numIndices32Bits,l.perObjectIndexBaseOffsets.push(d/2-t.indicesBase)}const h=this._subPortions.length;if(t.numLines>0){let d=t.numLines*2,p;t.numVertices<=256?(p=l.perLineNumberPortionId8Bits,c.numIndices8Bits+=d,ft.totalLines8Bits+=t.numLines):t.numVertices<=65536?(p=l.perLineNumberPortionId16Bits,c.numIndices16Bits+=d,ft.totalLines16Bits+=t.numLines):(p=l.perLineNumberPortionId32Bits,c.numIndices32Bits+=d,ft.totalLines32Bits+=t.numLines),ft.totalLines+=t.numLines;for(let m=0;m<t.numLines;m+=El)p.push(h)}return this._subPortions.push({numVertices:t.numLines}),this._numPortions++,ft.numberOfPortions++,h}finalize(){if(this._finalized)return;const e=this._state,t=this._dataTextureState,i=this.model.scene.canvas.gl,s=this._buffer;e.gl=i,t.texturePerObjectColorsAndFlags=this._dataTextureGenerator.generateTextureForColorsAndFlags(i,s.perObjectColors,s.perObjectPickColors,s.perObjectVertexBases,s.perObjectIndexBaseOffsets,s.perObjectSolid),t.texturePerObjectInstanceMatrices=this._dataTextureGenerator.generateTextureForInstancingMatrices(i,s.perObjectInstancePositioningMatrices),t.texturePerObjectPositionsDecodeMatrix=this._dataTextureGenerator.generateTextureForPositionsDecodeMatrices(i,s.perObjectPositionsDecodeMatrices),t.texturePerVertexIdCoordinates=this._dataTextureGenerator.generateTextureForPositions(i,s.positionsCompressed,s.lenPositionsCompressed),t.texturePerLineIdPortionIds8Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perLineNumberPortionId8Bits),t.texturePerLineIdPortionIds16Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perLineNumberPortionId16Bits),t.texturePerLineIdPortionIds32Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perLineNumberPortionId32Bits),s.lenIndices8Bits>0&&(t.texturePerLineIdIndices8Bits=this._dataTextureGenerator.generateTextureFor8BitIndices(i,s.indices8Bits,s.lenIndices8Bits)),s.lenIndices16Bits>0&&(t.texturePerLineIdIndices16Bits=this._dataTextureGenerator.generateTextureFor16BitIndices(i,s.indices16Bits,s.lenIndices16Bits)),s.lenIndices32Bits>0&&(t.texturePerLineIdIndices32Bits=this._dataTextureGenerator.generateTextureFor32BitIndices(i,s.indices32Bits,s.lenIndices32Bits)),t.finalize(),this._buffer=null,this._bucketGeometries={},this._finalized=!0,this._deferredSetFlagsDirty=!1,this._onSceneRendering=this.model.scene.on("rendering",()=>{this._deferredSetFlagsDirty&&this._uploadDeferredFlags(),this._numUpdatesInFrame=0})}initFlags(e,t,i){t&N.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&N.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&N.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&N.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&N.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&N.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);const s=!0;this._setFlags(e,t,i,s),this._setFlags2(e,t,s)}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&N.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&N.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&N.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&N.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&N.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}_beginDeferredFlags(){this._deferredSetFlagsActive=!0}_uploadDeferredFlags(){if(this._deferredSetFlagsActive=!1,!this._deferredSetFlagsDirty)return;this._deferredSetFlagsDirty=!1;const e=this.model.scene.canvas.gl,t=this._dataTextureState;e.bindTexture(e.TEXTURE_2D,t.texturePerObjectColorsAndFlags._texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.texturePerObjectColorsAndFlags._textureWidth,t.texturePerObjectColorsAndFlags._textureHeight,e.RGBA_INTEGER,e.UNSIGNED_BYTE,t.texturePerObjectColorsAndFlags._textureData)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&N.CULLED?(this._numCulledLayerPortions+=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions-=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&N.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){const i=this._portionToSubPortionsMap[e];for(let s=0,o=i.length;s<o;s++)this._subPortionSetColor(i[s],t)}_subPortionSetColor(e,t){if(!this._finalized)throw"Not finalized";const i=this._dataTextureState,s=this.model.scene.canvas.gl;if(Yt[0]=t[0],Yt[1]=t[1],Yt[2]=t[2],Yt[3]=t[3],i.texturePerObjectColorsAndFlags._textureData.set(Yt,e*32),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Zr&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectColorsAndFlags._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*8,Math.floor(e/512),1,1,s.RGBA_INTEGER,s.UNSIGNED_BYTE,Yt)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){const o=this._portionToSubPortionsMap[e];for(let a=0,n=o.length;a<n;a++)this._subPortionSetFlags(o[a],t,i,s)}_subPortionSetFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const o=!!(t&N.VISIBLE),a=!!(t&N.XRAYED),n=!!(t&N.HIGHLIGHTED),l=!!(t&N.SELECTED),c=!!(t&N.PICKABLE),h=!!(t&N.CULLED);let d;!o||h||a?d=O.NOT_RENDERED:i?d=O.COLOR_TRANSPARENT:d=O.COLOR_OPAQUE;let p;!o||h?p=O.NOT_RENDERED:l?p=O.SILHOUETTE_SELECTED:n?p=O.SILHOUETTE_HIGHLIGHTED:a?p=O.SILHOUETTE_XRAYED:p=O.NOT_RENDERED;let m=o&&!h&&c?O.PICK:O.NOT_RENDERED;const g=this._dataTextureState,u=this.model.scene.canvas.gl;if(Yt[0]=d,Yt[1]=p,Yt[3]=m,g.texturePerObjectColorsAndFlags._textureData.set(Yt,e*32+8),this._deferredSetFlagsActive||s){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Zr&&this._beginDeferredFlags(),u.bindTexture(u.TEXTURE_2D,g.texturePerObjectColorsAndFlags._texture),u.texSubImage2D(u.TEXTURE_2D,0,e%512*8+2,Math.floor(e/512),1,1,u.RGBA_INTEGER,u.UNSIGNED_BYTE,Yt)}_setDeferredFlags(){}_setFlags2(e,t,i=!1){const s=this._portionToSubPortionsMap[e];for(let o=0,a=s.length;o<a;o++)this._subPortionSetFlags2(s[o],t,i)}_subPortionSetFlags2(e,t,i=!1){if(!this._finalized)throw"Not finalized";const s=t&N.CLIPPABLE?255:0,o=this._dataTextureState,a=this.model.scene.canvas.gl;if(Yt[0]=s,Yt[1]=0,Yt[2]=1,Yt[3]=2,o.texturePerObjectColorsAndFlags._textureData.set(Yt,e*32+12),this._deferredSetFlagsActive||i){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Zr&&this._beginDeferredFlags(),a.bindTexture(a.TEXTURE_2D,o.texturePerObjectColorsAndFlags._texture),a.texSubImage2D(a.TEXTURE_2D,0,e%512*8+3,Math.floor(e/512),1,1,a.RGBA_INTEGER,a.UNSIGNED_BYTE,Yt)}_setDeferredFlags2(){}setOffset(e,t){const i=this._portionToSubPortionsMap[e];for(let s=0,o=i.length;s<o;s++)this._subPortionSetOffset(i[s],t)}_subPortionSetOffset(e,t){if(!this._finalized)throw"Not finalized";const i=this._dataTextureState,s=this.model.scene.canvas.gl;if(qr[0]=t[0],qr[1]=t[1],qr[2]=t[2],i.texturePerObjectOffsets._textureData.set(qr,e*3),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Zr&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectOffsets._texture),s.texSubImage2D(s.TEXTURE_2D,0,0,e,1,1,s.RGB,s.FLOAT,qr)}setMatrix(e,t){const i=this._portionToSubPortionsMap[e];for(let s=0,o=i.length;s<o;s++)this._subPortionSetMatrix(i[s],t)}_subPortionSetMatrix(e,t){if(!this._finalized)throw"Not finalized";const i=this._dataTextureState,s=this.model.scene.canvas.gl;if(Il.set(t),i.texturePerObjectInstanceMatrices._textureData.set(Il,e*16),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=Zr&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectInstanceMatrices._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*4,Math.floor(e/512),4,1,s.RGBA,s.FLOAT,Il)}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){}drawSilhouetteHighlighted(e,t){}drawSilhouetteSelected(e,t){}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawOcclusion(e,t){}drawShadow(e,t){}setPickMatrices(e,t){}drawPickMesh(e,t){}drawPickDepths(e,t){}drawSnapInit(e,t){}drawSnap(e,t){}drawPickNormals(e,t){}destroy(){if(this._destroyed)return;const e=this._state;this.model.scene.off(this._onSceneRendering),e.destroy(),this._destroyed=!0}}const Fu=A.vec3(),Ey=A.vec3(),Iy=A.vec3();A.vec3();const Jr=A.vec4(),Fy=A.mat4();class Su{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=this._scene,o=s.camera,a=t.model,n=s.canvas.gl,l=t._state,c=l.textureState,h=t._state.origin,{position:d,rotationMatrix:p}=a;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,l)),c.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let m,g;const u=h[0]!==0||h[1]!==0||h[2]!==0,x=d[0]!==0||d[1]!==0||d[2]!==0;if(u||x){const _=Fu;if(u){const b=A.transformPoint3(p,h,Ey);_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=d[0],_[1]+=d[1],_[2]+=d[2],m=Pt(o.viewMatrix,_,Fy),g=Iy,g[0]=o.eye[0]-_[0],g[1]=o.eye[1]-_[1],g[2]=o.eye[2]-_[2]}else m=o.viewMatrix,g=o.eye;if(n.uniformMatrix4fv(this._uSceneModelMatrix,!1,p),n.uniformMatrix4fv(this._uViewMatrix,!1,m),n.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),n.uniform3fv(this._uCameraEyeRtc,g),n.uniform1i(this._uRenderPass,i),s.logarithmicDepthBufferEnabled){const _=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,_)}const y=s._sectionPlanesState.getNumAllocatedSectionPlanes(),P=s._sectionPlanesState.sectionPlanes.length;if(y>0){const _=s._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,B=a.renderFlags;for(let w=0;w<y;w++){const C=this._uSectionPlanes[w];if(C)if(w<P){const E=B.sectionPlanesActivePerLayer[b+w];if(n.uniform1i(C.active,E?1:0),E){const I=_[w];if(h){const R=kt(I.dist,I.dir,h,Fu,a.matrix);n.uniform3fv(C.pos,R)}else n.uniform3fv(C.pos,I.pos);n.uniform3fv(C.dir,I.dir)}}else n.uniform1i(C.active,0)}}l.numIndices8Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,l.numIndices8Bits)),l.numIndices16Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,l.numIndices16Bits)),l.numIndices32Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,l.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors,console.error(this.errors);return}const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const o=i.lights;let a;for(let n=0,l=o.length;n<l;n++)switch(a=o[n],a.type){case"dir":this._uLightColor[n]=s.getLocation("lightColor"+n),this._uLightPos[n]=null,this._uLightDir[n]=s.getLocation("lightDir"+n);break;case"point":this._uLightColor[n]=s.getLocation("lightColor"+n),this._uLightPos[n]=s.getLocation("lightPos"+n),this._uLightDir[n]=null,this._uLightAttenuation[n]=s.getLocation("lightAttenuation"+n);break;case"spot":this._uLightColor[n]=s.getLocation("lightColor"+n),this._uLightPos[n]=s.getLocation("lightPos"+n),this._uLightDir[n]=s.getLocation("lightDir"+n),this._uLightAttenuation[n]=s.getLocation("lightAttenuation"+n);break}this._uSceneModelMatrix=s.getLocation("sceneModelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let n=0,l=e._sectionPlanesState.getNumAllocatedSectionPlanes();n<l;n++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+n),pos:s.getLocation("sectionPlanePos"+n),dir:s.getLocation("sectionPlaneDir"+n)});this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=s.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,o=t._lightsState.lights,a=t.camera.project;s.bind(),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let n=0,l=o.length;n<l;n++){const c=o[n];this._uLightColor[n]&&i.uniform4f(this._uLightColor[n],c.color[0],c.color[1],c.color[2],c.intensity),this._uLightPos[n]&&(i.uniform3fv(this._uLightPos[n],c.pos),this._uLightAttenuation[n]&&i.uniform1f(this._uLightAttenuation[n],c.attenuation)),this._uLightDir[n]&&i.uniform3fv(this._uLightDir[n],c.dir)}if(this._withSAO){const n=t.sao;if(n.possible){const c=i.drawingBufferWidth,h=i.drawingBufferHeight;Jr[0]=c,Jr[1]=h,Jr[2]=n.blendCutoff,Jr[3]=n.blendFactor,i.uniform4fv(this._uSAOParams,Jr),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,10)}}if(t.logarithmicDepthBufferEnabled){const n=2/(Math.log(a.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,n)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0;let o;const a=[];a.push("#version 300 es"),a.push("// TrianglesDataTextureColorRenderer vertex shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("precision highp usampler2D;"),a.push("precision highp isampler2D;"),a.push("precision highp sampler2D;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("precision mediump usampler2D;"),a.push("precision mediump isampler2D;"),a.push("precision mediump sampler2D;"),a.push("#endif"),a.push("uniform int renderPass;"),a.push("uniform mat4 sceneModelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),a.push("uniform highp sampler2D uTexturePerObjectMatrix;"),a.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),a.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),a.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),a.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),a.push("uniform vec3 uCameraEyeRtc;"),a.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("out float isPerspective;")),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("uniform vec4 lightAmbient;");for(let n=0,l=i.lights.length;n<l;n++)o=i.lights[n],o.type!=="ambient"&&(a.push("uniform vec4 lightColor"+n+";"),o.type==="dir"&&a.push("uniform vec3 lightDir"+n+";"),o.type==="point"&&a.push("uniform vec3 lightPos"+n+";"),o.type==="spot"&&(a.push("uniform vec3 lightPos"+n+";"),a.push("uniform vec3 lightDir"+n+";")));s&&(a.push("out vec4 vWorldPosition;"),a.push("flat out uint vFlags2;")),a.push("out vec4 vColor;"),a.push("void main(void) {"),a.push("int polygonIndex = gl_VertexID / 3;"),a.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),a.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),a.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),a.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),a.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),a.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),a.push("if (int(flags.x) != renderPass) {"),a.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),a.push("   return;"),a.push("} else {"),a.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),a.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),a.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),a.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),a.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),a.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),a.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),a.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),a.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),a.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),a.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),a.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),a.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),a.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),a.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),a.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),a.push("if (color.a == 0u) {"),a.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),a.push("   return;"),a.push("};"),a.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),a.push("vec3 position;"),a.push("position = positions[gl_VertexID % 3];"),a.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),a.push("if (solid != 1u) {"),a.push("if (isPerspectiveMatrix(projMatrix)) {"),a.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),a.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),a.push("position = positions[2 - (gl_VertexID % 3)];"),a.push("viewNormal = -viewNormal;"),a.push("}"),a.push("} else {"),a.push("if (viewNormal.z < 0.0) {"),a.push("position = positions[2 - (gl_VertexID % 3)];"),a.push("viewNormal = -viewNormal;"),a.push("}"),a.push("}"),a.push("}"),a.push("vec4 worldPosition = sceneModelMatrix * ((objectDecodeAndInstanceMatrix * vec4(position, 1.0))); "),a.push("vec4 viewPosition = viewMatrix * worldPosition; "),a.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),a.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),a.push("float lambertian = 1.0;");for(let n=0,l=i.lights.length;n<l;n++)if(o=i.lights[n],o.type!=="ambient"){if(o.type==="dir")o.space==="view"?a.push("viewLightDir = normalize(lightDir"+n+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+n+", 0.0)).xyz);");else if(o.type==="point")o.space==="view"?a.push("viewLightDir = -normalize(lightPos"+n+" - viewPosition.xyz);"):a.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+n+", 0.0)).xyz);");else if(o.type==="spot")o.space==="view"?a.push("viewLightDir = normalize(lightDir"+n+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+n+", 0.0)).xyz);");else continue;a.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),a.push("reflectedColor += lambertian * (lightColor"+n+".rgb * lightColor"+n+".a);")}return a.push("vec3 rgb = vec3(color.rgb) / 255.0;"),a.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("vFragDepth = 1.0 + clipPos.w;"),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(a.push("vWorldPosition = worldPosition;"),a.push("vFlags2 = flags2.r;")),a.push("gl_Position = clipPos;"),a.push("}"),a.push("}"),a}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// TrianglesDataTextureColorRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let o=0,a=t.getNumAllocatedSectionPlanes();o<a;o++)s.push("if (sectionPlaneActive"+o+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),s.push("   outColor            = vec4(vColor.rgb * ambient, 1.0);")):s.push("   outColor            = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Sy=new Float32Array([1,1,1]),Tu=A.vec3(),Ty=A.vec3(),Dy=A.vec3();A.vec3();const Ry=A.mat4();class Du{constructor(e,t){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=this._scene,o=s.camera,a=t.model,n=s.canvas.gl,l=t._state,c=l.textureState,h=t._state.origin,{position:d,rotationMatrix:p}=a,m=o.viewMatrix;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,l)),c.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let g,u;if(h||d[0]!==0||d[1]!==0||d[2]!==0){const P=Tu;if(h){const _=Ty;A.transformPoint3(p,h,_),P[0]=_[0],P[1]=_[1],P[2]=_[2]}else P[0]=0,P[1]=0,P[2]=0;P[0]+=d[0],P[1]+=d[1],P[2]+=d[2],g=Pt(m,P,Ry),u=Dy,u[0]=o.eye[0]-P[0],u[1]=o.eye[1]-P[1],u[2]=o.eye[2]-P[2]}else g=m,u=o.eye;if(n.uniform3fv(this._uCameraEyeRtc,u),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uWorldMatrix,!1,p),n.uniformMatrix4fv(this._uViewMatrix,!1,g),n.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),i===O.SILHOUETTE_XRAYED){const P=s.xrayMaterial._state,_=P.fillColor,b=P.fillAlpha;n.uniform4f(this._uColor,_[0],_[1],_[2],b)}else if(i===O.SILHOUETTE_HIGHLIGHTED){const P=s.highlightMaterial._state,_=P.fillColor,b=P.fillAlpha;n.uniform4f(this._uColor,_[0],_[1],_[2],b)}else if(i===O.SILHOUETTE_SELECTED){const P=s.selectedMaterial._state,_=P.fillColor,b=P.fillAlpha;n.uniform4f(this._uColor,_[0],_[1],_[2],b)}else n.uniform4fv(this._uColor,Sy);if(s.logarithmicDepthBufferEnabled){const P=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,P)}const x=s._sectionPlanesState.getNumAllocatedSectionPlanes(),y=s._sectionPlanesState.sectionPlanes.length;if(x>0){const P=s._sectionPlanesState.sectionPlanes,_=t.layerIndex*y,b=a.renderFlags;for(let B=0;B<x;B++){const w=this._uSectionPlanes[B];if(w)if(B<y){const C=b.sectionPlanesActivePerLayer[_+B];if(n.uniform1i(w.active,C?1:0),C){const E=P[B];if(h){const I=kt(E.dist,E.dir,h,Tu,a.matrix);n.uniform3fv(w.pos,I)}else n.uniform3fv(w.pos,E.pos);n.uniform3fv(w.dir,E.dir)}}else n.uniform1i(w.active,0)}}l.numIndices8Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,l.numIndices8Bits)),l.numIndices16Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,l.numIndices16Bits)),l.numIndices32Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,l.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uWorldMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=t.camera.project;if(this._program.bind(),t.logarithmicDepthBufferEnabled){const o=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,o)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture silhouette vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("} else {"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix *  (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2.r;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture draw fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("uniform vec4 color;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { "),i.push("      discard;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    outColor = color;"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ly=new Float32Array([0,0,0,1]),Ru=A.vec3(),Uy=A.vec3();A.vec3();const Oy=A.mat4();class ky{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=l.textureState,h=t._state.origin,{position:d,rotationMatrix:p}=s,m=a.viewMatrix;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),c.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let g;const u=h[0]!==0||h[1]!==0||h[2]!==0,x=d[0]!==0||d[1]!==0||d[2]!==0;if(u||x){const _=Ru;if(u){const b=A.transformPoint3(p,h,Uy);_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=d[0],_[1]+=d[1],_[2]+=d[2],g=Pt(m,_,Oy)}else g=m;if(n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uSceneModelMatrix,!1,p),n.uniformMatrix4fv(this._uViewMatrix,!1,g),n.uniformMatrix4fv(this._uProjMatrix,!1,a.projMatrix),i===O.EDGES_XRAYED){const _=o.xrayMaterial._state,b=_.edgeColor,B=_.edgeAlpha;n.uniform4f(this._uColor,b[0],b[1],b[2],B)}else if(i===O.EDGES_HIGHLIGHTED){const _=o.highlightMaterial._state,b=_.edgeColor,B=_.edgeAlpha;n.uniform4f(this._uColor,b[0],b[1],b[2],B)}else if(i===O.EDGES_SELECTED){const _=o.selectedMaterial._state,b=_.edgeColor,B=_.edgeAlpha;n.uniform4f(this._uColor,b[0],b[1],b[2],B)}else n.uniform4fv(this._uColor,Ly);const y=o._sectionPlanesState.getNumAllocatedSectionPlanes(),P=o._sectionPlanesState.sectionPlanes.length;if(y>0){const _=o._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,B=s.renderFlags;for(let w=0;w<y;w++){const C=this._uSectionPlanes[w];if(C)if(w<P){const E=B.sectionPlanesActivePerLayer[b+w];if(n.uniform1i(C.active,E?1:0),E){const I=_[w];if(h){const R=kt(I.dist,I.dir,h,Ru,s.matrix);n.uniform3fv(C.pos,R)}else n.uniform3fv(C.pos,I.pos);n.uniform3fv(C.dir,I.dir)}}else n.uniform1i(C.active,0)}}l.numEdgeIndices8Bits>0&&(c.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),n.drawArrays(n.LINES,0,l.numEdgeIndices8Bits)),l.numEdgeIndices16Bits>0&&(c.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),n.drawArrays(n.LINES,0,l.numEdgeIndices16Bits)),l.numEdgeIndices32Bits>0&&(c.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),n.drawArrays(n.LINES,0,l.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix"}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e.camera.project;if(i.bind(),e.logarithmicDepthBufferEnabled){const o=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,o)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// DTXTrianglesEdgesRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),i.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("mat4 matrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// DTXTrianglesEdgesRenderer fragment shader"),e.logarithmicDepthBufferEnabled&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outColor            = vColor;"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Lu=A.vec3(),Ny=A.vec3(),Qy=A.mat4();class Vy{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=l.textureState,h=t._state.origin,{position:d,rotationMatrix:p}=s,m=a.viewMatrix;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),c.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let g;const u=h[0]!==0||h[1]!==0||h[2]!==0,x=d[0]!==0||d[1]!==0||d[2]!==0;if(u||x){const _=Lu;if(u){const b=A.transformPoint3(p,h,Ny);_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=d[0],_[1]+=d[1],_[2]+=d[2],g=Pt(m,_,Qy)}else g=m;n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uSceneModelMatrix,!1,p),n.uniformMatrix4fv(this._uViewMatrix,!1,g),n.uniformMatrix4fv(this._uProjMatrix,!1,a.projMatrix);const y=o._sectionPlanesState.getNumAllocatedSectionPlanes(),P=o._sectionPlanesState.sectionPlanes.length;if(y>0){const _=o._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,B=s.renderFlags;for(let w=0;w<y;w++){const C=this._uSectionPlanes[w];if(C)if(w<P){const E=B.sectionPlanesActivePerLayer[b+w];if(n.uniform1i(C.active,E?1:0),E){const I=_[w];if(h){const R=kt(I.dist,I.dir,h,Lu,s.matrix);n.uniform3fv(C.pos,R)}else n.uniform3fv(C.pos,I.pos);n.uniform3fv(C.dir,I.dir)}}else n.uniform1i(C.active,0)}}l.numEdgeIndices8Bits>0&&(c.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),n.drawArrays(n.LINES,0,l.numEdgeIndices8Bits)),l.numEdgeIndices16Bits>0&&(c.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),n.drawArrays(n.LINES,0,l.numEdgeIndices16Bits)),l.numEdgeIndices32Bits>0&&(c.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),n.drawArrays(n.LINES,0,l.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix"}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e.camera.project;if(i.bind(),e.logarithmicDepthBufferEnabled){const o=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,o)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// TrianglesDataTextureEdgesColorRenderer"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled,i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform highp sampler2D uObjectPerObjectOffsets;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vec4 rgb = vec4(color.rgba);"),i.push("vColor = vec4(float(rgb.r*0.5) / 255.0, float(rgb.g*0.5) / 255.0, float(rgb.b*0.5) / 255.0, float(rgb.a) / 255.0);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// TrianglesDataTextureEdgesColorRenderer"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { discard; }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outColor            = vColor;"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Uu=A.vec3(),Hy=A.vec3(),jy=A.vec3(),zy=A.mat4();class Ou{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e));const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=l.textureState,h=t._state.origin,{position:d,rotationMatrix:p}=s,m=e.pickViewMatrix||a.viewMatrix,g=e.pickProjMatrix||a.projMatrix,u=e.pickOrigin||a.eye,x=e.pickProjMatrix?e.pickZFar:a.project.far;c.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let y,P;const _=h[0]!==0||h[1]!==0||h[2]!==0,b=d[0]!==0||d[1]!==0||d[2]!==0;if(_||b){const C=Uu;if(_){const E=A.transformPoint3(p,h,Hy);C[0]=E[0],C[1]=E[1],C[2]=E[2]}else C[0]=0,C[1]=0,C[2]=0;C[0]+=d[0],C[1]+=d[1],C[2]+=d[2],y=Pt(m,C,zy),P=jy,P[0]=u[0]-C[0],P[1]=u[1]-C[1],P[2]=u[2]-C[2]}else y=m,P=u;if(n.uniform2fv(this._uPickClipPos,e.pickClipPos),n.uniform2f(this._uDrawingBufferSize,n.drawingBufferWidth,n.drawingBufferHeight),n.uniformMatrix4fv(this._uSceneModelMatrix,!1,p),n.uniformMatrix4fv(this._uViewMatrix,!1,y),n.uniformMatrix4fv(this._uProjMatrix,!1,g),n.uniform3fv(this._uCameraEyeRtc,P),n.uniform1i(this._uRenderPass,i),o.logarithmicDepthBufferEnabled){const C=2/(Math.log(x+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,C)}const B=o._sectionPlanesState.getNumAllocatedSectionPlanes(),w=o._sectionPlanesState.sectionPlanes.length;if(B>0){const C=o._sectionPlanesState.sectionPlanes,E=t.layerIndex*w,I=s.renderFlags;for(let R=0;R<B;R++){const F=this._uSectionPlanes[R];if(F)if(R<w){const z=I.sectionPlanesActivePerLayer[E+R];if(n.uniform1i(F.active,z?1:0),z){const Q=C[R];if(h){const H=kt(Q.dist,Q.dir,h,Uu,s.matrix);n.uniform3fv(F.pos,H)}else n.uniform3fv(F.pos,Q.pos);n.uniform3fv(F.dir,Q.dir)}}else n.uniform1i(F.active,0)}}l.numIndices8Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,l.numIndices8Bits)),l.numIndices16Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,l.numIndices16Bits)),l.numIndices32Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,l.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uDrawingBufferSize=i.getLocation("drawingBufferSize"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const i=this._scene.canvas.gl;this._program.bind(),i.uniform1i(this._uPickInvisible,e.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry picking vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform bool pickInvisible;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("uniform vec2 pickClipPos;"),i.push("uniform vec2 drawingBufferSize;"),i.push("vec4 remapClipPos(vec4 clipPos) {"),i.push("    clipPos.xy /= clipPos.w;"),i.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),i.push("    clipPos.xy *= clipPos.w;"),i.push("    return clipPos;"),i.push("}"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("smooth out vec4 vWorldPosition;"),i.push("flat out uvec4 vFlags2;")),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("vPickColor = vec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0)) / 255.0;"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry picking fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uvec4 vFlags2;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("in vec4 vPickColor;"),i.push("out vec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outPickColor = vPickColor; "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ku=A.vec3(),Gy=A.vec3(),Wy=A.vec3();A.vec3();const Ky=A.mat4();class Nu{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=l.textureState,h=t._state.origin,{position:d,rotationMatrix:p}=s,m=e.pickViewMatrix||a.viewMatrix,g=e.pickProjMatrix||a.projMatrix,u=e.pickOrigin||a.eye,x=e.pickProjMatrix?e.pickZFar:a.project.far;this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),c.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let y,P;if(h||d[0]!==0||d[1]!==0||d[2]!==0){const B=ku;if(h){const w=Gy;A.transformPoint3(p,h,w),B[0]=w[0],B[1]=w[1],B[2]=w[2]}else B[0]=0,B[1]=0,B[2]=0;B[0]+=d[0],B[1]+=d[1],B[2]+=d[2],y=Pt(m,B,Ky),P=Wy,P[0]=u[0]-B[0],P[1]=u[1]-B[1],P[2]=u[2]-B[2],e.snapPickOrigin[0]=B[0],e.snapPickOrigin[1]=B[1],e.snapPickOrigin[2]=B[2]}else y=m,P=u,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;if(n.uniform3fv(this._uCameraEyeRtc,P),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniform2fv(this._uPickClipPos,e.pickClipPos),n.uniform2f(this._uDrawingBufferSize,n.drawingBufferWidth,n.drawingBufferHeight),n.uniform1f(this._uPickZNear,e.pickZNear),n.uniform1f(this._uPickZFar,e.pickZFar),n.uniformMatrix4fv(this._uSceneModelMatrix,!1,p),n.uniformMatrix4fv(this._uViewMatrix,!1,y),n.uniformMatrix4fv(this._uProjMatrix,!1,g),o.logarithmicDepthBufferEnabled){const B=2/(Math.log(x+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,B)}const _=o._sectionPlanesState.getNumAllocatedSectionPlanes(),b=o._sectionPlanesState.sectionPlanes.length;if(_>0){const B=o._sectionPlanesState.sectionPlanes,w=t.layerIndex*b,C=s.renderFlags;for(let E=0;E<_;E++){const I=this._uSectionPlanes[E];if(I)if(E<b){const R=C.sectionPlanesActivePerLayer[w+E];if(n.uniform1i(I.active,R?1:0),R){const F=B[E];if(h){const z=kt(F.dist,F.dir,h,ku,s.matrix);n.uniform3fv(I.pos,z)}else n.uniform3fv(I.pos,F.pos);n.uniform3fv(I.dir,F.dir)}}else n.uniform1i(I.active,0)}}l.numIndices8Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,l.numIndices8Bits)),l.numIndices16Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,l.numIndices16Bits)),l.numIndices32Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,l.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uDrawingBufferSize=i.getLocation("drawingBufferSize"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture pick depth vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform bool pickInvisible;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("uniform vec2 pickClipPos;"),i.push("uniform vec2 drawingBufferSize;"),i.push("vec4 remapClipPos(vec4 clipPos) {"),i.push("    clipPos.xy /= clipPos.w;"),i.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),i.push("    clipPos.xy *= clipPos.w;"),i.push("    return clipPos;"),i.push("}"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2.r;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("uniform float pickZNear;"),i.push("uniform float pickZFar;"),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("in vec4 vViewPosition;"),i.push("vec4 packDepth(const in float depth) {"),i.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),i.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),i.push("  vec4 res = fract(depth * bitShift);"),i.push("  res -= res.xxyz * bitMask;"),i.push("  return res;"),i.push("}"),i.push("out vec4 outPackedDepth;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),i.push("    outPackedDepth = packDepth(zNormalizedDepth); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Qu=A.vec3(),Xy=A.vec3(),Yy=A.vec3(),$y=A.vec3();A.vec3();const Zy=A.mat4();class Fl{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=l.textureState,h=t._state.origin,{position:d,rotationMatrix:p}=s,m=t.aabb,g=e.pickViewMatrix||a.viewMatrix,u=Qu;u[0]=A.safeInv(m[3]-m[0])*A.MAX_INT,u[1]=A.safeInv(m[4]-m[1])*A.MAX_INT,u[2]=A.safeInv(m[5]-m[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(u[0]),e.snapPickCoordinateScale[1]=A.safeInv(u[1]),e.snapPickCoordinateScale[2]=A.safeInv(u[2]),c.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let x,y;const P=h[0]!==0||h[1]!==0||h[2]!==0,_=d[0]!==0||d[1]!==0||d[2]!==0;if(P||_){const C=Xy;if(P){const E=A.transformPoint3(p,h,Yy);C[0]=E[0],C[1]=E[1],C[2]=E[2]}else C[0]=0,C[1]=0,C[2]=0;C[0]+=d[0],C[1]+=d[1],C[2]+=d[2],x=Pt(g,C,Zy),y=$y,y[0]=a.eye[0]-C[0],y[1]=a.eye[1]-C[1],y[2]=a.eye[2]-C[2],e.snapPickOrigin[0]=C[0],e.snapPickOrigin[1]=C[1],e.snapPickOrigin[2]=C[2]}else x=g,y=a.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,y),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,u),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniformMatrix4fv(this._uSceneModelMatrix,!1,p),n.uniformMatrix4fv(this._uViewMatrix,!1,x),n.uniformMatrix4fv(this._uProjMatrix,!1,a.projMatrix);{const C=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,C)}const b=o._sectionPlanesState.getNumAllocatedSectionPlanes(),B=o._sectionPlanesState.sectionPlanes.length;if(b>0){const C=o._sectionPlanesState.sectionPlanes,E=t.layerIndex*B,I=s.renderFlags;for(let R=0;R<b;R++){const F=this._uSectionPlanes[R];if(F)if(R<B){const z=I.sectionPlanesActivePerLayer[E+R];if(n.uniform1i(F.active,z?1:0),z){const Q=C[R];if(h){const H=kt(Q.dist,Q.dir,h,Qu,s.matrix);n.uniform3fv(F.pos,H)}else n.uniform3fv(F.pos,Q.pos);n.uniform3fv(F.dir,Q.dir)}}else n.uniform1i(F.active,0)}}const w=e.snapMode==="edge"?n.LINES:n.POINTS;l.numEdgeIndices8Bits>0&&(c.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),n.drawArrays(w,0,l.numEdgeIndices8Bits)),l.numEdgeIndices16Bits>0&&(c.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),n.drawArrays(w,0,l.numEdgeIndices16Bits)),l.numEdgeIndices32Bits>0&&(c.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),n.drawArrays(w,0,l.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});this._uLogDepthBufFC=i.getLocation("logDepthBufFC"),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTextureModelMatrices="uTextureModelMatrices",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc"),this.uVectorA=i.getLocation("uSnapVectorA"),this.uInverseVectorAB=i.getLocation("uSnapInvVectorAB"),this._uLayerNumber=i.getLocation("uLayerNumber"),this._uCoordinateScaler=i.getLocation("uCoordinateScaler")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry edges drawing vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 uSnapVectorA;"),i.push("uniform vec2 uSnapInvVectorAB;"),i.push("vec3 positions[3];"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - uSnapVectorA.x) * uSnapInvVectorAB.x;"),i.push("    float y = (clipPos.y - uSnapVectorA.y) * uSnapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("}"),i.push("{"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vViewPosition = clipPos;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int uLayerNumber;"),i.push("uniform vec3 uCoordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let o=0,a=e._sectionPlanesState.getNumAllocatedSectionPlanes();o<a;o++)i.push("uniform bool sectionPlaneActive"+o+";"),i.push("uniform vec3 sectionPlanePos"+o+";"),i.push("uniform vec3 sectionPlaneDir"+o+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz * uCoordinateScaler.xyz, uLayerNumber);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Vu=A.vec3(),qy=A.vec3(),Jy=A.vec3(),eb=A.vec3();A.vec3();const tb=A.mat4();class Hu{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=l.textureState,h=t._state.origin,{position:d,rotationMatrix:p}=s,m=t.aabb,g=e.pickViewMatrix||a.viewMatrix,u=Vu;u[0]=A.safeInv(m[3]-m[0])*A.MAX_INT,u[1]=A.safeInv(m[4]-m[1])*A.MAX_INT,u[2]=A.safeInv(m[5]-m[2])*A.MAX_INT,e.snapPickCoordinateScale[0]=A.safeInv(u[0]),e.snapPickCoordinateScale[1]=A.safeInv(u[1]),e.snapPickCoordinateScale[2]=A.safeInv(u[2]),c.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let x,y;const P=h[0]!==0||h[1]!==0||h[2]!==0,_=d[0]!==0||d[1]!==0||d[2]!==0;if(P||_){const w=qy;if(P){const C=Jy;A.transformPoint3(p,h,C),w[0]=C[0],w[1]=C[1],w[2]=C[2]}else w[0]=0,w[1]=0,w[2]=0;w[0]+=d[0],w[1]+=d[1],w[2]+=d[2],x=Pt(g,w,tb),y=eb,y[0]=a.eye[0]-w[0],y[1]=a.eye[1]-w[1],y[2]=a.eye[2]-w[2],e.snapPickOrigin[0]=w[0],e.snapPickOrigin[1]=w[1],e.snapPickOrigin[2]=w[2]}else x=g,y=a.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,y),n.uniform2fv(this._uVectorA,e.snapVectorA),n.uniform2fv(this._uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,u),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniformMatrix4fv(this._uSceneWorldModelMatrix,!1,p),n.uniformMatrix4fv(this._uViewMatrix,!1,x),n.uniformMatrix4fv(this._uProjMatrix,!1,a.projMatrix);{const w=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,w)}const b=o._sectionPlanesState.getNumAllocatedSectionPlanes(),B=o._sectionPlanesState.sectionPlanes.length;if(b>0){const w=o._sectionPlanesState.sectionPlanes,C=t.layerIndex*B,E=s.renderFlags;for(let I=0;I<b;I++){const R=this._uSectionPlanes[I];if(R)if(I<B){const F=E.sectionPlanesActivePerLayer[C+I];if(n.uniform1i(R.active,F?1:0),F){const z=w[I];if(h){const Q=kt(z.dist,z.dir,h,Vu,s.matrix);n.uniform3fv(R.pos,Q)}else n.uniform3fv(R.pos,z.pos);n.uniform3fv(R.dir,z.dir)}}else n.uniform1i(R.active,0)}}l.numIndices8Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,l.numIndices8Bits)),l.numIndices16Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,l.numIndices16Bits)),l.numIndices32Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,l.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uSceneWorldModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});this._uLogDepthBufFC=i.getLocation("logDepthBufFC"),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc"),this._uVectorA=i.getLocation("uVectorAB"),this._uInverseVectorAB=i.getLocation("uInverseVectorAB"),this._uLayerNumber=i.getLocation("uLayerNumber"),this._uCoordinateScaler=i.getLocation("uCoordinateScaler")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// DTXTrianglesSnapInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 uVectorAB;"),i.push("uniform vec2 uInverseVectorAB;"),i.push("vec3 positions[3];"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - uVectorAB.x) * uInverseVectorAB.x;"),i.push("    float y = (clipPos.y - uVectorAB.y) * uInverseVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("flat out uint vFlags2;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("}"),i.push("{"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("  if (isPerspectiveMatrix(projMatrix)) {"),i.push("      vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("      if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("          viewNormal = -viewNormal;"),i.push("      }"),i.push("  } else {"),i.push("      if (viewNormal.z < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("          viewNormal = -viewNormal;"),i.push("      }"),i.push("  }"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vWorldPosition = worldPosition;"),t&&i.push("vFlags2 = flags2.r;"),i.push("vPickColor = vec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0));"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// DTXTrianglesSnapInitRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int uLayerNumber;"),i.push("uniform vec3 uCoordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("flat in uint vFlags2;");for(let o=0,a=e._sectionPlanesState.getNumAllocatedSectionPlanes();o<a;o++)i.push("uniform bool sectionPlaneActive"+o+";"),i.push("uniform vec3 sectionPlanePos"+o+";"),i.push("uniform vec3 sectionPlaneDir"+o+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz * uCoordinateScaler.xyz, - uLayerNumber);"),i.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push(`outNormal = ivec4(worldNormal * float(${A.MAX_INT}), 1.0);`),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ju=A.vec3(),ib=A.vec3(),sb=A.vec3();A.vec3();const rb=A.mat4();class ob{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=l.textureState,h=t._state.origin,{position:d,rotationMatrix:p}=s,m=e.pickViewMatrix||a.viewMatrix;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),c.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let g,u;if(h||d[0]!==0||d[1]!==0||d[2]!==0){const P=ju;if(h){const _=ib;A.transformPoint3(p,h,_),P[0]=_[0],P[1]=_[1],P[2]=_[2]}else P[0]=0,P[1]=0,P[2]=0;P[0]+=d[0],P[1]+=d[1],P[2]+=d[2],g=Pt(m,P,rb),u=sb,u[0]=a.eye[0]-P[0],u[1]=a.eye[1]-P[1],u[2]=a.eye[2]-P[2]}else g=m,u=a.eye;n.uniform3fv(this._uCameraEyeRtc,u),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uWorldMatrix,!1,p),n.uniformMatrix4fv(this._uViewMatrix,!1,g),n.uniformMatrix4fv(this._uProjMatrix,!1,a.projMatrix);const x=o._sectionPlanesState.getNumAllocatedSectionPlanes(),y=o._sectionPlanesState.sectionPlanes.length;if(x>0){const P=o._sectionPlanesState.sectionPlanes,_=t.layerIndex*y,b=s.renderFlags;for(let B=0;B<x;B++){const w=this._uSectionPlanes[B];if(w)if(B<y){const C=b.sectionPlanesActivePerLayer[_+B];if(n.uniform1i(w.active,C?1:0),C){const E=P[B];if(h){const I=kt(E.dist,E.dir,h,ju,s.matrix);n.uniform3fv(w.pos,I)}else n.uniform3fv(w.pos,E.pos);n.uniform3fv(w.dir,E.dir)}}else n.uniform1i(w.active,0)}}l.numIndices8Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,l.numIndices8Bits)),l.numIndices16Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,l.numIndices16Bits)),l.numIndices32Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,l.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uWorldMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(){const e=this._scene;e.canvas.gl,e.camera.project,this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// TrianglesDataTextureOcclusionRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("  if (isPerspectiveMatrix(projMatrix)) {"),i.push("      vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("      if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("      }"),i.push("  } else {"),i.push("      vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("      if (viewNormal.z < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("      }"),i.push("  }"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix *  (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2.r;")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// TrianglesDataTextureColorRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("uniform bool sectionPlaneActive"+o+";"),s.push("uniform vec3 sectionPlanePos"+o+";"),s.push("uniform vec3 sectionPlaneDir"+o+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let o=0;o<t.getNumAllocatedSectionPlanes();o++)s.push("      if (sectionPlaneActive"+o+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const zu=A.vec3(),nb=A.vec3(),ab=A.vec3();A.vec3();const lb=A.mat4();class Ab{constructor(e){this._scene=e,this._allocate(),this._hash=this._getHash()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=this._scene,o=s.camera,a=t.model,n=s.canvas.gl,l=t._state,c=l.textureState,h=t._state.origin,{position:d,rotationMatrix:p}=a;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,l)),c.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let m,g;const u=h[0]!==0||h[1]!==0||h[2]!==0,x=d[0]!==0||d[1]!==0||d[2]!==0;if(u||x){const _=zu;if(u){const b=A.transformPoint3(p,h,nb);_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=d[0],_[1]+=d[1],_[2]+=d[2],m=Pt(o.viewMatrix,_,lb),g=ab,g[0]=o.eye[0]-_[0],g[1]=o.eye[1]-_[1],g[2]=o.eye[2]-_[2]}else m=o.viewMatrix,g=o.eye;if(n.uniformMatrix4fv(this._uSceneModelMatrix,!1,p),n.uniformMatrix4fv(this._uViewMatrix,!1,m),n.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),n.uniform3fv(this._uCameraEyeRtc,g),n.uniform1i(this._uRenderPass,i),s.logarithmicDepthBufferEnabled){const _=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,_)}const y=s._sectionPlanesState.getNumAllocatedSectionPlanes(),P=s._sectionPlanesState.sectionPlanes.length;if(y>0){const _=s._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,B=a.renderFlags;for(let w=0;w<y;w++){const C=this._uSectionPlanes[w];if(C)if(w<P){const E=B.sectionPlanesActivePerLayer[b+w];if(n.uniform1i(C.active,E?1:0),E){const I=_[w];if(h){const R=kt(I.dist,I.dir,h,zu,a.matrix);n.uniform3fv(C.pos,R)}else n.uniform3fv(C.pos,I.pos);n.uniform3fv(C.dir,I.dir)}}else n.uniform1i(C.active,0)}}l.numIndices8Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,l.numIndices8Bits)),l.numIndices16Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,l.numIndices16Bits)),l.numIndices32Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,l.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("objectDecodeAndInstanceMatrix"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,o=t.camera.project;if(s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),t.logarithmicDepthBufferEnabled){const a=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,a)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture draw vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out highp vec2 vHighPrecisionZW;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("} else {"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2.r;")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture draw fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in highp vec2 vHighPrecisionZW;"),i.push("out vec4 outColor;"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { "),i.push("      discard;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),i.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Gu=A.vec3(),cb=A.vec3(),hb=A.vec3();A.vec3();const ub=A.mat4();class db{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,o=s.scene,a=o.camera,n=o.canvas.gl,l=t._state,c=t._state.origin,{position:h,rotationMatrix:d}=s,p=a.viewMatrix;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(t));let m,g;const u=c[0]!==0||c[1]!==0||c[2]!==0,x=h[0]!==0||h[1]!==0||h[2]!==0;if(u||x){const _=Gu;if(u){const b=cb;A.transformPoint3(d,c,b),_[0]=b[0],_[1]=b[1],_[2]=b[2]}else _[0]=0,_[1]=0,_[2]=0;_[0]+=h[0],_[1]+=h[1],_[2]+=h[2],m=Pt(p,_,ub),g=hb,g[0]=a.eye[0]-_[0],g[1]=a.eye[1]-_[1],g[2]=a.eye[2]-_[2]}else m=p,g=a.eye;n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uWorldMatrix,!1,d),n.uniformMatrix4fv(this._uViewMatrix,!1,m),n.uniformMatrix4fv(this._uProjMatrix,!1,a.projMatrix),n.uniformMatrix4fv(this._uViewNormalMatrix,!1,a.viewNormalMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const y=o._sectionPlanesState.getNumAllocatedSectionPlanes(),P=o._sectionPlanesState.sectionPlanes.length;if(y>0){const _=o._sectionPlanesState.sectionPlanes,b=t.layerIndex*P,B=s.renderFlags;for(let w=0;w<y;w++){const C=this._uSectionPlanes[w];if(C)if(w<P){const E=B.sectionPlanesActivePerLayer[b+w];if(n.uniform1i(C.active,E?1:0),E){const I=_[w];if(c){const R=kt(I.dist,I.dir,c,Gu,s.matrix);n.uniform3fv(C.pos,R)}else n.uniform3fv(C.pos,I.pos);n.uniform3fv(C.dir,I.dir)}}else n.uniform1i(C.active,0)}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.objectDecodeAndInstanceMatrix),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aOffset.bindArrayBuffer(l.offsetsBuf),this._aNormal.bindArrayBuffer(l.normalsBuf),this._aColor.bindArrayBuffer(l.colorsBuf),this._aFlags.bindArrayBuffer(l.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(l.flags2Buf),l.indicesBuf.bind(),n.drawElements(n.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("objectDecodeAndInstanceMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2&&(this._aFlags2=i.getAttribute("flags2")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const s=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,s)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("// Batched geometry normals vertex shader"),e.logarithmicDepthBufferEnabled&&yt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 objectDecodeAndInstanceMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),yt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags2         = flags2;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(yt.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry normals fragment shader"),e.logarithmicDepthBufferEnabled&&yt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&yt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let o=0;o<e._sectionPlanesState.getNumAllocatedSectionPlanes();o++)i.push("uniform bool sectionPlaneActive"+o+";"),i.push("uniform vec3 sectionPlanePos"+o+";"),i.push("uniform vec3 sectionPlaneDir"+o+";")}if(i.push("in vec3 vViewNormal;"),i.push("vec3 packNormalToRGB( const in vec3 normal ) {"),i.push("    return normalize( normal ) * 0.5 + 0.5;"),i.push("}"),i.push("void main(void) {"),t){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return e.logarithmicDepthBufferEnabled&&yt.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Wu=A.vec3(),pb=A.vec3(),fb=A.vec3();A.vec3();A.vec4();const mb=A.mat4();class Sl{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=this._scene,o=s.camera,a=t.model,n=s.canvas.gl,l=t._state,c=l.textureState,h=t._state.origin,{position:d,rotationMatrix:p}=a;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,l));const m=e.pickViewMatrix||o.viewMatrix,g=e.pickProjMatrix||o.projMatrix,u=e.pickOrigin||o.eye,x=e.pickProjMatrix?e.pickZFar:o.project.far;c.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);let y,P;const _=h[0]!==0||h[1]!==0||h[2]!==0,b=d[0]!==0||d[1]!==0||d[2]!==0;if(_||b){const C=Wu;if(_){const E=A.transformPoint3(p,h,pb);C[0]=E[0],C[1]=E[1],C[2]=E[2]}else C[0]=0,C[1]=0,C[2]=0;C[0]+=d[0],C[1]+=d[1],C[2]+=d[2],y=Pt(m,C,mb),P=fb,P[0]=u[0]-C[0],P[1]=u[1]-C[1],P[2]=u[2]-C[2]}else y=m,P=u;if(n.uniform2fv(this._uPickClipPos,e.pickClipPos),n.uniform2f(this._uDrawingBufferSize,n.drawingBufferWidth,n.drawingBufferHeight),n.uniformMatrix4fv(this._uSceneModelMatrix,!1,p),n.uniformMatrix4fv(this._uViewMatrix,!1,y),n.uniformMatrix4fv(this._uProjMatrix,!1,g),n.uniform3fv(this._uCameraEyeRtc,P),n.uniform1i(this._uRenderPass,i),s.logarithmicDepthBufferEnabled){const C=2/(Math.log(x+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,C)}const B=s._sectionPlanesState.getNumAllocatedSectionPlanes(),w=s._sectionPlanesState.sectionPlanes.length;if(B>0){const C=s._sectionPlanesState.sectionPlanes,E=t.layerIndex*w,I=a.renderFlags;for(let R=0;R<B;R++){const F=this._uSectionPlanes[R];if(F)if(R<w){const z=I.sectionPlanesActivePerLayer[E+R];if(n.uniform1i(F.active,z?1:0),z){const Q=C[R];if(h){const H=kt(Q.dist,Q.dir,h,Wu,a.matrix);n.uniform3fv(F.pos,H)}else n.uniform3fv(F.pos,Q.pos);n.uniform3fv(F.dir,Q.dir)}}else n.uniform1i(F.active,0)}}l.numIndices8Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,l.numIndices8Bits)),l.numIndices16Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,l.numIndices16Bits)),l.numIndices32Bits>0&&(c.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,l.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Tt(t,this._buildShader()),this._program.errors){this.errors=this._program.errors;return}const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uDrawingBufferSize=i.getLocation("drawingBufferSize"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+s),pos:i.getLocation("sectionPlanePos"+s),dir:i.getLocation("sectionPlaneDir"+s)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,o=t.camera.project;if(s.bind(),t.logarithmicDepthBufferEnabled){const a=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,a)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// trianglesDatatextureNormalsRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("uniform vec2 pickClipPos;"),i.push("uniform vec2 drawingBufferSize;"),i.push("vec4 remapClipPos(vec4 clipPos) {"),i.push("    clipPos.xy /= clipPos.w;"),i.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),i.push("    clipPos.xy *= clipPos.w;"),i.push("    return clipPos;"),i.push("}"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out vec4 vWorldPosition;"),t&&i.push("flat out uint vFlags2;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("vWorldPosition = worldPosition;"),t&&i.push("vFlags2 = flags2.r;"),i.push("gl_Position = remapClipPos(clipPos);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// TrianglesDataTexturePickNormalsRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("in vec4 vWorldPosition;"),t){i.push("flat in uint vFlags2;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("out highp ivec4 outNormal;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let s=0,o=e._sectionPlanesState.getNumAllocatedSectionPlanes();s<o;s++)i.push("if (sectionPlaneActive"+s+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { "),i.push("      discard;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push(`  outNormal = ivec4(worldNormal * float(${A.MAX_INT}), 1.0);`),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class gb{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._pickNormalsRenderer&&this._pickNormalsRenderer.getValid()===!1&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.getValid()===!1&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&this._occlusionRenderer.getValid()===!1&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null)}eagerCreateRenders(){this._silhouetteRenderer||(this._silhouetteRenderer=new Du(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new Ou(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new Nu(this._scene)),this._pickNormalsRenderer||(this._pickNormalsRenderer=new Sl(this._scene)),this._snapRenderer||(this._snapRenderer=new Fl(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new Hu(this._scene)),this._snapRenderer||(this._snapRenderer=new Fl(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Su(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Su(this._scene,!0)),this._colorRendererWithSAO}get colorQualityRendererWithSAO(){return this._colorQualityRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Du(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new Ab(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new db(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new ky(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Vy(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Ou(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Sl(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Sl(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Nu(this._scene)),this._pickDepthRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new Fl(this._scene)),this._snapRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Hu(this._scene)),this._snapInitRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new ob(this._scene)),this._occlusionRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy()}}const Tl={};function _b(r){const e=r.id;let t=Tl[e];return t||(t=new gb(r),Tl[e]=t,t._compile(),t.eagerCreateRenders(),r.on("compile",()=>{t._compile(),t.eagerCreateRenders()}),r.on("destroyed",()=>{delete Tl[e],t._destroy()})),t}class vb{constructor(){this.positionsCompressed=[],this.lenPositionsCompressed=0,this.metallicRoughness=[],this.indices8Bits=[],this.lenIndices8Bits=0,this.indices16Bits=[],this.lenIndices16Bits=0,this.indices32Bits=[],this.lenIndices32Bits=0,this.edgeIndices8Bits=[],this.lenEdgeIndices8Bits=0,this.edgeIndices16Bits=[],this.lenEdgeIndices16Bits=0,this.edgeIndices32Bits=[],this.lenEdgeIndices32Bits=0,this.perObjectColors=[],this.perObjectPickColors=[],this.perObjectSolid=[],this.perObjectOffsets=[],this.perObjectPositionsDecodeMatrices=[],this.perObjectInstancePositioningMatrices=[],this.perObjectVertexBases=[],this.perObjectIndexBaseOffsets=[],this.perObjectEdgeIndexBaseOffsets=[],this.perTriangleNumberPortionId8Bits=[],this.perTriangleNumberPortionId16Bits=[],this.perTriangleNumberPortionId32Bits=[],this.perEdgeNumberPortionId8Bits=[],this.perEdgeNumberPortionId16Bits=[],this.perEdgeNumberPortionId32Bits=[]}}class Pb{constructor(){this.texturePerObjectColorsAndFlags=null,this.texturePerObjectOffsets=null,this.texturePerObjectInstanceMatrices=null,this.texturePerObjectPositionsDecodeMatrix=null,this.texturePerVertexIdCoordinates=null,this.texturePerPolygonIdPortionIds8Bits=null,this.texturePerPolygonIdPortionIds16Bits=null,this.texturePerPolygonIdPortionIds32Bits=null,this.texturePerEdgeIdPortionIds8Bits=null,this.texturePerEdgeIdPortionIds16Bits=null,this.texturePerEdgeIdPortionIds32Bits=null,this.texturePerPolygonIdIndices8Bits=null,this.texturePerPolygonIdIndices16Bits=null,this.texturePerPolygonIdIndices32Bits=null,this.texturePerPolygonIdEdgeIndices8Bits=null,this.texturePerPolygonIdEdgeIndices16Bits=null,this.texturePerPolygonIdEdgeIndices32Bits=null,this.textureModelMatrices=null}finalize(){this.indicesPerBitnessTextures={8:this.texturePerPolygonIdIndices8Bits,16:this.texturePerPolygonIdIndices16Bits,32:this.texturePerPolygonIdIndices32Bits},this.indicesPortionIdsPerBitnessTextures={8:this.texturePerPolygonIdPortionIds8Bits,16:this.texturePerPolygonIdPortionIds16Bits,32:this.texturePerPolygonIdPortionIds32Bits},this.edgeIndicesPerBitnessTextures={8:this.texturePerPolygonIdEdgeIndices8Bits,16:this.texturePerPolygonIdEdgeIndices16Bits,32:this.texturePerPolygonIdEdgeIndices32Bits},this.edgeIndicesPortionIdsPerBitnessTextures={8:this.texturePerEdgeIdPortionIds8Bits,16:this.texturePerEdgeIdPortionIds16Bits,32:this.texturePerEdgeIdPortionIds32Bits}}bindCommonTextures(e,t,i,s,o){this.texturePerObjectPositionsDecodeMatrix.bindTexture(e,t,1),this.texturePerVertexIdCoordinates.bindTexture(e,i,2),this.texturePerObjectColorsAndFlags.bindTexture(e,s,3),this.texturePerObjectInstanceMatrices.bindTexture(e,o,4)}bindTriangleIndicesTextures(e,t,i,s){this.indicesPortionIdsPerBitnessTextures[s].bindTexture(e,t,5),this.indicesPerBitnessTextures[s].bindTexture(e,i,6)}bindEdgeIndicesTextures(e,t,i,s){this.edgeIndicesPortionIdsPerBitnessTextures[s].bindTexture(e,t,5),this.edgeIndicesPerBitnessTextures[s].bindTexture(e,i,6)}}const rt={sizeDataColorsAndFlags:0,sizeDataPositionDecodeMatrices:0,sizeDataTextureOffsets:0,sizeDataTexturePositions:0,sizeDataTextureIndices:0,sizeDataTextureEdgeIndices:0,sizeDataTexturePortionIds:0,numberOfGeometries:0,numberOfPortions:0,numberOfLayers:0,numberOfTextures:0,totalPolygons:0,totalPolygons8Bits:0,totalPolygons16Bits:0,totalPolygons32Bits:0,totalEdges:0,totalEdges8Bits:0,totalEdges16Bits:0,totalEdges32Bits:0,cannotCreatePortion:{because10BitsObjectId:0,becauseTextureSize:0},overheadSizeAlignementIndices:0,overheadSizeAlignementEdgeIndices:0};window.printDataTextureRamStats=function(){console.log(JSON.stringify(rt,null,4));let r=0;Object.keys(rt).forEach(t=>{t.startsWith("size")&&(r+=rt[t])}),console.log(`Total size ${r} bytes (${(r/1e3/1e3).toFixed(2)} MB)`),console.log(`Avg bytes / triangle: ${(r/rt.totalPolygons).toFixed(2)}`);let e={};Object.keys(rt).forEach(t=>{t.startsWith("size")&&(e[t]=`${(rt[t]/r*100).toFixed(2)} % of total`)}),console.log(JSON.stringify({percentualRamUsage:e},null,4))};class xb{constructor(){}disableBindedTextureFiltering(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}createTextureForColorsAndFlags(e,t,i,s,o,a,n){const l=t.length;this.numPortions=l;const c=512*8,h=Math.ceil(l/(c/8));if(h===0)throw"texture height===0";const d=new Uint8Array(4*c*h);rt.sizeDataColorsAndFlags+=d.byteLength,rt.numberOfTextures++;for(let m=0;m<l;m++)d.set(t[m],m*32+0),d.set(i[m],m*32+4),d.set([0,0,0,0],m*32+8),d.set([0,0,0,0],m*32+12),d.set([s[m]>>24&255,s[m]>>16&255,s[m]>>8&255,s[m]&255],m*32+16),d.set([o[m]>>24&255,o[m]>>16&255,o[m]>>8&255,o[m]&255],m*32+20),d.set([a[m]>>24&255,a[m]>>16&255,a[m]>>8&255,a[m]&255],m*32+24),d.set([n[m]?1:0,0,0,0],m*32+28);const p=e.createTexture();return e.bindTexture(e.TEXTURE_2D,p),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8UI,c,h),e.texSubImage2D(e.TEXTURE_2D,0,0,0,c,h,e.RGBA_INTEGER,e.UNSIGNED_BYTE,d,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,p,c,h,d)}createTextureForObjectOffsets(e,t){const s=Math.ceil(t/512);if(s===0)throw"texture height===0";const o=new Float32Array(3*512*s).fill(0);rt.sizeDataTextureOffsets+=o.byteLength,rt.numberOfTextures++;const a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32F,512,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,512,s,e.RGB,e.FLOAT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,a,512,s,o)}createTextureForInstancingMatrices(e,t){const i=t.length;if(i===0)throw"num instance matrices===0";const s=512*4,o=Math.ceil(i/(s/4)),a=new Float32Array(4*s*o);rt.numberOfTextures++;for(let l=0;l<t.length;l++)a.set(t[l],l*16);const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGBA,e.FLOAT,a,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,n,s,o,a)}createTextureForPositionsDecodeMatrices(e,t){const i=t.length;if(i===0)throw"num decode+entity matrices===0";const s=512*4,o=Math.ceil(i/(s/4)),a=new Float32Array(4*s*o);rt.sizeDataPositionDecodeMatrices+=a.byteLength,rt.numberOfTextures++;for(let l=0;l<t.length;l++)a.set(t[l],l*16);const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGBA,e.FLOAT,a,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,n,s,o)}createTextureFor8BitIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/3/s);if(o===0)throw"texture height===0";const a=s*o*3,n=new Uint8Array(a);rt.sizeDataTextureIndices+=n.byteLength,rt.numberOfTextures++;for(let c=0,h=0,d=t.length;c<d;c++){const p=t[c];n.set(p,h),h+=p.length}const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RGB8UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGB_INTEGER,e.UNSIGNED_BYTE,n,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,l,s,o)}createTextureFor16BitIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/3/s);if(o===0)throw"texture height===0";const a=s*o*3,n=new Uint16Array(a);rt.sizeDataTextureIndices+=n.byteLength,rt.numberOfTextures++;for(let c=0,h=0,d=t.length;c<d;c++){const p=t[c];n.set(p,h),h+=p.length}const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGB_INTEGER,e.UNSIGNED_SHORT,n,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,l,s,o)}createTextureFor32BitIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/3/s);if(o===0)throw"texture height===0";const a=s*o*3,n=new Uint32Array(a);rt.sizeDataTextureIndices+=n.byteLength,rt.numberOfTextures++;for(let c=0,h=0,d=t.length;c<d;c++){const p=t[c];n.set(p,h),h+=p.length}const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RGB_INTEGER,e.UNSIGNED_INT,n,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,l,s,o)}createTextureFor8BitsEdgeIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/2/s);if(o===0)throw"texture height===0";const a=s*o*2,n=new Uint8Array(a);rt.sizeDataTextureEdgeIndices+=n.byteLength,rt.numberOfTextures++;for(let c=0,h=0,d=t.length;c<d;c++){const p=t[c];n.set(p,h),h+=p.length}const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RG8UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RG_INTEGER,e.UNSIGNED_BYTE,n,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,l,s,o)}createTextureFor16BitsEdgeIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/2/s);if(o===0)throw"texture height===0";const a=s*o*2,n=new Uint16Array(a);rt.sizeDataTextureEdgeIndices+=n.byteLength,rt.numberOfTextures++;for(let c=0,h=0,d=t.length;c<d;c++){const p=t[c];n.set(p,h),h+=p.length}const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RG16UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RG_INTEGER,e.UNSIGNED_SHORT,n,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,l,s,o)}createTextureFor32BitsEdgeIndices(e,t,i){if(i===0)return{texture:null,textureHeight:0};const s=4096,o=Math.ceil(i/2/s);if(o===0)throw"texture height===0";const a=s*o*2,n=new Uint32Array(a);rt.sizeDataTextureEdgeIndices+=n.byteLength,rt.numberOfTextures++;for(let c=0,h=0,d=t.length;c<d;c++){const p=t[c];n.set(p,h),h+=p.length}const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RG32UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RG_INTEGER,e.UNSIGNED_INT,n,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,l,s,o)}createTextureForPositions(e,t,i){const s=i/3,o=4096,a=Math.ceil(s/o);if(a===0)throw"texture height===0";const n=o*a*3,l=new Uint16Array(n);rt.sizeDataTexturePositions+=l.byteLength,rt.numberOfTextures++;for(let h=0,d=0,p=t.length;h<p;h++){const m=t[h];l.set(m,d),d+=m.length}const c=e.createTexture();return e.bindTexture(e.TEXTURE_2D,c),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,o,a),e.texSubImage2D(e.TEXTURE_2D,0,0,0,o,a,e.RGB_INTEGER,e.UNSIGNED_SHORT,l,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,c,o,a)}createTextureForPackedPortionIds(e,t){if(t.length===0)return{texture:null,textureHeight:0};const i=t.length,s=4096,o=Math.ceil(i/s);if(o===0)throw"texture height===0";const a=s*o,n=new Uint16Array(a);n.set(t,0),rt.sizeDataTexturePortionIds+=n.byteLength,rt.numberOfTextures++;const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.R16UI,s,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,o,e.RED_INTEGER,e.UNSIGNED_SHORT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Ot(e,l,s,o)}}const yb=new uc,Ku=65536,Mn=yb.maxDataTextureHeight,tr=8,eo=10,bb=A.vec4(),Dl=new Float32Array(16),jt=new Uint8Array(4),to=new Float32Array(3);let Bb=0;const wb=A.identityMat4();class Cb{constructor(e,t){rt.numberOfLayers++,this._layerNumber=Bb++,this.sortId=`TriDTX-${this._layerNumber}`,this.layerIndex=t.layerIndex,this._renderers=_b(e.scene),this.model=e,this._buffer=new vb,this._dtxState=new Pb,this._dtxTextureFactory=new xb,this._state=new Mt({origin:A.vec3(t.origin),metallicRoughnessBuf:null,textureState:this._dtxState,numIndices8Bits:0,numIndices16Bits:0,numIndices32Bits:0,numEdgeIndices8Bits:0,numEdgeIndices16Bits:0,numEdgeIndices32Bits:0,numVertices:0}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._subPortions=[],this.model.scene.readableGeometryEnabled&&(this._subPortionReadableGeometries={}),this._portionToSubPortionsMap=[],this._bucketGeometries={},this._meshes=[],this._aabb=A.collapseAABB3(),this.aabbDirty=!0,this._numUpdatesInFrame=0,this.primitive=t.primitive,this._finalized=!1}get aabb(){if(this.aabbDirty){A.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)A.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e){if(this._finalized)throw"Already finalized";const t=e.buckets.length;this._numPortions+t>Ku&&rt.cannotCreatePortion.because10BitsObjectId++;let i=this._numPortions+t<=Ku;const s=0,o=e.geometryId!==void 0&&e.geometryId!==null?`${e.geometryId}#${s}`:`${e.id}#${s}`;if(!this._bucketGeometries[o]){const n=Math.max(this._state.numIndices8Bits,this._state.numIndices16Bits,this._state.numIndices32Bits);let l=0,c=0;e.buckets.forEach(h=>{l+=h.positionsCompressed.length/3,c+=h.indices.length/3}),(this._state.numVertices+l>Mn*4096||n+c>Mn*4096)&&rt.cannotCreatePortion.becauseTextureSize++,i&&(i=this._state.numVertices+l<=Mn*4096&&n+c<=Mn*4096)}return i}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=[];t.buckets.forEach((o,a)=>{const n=t.geometryId!==void 0&&t.geometryId!==null?`${t.geometryId}#${a}`:`${t.id}#${a}`;let l=this._bucketGeometries[n];l||(l=this._createBucketGeometry(t,o),this._bucketGeometries[n]=l);const c=this._createSubPortion(t,l,o);i.push(c)});const s=this._portionToSubPortionsMap.length;return this._portionToSubPortionsMap.push(i),this.model.numPortions++,this._meshes.push(e),s}_createBucketGeometry(e,t){if(t.indices){const g=Math.ceil(t.indices.length/3/tr)*tr*3;rt.overheadSizeAlignementIndices+=2*(g-t.indices.length);const u=new Uint32Array(g);u.fill(0),u.set(t.indices),t.indices=u}if(t.edgeIndices){const g=Math.ceil(t.edgeIndices.length/2/tr)*tr*2;rt.overheadSizeAlignementEdgeIndices+=2*(g-t.edgeIndices.length);const u=new Uint32Array(g);u.fill(0),u.set(t.edgeIndices),t.edgeIndices=u}const i=t.positionsCompressed,s=t.indices,o=t.edgeIndices,a=this._buffer;a.positionsCompressed.push(i);const n=a.lenPositionsCompressed/3,l=i.length/3;a.lenPositionsCompressed+=i.length;let c,h=0;if(s){h=s.length/3;let g;l<=256?(g=a.indices8Bits,c=a.lenIndices8Bits/3,a.lenIndices8Bits+=s.length):l<=65536?(g=a.indices16Bits,c=a.lenIndices16Bits/3,a.lenIndices16Bits+=s.length):(g=a.indices32Bits,c=a.lenIndices32Bits/3,a.lenIndices32Bits+=s.length),g.push(s)}let d,p=0;if(o){p=o.length/2;let g;l<=256?(g=a.edgeIndices8Bits,d=a.lenEdgeIndices8Bits/2,a.lenEdgeIndices8Bits+=o.length):l<=65536?(g=a.edgeIndices16Bits,d=a.lenEdgeIndices16Bits/2,a.lenEdgeIndices16Bits+=o.length):(g=a.edgeIndices32Bits,d=a.lenEdgeIndices32Bits/2,a.lenEdgeIndices32Bits+=o.length),g.push(o)}return this._state.numVertices+=l,rt.numberOfGeometries++,{vertexBase:n,numVertices:l,numTriangles:h,numEdges:p,indicesBase:c,edgeIndicesBase:d}}_createSubPortion(e,t,i,s){const o=e.color;e.metallic,e.roughness;const a=e.colors,n=e.opacity,l=e.meshMatrix,c=e.pickColor,h=this._buffer,d=this._state;h.perObjectPositionsDecodeMatrices.push(e.positionsDecodeMatrix),h.perObjectInstancePositioningMatrices.push(l||wb),h.perObjectSolid.push(!!e.solid),a?h.perObjectColors.push([a[0]*255,a[1]*255,a[2]*255,255]):o&&h.perObjectColors.push([o[0],o[1],o[2],n]),h.perObjectPickColors.push(c),h.perObjectVertexBases.push(t.vertexBase);{let m;t.numVertices<=256?m=d.numIndices8Bits:t.numVertices<=65536?m=d.numIndices16Bits:m=d.numIndices32Bits,h.perObjectIndexBaseOffsets.push(m/3-t.indicesBase)}{let m;t.numVertices<=256?m=d.numEdgeIndices8Bits:t.numVertices<=65536?m=d.numEdgeIndices16Bits:m=d.numEdgeIndices32Bits,h.perObjectEdgeIndexBaseOffsets.push(m/2-t.edgeIndicesBase)}const p=this._subPortions.length;if(t.numTriangles>0){let m=t.numTriangles*3,g;t.numVertices<=256?(g=h.perTriangleNumberPortionId8Bits,d.numIndices8Bits+=m,rt.totalPolygons8Bits+=t.numTriangles):t.numVertices<=65536?(g=h.perTriangleNumberPortionId16Bits,d.numIndices16Bits+=m,rt.totalPolygons16Bits+=t.numTriangles):(g=h.perTriangleNumberPortionId32Bits,d.numIndices32Bits+=m,rt.totalPolygons32Bits+=t.numTriangles),rt.totalPolygons+=t.numTriangles;for(let u=0;u<t.numTriangles;u+=tr)g.push(p)}if(t.numEdges>0){let m=t.numEdges*2,g;t.numVertices<=256?(g=h.perEdgeNumberPortionId8Bits,d.numEdgeIndices8Bits+=m,rt.totalEdges8Bits+=t.numEdges):t.numVertices<=65536?(g=h.perEdgeNumberPortionId16Bits,d.numEdgeIndices16Bits+=m,rt.totalEdges16Bits+=t.numEdges):(g=h.perEdgeNumberPortionId32Bits,d.numEdgeIndices32Bits+=m,rt.totalEdges32Bits+=t.numEdges),rt.totalEdges+=t.numEdges;for(let u=0;u<t.numEdges;u+=tr)g.push(p)}return this._subPortions.push({numVertices:t.numTriangles}),this.model.scene.readableGeometryEnabled&&(this._subPortionReadableGeometries[p]={indices:i.indices,positionsCompressed:i.positionsCompressed,positionsDecodeMatrix:e.positionsDecodeMatrix,meshMatrix:e.meshMatrix}),this._numPortions++,rt.numberOfPortions++,p}finalize(){if(this._finalized)return;const e=this._state,t=this._dtxState,i=this.model.scene.canvas.gl,s=this._buffer;e.gl=i,t.texturePerObjectColorsAndFlags=this._dtxTextureFactory.createTextureForColorsAndFlags(i,s.perObjectColors,s.perObjectPickColors,s.perObjectVertexBases,s.perObjectIndexBaseOffsets,s.perObjectEdgeIndexBaseOffsets,s.perObjectSolid),t.texturePerObjectInstanceMatrices=this._dtxTextureFactory.createTextureForInstancingMatrices(i,s.perObjectInstancePositioningMatrices),t.texturePerObjectPositionsDecodeMatrix=this._dtxTextureFactory.createTextureForPositionsDecodeMatrices(i,s.perObjectPositionsDecodeMatrices),t.texturePerVertexIdCoordinates=this._dtxTextureFactory.createTextureForPositions(i,s.positionsCompressed,s.lenPositionsCompressed),t.texturePerPolygonIdPortionIds8Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perTriangleNumberPortionId8Bits),t.texturePerPolygonIdPortionIds16Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perTriangleNumberPortionId16Bits),t.texturePerPolygonIdPortionIds32Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perTriangleNumberPortionId32Bits),s.perEdgeNumberPortionId8Bits.length>0&&(t.texturePerEdgeIdPortionIds8Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perEdgeNumberPortionId8Bits)),s.perEdgeNumberPortionId16Bits.length>0&&(t.texturePerEdgeIdPortionIds16Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perEdgeNumberPortionId16Bits)),s.perEdgeNumberPortionId32Bits.length>0&&(t.texturePerEdgeIdPortionIds32Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perEdgeNumberPortionId32Bits)),s.lenIndices8Bits>0&&(t.texturePerPolygonIdIndices8Bits=this._dtxTextureFactory.createTextureFor8BitIndices(i,s.indices8Bits,s.lenIndices8Bits)),s.lenIndices16Bits>0&&(t.texturePerPolygonIdIndices16Bits=this._dtxTextureFactory.createTextureFor16BitIndices(i,s.indices16Bits,s.lenIndices16Bits)),s.lenIndices32Bits>0&&(t.texturePerPolygonIdIndices32Bits=this._dtxTextureFactory.createTextureFor32BitIndices(i,s.indices32Bits,s.lenIndices32Bits)),s.lenEdgeIndices8Bits>0&&(t.texturePerPolygonIdEdgeIndices8Bits=this._dtxTextureFactory.createTextureFor8BitsEdgeIndices(i,s.edgeIndices8Bits,s.lenEdgeIndices8Bits)),s.lenEdgeIndices16Bits>0&&(t.texturePerPolygonIdEdgeIndices16Bits=this._dtxTextureFactory.createTextureFor16BitsEdgeIndices(i,s.edgeIndices16Bits,s.lenEdgeIndices16Bits)),s.lenEdgeIndices32Bits>0&&(t.texturePerPolygonIdEdgeIndices32Bits=this._dtxTextureFactory.createTextureFor32BitsEdgeIndices(i,s.edgeIndices32Bits,s.lenEdgeIndices32Bits)),t.finalize(),this._buffer=null,this._bucketGeometries={},this._finalized=!0,this._deferredSetFlagsDirty=!1,this._onSceneRendering=this.model.scene.on("rendering",()=>{this._deferredSetFlagsDirty&&this._uploadDeferredFlags(),this._numUpdatesInFrame=0})}isEmpty(){return this._numPortions===0}initFlags(e,t,i){t&N.VISIBLE&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&N.HIGHLIGHTED&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&N.XRAYED&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&N.SELECTED&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&N.CLIPPABLE&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&N.EDGES&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&N.PICKABLE&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&N.CULLED&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);const s=!0;this._setFlags(e,t,i,s),this._setFlags2(e,t,s)}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&N.VISIBLE?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&N.HIGHLIGHTED?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&N.XRAYED?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&N.SELECTED?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&N.EDGES?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&N.CLIPPABLE?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}_beginDeferredFlags(){this._deferredSetFlagsActive=!0}_uploadDeferredFlags(){if(this._deferredSetFlagsActive=!1,!this._deferredSetFlagsDirty)return;this._deferredSetFlagsDirty=!1;const e=this.model.scene.canvas.gl,t=this._dtxState;e.bindTexture(e.TEXTURE_2D,t.texturePerObjectColorsAndFlags._texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.texturePerObjectColorsAndFlags._textureWidth,t.texturePerObjectColorsAndFlags._textureHeight,e.RGBA_INTEGER,e.UNSIGNED_BYTE,t.texturePerObjectColorsAndFlags._textureData)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&N.CULLED?(this._numCulledLayerPortions+=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions-=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&N.PICKABLE?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){const i=this._portionToSubPortionsMap[e];for(let s=0,o=i.length;s<o;s++)this._subPortionSetColor(i[s],t)}_subPortionSetColor(e,t){if(!this._finalized)throw"Not finalized";const i=this._dtxState,s=this.model.scene.canvas.gl;if(jt[0]=t[0],jt[1]=t[1],jt[2]=t[2],jt[3]=t[3],i.texturePerObjectColorsAndFlags._textureData.set(jt,e*32),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=eo&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectColorsAndFlags._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*8,Math.floor(e/512),1,1,s.RGBA_INTEGER,s.UNSIGNED_BYTE,jt)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){const o=this._portionToSubPortionsMap[e];for(let a=0,n=o.length;a<n;a++)this._subPortionSetFlags(o[a],t,i,s)}_subPortionSetFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const o=!!(t&N.VISIBLE),a=!!(t&N.XRAYED),n=!!(t&N.HIGHLIGHTED),l=!!(t&N.SELECTED),c=!!(t&N.EDGES),h=!!(t&N.PICKABLE),d=!!(t&N.CULLED);let p;!o||d||a||n&&!this.model.scene.highlightMaterial.glowThrough||l&&!this.model.scene.selectedMaterial.glowThrough?p=O.NOT_RENDERED:i?p=O.COLOR_TRANSPARENT:p=O.COLOR_OPAQUE;let m;!o||d?m=O.NOT_RENDERED:l?m=O.SILHOUETTE_SELECTED:n?m=O.SILHOUETTE_HIGHLIGHTED:a?m=O.SILHOUETTE_XRAYED:m=O.NOT_RENDERED;let g=0;!o||d?g=O.NOT_RENDERED:l?g=O.EDGES_SELECTED:n?g=O.EDGES_HIGHLIGHTED:a?g=O.EDGES_XRAYED:c?i?g=O.EDGES_COLOR_TRANSPARENT:g=O.EDGES_COLOR_OPAQUE:g=O.NOT_RENDERED;let u=o&&!d&&h?O.PICK:O.NOT_RENDERED;const x=this._dtxState,y=this.model.scene.canvas.gl;if(jt[0]=p,jt[1]=m,jt[2]=g,jt[3]=u,x.texturePerObjectColorsAndFlags._textureData.set(jt,e*32+8),this._deferredSetFlagsActive||s){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=eo&&this._beginDeferredFlags(),y.bindTexture(y.TEXTURE_2D,x.texturePerObjectColorsAndFlags._texture),y.texSubImage2D(y.TEXTURE_2D,0,e%512*8+2,Math.floor(e/512),1,1,y.RGBA_INTEGER,y.UNSIGNED_BYTE,jt)}_setDeferredFlags(){}_setFlags2(e,t,i=!1){const s=this._portionToSubPortionsMap[e];for(let o=0,a=s.length;o<a;o++)this._subPortionSetFlags2(s[o],t,i)}_subPortionSetFlags2(e,t,i=!1){if(!this._finalized)throw"Not finalized";const s=t&N.CLIPPABLE?255:0,o=this._dtxState,a=this.model.scene.canvas.gl;if(jt[0]=s,jt[1]=0,jt[2]=1,jt[3]=2,o.texturePerObjectColorsAndFlags._textureData.set(jt,e*32+12),this._deferredSetFlagsActive||i){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=eo&&this._beginDeferredFlags(),a.bindTexture(a.TEXTURE_2D,o.texturePerObjectColorsAndFlags._texture),a.texSubImage2D(a.TEXTURE_2D,0,e%512*8+3,Math.floor(e/512),1,1,a.RGBA_INTEGER,a.UNSIGNED_BYTE,jt)}_setDeferredFlags2(){}setOffset(e,t){const i=this._portionToSubPortionsMap[e];for(let s=0,o=i.length;s<o;s++)this._subPortionSetOffset(i[s],t)}_subPortionSetOffset(e,t){if(!this._finalized)throw"Not finalized";const i=this._dtxState,s=this.model.scene.canvas.gl;if(to[0]=t[0],to[1]=t[1],to[2]=t[2],i.texturePerObjectOffsets._textureData.set(to,e*3),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=eo&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectOffsets._texture),s.texSubImage2D(s.TEXTURE_2D,0,0,e,1,1,s.RGB,s.FLOAT,to)}setMatrix(e,t){const i=this._portionToSubPortionsMap[e];for(let s=0,o=i.length;s<o;s++)this._subPortionSetMatrix(i[s],t)}_subPortionSetMatrix(e,t){if(!this._finalized)throw"Not finalized";const i=this._dtxState,s=this.model.scene.canvas.gl;if(Dl.set(t),i.texturePerObjectInstanceMatrices._textureData.set(Dl,e*16),this._deferredSetFlagsActive){this._deferredSetFlagsDirty=!0;return}++this._numUpdatesInFrame>=eo&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectInstanceMatrices._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*4,Math.floor(e/512),4,1,s.RGBA,s.FLOAT,Dl)}getEachVertex(e,t){if(!this.model.scene.readableGeometryEnabled)return;const i=this._state,s=this._portionToSubPortionsMap[e];if(!s){this.model.error("portion not found: "+e);return}for(let o=0,a=s.length;o<a;o++){const n=s[o],l=this._subPortionReadableGeometries[n],c=l.positionsCompressed,h=l.positionsDecodeMatrix;l.meshMatrix;const d=i.origin,p=d[0],m=d[1],g=d[2],u=bb;for(let x=0,y=c.length;x<y;x+=3)u[0]=c[x],u[1]=c[x+1],u[2]=c[x+2],u[3]=1,A.decompressPosition(u,h),A.transformPoint4(this.model.worldMatrix,u,u),A.transformPoint4(this.model.worldMatrix,u,u),u[0]+=p,u[1]+=m,u[2]+=g,t(u)}}getEachIndex(e,t){if(!this.model.scene.readableGeometryEnabled)return;const i=this._portionToSubPortionsMap[e];if(!i){this.model.error("portion not found: "+e);return}for(let s=0,o=i.length;s<o;s++){const a=i[s],l=this._subPortionReadableGeometries[a].indices;for(let c=0,h=l.length;c<h;c++)t(l[c])}}drawColorOpaque(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),t.withSAO&&this.model.saoEnabled?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(t,this,O.COLOR_OPAQUE):this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_OPAQUE))}_updateBackfaceCull(e,t){const i=this.model.backfaces||e.sectioned;if(t.backfaces!==i){const s=t.gl;i?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),t.backfaces=i}}drawColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===0||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,O.COLOR_TRANSPARENT))}drawDepth(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(t,this,O.COLOR_OPAQUE))}drawNormals(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions||(this._updateBackfaceCull(e,t),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(t,this,O.COLOR_OPAQUE))}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_XRAYED))}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_HIGHLIGHTED))}drawSilhouetteSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,O.SILHOUETTE_SELECTED))}drawEdgesColorOpaque(e,t){if(this.model.scene.logarithmicDepthBufferEnabled){this.model.scene._loggedWarning||(console.log("Edge enhancement for SceneModel data texture layers currently disabled with logarithmic depth buffer"),this.model.scene._loggedWarning=!0);return}this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,O.EDGES_COLOR_OPAQUE)}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numEdgesLayerPortions===0||this._numTransparentLayerPortions===0||this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,O.EDGES_COLOR_TRANSPARENT)}drawEdgesHighlighted(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numHighlightedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,O.EDGES_HIGHLIGHTED)}drawEdgesSelected(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numSelectedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,O.EDGES_SELECTED)}drawEdgesXRayed(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||this._numXRayedLayerPortions===0||this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,O.EDGES_XRAYED)}drawOcclusion(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,O.COLOR_OPAQUE))}drawShadow(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(t,this,O.COLOR_OPAQUE))}setPickMatrices(e,t){}drawPickMesh(e,t){this._numVisibleLayerPortions!==0&&(this._updateBackfaceCull(e,t),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,O.PICK))}drawPickDepths(e,t){this._numVisibleLayerPortions!==0&&(this._updateBackfaceCull(e,t),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,O.PICK))}drawSnapInit(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,O.PICK))}drawSnap(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,O.PICK))}drawPickNormals(e,t){this._numCulledLayerPortions===this._numPortions||this._numVisibleLayerPortions===0||(this._updateBackfaceCull(e,t),this._renderers.pickNormalsRenderer&&this._renderers.pickNormalsRenderer.drawLayer(t,this,O.PICK))}destroy(){if(this._destroyed)return;const e=this._state;e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),this.model.scene.off(this._onSceneRendering),e.destroy(),this._destroyed=!0}}class Xu{constructor(e){this.id=e.id,this.colorTexture=e.colorTexture,this.alphaCutoff=e.alphaCutoff,this.metallicRoughnessTexture=e.metallicRoughnessTexture,this.normalsTexture=e.normalsTexture,this.emissiveTexture=e.emissiveTexture,this.occlusionTexture=e.occlusionTexture}destroy(){}}class ir{constructor(e){this.id=e.id,this.texture=e.texture}destroy(){this.texture&&(this.texture.destroy(),this.texture=null)}}const Yu={enabled:!1,files:{},add:function(r,e){this.enabled!==!1&&(this.files[r]=e)},get:function(r){if(this.enabled!==!1)return this.files[r]},remove:function(r){delete this.files[r]},clear:function(){this.files={}}};class Mb{constructor(e,t,i){this.isLoading=!1,this.itemsLoaded=0,this.itemsTotal=0,this.urlModifier=void 0,this.handlers=[],this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i}itemStart(e){this.itemsTotal++,this.isLoading===!1&&this.onStart!==void 0&&this.onStart(e,this.itemsLoaded,this.itemsTotal),this.isLoading=!0}itemEnd(e){this.itemsLoaded++,this.onProgress!==void 0&&this.onProgress(e,this.itemsLoaded,this.itemsTotal),this.itemsLoaded===this.itemsTotal&&(this.isLoading=!1,this.onLoad!==void 0&&this.onLoad())}itemError(e){this.onError!==void 0&&this.onError(e)}resolveURL(e){return this.urlModifier?this.urlModifier(e):e}setURLModifier(e){return this.urlModifier=e,this}addHandler(e,t){return this.handlers.push(e,t),this}removeHandler(e){const t=this.handlers.indexOf(e);return t!==-1&&this.handlers.splice(t,2),this}getHandler(e){for(let t=0,i=this.handlers.length;t<i;t+=2){const s=this.handlers[t],o=this.handlers[t+1];if(s.global&&(s.lastIndex=0),s.test(e))return o}return null}}const Eb=new Mb;class Ib{constructor(e){this.manager=e!==void 0?e:Eb,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const i=this;return new Promise(function(s,o){i.load(e,s,t,o)})}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}const $i={};class $u extends Ib{constructor(e){super(e)}load(e,t,i,s){e===void 0&&(e=""),this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const o=Yu.get(e);if(o!==void 0)return this.manager.itemStart(e),It.scheduleTask(()=>{t&&t(o),this.manager.itemEnd(e)},0),o;if($i[e]!==void 0){$i[e].push({onLoad:t,onProgress:i,onError:s});return}$i[e]=[],$i[e].push({onLoad:t,onProgress:i,onError:s});const a=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),n=this.mimeType,l=this.responseType;fetch(a).then(c=>{if(c.status===200||c.status===0){if(c.status===0&&console.warn("FileLoader: HTTP Status 0 received."),typeof ReadableStream>"u"||c.body.getReader===void 0)return c;const h=$i[e],d=c.body.getReader(),p=c.headers.get("Content-Length"),m=p?parseInt(p):0,g=m!==0;let u=0;const x=new ReadableStream({start(y){P();function P(){d.read().then(({done:_,value:b})=>{if(_)y.close();else{u+=b.byteLength;const B=new ProgressEvent("progress",{lengthComputable:g,loaded:u,total:m});for(let w=0,C=h.length;w<C;w++){const E=h[w];E.onProgress&&E.onProgress(B)}y.enqueue(b),P()}})}}});return new Response(x)}else throw Error(`fetch for "${c.url}" responded with ${c.status}: ${c.statusText}`)}).then(c=>{switch(l){case"arraybuffer":return c.arrayBuffer();case"blob":return c.blob();case"document":return c.text().then(h=>new DOMParser().parseFromString(h,n));case"json":return c.json();default:if(n===void 0)return c.text();{const d=/charset="?([^;"\s]*)"?/i.exec(n),p=d&&d[1]?d[1].toLowerCase():void 0,m=new TextDecoder(p);return c.arrayBuffer().then(g=>m.decode(g))}}}).then(c=>{Yu.add(e,c);const h=$i[e];delete $i[e];for(let d=0,p=h.length;d<p;d++){const m=h[d];m.onLoad&&m.onLoad(c)}}).catch(c=>{const h=$i[e];if(h===void 0)throw this.manager.itemError(e),c;delete $i[e];for(let d=0,p=h.length;d<p;d++){const m=h[d];m.onError&&m.onError(c)}this.manager.itemError(e)}).finally(()=>{this.manager.itemEnd(e)}),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class Fb{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const i=this.workersResolve[e];if(i&&i(t),this.queue.length){const{resolve:s,msg:o,transfer:a}=this.queue.shift();this.workersResolve[e]=s,this.workers[e].postMessage(o,a)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise(i=>{const s=this._getIdleWorker();s!==-1?(this._initWorker(s),this.workerStatus|=1<<s,this.workersResolve[s]=i,this.workers[s].postMessage(e,t)):this.queue.push({resolve:i,msg:e,transfer:t})})}destroy(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const Sb=2,Tb=1;let Rl=0;class Hi{constructor({viewer:e,transcoderPath:t,workerLimit:i}){this._transcoderPath=t||"https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk/dist/basis/",this._transcoderBinary=null,this._transcoderPending=null,this._workerPool=new Fb,this._workerSourceURL="",i&&this._workerPool.setWorkerLimit(i);const s=e.capabilities;this._workerConfig={astcSupported:s.astcSupported,etc1Supported:s.etc1Supported,etc2Supported:s.etc2Supported,dxtSupported:s.dxtSupported,bptcSupported:s.bptcSupported,pvrtcSupported:s.pvrtcSupported},this._supportedFileTypes=["xkt2"]}_init(){if(!this._transcoderPending){const e=new $u;e.setPath(this._transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),i=new $u;i.setPath(this._transcoderPath),i.setResponseType("arraybuffer"),i.setWithCredentials(this.withCredentials);const s=i.loadAsync("basis_transcoder.wasm");this._transcoderPending=Promise.all([t,s]).then(([o,a])=>{const n=Hi.BasisWorker.toString(),l=["/* constants */","let _EngineFormat = "+JSON.stringify(Hi.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(Hi.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(Hi.BasisFormat),"/* basis_transcoder.js */",o,"/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join(`
`);this._workerSourceURL=URL.createObjectURL(new Blob([l])),this._transcoderBinary=a,this._workerPool.setWorkerCreator(()=>{const c=new Worker(this._workerSourceURL),h=this._transcoderBinary.slice(0);return c.postMessage({type:"init",config:this._workerConfig,transcoderBinary:h},[h]),c})}),Rl>0&&console.warn("KTX2TextureTranscoder: Multiple active KTX2TextureTranscoder may cause performance issues. Use a single KTX2TextureTranscoder instance, or call .dispose() on old instances."),Rl++}return this._transcoderPending}transcode(e,t,i={}){return new Promise((s,o)=>{const a=i;this._init().then(()=>this._workerPool.postMessage({type:"transcode",buffers:e,taskConfig:a},e)).then(n=>{const l=n.data,{mipmaps:c,width:h,height:d,format:p,type:m,error:g,dfdTransferFn:u,dfdFlags:x}=l;if(m==="error")return o(g);t.setCompressedData({mipmaps:c,props:{format:p,minFilter:c.length===1?Si:xo,magFilter:c.length===1?Si:xo,encoding:u===Sb?Et:os,premultiplyAlpha:!!(x&Tb)}}),s()})})}destroy(){URL.revokeObjectURL(this._workerSourceURL),this._workerPool.destroy(),Rl--}}Hi.BasisFormat={ETC1S:0,UASTC_4x4:1};Hi.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16};Hi.EngineFormat={RGBAFormat:ga,RGBA_ASTC_4x4_Format:CA,RGBA_BPTC_Format:MA,RGBA_ETC2_EAC_Format:wA,RGBA_PVRTC_4BPPV1_Format:bA,RGBA_S3TC_DXT5_Format:aa,RGB_ETC1_Format:Bf,RGB_ETC2_Format:BA,RGB_PVRTC_4BPPV1_Format:yA,RGB_S3TC_DXT1_Format:na};Hi.BasisWorker=function(){let r,e,t;const i=_EngineFormat,s=_TranscoderFormat,o=_BasisFormat;self.addEventListener("message",function(m){const g=m.data;switch(g.type){case"init":r=g.config,a(g.transcoderBinary);break;case"transcode":e.then(()=>{try{const{width:u,height:x,hasAlpha:y,mipmaps:P,format:_,dfdTransferFn:b,dfdFlags:B}=n(g.buffers[0]),w=[];for(let C=0;C<P.length;++C)w.push(P[C].data.buffer);self.postMessage({type:"transcode",id:g.id,width:u,height:x,hasAlpha:y,mipmaps:P,format:_,dfdTransferFn:b,dfdFlags:B},w)}catch(u){console.error(`[KTX2TextureTranscoder.BasisWorker]: ${u}`),self.postMessage({type:"error",id:g.id,error:u.message})}});break}});function a(m){e=new Promise(g=>{t={wasmBinary:m,onRuntimeInitialized:g},BASIS(t)}).then(()=>{t.initializeBasis(),t.KTX2File===void 0&&console.warn("KTX2TextureTranscoder: Please update Basis Universal transcoder.")})}function n(m){const g=new t.KTX2File(new Uint8Array(m));function u(){g.close(),g.delete()}if(!g.isValid())throw u(),new Error("KTX2TextureTranscoder: Invalid or unsupported .ktx2 file");const x=g.isUASTC()?o.UASTC_4x4:o.ETC1S,y=g.getWidth(),P=g.getHeight(),_=g.getLevels(),b=g.getHasAlpha(),B=g.getDFDTransferFunc(),w=g.getDFDFlags(),{transcoderFormat:C,engineFormat:E}=d(x,y,P,b);if(!y||!P||!_)throw u(),new Error("KTX2TextureTranscoder: Invalid texture");if(!g.startTranscoding())throw u(),new Error("KTX2TextureTranscoder: .startTranscoding failed");const I=[];for(let R=0;R<_;R++){const F=g.getImageLevelInfo(R,0,0),z=F.origWidth,Q=F.origHeight,H=new Uint8Array(g.getImageTranscodedSizeInBytes(R,0,0,C));if(!g.transcodeImage(H,R,0,0,C,0,-1,-1))throw u(),new Error("KTX2TextureTranscoder: .transcodeImage failed.");I.push({data:H,width:z,height:Q})}return u(),{width:y,height:P,hasAlpha:b,mipmaps:I,format:E,dfdTransferFn:B,dfdFlags:w}}const l=[{if:"astcSupported",basisFormat:[o.UASTC_4x4],transcoderFormat:[s.ASTC_4x4,s.ASTC_4x4],engineFormat:[i.RGBA_ASTC_4x4_Format,i.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.BC7_M5,s.BC7_M5],engineFormat:[i.RGBA_BPTC_Format,i.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.BC1,s.BC3],engineFormat:[i.RGB_S3TC_DXT1_Format,i.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.ETC1,s.ETC2],engineFormat:[i.RGB_ETC2_Format,i.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.ETC1],engineFormat:[i.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[s.PVRTC1_4_RGB,s.PVRTC1_4_RGBA],engineFormat:[i.RGB_PVRTC_4BPPV1_Format,i.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],c=l.sort(function(m,g){return m.priorityETC1S-g.priorityETC1S}),h=l.sort(function(m,g){return m.priorityUASTC-g.priorityUASTC});function d(m,g,u,x){let y,P;const _=m===o.ETC1S?c:h;for(let b=0;b<_.length;b++){const B=_[b];if(r[B.if]&&B.basisFormat.includes(m)&&!(x&&B.transcoderFormat.length<2)&&!(B.needsPowerOfTwo&&!(p(g)&&p(u))))return y=B.transcoderFormat[x?1:0],P=B.engineFormat[x?1:0],{transcoderFormat:y,engineFormat:P}}return console.warn("KTX2TextureTranscoder: No suitable compressed texture format found. Decoding to RGBA32."),y=s.RGBA32,P=i.RGBAFormat,{transcoderFormat:y,engineFormat:P}}function p(m){return m<=2?!0:(m&m-1)===0&&m!==0}};const Ll={};function Db(r){const e=r.scene.id;let t=Ll[e];return t||(t=new Hi({viewer:r}),Ll[e]=t,r.scene.on("destroyed",()=>{delete Ll[e],t.destroy()})),t}/**
 * @author https://github.com/tmarti, with support from https://tribia.com/
 * @license MIT
 *
 * This file takes a geometry given by { positionsCompressed, indices }, and returns
 * equivalent { positionsCompressed, indices } arrays but which only contain unique
 * positionsCompressed.
 *
 * The time is O(N logN) with the number of positionsCompressed due to a pre-sorting
 * step, but is much more GC-friendly and actually faster than the classic O(N)
 * approach based in keeping a hash-based LUT to identify unique positionsCompressed.
 */let va=null;function Ul(r,e){let t;for(let i=0;i<3;i++)if((t=va[r*3+i]-va[e*3+i])!==0)return t;return 0}let xr=null;function Rb(r){if(!(xr!==null&&xr.length>=r)){xr=new Uint32Array(r);for(let e=0;e<r;e++)xr[e]=e}}function Lb(r){const e=r.positionsCompressed,t=r.indices,i=r.edgeIndices;Rb(e.length/3);const s=xr.slice(0,e.length/3),o=xr.slice(0,e.length/3);va=e,s.sort(Ul);let a=0;o[s[0]]=0;for(let d=1,p=s.length;d<p;d++)Ul(s[d],s[d-1])!==0&&a++,o[s[d]]=a;const n=a+1,l=new Uint16Array(n*3);a=0,l[a*3+0]=e[s[0]*3+0],l[a*3+1]=e[s[0]*3+1],l[a*3+2]=e[s[0]*3+2];for(let d=1,p=s.length;d<p;d++)Ul(s[d],s[d-1])!==0&&(a++,l[a*3+0]=e[s[d]*3+0],l[a*3+1]=e[s[d]*3+1],l[a*3+2]=e[s[d]*3+2]),o[s[d]]=a;va=null;const c=new Uint32Array(t.length);for(let d=0,p=t.length;d<p;d++)c[d]=o[t[d]];const h=new Uint32Array(i.length);for(let d=0,p=i.length;d<p;d++)h[d]=o[i[d]];return[l,c,h]}/**
 * @author https://github.com/tmarti, with support from https://tribia.com/
 * @license MIT
 **/const Zu=8;let gs=null;function Ub(r,e){const t=r*3,i=e*3;let s,o,a,n,l,c;const h=Math.min(s=gs[t],o=gs[t+1],a=gs[t+2]),d=Math.min(n=gs[i],l=gs[i+1],c=gs[i+2]);if(h!==d)return h-d;const p=Math.max(s,o,a),m=Math.max(n,l,c);return p!==m?p-m:0}function Ob(r,e){const t=new Int32Array(r.length/3);for(let s=0,o=t.length;s<o;s++)t[s]=s;gs=new Int32Array(r.length);for(let s=0,o=r.length;s<o;s++)gs[s]=r[s]>>e;t.sort(Ub);const i=new Int32Array(r.length);for(let s=0,o=t.length;s<o;s++)i[s*3+0]=r[t[s]*3+0],i[s*3+1]=r[t[s]*3+1],i[s*3+2]=r[t[s]*3+2];return i}let co=null;function kb(r,e){let t=co[r*2]-co[e*2];return t!==0?t:co[r*2+1]-co[e*2+1]}function Nb(r){if((r||[]).length===0)return[];let e=new Int32Array(r.length/2);for(let i=0,s=e.length;i<s;i++)e[i]=i;for(let i=0,s=r.length;i<s;i+=2)if(r[i]>r[i+1]){let o=r[i];r[i]=r[i+1],r[i+1]=o}co=new Int32Array(r),e.sort(kb);const t=new Int32Array(r.length);for(let i=0,s=e.length;i<s;i++)t[i*2+0]=r[e[i]*2+0],t[i*2+1]=r[e[i]*2+1];return t}function Qb(r,e,t=!1){const i=r.positionsCompressed||[],s=Ob(r.indices||[],e),o=Nb(r.edgeIndices||[]);function a(P,_){if(P>_){let C=P;P=_,_=C}function b(C,E){return C!==P?P-C:E!==_?_-E:0}let B=0,w=(o.length>>1)-1;for(;B<=w;){const C=w+B>>1,E=b(o[C*2],o[C*2+1]);if(E>0)B=C+1;else if(E<0)w=C-1;else return C}return-B-1}const n=new Int32Array(o.length/2);n.fill(0);const l=i.length/3;if(l>(1<<e)*Zu)return[r];const c=new Int32Array(l);c.fill(-1);const h=[];function d(){c.fill(-1);const P={positionsCompressed:[],indices:[],edgeIndices:[],maxNumPositions:(1<<e)-e,numPositions:0,bucketNumber:h.length};return h.push(P),P}let p=d();for(let P=0,_=s.length;P<_;P+=3){let b=0;const B=s[P],w=s[P+1],C=s[P+2];if(c[B]===-1&&b++,c[w]===-1&&b++,c[C]===-1&&b++,b+p.numPositions>p.maxNumPositions&&(p=d()),p.bucketNumber>Zu)return[r];c[B]===-1&&(c[B]=p.numPositions++,p.positionsCompressed.push(i[B*3]),p.positionsCompressed.push(i[B*3+1]),p.positionsCompressed.push(i[B*3+2])),c[w]===-1&&(c[w]=p.numPositions++,p.positionsCompressed.push(i[w*3]),p.positionsCompressed.push(i[w*3+1]),p.positionsCompressed.push(i[w*3+2])),c[C]===-1&&(c[C]=p.numPositions++,p.positionsCompressed.push(i[C*3]),p.positionsCompressed.push(i[C*3+1]),p.positionsCompressed.push(i[C*3+2])),p.indices.push(c[B]),p.indices.push(c[w]),p.indices.push(c[C]);let E;(E=a(B,w))>=0&&n[E]===0&&(n[E]=1,p.edgeIndices.push(c[o[E*2]]),p.edgeIndices.push(c[o[E*2+1]])),(E=a(B,C))>=0&&n[E]===0&&(n[E]=1,p.edgeIndices.push(c[o[E*2]]),p.edgeIndices.push(c[o[E*2+1]])),(E=a(w,C))>=0&&n[E]===0&&(n[E]=1,p.edgeIndices.push(c[o[E*2]]),p.edgeIndices.push(c[o[E*2+1]]))}const m=e/8*2,g=e/8,u=i.length*2+(s.length+o.length)*m;let x=0,y=-i.length/3;return h.forEach(P=>{x+=P.positionsCompressed.length*2+(P.indices.length+P.edgeIndices.length)*g,y+=P.positionsCompressed.length/3}),x>u?[r]:(t&&Vb(h,r),h)}function Vb(r,e){const t={};let i=0;r.forEach(s=>{const o=s.indices,a=s.edgeIndices,n=s.positionsCompressed;for(let l=0,c=o.length;l<c;l+=3){const h=n[o[l]*3]+"_"+n[o[l]*3+1]+"_"+n[o[l]*3+2]+"/"+n[o[l+1]*3]+"_"+n[o[l+1]*3+1]+"_"+n[o[l+1]*3+2]+"/"+n[o[l+2]*3]+"_"+n[o[l+2]*3+1]+"_"+n[o[l+2]*3+2];t[h]=!0}i+=s.edgeIndices.length/2;for(let l=0,c=a.length;l<c;l+=2)n[a[l]*3]+""+n[a[l]*3+1]+n[a[l]*3+2]+n[a[l+1]*3]+n[a[l+1]*3+1]+n[a[l+1]*3+2]});{const s=e.indices;e.edgeIndices;const o=e.positionsCompressed;for(let a=0,n=s.length;a<n;a+=3){const l=o[s[a]*3]+"_"+o[s[a]*3+1]+"_"+o[s[a]*3+2]+"/"+o[s[a+1]*3]+"_"+o[s[a+1]*3+1]+"_"+o[s[a+1]*3+2]+"/"+o[s[a+2]*3]+"_"+o[s[a+2]*3+1]+"_"+o[s[a+2]*3+2];if(!(l in t))throw console.log("Not found "+l),"Ohhhh!"}}}const Ni=A.vec4(4),io=A.vec4(),qu=A.vec4(),Hb=A.vec3([1,0,0]),jb=A.vec3([0,1,0]),zb=A.vec3([0,0,1]);A.vec3(3);A.vec3(3);const Gb=A.identityMat4();class Wb{constructor(e){this._model=e.model,this.id=e.id,this._parentTransform=e.parent,this._childTransforms=[],this._meshes=[],this._scale=new Float32Array([1,1,1]),this._quaternion=A.identityQuaternion(new Float32Array(4)),this._rotation=new Float32Array(3),this._position=new Float32Array(3),this._localMatrix=A.identityMat4(new Float32Array(16)),this._worldMatrix=A.identityMat4(new Float32Array(16)),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,e.matrix?this.matrix=e.matrix:(this.scale=e.scale,this.position=e.position,e.quaternion||(this.rotation=e.rotation)),e.parent&&e.parent._addChildTransform(this)}_addChildTransform(e){this._childTransforms.push(e),e._parentTransform=this,e._transformDirty(),e._setSubtreeAABBsDirty(this)}_addMesh(e){this._meshes.push(e),e.transform=this}get parentTransform(){return this._parentTransform}get meshes(){return this._meshes}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._model.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),A.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._model.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),A.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._model.glRedraw()}get quaternion(){return this._quaternion}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._model.glRedraw()}get scale(){return this._scale}set matrix(e){this._localMatrix||(this._localMatrix=A.identityMat4()),this._localMatrix.set(e||Gb),A.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._transformDirty(),this._model.glRedraw()}get matrix(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=A.identityMat4()),A.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}rotate(e,t){return Ni[0]=e[0],Ni[1]=e[1],Ni[2]=e[2],Ni[3]=t*A.DEGTORAD,A.angleAxisToQuaternion(Ni,io),A.mulQuaternions(this.quaternion,io,qu),this.quaternion=qu,this._setLocalMatrixDirty(),this._model.glRedraw(),this}rotateOnWorldAxis(e,t){return Ni[0]=e[0],Ni[1]=e[1],Ni[2]=e[2],Ni[3]=t*A.DEGTORAD,A.angleAxisToQuaternion(Ni,io),A.mulQuaternions(io,this.quaternion,io),this}rotateX(e){return this.rotate(Hb,e)}rotateY(e){return this.rotate(jb,e)}rotateZ(e){return this.rotate(zb,e)}translate(e){return this._position[0]+=e[0],this._position[1]+=e[1],this._position[2]+=e[2],this._setLocalMatrixDirty(),this._model.glRedraw(),this}translateX(e){return this._position[0]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}translateY(e){return this._position[1]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}translateZ(e){return this._position[2]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._transformDirty()}_transformDirty(){this._worldMatrixDirty=!0;for(let e=0,t=this._childTransforms.length;e<t;e++){const i=this._childTransforms[e];if(i._transformDirty(),i._meshes&&i._meshes.length>0){const s=i._meshes;for(let o=0,a=s.length;o<a;o++)s[o]._transformDirty()}}if(this._meshes&&this._meshes.length>0){const e=this._meshes;for(let t=0,i=e.length;t<i;t++)e[t]._transformDirty()}}_buildWorldMatrix(){const e=this.matrix;if(this._parentTransform)A.mulMat4(this._parentTransform.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_setSubtreeAABBsDirty(e){if(e._aabbDirty=!0,e._childTransforms)for(let t=0,i=e._childTransforms.length;t<i;t++)this._setSubtreeAABBsDirty(e._childTransforms[t])}}const Ju=A.vec3(),Zi=A.OBB3(),En=A.vec4(),ed=A.vec3([1,1,1]),td=A.vec3([0,0,0]);A.vec3([0,0,0]);const id=A.identityQuaternion(),Kb=A.identityMat4(),Ol="defaultColorTexture",kl="defaultMetalRoughTexture",Nl="defaultNormalsTexture",Ql="defaultEmissiveTexture",Vl="defaultOcclusionTexture",sd="defaultTextureSet",Hl=new Uint8Array([255,255,255]),so=0,ro=1,sr=2;class Xb extends vt{constructor(e,t={}){super(e,t),this.renderOrder=t.renderOrder||0,this._dtxEnabled=this.scene.dtxEnabled&&t.dtxEnabled!==!1,this._enableVertexWelding=!1,this._enableIndexBucketing=!1,this._vboBatchingLayerScratchMemory=Qv(),this._textureTranscoder=t.textureTranscoder||Db(this.scene.viewer),this._maxGeometryBatchSize=t.maxGeometryBatchSize,this._aabb=A.collapseAABB3(),this._aabbDirty=!0,this._quantizationRanges={},this._vboInstancingLayers={},this._vboBatchingLayers={},this._dtxLayers={},this._meshList=[],this.layerList=[],this._layersToFinalize=[],this._entityList=[],this._entitiesToFinalize=[],this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={},this._transforms={},this._meshes={},this._unusedMeshes={},this._entities={},this.renderFlags=new Tf,this.numGeometries=0,this.numPortions=0,this.numVisibleLayerPortions=0,this.numTransparentLayerPortions=0,this.numXRayedLayerPortions=0,this.numHighlightedLayerPortions=0,this.numSelectedLayerPortions=0,this.numEdgesLayerPortions=0,this.numPickableLayerPortions=0,this.numClippableLayerPortions=0,this.numCulledLayerPortions=0,this.numEntities=0,this._numTriangles=0,this._numLines=0,this._numPoints=0,this._layersFinalized=!1,this._edgeThreshold=t.edgeThreshold||10,this._origin=A.vec3(t.origin||[0,0,0]),this._position=A.vec3(t.position||[0,0,0]),this._rotation=A.vec3(t.rotation||[0,0,0]),this._quaternion=A.vec4(t.quaternion||[0,0,0,1]),this._conjugateQuaternion=A.vec4(t.quaternion||[0,0,0,1]),t.rotation&&A.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._scale=A.vec3(t.scale||[1,1,1]),this._worldRotationMatrix=A.mat4(),this._worldRotationMatrixConjugate=A.mat4(),this._matrix=A.mat4(),this._matrixDirty=!0,this._rebuildMatrices(),this._worldNormalMatrix=A.mat4(),A.inverseMat4(this._matrix,this._worldNormalMatrix),A.transposeMat4(this._worldNormalMatrix),(t.matrix||t.position||t.rotation||t.scale||t.quaternion)&&(this._viewMatrix=A.mat4(),this._viewNormalMatrix=A.mat4(),this._viewMatrixDirty=!0,this._matrixNonIdentity=!0),this._opacity=1,this._colorize=[1,1,1],this._saoEnabled=t.saoEnabled!==!1,this._pbrEnabled=t.pbrEnabled!==!1,this._colorTextureEnabled=t.colorTextureEnabled!==!1,this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this._onCameraViewMatrix=this.scene.camera.on("matrix",()=>{this._viewMatrixDirty=!0}),this._meshesWithDirtyMatrices=[],this._numMeshesWithDirtyMatrices=0,this._onTick=this.scene.on("tick",()=>{for(;this._numMeshesWithDirtyMatrices>0;)this._meshesWithDirtyMatrices[--this._numMeshesWithDirtyMatrices]._updateMatrix()}),this._createDefaultTextureSet(),this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.colorize=t.colorize,this.opacity=t.opacity,this.backfaces=t.backfaces}_meshMatrixDirty(e){this._meshesWithDirtyMatrices[this._numMeshesWithDirtyMatrices++]=e}_createDefaultTextureSet(){const e=new ir({id:Ol,texture:new ms({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})}),t=new ir({id:kl,texture:new ms({gl:this.scene.canvas.gl,preloadColor:[0,1,1,1]})}),i=new ir({id:Nl,texture:new ms({gl:this.scene.canvas.gl,preloadColor:[0,0,0,0]})}),s=new ir({id:Ql,texture:new ms({gl:this.scene.canvas.gl,preloadColor:[0,0,0,1]})}),o=new ir({id:Vl,texture:new ms({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})});this._textures[Ol]=e,this._textures[kl]=t,this._textures[Nl]=i,this._textures[Ql]=s,this._textures[Vl]=o,this._textureSets[sd]=new Xu({id:sd,model:this,colorTexture:e,metallicRoughnessTexture:t,normalsTexture:i,emissiveTexture:s,occlusionTexture:o})}get isPerformanceModel(){return!0}get transforms(){return this._transforms}get textures(){return this._textures}get textureSets(){return this._textureSets}get meshes(){return this._meshes}get objects(){return this._entities}get origin(){return this._origin}set position(e){this._position.set(e||[0,0,0]),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),A.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),A.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set scale(e){}get scale(){return this._scale}set matrix(e){this._matrix.set(e||Kb),A.decomposeMat4(this._matrix,this._position,this._quaternion,this._scale),this._matrixDirty=!1,this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get matrix(){return this._rebuildMatrices(),this._matrix}get rotationMatrix(){return this._rebuildMatrices(),this._worldRotationMatrix}_rebuildMatrices(){this._matrixDirty&&(A.quaternionToRotationMat4(this._quaternion,this._worldRotationMatrix),A.conjugateQuaternion(this._quaternion,this._conjugateQuaternion),A.quaternionToRotationMat4(this._conjugateQuaternion,this._worldRotationMatrixConjugate),A.scaleMat4v(this._scale,this._worldRotationMatrix),A.scaleMat4v(this._scale,this._worldRotationMatrixConjugate),this._matrix.set(this._worldRotationMatrix),A.translateMat4v(this._position,this._matrix),this._matrixDirty=!1,this._viewMatrixDirty=!0)}get rotationMatrixConjugate(){return this._rebuildMatrices(),this._worldRotationMatrixConjugate}_setWorldMatrixDirty(){this._matrixDirty=!0,this._aabbDirty=!0}_transformDirty(){this._matrixDirty=!0,this._aabbDirty=!0,this.scene._aabbDirty=!0}_sceneModelDirty(){this.scene._aabbDirty=!0,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._matrixDirty=!0;for(let e=0,t=this._entityList.length;e<t;e++)this._entityList[e]._sceneModelDirty()}get worldMatrix(){return this.matrix}get worldNormalMatrix(){return this._worldNormalMatrix}_rebuildViewMatrices(){this._rebuildMatrices(),this._viewMatrixDirty&&(A.mulMat4(this.scene.camera.viewMatrix,this._matrix,this._viewMatrix),A.inverseMat4(this._viewMatrix,this._viewNormalMatrix),A.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1)}get viewMatrix(){return this._viewMatrix?(this._rebuildViewMatrices(),this._viewMatrix):this.scene.camera.viewMatrix}get viewNormalMatrix(){return this._viewNormalMatrix?(this._rebuildViewMatrices(),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix}get backfaces(){return this._backfaces}set backfaces(e){e=!!e,this._backfaces=e,this.glRedraw()}get entityList(){return this._entityList}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return!1}get aabb(){if(this._aabbDirty){A.collapseAABB3(this._aabb);for(let e=0,t=this._entityList.length;e<t;e++)A.expandAABB3(this._aabb,this._entityList[e].aabb);this._aabbDirty=!1}return this._aabb}get numTriangles(){return this._numTriangles}get numLines(){return this._numLines}get numPoints(){return this._numPoints}get visible(){return this.numVisibleLayerPortions>0}set visible(e){e=e!==!1,this._visible=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].visible=e;this.glRedraw()}get xrayed(){return this.numXRayedLayerPortions>0}set xrayed(e){e=!!e,this._xrayed=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].xrayed=e;this.glRedraw()}get highlighted(){return this.numHighlightedLayerPortions>0}set highlighted(e){e=!!e,this._highlighted=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].highlighted=e;this.glRedraw()}get selected(){return this.numSelectedLayerPortions>0}set selected(e){e=!!e,this._selected=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].selected=e;this.glRedraw()}get edges(){return this.numEdgesLayerPortions>0}set edges(e){e=!!e,this._edges=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].edges=e;this.glRedraw()}get culled(){return this._culled}set culled(e){e=!!e,this._culled=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].culled=e;this.glRedraw()}get clippable(){return this._clippable}set clippable(e){e=e!==!1,this._clippable=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].clippable=e;this.glRedraw()}get collidable(){return this._collidable}set collidable(e){e=e!==!1,this._collidable=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].collidable=e}get pickable(){return this.numPickableLayerPortions>0}set pickable(e){e=e!==!1,this._pickable=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].pickable=e}get colorize(){return this._colorize}set colorize(e){this._colorize=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].colorize=e}get opacity(){return this._opacity}set opacity(e){this._opacity=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].opacity=e}get castsShadow(){return this._castsShadow}set castsShadow(e){e=e!==!1,e!==this._castsShadow&&(this._castsShadow=e,this.glRedraw())}get receivesShadow(){return this._receivesShadow}set receivesShadow(e){e=e!==!1,e!==this._receivesShadow&&(this._receivesShadow=e,this.glRedraw())}get saoEnabled(){return this._saoEnabled}get pbrEnabled(){return this._pbrEnabled}get colorTextureEnabled(){return this._colorTextureEnabled}get isDrawable(){return!0}get isStateSortable(){return!1}get xrayMaterial(){return this.scene.xrayMaterial}get highlightMaterial(){return this.scene.highlightMaterial}get selectedMaterial(){return this.scene.selectedMaterial}get edgeMaterial(){return this.scene.edgeMaterial}getPickViewMatrix(e){return this._viewMatrix?this._viewMatrix:e}createQuantizationRange(e){if(e.id===void 0||e.id===null){this.error("[createQuantizationRange] Config missing: id");return}if(e.aabb){this.error("[createQuantizationRange] Config missing: aabb");return}if(this._quantizationRanges[e.id]){this.error("[createQuantizationRange] QuantizationRange already created: "+e.id);return}this._quantizationRanges[e.id]={id:e.id,aabb:e.aabb,matrix:vl(e.aabb,A.mat4())}}createGeometry(e){if(e.id===void 0||e.id===null){this.error("[createGeometry] Config missing: id");return}if(this._geometries[e.id]){this.error("[createGeometry] Geometry already created: "+e.id);return}if((e.primitive===void 0||e.primitive===null)&&(e.primitive="triangles"),e.primitive!=="points"&&e.primitive!=="lines"&&e.primitive!=="triangles"&&e.primitive!=="solid"&&e.primitive!=="surface"){this.error(`[createGeometry] Unsupported value for 'primitive': '${e.primitive}' - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'. Defaulting to 'triangles'.`);return}if(!e.positions&&!e.positionsCompressed&&!e.buckets)return this.error("[createGeometry] Param expected: `positions`,  `positionsCompressed' or 'buckets"),null;if(e.positionsCompressed&&!e.positionsDecodeMatrix&&!e.positionsDecodeBoundary)return this.error("[createGeometry] Param expected: `positionsDecodeMatrix` or 'positionsDecodeBoundary' (required for `positionsCompressed')"),null;if(e.positionsDecodeMatrix&&e.positionsDecodeBoundary)return this.error("[createGeometry] Only one of these params expected: `positionsDecodeMatrix` or 'positionsDecodeBoundary' (required for `positionsCompressed')"),null;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("[createGeometry] Param expected: `uvDecodeMatrix` (required for `uvCompressed')"),null;if(!e.buckets&&!e.indices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")){const t=(e.positions||e.positionsCompressed).length/3;e.indices=this._createDefaultIndices(t)}if(!e.buckets&&!e.indices&&e.primitive!=="points")return this.error(`[createGeometry] Param expected: indices (required for '${e.primitive}' primitive type)`),null;if(e.positionsDecodeBoundary&&(e.positionsDecodeMatrix=vl(e.positionsDecodeBoundary,A.mat4())),e.positions){const t=A.collapseAABB3();e.positionsDecodeMatrix=A.mat4(),A.expandAABB3Points3(t,e.positions),e.positionsCompressed=Io(e.positions,t,e.positionsDecodeMatrix),e.aabb=t}else if(e.positionsCompressed){const t=A.collapseAABB3();e.positionsDecodeMatrix=new Float64Array(e.positionsDecodeMatrix),e.positionsCompressed=new Uint16Array(e.positionsCompressed),A.expandAABB3Points3(t,e.positionsCompressed),at.decompressAABB(t,e.positionsDecodeMatrix),e.aabb=t}else if(e.buckets){const t=A.collapseAABB3();this._dtxBuckets[e.id]=e.buckets;for(let i=0,s=e.buckets.length;i<s;i++){const o=e.buckets[i];o.positions?A.expandAABB3Points3(t,o.positions):o.positionsCompressed&&A.expandAABB3Points3(t,o.positionsCompressed)}e.positionsDecodeMatrix&&at.decompressAABB(t,e.positionsDecodeMatrix),e.aabb=t}if(e.colorsCompressed&&e.colorsCompressed.length>0)e.colorsCompressed=new Uint8Array(e.colorsCompressed);else if(e.colors&&e.colors.length>0){const t=e.colors,i=new Uint8Array(t.length);for(let s=0,o=t.length;s<o;s++)i[s]=t[s]*255;e.colorsCompressed=i}if(!e.buckets&&!e.edgeIndices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")&&(e.positions?e.edgeIndices=ps(e.positions,e.indices,null,5):e.edgeIndices=ps(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.uv){const t=at.getUVBounds(e.uv),i=at.compressUVs(e.uv,t.min,t.max);e.uvCompressed=i.quantized,e.uvDecodeMatrix=i.decodeMatrix}else e.uvCompressed&&(e.uvCompressed=new Uint16Array(e.uvCompressed),e.uvDecodeMatrix=new Float64Array(e.uvDecodeMatrix));e.normals&&(e.normals=null),this._geometries[e.id]=e,this._numTriangles+=e.indices?Math.round(e.indices.length/3):0,this.numGeometries++}createTexture(e){const t=e.id;if(t==null){this.error("[createTexture] Config missing: id");return}if(this._textures[t]){this.error("[createTexture] Texture already created: "+t);return}if(!e.src&&!e.image&&!e.buffers)return this.error("[createTexture] Param expected: `src`, `image' or 'buffers'"),null;let i=e.minFilter||xo;i!==Si&&i!==hc&&i!==xo&&i!==cc&&i!==Ac&&(this.error(`[createTexture] Unsupported value for 'minFilter' - 
            supported values are LinearFilter, LinearMipMapNearestFilter, NearestMipMapNearestFilter, 
            NearestMipMapLinearFilter and LinearMipmapLinearFilter. Defaulting to LinearMipmapLinearFilter.`),i=xo);let s=e.magFilter||Si;s!==Si&&s!==La&&(this.error("[createTexture] Unsupported value for 'magFilter' - supported values are LinearFilter and NearestFilter. Defaulting to LinearFilter."),s=Si);let o=e.wrapS||Vt;o!==Bs&&o!==Po&&o!==Vt&&(this.error("[createTexture] Unsupported value for 'wrapS' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),o=Vt);let a=e.wrapT||Vt;a!==Bs&&a!==Po&&a!==Vt&&(this.error("[createTexture] Unsupported value for 'wrapT' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),a=Vt);let n=e.wrapR||Vt;n!==Bs&&n!==Po&&n!==Vt&&(this.error("[createTexture] Unsupported value for 'wrapR' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),n=Vt);let l=e.encoding||os;l!==os&&l!==Et&&(this.error("[createTexture] Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),l=os);const c=new ms({gl:this.scene.canvas.gl,minFilter:i,magFilter:s,wrapS:o,wrapT:a,wrapR:n,encoding:l});if(e.preloadColor&&c.setPreloadColor(e.preloadColor),e.image){const h=e.image;if(h.crossOrigin="Anonymous",h.compressed){const d=h.data;c.setCompressedData({mipmaps:d,props:{format:d[0].format,minFilter:i,magFilter:s}})}else c.setImage(h,{minFilter:i,magFilter:s,wrapS:o,wrapT:a,wrapR:n,flipY:e.flipY,encoding:l})}else if(e.src){const h=e.src.split(".").pop();switch(h){case"jpeg":case"jpg":case"png":case"gif":const d=new Image;d.onload=()=>{c.setImage(d,{minFilter:i,magFilter:s,wrapS:o,wrapT:a,wrapR:n,flipY:e.flipY,encoding:l}),this.glRedraw()},d.src=e.src;break;default:this._textureTranscoder?we.loadArraybuffer(e.src,p=>{if(!p.byteLength){this.error("[createTexture] Can't create texture from 'src': file data is zero length");return}this._textureTranscoder.transcode([p],c).then(()=>{this.glRedraw()})},function(p){this.error(`[createTexture] Can't create texture from 'src': ${p}`)}):this.error(`[createTexture] Can't create texture from 'src' - SceneModel needs to be configured with a TextureTranscoder for this file type ('${h}')`);break}}else e.buffers&&(this._textureTranscoder?this._textureTranscoder.transcode(e.buffers,c).then(()=>{this.glRedraw()}):this.error("[createTexture] Can't create texture from 'buffers' - SceneModel needs to be configured with a TextureTranscoder for this option"));this._textures[t]=new ir({id:t,texture:c})}createTextureSet(e){const t=e.id;if(t==null){this.error("[createTextureSet] Config missing: id");return}if(this._textureSets[t]){this.error(`[createTextureSet] Texture set already created: ${t}`);return}let i;if(e.colorTextureId!==void 0&&e.colorTextureId!==null){if(i=this._textures[e.colorTextureId],!i){this.error(`[createTextureSet] Texture not found: ${e.colorTextureId} - ensure that you create it first with createTexture()`);return}}else i=this._textures[Ol];let s;if(e.metallicRoughnessTextureId!==void 0&&e.metallicRoughnessTextureId!==null){if(s=this._textures[e.metallicRoughnessTextureId],!s){this.error(`[createTextureSet] Texture not found: ${e.metallicRoughnessTextureId} - ensure that you create it first with createTexture()`);return}}else s=this._textures[kl];let o;if(e.normalsTextureId!==void 0&&e.normalsTextureId!==null){if(o=this._textures[e.normalsTextureId],!o){this.error(`[createTextureSet] Texture not found: ${e.normalsTextureId} - ensure that you create it first with createTexture()`);return}}else o=this._textures[Nl];let a;if(e.emissiveTextureId!==void 0&&e.emissiveTextureId!==null){if(a=this._textures[e.emissiveTextureId],!a){this.error(`[createTextureSet] Texture not found: ${e.emissiveTextureId} - ensure that you create it first with createTexture()`);return}}else a=this._textures[Ql];let n;if(e.occlusionTextureId!==void 0&&e.occlusionTextureId!==null){if(n=this._textures[e.occlusionTextureId],!n){this.error(`[createTextureSet] Texture not found: ${e.occlusionTextureId} - ensure that you create it first with createTexture()`);return}}else n=this._textures[Vl];const l=new Xu({id:t,model:this,colorTexture:i,alphaCutoff:e.alphaCutoff,metallicRoughnessTexture:s,normalsTexture:o,emissiveTexture:a,occlusionTexture:n});return this._textureSets[t]=l,l}createTransform(e){if(e.id===void 0||e.id===null){this.error("[createTransform] SceneModel.createTransform() config missing: id");return}if(this._transforms[e.id]){this.error(`[createTransform] SceneModel already has a transform with this ID: ${e.id}`);return}let t;if(e.parentTransformId&&(t=this._transforms[e.parentTransformId],!t)){this.error("[createTransform] SceneModel.createTransform() config missing: id");return}const i=new Wb({id:e.id,model:this,parent:t,matrix:e.matrix,position:e.position,scale:e.scale,rotation:e.rotation,quaternion:e.quaternion});return this._transforms[i.id]=i,i}createMesh(e){if(e.id===void 0||e.id===null)return this.error("[createMesh] SceneModel.createMesh() config missing: id"),!1;if(this._meshes[e.id])return this.error(`[createMesh] SceneModel already has a mesh with this ID: ${e.id}`),!1;if(!(e.geometryId!==void 0)){if((e.primitive===void 0||e.primitive===null)&&(e.primitive="triangles"),e.primitive!=="points"&&e.primitive!=="lines"&&e.primitive!=="triangles"&&e.primitive!=="solid"&&e.primitive!=="surface")return this.error(`Unsupported value for 'primitive': '${primitive}'  ('geometryId' is absent) - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'.`),!1;if(!e.positions&&!e.positionsCompressed&&!e.buckets)return this.error("Param expected: 'positions',  'positionsCompressed' or `buckets`  ('geometryId' is absent)"),!1;if(e.positions&&(e.positionsDecodeMatrix||e.positionsDecodeBoundary))return this.error("Illegal params: 'positions' not expected with 'positionsDecodeMatrix'/'positionsDecodeBoundary' ('geometryId' is absent)"),!1;if(e.positionsCompressed&&!e.positionsDecodeMatrix&&!e.positionsDecodeBoundary)return this.error("Param expected: 'positionsCompressed' should be accompanied by 'positionsDecodeMatrix'/'positionsDecodeBoundary' ('geometryId' is absent)"),!1;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("Param expected: 'uvCompressed' should be accompanied by `uvDecodeMatrix` ('geometryId' is absent)"),!1;if(!e.buckets&&!e.indices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")){const o=(e.positions||e.positionsCompressed).length/3;e.indices=this._createDefaultIndices(o)}if(!e.buckets&&!e.indices&&e.primitive!=="points")return e.indices=this._createDefaultIndices(numIndices),this.error(`Param expected: indices (required for '${e.primitive}' primitive type)`),!1;if((e.matrix||e.position||e.rotation||e.scale)&&(e.positionsCompressed||e.positionsDecodeBoundary))return this.error("Unexpected params: 'matrix', 'rotation', 'scale', 'position' not allowed with 'positionsCompressed'"),!1;const s=!!this._dtxEnabled&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")&&!e.textureSetId;if(e.origin=e.origin?A.addVec3(this._origin,e.origin,A.vec3()):this._origin,e.matrix)e.meshMatrix=e.matrix;else if(e.scale||e.rotation||e.position||e.quaternion){const o=e.scale||ed,a=e.position||td;e.rotation?(A.eulerToQuaternion(e.rotation,"XYZ",En),e.meshMatrix=A.composeMat4(a,En,o,A.mat4())):e.meshMatrix=A.composeMat4(a,e.quaternion||id,o,A.mat4())}if(e.positionsDecodeBoundary&&(e.positionsDecodeMatrix=vl(e.positionsDecodeBoundary,A.mat4())),s){if(e.type=sr,e.color=e.color?new Uint8Array([Math.floor(e.color[0]*255),Math.floor(e.color[1]*255),Math.floor(e.color[2]*255)]):Hl,e.opacity=e.opacity!==void 0&&e.opacity!==null?Math.floor(e.opacity*255):255,e.positions){const o=A.vec3(),a=[];th(e.positions,a,o)&&(e.positions=a,e.origin=A.addVec3(e.origin,o,o))}if(e.positions){const o=A.collapseAABB3();e.positionsDecodeMatrix=A.mat4(),A.expandAABB3Points3(o,e.positions),e.positionsCompressed=Io(e.positions,o,e.positionsDecodeMatrix),e.aabb=o}else if(e.positionsCompressed){const o=A.collapseAABB3();A.expandAABB3Points3(o,e.positionsCompressed),at.decompressAABB(o,e.positionsDecodeMatrix),e.aabb=o}if(e.buckets){const o=A.collapseAABB3();for(let a=0,n=e.buckets.length;a<n;a++){const l=e.buckets[a];l.positions?A.expandAABB3Points3(o,l.positions):l.positionsCompressed&&A.expandAABB3Points3(o,l.positionsCompressed)}e.positionsDecodeMatrix&&at.decompressAABB(o,e.positionsDecodeMatrix),e.aabb=o}e.meshMatrix&&(A.AABB3ToOBB3(e.aabb,Zi),A.transformOBB3(e.meshMatrix,Zi),A.OBB3ToAABB3(Zi,e.aabb)),!e.buckets&&!e.edgeIndices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")&&(e.positions?e.edgeIndices=ps(e.positions,e.indices,null,2):e.edgeIndices=ps(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.buckets||(e.buckets=rd(e,this._enableVertexWelding&&this._enableIndexBucketing))}else{if(e.type=ro,e.color=e.color?new Uint8Array([Math.floor(e.color[0]*255),Math.floor(e.color[1]*255),Math.floor(e.color[2]*255)]):[255,255,255],e.opacity=e.opacity!==void 0&&e.opacity!==null?Math.floor(e.opacity*255):255,e.metallic=e.metallic!==void 0&&e.metallic!==null?Math.floor(e.metallic*255):0,e.roughness=e.roughness!==void 0&&e.roughness!==null?Math.floor(e.roughness*255):255,e.positions){const o=[];th(e.positions,o,Ju)&&(e.positions=o,e.origin=A.addVec3(e.origin,Ju,A.vec3()))}if(e.positions){const o=A.collapseAABB3();e.meshMatrix&&(A.transformPositions3(e.meshMatrix,e.positions,e.positions),e.meshMatrix=null),A.expandAABB3Points3(o,e.positions),e.aabb=o}else{const o=A.collapseAABB3();A.expandAABB3Points3(o,e.positionsCompressed),at.decompressAABB(o,e.positionsDecodeMatrix),e.aabb=o}if(e.meshMatrix&&(A.AABB3ToOBB3(e.aabb,Zi),A.transformOBB3(e.meshMatrix,Zi),A.OBB3ToAABB3(Zi,e.aabb)),!e.buckets&&!e.edgeIndices&&(e.primitive==="triangles"||e.primitive==="solid"||e.primitive==="surface")&&(e.positions?e.edgeIndices=ps(e.positions,e.indices,null,2):e.edgeIndices=ps(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.textureSetId&&(e.textureSet=this._textureSets[e.textureSetId],!e.textureSet))return this.error(`[createMesh] Texture set not found: ${e.textureSetId} - ensure that you create it first with createTextureSet()`),!1}}else{if(e.positions||e.positionsCompressed||e.indices||e.edgeIndices||e.normals||e.normalsCompressed||e.uv||e.uvCompressed||e.positionsDecodeMatrix)return this.error("Mesh geometry parameters not expected when instancing a geometry (not expected: positions, positionsCompressed, indices, edgeIndices, normals, normalsCompressed, uv, uvCompressed, positionsDecodeMatrix)"),!1;if(e.geometry=this._geometries[e.geometryId],!e.geometry)return this.error(`[createMesh] Geometry not found: ${e.geometryId} - ensure that you create it first with createGeometry()`),!1;if(e.origin=e.origin?A.addVec3(this._origin,e.origin,A.vec3()):this._origin,e.positionsDecodeMatrix=e.geometry.positionsDecodeMatrix,e.transformId){if(e.transform=this._transforms[e.transformId],!e.transform)return this.error(`[createMesh] Transform not found: ${e.transformId} - ensure that you create it first with createTransform()`),!1;e.aabb=e.geometry.aabb}else{if(e.matrix)e.meshMatrix=e.matrix;else if(e.scale||e.rotation||e.position||e.quaternion){const o=e.scale||ed,a=e.position||td;e.rotation?(A.eulerToQuaternion(e.rotation,"XYZ",En),e.meshMatrix=A.composeMat4(a,En,o,A.mat4())):e.meshMatrix=A.composeMat4(a,e.quaternion||id,o,A.mat4())}A.AABB3ToOBB3(e.geometry.aabb,Zi),A.transformOBB3(e.meshMatrix,Zi),e.aabb=A.OBB3ToAABB3(Zi,A.AABB3())}if(!!this._dtxEnabled&&(e.geometry.primitive==="triangles"||e.geometry.primitive==="solid"||e.geometry.primitive==="surface")&&!e.textureSetId){e.type=sr,e.color=e.color?new Uint8Array([Math.floor(e.color[0]*255),Math.floor(e.color[1]*255),Math.floor(e.color[2]*255)]):Hl,e.opacity=e.opacity!==void 0&&e.opacity!==null?Math.floor(e.opacity*255):255;let o=this._dtxBuckets[e.geometryId];o||(o=rd(e.geometry,this._enableVertexWelding,this._enableIndexBucketing),this._dtxBuckets[e.geometryId]=o),e.buckets=o}else e.type=so,e.color=e.color?new Uint8Array([Math.floor(e.color[0]*255),Math.floor(e.color[1]*255),Math.floor(e.color[2]*255)]):Hl,e.opacity=e.opacity!==void 0&&e.opacity!==null?Math.floor(e.opacity*255):255,e.metallic=e.metallic!==void 0&&e.metallic!==null?Math.floor(e.metallic*255):0,e.roughness=e.roughness!==void 0&&e.roughness!==null?Math.floor(e.roughness*255):255,e.textureSetId&&(e.textureSet=this._textureSets[e.textureSetId])}return e.numPrimitives=this._getNumPrimitives(e),this._createMesh(e)}_createDefaultIndices(e){const t=[];for(let i=0;i<e;i++)t.push(i);return t}_createMesh(e){const t=new kv(this,e.id,e.color,e.opacity,e.transform,e.textureSet);t.pickId=this.scene._renderer.getPickID(t);const i=t.pickId,s=i>>24&255,o=i>>16&255,a=i>>8&255,n=i&255;switch(e.pickColor=new Uint8Array([n,a,o,s]),e.solid=e.primitive==="solid",t.origin=A.vec3(e.origin),e.type){case sr:t.layer=this._getDTXLayer(e),t.aabb=e.aabb;break;case ro:t.layer=this._getVBOBatchingLayer(e),t.aabb=e.aabb;break;case so:t.layer=this._getVBOInstancingLayer(e),t.aabb=e.aabb;break}return e.transform&&(e.meshMatrix=e.transform.worldMatrix),t.portionId=t.layer.createPortion(t,e),t.numPrimitives=e.numPrimitives,this._meshes[e.id]=t,this._unusedMeshes[e.id]=t,this._meshList.push(t),t}_getNumPrimitives(e){let t=0;switch(e.geometry?e.geometry.primitive:e.primitive){case"triangles":case"solid":case"surface":switch(e.type){case sr:for(let s=0,o=e.buckets.length;s<o;s++)t+=e.buckets[s].indices.length;break;case ro:t+=e.indices.length;break;case so:t+=e.geometry.indices.length;break}return Math.round(t/3);case"points":switch(e.type){case sr:for(let o=0,a=e.buckets.length;o<a;o++)t+=e.buckets[o].positionsCompressed.length;break;case ro:t+=e.positions?e.positions.length:e.positionsCompressed.length;break;case so:const s=e.geometry;t+=s.positions?s.positions.length:s.positionsCompressed.length;break}return Math.round(t);case"lines":case"line-strip":switch(e.type){case sr:for(let s=0,o=e.buckets.length;s<o;s++)t+=e.buckets[s].indices.length;break;case ro:t+=e.indices.length;break;case so:t+=e.geometry.indices.length;break}return Math.round(t/2)}return 0}_getDTXLayer(e){const t=e.origin,i=e.geometry?e.geometry.primitive:e.primitive,s=`.${i}.${Math.round(t[0])}.${Math.round(t[1])}.${Math.round(t[2])}`;let o=this._dtxLayers[s];if(o)if(!o.canCreatePortion(e))delete this._dtxLayers[s],o=null;else return o;switch(i){case"triangles":case"solid":case"surface":o=new Cb(this,{layerIndex:0,origin:t,primitive:i});break;case"lines":o=new My(this,{layerIndex:0,origin:t,primitive:i});break;default:return}return this._dtxLayers[s]=o,this.layerList.push(o),this._layersToFinalize.push(o),o}_getVBOBatchingLayer(e){const t=this,i=e.origin;e.renderLayer;const s=e.positionsDecodeMatrix||e.positionsDecodeBoundary?this._createHashStringFromMatrix(e.positionsDecodeMatrix||e.positionsDecodeBoundary):"-",o=e.textureSetId||"-",a=`${Math.round(i[0])}.${Math.round(i[1])}.${Math.round(i[2])}.${e.primitive}.${s}.${o}`;let n=this._vboBatchingLayers[a];if(n)return n;let l=e.textureSet;for(;!n;){switch(e.primitive){case"triangles":n=new Pl({model:t,textureSet:l,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:e.primitive==="solid",autoNormals:!0,primitive:e.primitive});break;case"solid":n=new Pl({model:t,textureSet:l,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:e.primitive==="solid",autoNormals:!0,primitive:e.primitive});break;case"surface":n=new Pl({model:t,textureSet:l,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:e.primitive==="solid",autoNormals:!0,primitive:e.primitive});break;case"lines":n=new mx({model:t,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,primitive:e.primitive});break;case"points":n=new Yx({model:t,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,primitive:e.primitive});break}const c=e.positionsCompressed?e.positionsCompressed.length:e.positions.length;(e.primitive==="points"?n.canCreatePortion(c):n.canCreatePortion(c,e.indices.length))||(n.finalize(),delete this._vboBatchingLayers[a],n=null)}return this._vboBatchingLayers[a]=n,this.layerList.push(n),this._layersToFinalize.push(n),n}_createHashStringFromMatrix(e){const t=e.join("");let i=0;for(let o=0;o<t.length;o++){const a=t.charCodeAt(o);i=(i<<5)-i+a,i|=0}return(i>>>0).toString(16)}_getVBOInstancingLayer(e){const t=this,i=e.origin,s=e.textureSetId||"-",o=e.geometryId,a=`${Math.round(i[0])}.${Math.round(i[1])}.${Math.round(i[2])}.${s}.${o}`;let n=this._vboInstancingLayers[a];if(n)return n;let l=e.textureSet;const c=e.geometry;for(;!n;)switch(c.primitive){case"triangles":n=new yl({model:t,textureSet:l,geometry:c,origin:i,layerIndex:0,solid:!1});break;case"solid":n=new yl({model:t,textureSet:l,geometry:c,origin:i,layerIndex:0,solid:!0});break;case"surface":n=new yl({model:t,textureSet:l,geometry:c,origin:i,layerIndex:0,solid:!1});break;case"lines":n=new Ix({model:t,textureSet:l,geometry:c,origin:i,layerIndex:0});break;case"points":n=new fy({model:t,textureSet:l,geometry:c,origin:i,layerIndex:0});break}return this._vboInstancingLayers[a]=n,this.layerList.push(n),this._layersToFinalize.push(n),n}createEntity(e){if(e.id===void 0?e.id=A.createUUID():this.scene.components[e.id]&&(this.error(`Scene already has a Component with this ID: ${e.id} - will assign random ID`),e.id=A.createUUID()),e.meshIds===void 0){this.error("Config missing: meshIds");return}let t=0;return this._visible&&e.visible!==!1&&(t=t|N.VISIBLE),this._pickable&&e.pickable!==!1&&(t=t|N.PICKABLE),this._culled&&e.culled!==!1&&(t=t|N.CULLED),this._clippable&&e.clippable!==!1&&(t=t|N.CLIPPABLE),this._collidable&&e.collidable!==!1&&(t=t|N.COLLIDABLE),this._edges&&e.edges!==!1&&(t=t|N.EDGES),this._xrayed&&e.xrayed!==!1&&(t=t|N.XRAYED),this._highlighted&&e.highlighted!==!1&&(t=t|N.HIGHLIGHTED),this._selected&&e.selected!==!1&&(t=t|N.SELECTED),e.flags=t,this._createEntity(e)}_createEntity(e){let t=[];for(let o=0,a=e.meshIds.length;o<a;o++){const n=e.meshIds[o];let l=this._meshes[n];if(!l){this.error(`Mesh with this ID not found: "${n}" - ignoring this mesh`);continue}if(l.parent){this.error(`Mesh with ID "${n}" already belongs to object with ID "${l.parent.id}" - ignoring this mesh`);continue}t.push(l),delete this._unusedMeshes[n]}const i=!0,s=new b_(this,e.isObject,e.id,t,e.flags,i);return this._entityList.push(s),this._entities[e.id]=s,this._entitiesToFinalize.push(s),this.numEntities++,s}preFinalize(){if(this.destroyed||this._layersToFinalize.length===0)return!1;this._createDummyEntityForUnusedMeshes();for(let e=0,t=this._layersToFinalize.length;e<t;e++)this._layersToFinalize[e].finalize();this._vboBatchingLayers={},this._vboInstancingLayers={},this._dtxLayers={},this._layersToFinalize=[];for(let e=0,t=this._entitiesToFinalize.length;e<t;e++)this._entitiesToFinalize[e]._finalize();for(let e=0,t=this._entitiesToFinalize.length;e<t;e++)this._entitiesToFinalize[e]._finalize2();this._entitiesToFinalize=[],this.scene._aabbDirty=!0,this._viewMatrixDirty=!0,this._matrixDirty=!0,this._aabbDirty=!0,this._setWorldMatrixDirty(),this._sceneModelDirty(),this.position=this._position,this.layerList.sort((e,t)=>e.sortId<t.sortId?-1:e.sortId>t.sortId?1:0);for(let e=0,t=this.layerList.length;e<t;e++){const i=this.layerList[e];i.layerIndex=e}this.glRedraw(),this._layersFinalized=!0}finalize(){this.destroyed||(this.preFinalize(),this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={})}stateSortCompare(e,t){}rebuildRenderFlags(){if(this.renderFlags.reset(),this._updateRenderFlagsVisibleLayers(),this.renderFlags.numLayers>0&&this.renderFlags.numVisibleLayers===0){this.renderFlags.culled=!0;return}this._updateRenderFlags()}_updateRenderFlagsVisibleLayers(){const e=this.renderFlags;e.numLayers=this.layerList.length,e.numVisibleLayers=0;for(let t=0,i=this.layerList.length;t<i;t++){const s=this.layerList[t];this._getActiveSectionPlanesForLayer(s)&&(e.visibleLayers[e.numVisibleLayers++]=t)}}_createDummyEntityForUnusedMeshes(){const e=Object.keys(this._unusedMeshes);if(e.length>0){const t=`${this.id}-${A.createUUID()}`;this.warn(`Creating dummy SceneModelEntity "${t}" for unused SceneMeshes: [${e.join(",")}]`),this.createEntity({id:t,meshIds:e,isObject:!0})}this._unusedMeshes={}}_getActiveSectionPlanesForLayer(e){const t=this.renderFlags,i=this.scene._sectionPlanesState.sectionPlanes,s=i.length,o=e.layerIndex*s;if(s>0)for(let a=0;a<s;a++)i[a].active?(t.sectionPlanesActivePerLayer[o+a]=!0,t.sectioned=!0):t.sectionPlanesActivePerLayer[o+a]=!1;return!0}_updateRenderFlags(){if(this.numVisibleLayerPortions===0||this.numCulledLayerPortions===this.numPortions)return;const e=this.renderFlags;if(e.colorOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.colorTransparent=!0),this.numXRayedLayerPortions>0){const t=this.scene.xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}if(this.numEdgesLayerPortions>0&&this.scene.edgeMaterial._state.edges&&(e.edgesOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.edgesTransparent=!0)),this.numSelectedLayerPortions>0){const t=this.scene.selectedMaterial._state;t.fill&&(t.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}if(this.numHighlightedLayerPortions>0){const t=this.scene.highlightMaterial._state;t.fill&&(t.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}drawColorOpaque(e,t){const i=this.renderFlags;for(let s=0,o=i.visibleLayers.length;s<o;s++){const a=i.visibleLayers[s];this.layerList[a].drawColorOpaque(i,e)}}drawColorTransparent(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawColorTransparent(t,e)}}drawDepth(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawDepth(t,e)}}drawNormals(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawNormals(t,e)}}drawSilhouetteXRayed(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawSilhouetteXRayed(t,e)}}drawSilhouetteHighlighted(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawSilhouetteHighlighted(t,e)}}drawSilhouetteSelected(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawSilhouetteSelected(t,e)}}drawEdgesColorOpaque(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawEdgesColorOpaque(t,e)}}drawEdgesColorTransparent(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawEdgesColorTransparent(t,e)}}drawEdgesXRayed(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawEdgesXRayed(t,e)}}drawEdgesHighlighted(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawEdgesHighlighted(t,e)}}drawEdgesSelected(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawEdgesSelected(t,e)}}drawOcclusion(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawOcclusion(t,e)}}drawShadow(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawShadow(t,e)}}setPickMatrices(e,t){if(this._numVisibleLayerPortions===0)return;const i=this.renderFlags;for(let s=0,o=i.visibleLayers.length;s<o;s++){const a=i.visibleLayers[s],n=this.layerList[a];n.setPickMatrices&&n.setPickMatrices(e,t)}}drawPickMesh(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawPickMesh(t,e)}}drawPickDepths(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawPickDepths(t,e)}}drawPickNormals(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i];this.layerList[o].drawPickNormals(t,e)}}drawSnapInit(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i],a=this.layerList[o];a.drawSnapInit&&(e.snapPickOrigin=[0,0,0],e.snapPickCoordinateScale=[1,1,1],e.snapPickLayerNumber++,a.drawSnapInit(t,e),e.snapPickLayerParams[e.snapPickLayerNumber]={origin:e.snapPickOrigin.slice(),coordinateScale:e.snapPickCoordinateScale.slice()})}}drawSnap(e){if(this.numVisibleLayerPortions===0)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const o=t.visibleLayers[i],a=this.layerList[o];a.drawSnap&&(e.snapPickOrigin=[0,0,0],e.snapPickCoordinateScale=[1,1,1],e.snapPickLayerNumber++,a.drawSnap(t,e),e.snapPickLayerParams[e.snapPickLayerNumber]={origin:e.snapPickOrigin.slice(),coordinateScale:e.snapPickCoordinateScale.slice()})}}destroy(){for(let e in this._vboBatchingLayers)this._vboBatchingLayers.hasOwnProperty(e)&&this._vboBatchingLayers[e].destroy();this._vboBatchingLayers={};for(let e in this._vboInstancingLayers)this._vboInstancingLayers.hasOwnProperty(e)&&this._vboInstancingLayers[e].destroy();this._vboInstancingLayers={},this.scene.camera.off(this._onCameraViewMatrix),this.scene.off(this._onTick);for(let e=0,t=this.layerList.length;e<t;e++)this.layerList[e].destroy();this.layerList=[];for(let e=0,t=this._entityList.length;e<t;e++)this._entityList[e]._destroy();this._layersToFinalize={},this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={},this._meshes={},this._entities={},this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this),Vv(),super.destroy()}}function rd(r,e,t){let i,s,o;e||t?[i,s,o]=Lb({positionsCompressed:r.positionsCompressed,indices:r.indices,edgeIndices:r.edgeIndices}):(i=r.positionsCompressed,s=r.indices,o=r.edgeIndices);let a;if(t){let n=i.length/3;a=Qb({positionsCompressed:i,indices:s,edgeIndices:o},n>65536?16:8)}else a=[{positionsCompressed:i,indices:s,edgeIndices:o}];return a}A.vec3();A.vec3();A.vec3();A.vec3();const Yb=A.vec3(),Rs=A.vec3(),hs=A.vec3();A.vec4();A.vec4();A.vec4();class $b extends vt{constructor(e,t={}){const i=e.viewer.scene;super(i,t),this.plugin=e;const s=t.container;if(!s)throw"config missing: container";this._color=t.color||e.defaultColor;const o=function(P,_){const b=[];let B=P!==void 0?!!P:_;return{reg:w=>b.push(w),get:()=>B,set:w=>{B=w!==void 0?!!w:_,b.forEach(C=>C(B))}}};this._visible=o(t.visible,e.defaultVisible),this._originVisible=o(t.originVisible,e.defaultOriginVisible),this._targetVisible=o(t.targetVisible,e.defaultTargetVisible),this._axisVisible=o(t.axisVisible,e.defaultAxisVisible),this._xAxisVisible=o(t.xAxisVisible,e.defaultAxisVisible),this._yAxisVisible=o(t.yAxisVisible,e.defaultAxisVisible),this._zAxisVisible=o(t.zAxisVisible,e.defaultAxisVisible),this._axisEnabled=o(!0,e.defaultAxisVisible),this._wireVisible=o(t.wireVisible,e.defaultWireVisible),this._xLabelEnabled=o(t.xLabelEnabled,e.defaultXLabelEnabled),this._yLabelEnabled=o(t.yLabelEnabled,e.defaultYLabelEnabled),this._zLabelEnabled=o(t.zLabelEnabled,e.defaultZLabelEnabled),this._lengthLabelEnabled=o(t.lengthLabelEnabled,e.defaultLengthLabelEnabled),this._labelsVisible=o(t.labelsVisible,e.defaultLabelsVisible),this._clickable=o(!1,!1),this._labelsOnWires=o(t.labelsOnWires,e.defaultLabelsOnWires),this._useRotationAdjustment=o(t.useRotationAdjustment,e.useRotationAdjustment),this._axesBasis=A.identityMat4(),this.approximate=t.approximate;const a=i.canvas.canvas,n=t.onMouseOver?P=>{t.onMouseOver(P,this),a.dispatchEvent(new MouseEvent("mouseover",P))}:null,l=t.onMouseLeave?P=>{t.onMouseLeave(P,this),a.dispatchEvent(new MouseEvent("mouseleave",P))}:null,c=t.onContextMenu?P=>{t.onContextMenu(P,this)}:null,h=P=>a.dispatchEvent(new MouseEvent("mousedown",P)),d=P=>a.dispatchEvent(new MouseEvent("mouseup",P)),p=P=>a.dispatchEvent(new MouseEvent("mousemove",P)),m=P=>a.dispatchEvent(new WheelEvent("wheel",P));this._cleanups=[],["units","scale"].forEach(P=>{const _=i.metrics.on("units",()=>this._update());this._cleanups.push(()=>i.metrics.off(_))}),this._drawables=[];const g=(P,_)=>{const b=()=>P.setVisible(_.every(B=>B.get()));_.forEach(B=>B.reg(b)),this._drawables.push(P),this._cleanups.push(()=>P.destroy())},u=(P,_,b)=>{const B=new _f(i,s,{color:P,thickness:_,thicknessClickable:6,zIndex:e.zIndex!==void 0?e.zIndex+1:void 0,onMouseOver:n,onMouseLeave:l,onMouseWheel:m,onMouseDown:h,onMouseUp:d,onMouseMove:p,onContextMenu:c});return g(B,b),{setEnds:(w,C)=>B.setEnds(w,C),setColor:w=>B.setColor(w)}};this._lengthWire=u(this._color,2,[this._visible,this._wireVisible]),this._xAxisWire=u("red",1,[this._visible,this._axisEnabled,this._axisVisible,this._xAxisVisible]),this._yAxisWire=u("green",1,[this._visible,this._axisEnabled,this._axisVisible,this._yAxisVisible]),this._zAxisWire=u("blue",1,[this._visible,this._axisEnabled,this._axisVisible,this._zAxisVisible]);const x=(P,_,b)=>{const B=new gf(i,s,{fillColor:P,zIndex:e.zIndex!==void 0?e.zIndex+_:void 0,onMouseOver:n,onMouseLeave:l,onMouseWheel:m,onMouseDown:h,onMouseUp:d,onMouseMove:p,onContextMenu:c});return g(B,b),{setFillColor:w=>B.setFillColor(w),setPosOnWire:(w,C,E,I)=>B.setPosOnWire(w,C,E,I),setPosBetween:(w,C,E)=>B.setPosBetween(w,C,E),setText:w=>B.setText(w.replace(/ /g,"&nbsp;"))}};this._lengthLabel=x(this._color,4,[this._visible,this._wireVisible,this._labelsVisible,this._clickable,this._axisEnabled,this._lengthLabelEnabled]),this._xAxisLabel=x("red",3,[this._visible,this._axisEnabled,this._axisVisible,this._xAxisVisible,this._labelsVisible,this._clickable,this._xLabelEnabled]),this._yAxisLabel=x("green",3,[this._visible,this._axisEnabled,this._axisVisible,this._yAxisVisible,this._labelsVisible,this._clickable,this._yLabelEnabled]),this._zAxisLabel=x("blue",3,[this._visible,this._axisEnabled,this._axisVisible,this._zAxisVisible,this._labelsVisible,this._clickable,this._zLabelEnabled]);const y=(P,_)=>{const b=new mf(i,P,s,{fillColor:this._color,zIndex:e.zIndex!==void 0?e.zIndex+2:void 0,onMouseOver:n,onMouseLeave:l,onMouseWheel:m,onMouseDown:h,onMouseUp:d,onMouseMove:p,onContextMenu:c});return b.on("worldPos",()=>this._update()),g(b,_),b};this._originDot=y(t.origin,[this._visible,this._originVisible]),this._targetDot=y(t.target,[this._visible,this._targetVisible]),this._update()}_update(){if(!this._targetDot)return;const e=this._originDot.worldPos,t=this._targetDot.worldPos,i=this._axesBasis,s=A.subVec3(t,e,Yb),o=A.transformVec3(i,s,s),a=this._useRotationAdjustment.get()&&Math.abs(s[1])>0,n=(l,c)=>{const h=this.plugin.viewer.scene.metrics,d=h.scale,p=h.unitsInfo[h.units].abbrev,m=(u,x,y,P)=>{this._labelsOnWires.get()?u.setPosOnWire(x,y,0,this.plugin.labelMinAxisLength):u.setPosOnWire(e,t,P*35,0)},g=u=>(this._approximate?" ~ ":" = ")+u.toFixed(2)+p;this._xAxisWire.setEnds(e,l),m(this._xAxisLabel,e,l,1),this._xAxisLabel.setText("X"+g(A.distVec3(e,l)*d)),this._yAxisWire.setEnds(l,c),m(this._yAxisLabel,l,c,2),this._yAxisLabel.setText("Y"+g(A.distVec3(l,c)*d)),this._zAxisWire.setEnds(c,t),m(this._zAxisLabel,c,t,3),this._zAxisLabel.setText((a?"":"Z")+g(A.distVec3(c,t)*d)),this._lengthWire.setEnds(e,t),m(this._lengthLabel,e,t,0),this._length=A.distVec3(e,t)*d,this._lengthLabel.setText(g(this._length))};a?(hs[0]=e[0],hs[1]=t[1],hs[2]=e[2],n(e,hs)):(Rs[0]=e[0]+i[0]*o[0],Rs[1]=e[1]+i[4]*o[0],Rs[2]=e[2]+i[8]*o[0],hs[0]=Rs[0]+i[1]*o[1],hs[1]=Rs[1]+i[5]*o[1],hs[2]=Rs[2]+i[9]*o[1],n(Rs,hs))}set axesBasis(e){this._axesBasis.set(e),this._update()}get axesBasis(){return this._axesBasis}set approximate(e){e=e!==!1,this._approximate!==e&&(this._approximate=e,this._update())}get approximate(){return this._approximate}get origin(){return this._originDot}get target(){return this._targetDot}get length(){return this._length}get color(){return this._color}set color(e){this._color=e,this._originDot.setFillColor(e),this._targetDot.setFillColor(e),this._lengthWire.setColor(e),this._lengthLabel.setFillColor(e)}set visible(e){this._visible.set(e)}get visible(){return this._visible.get()}set originVisible(e){this._originVisible.set(e)}get originVisible(){return this._originVisible.get()}set targetVisible(e){this._targetVisible.set(e)}get targetVisible(){return this._targetVisible.get()}set useRotationAdjustment(e){this._useRotationAdjustment.set(e),this._update()}get useRotationAdjustment(){return this._useRotationAdjustment.get()}set axisEnabled(e){this._axisEnabled.set(e)}get axisEnabled(){return this._axisEnabled.get()}set axisVisible(e){this._axisVisible.set(e)}get axisVisible(){return this._axisVisible.get()}set xAxisVisible(e){this._xAxisVisible.set(e)}get xAxisVisible(){return this._xAxisVisible.get()}set yAxisVisible(e){this._yAxisVisible.set(e)}get yAxisVisible(){return this._yAxisVisible.get()}set zAxisVisible(e){this._zAxisVisible.set(e)}get zAxisVisible(){return this._zAxisVisible.get()}set wireVisible(e){this._wireVisible.set(e)}get wireVisible(){return this._wireVisible.get()}set labelsVisible(e){this._labelsVisible.set(e)}get labelsVisible(){return this._labelsVisible.get()}set xLabelEnabled(e){this._xLabelEnabled.set(e)}get xLabelEnabled(){return this._xLabelEnabled.get()}set yLabelEnabled(e){this._yLabelEnabled.set(e)}get yLabelEnabled(){return this._yLabelEnabled.get()}set zLabelEnabled(e){this._zLabelEnabled.set(e)}get zLabelEnabled(){return this._zLabelEnabled.get()}set lengthLabelEnabled(e){this._lengthLabelEnabled.set(e)}get lengthLabelEnabled(){return this._lengthLabelEnabled.get()}set labelsOnWires(e){this._labelsOnWires.set(e),this._update()}get labelsOnWires(){return this._labelsOnWires.get()}setHighlighted(e){this._drawables.forEach(t=>t.setHighlighted(e))}set clickable(e){this._clickable.set(!!e),this._drawables.forEach(t=>t.setClickable(this._clickable.get()))}get clickable(){return this._clickable.get()}destroy(){this._cleanups.forEach(e=>e()),super.destroy()}}class Zb extends vt{get active(){}set snapping(e){}get snapping(){return!0}activate(){}deactivate(){}reset(){}get currentMeasurement(){return null}destroy(){}}const In=0;class qb extends Zb{constructor(e,t={}){super(e.viewer.scene),this._canvasToPagePos=t.canvasToPagePos,this.pointerLens=t.pointerLens,this._active=!1,this._currentDistanceMeasurement=null,this._currentDistanceMeasurementInitState={wireVisible:null,axisVisible:null,xAxisVisible:null,yaxisVisible:null,zAxisVisible:null,targetVisible:null},this._initMarkerDiv(),this._snapping=t.snapping!==!1,this._mouseState=In,this._attachPlugin(e,t)}_initMarkerDiv(){const e=document.createElement("div"),t=this.scene.canvas.canvas;t.parentNode.insertBefore(e,t),e.style.background="black",e.style.border="2px solid blue",e.style.borderRadius="10px",e.style.width="5px",e.style.height="5px",e.style.top="-200px",e.style.left="-200px",e.style.margin="0 0",e.style.zIndex="100",e.style.position="absolute",e.style.pointerEvents="none",this._markerDiv=e}_destroyMarkerDiv(){this._markerDiv&&(this._markerDiv.parentNode.removeChild(this._markerDiv),this._markerDiv=null)}_attachPlugin(e,t={}){this.distanceMeasurementsPlugin=e,this.plugin=e}get active(){return this._active}set snapping(e){this._snapping=e}get snapping(){return this._snapping}activate(){if(this._active)return;this._markerDiv||this._initMarkerDiv(),this.fire("activated",!0);const e=this.distanceMeasurementsPlugin,t=this.scene,i=e.viewer.cameraControl,s=t.canvas.canvas;t.input;let o=!1;const a=A.vec3(),n=A.vec2();let l,c;const h=20;let d=null;this._mouseState=In;const p=A.vec2(),m=u=>{const x=u.snappedCanvasPos||u.canvasPos;if(o=!0,a.set(u.worldPos),n.set(u.canvasPos),this._mouseState===In){if(this._canvasToPagePos)this._canvasToPagePos(s,x,p),this._markerDiv.style.left=`${p[0]-5}px`,this._markerDiv.style.top=`${p[1]-5}px`;else{const y=A.vec2(x);Da(s,this._markerDiv.parentNode,y),this._markerDiv.style.left=`${y[0]-5}px`,this._markerDiv.style.top=`${y[1]-5}px`}this._markerDiv.style.background="pink",u.snappedToVertex||u.snappedToEdge?(this.pointerLens&&(this.pointerLens.visible=!0,this.pointerLens.canvasPos=u.canvasPos,this.pointerLens.snappedCanvasPos=u.snappedCanvasPos||u.canvasPos,this.pointerLens.snapped=!0),this._markerDiv.style.background="greenyellow",this._markerDiv.style.border="2px solid green"):(this.pointerLens&&(this.pointerLens.visible=!0,this.pointerLens.canvasPos=u.canvasPos,this.pointerLens.snappedCanvasPos=u.canvasPos,this.pointerLens.snapped=!1),this._markerDiv.style.background="pink",this._markerDiv.style.border="2px solid red"),d=u.entity}else this._markerDiv.style.left="-10000px",this._markerDiv.style.top="-10000px";s.style.cursor="pointer",this._currentDistanceMeasurement&&(this._currentDistanceMeasurement.wireVisible=this._currentDistanceMeasurementInitState.wireVisible,this._currentDistanceMeasurement.axisVisible=this._currentDistanceMeasurementInitState.axisVisible&&this.distanceMeasurementsPlugin.defaultAxisVisible,this._currentDistanceMeasurement.xAxisVisible=this._currentDistanceMeasurementInitState.xAxisVisible&&this.distanceMeasurementsPlugin.defaultXAxisVisible,this._currentDistanceMeasurement.yAxisVisible=this._currentDistanceMeasurementInitState.yAxisVisible&&this.distanceMeasurementsPlugin.defaultYAxisVisible,this._currentDistanceMeasurement.zAxisVisible=this._currentDistanceMeasurementInitState.zAxisVisible&&this.distanceMeasurementsPlugin.defaultZAxisVisible,this._currentDistanceMeasurement.targetVisible=this._currentDistanceMeasurementInitState.targetVisible,this._currentDistanceMeasurement.target.worldPos=a.slice(),this._markerDiv.style.left="-10000px",this._markerDiv.style.top="-10000px")};this._onHoverSnapOrSurface=i.on("hoverSnapOrSurface",u=>{this._snapping&&m(u)}),this._onHoverSurface=i.on("hoverSurface",u=>{this._snapping||m(u)}),s.addEventListener("mousedown",this._onMouseDown=u=>{u.which===1&&(l=u.clientX,c=u.clientY)}),s.addEventListener("mouseup",this._onMouseUp=u=>{u.which===1&&(u.clientX>l+h||u.clientX<l-h||u.clientY>c+h||u.clientY<c-h||(this._currentDistanceMeasurement?o?(this._currentDistanceMeasurement.target.entity=d,d=null,this._currentDistanceMeasurement.clickable=!0,this.distanceMeasurementsPlugin.fire("measurementEnd",this._currentDistanceMeasurement),this._currentDistanceMeasurement=null):(this._currentDistanceMeasurement.destroy(),this.distanceMeasurementsPlugin.fire("measurementCancel",this._currentDistanceMeasurement),this._currentDistanceMeasurement=null,d=null):o&&(this._currentDistanceMeasurement=e.createMeasurement({id:A.createUUID(),origin:{worldPos:a.slice(),entity:d},target:{worldPos:a.slice(),entity:d},approximate:!0}),this._currentDistanceMeasurementInitState.axisVisible=this._currentDistanceMeasurement.axisVisible&&this.distanceMeasurementsPlugin.defaultAxisVisible,this._currentDistanceMeasurementInitState.xAxisVisible=this._currentDistanceMeasurement.xAxisVisible&&this.distanceMeasurementsPlugin.defaultXAxisVisible,this._currentDistanceMeasurementInitState.yAxisVisible=this._currentDistanceMeasurement.yAxisVisible&&this.distanceMeasurementsPlugin.defaultYAxisVisible,this._currentDistanceMeasurementInitState.zAxisVisible=this._currentDistanceMeasurement.zAxisVisible&&this.distanceMeasurementsPlugin.defaultZAxisVisible,this._currentDistanceMeasurementInitState.wireVisible=this._currentDistanceMeasurement.wireVisible,this._currentDistanceMeasurementInitState.targetVisible=this._currentDistanceMeasurement.targetVisible,this._currentDistanceMeasurement.clickable=!1,this._currentDistanceMeasurement.origin.entity=d,d=null,this.distanceMeasurementsPlugin.fire("measurementStart",this._currentDistanceMeasurement))))});const g=u=>{this.pointerLens&&(this.pointerLens.visible=!0,this.pointerLens.canvasPos=u.canvasPos,this.pointerLens.snappedCanvasPos=u.snappedCanvasPos||u.canvasPos),o=!1,this._markerDiv.style.left="-100px",this._markerDiv.style.top="-100px",this._currentDistanceMeasurement&&(this._currentDistanceMeasurement.wireVisible=!1,this._currentDistanceMeasurement.targetVisible=!1,this._currentDistanceMeasurement.axisVisible=!1),s.style.cursor="default"};this._onHoverSnapOrSurfaceOff=i.on("hoverSnapOrSurfaceOff",u=>{this._snapping&&g(u)}),this._onHoverOff=i.on("hoverOff",u=>{this._snapping||g(u)}),this._active=!0}deactivate(){if(!this._active)return;this.fire("activated",!1),this.pointerLens&&(this.pointerLens.visible=!1),this.reset();const e=this.scene.canvas.canvas;e.removeEventListener("mousedown",this._onMouseDown),e.removeEventListener("mouseup",this._onMouseUp);const t=this.distanceMeasurementsPlugin.viewer.cameraControl;t.off(this._onHoverSnapOrSurface),t.off(this._onHoverSurface),t.off(this._onHoverSnapOrSurfaceOff),t.off(this._onHoverOff),this._active=!1}reset(){this._active&&(this._destroyMarkerDiv(),this._initMarkerDiv(),this._currentDistanceMeasurement&&(this.distanceMeasurementsPlugin.fire("measurementCancel",this._currentDistanceMeasurement),this._currentDistanceMeasurement.destroy(),this._currentDistanceMeasurement=null),this._mouseState=In)}get currentMeasurement(){return this._currentDistanceMeasurement}destroy(){this.deactivate(),super.destroy()}}class VF extends Ro{constructor(e,t={}){super("DistanceMeasurements",e),this._pointerLens=t.pointerLens,this._container=t.container||document.body,this._defaultControl=null,this._measurements={},this.labelMinAxisLength=t.labelMinAxisLength,this.defaultVisible=t.defaultVisible!==!1,this.defaultOriginVisible=t.defaultOriginVisible!==!1,this.defaultTargetVisible=t.defaultTargetVisible!==!1,this.defaultWireVisible=t.defaultWireVisible!==!1,this.defaultXLabelEnabled=t.defaultXLabelEnabled!==!1,this.defaultYLabelEnabled=t.defaultYLabelEnabled!==!1,this.defaultZLabelEnabled=t.defaultZLabelEnabled!==!1,this.defaultLengthLabelEnabled=t.defaultLengthLabelEnabled!==!1,this.defaultLabelsVisible=t.defaultLabelsVisible!==!1,this.defaultAxisVisible=t.defaultAxisVisible!==!1,this.defaultXAxisVisible=t.defaultXAxisVisible!==!1,this.defaultYAxisVisible=t.defaultYAxisVisible!==!1,this.defaultZAxisVisible=t.defaultZAxisVisible!==!1,this.defaultColor=t.defaultColor!==void 0?t.defaultColor:"#00BBFF",this.zIndex=t.zIndex||1e4,this.defaultLabelsOnWires=t.defaultLabelsOnWires!==!1,this.useRotationAdjustment=t.useRotationAdjustment!==void 0?t.useRotationAdjustment!==!1:!1,this._onMouseOver=(i,s)=>{this.fire("mouseOver",{plugin:this,distanceMeasurement:s,measurement:s,event:i})},this._onMouseLeave=(i,s)=>{this.fire("mouseLeave",{plugin:this,distanceMeasurement:s,measurement:s,event:i})},this._onContextMenu=(i,s)=>{this.fire("contextMenu",{plugin:this,distanceMeasurement:s,measurement:s,event:i})}}getContainerElement(){return this._container}send(e,t){}get pointerLens(){return this._pointerLens}get control(){return this._defaultControl||(this._defaultControl=new qb(this,{})),this._defaultControl}get measurements(){return this._measurements}set labelMinAxisLength(e){e<1&&(this.error("labelMinAxisLength must be >= 1; defaulting to 25"),e=25),this._labelMinAxisLength=e||25}get labelMinAxisLength(){return this._labelMinAxisLength}set useRotationAdjustment(e){e=e!==void 0?!!e:!1,this._useRotationAdjustment=e}get useRotationAdjustment(){return this._useRotationAdjustment}createMeasurement(e={}){this.viewer.scene.components[e.id]&&(this.error("Viewer scene component with this ID already exists: "+e.id),delete e.id);const t=e.origin,i=e.target,s=new $b(this,{id:e.id,plugin:this,container:this._container,origin:{entity:t.entity,worldPos:t.worldPos},target:{entity:i.entity,worldPos:i.worldPos},visible:e.visible,wireVisible:e.wireVisible,axisVisible:e.axisVisible!==!1&&this.defaultAxisVisible!==!1,xAxisVisible:e.xAxisVisible!==!1&&this.defaultXAxisVisible!==!1,yAxisVisible:e.yAxisVisible!==!1&&this.defaultYAxisVisible!==!1,zAxisVisible:e.zAxisVisible!==!1&&this.defaultZAxisVisible!==!1,xLabelEnabled:e.xLabelEnabled!==!1&&this.defaultXLabelEnabled!==!1,yLabelEnabled:e.yLabelEnabled!==!1&&this.defaultYLabelEnabled!==!1,zLabelEnabled:e.zLabelEnabled!==!1&&this.defaultZLabelEnabled!==!1,lengthLabelEnabled:e.lengthLabelEnabled!==!1&&this.defaultLengthLabelEnabled!==!1,labelsVisible:e.labelsVisible!==!1&&this.defaultLabelsVisible!==!1,useRotationAdjustment:this.useRotationAdjustment,originVisible:e.originVisible,targetVisible:e.targetVisible,color:e.color,labelsOnWires:e.labelsOnWires!==!1&&this.defaultLabelsOnWires!==!1,onMouseOver:this._onMouseOver,onMouseLeave:this._onMouseLeave,onContextMenu:this._onContextMenu});return this._measurements[s.id]=s,s.clickable=!0,s.on("destroyed",()=>{delete this._measurements[s.id]}),this.fire("measurementCreated",s),s}destroyMeasurement(e){const t=this._measurements[e];if(!t){this.log("DistanceMeasurement not found: "+e);return}t.destroy(),this.fire("measurementDestroyed",t)}setLabelsShown(e){for(const[t,i]of Object.entries(this.measurements))i.labelShown=e}setAxisVisible(e){for(const[t,i]of Object.entries(this.measurements))i.axisVisible=e;this.defaultAxisVisible=e}getAxisVisible(){return this.defaultAxisVisible}clear(){const e=Object.keys(this._measurements);for(var t=0,i=e.length;t<i;t++)this.destroyMeasurement(e[t])}destroy(){this.clear(),super.destroy()}}class Jb{constructor(e={}){this._eventSubIDMap=null,this._eventSubEvents=null,this._eventSubs=null,this._events=null,this._locale="en",this._messages={},this._locales=[],this._locale="en",this.messages=e.messages,this.locale=e.locale}set messages(e){this._messages=e||{},this._locales=Object.keys(this._messages),this.fire("updated",this)}loadMessages(e={}){for(let t in e)this._messages[t]=e[t];this.messages=this._messages}clearMessages(){this.messages={}}get locales(){return this._locales}set locale(e){e=e||"de",this._locale!==e&&(this._locale=e,this.fire("updated",e))}get locale(){return this._locale}translate(e,t){const i=this._messages[this._locale];if(!i)return null;const s=od(e,i);return s?t?jl(s,t):s:null}translatePlurals(e,t,i){const s=this._messages[this._locale];if(!s)return null;let o=od(e,s);return t=parseInt(""+t,10),t===0?o=o.zero:o=t>1?o.other:o.one,o?(o=jl(o,[t]),i&&(o=jl(o,i)),o):null}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),i!==!0&&(this._events[e]=t||!0);const s=this._eventSubs[e];if(s)for(const o in s)s.hasOwnProperty(o)&&s[o].callback(t)}on(e,t){this._events||(this._events={}),this._eventSubIDMap||(this._eventSubIDMap=new Di),this._eventSubEvents||(this._eventSubEvents={}),this._eventSubs||(this._eventSubs={});let i=this._eventSubs[e];i||(i={},this._eventSubs[e]=i);const s=this._eventSubIDMap.addItem();i[s]={callback:t},this._eventSubEvents[s]=e;const o=this._events[e];return o!==void 0&&t(o),s}off(e){if(e==null||!this._eventSubEvents)return;const t=this._eventSubEvents[e];if(t){delete this._eventSubEvents[e];const i=this._eventSubs[t];i&&delete i[e],this._eventSubIDMap.removeItem(e)}}}function od(r,e){if(e[r])return e[r];const t=r.split(".");let i=e;for(let s=0,o=t.length;i&&s<o;s++){const a=t[s];i=i[a]}return i}function jl(r,e=[]){return r.replace(/\{\{|\}\}|\{(\d+)\}/g,function(t,i){return t==="{{"?"{":t==="}}"?"}":e[i]})}A.vec3();const zl=A.vec3(),Gl=A.vec3(),Wl=A.vec3(),nd=A.vec3(),Ls=A.vec3();class js extends vt{get type(){return"CameraFlightAnimation"}constructor(e,t={}){super(e,t),this._look1=A.vec3(),this._eye1=A.vec3(),this._up1=A.vec3(),this._look2=A.vec3(),this._eye2=A.vec3(),this._up2=A.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._callback=null,this._callbackScope=null,this._time1=null,this._time2=null,this.easing=t.easing!==!1,this.duration=t.duration,this.fit=t.fit,this.fitFOV=t.fitFOV,this.trail=t.trail}flyTo(e,t,i){e=e||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=t,this._callbackScope=i;const s=this.scene.camera,o=!!e.projection&&e.projection!==s.projection;this._eye1[0]=s.eye[0],this._eye1[1]=s.eye[1],this._eye1[2]=s.eye[2],this._look1[0]=s.look[0],this._look1[1]=s.look[1],this._look1[2]=s.look[2],this._up1[0]=s.up[0],this._up1[1]=s.up[1],this._up1[2]=s.up[2],this._orthoScale1=s.ortho.scale,this._orthoScale2=e.orthoScale||this._orthoScale1;let a,n,l,c,h;if(e.aabb)a=e.aabb;else if(e.length===6)a=e;else if(e.eye&&e.look||e.up)n=e.eye,l=e.look,c=e.up;else if(e.eye)n=e.eye;else if(e.look)l=e.look;else{let p=e;if((we.isNumeric(p)||we.isString(p))&&(h=p,p=this.scene.components[h],!p)){this.error("Component not found: "+we.inQuotes(h)),t&&(i?t.call(i):t());return}o||(a=p.aabb||this.scene.aabb)}const d=e.poi;if(a){if(a[3]<a[0]||a[4]<a[1]||a[5]<a[2]||a[3]===a[0]&&a[4]===a[1]&&a[5]===a[2])return;a=a.slice();const p=A.getAABB3Center(a);this._look2=d||p;const m=A.subVec3(this._eye1,this._look1,zl),g=A.normalizeVec3(m),u=d?A.getAABB3DiagPoint(a,d):A.getAABB3Diag(a),x=e.fitFOV||this._fitFOV,y=Math.abs(u/Math.tan(x*A.DEGTORAD));this._orthoScale2=u*1.1,this._eye2[0]=this._look2[0]+g[0]*y,this._eye2[1]=this._look2[1]+g[1]*y,this._eye2[2]=this._look2[2]+g[2]*y,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0}else(n||l||c)&&(this._flyingEyeLookUp=!!n&&!!l&&!!c,this._flyingEye=!!n&&!l,this._flyingLook=!!l&&!n,n&&(this._eye2[0]=n[0],this._eye2[1]=n[1],this._eye2[2]=n[2]),l&&(this._look2[0]=l[0],this._look2[1]=l[1],this._look2[2]=l[2]),c&&(this._up2[0]=c[0],this._up2[1]=c[1],this._up2[2]=c[2]));o?(e.projection==="ortho"&&s.projection!=="ortho"&&(this._projection2="ortho",this._projMatrix1=s.projMatrix.slice(),this._projMatrix2=s.ortho.matrix.slice(),s.projection="customProjection"),e.projection==="perspective"&&s.projection!=="perspective"&&(this._projection2="perspective",this._projMatrix1=s.projMatrix.slice(),this._projMatrix2=s.perspective.matrix.slice(),s.projection="customProjection")):this._projection2=null,this.fire("started",e,!0),this._time1=Date.now(),this._time2=this._time1+(e.duration?e.duration*1e3:this._duration),this._flying=!0,It.scheduleTask(this._update,this)}jumpTo(e){this._jumpTo(e)}_jumpTo(e){this._flying&&this.stop();const t=this.scene.camera;var i,s,o,a,n;if(e.aabb)i=e.aabb;else if(e.length===6)i=e;else if(e.eye||e.look||e.up)o=e.eye,a=e.look,n=e.up;else{let h=e;if((we.isNumeric(h)||we.isString(h))&&(s=h,h=this.scene.components[s],!h)){this.error("Component not found: "+we.inQuotes(s));return}i=h.aabb||this.scene.aabb}const l=e.poi;if(i){if(i[3]<=i[0]||i[4]<=i[1]||i[5]<=i[2])return;var c=l?A.getAABB3DiagPoint(i,l):A.getAABB3Diag(i);a=l||A.getAABB3Center(i,a),this._trail?A.subVec3(t.look,a,Ls):A.subVec3(t.eye,t.look,Ls),A.normalizeVec3(Ls);let h;(e.fit!==void 0?e.fit:this._fit)?h=Math.abs(c/Math.tan((e.fitFOV||this._fitFOV)*A.DEGTORAD)):h=A.lenVec3(A.subVec3(t.eye,t.look,zl)),A.mulVec3Scalar(Ls,h),t.eye=A.addVec3(a,Ls,zl),t.look=a,this.scene.camera.ortho.scale=c*1.1}else(o||a||n)&&(o&&(t.eye=o),a&&(t.look=a),n&&(t.up=n));e.projection&&(t.projection=e.projection)}_update(){if(!this._flying)return;let t=(Date.now()-this._time1)/(this._time2-this._time1);const i=t>=1;t>1&&(t=1);const s=this.easing?js._ease(t,0,1,1):t,o=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(A.subVec3(o.eye,o.look,Ls),o.eye=A.lerpVec3(s,0,1,this._eye1,this._eye2,Wl),o.look=A.subVec3(Wl,Ls,Gl)):this._flyingLook&&(o.look=A.lerpVec3(s,0,1,this._look1,this._look2,Gl),o.up=A.lerpVec3(s,0,1,this._up1,this._up2,nd)):this._flyingEyeLookUp&&(o.eye=A.lerpVec3(s,0,1,this._eye1,this._eye2,Wl),o.look=A.lerpVec3(s,0,1,this._look1,this._look2,Gl),o.up=A.lerpVec3(s,0,1,this._up1,this._up2,nd)),this._projection2){const a=this._projection2==="ortho"?js._easeOutExpo(t,0,1,1):js._easeInCubic(t,0,1,1);o.customProjection.matrix=A.lerpMat4(a,0,1,this._projMatrix1,this._projMatrix2)}else o.ortho.scale=this._orthoScale1+t*(this._orthoScale2-this._orthoScale1);if(i){o.ortho.scale=this._orthoScale2,this.stop();return}It.scheduleTask(this._update,this)}static _ease(e,t,i,s){return e/=s,-i*e*(e-2)+t}static _easeInCubic(e,t,i,s){return e/=s,i*e*e*e+t}static _easeOutExpo(e,t,i,s){return i*(-Math.pow(2,-10*e/s)+1)+t}stop(){if(!this._flying)return;this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);const e=this._callback;e&&(this._callback=null,this._callbackScope?e.call(this._callbackScope):e()),this.fire("stopped",!0,!0)}cancel(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))}set duration(e){this._duration=e?e*1e3:500,this.stop()}get duration(){return this._duration/1e3}set fit(e){this._fit=e!==!1}get fit(){return this._fit}set fitFOV(e){this._fitFOV=e||45}get fitFOV(){return this._fitFOV}set trail(e){this._trail=!!e}get trail(){return this._trail}destroy(){this.stop(),super.destroy()}}class $t extends vt{get type(){return"CameraPathAnimation"}constructor(e,t={}){super(e,t),this._cameraFlightAnimation=new js(this),this._t=0,this.state=$t.SCRUBBING,this._playingFromT=0,this._playingToT=0,this._playingRate=t.playingRate||1,this._playingDir=1,this._lastTime=null,this.cameraPath=t.cameraPath,this._tick=this.scene.on("tick",this._updateT,this)}_updateT(){const e=this._cameraPath;if(!e)return;let t,i;const s=performance.now(),o=this._lastTime?(s-this._lastTime)*.001:0;if(this._lastTime=s,o!==0)switch(this.state){case $t.SCRUBBING:return;case $t.PLAYING:if(this._t+=this._playingRate*o,t=this._cameraPath.frames.length,t===0||this._playingDir<0&&this._t<=0||this._playingDir>0&&this._t>=this._cameraPath.frames[t-1].t){this.state=$t.SCRUBBING,this._t=this._cameraPath.frames[t-1].t,this.fire("stopped");return}e.loadFrame(this._t);break;case $t.PLAYING_TO:i=this._t+this._playingRate*o*this._playingDir,(this._playingDir<0&&i<=this._playingToT||this._playingDir>0&&i>=this._playingToT)&&(i=this._playingToT,this.state=$t.SCRUBBING,this.fire("stopped")),this._t=i,e.loadFrame(this._t);break}}_ease(e,t,i,s){return e/=s,-i*e*(e-2)+t}set cameraPath(e){this._cameraPath=e}get cameraPath(){return this._cameraPath}set rate(e){this._playingRate=e}get rate(){return this._playingRate}play(){this._cameraPath&&(this._lastTime=null,this.state=$t.PLAYING)}playToT(e){this._cameraPath&&(this._playingFromT=this._t,this._playingToT=e,this._playingDir=this._playingToT-this._playingFromT<0?-1:1,this._lastTime=null,this.state=$t.PLAYING_TO)}playToFrame(e){const t=this._cameraPath;if(!t)return;const i=t.frames[e];if(!i){this.error("playToFrame - frame index out of range: "+e);return}this.playToT(i.t)}flyToFrame(e,t){const i=this._cameraPath;if(!i)return;const s=i.frames[e];if(!s){this.error("flyToFrame - frame index out of range: "+e);return}this.state=$t.SCRUBBING,this._cameraFlightAnimation.flyTo(s,t)}scrubToT(e){const t=this._cameraPath;!t||!this.scene.camera||(this._t=e,t.loadFrame(this._t),this.state=$t.SCRUBBING)}scrubToFrame(e){const t=this._cameraPath;if(!t||!this.scene.camera)return;if(!t.frames[e]){this.error("playToFrame - frame index out of range: "+e);return}t.loadFrame(this._t),this.state=$t.SCRUBBING}stop(){this.state=$t.SCRUBBING,this.fire("stopped")}destroy(){super.destroy(),this.scene.off(this._tick)}}$t.STOPPED=0;$t.SCRUBBING=1;$t.PLAYING=2;$t.PLAYING_TO=3;A.vec3();A.vec3();A.vec3();A.vec3([0,-1,0]);A.vec4([0,0,0,1]);class HF extends ac{get type(){return"PointLight"}constructor(e,t={}){super(e,t);const i=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;const s=this.scene.camera,o=this.scene.canvas;this._onCameraViewMatrix=s.on("viewMatrix",()=>{this._shadowViewMatrixDirty=!0}),this._onCameraProjMatrix=s.on("projMatrix",()=>{this._shadowProjMatrixDirty=!0}),this._onCanvasBoundary=o.on("boundary",()=>{this._shadowProjMatrixDirty=!0}),this._state=new Mt({type:"point",pos:A.vec3([1,1,1]),color:A.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:t.space||"view",castsShadow:!1,getShadowViewMatrix:()=>{if(i._shadowViewMatrixDirty){i._shadowViewMatrix||(i._shadowViewMatrix=A.identityMat4());const a=i._state.pos,n=s.look,l=s.up;A.lookAtMat4v(a,n,l,i._shadowViewMatrix),i._shadowViewMatrixDirty=!1}return i._shadowViewMatrix},getShadowProjMatrix:()=>{if(i._shadowProjMatrixDirty){i._shadowProjMatrix||(i._shadowProjMatrix=A.identityMat4());const a=i.scene.canvas.canvas;A.perspectiveMat4(70*(Math.PI/180),a.clientWidth/a.clientHeight,.1,500,i._shadowProjMatrix),i._shadowProjMatrixDirty=!1}return i._shadowProjMatrix},getShadowRenderBuf:()=>(i._shadowRenderBuf||(i._shadowRenderBuf=new nc(i.scene.canvas.canvas,i.scene.canvas.gl,{size:[1024,1024]})),i._shadowRenderBuf)}),this.pos=t.pos,this.color=t.color,this.intensity=t.intensity,this.constantAttenuation=t.constantAttenuation,this.linearAttenuation=t.linearAttenuation,this.quadraticAttenuation=t.quadraticAttenuation,this.castsShadow=t.castsShadow,this.scene._lightCreated(this)}set pos(e){this._state.pos.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}get pos(){return this._state.pos}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){e=e!==void 0?e:1,this._state.intensity=e,this.glRedraw()}get intensity(){return this._state.intensity}set constantAttenuation(e){this._state.attenuation[0]=e||0,this.glRedraw()}get constantAttenuation(){return this._state.attenuation[0]}set linearAttenuation(e){this._state.attenuation[1]=e||0,this.glRedraw()}get linearAttenuation(){return this._state.attenuation[1]}set quadraticAttenuation(e){this._state.attenuation[2]=e||0,this.glRedraw()}get quadraticAttenuation(){return this._state.attenuation[2]}set castsShadow(e){e=!!e,this._state.castsShadow!==e&&(this._state.castsShadow=e,this._shadowViewMatrixDirty=!0,this.glRedraw())}get castsShadow(){return this._state.castsShadow}destroy(){const e=this.scene.camera,t=this.scene.canvas;e.off(this._onCameraViewMatrix),e.off(this._onCameraProjMatrix),t.off(this._onCanvasBoundary),super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}const Fn=A.vec3();class jF{constructor(e){if(this.objectsVisible=[],this.objectsEdges=[],this.objectsXrayed=[],this.objectsHighlighted=[],this.objectsSelected=[],this.objectsClippable=[],this.objectsPickable=[],this.objectsColorize=[],this.objectsOpacity=[],this.numObjects=0,e){const i=e.metaScene.scene;this.saveObjects(i,e)}}saveObjects(e,t,i){this.numObjects=0,this._mask=i?we.apply(i,{}):null;const s=!i||i.visible,o=!i||i.edges,a=!i||i.xrayed,n=!i||i.highlighted,l=!i||i.selected,c=!i||i.clippable,h=!i||i.pickable,d=!i||i.colorize,p=!i||i.opacity,m=t.metaObjects,g=e.objects;for(let u=0,x=m.length;u<x;u++){const P=m[u].id,_=g[P];if(_){if(s&&(this.objectsVisible[u]=_.visible),o&&(this.objectsEdges[u]=_.edges),a&&(this.objectsXrayed[u]=_.xrayed),n&&(this.objectsHighlighted[u]=_.highlighted),l&&(this.objectsSelected[u]=_.selected),c&&(this.objectsClippable[u]=_.clippable),h&&(this.objectsPickable[u]=_.pickable),d){const b=_.colorize;this.objectsColorize[u*3+0]=b[0],this.objectsColorize[u*3+1]=b[1],this.objectsColorize[u*3+2]=b[2]}p&&(this.objectsOpacity[u]=_.opacity),this.numObjects++}}}restoreObjects(e,t){const i=this._mask,s=!i||i.visible,o=!i||i.edges,a=!i||i.xrayed,n=!i||i.highlighted,l=!i||i.selected,c=!i||i.clippable,h=!i||i.pickable,d=!i||i.colorize,p=!i||i.opacity,m=t.metaObjects,g=e.objects;for(let u=0,x=m.length;u<x;u++){const P=m[u].id,_=g[P];_&&(s&&(_.visible=this.objectsVisible[u]),o&&(_.edges=this.objectsEdges[u]),a&&(_.xrayed=this.objectsXrayed[u]),n&&(_.highlighted=this.objectsHighlighted[u]),l&&(_.selected=this.objectsSelected[u]),c&&(_.clippable=this.objectsClippable[u]),h&&(_.pickable=this.objectsPickable[u]),d&&(Fn[0]=this.objectsColorize[u*3+0],Fn[1]=this.objectsColorize[u*3+1],Fn[2]=this.objectsColorize[u*3+2],_.colorize=Fn),p&&(_.opacity=this.objectsOpacity[u]))}}}A.vec3();const eB=A.vec4(),tB=A.vec4(),Kl=A.vec3(),ad=A.vec3(),iB=A.vec3(),ld=A.vec4(),sB=A.vec4(),Ad=A.vec4();class rB{constructor(e){this._scene=e}dollyToCanvasPos(e,t,i){let s=!1;const o=this._scene.camera;if(e){const a=A.subVec3(e,o.eye,Kl);s=A.lenVec3(a)<i}if(o.projection==="perspective"){o.ortho.scale=o.ortho.scale-i;const a=this._unproject(t,ld),n=A.subVec3(a,o.eye,Ad),l=A.mulVec3Scalar(A.normalizeVec3(n),-i,[]);if(o.eye=[o.eye[0]-l[0],o.eye[1]-l[1],o.eye[2]-l[2]],o.look=[o.look[0]-l[0],o.look[1]-l[1],o.look[2]-l[2]],e){const c=A.subVec3(e,o.eye,Kl),h=A.lenVec3(c),d=A.mulVec3Scalar(A.normalizeVec3(A.subVec3(o.look,o.eye,ad)),h);o.look=[o.eye[0]+d[0],o.eye[1]+d[1],o.eye[2]+d[2]]}}else if(o.projection==="ortho"){const a=this._unproject(t,ld);o.ortho.scale=o.ortho.scale-i,o.ortho._update();const n=this._unproject(t,sB),l=A.subVec3(n,a,Ad),c=A.mulVec3Scalar(A.normalizeVec3(A.subVec3(o.look,o.eye,Kl)),-i,ad),h=A.addVec3(l,c,iB);o.eye=[o.eye[0]-h[0],o.eye[1]-h[1],o.eye[2]-h[2]],o.look=[o.look[0]-h[0],o.look[1]-h[1],o.look[2]-h[2]]}return s}_unproject(e,t){const i=this._scene.camera,s=i.project.transposedMatrix,o=s.subarray(8,12),a=s.subarray(12),n=[0,0,-1,1],l=A.dotVec4(n,o)/A.dotVec4(n,a);return i.project.unproject(e,l,eB,tB,t),t}destroy(){}}const cd=A.vec3(),hd=A.vec3(),oB=A.vec3(),nB=A.vec4(),aB=A.vec4(),lB=A.vec4();class AB{constructor(e,t){this._scene=e,this._configs=t,this._pivotWorldPos=A.vec3(),this._cameraOffset=A.vec3(),this._azimuth=0,this._polar=0,this._radius=0,this._pivotPosSet=!1,this._pivoting=!1,this._shown=!1,this._pivotSphereEnabled=!1,this._pivotSphere=null,this._pivotSphereSize=1,this._pivotSphereGeometry=null,this._pivotSphereMaterial=null,this._rtcCenter=A.vec3(),this._rtcPos=A.vec3(),this._pivotViewPos=A.vec4(),this._pivotProjPos=A.vec4(),this._pivotCanvasPos=A.vec2(),this._cameraDirty=!0,this._onViewMatrix=this._scene.camera.on("viewMatrix",()=>{this._cameraDirty=!0}),this._onProjMatrix=this._scene.camera.on("projMatrix",()=>{this._cameraDirty=!0}),this._onTick=this._scene.on("tick",()=>{this.updatePivotElement(),this.updatePivotSphere()})}createPivotSphere(){const e=this.getPivotPos(),t=A.vec3();A.decomposeMat4(A.inverseMat4(this._scene.viewer.camera.viewMatrix,A.mat4()),t,A.vec4(),A.vec3());const i=A.distVec3(t,e);let s=Math.tan(Math.PI/500)*i*this._pivotSphereSize;this._scene.camera.projection=="ortho"&&(s/=this._scene.camera.ortho.scale/2),ma(e,this._rtcCenter,this._rtcPos),this._pivotSphereGeometry=new Dv(this._scene,Df({radius:s})),this._pivotSphere=new ct(this._scene,{geometry:this._pivotSphereGeometry,material:this._pivotSphereMaterial,pickable:!1,position:this._rtcPos,rtcCenter:this._rtcCenter})}destroyPivotSphere(){this._pivotSphere&&(this._pivotSphere.destroy(),this._pivotSphere=null),this._pivotSphereGeometry&&(this._pivotSphereGeometry.destroy(),this._pivotSphereGeometry=null)}updatePivotElement(){const e=this._scene.camera,t=this._scene.canvas;if(this._pivoting&&this._cameraDirty){A.transformPoint3(e.viewMatrix,this.getPivotPos(),this._pivotViewPos),this._pivotViewPos[3]=1,A.transformPoint4(e.projMatrix,this._pivotViewPos,this._pivotProjPos);const i=t.boundary,s=i[2],o=i[3];this._pivotCanvasPos[0]=Math.floor((1+this._pivotProjPos[0]/this._pivotProjPos[3])*s/2),this._pivotCanvasPos[1]=Math.floor((1-this._pivotProjPos[1]/this._pivotProjPos[3])*o/2);let a=t._lastBoundingClientRect;if(!a||t._canvasSizeChanged){const n=t.canvas;a=t._lastBoundingClientRect=n.getBoundingClientRect()}this._pivotElement&&(this._pivotElement.style.left=Math.floor(a.left+this._pivotCanvasPos[0])-this._pivotElement.clientWidth/2+window.scrollX+"px",this._pivotElement.style.top=Math.floor(a.top+this._pivotCanvasPos[1])-this._pivotElement.clientHeight/2+window.scrollY+"px"),this._cameraDirty=!1}}updatePivotSphere(){this._pivoting&&this._pivotSphere&&(ma(this.getPivotPos(),this._rtcCenter,this._rtcPos),A.compareVec3(this._rtcPos,this._pivotSphere.position)||(this.destroyPivotSphere(),this.createPivotSphere()))}setPivotElement(e){this._pivotElement=e}enablePivotSphere(e={}){this.destroyPivotSphere(),this._pivotSphereEnabled=!0,e.size&&(this._pivotSphereSize=e.size);const t=e.color||[1,0,0];this._pivotSphereMaterial=new gi(this._scene,{emissive:t,ambient:t,specular:[0,0,0],diffuse:[0,0,0]})}disablePivotSphere(){this.destroyPivotSphere(),this._pivotSphereEnabled=!1}startPivot(){if(this._cameraLookingDownwards())return this._pivoting=!1,!1;const e=this._scene.camera;let t=A.lookAtMat4v(e.eye,e.look,e.worldUp);A.transformPoint3(t,this.getPivotPos(),this._cameraOffset);const i=this.getPivotPos();this._cameraOffset[2]+=A.distVec3(e.eye,i),t=A.inverseMat4(t);const s=A.transformVec3(t,this._cameraOffset),o=A.vec3();if(A.subVec3(e.eye,i,o),A.addVec3(o,s),e.zUp){const a=o[1];o[1]=o[2],o[2]=a}this._radius=A.lenVec3(o),this._polar=Math.acos(o[1]/this._radius),this._azimuth=Math.atan2(o[0],o[2]),this._pivoting=!0}_cameraLookingDownwards(){const e=this._scene.camera,t=A.normalizeVec3(A.subVec3(e.look,e.eye,cd)),i=A.cross3Vec3(t,e.worldUp,hd);return A.sqLenVec3(i)<=1e-4}getPivoting(){return this._pivoting}setPivotPos(e){this._pivotWorldPos.set(e),this._pivotPosSet=!0}setCanvasPivotPos(e){const t=this._scene.camera,i=Math.abs(A.distVec3(this._scene.center,t.eye)),s=t.project.transposedMatrix,o=s.subarray(8,12),a=s.subarray(12),n=[0,0,-1,1],l=A.dotVec4(n,o)/A.dotVec4(n,a),c=nB;t.project.unproject(e,l,aB,lB,c);const h=A.normalizeVec3(A.subVec3(c,t.eye,cd)),d=A.addVec3(t.eye,A.mulVec3Scalar(h,i,hd),oB);this.setPivotPos(d)}getPivotPos(){return this._pivotPosSet?this._pivotWorldPos:this._scene.camera.look}continuePivot(e,t){if(!this._pivoting||e===0&&t===0)return;const i=this._scene.camera;var s=-e;const o=-t;i.worldUp[2]===1&&(s=-s),this._azimuth+=-s*.01,this._polar+=o*.01,this._polar=A.clamp(this._polar,.001,Math.PI-.001);const a=[this._radius*Math.sin(this._polar)*Math.sin(this._azimuth),this._radius*Math.cos(this._polar),this._radius*Math.sin(this._polar)*Math.cos(this._azimuth)];if(i.worldUp[2]===1){const p=a[1];a[1]=a[2],a[2]=p}const n=A.lenVec3(A.subVec3(i.look,i.eye,A.vec3())),l=this.getPivotPos();A.addVec3(a,l);let c=A.lookAtMat4v(a,l,i.worldUp);c=A.inverseMat4(c);const h=A.transformVec3(c,this._cameraOffset);c[12]-=h[0],c[13]-=h[1],c[14]-=h[2];const d=[c[8],c[9],c[10]];i.eye=[c[12],c[13],c[14]],A.subVec3(i.eye,A.mulVec3Scalar(d,n),i.look),i.up=[c[4],c[5],c[6]],this.showPivot()}showPivot(){this._shown||(this._pivotElement&&(this.updatePivotElement(),this._pivotElement.style.visibility="visible"),this._pivotSphereEnabled&&(this.destroyPivotSphere(),this.createPivotSphere()),this._shown=!0)}hidePivot(){this._shown&&(this._pivotElement&&(this._pivotElement.style.visibility="hidden"),this._pivotSphereEnabled&&this.destroyPivotSphere(),this._shown=!1)}endPivot(){this._pivoting=!1}destroy(){this.destroyPivotSphere(),this._scene.camera.off(this._onViewMatrix),this._scene.camera.off(this._onProjMatrix),this._scene.off(this._onTick)}}class cB{constructor(e,t){this._scene=e.scene,this._cameraControl=e,this._scene.canvas.canvas.oncontextmenu=function(i){i.preventDefault()},this._configs=t,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.scheduleSnapOrPick=!1,this.pickCursorPos=A.vec2(),this.picked=!1,this.pickedSurface=!1,this.pickResult=null,this._lastPickedEntityId=null,this._lastHash=null,this._needFireEvents=0}update(){if(!this._configs.pointerEnabled||!this.schedulePickEntity&&!this.schedulePickSurface)return;const e=`${~~this.pickCursorPos[0]}-${~~this.pickCursorPos[1]}-${this.scheduleSnapOrPick}-${this.schedulePickSurface}-${this.schedulePickEntity}`;if(this._lastHash===e)return;this.picked=!1,this.pickedSurface=!1,this.snappedOrPicked=!1,this.hoveredSnappedOrSurfaceOff=!1;const t=this._cameraControl.hasSubs("hoverSurface");if(this.scheduleSnapOrPick){const i=this._scene.pick({canvasPos:this.pickCursorPos,snapRadius:this._configs.snapRadius,snapToVertex:this._configs.snapToVertex,snapToEdge:this._configs.snapToEdge});i&&(i.snappedToEdge||i.snappedToVertex)?(this.snapPickResult=i,this.snappedOrPicked=!0,this._needFireEvents++):(this.schedulePickSurface=!0,this.snapPickResult=null)}if(this.schedulePickSurface&&this.pickResult&&this.pickResult.worldPos){const i=this.pickResult.canvasPos;if(i[0]===this.pickCursorPos[0]&&i[1]===this.pickCursorPos[1]){this.picked=!0,this.pickedSurface=!0,this._needFireEvents+=t?1:0,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.scheduleSnapOrPick?this.snappedOrPicked=!0:this.hoveredSnappedOrSurfaceOff=!0,this.scheduleSnapOrPick=!1;return}}if(this.schedulePickEntity&&this.pickResult&&(this.pickResult.canvasPos||this.pickResult.snappedCanvasPos)){const i=this.pickResult.canvasPos||this.pickResult.snappedCanvasPos;if(i[0]===this.pickCursorPos[0]&&i[1]===this.pickCursorPos[1]){this.picked=!0,this.pickedSurface=!1,this.schedulePickEntity=!1,this.schedulePickSurface=!1;return}}this.schedulePickSurface||this.scheduleSnapOrPick&&!this.snapPickResult?(this.pickResult=this._scene.pick({pickSurface:!0,pickSurfaceNormal:!1,canvasPos:this.pickCursorPos}),this.pickResult?(this.picked=!0,this.scheduleSnapOrPick?this.snappedOrPicked=!0:this.pickedSurface=!0,this._needFireEvents++):this.scheduleSnapOrPick&&(this.hoveredSnappedOrSurfaceOff=!0,this._needFireEvents++)):(this.pickResult=this._scene.pick({canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!1,this._needFireEvents++)),this.scheduleSnapOrPick=!1,this.schedulePickEntity=!1,this.schedulePickSurface=!1}fireEvents(){if(this._needFireEvents!==0){if(this.hoveredSnappedOrSurfaceOff&&this._cameraControl.fire("hoverSnapOrSurfaceOff",{canvasPos:this.pickCursorPos,pointerPos:this.pickCursorPos},!0),this.snappedOrPicked)if(this.snapPickResult){const e=new xA;e.entity=this.snapPickResult.entity,e.snappedToVertex=this.snapPickResult.snappedToVertex,e.snappedToEdge=this.snapPickResult.snappedToEdge,e.worldPos=this.snapPickResult.worldPos,e.canvasPos=this.pickCursorPos,e.snappedCanvasPos=this.snapPickResult.snappedCanvasPos,this._cameraControl.fire("hoverSnapOrSurface",e,!0),this.snapPickResult=null}else this._cameraControl.fire("hoverSnapOrSurface",this.pickResult,!0);if(this.picked&&this.pickResult&&(this.pickResult.entity||this.pickResult.worldPos)){if(this.pickResult.entity){const e=this.pickResult.entity.id;this._lastPickedEntityId!==e&&(this._lastPickedEntityId!==void 0&&this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._cameraControl.fire("hoverEnter",this.pickResult,!0),this._lastPickedEntityId=e)}this._cameraControl.fire("hover",this.pickResult,!0),this.pickResult.worldPos&&(this.pickedSurface=!0,this._cameraControl.fire("hoverSurface",this.pickResult,!0))}else this._lastPickedEntityId!==void 0&&(this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),this._cameraControl.fire("hoverOff",{canvasPos:this.pickCursorPos},!0);this.pickResult=null,this._needFireEvents=0}}}const Sn=A.vec2(),hB=function(r,e){if(!r)r=window.event,e[0]=r.x,e[1]=r.y;else{let t=r.target,i=0,s=0,o=0,a=0;for(;t.offsetParent;)i+=t.offsetLeft,s+=t.offsetTop,o+=t.scrollLeft,a+=t.scrollTop,t=t.offsetParent;e[0]=r.pageX+o-i,e[1]=r.pageY+a-s}return e};class uB{constructor(e,t,i,s,o){this._scene=e;const a=t.pickController,n=t.cameraControl;let l=0,c=0,h=0,d=0,p,m,g,u=!1;const x=A.vec3();let y=!0;const P=this._scene.canvas.canvas,_=[];document.addEventListener("keydown",this._documentKeyDownHandler=z=>{if(!(i.active&&i.pointerEnabled)||!e.input.keyboardEnabled)return;const Q=z.keyCode;_[Q]=!0}),document.addEventListener("keyup",this._documentKeyUpHandler=z=>{if(!(i.active&&i.pointerEnabled)||!e.input.keyboardEnabled)return;const Q=z.keyCode;_[Q]=!1});function b(z=!0){B(),z&&w()}function B(){l=s.pointerCanvasPos[0],c=s.pointerCanvasPos[1],h=s.pointerCanvasPos[0],d=s.pointerCanvasPos[1]}function w(){a.pickCursorPos=s.pointerCanvasPos,a.schedulePickSurface=!0,a.update(),a.picked&&a.pickedSurface&&a.pickResult&&a.pickResult.worldPos?(u=!0,x.set(a.pickResult.worldPos)):u=!1}function C(){return i.planView||n._isKeyDownForAction(n.MOUSE_PAN,_)}function E(){return n._isKeyDownForAction(n.MOUSE_ROTATE,_)}P.addEventListener("mousedown",this._mouseDownHandler=z=>{if(i.active&&i.pointerEnabled)switch(z.which){case 1:_[e.input.KEY_SHIFT]||i.planView?(p=!0,_[e.input.MOUSE_LEFT_BUTTON]=!0,b()):(p=!0,_[e.input.MOUSE_LEFT_BUTTON]=!0,b(!1));break;case 2:m=!0,_[e.input.MOUSE_MIDDLE_BUTTON]=!0,b();break;case 3:g=!0,_[e.input.MOUSE_RIGHT_BUTTON]=!0,i.panRightClick&&b();break}}),document.addEventListener("mousemove",this._documentMouseMoveHandler=z=>{if(!(i.active&&i.pointerEnabled)||!p&&!m&&!g)return;const Q=e.canvas.boundary,H=Q[2],ae=Q[3],pe=s.pointerCanvasPos[0],ge=s.pointerCanvasPos[1],fe=C(),Me=E(),be=document.pointerLockElement?z.movementX:pe-l,Fe=document.pointerLockElement?z.movementY:ge-c;if(fe){const Re=e.camera;if(Re.projection==="perspective"){const Ne=Math.abs(u?A.lenVec3(A.subVec3(x,e.camera.eye,[])):e.camera.eyeLookDist)*Math.tan(Re.perspective.fov/2*Math.PI/180);o.panDeltaX+=1.5*be*Ne/ae,o.panDeltaY+=1.5*Fe*Ne/ae}else o.panDeltaX+=.5*Re.ortho.scale*(be/ae),o.panDeltaY+=.5*Re.ortho.scale*(Fe/ae)}else Me&&(i.planView||(i.firstPerson?(o.rotateDeltaY-=be/H*i.dragRotationRate/2,o.rotateDeltaX+=Fe/ae*(i.dragRotationRate/4)):(o.rotateDeltaY-=be/H*(i.dragRotationRate*1.5),o.rotateDeltaX+=Fe/ae*(i.dragRotationRate*1.5))));l=pe,c=ge}),P.addEventListener("mousemove",this._canvasMouseMoveHandler=z=>{i.active&&i.pointerEnabled&&s.mouseover&&(y=!0)}),document.addEventListener("mouseup",this._documentMouseUpHandler=z=>{if(i.active&&i.pointerEnabled)switch(z.which){case 1:p=!1,m=!1,g=!1,_[e.input.MOUSE_LEFT_BUTTON]=!1,_[e.input.MOUSE_MIDDLE_BUTTON]=!1,_[e.input.MOUSE_RIGHT_BUTTON]=!1;break;case 2:p=!1,m=!1,g=!1,_[e.input.MOUSE_LEFT_BUTTON]=!1,_[e.input.MOUSE_MIDDLE_BUTTON]=!1,_[e.input.MOUSE_RIGHT_BUTTON]=!1;break;case 3:p=!1,m=!1,g=!1,_[e.input.MOUSE_LEFT_BUTTON]=!1,_[e.input.MOUSE_MIDDLE_BUTTON]=!1,_[e.input.MOUSE_RIGHT_BUTTON]=!1;break}}),P.addEventListener("mouseup",this._mouseUpHandler=z=>{if(i.active&&i.pointerEnabled){switch(z.which){case 3:hB(z,Sn);const Q=Sn[0],H=Sn[1];Math.abs(Q-h)<3&&Math.abs(H-d)<3&&t.cameraControl.fire("rightClick",{pagePos:[Math.round(z.pageX),Math.round(z.pageY)],canvasPos:Sn,event:z},!0);break}P.style.removeProperty("cursor")}}),P.addEventListener("mouseenter",this._mouseEnterHandler=()=>{i.active&&i.pointerEnabled});const I=1/20,R=1/60;let F=null;P.addEventListener("wheel",this._mouseWheelHandler=z=>{if(!(i.active&&i.pointerEnabled&&i.zoomOnMouseWheel&&n._isKeyDownForAction(n.MOUSE_DOLLY,_)))return;const Q=performance.now()/1e3;var H=F!==null?Q-F:0;F=Q,H>I&&(H=I),H<R&&(H=R);const ae=Math.max(-1,Math.min(1,-z.deltaY*40));if(ae===0)return;const pe=ae/Math.abs(ae);o.dollyDelta+=-pe*H*i.mouseWheelDollyRate,y&&(s.followPointerDirty=!0,y=!1)},{passive:!0})}reset(){}destroy(){const e=this._scene.canvas.canvas;document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler),e.removeEventListener("mousedown",this._mouseDownHandler),document.removeEventListener("mousemove",this._documentMouseMoveHandler),e.removeEventListener("mousemove",this._canvasMouseMoveHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._mouseUpHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("wheel",this._mouseWheelHandler)}}const ci=A.vec3(),rr=A.vec3(),ud=A.vec3(),dB=A.vec3(),or=A.vec3(),Rt={eye:A.vec3(),look:A.vec3(),up:A.vec3()};class pB{constructor(e,t,i,s){this._scene=e;const o=t.cameraControl,a=e.camera;this._onSceneKeyDown=e.input.on("keydown",()=>{if(!(i.active&&i.pointerEnabled)||!e.input.keyboardEnabled||i.keyboardEnabledOnlyIfMouseover&&!s.mouseover)return;const n=o._isKeyDownForAction(o.AXIS_VIEW_RIGHT),l=o._isKeyDownForAction(o.AXIS_VIEW_BACK),c=o._isKeyDownForAction(o.AXIS_VIEW_LEFT),h=o._isKeyDownForAction(o.AXIS_VIEW_FRONT),d=o._isKeyDownForAction(o.AXIS_VIEW_TOP),p=o._isKeyDownForAction(o.AXIS_VIEW_BOTTOM);if(!n&&!l&&!c&&!h&&!d&&!p)return;const m=e.aabb,g=A.getAABB3Diag(m);A.getAABB3Center(m,ci);const u=Math.abs(g/Math.tan(t.cameraFlight.fitFOV*A.DEGTORAD)),x=g*1.1;Rt.orthoScale=x,n?(Rt.eye.set(A.addVec3(ci,A.mulVec3Scalar(a.worldRight,u,rr),or)),Rt.look.set(ci),Rt.up.set(a.worldUp)):l?(Rt.eye.set(A.addVec3(ci,A.mulVec3Scalar(a.worldForward,u,rr),or)),Rt.look.set(ci),Rt.up.set(a.worldUp)):c?(Rt.eye.set(A.addVec3(ci,A.mulVec3Scalar(a.worldRight,-u,rr),or)),Rt.look.set(ci),Rt.up.set(a.worldUp)):h?(Rt.eye.set(A.addVec3(ci,A.mulVec3Scalar(a.worldForward,-u,rr),or)),Rt.look.set(ci),Rt.up.set(a.worldUp)):d?(Rt.eye.set(A.addVec3(ci,A.mulVec3Scalar(a.worldUp,u,rr),or)),Rt.look.set(ci),Rt.up.set(A.normalizeVec3(A.mulVec3Scalar(a.worldForward,1,ud),dB))):p&&(Rt.eye.set(A.addVec3(ci,A.mulVec3Scalar(a.worldUp,-u,rr),or)),Rt.look.set(ci),Rt.up.set(A.normalizeVec3(A.mulVec3Scalar(a.worldForward,-1,ud)))),!i.firstPerson&&i.followPointer&&t.pivotController.setPivotPos(ci),t.cameraFlight.duration>0?t.cameraFlight.flyTo(Rt,()=>{t.pivotController.getPivoting()&&i.followPointer&&t.pivotController.showPivot()}):(t.cameraFlight.jumpTo(Rt),t.pivotController.getPivoting()&&i.followPointer&&t.pivotController.showPivot())})}reset(){}destroy(){this._scene.input.off(this._onSceneKeyDown)}}class fB{constructor(e,t,i,s,o){this._scene=e;const a=t.pickController,n=t.pivotController,l=t.cameraControl;this._clicks=0,this._timeout=null,this._lastPickedEntityId=null,this._lastClickedWorldPos=null;let c=!1,h=!1;const d=this._scene.canvas.canvas,p=g=>{let u;g&&g.worldPos&&(u=g.worldPos);const x=g&&g.entity?g.entity.aabb:e.aabb;if(u){const y=e.camera;A.subVec3(y.eye,y.look,[]),t.cameraFlight.flyTo({aabb:x})}else t.cameraFlight.flyTo({aabb:x})},m=e.tickify(this._canvasMouseMoveHandler=g=>{if(!(i.active&&i.pointerEnabled)||c||h)return;if(l.hasSubs("rayMove")){const B=A.vec3(),w=A.vec3();A.canvasPosToWorldRay(e.canvas.canvas,e.camera.viewMatrix,e.camera.projMatrix,e.camera.projection,s.pointerCanvasPos,B,w),l.fire("rayMove",{canvasPos:s.pointerCanvasPos,ray:{origin:B,direction:w,canvasPos:s.pointerCanvasPos}},!0)}const u=l.hasSubs("hover"),x=l.hasSubs("hoverEnter"),y=l.hasSubs("hoverOut"),P=l.hasSubs("hoverOff"),_=l.hasSubs("hoverSurface"),b=l.hasSubs("hoverSnapOrSurface");if(u||x||y||P||_||b)if(a.pickCursorPos=s.pointerCanvasPos,a.schedulePickEntity=!0,a.schedulePickSurface=_,a.scheduleSnapOrPick=b,a.update(),a.pickResult){if(a.pickResult.entity){const B=a.pickResult.entity.id;this._lastPickedEntityId!==B&&(this._lastPickedEntityId!==void 0&&l.fire("hoverOut",{entity:e.objects[this._lastPickedEntityId]},!0),l.fire("hoverEnter",a.pickResult,!0),this._lastPickedEntityId=B)}l.fire("hover",a.pickResult,!0),(a.pickResult.worldPos||a.pickResult.snappedWorldPos)&&l.fire("hoverSurface",a.pickResult,!0)}else this._lastPickedEntityId!==void 0&&(l.fire("hoverOut",{entity:e.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),l.fire("hoverOff",{canvasPos:a.pickCursorPos},!0)});d.addEventListener("mousemove",m),d.addEventListener("mousedown",this._canvasMouseDownHandler=g=>{if(g.which===1&&(c=!0),g.which===3&&(h=!0),g.which===1&&i.active&&i.pointerEnabled&&(s.mouseDownClientX=g.clientX,s.mouseDownClientY=g.clientY,s.mouseDownCursorX=s.pointerCanvasPos[0],s.mouseDownCursorY=s.pointerCanvasPos[1],!i.firstPerson&&i.followPointer&&(a.pickCursorPos=s.pointerCanvasPos,a.schedulePickSurface=!0,a.update(),g.which===1))){const x=a.pickResult;x&&x.worldPos?(n.setPivotPos(x.worldPos),n.startPivot(),this._lastClickedWorldPos=x.worldPos.slice()):(i.smartPivot?n.setCanvasPivotPos(s.pointerCanvasPos):this._lastClickedWorldPos?n.setPivotPos(this._lastClickedWorldPos):n.setPivotPos(e.camera.look),n.startPivot())}}),document.addEventListener("mouseup",this._documentMouseUpHandler=g=>{g.which===1&&(c=!1),g.which===3&&(h=!1),n.getPivoting()&&n.endPivot()}),d.addEventListener("mouseup",this._canvasMouseUpHandler=g=>{if(!(i.active&&i.pointerEnabled)||!(g.which===1)||(n.hidePivot(),Math.abs(g.clientX-s.mouseDownClientX)>3||Math.abs(g.clientY-s.mouseDownClientY)>3))return;const x=l.hasSubs("picked"),y=l.hasSubs("pickedNothing"),P=l.hasSubs("pickedSurface"),_=l.hasSubs("doublePicked"),b=l.hasSubs("doublePickedSurface"),B=l.hasSubs("doublePickedNothing");if(!i.doublePickFlyTo&&!_&&!b&&!B){(x||y||P)&&(a.pickCursorPos=s.pointerCanvasPos,a.schedulePickEntity=!0,a.schedulePickSurface=P,a.update(),a.pickResult?(l.fire("picked",a.pickResult,!0),a.pickedSurface&&l.fire("pickedSurface",a.pickResult,!0)):l.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0)),this._clicks=0;return}if(this._clicks++,this._clicks===1){a.pickCursorPos=s.pointerCanvasPos,a.schedulePickEntity=i.doublePickFlyTo,a.schedulePickSurface=P,a.update();const w=a.pickResult,C=a.pickedSurface;this._timeout=setTimeout(()=>{w&&w.worldPos?(l.fire("picked",w,!0),C&&(l.fire("pickedSurface",w,!0),!i.firstPerson&&i.followPointer&&(t.pivotController.setPivotPos(w.worldPos),t.pivotController.startPivot()&&t.pivotController.showPivot()))):l.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0),this._clicks=0},i.doubleClickTimeFrame)}else{if(this._timeout!==null&&(window.clearTimeout(this._timeout),this._timeout=null),a.pickCursorPos=s.pointerCanvasPos,a.schedulePickEntity=i.doublePickFlyTo||_||b,a.schedulePickSurface=a.schedulePickEntity&&b,a.update(),a.pickResult){if(l.fire("doublePicked",a.pickResult,!0),a.pickedSurface&&l.fire("doublePickedSurface",a.pickResult,!0),i.doublePickFlyTo&&(p(a.pickResult),!i.firstPerson&&i.followPointer)){const w=a.pickResult.entity.aabb,C=A.getAABB3Center(w);t.pivotController.setPivotPos(C),t.pivotController.startPivot()&&t.pivotController.showPivot()}}else if(l.fire("doublePickedNothing",{canvasPos:s.pointerCanvasPos},!0),i.doublePickFlyTo&&(p(),!i.firstPerson&&i.followPointer)){const w=e.aabb,C=A.getAABB3Center(w);t.pivotController.setPivotPos(C),t.pivotController.startPivot()&&t.pivotController.showPivot()}this._clicks=0}},!1)}reset(){this._clicks=0,this._lastPickedEntityId=null,this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("mousemove",this._canvasMouseMoveHandler),e.removeEventListener("mousedown",this._canvasMouseDownHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._canvasMouseUpHandler),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}}class mB{constructor(e,t,i,s,o){this._scene=e;const a=e.input,n=[];e.canvas.canvas;let l=!0;this._onSceneMouseMove=a.on("mousemove",()=>{l=!0}),this._onSceneKeyDown=a.on("keydown",c=>{!(i.active&&i.pointerEnabled)||!e.input.keyboardEnabled||i.keyboardEnabledOnlyIfMouseover&&!s.mouseover||(n[c]=!0)}),this._onSceneKeyUp=a.on("keyup",c=>{!(i.active&&i.pointerEnabled)||!e.input.keyboardEnabled||(n[c]=!1,t.pivotController.getPivoting()&&t.pivotController.endPivot())}),this._onTick=e.on("tick",c=>{if(!(i.active&&i.pointerEnabled)||!e.input.keyboardEnabled||i.keyboardEnabledOnlyIfMouseover&&!s.mouseover)return;const h=t.cameraControl,d=c.deltaTime/1e3;if(!i.planView){const _=h._isKeyDownForAction(h.ROTATE_Y_POS,n),b=h._isKeyDownForAction(h.ROTATE_Y_NEG,n),B=h._isKeyDownForAction(h.ROTATE_X_POS,n),w=h._isKeyDownForAction(h.ROTATE_X_NEG,n),C=d*i.keyboardRotationRate;(_||b||B||w)&&(!i.firstPerson&&i.followPointer&&t.pivotController.startPivot(),_?o.rotateDeltaY+=C:b&&(o.rotateDeltaY-=C),B?o.rotateDeltaX+=C:w&&(o.rotateDeltaX-=C),!i.firstPerson&&i.followPointer&&t.pivotController.startPivot())}if(!n[a.KEY_CTRL]&&!n[a.KEY_ALT]){const _=h._isKeyDownForAction(h.DOLLY_BACKWARDS,n),b=h._isKeyDownForAction(h.DOLLY_FORWARDS,n);if(_||b){const B=d*i.keyboardDollyRate;!i.firstPerson&&i.followPointer&&t.pivotController.startPivot(),b?o.dollyDelta-=B:_&&(o.dollyDelta+=B),l&&(s.followPointerDirty=!0,l=!1)}}const p=h._isKeyDownForAction(h.PAN_FORWARDS,n),m=h._isKeyDownForAction(h.PAN_BACKWARDS,n),g=h._isKeyDownForAction(h.PAN_LEFT,n),u=h._isKeyDownForAction(h.PAN_RIGHT,n),x=h._isKeyDownForAction(h.PAN_UP,n),y=h._isKeyDownForAction(h.PAN_DOWN,n),P=(n[a.KEY_ALT]?.3:1)*d*i.keyboardPanRate;(p||m||g||u||x||y)&&(!i.firstPerson&&i.followPointer&&t.pivotController.startPivot(),y?o.panDeltaY+=P:x&&(o.panDeltaY+=-P),u?o.panDeltaX+=-P:g&&(o.panDeltaX+=P),m?o.panDeltaZ+=P:p&&(o.panDeltaZ+=-P))})}reset(){}destroy(){this._scene.off(this._onTick),this._scene.input.off(this._onSceneMouseMove),this._scene.input.off(this._onSceneKeyDown),this._scene.input.off(this._onSceneKeyUp)}}const dd=1,nr=.001,gB=A.vec3();class _B{constructor(e,t,i,s,o){this._scene=e;const a=e.camera,n=t.pickController,l=t.pivotController,c=t.panController,h=t.cameraControl;let d=dd,p=1,m=null;this._onTick=e.on("tick",()=>{if(!(i.active&&i.pointerEnabled))return;let g="default";Math.abs(o.dollyDelta)<nr&&(o.dollyDelta=0),Math.abs(o.rotateDeltaX)<nr&&(o.rotateDeltaX=0),Math.abs(o.rotateDeltaY)<nr&&(o.rotateDeltaY=0),(o.rotateDeltaX!==0||o.rotateDeltaY!==0)&&(o.dollyDelta=0),i.followPointer?--d<=0&&(d=dd,o.dollyDelta!==0&&(o.rotateDeltaY===0&&o.rotateDeltaX===0&&i.followPointer&&s.followPointerDirty&&(n.pickCursorPos=s.pointerCanvasPos,n.schedulePickSurface=!0,n.update(),n.pickResult&&n.pickResult.worldPos?m=n.pickResult.worldPos:(p=1,m=null),s.followPointerDirty=!1),m&&(p=Math.abs(A.lenVec3(A.subVec3(m,e.camera.eye,gB)))/i.dollyProximityThreshold),p<i.dollyMinSpeed&&(p=i.dollyMinSpeed))):(p=1,m=null);const u=o.dollyDelta*p;if((o.rotateDeltaY!==0||o.rotateDeltaX!==0)&&(!i.firstPerson&&i.followPointer&&l.getPivoting()?(l.continuePivot(o.rotateDeltaY,o.rotateDeltaX),l.showPivot()):(o.rotateDeltaX!==0&&(i.firstPerson?a.pitch(-o.rotateDeltaX):a.orbitPitch(o.rotateDeltaX)),o.rotateDeltaY!==0&&(i.firstPerson?a.yaw(o.rotateDeltaY):a.orbitYaw(o.rotateDeltaY))),o.rotateDeltaX*=i.rotationInertia,o.rotateDeltaY*=i.rotationInertia,g=h._cursors.rotate),Math.abs(o.panDeltaX)<nr&&(o.panDeltaX=0),Math.abs(o.panDeltaY)<nr&&(o.panDeltaY=0),Math.abs(o.panDeltaZ)<nr&&(o.panDeltaZ=0),o.panDeltaX!==0||o.panDeltaY!==0||o.panDeltaZ!==0){const x=A.vec3();x[0]=o.panDeltaX,x[1]=o.panDeltaY,x[2]=o.panDeltaZ;let y,P;if(i.constrainVertical){a.xUp?(y=a.eye[0],P=a.look[0]):a.yUp?(y=a.eye[1],P=a.look[1]):a.zUp&&(y=a.eye[2],P=a.look[2]),a.pan(x);const _=a.eye,b=a.look;a.xUp?(_[0]=y,b[0]=P):a.yUp?(_[1]=y,b[1]=P):a.zUp&&(_[2]=y,b[2]=P),a.eye=_,a.look=b}else a.pan(x);g=h._cursors.pan}if(o.panDeltaX*=i.panInertia,o.panDeltaY*=i.panInertia,o.panDeltaZ*=i.panInertia,u!==0){if(u<0?g=h._cursors.dollyForward:g=h._cursors.dollyBackward,i.firstPerson){let x,y;if(i.constrainVertical&&(a.xUp?(x=a.eye[0],y=a.look[0]):a.yUp?(x=a.eye[1],y=a.look[1]):a.zUp&&(x=a.eye[2],y=a.look[2])),i.followPointer?c.dollyToCanvasPos(m,s.pointerCanvasPos,-u)&&(s.followPointerDirty=!0):(a.pan([0,0,u]),a.ortho.scale=a.ortho.scale-u),i.constrainVertical){const P=a.eye,_=a.look;a.xUp?(P[0]=x,_[0]=y):a.yUp?(P[1]=x,_[1]=y):a.zUp&&(P[2]=x,_[2]=y),a.eye=P,a.look=_}}else i.planView,i.followPointer?c.dollyToCanvasPos(m,s.pointerCanvasPos,-u)&&(s.followPointerDirty=!0):(a.ortho.scale=a.ortho.scale+u,a.zoom(u));o.dollyDelta*=i.dollyInertia}n.fireEvents(),document.body.style.cursor=g})}destroy(){this._scene.off(this._onTick)}}class vB{constructor(e,t,i,s,o){this._scene=e;const a=this._scene.canvas.canvas;a.addEventListener("mouseenter",this._mouseEnterHandler=()=>{s.mouseover=!0}),a.addEventListener("mouseleave",this._mouseLeaveHandler=()=>{s.mouseover=!1,a.style.cursor=null}),document.addEventListener("mousemove",this._mouseMoveHandler=n=>{pd(n,a,s.pointerCanvasPos)}),a.addEventListener("mousedown",this._mouseDownHandler=n=>{i.active&&i.pointerEnabled&&(pd(n,a,s.pointerCanvasPos),s.mouseover=!0)}),a.addEventListener("mouseup",this._mouseUpHandler=n=>{i.active&&i.pointerEnabled})}reset(){}destroy(){const e=this._scene.canvas.canvas;document.removeEventListener("mousemove",this._mouseMoveHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("mouseleave",this._mouseLeaveHandler),e.removeEventListener("mousedown",this._mouseDownHandler),e.removeEventListener("mouseup",this._mouseUpHandler)}}function pd(r,e,t){if(!r)r=window.event,t[0]=r.x,t[1]=r.y;else{const{left:i,top:s}=e.getBoundingClientRect();t[0]=r.clientX-i,t[1]=r.clientY-s}return t}const ar=function(r,e){if(!r)r=window.event,e[0]=r.x,e[1]=r.y;else{let t=r.target,i=0,s=0;for(;t.offsetParent;)i+=t.offsetLeft,s+=t.offsetTop,t=t.offsetParent;e[0]=r.pageX-i,e[1]=r.pageY-s}return e};class PB{constructor(e,t,i,s,o){this._scene=e;const a=t.pickController,n=t.pivotController,l=A.vec2(),c=A.vec2(),h=A.vec2(),d=A.vec2(),p=[],m=this._scene.canvas.canvas;let g=0,u=!1;this._onTick=e.on("tick",()=>{u=!1}),m.addEventListener("touchstart",this._canvasTouchStartHandler=x=>{if(!(i.active&&i.pointerEnabled))return;x.preventDefault();const y=x.touches,P=x.changedTouches;for(s.touchStartTime=Date.now(),y.length===1&&P.length===1&&(ar(y[0],l),i.followPointer&&(a.pickCursorPos=l,a.schedulePickSurface=!0,a.update(),i.planView||(a.picked&&a.pickedSurface&&a.pickResult&&a.pickResult.worldPos?(n.setPivotPos(a.pickResult.worldPos),!i.firstPerson&&n.startPivot()&&n.showPivot()):(i.smartPivot?n.setCanvasPivotPos(s.pointerCanvasPos):n.setPivotPos(e.camera.look),!i.firstPerson&&n.startPivot()&&n.showPivot()))));p.length<y.length;)p.push(A.vec2());for(let _=0,b=y.length;_<b;++_)ar(y[_],p[_]);g=y.length}),m.addEventListener("touchend",this._canvasTouchEndHandler=()=>{n.getPivoting()&&(n.endPivot(),n.hidePivot())}),m.addEventListener("touchmove",this._canvasTouchMoveHandler=x=>{if(!(i.active&&i.pointerEnabled)||(x.stopPropagation(),x.preventDefault(),u))return;u=!0;const y=e.canvas.boundary,P=y[2],_=y[3],b=x.touches;if(x.touches.length===g){if(g===1){ar(b[0],c),A.subVec2(c,p[0],d);const B=d[0],w=d[1];if(s.longTouchTimeout!==null&&(Math.abs(B)>i.longTapRadius||Math.abs(w)>i.longTapRadius)&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null),i.planView){const C=e.camera;if(C.projection==="perspective"){const I=Math.abs(e.camera.eyeLookDist)*Math.tan(C.perspective.fov/2*Math.PI/180);o.panDeltaX+=B*I/_*i.touchPanRate,o.panDeltaY+=w*I/_*i.touchPanRate}else o.panDeltaX+=.5*C.ortho.scale*(B/_)*i.touchPanRate,o.panDeltaY+=.5*C.ortho.scale*(w/_)*i.touchPanRate}else o.rotateDeltaY-=B/P*(i.dragRotationRate*1),o.rotateDeltaX+=w/_*(i.dragRotationRate*1.5)}else if(g===2){const B=b[0],w=b[1];ar(B,c),ar(w,h);const C=A.geometricMeanVec2(p[0],p[1]),E=A.geometricMeanVec2(c,h),I=A.vec2();A.subVec2(C,E,I);const R=I[0],F=I[1],z=e.camera,Q=A.distVec2([B.pageX,B.pageY],[w.pageX,w.pageY]),ae=(A.distVec2(p[0],p[1])-Q)*i.touchDollyRate;if(o.dollyDelta=ae,Math.abs(ae)<1)if(z.projection==="perspective"){const pe=a.pickResult?a.pickResult.worldPos:e.center,fe=Math.abs(A.lenVec3(A.subVec3(pe,e.camera.eye,[])))*Math.tan(z.perspective.fov/2*Math.PI/180);o.panDeltaX-=R*fe/_*i.touchPanRate,o.panDeltaY-=F*fe/_*i.touchPanRate}else o.panDeltaX-=.5*z.ortho.scale*(R/_)*i.touchPanRate,o.panDeltaY-=.5*z.ortho.scale*(F/_)*i.touchPanRate;s.pointerCanvasPos=E}for(let B=0;B<g;++B)ar(b[B],p[B])}})}reset(){}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchend",this._canvasTouchEndHandler),e.removeEventListener("touchmove",this._canvasTouchMoveHandler),this._scene.off(this._onTick)}}const xB=150,yB=325,bB=4,Tn=function(r,e){if(!r)r=window.event,e[0]=r.x,e[1]=r.y;else{let t=r.target,i=0,s=0;for(;t.offsetParent;)i+=t.offsetLeft,s+=t.offsetTop,t=t.offsetParent;e[0]=r.pageX-i,e[1]=r.pageY-s}return e};class BB{constructor(e,t,i,s,o){this._scene=e;const a=t.pickController,n=t.cameraControl;let l;const c=[],h=new Float32Array(2);let d=-1,p=-1;const m=this._scene.canvas.canvas,g=u=>{let x;u&&u.worldPos&&(x=u.worldPos);const y=u?u.entity.aabb:e.aabb;if(x){const P=e.camera;A.subVec3(P.eye,P.look,[]),t.cameraFlight.flyTo({aabb:y})}else t.cameraFlight.flyTo({aabb:y})};m.addEventListener("touchstart",this._canvasTouchStartHandler=u=>{if(!(i.active&&i.pointerEnabled))return;s.longTouchTimeout!==null&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null);const x=u.touches,y=u.changedTouches;if(l=Date.now(),x.length===1&&y.length===1){d=l,Tn(x[0],h);const P=h[0],_=h[1],b=x[0].pageX,B=x[0].pageY;s.longTouchTimeout=setTimeout(()=>{t.cameraControl.fire("rightClick",{pagePos:[Math.round(b),Math.round(B)],canvasPos:[Math.round(P),Math.round(_)],event:u},!0),s.longTouchTimeout=null},i.longTapTimeout)}else d=-1;for(;c.length<x.length;)c.push(new Float32Array(2));for(let P=0,_=x.length;P<_;++P)Tn(x[P],c[P]);c.length=x.length},{passive:!0}),m.addEventListener("touchend",this._canvasTouchEndHandler=u=>{if(!(i.active&&i.pointerEnabled))return;const x=Date.now(),y=u.touches,P=u.changedTouches,_=n.hasSubs("pickedSurface");s.longTouchTimeout!==null&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null),y.length===0&&P.length===1&&d>-1&&x-d<xB&&(p>-1&&d-p<yB?(Tn(P[0],a.pickCursorPos),a.schedulePickEntity=!0,a.schedulePickSurface=_,a.update(),a.pickResult?(a.pickResult.touchInput=!0,n.fire("doublePicked",a.pickResult),a.pickedSurface&&n.fire("doublePickedSurface",a.pickResult),i.doublePickFlyTo&&g(a.pickResult)):(n.fire("doublePickedNothing"),i.doublePickFlyTo&&g()),p=-1):A.distVec2(c[0],h)<bB&&(Tn(P[0],a.pickCursorPos),a.schedulePickEntity=!0,a.schedulePickSurface=_,a.update(),a.pickResult?(a.pickResult.touchInput=!0,n.fire("picked",a.pickResult),a.pickedSurface&&n.fire("pickedSurface",a.pickResult)):n.fire("pickedNothing"),p=x),d=-1),c.length=y.length;for(let b=0,B=y.length;b<B;++b)c[b][0]=y[b].pageX,c[b][1]=y[b].pageY},{passive:!0})}reset(){}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchend",this._canvasTouchEndHandler)}}const fd=30,wB=!0,CB=!0;class MB extends vt{constructor(e,t={}){super(e,t),this.PAN_LEFT=0,this.PAN_RIGHT=1,this.PAN_UP=2,this.PAN_DOWN=3,this.PAN_FORWARDS=4,this.PAN_BACKWARDS=5,this.ROTATE_X_POS=6,this.ROTATE_X_NEG=7,this.ROTATE_Y_POS=8,this.ROTATE_Y_NEG=9,this.DOLLY_FORWARDS=10,this.DOLLY_BACKWARDS=11,this.AXIS_VIEW_RIGHT=12,this.AXIS_VIEW_BACK=13,this.AXIS_VIEW_LEFT=14,this.AXIS_VIEW_FRONT=15,this.AXIS_VIEW_TOP=16,this.AXIS_VIEW_BOTTOM=17,this.MOUSE_PAN=18,this.MOUSE_ROTATE=19,this.MOUSE_DOLLY=20,this._keyMap={},this.scene.canvas.canvas.oncontextmenu=s=>{s.preventDefault()},this._configs={longTapTimeout:600,longTapRadius:5,active:!0,keyboardLayout:"qwerty",navMode:"orbit",planView:!1,firstPerson:!1,followPointer:!0,doublePickFlyTo:!0,panRightClick:!0,showPivot:!1,pointerEnabled:!0,constrainVertical:!1,smartPivot:!1,doubleClickTimeFrame:250,zoomOnMouseWheel:!0,snapToVertex:wB,snapToEdge:CB,snapRadius:fd,keyboardEnabledOnlyIfMouseover:!0,dragRotationRate:360,keyboardRotationRate:90,rotationInertia:0,keyboardPanRate:1,touchPanRate:1,panInertia:.5,keyboardDollyRate:10,mouseWheelDollyRate:100,touchDollyRate:.2,dollyInertia:0,dollyProximityThreshold:30,dollyMinSpeed:.04},this._states={pointerCanvasPos:A.vec2(),mouseover:!1,followPointerDirty:!0,mouseDownClientX:0,mouseDownClientY:0,mouseDownCursorX:0,mouseDownCursorY:0,touchStartTime:null,activeTouches:[],tapStartPos:A.vec2(),tapStartTime:-1,lastTapTime:-1,longTouchTimeout:null},this._updates={rotateDeltaX:0,rotateDeltaY:0,panDeltaX:0,panDeltaY:0,panDeltaZ:0,dollyDelta:0};const i=this.scene;this._controllers={cameraControl:this,pickController:new cB(this,this._configs),pivotController:new AB(i,this._configs),panController:new rB(i),cameraFlight:new js(this,{duration:.5})},this._handlers=[new vB(this.scene,this._controllers,this._configs,this._states,this._updates),new PB(this.scene,this._controllers,this._configs,this._states,this._updates),new uB(this.scene,this._controllers,this._configs,this._states,this._updates),new pB(this.scene,this._controllers,this._configs,this._states,this._updates),new fB(this.scene,this._controllers,this._configs,this._states,this._updates),new BB(this.scene,this._controllers,this._configs,this._states,this._updates),new mB(this.scene,this._controllers,this._configs,this._states,this._updates)],this._cursors={dollyForward:"zoom-in",dollyBackward:"zoom-out",rotate:"grabbing",pan:"move"},this._cameraUpdater=new _B(this.scene,this._controllers,this._configs,this._states,this._updates),this.navMode=t.navMode,t.planView&&(this.planView=t.planView),this.constrainVertical=t.constrainVertical,t.keyboardLayout?this.keyboardLayout=t.keyboardLayout:this.keyMap=t.keyMap,this.doublePickFlyTo=t.doublePickFlyTo,this.panRightClick=t.panRightClick,this.active=t.active,this.followPointer=t.followPointer,this.rotationInertia=t.rotationInertia,this.keyboardPanRate=t.keyboardPanRate,this.touchPanRate=t.touchPanRate,this.keyboardRotationRate=t.keyboardRotationRate,this.dragRotationRate=t.dragRotationRate,this.touchDollyRate=t.touchDollyRate,this.dollyInertia=t.dollyInertia,this.dollyProximityThreshold=t.dollyProximityThreshold,this.dollyMinSpeed=t.dollyMinSpeed,this.panInertia=t.panInertia,this.pointerEnabled=!0,this.keyboardDollyRate=t.keyboardDollyRate,this.mouseWheelDollyRate=t.mouseWheelDollyRate}set keyMap(e){if(e=e||"qwerty",we.isString(e)){const t=this.scene.input,i={};switch(e){default:this.error("Unsupported value for 'keyMap': "+e+" defaulting to 'qwerty'");case"qwerty":i[this.PAN_LEFT]=[t.KEY_A],i[this.PAN_RIGHT]=[t.KEY_D],i[this.PAN_UP]=[t.KEY_Z],i[this.PAN_DOWN]=[t.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[t.KEY_W,t.KEY_ADD],i[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[t.KEY_Q,t.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6],i[this.MOUSE_PAN]=[[t.MOUSE_LEFT_BUTTON,t.KEY_SHIFT],this._configs.panRightClick?t.MOUSE_RIGHT_BUTTON:t.MOUSE_MIDDLE_BUTTON],i[this.MOUSE_ROTATE]=[t.MOUSE_LEFT_BUTTON],i[this.MOUSE_DOLLY]=[];break;case"azerty":i[this.PAN_LEFT]=[t.KEY_Q],i[this.PAN_RIGHT]=[t.KEY_D],i[this.PAN_UP]=[t.KEY_W],i[this.PAN_DOWN]=[t.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[t.KEY_Z,t.KEY_ADD],i[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[t.KEY_A,t.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6],i[this.MOUSE_PAN]=[[t.MOUSE_LEFT_BUTTON,t.KEY_SHIFT],this._configs.panRightClick?t.MOUSE_RIGHT_BUTTON:t.MOUSE_MIDDLE_BUTTON],i[this.MOUSE_ROTATE]=[t.MOUSE_LEFT_BUTTON],i[this.MOUSE_DOLLY]=[];break}this._keyMap=i}else{const t=e;this._keyMap=t}}get keyMap(){return this._keyMap}_areAllKeysDown(e,t){if(!t||t.length<=0)return!0;if(!e)return!1;for(let i=0,s=t.length;i<s;i++){const o=t[i];if(!e[o])return!1}return!0}_isAnyOtherKeyDown(e,t){for(let i=0,s=e.length;i<s;i++)if(e[i]){if(Array.isArray(t)){if(t.indexOf(i)<0)return!0}else if(i!==t)return!0}return!1}_isMouseAction(e){switch(e){case this.MOUSE_ROTATE:case this.MOUSE_DOLLY:case this.MOUSE_PAN:return!0;default:return!1}}_isKeyDownForAction(e,t){const i=this._keyMap[e];if(!i)return!1;if(i.length===0&&this._isMouseAction(e))return!0;t||(t=this.scene.input.keyDown);for(let s=0,o=i.length;s<o;s++){const a=i[s];if(Array.isArray(a)){if(this._areAllKeysDown(t,a)&&!this._isAnyOtherKeyDown(t,a))return!0}else if(t[a]&&!this._isAnyOtherKeyDown(t,a))return!0}return!1}set pivotElement(e){this._controllers.pivotController.setPivotElement(e)}set active(e){e=e!==!1,this._configs.active=e,this._handlers[1]._active=e,this._handlers[5]._active=e}get active(){return this._configs.active}set snapToVertex(e){this._configs.snapToVertex=!!e}get snapToVertex(){return this._configs.snapToVertex}set snapToEdge(e){this._configs.snapToEdge=!!e}get snapToEdge(){return this._configs.snapToEdge}set snapRadius(e){e=e||fd,this._configs.snapRadius=e}get snapRadius(){return this._configs.snapRadius}set keyboardEnabledOnlyIfMouseover(e){this._configs.keyboardEnabledOnlyIfMouseover=!!e}get keyboardEnabledOnlyIfMouseover(){return this._configs.keyboardEnabledOnlyIfMouseover}set navMode(e){e=e||"orbit",e!=="firstPerson"&&e!=="orbit"&&e!=="planView"&&(this.error("Unsupported value for navMode: "+e+" - supported values are 'orbit', 'firstPerson' and 'planView' - defaulting to 'orbit'"),e="orbit"),this._configs.firstPerson=e==="firstPerson",this._configs.planView=e==="planView",(this._configs.firstPerson||this._configs.planView)&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this._configs.navMode=e}get navMode(){return this._configs.navMode}set pointerEnabled(e){this._reset(),this._configs.pointerEnabled=!!e}setCursorStyle(e,t){Object.prototype.hasOwnProperty.call(this._cursors,e)?this._cursors={...this._cursors,[e]:t}:console.warn(`Action '${e}' is not valid for cursor styles.`)}getCursorStyle(e){return this._cursors[e]||null}_reset(){for(let e=0,t=this._handlers.length;e<t;e++){const i=this._handlers[e];i.reset&&i.reset()}this._updates.panDeltaX=0,this._updates.panDeltaY=0,this._updates.rotateDeltaX=0,this._updates.rotateDeltaY=0,this._updates.dolyDelta=0}get pointerEnabled(){return this._configs.pointerEnabled}set followPointer(e){this._configs.followPointer=e!==!1}get followPointer(){return this._configs.followPointer}set pivotPos(e){this._controllers.pivotController.setPivotPos(e)}get pivotPos(){return this._controllers.pivotController.getPivotPos()}set dollyToPointer(e){this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer=e}get dollyToPointer(){return this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer}set panToPointer(e){this.warn("panToPointer property is deprecated - replaced with followPointer")}get panToPointer(){return this.warn("panToPointer property is deprecated - replaced with followPointer"),!1}set planView(e){this._configs.planView=!!e,this._configs.firstPerson=!1,this._configs.planView&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this.warn("planView property is deprecated - replaced with navMode")}get planView(){return this.warn("planView property is deprecated - replaced with navMode"),this._configs.planView}set firstPerson(e){this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson=!!e,this._configs.planView=!1,this._configs.firstPerson&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot())}get firstPerson(){return this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson}set constrainVertical(e){this._configs.constrainVertical=!!e}get constrainVertical(){return this._configs.constrainVertical}set doublePickFlyTo(e){this._configs.doublePickFlyTo=e!==!1}get doublePickFlyTo(){return this._configs.doublePickFlyTo}set panRightClick(e){this._configs.panRightClick=e!==!1;const t=this._keyMap[this.MOUSE_PAN];if(t&&t.length>0){const i=this.scene.input;for(let s=0,o=t.length;s<o;s++)this._configs.panRightClick&&t[s]===i.MOUSE_MIDDLE_BUTTON?this._keyMap[this.MOUSE_PAN][s]=i.MOUSE_RIGHT_BUTTON:!this._configs.panRightClick&&t[s]===i.MOUSE_RIGHT_BUTTON&&(this._keyMap[this.MOUSE_PAN][s]=i.MOUSE_MIDDLE_BUTTON)}}get panRightClick(){return this._configs.panRightClick}set rotationInertia(e){this._configs.rotationInertia=e??0}get rotationInertia(){return this._configs.rotationInertia}set keyboardPanRate(e){this._configs.keyboardPanRate=e??5}set touchPanRate(e){this._configs.touchPanRate=e??1}get touchPanRate(){return this._configs.touchPanRate}get keyboardPanRate(){return this._configs.keyboardPanRate}set keyboardRotationRate(e){this._configs.keyboardRotationRate=e??90}get keyboardRotationRate(){return this._configs.keyboardRotationRate}set dragRotationRate(e){this._configs.dragRotationRate=e??360}get dragRotationRate(){return this._configs.dragRotationRate}set keyboardDollyRate(e){this._configs.keyboardDollyRate=e??15}get keyboardDollyRate(){return this._configs.keyboardDollyRate}set touchDollyRate(e){this._configs.touchDollyRate=e??.2}get touchDollyRate(){return this._configs.touchDollyRate}set mouseWheelDollyRate(e){this._configs.mouseWheelDollyRate=e??100}get mouseWheelDollyRate(){return this._configs.mouseWheelDollyRate}set dollyInertia(e){this._configs.dollyInertia=e??0}get dollyInertia(){return this._configs.dollyInertia}set dollyProximityThreshold(e){this._configs.dollyProximityThreshold=e??35}get dollyProximityThreshold(){return this._configs.dollyProximityThreshold}set dollyMinSpeed(e){this._configs.dollyMinSpeed=e??.04}get dollyMinSpeed(){return this._configs.dollyMinSpeed}set panInertia(e){this._configs.panInertia=e??.5}get panInertia(){return this._configs.panInertia}set keyboardLayout(e){e=e||"qwerty",e!=="qwerty"&&e!=="azerty"&&(this.error("Unsupported value for keyboardLayout - defaulting to 'qwerty'"),e="qwerty"),this._configs.keyboardLayout=e,this.keyMap=this._configs.keyboardLayout}get keyboardLayout(){return this._configs.keyboardLayout}enablePivotSphere(e={}){this._controllers.pivotController.enablePivotSphere(e)}disablePivotSphere(){this._controllers.pivotController.disablePivotSphere()}set smartPivot(e){this._configs.smartPivot=e!==!1}get smartPivot(){return this._configs.smartPivot}set doubleClickTimeFrame(e){this._configs.doubleClickTimeFrame=e??250}get doubleClickTimeFrame(){return this._configs.doubleClickTimeFrame}set zoomOnMouseWheel(e){this._configs.zoomOnMouseWheel=!!e}get zoomOnMouseWheel(){return this._configs.zoomOnMouseWheel}destroy(){this._destroyHandlers(),this._destroyControllers(),this._cameraUpdater.destroy(),super.destroy()}_destroyHandlers(){for(let e=0,t=this._handlers.length;e<t;e++){const i=this._handlers[e];i.destroy&&i.destroy()}}_destroyControllers(){for(let e=0,t=this._controllers.length;e<t;e++){const i=this._controllers[e];i.destroy&&i.destroy()}}}class EB{constructor(e,t,i,s,o){this.name=e,this.type=i,this.value=t,this.valueType=s,this.description=o}}class IB{constructor(e){if(this.id=e.id,this.originalSystemId=e.originalSystemId,this.metaModels=[],this.name=e.name,this.type=e.type,this.properties=[],e.properties){const t=e.properties;for(let i=0,s=t.length;i<s;i++){const o=t[i];Number.isInteger(o)?this.properties.push(o):this.properties.push(new EB(o.name,o.value,o.type,o.valueType,o.description))}}}}class FB{constructor(e){this.metaModels=[],this.id=e.id,this.parentId=e.parentId,this.parent=null,this.originalSystemId=e.originalSystemId,this.name=e.name,this.type=e.type,this.propertySetIds=e.propertySetIds,this.propertySets=[],this.attributes=e.attributes||{},e.external!==void 0&&e.external!==null&&(this.external=e.external)}get metaModel(){return this.metaModels.length==1?this.metaModels[0]:null}getObjectIDsInSubtree(){const e=[];function t(i){if(!i)return;e.push(i.id);const s=i.children;if(s)for(var o=0,a=s.length;o<a;o++)t(s[o])}return t(this),e}withMetaObjectsInSubtree(e){function t(i){if(!i)return;e(i);const s=i.children;if(s)for(var o=0,a=s.length;o<a;o++)t(s[o])}t(this)}getObjectIDsInSubtreeByType(e){const t={};for(var i=0,s=e.length;i<s;i++)t[e[i]]=e[i];const o=[];function a(n){if(!n)return;t[n.type]&&o.push(n.id);const l=n.children;if(l)for(var c=0,h=l.length;c<h;c++)a(l[c])}return a(this),o}getJSON(){var e={id:this.id,type:this.type,name:this.name};return this.parent&&(e.parent=this.parent.id),e}}class Nf{constructor(e){this.id=e.id,this.projectId=e.projectId,this.revisionId=e.revisionId,this.author=e.author,this.createdAt=e.createdAt,this.creatingApplication=e.creatingApplication,this.schema=e.schema,this.metaScene=e.metaScene,this.propertySets=[],this.rootMetaObjects=[],this.metaObjects={},this.graph=e.graph||{},this.metaScene.metaModels[this.id]=this,this._propertyLookup=[],this.finalized=!1}get rootMetaObject(){return this.rootMetaObjects.length===1?this.rootMetaObjects[0]:null}loadData(e,t={}){if(this.finalized)throw"MetaScene already finalized - can't add more data";this._globalizeIDs(e,t);const i=this.metaScene,s=e.properties;if(s)for(let o=0,a=s.length;o<a;o++)this._propertyLookup.push(s[o]);if(e.propertySets)for(let o=0,a=e.propertySets.length;o<a;o++){const n=e.propertySets[o];n.properties||(n.properties=[]);let l=i.propertySets[n.id];l||(l=new IB({id:n.id,originalSystemId:n.originalSystemId||n.id,type:n.type,name:n.name,properties:n.properties}),i.propertySets[l.id]=l),l.metaModels.push(this),this.propertySets.push(l)}if(e.metaObjects)for(let o=0,a=e.metaObjects.length;o<a;o++){const n=e.metaObjects[o],l=n.id;let c=i.metaObjects[l];if(!c){const h=n.type,d=n.originalSystemId,p=n.propertySets||n.propertySetIds;c=new FB({id:l,originalSystemId:d,parentId:n.parent,type:h,name:n.name,attributes:n.attributes,propertySetIds:p,external:n.external}),this.metaScene.metaObjects[l]=c,c.metaModels=[]}this.metaObjects[l]=c,n.parent||(this.rootMetaObjects.push(c),i.rootMetaObjects[l]=c),c.metaModels.push(this)}}_decompressProperties(e,t){const i=[];for(let s=0,o=t.length;s<o;s++){const a=t[s];if(Number.isInteger(a)){const n=e[a];n?t[s]=n:i.push(a)}}i.length>0&&console.error(`[MetaModel._decompressProperties] Properties not found: ${i}`)}finalize(){if(this.finalized)throw"MetaScene already finalized - can't re-finalize";const e=this.metaScene;for(let t in e.metaObjects){const i=e.metaObjects[t];if(i.children&&(i.children=[]),i.propertySets&&(i.propertySets=[]),i.propertySetIds)for(let s=0,o=i.propertySetIds.length;s<o;s++){const a=i.propertySetIds[s],n=e.propertySets[a];i.propertySets.push(n)}}for(let t in e.metaObjects){const i=e.metaObjects[t];if(i.parentId){const s=e.metaObjects[i.parentId];s&&(i.parent=s,(s.children||(s.children=[])).push(i))}}for(let t in e.metaObjects){const i=e.metaObjects[t];i.metaModels=[]}for(let t in e.metaModels){const i=e.metaModels[t];for(let s in i.metaObjects)i.metaObjects[s].metaModels.push(i)}e.metaObjectsByType={};for(let t in e.metaObjects){const i=e.metaObjects[t],s=i.type;(e.metaObjectsByType[s]||(e.metaObjectsByType[s]={}))[t]=i}if(this.propertySets)for(let t=0,i=this.propertySets.length;t<i;t++){const s=this.propertySets[t];this._decompressProperties(this._propertyLookup,s.properties)}this._propertyLookup=[],this.finalized=!0,this.metaScene.fire("metaModelCreated",this.id)}getJSON(){const e={id:this.id,projectId:this.projectId,author:this.author,createdAt:this.createdAt,schema:this.schema,creatingApplication:this.creatingApplication,metaObjects:[],propertySets:[]},t=Object.values(this.metaObjects);for(let i=0,s=t.length;i<s;i++){const o=t[i],a={id:o.id,originalSystemId:o.originalSystemId,extId:o.extId,type:o.type,name:o.name};o.parent&&(a.parent=o.parent.id),o.attributes&&(a.attributes=o.attributes),o.propertySetIds&&(a.propertySetIds=o.propertySetIds),e.metaObjects.push(a)}for(let i=0,s=this.propertySets.length;i<s;i++){const o=this.propertySets[i],a={id:o.id,originalSystemId:o.originalSystemId,extId:o.extId,type:o.type,name:o.name,propertyies:[]};for(let n=0,l=o.properties.length;n<l;n++){const c=o.properties[n],h={id:c.id,description:c.description,type:c.type,name:c.name,value:c.value,valueType:c.valueType};a.properties.push(h)}e.propertySets.push(a)}return e}_globalizeIDs(e,t){const i=!!t.globalizeObjectIds;if(e.metaObjects)for(let s=0,o=e.metaObjects.length;s<o;s++){const a=e.metaObjects[s];if(a.originalSystemId=a.id,a.parent&&(a.originalParentSystemId=a.parent),i&&(a.id=A.globalizeObjectId(this.id,a.id),a.parent&&(a.parent=A.globalizeObjectId(this.id,a.parent))),i){const n=a.propertySetIds;if(n){const l=[];for(let c=0,h=n.length;c<h;c++)l.push(A.globalizeObjectId(this.id,n[c]));a.propertySetIds=l,a.originalSystemPropertySetIds=n}}else a.originalSystemPropertySetIds=a.propertySetIds}if(e.propertySets)for(let s=0,o=e.propertySets.length;s<o;s++){const a=e.propertySets[s];a.originalSystemId=a.id,i&&(a.id=A.globalizeObjectId(this.id,a.id))}}}class SB{constructor(e,t){this.viewer=e,this.scene=t,this.metaModels={},this.propertySets={},this.metaObjects={},this.metaObjectsByType={},this.rootMetaObjects={},this._eventSubs={}}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let s=0,o=i.length;s<o;s++)i[s](t)}off(e){}createMetaModel(e,t,i={}){const s=new Nf({metaScene:this,id:e,projectId:t.projectId||"none",revisionId:t.revisionId||"none",author:t.author||"none",createdAt:t.createdAt||"none",creatingApplication:t.creatingApplication||"none",schema:t.schema||"none",propertySets:[]});return s.loadData(t),s.finalize(),s}destroyMetaModel(e){const t=this.metaModels[e];if(t){if(t.propertySets)for(let i=0,s=t.propertySets.length;i<s;i++){const o=t.propertySets[i];if(o.metaModels.length===1&&o.metaModels[0].id===e)delete this.propertySets[o.id];else{const a=[];for(let n=0,l=o.metaModels.length;n<l;n++)o.metaModels[n].id!==e&&a.push(o.metaModels[n]);o.metaModels=a}}if(t.metaObjects)for(let i in t.metaObjects){const s=t.metaObjects[i];s.metaModels.length===1&&s.metaModels[0].id===e?(delete this.metaObjects[i],s.parent||delete this.rootMetaObjects[i]):s.metaModels=s.metaModels.filter(o=>o.id!==e)}for(let i in this.metaObjects){const s=this.metaObjects[i];if(s.children&&(s.children=[]),s.propertySets&&(s.propertySets=[]),s.propertySetIds)for(let o=0,a=s.propertySetIds.length;o<a;o++){const n=s.propertySetIds[o],l=this.propertySets[n];s.propertySets.push(l)}}this.metaObjectsByType={};for(let i in this.metaObjects){const s=this.metaObjects[i],o=s.type;s.children&&(s.children=null),(this.metaObjectsByType[o]||(this.metaObjectsByType[o]={}))[i]=s}for(let i in this.metaObjects){const s=this.metaObjects[i];if(s.parentId){const o=this.metaObjects[s.parentId];o&&(s.parent=o,(o.children||(o.children=[])).push(s))}}delete this.metaModels[e];for(let i in this.metaObjects){const s=this.metaObjects[i];s.metaModels=[]}for(let i in this.metaModels){const s=this.metaModels[i];for(let o=0,a=s.metaObjects.length;o<a;o++)s.metaObjects[o].metaModels.push(s)}this.fire("metaModelDestroyed",e)}}getObjectIDsByType(e){const t=this.metaObjectsByType[e];return t?Object.keys(t):[]}getObjectIDsInSubtree(e,t,i){const s=[],o=this.metaObjects[e],a=t&&t.length>0?md(t):null,n=i&&i.length>0?md(i):null,l=c=>{if(!c)return;var h=!0;(n&&n[c.type]||a&&!a[c.type])&&(h=!1),h&&s.push(c.id);const d=c.children;if(d)for(var p=0,m=d.length;p<m;p++)l(d[p])};return l(o),s}withMetaObjectsInSubtree(e,t){const i=this.metaObjects[e];i&&i.withMetaObjectsInSubtree(t)}}function md(r){const e={};for(var t=0,i=r.length;t<i;t++)e[r[t]]=!0;return e}/*!
 * html2canvas 1.4.1 <https://html2canvas.hertzen.com>
 * Copyright (c) 2022 Niklas von Hertzen <https://hertzen.com>
 * Released under MIT License
 *//*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var LA=function(r,e){return LA=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(t[s]=i[s])},LA(r,e)};function Ri(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");LA(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var UA=function(){return UA=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++){t=arguments[i];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},UA.apply(this,arguments)};function Ai(r,e,t,i){function s(o){return o instanceof t?o:new t(function(a){a(o)})}return new(t||(t=Promise))(function(o,a){function n(h){try{c(i.next(h))}catch(d){a(d)}}function l(h){try{c(i.throw(h))}catch(d){a(d)}}function c(h){h.done?o(h.value):s(h.value).then(n,l)}c((i=i.apply(r,[])).next())})}function ii(r,e){var t={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,s,o,a;return a={next:n(0),throw:n(1),return:n(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function n(c){return function(h){return l([c,h])}}function l(c){if(i)throw new TypeError("Generator is already executing.");for(;t;)try{if(i=1,s&&(o=c[0]&2?s.return:c[0]?s.throw||((o=s.return)&&o.call(s),0):s.next)&&!(o=o.call(s,c[1])).done)return o;switch(s=0,o&&(c=[c[0]&2,o.value]),c[0]){case 0:case 1:o=c;break;case 4:return t.label++,{value:c[1],done:!1};case 5:t.label++,s=c[1],c=[0];continue;case 7:c=t.ops.pop(),t.trys.pop();continue;default:if(o=t.trys,!(o=o.length>0&&o[o.length-1])&&(c[0]===6||c[0]===2)){t=0;continue}if(c[0]===3&&(!o||c[1]>o[0]&&c[1]<o[3])){t.label=c[1];break}if(c[0]===6&&t.label<o[1]){t.label=o[1],o=c;break}if(o&&t.label<o[2]){t.label=o[2],t.ops.push(c);break}o[2]&&t.ops.pop(),t.trys.pop();continue}c=e.call(r,t)}catch(h){c=[6,h],s=0}finally{i=o=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}function Dn(r,e,t){if(arguments.length===2)for(var i=0,s=e.length,o;i<s;i++)(o||!(i in e))&&(o||(o=Array.prototype.slice.call(e,0,i)),o[i]=e[i]);return r.concat(o||e)}var As=function(){function r(e,t,i,s){this.left=e,this.top=t,this.width=i,this.height=s}return r.prototype.add=function(e,t,i,s){return new r(this.left+e,this.top+t,this.width+i,this.height+s)},r.fromClientRect=function(e,t){return new r(t.left+e.windowBounds.left,t.top+e.windowBounds.top,t.width,t.height)},r.fromDOMRectList=function(e,t){var i=Array.from(t).find(function(s){return s.width!==0});return i?new r(i.left+e.windowBounds.left,i.top+e.windowBounds.top,i.width,i.height):r.EMPTY},r.EMPTY=new r(0,0,0,0),r}(),Ua=function(r,e){return As.fromClientRect(r,e.getBoundingClientRect())},TB=function(r){var e=r.body,t=r.documentElement;if(!e||!t)throw new Error("Unable to get document size");var i=Math.max(Math.max(e.scrollWidth,t.scrollWidth),Math.max(e.offsetWidth,t.offsetWidth),Math.max(e.clientWidth,t.clientWidth)),s=Math.max(Math.max(e.scrollHeight,t.scrollHeight),Math.max(e.offsetHeight,t.offsetHeight),Math.max(e.clientHeight,t.clientHeight));return new As(0,0,i,s)},Oa=function(r){for(var e=[],t=0,i=r.length;t<i;){var s=r.charCodeAt(t++);if(s>=55296&&s<=56319&&t<i){var o=r.charCodeAt(t++);(o&64512)===56320?e.push(((s&1023)<<10)+(o&1023)+65536):(e.push(s),t--)}else e.push(s)}return e},Ut=function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];if(String.fromCodePoint)return String.fromCodePoint.apply(String,r);var t=r.length;if(!t)return"";for(var i=[],s=-1,o="";++s<t;){var a=r[s];a<=65535?i.push(a):(a-=65536,i.push((a>>10)+55296,a%1024+56320)),(s+1===t||i.length>16384)&&(o+=String.fromCharCode.apply(String,i),i.length=0)}return o},gd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",DB=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Rn=0;Rn<gd.length;Rn++)DB[gd.charCodeAt(Rn)]=Rn;var _d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",ho=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Ln=0;Ln<_d.length;Ln++)ho[_d.charCodeAt(Ln)]=Ln;var RB=function(r){var e=r.length*.75,t=r.length,i,s=0,o,a,n,l;r[r.length-1]==="="&&(e--,r[r.length-2]==="="&&e--);var c=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(e):new Array(e),h=Array.isArray(c)?c:new Uint8Array(c);for(i=0;i<t;i+=4)o=ho[r.charCodeAt(i)],a=ho[r.charCodeAt(i+1)],n=ho[r.charCodeAt(i+2)],l=ho[r.charCodeAt(i+3)],h[s++]=o<<2|a>>4,h[s++]=(a&15)<<4|n>>2,h[s++]=(n&3)<<6|l&63;return c},LB=function(r){for(var e=r.length,t=[],i=0;i<e;i+=2)t.push(r[i+1]<<8|r[i]);return t},UB=function(r){for(var e=r.length,t=[],i=0;i<e;i+=4)t.push(r[i+3]<<24|r[i+2]<<16|r[i+1]<<8|r[i]);return t},zs=5,dc=11,Xl=2,OB=dc-zs,Qf=65536>>zs,kB=1<<zs,Yl=kB-1,NB=1024>>zs,QB=Qf+NB,VB=QB,HB=32,jB=VB+HB,zB=65536>>dc,GB=1<<OB,WB=GB-1,vd=function(r,e,t){return r.slice?r.slice(e,t):new Uint16Array(Array.prototype.slice.call(r,e,t))},KB=function(r,e,t){return r.slice?r.slice(e,t):new Uint32Array(Array.prototype.slice.call(r,e,t))},XB=function(r,e){var t=RB(r),i=Array.isArray(t)?UB(t):new Uint32Array(t),s=Array.isArray(t)?LB(t):new Uint16Array(t),o=24,a=vd(s,o/2,i[4]/2),n=i[5]===2?vd(s,(o+i[4])/2):KB(i,Math.ceil((o+i[4])/4));return new YB(i[0],i[1],i[2],i[3],a,n)},YB=function(){function r(e,t,i,s,o,a){this.initialValue=e,this.errorValue=t,this.highStart=i,this.highValueIndex=s,this.index=o,this.data=a}return r.prototype.get=function(e){var t;if(e>=0){if(e<55296||e>56319&&e<=65535)return t=this.index[e>>zs],t=(t<<Xl)+(e&Yl),this.data[t];if(e<=65535)return t=this.index[Qf+(e-55296>>zs)],t=(t<<Xl)+(e&Yl),this.data[t];if(e<this.highStart)return t=jB-zB+(e>>dc),t=this.index[t],t+=e>>zs&WB,t=this.index[t],t=(t<<Xl)+(e&Yl),this.data[t];if(e<=1114111)return this.data[this.highValueIndex]}return this.errorValue},r}(),Pd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",$B=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Un=0;Un<Pd.length;Un++)$B[Pd.charCodeAt(Un)]=Un;var ZB="KwAAAAAAAAAACA4AUD0AADAgAAACAAAAAAAIABAAGABAAEgAUABYAGAAaABgAGgAYgBqAF8AZwBgAGgAcQB5AHUAfQCFAI0AlQCdAKIAqgCyALoAYABoAGAAaABgAGgAwgDKAGAAaADGAM4A0wDbAOEA6QDxAPkAAQEJAQ8BFwF1AH0AHAEkASwBNAE6AUIBQQFJAVEBWQFhAWgBcAF4ATAAgAGGAY4BlQGXAZ8BpwGvAbUBvQHFAc0B0wHbAeMB6wHxAfkBAQIJAvEBEQIZAiECKQIxAjgCQAJGAk4CVgJeAmQCbAJ0AnwCgQKJApECmQKgAqgCsAK4ArwCxAIwAMwC0wLbAjAA4wLrAvMC+AIAAwcDDwMwABcDHQMlAy0DNQN1AD0DQQNJA0kDSQNRA1EDVwNZA1kDdQB1AGEDdQBpA20DdQN1AHsDdQCBA4kDkQN1AHUAmQOhA3UAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AKYDrgN1AHUAtgO+A8YDzgPWAxcD3gPjA+sD8wN1AHUA+wMDBAkEdQANBBUEHQQlBCoEFwMyBDgEYABABBcDSARQBFgEYARoBDAAcAQzAXgEgASIBJAEdQCXBHUAnwSnBK4EtgS6BMIEyAR1AHUAdQB1AHUAdQCVANAEYABgAGAAYABgAGAAYABgANgEYADcBOQEYADsBPQE/AQEBQwFFAUcBSQFLAU0BWQEPAVEBUsFUwVbBWAAYgVgAGoFcgV6BYIFigWRBWAAmQWfBaYFYABgAGAAYABgAKoFYACxBbAFuQW6BcEFwQXHBcEFwQXPBdMF2wXjBeoF8gX6BQIGCgYSBhoGIgYqBjIGOgZgAD4GRgZMBmAAUwZaBmAAYABgAGAAYABgAGAAYABgAGAAYABgAGIGYABpBnAGYABgAGAAYABgAGAAYABgAGAAYAB4Bn8GhQZgAGAAYAB1AHcDFQSLBmAAYABgAJMGdQA9A3UAmwajBqsGqwaVALMGuwbDBjAAywbSBtIG1QbSBtIG0gbSBtIG0gbdBuMG6wbzBvsGAwcLBxMHAwcbByMHJwcsBywHMQcsB9IGOAdAB0gHTgfSBkgHVgfSBtIG0gbSBtIG0gbSBtIG0gbSBiwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdgAGAALAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdbB2MHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB2kH0gZwB64EdQB1AHUAdQB1AHUAdQB1AHUHfQdgAIUHjQd1AHUAlQedB2AAYAClB6sHYACzB7YHvgfGB3UAzgfWBzMB3gfmB1EB7gf1B/0HlQENAQUIDQh1ABUIHQglCBcDLQg1CD0IRQhNCEEDUwh1AHUAdQBbCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIcAh3CHoIMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIgggwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAALAcsBywHLAcsBywHLAcsBywHLAcsB4oILAcsB44I0gaWCJ4Ipgh1AHUAqgiyCHUAdQB1AHUAdQB1AHUAdQB1AHUAtwh8AXUAvwh1AMUIyQjRCNkI4AjoCHUAdQB1AO4I9gj+CAYJDgkTCS0HGwkjCYIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiAAIAAAAFAAYABgAGIAXwBgAHEAdQBFAJUAogCyAKAAYABgAEIA4ABGANMA4QDxAMEBDwE1AFwBLAE6AQEBUQF4QkhCmEKoQrhCgAHIQsAB0MLAAcABwAHAAeDC6ABoAHDCwMMAAcABwAHAAdDDGMMAAcAB6MM4wwjDWMNow3jDaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAEjDqABWw6bDqABpg6gAaABoAHcDvwOPA+gAaABfA/8DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DpcPAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcAB9cPKwkyCToJMAB1AHUAdQBCCUoJTQl1AFUJXAljCWcJawkwADAAMAAwAHMJdQB2CX4JdQCECYoJjgmWCXUAngkwAGAAYABxAHUApgn3A64JtAl1ALkJdQDACTAAMAAwADAAdQB1AHUAdQB1AHUAdQB1AHUAowYNBMUIMAAwADAAMADICcsJ0wnZCRUE4QkwAOkJ8An4CTAAMAB1AAAKvwh1AAgKDwoXCh8KdQAwACcKLgp1ADYKqAmICT4KRgowADAAdQB1AE4KMAB1AFYKdQBeCnUAZQowADAAMAAwADAAMAAwADAAMAAVBHUAbQowADAAdQC5CXUKMAAwAHwBxAijBogEMgF9CoQKiASMCpQKmgqIBKIKqgquCogEDQG2Cr4KxgrLCjAAMADTCtsKCgHjCusK8Qr5CgELMAAwADAAMAB1AIsECQsRC3UANAEZCzAAMAAwADAAMAB1ACELKQswAHUANAExCzkLdQBBC0kLMABRC1kLMAAwADAAMAAwADAAdQBhCzAAMAAwAGAAYABpC3ELdwt/CzAAMACHC4sLkwubC58Lpwt1AK4Ltgt1APsDMAAwADAAMAAwADAAMAAwAL4LwwvLC9IL1wvdCzAAMADlC+kL8Qv5C/8LSQswADAAMAAwADAAMAAwADAAMAAHDDAAMAAwADAAMAAODBYMHgx1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1ACYMMAAwADAAdQB1AHUALgx1AHUAdQB1AHUAdQA2DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AD4MdQBGDHUAdQB1AHUAdQB1AEkMdQB1AHUAdQB1AFAMMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQBYDHUAdQB1AF8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUA+wMVBGcMMAAwAHwBbwx1AHcMfwyHDI8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAYABgAJcMMAAwADAAdQB1AJ8MlQClDDAAMACtDCwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB7UMLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AA0EMAC9DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAsBywHLAcsBywHLAcsBywHLQcwAMEMyAwsBywHLAcsBywHLAcsBywHLAcsBywHzAwwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1ANQM2QzhDDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMABgAGAAYABgAGAAYABgAOkMYADxDGAA+AwADQYNYABhCWAAYAAODTAAMAAwADAAFg1gAGAAHg37AzAAMAAwADAAYABgACYNYAAsDTQNPA1gAEMNPg1LDWAAYABgAGAAYABgAGAAYABgAGAAUg1aDYsGVglhDV0NcQBnDW0NdQ15DWAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAlQCBDZUAiA2PDZcNMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAnw2nDTAAMAAwADAAMAAwAHUArw23DTAAMAAwADAAMAAwADAAMAAwADAAMAB1AL8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQDHDTAAYABgAM8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA1w11ANwNMAAwAD0B5A0wADAAMAAwADAAMADsDfQN/A0EDgwOFA4wABsOMAAwADAAMAAwADAAMAAwANIG0gbSBtIG0gbSBtIG0gYjDigOwQUuDsEFMw7SBjoO0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGQg5KDlIOVg7SBtIGXg5lDm0OdQ7SBtIGfQ6EDooOjQ6UDtIGmg6hDtIG0gaoDqwO0ga0DrwO0gZgAGAAYADEDmAAYAAkBtIGzA5gANIOYADaDokO0gbSBt8O5w7SBu8O0gb1DvwO0gZgAGAAxA7SBtIG0gbSBtIGYABgAGAAYAAED2AAsAUMD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHJA8sBywHLAcsBywHLAccDywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywPLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAc0D9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHPA/SBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gYUD0QPlQCVAJUAMAAwADAAMACVAJUAlQCVAJUAlQCVAEwPMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA//8EAAQABAAEAAQABAAEAAQABAANAAMAAQABAAIABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQACgATABcAHgAbABoAHgAXABYAEgAeABsAGAAPABgAHABLAEsASwBLAEsASwBLAEsASwBLABgAGAAeAB4AHgATAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABYAGwASAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWAA0AEQAeAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAFAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJABYAGgAbABsAGwAeAB0AHQAeAE8AFwAeAA0AHgAeABoAGwBPAE8ADgBQAB0AHQAdAE8ATwAXAE8ATwBPABYAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAFAATwBAAE8ATwBPAEAATwBQAFAATwBQAB4AHgAeAB4AHgAeAB0AHQAdAB0AHgAdAB4ADgBQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgBQAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAkACQAJAAkACQAJAAkABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAFAAHgAeAB4AKwArAFAAUABQAFAAGABQACsAKwArACsAHgAeAFAAHgBQAFAAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUAAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAYAA0AKwArAB4AHgAbACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAB4ABAAEAB4ABAAEABMABAArACsAKwArACsAKwArACsAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAKwArACsAKwBWAFYAVgBWAB4AHgArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AGgAaABoAGAAYAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQAEwAEACsAEwATAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABLAEsASwBLAEsASwBLAEsASwBLABoAGQAZAB4AUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABMAUAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABABQAFAABAAEAB4ABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUAAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAFAABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQAUABQAB4AHgAYABMAUAArACsABAAbABsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAFAABAAEAAQABAAEAFAABAAEAAQAUAAEAAQABAAEAAQAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArACsAHgArAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAUAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEAA0ADQBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUAArACsAKwBQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABABQACsAKwArACsAKwArACsAKwAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUAAaABoAUABQAFAAUABQAEwAHgAbAFAAHgAEACsAKwAEAAQABAArAFAAUABQAFAAUABQACsAKwArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQACsAUABQACsAKwAEACsABAAEAAQABAAEACsAKwArACsABAAEACsAKwAEAAQABAArACsAKwAEACsAKwArACsAKwArACsAUABQAFAAUAArAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLAAQABABQAFAAUAAEAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAArACsAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AGwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAKwArACsAKwArAAQABAAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAAQAUAArAFAAUABQAFAAUABQACsAKwArAFAAUABQACsAUABQAFAAUAArACsAKwBQAFAAKwBQACsAUABQACsAKwArAFAAUAArACsAKwBQAFAAUAArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArAAQABAAEAAQABAArACsAKwAEAAQABAArAAQABAAEAAQAKwArAFAAKwArACsAKwArACsABAArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAHgAeAB4AHgAeAB4AGwAeACsAKwArACsAKwAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAUABQAFAAKwArACsAKwArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwAOAFAAUABQAFAAUABQAFAAHgBQAAQABAAEAA4AUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAKwArAAQAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAKwArACsAKwArACsAUAArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAFAABAAEAAQABAAEAAQABAArAAQABAAEACsABAAEAAQABABQAB4AKwArACsAKwBQAFAAUAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQABoAUABQAFAAUABQAFAAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQACsAUAArACsAUABQAFAAUABQAFAAUAArACsAKwAEACsAKwArACsABAAEAAQABAAEAAQAKwAEACsABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArAAQABAAeACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAXAAqACoAKgAqACoAKgAqACsAKwArACsAGwBcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAeAEsASwBLAEsASwBLAEsASwBLAEsADQANACsAKwArACsAKwBcAFwAKwBcACsAXABcAFwAXABcACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAXAArAFwAXABcAFwAXABcAFwAXABcAFwAKgBcAFwAKgAqACoAKgAqACoAKgAqACoAXAArACsAXABcAFwAXABcACsAXAArACoAKgAqACoAKgAqACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwBcAFwAXABcAFAADgAOAA4ADgAeAA4ADgAJAA4ADgANAAkAEwATABMAEwATAAkAHgATAB4AHgAeAAQABAAeAB4AHgAeAB4AHgBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQAFAADQAEAB4ABAAeAAQAFgARABYAEQAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAAQABAAEAAQADQAEAAQAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAA0ADQAeAB4AHgAeAB4AHgAEAB4AHgAeAB4AHgAeACsAHgAeAA4ADgANAA4AHgAeAB4AHgAeAAkACQArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgBcAEsASwBLAEsASwBLAEsASwBLAEsADQANAB4AHgAeAB4AXABcAFwAXABcAFwAKgAqACoAKgBcAFwAXABcACoAKgAqAFwAKgAqACoAXABcACoAKgAqACoAKgAqACoAXABcAFwAKgAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqAFwAKgBLAEsASwBLAEsASwBLAEsASwBLACoAKgAqACoAKgAqAFAAUABQAFAAUABQACsAUAArACsAKwArACsAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAKwBQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsABAAEAAQAHgANAB4AHgAeAB4AHgAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUAArACsADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWABEAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQANAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAANAA0AKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUAArAAQABAArACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqAA0ADQAVAFwADQAeAA0AGwBcACoAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwAeAB4AEwATAA0ADQAOAB4AEwATAB4ABAAEAAQACQArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAHgArACsAKwATABMASwBLAEsASwBLAEsASwBLAEsASwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAXABcAFwAXABcACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAXAArACsAKwAqACoAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsAHgAeAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKwArAAQASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACoAKgAqACoAKgAqACoAXAAqACoAKgAqACoAKgArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABABQAFAAUABQAFAAUABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwANAA0AHgANAA0ADQANAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwAeAB4AHgAeAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArAA0ADQANAA0ADQBLAEsASwBLAEsASwBLAEsASwBLACsAKwArAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUAAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAAQAUABQAFAAUABQAFAABABQAFAABAAEAAQAUAArACsAKwArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQACsAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAFAAUABQACsAHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQACsAKwAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQACsAHgAeAB4AHgAeAB4AHgAOAB4AKwANAA0ADQANAA0ADQANAAkADQANAA0ACAAEAAsABAAEAA0ACQANAA0ADAAdAB0AHgAXABcAFgAXABcAFwAWABcAHQAdAB4AHgAUABQAFAANAAEAAQAEAAQABAAEAAQACQAaABoAGgAaABoAGgAaABoAHgAXABcAHQAVABUAHgAeAB4AHgAeAB4AGAAWABEAFQAVABUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ADQAeAA0ADQANAA0AHgANAA0ADQAHAB4AHgAeAB4AKwAEAAQABAAEAAQABAAEAAQABAAEAFAAUAArACsATwBQAFAAUABQAFAAHgAeAB4AFgARAE8AUABPAE8ATwBPAFAAUABQAFAAUAAeAB4AHgAWABEAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArABsAGwAbABsAGwAbABsAGgAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGgAbABsAGwAbABoAGwAbABoAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAHgAeAFAAGgAeAB0AHgBQAB4AGgAeAB4AHgAeAB4AHgAeAB4AHgBPAB4AUAAbAB4AHgBQAFAAUABQAFAAHgAeAB4AHQAdAB4AUAAeAFAAHgBQAB4AUABPAFAAUAAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgBQAFAAUABQAE8ATwBQAFAAUABQAFAATwBQAFAATwBQAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAUABQAFAATwBPAE8ATwBPAE8ATwBPAE8ATwBQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABPAB4AHgArACsAKwArAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHQAdAB4AHgAeAB0AHQAeAB4AHQAeAB4AHgAdAB4AHQAbABsAHgAdAB4AHgAeAB4AHQAeAB4AHQAdAB0AHQAeAB4AHQAeAB0AHgAdAB0AHQAdAB0AHQAeAB0AHgAeAB4AHgAeAB0AHQAdAB0AHgAeAB4AHgAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHgAeAB0AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAeAB0AHQAdAB0AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAdAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAWABEAHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAWABEAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AHQAdAB0AHgAeAB0AHgAeAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlAB4AHQAdAB4AHgAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AJQAlAB0AHQAlAB4AJQAlACUAIAAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAdAB0AHQAeAB0AJQAdAB0AHgAdAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAdAB0AHQAdACUAHgAlACUAJQAdACUAJQAdAB0AHQAlACUAHQAdACUAHQAdACUAJQAlAB4AHQAeAB4AHgAeAB0AHQAlAB0AHQAdAB0AHQAdACUAJQAlACUAJQAdACUAJQAgACUAHQAdACUAJQAlACUAJQAlACUAJQAeAB4AHgAlACUAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AFwAXABcAFwAXABcAHgATABMAJQAeAB4AHgAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARABYAEQAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAEAAQABAAeAB4AKwArACsAKwArABMADQANAA0AUAATAA0AUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUAANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAA0ADQANAA0ADQANAA0ADQAeAA0AFgANAB4AHgAXABcAHgAeABcAFwAWABEAFgARABYAEQAWABEADQANAA0ADQATAFAADQANAB4ADQANAB4AHgAeAB4AHgAMAAwADQANAA0AHgANAA0AFgANAA0ADQANAA0ADQANAA0AHgANAB4ADQANAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArAA0AEQARACUAJQBHAFcAVwAWABEAFgARABYAEQAWABEAFgARACUAJQAWABEAFgARABYAEQAWABEAFQAWABEAEQAlAFcAVwBXAFcAVwBXAFcAVwBXAAQABAAEAAQABAAEACUAVwBXAFcAVwA2ACUAJQBXAFcAVwBHAEcAJQAlACUAKwBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBRAFcAUQBXAFEAVwBXAFcAVwBXAFcAUQBXAFcAVwBXAFcAVwBRAFEAKwArAAQABAAVABUARwBHAFcAFQBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBRAFcAVwBXAFcAVwBXAFEAUQBXAFcAVwBXABUAUQBHAEcAVwArACsAKwArACsAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwAlACUAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACsAKwArACsAKwArACsAKwArACsAKwArAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBPAE8ATwBPAE8ATwBPAE8AJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADQATAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABLAEsASwBLAEsASwBLAEsASwBLAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAABAAEAAQABAAeAAQABAAEAAQABAAEAAQABAAEAAQAHgBQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAeAA0ADQANAA0ADQArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAAQAUABQAFAABABQAFAAUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAeAB4AHgAeAAQAKwArACsAUABQAFAAUABQAFAAHgAeABoAHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADgAOABMAEwArACsAKwArACsAKwArACsABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwANAA0ASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUAAeAB4AHgBQAA4AUABQAAQAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArAB4AWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYACsAKwArAAQAHgAeAB4AHgAeAB4ADQANAA0AHgAeAB4AHgArAFAASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArAB4AHgBcAFwAXABcAFwAKgBcAFwAXABcAFwAXABcAFwAXABcAEsASwBLAEsASwBLAEsASwBLAEsAXABcAFwAXABcACsAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAFAAUABQAAQAUABQAFAAUABQAFAAUABQAAQABAArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAHgANAA0ADQBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAXAAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAKgAqACoAXABcACoAKgBcAFwAXABcAFwAKgAqAFwAKgBcACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcACoAKgBQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAA0ADQBQAFAAUAAEAAQAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQADQAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAVABVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBUAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVACsAKwArACsAKwArACsAKwArACsAKwArAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAKwArACsAKwBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAKwArACsAKwAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAKwArACsAKwArAFYABABWAFYAVgBWAFYAVgBWAFYAVgBWAB4AVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgArAFYAVgBWAFYAVgArAFYAKwBWAFYAKwBWAFYAKwBWAFYAVgBWAFYAVgBWAFYAVgBWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAEQAWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAaAB4AKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAGAARABEAGAAYABMAEwAWABEAFAArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACUAJQAlACUAJQAWABEAFgARABYAEQAWABEAFgARABYAEQAlACUAFgARACUAJQAlACUAJQAlACUAEQAlABEAKwAVABUAEwATACUAFgARABYAEQAWABEAJQAlACUAJQAlACUAJQAlACsAJQAbABoAJQArACsAKwArAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAcAKwATACUAJQAbABoAJQAlABYAEQAlACUAEQAlABEAJQBXAFcAVwBXAFcAVwBXAFcAVwBXABUAFQAlACUAJQATACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXABYAJQARACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAWACUAEQAlABYAEQARABYAEQARABUAVwBRAFEAUQBRAFEAUQBRAFEAUQBRAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcARwArACsAVwBXAFcAVwBXAFcAKwArAFcAVwBXAFcAVwBXACsAKwBXAFcAVwBXAFcAVwArACsAVwBXAFcAKwArACsAGgAbACUAJQAlABsAGwArAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAAQAB0AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsADQANAA0AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAA0AUABQAFAAUAArACsAKwArAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwArAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwBQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAUABQAFAAUABQAAQABAAEACsABAAEACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAKwBQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAA0ADQANAA0ADQANAA0ADQAeACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAArACsAKwArAFAAUABQAFAAUAANAA0ADQANAA0ADQAUACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsADQANAA0ADQANAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArAAQABAANACsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAB4AHgAeAB4AHgArACsAKwArACsAKwAEAAQABAAEAAQABAAEAA0ADQAeAB4AHgAeAB4AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsASwBLAEsASwBLAEsASwBLAEsASwANAA0ADQANAFAABAAEAFAAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAeAA4AUAArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAADQANAB4ADQAEAAQABAAEAB4ABAAEAEsASwBLAEsASwBLAEsASwBLAEsAUAAOAFAADQANAA0AKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAANAA0AHgANAA0AHgAEACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAA0AKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsABAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsABAAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAUAArACsAKwArACsAKwAEACsAKwArACsAKwBQAFAAUABQAFAABAAEACsAKwAEAAQABAAEAAQABAAEACsAKwArAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAAQABABQAFAAUABQAA0ADQANAA0AHgBLAEsASwBLAEsASwBLAEsASwBLAA0ADQArAB4ABABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUAAeAFAAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABAAEAAQADgANAA0AEwATAB4AHgAeAA0ADQANAA0ADQANAA0ADQANAA0ADQANAA0ADQANAFAAUABQAFAABAAEACsAKwAEAA0ADQAeAFAAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKwArACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBcAFwADQANAA0AKgBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAKwArAFAAKwArAFAAUABQAFAAUABQAFAAUAArAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQAKwAEAAQAKwArAAQABAAEAAQAUAAEAFAABAAEAA0ADQANACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABABQAA4AUAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAFAABAAEAAQABAAOAB4ADQANAA0ADQAOAB4ABAArACsAKwArACsAKwArACsAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAA0ADQANAFAADgAOAA4ADQANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAAQABAAEAFAADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAOABMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAArACsAKwAEACsABAAEACsABAAEAAQABAAEAAQABABQAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAaABoAGgAaAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABIAEgAQwBDAEMAUABQAFAAUABDAFAAUABQAEgAQwBIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABDAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAJAAkACQAJAAkACQAJABYAEQArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwANAA0AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAANACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAA0ADQANAB4AHgAeAB4AHgAeAFAAUABQAFAADQAeACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAA0AHgAeACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAARwBHABUARwAJACsAKwArACsAKwArACsAKwArACsAKwAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUQBRAFEAKwArACsAKwArACsAKwArACsAKwArACsAKwBRAFEAUQBRACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAHgAEAAQADQAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQABAAEAAQABAAeAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQAHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAKwArAFAAKwArAFAAUAArACsAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUAArAFAAUABQAFAAUABQAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAHgAeAFAAUABQAFAAUAArAFAAKwArACsAUABQAFAAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeACsAKwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4ABAAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAHgAeAA0ADQANAA0AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArAAQABAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwBQAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArABsAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAB4AHgAeAB4ABAAEAAQABAAEAAQABABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArABYAFgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAGgBQAFAAUAAaAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUAArACsAKwArACsAKwBQACsAKwArACsAUAArAFAAKwBQACsAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUAArAFAAKwBQACsAUAArAFAAUAArAFAAKwArAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAKwBQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8AJQAlACUAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB4AHgAeACUAJQAlAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAlACUAJQAlACUAHgAlACUAJQAlACUAIAAgACAAJQAlACAAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACEAIQAhACEAIQAlACUAIAAgACUAJQAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAIAAlACUAJQAlACAAIAAgACUAIAAgACAAJQAlACUAJQAlACUAJQAgACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAlAB4AJQAeACUAJQAlACUAJQAgACUAJQAlACUAHgAlAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACAAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABcAFwAXABUAFQAVAB4AHgAeAB4AJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAgACUAJQAgACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAIAAgACUAJQAgACAAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACAAIAAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACAAIAAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAA==",xd=50,qB=1,Vf=2,Hf=3,JB=4,ew=5,yd=7,jf=8,bd=9,Ps=10,OA=11,Bd=12,kA=13,tw=14,uo=15,NA=16,On=17,oo=18,iw=19,wd=20,QA=21,no=22,$l=23,lr=24,mi=25,po=26,fo=27,Ar=28,sw=29,ks=30,rw=31,kn=32,Nn=33,VA=34,HA=35,jA=36,Fo=37,zA=38,Aa=39,ca=40,Zl=41,zf=42,ow=43,nw=[9001,65288],Gf="!",ut="×",Qn="÷",GA=XB(ZB),qi=[ks,jA],WA=[qB,Vf,Hf,ew],Wf=[Ps,jf],Cd=[fo,po],aw=WA.concat(Wf),Md=[zA,Aa,ca,VA,HA],lw=[uo,kA],Aw=function(r,e){e===void 0&&(e="strict");var t=[],i=[],s=[];return r.forEach(function(o,a){var n=GA.get(o);if(n>xd?(s.push(!0),n-=xd):s.push(!1),["normal","auto","loose"].indexOf(e)!==-1&&[8208,8211,12316,12448].indexOf(o)!==-1)return i.push(a),t.push(NA);if(n===JB||n===OA){if(a===0)return i.push(a),t.push(ks);var l=t[a-1];return aw.indexOf(l)===-1?(i.push(i[a-1]),t.push(l)):(i.push(a),t.push(ks))}if(i.push(a),n===rw)return t.push(e==="strict"?QA:Fo);if(n===zf||n===sw)return t.push(ks);if(n===ow)return o>=131072&&o<=196605||o>=196608&&o<=262141?t.push(Fo):t.push(ks);t.push(n)}),[i,t,s]},ql=function(r,e,t,i){var s=i[t];if(Array.isArray(r)?r.indexOf(s)!==-1:r===s)for(var o=t;o<=i.length;){o++;var a=i[o];if(a===e)return!0;if(a!==Ps)break}if(s===Ps)for(var o=t;o>0;){o--;var n=i[o];if(Array.isArray(r)?r.indexOf(n)!==-1:r===n)for(var l=t;l<=i.length;){l++;var a=i[l];if(a===e)return!0;if(a!==Ps)break}if(n!==Ps)break}return!1},Ed=function(r,e){for(var t=r;t>=0;){var i=e[t];if(i===Ps)t--;else return i}return 0},cw=function(r,e,t,i,s){if(t[i]===0)return ut;var o=i-1;if(Array.isArray(s)&&s[o]===!0)return ut;var a=o-1,n=o+1,l=e[o],c=a>=0?e[a]:0,h=e[n];if(l===Vf&&h===Hf)return ut;if(WA.indexOf(l)!==-1)return Gf;if(WA.indexOf(h)!==-1||Wf.indexOf(h)!==-1)return ut;if(Ed(o,e)===jf)return Qn;if(GA.get(r[o])===OA||(l===kn||l===Nn)&&GA.get(r[n])===OA||l===yd||h===yd||l===bd||[Ps,kA,uo].indexOf(l)===-1&&h===bd||[On,oo,iw,lr,Ar].indexOf(h)!==-1||Ed(o,e)===no||ql($l,no,o,e)||ql([On,oo],QA,o,e)||ql(Bd,Bd,o,e))return ut;if(l===Ps)return Qn;if(l===$l||h===$l)return ut;if(h===NA||l===NA)return Qn;if([kA,uo,QA].indexOf(h)!==-1||l===tw||c===jA&&lw.indexOf(l)!==-1||l===Ar&&h===jA||h===wd||qi.indexOf(h)!==-1&&l===mi||qi.indexOf(l)!==-1&&h===mi||l===fo&&[Fo,kn,Nn].indexOf(h)!==-1||[Fo,kn,Nn].indexOf(l)!==-1&&h===po||qi.indexOf(l)!==-1&&Cd.indexOf(h)!==-1||Cd.indexOf(l)!==-1&&qi.indexOf(h)!==-1||[fo,po].indexOf(l)!==-1&&(h===mi||[no,uo].indexOf(h)!==-1&&e[n+1]===mi)||[no,uo].indexOf(l)!==-1&&h===mi||l===mi&&[mi,Ar,lr].indexOf(h)!==-1)return ut;if([mi,Ar,lr,On,oo].indexOf(h)!==-1)for(var d=o;d>=0;){var p=e[d];if(p===mi)return ut;if([Ar,lr].indexOf(p)!==-1)d--;else break}if([fo,po].indexOf(h)!==-1)for(var d=[On,oo].indexOf(l)!==-1?a:o;d>=0;){var p=e[d];if(p===mi)return ut;if([Ar,lr].indexOf(p)!==-1)d--;else break}if(zA===l&&[zA,Aa,VA,HA].indexOf(h)!==-1||[Aa,VA].indexOf(l)!==-1&&[Aa,ca].indexOf(h)!==-1||[ca,HA].indexOf(l)!==-1&&h===ca||Md.indexOf(l)!==-1&&[wd,po].indexOf(h)!==-1||Md.indexOf(h)!==-1&&l===fo||qi.indexOf(l)!==-1&&qi.indexOf(h)!==-1||l===lr&&qi.indexOf(h)!==-1||qi.concat(mi).indexOf(l)!==-1&&h===no&&nw.indexOf(r[n])===-1||qi.concat(mi).indexOf(h)!==-1&&l===oo)return ut;if(l===Zl&&h===Zl){for(var m=t[o],g=1;m>0&&(m--,e[m]===Zl);)g++;if(g%2!==0)return ut}return l===kn&&h===Nn?ut:Qn},hw=function(r,e){e||(e={lineBreak:"normal",wordBreak:"normal"});var t=Aw(r,e.lineBreak),i=t[0],s=t[1],o=t[2];(e.wordBreak==="break-all"||e.wordBreak==="break-word")&&(s=s.map(function(n){return[mi,ks,zf].indexOf(n)!==-1?Fo:n}));var a=e.wordBreak==="keep-all"?o.map(function(n,l){return n&&r[l]>=19968&&r[l]<=40959}):void 0;return[i,s,a]},uw=function(){function r(e,t,i,s){this.codePoints=e,this.required=t===Gf,this.start=i,this.end=s}return r.prototype.slice=function(){return Ut.apply(void 0,this.codePoints.slice(this.start,this.end))},r}(),dw=function(r,e){var t=Oa(r),i=hw(t,e),s=i[0],o=i[1],a=i[2],n=t.length,l=0,c=0;return{next:function(){if(c>=n)return{done:!0,value:null};for(var h=ut;c<n&&(h=cw(t,o,s,++c,a))===ut;);if(h!==ut||c===n){var d=new uw(t,h,l,c);return l=c,{value:d,done:!1}}return{done:!0,value:null}}}},pw=1,fw=2,Oo=4,Id=8,Pa=10,Fd=47,yo=92,mw=9,gw=32,Vn=34,ao=61,_w=35,vw=36,Pw=37,Hn=39,jn=40,lo=41,xw=95,ui=45,yw=33,bw=60,Bw=62,ww=64,Cw=91,Mw=93,Ew=61,Iw=123,zn=63,Fw=125,Sd=124,Sw=126,Tw=128,Td=65533,Jl=42,Vs=43,Dw=44,Rw=58,Lw=59,So=46,Uw=0,Ow=8,kw=11,Nw=14,Qw=31,Vw=127,Qi=-1,Kf=48,Xf=97,Yf=101,Hw=102,jw=117,zw=122,$f=65,Zf=69,qf=70,Gw=85,Ww=90,si=function(r){return r>=Kf&&r<=57},Kw=function(r){return r>=55296&&r<=57343},cr=function(r){return si(r)||r>=$f&&r<=qf||r>=Xf&&r<=Hw},Xw=function(r){return r>=Xf&&r<=zw},Yw=function(r){return r>=$f&&r<=Ww},$w=function(r){return Xw(r)||Yw(r)},Zw=function(r){return r>=Tw},Gn=function(r){return r===Pa||r===mw||r===gw},xa=function(r){return $w(r)||Zw(r)||r===xw},Dd=function(r){return xa(r)||si(r)||r===ui},qw=function(r){return r>=Uw&&r<=Ow||r===kw||r>=Nw&&r<=Qw||r===Vw},_s=function(r,e){return r!==yo?!1:e!==Pa},Wn=function(r,e,t){return r===ui?xa(e)||_s(e,t):xa(r)?!0:!!(r===yo&&_s(r,e))},eA=function(r,e,t){return r===Vs||r===ui?si(e)?!0:e===So&&si(t):si(r===So?e:r)},Jw=function(r){var e=0,t=1;(r[e]===Vs||r[e]===ui)&&(r[e]===ui&&(t=-1),e++);for(var i=[];si(r[e]);)i.push(r[e++]);var s=i.length?parseInt(Ut.apply(void 0,i),10):0;r[e]===So&&e++;for(var o=[];si(r[e]);)o.push(r[e++]);var a=o.length,n=a?parseInt(Ut.apply(void 0,o),10):0;(r[e]===Zf||r[e]===Yf)&&e++;var l=1;(r[e]===Vs||r[e]===ui)&&(r[e]===ui&&(l=-1),e++);for(var c=[];si(r[e]);)c.push(r[e++]);var h=c.length?parseInt(Ut.apply(void 0,c),10):0;return t*(s+n*Math.pow(10,-a))*Math.pow(10,l*h)},eC={type:2},tC={type:3},iC={type:4},sC={type:13},rC={type:8},oC={type:21},nC={type:9},aC={type:10},lC={type:11},AC={type:12},cC={type:14},Kn={type:23},hC={type:1},uC={type:25},dC={type:24},pC={type:26},fC={type:27},mC={type:28},gC={type:29},_C={type:31},KA={type:32},Jf=function(){function r(){this._value=[]}return r.prototype.write=function(e){this._value=this._value.concat(Oa(e))},r.prototype.read=function(){for(var e=[],t=this.consumeToken();t!==KA;)e.push(t),t=this.consumeToken();return e},r.prototype.consumeToken=function(){var e=this.consumeCodePoint();switch(e){case Vn:return this.consumeStringToken(Vn);case _w:var t=this.peekCodePoint(0),i=this.peekCodePoint(1),s=this.peekCodePoint(2);if(Dd(t)||_s(i,s)){var o=Wn(t,i,s)?fw:pw,a=this.consumeName();return{type:5,value:a,flags:o}}break;case vw:if(this.peekCodePoint(0)===ao)return this.consumeCodePoint(),sC;break;case Hn:return this.consumeStringToken(Hn);case jn:return eC;case lo:return tC;case Jl:if(this.peekCodePoint(0)===ao)return this.consumeCodePoint(),cC;break;case Vs:if(eA(e,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(e),this.consumeNumericToken();break;case Dw:return iC;case ui:var n=e,l=this.peekCodePoint(0),c=this.peekCodePoint(1);if(eA(n,l,c))return this.reconsumeCodePoint(e),this.consumeNumericToken();if(Wn(n,l,c))return this.reconsumeCodePoint(e),this.consumeIdentLikeToken();if(l===ui&&c===Bw)return this.consumeCodePoint(),this.consumeCodePoint(),dC;break;case So:if(eA(e,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(e),this.consumeNumericToken();break;case Fd:if(this.peekCodePoint(0)===Jl)for(this.consumeCodePoint();;){var h=this.consumeCodePoint();if(h===Jl&&(h=this.consumeCodePoint(),h===Fd))return this.consumeToken();if(h===Qi)return this.consumeToken()}break;case Rw:return pC;case Lw:return fC;case bw:if(this.peekCodePoint(0)===yw&&this.peekCodePoint(1)===ui&&this.peekCodePoint(2)===ui)return this.consumeCodePoint(),this.consumeCodePoint(),uC;break;case ww:var d=this.peekCodePoint(0),p=this.peekCodePoint(1),m=this.peekCodePoint(2);if(Wn(d,p,m)){var a=this.consumeName();return{type:7,value:a}}break;case Cw:return mC;case yo:if(_s(e,this.peekCodePoint(0)))return this.reconsumeCodePoint(e),this.consumeIdentLikeToken();break;case Mw:return gC;case Ew:if(this.peekCodePoint(0)===ao)return this.consumeCodePoint(),rC;break;case Iw:return lC;case Fw:return AC;case jw:case Gw:var g=this.peekCodePoint(0),u=this.peekCodePoint(1);return g===Vs&&(cr(u)||u===zn)&&(this.consumeCodePoint(),this.consumeUnicodeRangeToken()),this.reconsumeCodePoint(e),this.consumeIdentLikeToken();case Sd:if(this.peekCodePoint(0)===ao)return this.consumeCodePoint(),nC;if(this.peekCodePoint(0)===Sd)return this.consumeCodePoint(),oC;break;case Sw:if(this.peekCodePoint(0)===ao)return this.consumeCodePoint(),aC;break;case Qi:return KA}return Gn(e)?(this.consumeWhiteSpace(),_C):si(e)?(this.reconsumeCodePoint(e),this.consumeNumericToken()):xa(e)?(this.reconsumeCodePoint(e),this.consumeIdentLikeToken()):{type:6,value:Ut(e)}},r.prototype.consumeCodePoint=function(){var e=this._value.shift();return typeof e>"u"?-1:e},r.prototype.reconsumeCodePoint=function(e){this._value.unshift(e)},r.prototype.peekCodePoint=function(e){return e>=this._value.length?-1:this._value[e]},r.prototype.consumeUnicodeRangeToken=function(){for(var e=[],t=this.consumeCodePoint();cr(t)&&e.length<6;)e.push(t),t=this.consumeCodePoint();for(var i=!1;t===zn&&e.length<6;)e.push(t),t=this.consumeCodePoint(),i=!0;if(i){var s=parseInt(Ut.apply(void 0,e.map(function(l){return l===zn?Kf:l})),16),o=parseInt(Ut.apply(void 0,e.map(function(l){return l===zn?qf:l})),16);return{type:30,start:s,end:o}}var a=parseInt(Ut.apply(void 0,e),16);if(this.peekCodePoint(0)===ui&&cr(this.peekCodePoint(1))){this.consumeCodePoint(),t=this.consumeCodePoint();for(var n=[];cr(t)&&n.length<6;)n.push(t),t=this.consumeCodePoint();var o=parseInt(Ut.apply(void 0,n),16);return{type:30,start:a,end:o}}else return{type:30,start:a,end:a}},r.prototype.consumeIdentLikeToken=function(){var e=this.consumeName();return e.toLowerCase()==="url"&&this.peekCodePoint(0)===jn?(this.consumeCodePoint(),this.consumeUrlToken()):this.peekCodePoint(0)===jn?(this.consumeCodePoint(),{type:19,value:e}):{type:20,value:e}},r.prototype.consumeUrlToken=function(){var e=[];if(this.consumeWhiteSpace(),this.peekCodePoint(0)===Qi)return{type:22,value:""};var t=this.peekCodePoint(0);if(t===Hn||t===Vn){var i=this.consumeStringToken(this.consumeCodePoint());return i.type===0&&(this.consumeWhiteSpace(),this.peekCodePoint(0)===Qi||this.peekCodePoint(0)===lo)?(this.consumeCodePoint(),{type:22,value:i.value}):(this.consumeBadUrlRemnants(),Kn)}for(;;){var s=this.consumeCodePoint();if(s===Qi||s===lo)return{type:22,value:Ut.apply(void 0,e)};if(Gn(s))return this.consumeWhiteSpace(),this.peekCodePoint(0)===Qi||this.peekCodePoint(0)===lo?(this.consumeCodePoint(),{type:22,value:Ut.apply(void 0,e)}):(this.consumeBadUrlRemnants(),Kn);if(s===Vn||s===Hn||s===jn||qw(s))return this.consumeBadUrlRemnants(),Kn;if(s===yo)if(_s(s,this.peekCodePoint(0)))e.push(this.consumeEscapedCodePoint());else return this.consumeBadUrlRemnants(),Kn;else e.push(s)}},r.prototype.consumeWhiteSpace=function(){for(;Gn(this.peekCodePoint(0));)this.consumeCodePoint()},r.prototype.consumeBadUrlRemnants=function(){for(;;){var e=this.consumeCodePoint();if(e===lo||e===Qi)return;_s(e,this.peekCodePoint(0))&&this.consumeEscapedCodePoint()}},r.prototype.consumeStringSlice=function(e){for(var t=5e4,i="";e>0;){var s=Math.min(t,e);i+=Ut.apply(void 0,this._value.splice(0,s)),e-=s}return this._value.shift(),i},r.prototype.consumeStringToken=function(e){var t="",i=0;do{var s=this._value[i];if(s===Qi||s===void 0||s===e)return t+=this.consumeStringSlice(i),{type:0,value:t};if(s===Pa)return this._value.splice(0,i),hC;if(s===yo){var o=this._value[i+1];o!==Qi&&o!==void 0&&(o===Pa?(t+=this.consumeStringSlice(i),i=-1,this._value.shift()):_s(s,o)&&(t+=this.consumeStringSlice(i),t+=Ut(this.consumeEscapedCodePoint()),i=-1))}i++}while(!0)},r.prototype.consumeNumber=function(){var e=[],t=Oo,i=this.peekCodePoint(0);for((i===Vs||i===ui)&&e.push(this.consumeCodePoint());si(this.peekCodePoint(0));)e.push(this.consumeCodePoint());i=this.peekCodePoint(0);var s=this.peekCodePoint(1);if(i===So&&si(s))for(e.push(this.consumeCodePoint(),this.consumeCodePoint()),t=Id;si(this.peekCodePoint(0));)e.push(this.consumeCodePoint());i=this.peekCodePoint(0),s=this.peekCodePoint(1);var o=this.peekCodePoint(2);if((i===Zf||i===Yf)&&((s===Vs||s===ui)&&si(o)||si(s)))for(e.push(this.consumeCodePoint(),this.consumeCodePoint()),t=Id;si(this.peekCodePoint(0));)e.push(this.consumeCodePoint());return[Jw(e),t]},r.prototype.consumeNumericToken=function(){var e=this.consumeNumber(),t=e[0],i=e[1],s=this.peekCodePoint(0),o=this.peekCodePoint(1),a=this.peekCodePoint(2);if(Wn(s,o,a)){var n=this.consumeName();return{type:15,number:t,flags:i,unit:n}}return s===Pw?(this.consumeCodePoint(),{type:16,number:t,flags:i}):{type:17,number:t,flags:i}},r.prototype.consumeEscapedCodePoint=function(){var e=this.consumeCodePoint();if(cr(e)){for(var t=Ut(e);cr(this.peekCodePoint(0))&&t.length<6;)t+=Ut(this.consumeCodePoint());Gn(this.peekCodePoint(0))&&this.consumeCodePoint();var i=parseInt(t,16);return i===0||Kw(i)||i>1114111?Td:i}return e===Qi?Td:e},r.prototype.consumeName=function(){for(var e="";;){var t=this.consumeCodePoint();if(Dd(t))e+=Ut(t);else if(_s(t,this.peekCodePoint(0)))e+=Ut(this.consumeEscapedCodePoint());else return this.reconsumeCodePoint(t),e}},r}(),em=function(){function r(e){this._tokens=e}return r.create=function(e){var t=new Jf;return t.write(e),new r(t.read())},r.parseValue=function(e){return r.create(e).parseComponentValue()},r.parseValues=function(e){return r.create(e).parseComponentValues()},r.prototype.parseComponentValue=function(){for(var e=this.consumeToken();e.type===31;)e=this.consumeToken();if(e.type===32)throw new SyntaxError("Error parsing CSS component value, unexpected EOF");this.reconsumeToken(e);var t=this.consumeComponentValue();do e=this.consumeToken();while(e.type===31);if(e.type===32)return t;throw new SyntaxError("Error parsing CSS component value, multiple values found when expecting only one")},r.prototype.parseComponentValues=function(){for(var e=[];;){var t=this.consumeComponentValue();if(t.type===32)return e;e.push(t),e.push()}},r.prototype.consumeComponentValue=function(){var e=this.consumeToken();switch(e.type){case 11:case 28:case 2:return this.consumeSimpleBlock(e.type);case 19:return this.consumeFunction(e)}return e},r.prototype.consumeSimpleBlock=function(e){for(var t={type:e,values:[]},i=this.consumeToken();;){if(i.type===32||PC(i,e))return t;this.reconsumeToken(i),t.values.push(this.consumeComponentValue()),i=this.consumeToken()}},r.prototype.consumeFunction=function(e){for(var t={name:e.value,values:[],type:18};;){var i=this.consumeToken();if(i.type===32||i.type===3)return t;this.reconsumeToken(i),t.values.push(this.consumeComponentValue())}},r.prototype.consumeToken=function(){var e=this._tokens.shift();return typeof e>"u"?KA:e},r.prototype.reconsumeToken=function(e){this._tokens.unshift(e)},r}(),ko=function(r){return r.type===15},Sr=function(r){return r.type===17},bt=function(r){return r.type===20},vC=function(r){return r.type===0},XA=function(r,e){return bt(r)&&r.value===e},tm=function(r){return r.type!==31},Fr=function(r){return r.type!==31&&r.type!==4},zi=function(r){var e=[],t=[];return r.forEach(function(i){if(i.type===4){if(t.length===0)throw new Error("Error parsing function args, zero tokens for arg");e.push(t),t=[];return}i.type!==31&&t.push(i)}),t.length&&e.push(t),e},PC=function(r,e){return e===11&&r.type===12||e===28&&r.type===29?!0:e===2&&r.type===3},Es=function(r){return r.type===17||r.type===15},Nt=function(r){return r.type===16||Es(r)},im=function(r){return r.length>1?[r[0],r[1]]:[r[0]]},qt={type:17,number:0,flags:Oo},pc={type:16,number:50,flags:Oo},xs={type:16,number:100,flags:Oo},mo=function(r,e,t){var i=r[0],s=r[1];return[Ct(i,e),Ct(typeof s<"u"?s:i,t)]},Ct=function(r,e){if(r.type===16)return r.number/100*e;if(ko(r))switch(r.unit){case"rem":case"em":return 16*r.number;case"px":default:return r.number}return r.number},sm="deg",rm="grad",om="rad",nm="turn",ka={name:"angle",parse:function(r,e){if(e.type===15)switch(e.unit){case sm:return Math.PI*e.number/180;case rm:return Math.PI/200*e.number;case om:return e.number;case nm:return Math.PI*2*e.number}throw new Error("Unsupported angle type")}},am=function(r){return r.type===15&&(r.unit===sm||r.unit===rm||r.unit===om||r.unit===nm)},lm=function(r){var e=r.filter(bt).map(function(t){return t.value}).join(" ");switch(e){case"to bottom right":case"to right bottom":case"left top":case"top left":return[qt,qt];case"to top":case"bottom":return Ei(0);case"to bottom left":case"to left bottom":case"right top":case"top right":return[qt,xs];case"to right":case"left":return Ei(90);case"to top left":case"to left top":case"right bottom":case"bottom right":return[xs,xs];case"to bottom":case"top":return Ei(180);case"to top right":case"to right top":case"left bottom":case"bottom left":return[xs,qt];case"to left":case"right":return Ei(270)}return 0},Ei=function(r){return Math.PI*r/180},ws={name:"color",parse:function(r,e){if(e.type===18){var t=xC[e.name];if(typeof t>"u")throw new Error('Attempting to parse an unsupported color function "'+e.name+'"');return t(r,e.values)}if(e.type===5){if(e.value.length===3){var i=e.value.substring(0,1),s=e.value.substring(1,2),o=e.value.substring(2,3);return ys(parseInt(i+i,16),parseInt(s+s,16),parseInt(o+o,16),1)}if(e.value.length===4){var i=e.value.substring(0,1),s=e.value.substring(1,2),o=e.value.substring(2,3),a=e.value.substring(3,4);return ys(parseInt(i+i,16),parseInt(s+s,16),parseInt(o+o,16),parseInt(a+a,16)/255)}if(e.value.length===6){var i=e.value.substring(0,2),s=e.value.substring(2,4),o=e.value.substring(4,6);return ys(parseInt(i,16),parseInt(s,16),parseInt(o,16),1)}if(e.value.length===8){var i=e.value.substring(0,2),s=e.value.substring(2,4),o=e.value.substring(4,6),a=e.value.substring(6,8);return ys(parseInt(i,16),parseInt(s,16),parseInt(o,16),parseInt(a,16)/255)}}if(e.type===20){var n=ns[e.value.toUpperCase()];if(typeof n<"u")return n}return ns.TRANSPARENT}},Cs=function(r){return(255&r)===0},zt=function(r){var e=255&r,t=255&r>>8,i=255&r>>16,s=255&r>>24;return e<255?"rgba("+s+","+i+","+t+","+e/255+")":"rgb("+s+","+i+","+t+")"},ys=function(r,e,t,i){return(r<<24|e<<16|t<<8|Math.round(i*255)<<0)>>>0},Rd=function(r,e){if(r.type===17)return r.number;if(r.type===16){var t=e===3?1:255;return e===3?r.number/100*t:Math.round(r.number/100*t)}return 0},Ld=function(r,e){var t=e.filter(Fr);if(t.length===3){var i=t.map(Rd),s=i[0],o=i[1],a=i[2];return ys(s,o,a,1)}if(t.length===4){var n=t.map(Rd),s=n[0],o=n[1],a=n[2],l=n[3];return ys(s,o,a,l)}return 0};function tA(r,e,t){return t<0&&(t+=1),t>=1&&(t-=1),t<1/6?(e-r)*t*6+r:t<1/2?e:t<2/3?(e-r)*6*(2/3-t)+r:r}var Ud=function(r,e){var t=e.filter(Fr),i=t[0],s=t[1],o=t[2],a=t[3],n=(i.type===17?Ei(i.number):ka.parse(r,i))/(Math.PI*2),l=Nt(s)?s.number/100:0,c=Nt(o)?o.number/100:0,h=typeof a<"u"&&Nt(a)?Ct(a,1):1;if(l===0)return ys(c*255,c*255,c*255,1);var d=c<=.5?c*(l+1):c+l-c*l,p=c*2-d,m=tA(p,d,n+1/3),g=tA(p,d,n),u=tA(p,d,n-1/3);return ys(m*255,g*255,u*255,h)},xC={hsl:Ud,hsla:Ud,rgb:Ld,rgba:Ld},bo=function(r,e){return ws.parse(r,em.create(e).parseComponentValue())},ns={ALICEBLUE:4042850303,ANTIQUEWHITE:4209760255,AQUA:16777215,AQUAMARINE:2147472639,AZURE:4043309055,BEIGE:4126530815,BISQUE:4293182719,BLACK:255,BLANCHEDALMOND:4293643775,BLUE:65535,BLUEVIOLET:2318131967,BROWN:2771004159,BURLYWOOD:3736635391,CADETBLUE:1604231423,CHARTREUSE:2147418367,CHOCOLATE:3530104575,CORAL:4286533887,CORNFLOWERBLUE:1687547391,CORNSILK:4294499583,CRIMSON:3692313855,CYAN:16777215,DARKBLUE:35839,DARKCYAN:9145343,DARKGOLDENROD:3095837695,DARKGRAY:2846468607,DARKGREEN:6553855,DARKGREY:2846468607,DARKKHAKI:3182914559,DARKMAGENTA:2332068863,DARKOLIVEGREEN:1433087999,DARKORANGE:4287365375,DARKORCHID:2570243327,DARKRED:2332033279,DARKSALMON:3918953215,DARKSEAGREEN:2411499519,DARKSLATEBLUE:1211993087,DARKSLATEGRAY:793726975,DARKSLATEGREY:793726975,DARKTURQUOISE:13554175,DARKVIOLET:2483082239,DEEPPINK:4279538687,DEEPSKYBLUE:12582911,DIMGRAY:1768516095,DIMGREY:1768516095,DODGERBLUE:512819199,FIREBRICK:2988581631,FLORALWHITE:4294635775,FORESTGREEN:579543807,FUCHSIA:4278255615,GAINSBORO:3705462015,GHOSTWHITE:4177068031,GOLD:4292280575,GOLDENROD:3668254975,GRAY:2155905279,GREEN:8388863,GREENYELLOW:2919182335,GREY:2155905279,HONEYDEW:4043305215,HOTPINK:4285117695,INDIANRED:3445382399,INDIGO:1258324735,IVORY:4294963455,KHAKI:4041641215,LAVENDER:3873897215,LAVENDERBLUSH:4293981695,LAWNGREEN:2096890111,LEMONCHIFFON:4294626815,LIGHTBLUE:2916673279,LIGHTCORAL:4034953471,LIGHTCYAN:3774873599,LIGHTGOLDENRODYELLOW:4210742015,LIGHTGRAY:3553874943,LIGHTGREEN:2431553791,LIGHTGREY:3553874943,LIGHTPINK:4290167295,LIGHTSALMON:4288707327,LIGHTSEAGREEN:548580095,LIGHTSKYBLUE:2278488831,LIGHTSLATEGRAY:2005441023,LIGHTSLATEGREY:2005441023,LIGHTSTEELBLUE:2965692159,LIGHTYELLOW:4294959359,LIME:16711935,LIMEGREEN:852308735,LINEN:4210091775,MAGENTA:4278255615,MAROON:2147483903,MEDIUMAQUAMARINE:1724754687,MEDIUMBLUE:52735,MEDIUMORCHID:3126187007,MEDIUMPURPLE:2473647103,MEDIUMSEAGREEN:1018393087,MEDIUMSLATEBLUE:2070474495,MEDIUMSPRINGGREEN:16423679,MEDIUMTURQUOISE:1221709055,MEDIUMVIOLETRED:3340076543,MIDNIGHTBLUE:421097727,MINTCREAM:4127193855,MISTYROSE:4293190143,MOCCASIN:4293178879,NAVAJOWHITE:4292783615,NAVY:33023,OLDLACE:4260751103,OLIVE:2155872511,OLIVEDRAB:1804477439,ORANGE:4289003775,ORANGERED:4282712319,ORCHID:3664828159,PALEGOLDENROD:4008225535,PALEGREEN:2566625535,PALETURQUOISE:2951671551,PALEVIOLETRED:3681588223,PAPAYAWHIP:4293907967,PEACHPUFF:4292524543,PERU:3448061951,PINK:4290825215,PLUM:3718307327,POWDERBLUE:2967529215,PURPLE:2147516671,REBECCAPURPLE:1714657791,RED:4278190335,ROSYBROWN:3163525119,ROYALBLUE:1097458175,SADDLEBROWN:2336560127,SALMON:4202722047,SANDYBROWN:4104413439,SEAGREEN:780883967,SEASHELL:4294307583,SIENNA:2689740287,SILVER:3233857791,SKYBLUE:2278484991,SLATEBLUE:1784335871,SLATEGRAY:1887473919,SLATEGREY:1887473919,SNOW:4294638335,SPRINGGREEN:16744447,STEELBLUE:1182971135,TAN:3535047935,TEAL:8421631,THISTLE:3636451583,TOMATO:4284696575,TRANSPARENT:0,TURQUOISE:1088475391,VIOLET:4001558271,WHEAT:4125012991,WHITE:4294967295,WHITESMOKE:4126537215,YELLOW:4294902015,YELLOWGREEN:2597139199},yC={name:"background-clip",initialValue:"border-box",prefix:!1,type:1,parse:function(r,e){return e.map(function(t){if(bt(t))switch(t.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},bC={name:"background-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},Na=function(r,e){var t=ws.parse(r,e[0]),i=e[1];return i&&Nt(i)?{color:t,stop:i}:{color:t,stop:null}},Od=function(r,e){var t=r[0],i=r[r.length-1];t.stop===null&&(t.stop=qt),i.stop===null&&(i.stop=xs);for(var s=[],o=0,a=0;a<r.length;a++){var n=r[a].stop;if(n!==null){var l=Ct(n,e);l>o?s.push(l):s.push(o),o=l}else s.push(null)}for(var c=null,a=0;a<s.length;a++){var h=s[a];if(h===null)c===null&&(c=a);else if(c!==null){for(var d=a-c,p=s[c-1],m=(h-p)/(d+1),g=1;g<=d;g++)s[c+g-1]=m*g;c=null}}return r.map(function(u,x){var y=u.color;return{color:y,stop:Math.max(Math.min(1,s[x]/e),0)}})},BC=function(r,e,t){var i=e/2,s=t/2,o=Ct(r[0],e)-i,a=s-Ct(r[1],t);return(Math.atan2(a,o)+Math.PI*2)%(Math.PI*2)},wC=function(r,e,t){var i=typeof r=="number"?r:BC(r,e,t),s=Math.abs(e*Math.sin(i))+Math.abs(t*Math.cos(i)),o=e/2,a=t/2,n=s/2,l=Math.sin(i-Math.PI/2)*n,c=Math.cos(i-Math.PI/2)*n;return[s,o-c,o+c,a-l,a+l]},Fi=function(r,e){return Math.sqrt(r*r+e*e)},kd=function(r,e,t,i,s){var o=[[0,0],[0,e],[r,0],[r,e]];return o.reduce(function(a,n){var l=n[0],c=n[1],h=Fi(t-l,i-c);return(s?h<a.optimumDistance:h>a.optimumDistance)?{optimumCorner:n,optimumDistance:h}:a},{optimumDistance:s?1/0:-1/0,optimumCorner:null}).optimumCorner},CC=function(r,e,t,i,s){var o=0,a=0;switch(r.size){case 0:r.shape===0?o=a=Math.min(Math.abs(e),Math.abs(e-i),Math.abs(t),Math.abs(t-s)):r.shape===1&&(o=Math.min(Math.abs(e),Math.abs(e-i)),a=Math.min(Math.abs(t),Math.abs(t-s)));break;case 2:if(r.shape===0)o=a=Math.min(Fi(e,t),Fi(e,t-s),Fi(e-i,t),Fi(e-i,t-s));else if(r.shape===1){var n=Math.min(Math.abs(t),Math.abs(t-s))/Math.min(Math.abs(e),Math.abs(e-i)),l=kd(i,s,e,t,!0),c=l[0],h=l[1];o=Fi(c-e,(h-t)/n),a=n*o}break;case 1:r.shape===0?o=a=Math.max(Math.abs(e),Math.abs(e-i),Math.abs(t),Math.abs(t-s)):r.shape===1&&(o=Math.max(Math.abs(e),Math.abs(e-i)),a=Math.max(Math.abs(t),Math.abs(t-s)));break;case 3:if(r.shape===0)o=a=Math.max(Fi(e,t),Fi(e,t-s),Fi(e-i,t),Fi(e-i,t-s));else if(r.shape===1){var n=Math.max(Math.abs(t),Math.abs(t-s))/Math.max(Math.abs(e),Math.abs(e-i)),d=kd(i,s,e,t,!1),c=d[0],h=d[1];o=Fi(c-e,(h-t)/n),a=n*o}break}return Array.isArray(r.size)&&(o=Ct(r.size[0],i),a=r.size.length===2?Ct(r.size[1],s):o),[o,a]},MC=function(r,e){var t=Ei(180),i=[];return zi(e).forEach(function(s,o){if(o===0){var a=s[0];if(a.type===20&&a.value==="to"){t=lm(s);return}else if(am(a)){t=ka.parse(r,a);return}}var n=Na(r,s);i.push(n)}),{angle:t,stops:i,type:1}},Xn=function(r,e){var t=Ei(180),i=[];return zi(e).forEach(function(s,o){if(o===0){var a=s[0];if(a.type===20&&["top","left","right","bottom"].indexOf(a.value)!==-1){t=lm(s);return}else if(am(a)){t=(ka.parse(r,a)+Ei(270))%Ei(360);return}}var n=Na(r,s);i.push(n)}),{angle:t,stops:i,type:1}},EC=function(r,e){var t=Ei(180),i=[],s=1,o=0,a=3,n=[];return zi(e).forEach(function(l,c){var h=l[0];if(c===0){if(bt(h)&&h.value==="linear"){s=1;return}else if(bt(h)&&h.value==="radial"){s=2;return}}if(h.type===18){if(h.name==="from"){var d=ws.parse(r,h.values[0]);i.push({stop:qt,color:d})}else if(h.name==="to"){var d=ws.parse(r,h.values[0]);i.push({stop:xs,color:d})}else if(h.name==="color-stop"){var p=h.values.filter(Fr);if(p.length===2){var d=ws.parse(r,p[1]),m=p[0];Sr(m)&&i.push({stop:{type:16,number:m.number*100,flags:m.flags},color:d})}}}}),s===1?{angle:(t+Ei(180))%Ei(360),stops:i,type:s}:{size:a,shape:o,stops:i,position:n,type:s}},Am="closest-side",cm="farthest-side",hm="closest-corner",um="farthest-corner",dm="circle",pm="ellipse",fm="cover",mm="contain",IC=function(r,e){var t=0,i=3,s=[],o=[];return zi(e).forEach(function(a,n){var l=!0;if(n===0){var c=!1;l=a.reduce(function(d,p){if(c)if(bt(p))switch(p.value){case"center":return o.push(pc),d;case"top":case"left":return o.push(qt),d;case"right":case"bottom":return o.push(xs),d}else(Nt(p)||Es(p))&&o.push(p);else if(bt(p))switch(p.value){case dm:return t=0,!1;case pm:return t=1,!1;case"at":return c=!0,!1;case Am:return i=0,!1;case fm:case cm:return i=1,!1;case mm:case hm:return i=2,!1;case um:return i=3,!1}else if(Es(p)||Nt(p))return Array.isArray(i)||(i=[]),i.push(p),!1;return d},l)}if(l){var h=Na(r,a);s.push(h)}}),{size:i,shape:t,stops:s,position:o,type:2}},Yn=function(r,e){var t=0,i=3,s=[],o=[];return zi(e).forEach(function(a,n){var l=!0;if(n===0?l=a.reduce(function(h,d){if(bt(d))switch(d.value){case"center":return o.push(pc),!1;case"top":case"left":return o.push(qt),!1;case"right":case"bottom":return o.push(xs),!1}else if(Nt(d)||Es(d))return o.push(d),!1;return h},l):n===1&&(l=a.reduce(function(h,d){if(bt(d))switch(d.value){case dm:return t=0,!1;case pm:return t=1,!1;case mm:case Am:return i=0,!1;case cm:return i=1,!1;case hm:return i=2,!1;case fm:case um:return i=3,!1}else if(Es(d)||Nt(d))return Array.isArray(i)||(i=[]),i.push(d),!1;return h},l)),l){var c=Na(r,a);s.push(c)}}),{size:i,shape:t,stops:s,position:o,type:2}},FC=function(r){return r.type===1},SC=function(r){return r.type===2},fc={name:"image",parse:function(r,e){if(e.type===22){var t={url:e.value,type:0};return r.cache.addImage(e.value),t}if(e.type===18){var i=gm[e.name];if(typeof i>"u")throw new Error('Attempting to parse an unsupported image function "'+e.name+'"');return i(r,e.values)}throw new Error("Unsupported image type "+e.type)}};function TC(r){return!(r.type===20&&r.value==="none")&&(r.type!==18||!!gm[r.name])}var gm={"linear-gradient":MC,"-moz-linear-gradient":Xn,"-ms-linear-gradient":Xn,"-o-linear-gradient":Xn,"-webkit-linear-gradient":Xn,"radial-gradient":IC,"-moz-radial-gradient":Yn,"-ms-radial-gradient":Yn,"-o-radial-gradient":Yn,"-webkit-radial-gradient":Yn,"-webkit-gradient":EC},DC={name:"background-image",initialValue:"none",type:1,prefix:!1,parse:function(r,e){if(e.length===0)return[];var t=e[0];return t.type===20&&t.value==="none"?[]:e.filter(function(i){return Fr(i)&&TC(i)}).map(function(i){return fc.parse(r,i)})}},RC={name:"background-origin",initialValue:"border-box",prefix:!1,type:1,parse:function(r,e){return e.map(function(t){if(bt(t))switch(t.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},LC={name:"background-position",initialValue:"0% 0%",type:1,prefix:!1,parse:function(r,e){return zi(e).map(function(t){return t.filter(Nt)}).map(im)}},UC={name:"background-repeat",initialValue:"repeat",prefix:!1,type:1,parse:function(r,e){return zi(e).map(function(t){return t.filter(bt).map(function(i){return i.value}).join(" ")}).map(OC)}},OC=function(r){switch(r){case"no-repeat":return 1;case"repeat-x":case"repeat no-repeat":return 2;case"repeat-y":case"no-repeat repeat":return 3;case"repeat":default:return 0}},Mr;(function(r){r.AUTO="auto",r.CONTAIN="contain",r.COVER="cover"})(Mr||(Mr={}));var kC={name:"background-size",initialValue:"0",prefix:!1,type:1,parse:function(r,e){return zi(e).map(function(t){return t.filter(NC)})}},NC=function(r){return bt(r)||Nt(r)},Qa=function(r){return{name:"border-"+r+"-color",initialValue:"transparent",prefix:!1,type:3,format:"color"}},QC=Qa("top"),VC=Qa("right"),HC=Qa("bottom"),jC=Qa("left"),Va=function(r){return{name:"border-radius-"+r,initialValue:"0 0",prefix:!1,type:1,parse:function(e,t){return im(t.filter(Nt))}}},zC=Va("top-left"),GC=Va("top-right"),WC=Va("bottom-right"),KC=Va("bottom-left"),Ha=function(r){return{name:"border-"+r+"-style",initialValue:"solid",prefix:!1,type:2,parse:function(e,t){switch(t){case"none":return 0;case"dashed":return 2;case"dotted":return 3;case"double":return 4}return 1}}},XC=Ha("top"),YC=Ha("right"),$C=Ha("bottom"),ZC=Ha("left"),ja=function(r){return{name:"border-"+r+"-width",initialValue:"0",type:0,prefix:!1,parse:function(e,t){return ko(t)?t.number:0}}},qC=ja("top"),JC=ja("right"),e1=ja("bottom"),t1=ja("left"),i1={name:"color",initialValue:"transparent",prefix:!1,type:3,format:"color"},s1={name:"direction",initialValue:"ltr",prefix:!1,type:2,parse:function(r,e){switch(e){case"rtl":return 1;case"ltr":default:return 0}}},r1={name:"display",initialValue:"inline-block",prefix:!1,type:1,parse:function(r,e){return e.filter(bt).reduce(function(t,i){return t|o1(i.value)},0)}},o1=function(r){switch(r){case"block":case"-webkit-box":return 2;case"inline":return 4;case"run-in":return 8;case"flow":return 16;case"flow-root":return 32;case"table":return 64;case"flex":case"-webkit-flex":return 128;case"grid":case"-ms-grid":return 256;case"ruby":return 512;case"subgrid":return 1024;case"list-item":return 2048;case"table-row-group":return 4096;case"table-header-group":return 8192;case"table-footer-group":return 16384;case"table-row":return 32768;case"table-cell":return 65536;case"table-column-group":return 131072;case"table-column":return 262144;case"table-caption":return 524288;case"ruby-base":return 1048576;case"ruby-text":return 2097152;case"ruby-base-container":return 4194304;case"ruby-text-container":return 8388608;case"contents":return 16777216;case"inline-block":return 33554432;case"inline-list-item":return 67108864;case"inline-table":return 134217728;case"inline-flex":return 268435456;case"inline-grid":return 536870912}return 0},n1={name:"float",initialValue:"none",prefix:!1,type:2,parse:function(r,e){switch(e){case"left":return 1;case"right":return 2;case"inline-start":return 3;case"inline-end":return 4}return 0}},a1={name:"letter-spacing",initialValue:"0",prefix:!1,type:0,parse:function(r,e){return e.type===20&&e.value==="normal"?0:e.type===17||e.type===15?e.number:0}},ya;(function(r){r.NORMAL="normal",r.STRICT="strict"})(ya||(ya={}));var l1={name:"line-break",initialValue:"normal",prefix:!1,type:2,parse:function(r,e){switch(e){case"strict":return ya.STRICT;case"normal":default:return ya.NORMAL}}},A1={name:"line-height",initialValue:"normal",prefix:!1,type:4},Nd=function(r,e){return bt(r)&&r.value==="normal"?1.2*e:r.type===17?e*r.number:Nt(r)?Ct(r,e):e},c1={name:"list-style-image",initialValue:"none",type:0,prefix:!1,parse:function(r,e){return e.type===20&&e.value==="none"?null:fc.parse(r,e)}},h1={name:"list-style-position",initialValue:"outside",prefix:!1,type:2,parse:function(r,e){switch(e){case"inside":return 0;case"outside":default:return 1}}},YA={name:"list-style-type",initialValue:"none",prefix:!1,type:2,parse:function(r,e){switch(e){case"disc":return 0;case"circle":return 1;case"square":return 2;case"decimal":return 3;case"cjk-decimal":return 4;case"decimal-leading-zero":return 5;case"lower-roman":return 6;case"upper-roman":return 7;case"lower-greek":return 8;case"lower-alpha":return 9;case"upper-alpha":return 10;case"arabic-indic":return 11;case"armenian":return 12;case"bengali":return 13;case"cambodian":return 14;case"cjk-earthly-branch":return 15;case"cjk-heavenly-stem":return 16;case"cjk-ideographic":return 17;case"devanagari":return 18;case"ethiopic-numeric":return 19;case"georgian":return 20;case"gujarati":return 21;case"gurmukhi":return 22;case"hebrew":return 22;case"hiragana":return 23;case"hiragana-iroha":return 24;case"japanese-formal":return 25;case"japanese-informal":return 26;case"kannada":return 27;case"katakana":return 28;case"katakana-iroha":return 29;case"khmer":return 30;case"korean-hangul-formal":return 31;case"korean-hanja-formal":return 32;case"korean-hanja-informal":return 33;case"lao":return 34;case"lower-armenian":return 35;case"malayalam":return 36;case"mongolian":return 37;case"myanmar":return 38;case"oriya":return 39;case"persian":return 40;case"simp-chinese-formal":return 41;case"simp-chinese-informal":return 42;case"tamil":return 43;case"telugu":return 44;case"thai":return 45;case"tibetan":return 46;case"trad-chinese-formal":return 47;case"trad-chinese-informal":return 48;case"upper-armenian":return 49;case"disclosure-open":return 50;case"disclosure-closed":return 51;case"none":default:return-1}}},za=function(r){return{name:"margin-"+r,initialValue:"0",prefix:!1,type:4}},u1=za("top"),d1=za("right"),p1=za("bottom"),f1=za("left"),m1={name:"overflow",initialValue:"visible",prefix:!1,type:1,parse:function(r,e){return e.filter(bt).map(function(t){switch(t.value){case"hidden":return 1;case"scroll":return 2;case"clip":return 3;case"auto":return 4;case"visible":default:return 0}})}},g1={name:"overflow-wrap",initialValue:"normal",prefix:!1,type:2,parse:function(r,e){switch(e){case"break-word":return"break-word";case"normal":default:return"normal"}}},Ga=function(r){return{name:"padding-"+r,initialValue:"0",prefix:!1,type:3,format:"length-percentage"}},_1=Ga("top"),v1=Ga("right"),P1=Ga("bottom"),x1=Ga("left"),y1={name:"text-align",initialValue:"left",prefix:!1,type:2,parse:function(r,e){switch(e){case"right":return 2;case"center":case"justify":return 1;case"left":default:return 0}}},b1={name:"position",initialValue:"static",prefix:!1,type:2,parse:function(r,e){switch(e){case"relative":return 1;case"absolute":return 2;case"fixed":return 3;case"sticky":return 4}return 0}},B1={name:"text-shadow",initialValue:"none",type:1,prefix:!1,parse:function(r,e){return e.length===1&&XA(e[0],"none")?[]:zi(e).map(function(t){for(var i={color:ns.TRANSPARENT,offsetX:qt,offsetY:qt,blur:qt},s=0,o=0;o<t.length;o++){var a=t[o];Es(a)?(s===0?i.offsetX=a:s===1?i.offsetY=a:i.blur=a,s++):i.color=ws.parse(r,a)}return i})}},w1={name:"text-transform",initialValue:"none",prefix:!1,type:2,parse:function(r,e){switch(e){case"uppercase":return 2;case"lowercase":return 1;case"capitalize":return 3}return 0}},C1={name:"transform",initialValue:"none",prefix:!0,type:0,parse:function(r,e){if(e.type===20&&e.value==="none")return null;if(e.type===18){var t=I1[e.name];if(typeof t>"u")throw new Error('Attempting to parse an unsupported transform function "'+e.name+'"');return t(e.values)}return null}},M1=function(r){var e=r.filter(function(t){return t.type===17}).map(function(t){return t.number});return e.length===6?e:null},E1=function(r){var e=r.filter(function(l){return l.type===17}).map(function(l){return l.number}),t=e[0],i=e[1];e[2],e[3];var s=e[4],o=e[5];e[6],e[7],e[8],e[9],e[10],e[11];var a=e[12],n=e[13];return e[14],e[15],e.length===16?[t,i,s,o,a,n]:null},I1={matrix:M1,matrix3d:E1},Qd={type:16,number:50,flags:Oo},F1=[Qd,Qd],S1={name:"transform-origin",initialValue:"50% 50%",prefix:!0,type:1,parse:function(r,e){var t=e.filter(Nt);return t.length!==2?F1:[t[0],t[1]]}},T1={name:"visible",initialValue:"none",prefix:!1,type:2,parse:function(r,e){switch(e){case"hidden":return 1;case"collapse":return 2;case"visible":default:return 0}}},Bo;(function(r){r.NORMAL="normal",r.BREAK_ALL="break-all",r.KEEP_ALL="keep-all"})(Bo||(Bo={}));var D1={name:"word-break",initialValue:"normal",prefix:!1,type:2,parse:function(r,e){switch(e){case"break-all":return Bo.BREAK_ALL;case"keep-all":return Bo.KEEP_ALL;case"normal":default:return Bo.NORMAL}}},R1={name:"z-index",initialValue:"auto",prefix:!1,type:0,parse:function(r,e){if(e.type===20)return{auto:!0,order:0};if(Sr(e))return{auto:!1,order:e.number};throw new Error("Invalid z-index number parsed")}},_m={name:"time",parse:function(r,e){if(e.type===15)switch(e.unit.toLowerCase()){case"s":return 1e3*e.number;case"ms":return e.number}throw new Error("Unsupported time type")}},L1={name:"opacity",initialValue:"1",type:0,prefix:!1,parse:function(r,e){return Sr(e)?e.number:1}},U1={name:"text-decoration-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},O1={name:"text-decoration-line",initialValue:"none",prefix:!1,type:1,parse:function(r,e){return e.filter(bt).map(function(t){switch(t.value){case"underline":return 1;case"overline":return 2;case"line-through":return 3;case"none":return 4}return 0}).filter(function(t){return t!==0})}},k1={name:"font-family",initialValue:"",prefix:!1,type:1,parse:function(r,e){var t=[],i=[];return e.forEach(function(s){switch(s.type){case 20:case 0:t.push(s.value);break;case 17:t.push(s.number.toString());break;case 4:i.push(t.join(" ")),t.length=0;break}}),t.length&&i.push(t.join(" ")),i.map(function(s){return s.indexOf(" ")===-1?s:"'"+s+"'"})}},N1={name:"font-size",initialValue:"0",prefix:!1,type:3,format:"length"},Q1={name:"font-weight",initialValue:"normal",type:0,prefix:!1,parse:function(r,e){if(Sr(e))return e.number;if(bt(e))switch(e.value){case"bold":return 700;case"normal":default:return 400}return 400}},V1={name:"font-variant",initialValue:"none",type:1,prefix:!1,parse:function(r,e){return e.filter(bt).map(function(t){return t.value})}},H1={name:"font-style",initialValue:"normal",prefix:!1,type:2,parse:function(r,e){switch(e){case"oblique":return"oblique";case"italic":return"italic";case"normal":default:return"normal"}}},Ht=function(r,e){return(r&e)!==0},j1={name:"content",initialValue:"none",type:1,prefix:!1,parse:function(r,e){if(e.length===0)return[];var t=e[0];return t.type===20&&t.value==="none"?[]:e}},z1={name:"counter-increment",initialValue:"none",prefix:!0,type:1,parse:function(r,e){if(e.length===0)return null;var t=e[0];if(t.type===20&&t.value==="none")return null;for(var i=[],s=e.filter(tm),o=0;o<s.length;o++){var a=s[o],n=s[o+1];if(a.type===20){var l=n&&Sr(n)?n.number:1;i.push({counter:a.value,increment:l})}}return i}},G1={name:"counter-reset",initialValue:"none",prefix:!0,type:1,parse:function(r,e){if(e.length===0)return[];for(var t=[],i=e.filter(tm),s=0;s<i.length;s++){var o=i[s],a=i[s+1];if(bt(o)&&o.value!=="none"){var n=a&&Sr(a)?a.number:0;t.push({counter:o.value,reset:n})}}return t}},W1={name:"duration",initialValue:"0s",prefix:!1,type:1,parse:function(r,e){return e.filter(ko).map(function(t){return _m.parse(r,t)})}},K1={name:"quotes",initialValue:"none",prefix:!0,type:1,parse:function(r,e){if(e.length===0)return null;var t=e[0];if(t.type===20&&t.value==="none")return null;var i=[],s=e.filter(vC);if(s.length%2!==0)return null;for(var o=0;o<s.length;o+=2){var a=s[o].value,n=s[o+1].value;i.push({open:a,close:n})}return i}},Vd=function(r,e,t){if(!r)return"";var i=r[Math.min(e,r.length-1)];return i?t?i.open:i.close:""},X1={name:"box-shadow",initialValue:"none",type:1,prefix:!1,parse:function(r,e){return e.length===1&&XA(e[0],"none")?[]:zi(e).map(function(t){for(var i={color:255,offsetX:qt,offsetY:qt,blur:qt,spread:qt,inset:!1},s=0,o=0;o<t.length;o++){var a=t[o];XA(a,"inset")?i.inset=!0:Es(a)?(s===0?i.offsetX=a:s===1?i.offsetY=a:s===2?i.blur=a:i.spread=a,s++):i.color=ws.parse(r,a)}return i})}},Y1={name:"paint-order",initialValue:"normal",prefix:!1,type:1,parse:function(r,e){var t=[0,1,2],i=[];return e.filter(bt).forEach(function(s){switch(s.value){case"stroke":i.push(1);break;case"fill":i.push(0);break;case"markers":i.push(2);break}}),t.forEach(function(s){i.indexOf(s)===-1&&i.push(s)}),i}},$1={name:"-webkit-text-stroke-color",initialValue:"currentcolor",prefix:!1,type:3,format:"color"},Z1={name:"-webkit-text-stroke-width",initialValue:"0",type:0,prefix:!1,parse:function(r,e){return ko(e)?e.number:0}},q1=function(){function r(e,t){var i,s;this.animationDuration=Ve(e,W1,t.animationDuration),this.backgroundClip=Ve(e,yC,t.backgroundClip),this.backgroundColor=Ve(e,bC,t.backgroundColor),this.backgroundImage=Ve(e,DC,t.backgroundImage),this.backgroundOrigin=Ve(e,RC,t.backgroundOrigin),this.backgroundPosition=Ve(e,LC,t.backgroundPosition),this.backgroundRepeat=Ve(e,UC,t.backgroundRepeat),this.backgroundSize=Ve(e,kC,t.backgroundSize),this.borderTopColor=Ve(e,QC,t.borderTopColor),this.borderRightColor=Ve(e,VC,t.borderRightColor),this.borderBottomColor=Ve(e,HC,t.borderBottomColor),this.borderLeftColor=Ve(e,jC,t.borderLeftColor),this.borderTopLeftRadius=Ve(e,zC,t.borderTopLeftRadius),this.borderTopRightRadius=Ve(e,GC,t.borderTopRightRadius),this.borderBottomRightRadius=Ve(e,WC,t.borderBottomRightRadius),this.borderBottomLeftRadius=Ve(e,KC,t.borderBottomLeftRadius),this.borderTopStyle=Ve(e,XC,t.borderTopStyle),this.borderRightStyle=Ve(e,YC,t.borderRightStyle),this.borderBottomStyle=Ve(e,$C,t.borderBottomStyle),this.borderLeftStyle=Ve(e,ZC,t.borderLeftStyle),this.borderTopWidth=Ve(e,qC,t.borderTopWidth),this.borderRightWidth=Ve(e,JC,t.borderRightWidth),this.borderBottomWidth=Ve(e,e1,t.borderBottomWidth),this.borderLeftWidth=Ve(e,t1,t.borderLeftWidth),this.boxShadow=Ve(e,X1,t.boxShadow),this.color=Ve(e,i1,t.color),this.direction=Ve(e,s1,t.direction),this.display=Ve(e,r1,t.display),this.float=Ve(e,n1,t.cssFloat),this.fontFamily=Ve(e,k1,t.fontFamily),this.fontSize=Ve(e,N1,t.fontSize),this.fontStyle=Ve(e,H1,t.fontStyle),this.fontVariant=Ve(e,V1,t.fontVariant),this.fontWeight=Ve(e,Q1,t.fontWeight),this.letterSpacing=Ve(e,a1,t.letterSpacing),this.lineBreak=Ve(e,l1,t.lineBreak),this.lineHeight=Ve(e,A1,t.lineHeight),this.listStyleImage=Ve(e,c1,t.listStyleImage),this.listStylePosition=Ve(e,h1,t.listStylePosition),this.listStyleType=Ve(e,YA,t.listStyleType),this.marginTop=Ve(e,u1,t.marginTop),this.marginRight=Ve(e,d1,t.marginRight),this.marginBottom=Ve(e,p1,t.marginBottom),this.marginLeft=Ve(e,f1,t.marginLeft),this.opacity=Ve(e,L1,t.opacity);var o=Ve(e,m1,t.overflow);this.overflowX=o[0],this.overflowY=o[o.length>1?1:0],this.overflowWrap=Ve(e,g1,t.overflowWrap),this.paddingTop=Ve(e,_1,t.paddingTop),this.paddingRight=Ve(e,v1,t.paddingRight),this.paddingBottom=Ve(e,P1,t.paddingBottom),this.paddingLeft=Ve(e,x1,t.paddingLeft),this.paintOrder=Ve(e,Y1,t.paintOrder),this.position=Ve(e,b1,t.position),this.textAlign=Ve(e,y1,t.textAlign),this.textDecorationColor=Ve(e,U1,(i=t.textDecorationColor)!==null&&i!==void 0?i:t.color),this.textDecorationLine=Ve(e,O1,(s=t.textDecorationLine)!==null&&s!==void 0?s:t.textDecoration),this.textShadow=Ve(e,B1,t.textShadow),this.textTransform=Ve(e,w1,t.textTransform),this.transform=Ve(e,C1,t.transform),this.transformOrigin=Ve(e,S1,t.transformOrigin),this.visibility=Ve(e,T1,t.visibility),this.webkitTextStrokeColor=Ve(e,$1,t.webkitTextStrokeColor),this.webkitTextStrokeWidth=Ve(e,Z1,t.webkitTextStrokeWidth),this.wordBreak=Ve(e,D1,t.wordBreak),this.zIndex=Ve(e,R1,t.zIndex)}return r.prototype.isVisible=function(){return this.display>0&&this.opacity>0&&this.visibility===0},r.prototype.isTransparent=function(){return Cs(this.backgroundColor)},r.prototype.isTransformed=function(){return this.transform!==null},r.prototype.isPositioned=function(){return this.position!==0},r.prototype.isPositionedWithZIndex=function(){return this.isPositioned()&&!this.zIndex.auto},r.prototype.isFloating=function(){return this.float!==0},r.prototype.isInlineLevel=function(){return Ht(this.display,4)||Ht(this.display,33554432)||Ht(this.display,268435456)||Ht(this.display,536870912)||Ht(this.display,67108864)||Ht(this.display,134217728)},r}(),J1=function(){function r(e,t){this.content=Ve(e,j1,t.content),this.quotes=Ve(e,K1,t.quotes)}return r}(),Hd=function(){function r(e,t){this.counterIncrement=Ve(e,z1,t.counterIncrement),this.counterReset=Ve(e,G1,t.counterReset)}return r}(),Ve=function(r,e,t){var i=new Jf,s=t!==null&&typeof t<"u"?t.toString():e.initialValue;i.write(s);var o=new em(i.read());switch(e.type){case 2:var a=o.parseComponentValue();return e.parse(r,bt(a)?a.value:e.initialValue);case 0:return e.parse(r,o.parseComponentValue());case 1:return e.parse(r,o.parseComponentValues());case 4:return o.parseComponentValue();case 3:switch(e.format){case"angle":return ka.parse(r,o.parseComponentValue());case"color":return ws.parse(r,o.parseComponentValue());case"image":return fc.parse(r,o.parseComponentValue());case"length":var n=o.parseComponentValue();return Es(n)?n:qt;case"length-percentage":var l=o.parseComponentValue();return Nt(l)?l:qt;case"time":return _m.parse(r,o.parseComponentValue())}break}},eM="data-html2canvas-debug",tM=function(r){var e=r.getAttribute(eM);switch(e){case"all":return 1;case"clone":return 2;case"parse":return 3;case"render":return 4;default:return 0}},$A=function(r,e){var t=tM(r);return t===1||e===t},Gi=function(){function r(e,t){if(this.context=e,this.textNodes=[],this.elements=[],this.flags=0,$A(t,3))debugger;this.styles=new q1(e,window.getComputedStyle(t,null)),JA(t)&&(this.styles.animationDuration.some(function(i){return i>0})&&(t.style.animationDuration="0s"),this.styles.transform!==null&&(t.style.transform="none")),this.bounds=Ua(this.context,t),$A(t,4)&&(this.flags|=16)}return r}(),iM="AAAAAAAAAAAAEA4AGBkAAFAaAAACAAAAAAAIABAAGAAwADgACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAAQABIAEQATAAIABAACAAQAAgAEAAIABAAVABcAAgAEAAIABAACAAQAGAAaABwAHgAgACIAI4AlgAIABAAmwCjAKgAsAC2AL4AvQDFAMoA0gBPAVYBWgEIAAgACACMANoAYgFkAWwBdAF8AX0BhQGNAZUBlgGeAaMBlQGWAasBswF8AbsBwwF0AcsBYwHTAQgA2wG/AOMBdAF8AekB8QF0AfkB+wHiAHQBfAEIAAMC5gQIAAsCEgIIAAgAFgIeAggAIgIpAggAMQI5AkACygEIAAgASAJQAlgCYAIIAAgACAAKBQoFCgUTBRMFGQUrBSsFCAAIAAgACAAIAAgACAAIAAgACABdAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABoAmgCrwGvAQgAbgJ2AggAHgEIAAgACADnAXsCCAAIAAgAgwIIAAgACAAIAAgACACKAggAkQKZAggAPADJAAgAoQKkAqwCsgK6AsICCADJAggA0AIIAAgACAAIANYC3gIIAAgACAAIAAgACABAAOYCCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAkASoB+QIEAAgACAA8AEMCCABCBQgACABJBVAFCAAIAAgACAAIAAgACAAIAAgACABTBVoFCAAIAFoFCABfBWUFCAAIAAgACAAIAAgAbQUIAAgACAAIAAgACABzBXsFfQWFBYoFigWKBZEFigWKBYoFmAWfBaYFrgWxBbkFCAAIAAgACAAIAAgACAAIAAgACAAIAMEFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAMgFCADQBQgACAAIAAgACAAIAAgACAAIAAgACAAIAO4CCAAIAAgAiQAIAAgACABAAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAD0AggACAD8AggACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIANYFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAMDvwAIAAgAJAIIAAgACAAIAAgACAAIAAgACwMTAwgACAB9BOsEGwMjAwgAKwMyAwsFYgE3A/MEPwMIAEUDTQNRAwgAWQOsAGEDCAAIAAgACAAIAAgACABpAzQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFIQUoBSwFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABtAwgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABMAEwACAAIAAgACAAIABgACAAIAAgACAC/AAgACAAyAQgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACAAIAAwAAgACAAIAAgACAAIAAgACAAIAAAARABIAAgACAAIABQASAAIAAgAIABwAEAAjgCIABsAqAC2AL0AigDQAtwC+IJIQqVAZUBWQqVAZUBlQGVAZUBlQGrC5UBlQGVAZUBlQGVAZUBlQGVAXsKlQGVAbAK6wsrDGUMpQzlDJUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAfAKAAuZA64AtwCJALoC6ADwAAgAuACgA/oEpgO6AqsD+AAIAAgAswMIAAgACAAIAIkAuwP5AfsBwwPLAwgACAAIAAgACADRA9kDCAAIAOED6QMIAAgACAAIAAgACADuA/YDCAAIAP4DyQAIAAgABgQIAAgAXQAOBAgACAAIAAgACAAIABMECAAIAAgACAAIAAgACAD8AAQBCAAIAAgAGgQiBCoECAExBAgAEAEIAAgACAAIAAgACAAIAAgACAAIAAgACAA4BAgACABABEYECAAIAAgATAQYAQgAVAQIAAgACAAIAAgACAAIAAgACAAIAFoECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAOQEIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAB+BAcACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAEABhgSMBAgACAAIAAgAlAQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAwAEAAQABAADAAMAAwADAAQABAAEAAQABAAEAAQABHATAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAdQMIAAgACAAIAAgACAAIAMkACAAIAAgAfQMIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACFA4kDCAAIAAgACAAIAOcBCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAIcDCAAIAAgACAAIAAgACAAIAAgACAAIAJEDCAAIAAgACADFAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABgBAgAZgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAbAQCBXIECAAIAHkECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABAAJwEQACjBKoEsgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAC6BMIECAAIAAgACAAIAAgACABmBAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAxwQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAGYECAAIAAgAzgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBd0FXwUIAOIF6gXxBYoF3gT5BQAGCAaKBYoFigWKBYoFigWKBYoFigWKBYoFigXWBIoFigWKBYoFigWKBYoFigWKBYsFEAaKBYoFigWKBYoFigWKBRQGCACKBYoFigWKBQgACAAIANEECAAIABgGigUgBggAJgYIAC4GMwaKBYoF0wQ3Bj4GigWKBYoFigWKBYoFigWKBYoFigWKBYoFigUIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWLBf///////wQABAAEAAQABAAEAAQABAAEAAQAAwAEAAQAAgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAQADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUAAAAFAAUAAAAFAAUAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAQAAAAUABQAFAAUABQAFAAAAAAAFAAUAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAFAAUAAQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAAABwAHAAcAAAAHAAcABwAFAAEAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAcABwAFAAUAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAAAAQABAAAAAAAAAAAAAAAFAAUABQAFAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAHAAcAAAAHAAcAAAAAAAUABQAHAAUAAQAHAAEABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwABAAUABQAFAAUAAAAAAAAAAAAAAAEAAQABAAEAAQABAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABQANAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAABQAHAAUABQAFAAAAAAAAAAcABQAFAAUABQAFAAQABAAEAAQABAAEAAQABAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUAAAAFAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAUAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAcABwAFAAcABwAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUABwAHAAUABQAFAAUAAAAAAAcABwAAAAAABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAAAAAAAAAAABQAFAAAAAAAFAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAFAAUABQAFAAUAAAAFAAUABwAAAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABwAFAAUABQAFAAAAAAAHAAcAAAAAAAcABwAFAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAAAAAAAAAHAAcABwAAAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAUABQAFAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAHAAcABQAHAAcAAAAFAAcABwAAAAcABwAFAAUAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAFAAcABwAFAAUABQAAAAUAAAAHAAcABwAHAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAHAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUAAAAFAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAUAAAAFAAUAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABwAFAAUABQAFAAUABQAAAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABQAFAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAFAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAHAAUABQAFAAUABQAFAAUABwAHAAcABwAHAAcABwAHAAUABwAHAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABwAHAAcABwAFAAUABwAHAAcAAAAAAAAAAAAHAAcABQAHAAcABwAHAAcABwAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAUABQAFAAUABQAFAAUAAAAFAAAABQAAAAAABQAFAAUABQAFAAUABQAFAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAUABQAFAAUABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABwAFAAcABwAHAAcABwAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAUABQAFAAUABwAHAAUABQAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABQAFAAcABwAHAAUABwAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAcABQAFAAUABQAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAAAAAABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAAAAAAAAAFAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAUABQAHAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAFAAUABQAFAAcABwAFAAUABwAHAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAcABwAFAAUABwAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABQAAAAAABQAFAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAcABwAAAAAAAAAAAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAcABwAFAAcABwAAAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAFAAUABQAAAAUABQAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABwAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAHAAcABQAHAAUABQAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAAABwAHAAAAAAAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAFAAUABwAFAAcABwAFAAcABQAFAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAAAAAABwAHAAcABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAFAAcABwAFAAUABQAFAAUABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAUABQAFAAcABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABQAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAAAAAAFAAUABwAHAAcABwAFAAAAAAAAAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAHAAUABQAFAAUABQAFAAUABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAABQAAAAUABQAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAHAAcAAAAFAAUAAAAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABQAFAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAABQAFAAUABQAFAAUABQAAAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAFAAUABQAFAAUADgAOAA4ADgAOAA4ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAMAAwADAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkAAAAAAAAAAAAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAAAAAAAAAAAAsADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwACwAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAADgAOAA4AAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAAAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4AAAAOAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAAAAAAAAAAAA4AAAAOAAAAAAAAAAAADgAOAA4AAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAA=",jd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",go=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var $n=0;$n<jd.length;$n++)go[jd.charCodeAt($n)]=$n;var sM=function(r){var e=r.length*.75,t=r.length,i,s=0,o,a,n,l;r[r.length-1]==="="&&(e--,r[r.length-2]==="="&&e--);var c=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(e):new Array(e),h=Array.isArray(c)?c:new Uint8Array(c);for(i=0;i<t;i+=4)o=go[r.charCodeAt(i)],a=go[r.charCodeAt(i+1)],n=go[r.charCodeAt(i+2)],l=go[r.charCodeAt(i+3)],h[s++]=o<<2|a>>4,h[s++]=(a&15)<<4|n>>2,h[s++]=(n&3)<<6|l&63;return c},rM=function(r){for(var e=r.length,t=[],i=0;i<e;i+=2)t.push(r[i+1]<<8|r[i]);return t},oM=function(r){for(var e=r.length,t=[],i=0;i<e;i+=4)t.push(r[i+3]<<24|r[i+2]<<16|r[i+1]<<8|r[i]);return t},Gs=5,mc=11,iA=2,nM=mc-Gs,vm=65536>>Gs,aM=1<<Gs,sA=aM-1,lM=1024>>Gs,AM=vm+lM,cM=AM,hM=32,uM=cM+hM,dM=65536>>mc,pM=1<<nM,fM=pM-1,zd=function(r,e,t){return r.slice?r.slice(e,t):new Uint16Array(Array.prototype.slice.call(r,e,t))},mM=function(r,e,t){return r.slice?r.slice(e,t):new Uint32Array(Array.prototype.slice.call(r,e,t))},gM=function(r,e){var t=sM(r),i=Array.isArray(t)?oM(t):new Uint32Array(t),s=Array.isArray(t)?rM(t):new Uint16Array(t),o=24,a=zd(s,o/2,i[4]/2),n=i[5]===2?zd(s,(o+i[4])/2):mM(i,Math.ceil((o+i[4])/4));return new _M(i[0],i[1],i[2],i[3],a,n)},_M=function(){function r(e,t,i,s,o,a){this.initialValue=e,this.errorValue=t,this.highStart=i,this.highValueIndex=s,this.index=o,this.data=a}return r.prototype.get=function(e){var t;if(e>=0){if(e<55296||e>56319&&e<=65535)return t=this.index[e>>Gs],t=(t<<iA)+(e&sA),this.data[t];if(e<=65535)return t=this.index[vm+(e-55296>>Gs)],t=(t<<iA)+(e&sA),this.data[t];if(e<this.highStart)return t=uM-dM+(e>>mc),t=this.index[t],t+=e>>Gs&fM,t=this.index[t],t=(t<<iA)+(e&sA),this.data[t];if(e<=1114111)return this.data[this.highValueIndex]}return this.errorValue},r}(),Gd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",vM=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Zn=0;Zn<Gd.length;Zn++)vM[Gd.charCodeAt(Zn)]=Zn;var PM=1,rA=2,oA=3,Wd=4,Kd=5,xM=7,Xd=8,nA=9,aA=10,Yd=11,$d=12,Zd=13,qd=14,lA=15,yM=function(r){for(var e=[],t=0,i=r.length;t<i;){var s=r.charCodeAt(t++);if(s>=55296&&s<=56319&&t<i){var o=r.charCodeAt(t++);(o&64512)===56320?e.push(((s&1023)<<10)+(o&1023)+65536):(e.push(s),t--)}else e.push(s)}return e},bM=function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];if(String.fromCodePoint)return String.fromCodePoint.apply(String,r);var t=r.length;if(!t)return"";for(var i=[],s=-1,o="";++s<t;){var a=r[s];a<=65535?i.push(a):(a-=65536,i.push((a>>10)+55296,a%1024+56320)),(s+1===t||i.length>16384)&&(o+=String.fromCharCode.apply(String,i),i.length=0)}return o},BM=gM(iM),bi="×",AA="÷",wM=function(r){return BM.get(r)},CM=function(r,e,t){var i=t-2,s=e[i],o=e[t-1],a=e[t];if(o===rA&&a===oA)return bi;if(o===rA||o===oA||o===Wd||a===rA||a===oA||a===Wd)return AA;if(o===Xd&&[Xd,nA,Yd,$d].indexOf(a)!==-1||(o===Yd||o===nA)&&(a===nA||a===aA)||(o===$d||o===aA)&&a===aA||a===Zd||a===Kd||a===xM||o===PM)return bi;if(o===Zd&&a===qd){for(;s===Kd;)s=e[--i];if(s===qd)return bi}if(o===lA&&a===lA){for(var n=0;s===lA;)n++,s=e[--i];if(n%2===0)return bi}return AA},MM=function(r){var e=yM(r),t=e.length,i=0,s=0,o=e.map(wM);return{next:function(){if(i>=t)return{done:!0,value:null};for(var a=bi;i<t&&(a=CM(e,o,++i))===bi;);if(a!==bi||i===t){var n=bM.apply(null,e.slice(s,i));return s=i,{value:n,done:!1}}return{done:!0,value:null}}}},EM=function(r){for(var e=MM(r),t=[],i;!(i=e.next()).done;)i.value&&t.push(i.value.slice());return t},IM=function(r){var e=123;if(r.createRange){var t=r.createRange();if(t.getBoundingClientRect){var i=r.createElement("boundtest");i.style.height=e+"px",i.style.display="block",r.body.appendChild(i),t.selectNode(i);var s=t.getBoundingClientRect(),o=Math.round(s.height);if(r.body.removeChild(i),o===e)return!0}}return!1},FM=function(r){var e=r.createElement("boundtest");e.style.width="50px",e.style.display="block",e.style.fontSize="12px",e.style.letterSpacing="0px",e.style.wordSpacing="0px",r.body.appendChild(e);var t=r.createRange();e.innerHTML=typeof"".repeat=="function"?"&#128104;".repeat(10):"";var i=e.firstChild,s=Oa(i.data).map(function(l){return Ut(l)}),o=0,a={},n=s.every(function(l,c){t.setStart(i,o),t.setEnd(i,o+l.length);var h=t.getBoundingClientRect();o+=l.length;var d=h.x>a.x||h.y>a.y;return a=h,c===0?!0:d});return r.body.removeChild(e),n},SM=function(){return typeof new Image().crossOrigin<"u"},TM=function(){return typeof new XMLHttpRequest().responseType=="string"},DM=function(r){var e=new Image,t=r.createElement("canvas"),i=t.getContext("2d");if(!i)return!1;e.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";try{i.drawImage(e,0,0),t.toDataURL()}catch{return!1}return!0},Jd=function(r){return r[0]===0&&r[1]===255&&r[2]===0&&r[3]===255},RM=function(r){var e=r.createElement("canvas"),t=100;e.width=t,e.height=t;var i=e.getContext("2d");if(!i)return Promise.reject(!1);i.fillStyle="rgb(0, 255, 0)",i.fillRect(0,0,t,t);var s=new Image,o=e.toDataURL();s.src=o;var a=ZA(t,t,0,0,s);return i.fillStyle="red",i.fillRect(0,0,t,t),ep(a).then(function(n){i.drawImage(n,0,0);var l=i.getImageData(0,0,t,t).data;i.fillStyle="red",i.fillRect(0,0,t,t);var c=r.createElement("div");return c.style.backgroundImage="url("+o+")",c.style.height=t+"px",Jd(l)?ep(ZA(t,t,0,0,c)):Promise.reject(!1)}).then(function(n){return i.drawImage(n,0,0),Jd(i.getImageData(0,0,t,t).data)}).catch(function(){return!1})},ZA=function(r,e,t,i,s){var o="http://www.w3.org/2000/svg",a=document.createElementNS(o,"svg"),n=document.createElementNS(o,"foreignObject");return a.setAttributeNS(null,"width",r.toString()),a.setAttributeNS(null,"height",e.toString()),n.setAttributeNS(null,"width","100%"),n.setAttributeNS(null,"height","100%"),n.setAttributeNS(null,"x",t.toString()),n.setAttributeNS(null,"y",i.toString()),n.setAttributeNS(null,"externalResourcesRequired","true"),a.appendChild(n),n.appendChild(s),a},ep=function(r){return new Promise(function(e,t){var i=new Image;i.onload=function(){return e(i)},i.onerror=t,i.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(r))})},Zt={get SUPPORT_RANGE_BOUNDS(){var r=IM(document);return Object.defineProperty(Zt,"SUPPORT_RANGE_BOUNDS",{value:r}),r},get SUPPORT_WORD_BREAKING(){var r=Zt.SUPPORT_RANGE_BOUNDS&&FM(document);return Object.defineProperty(Zt,"SUPPORT_WORD_BREAKING",{value:r}),r},get SUPPORT_SVG_DRAWING(){var r=DM(document);return Object.defineProperty(Zt,"SUPPORT_SVG_DRAWING",{value:r}),r},get SUPPORT_FOREIGNOBJECT_DRAWING(){var r=typeof Array.from=="function"&&typeof window.fetch=="function"?RM(document):Promise.resolve(!1);return Object.defineProperty(Zt,"SUPPORT_FOREIGNOBJECT_DRAWING",{value:r}),r},get SUPPORT_CORS_IMAGES(){var r=SM();return Object.defineProperty(Zt,"SUPPORT_CORS_IMAGES",{value:r}),r},get SUPPORT_RESPONSE_TYPE(){var r=TM();return Object.defineProperty(Zt,"SUPPORT_RESPONSE_TYPE",{value:r}),r},get SUPPORT_CORS_XHR(){var r="withCredentials"in new XMLHttpRequest;return Object.defineProperty(Zt,"SUPPORT_CORS_XHR",{value:r}),r},get SUPPORT_NATIVE_TEXT_SEGMENTATION(){var r=!!(typeof Intl<"u"&&Intl.Segmenter);return Object.defineProperty(Zt,"SUPPORT_NATIVE_TEXT_SEGMENTATION",{value:r}),r}},wo=function(){function r(e,t){this.text=e,this.bounds=t}return r}(),LM=function(r,e,t,i){var s=kM(e,t),o=[],a=0;return s.forEach(function(n){if(t.textDecorationLine.length||n.trim().length>0)if(Zt.SUPPORT_RANGE_BOUNDS){var l=tp(i,a,n.length).getClientRects();if(l.length>1){var c=gc(n),h=0;c.forEach(function(p){o.push(new wo(p,As.fromDOMRectList(r,tp(i,h+a,p.length).getClientRects()))),h+=p.length})}else o.push(new wo(n,As.fromDOMRectList(r,l)))}else{var d=i.splitText(n.length);o.push(new wo(n,UM(r,i))),i=d}else Zt.SUPPORT_RANGE_BOUNDS||(i=i.splitText(n.length));a+=n.length}),o},UM=function(r,e){var t=e.ownerDocument;if(t){var i=t.createElement("html2canvaswrapper");i.appendChild(e.cloneNode(!0));var s=e.parentNode;if(s){s.replaceChild(i,e);var o=Ua(r,i);return i.firstChild&&s.replaceChild(i.firstChild,i),o}}return As.EMPTY},tp=function(r,e,t){var i=r.ownerDocument;if(!i)throw new Error("Node has no owner document");var s=i.createRange();return s.setStart(r,e),s.setEnd(r,e+t),s},gc=function(r){if(Zt.SUPPORT_NATIVE_TEXT_SEGMENTATION){var e=new Intl.Segmenter(void 0,{granularity:"grapheme"});return Array.from(e.segment(r)).map(function(t){return t.segment})}return EM(r)},OM=function(r,e){if(Zt.SUPPORT_NATIVE_TEXT_SEGMENTATION){var t=new Intl.Segmenter(void 0,{granularity:"word"});return Array.from(t.segment(r)).map(function(i){return i.segment})}return QM(r,e)},kM=function(r,e){return e.letterSpacing!==0?gc(r):OM(r,e)},NM=[32,160,4961,65792,65793,4153,4241],QM=function(r,e){for(var t=dw(r,{lineBreak:e.lineBreak,wordBreak:e.overflowWrap==="break-word"?"break-word":e.wordBreak}),i=[],s,o=function(){if(s.value){var a=s.value.slice(),n=Oa(a),l="";n.forEach(function(c){NM.indexOf(c)===-1?l+=Ut(c):(l.length&&i.push(l),i.push(Ut(c)),l="")}),l.length&&i.push(l)}};!(s=t.next()).done;)o();return i},VM=function(){function r(e,t,i){this.text=HM(t.data,i.textTransform),this.textBounds=LM(e,this.text,i,t)}return r}(),HM=function(r,e){switch(e){case 1:return r.toLowerCase();case 3:return r.replace(jM,zM);case 2:return r.toUpperCase();default:return r}},jM=/(^|\s|:|-|\(|\))([a-z])/g,zM=function(r,e,t){return r.length>0?e+t.toUpperCase():r},Pm=function(r){Ri(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s.src=i.currentSrc||i.src,s.intrinsicWidth=i.naturalWidth,s.intrinsicHeight=i.naturalHeight,s.context.cache.addImage(s.src),s}return e}(Gi),xm=function(r){Ri(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s.canvas=i,s.intrinsicWidth=i.width,s.intrinsicHeight=i.height,s}return e}(Gi),ym=function(r){Ri(e,r);function e(t,i){var s=r.call(this,t,i)||this,o=new XMLSerializer,a=Ua(t,i);return i.setAttribute("width",a.width+"px"),i.setAttribute("height",a.height+"px"),s.svg="data:image/svg+xml,"+encodeURIComponent(o.serializeToString(i)),s.intrinsicWidth=i.width.baseVal.value,s.intrinsicHeight=i.height.baseVal.value,s.context.cache.addImage(s.svg),s}return e}(Gi),bm=function(r){Ri(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s.value=i.value,s}return e}(Gi),qA=function(r){Ri(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s.start=i.start,s.reversed=typeof i.reversed=="boolean"&&i.reversed===!0,s}return e}(Gi),GM=[{type:15,flags:0,unit:"px",number:3}],WM=[{type:16,flags:0,number:50}],KM=function(r){return r.width>r.height?new As(r.left+(r.width-r.height)/2,r.top,r.height,r.height):r.width<r.height?new As(r.left,r.top+(r.height-r.width)/2,r.width,r.width):r},XM=function(r){var e=r.type===YM?new Array(r.value.length+1).join("•"):r.value;return e.length===0?r.placeholder||"":e},ba="checkbox",Ba="radio",YM="password",ip=707406591,_c=function(r){Ri(e,r);function e(t,i){var s=r.call(this,t,i)||this;switch(s.type=i.type.toLowerCase(),s.checked=i.checked,s.value=XM(i),(s.type===ba||s.type===Ba)&&(s.styles.backgroundColor=3739148031,s.styles.borderTopColor=s.styles.borderRightColor=s.styles.borderBottomColor=s.styles.borderLeftColor=2779096575,s.styles.borderTopWidth=s.styles.borderRightWidth=s.styles.borderBottomWidth=s.styles.borderLeftWidth=1,s.styles.borderTopStyle=s.styles.borderRightStyle=s.styles.borderBottomStyle=s.styles.borderLeftStyle=1,s.styles.backgroundClip=[0],s.styles.backgroundOrigin=[0],s.bounds=KM(s.bounds)),s.type){case ba:s.styles.borderTopRightRadius=s.styles.borderTopLeftRadius=s.styles.borderBottomRightRadius=s.styles.borderBottomLeftRadius=GM;break;case Ba:s.styles.borderTopRightRadius=s.styles.borderTopLeftRadius=s.styles.borderBottomRightRadius=s.styles.borderBottomLeftRadius=WM;break}return s}return e}(Gi),Bm=function(r){Ri(e,r);function e(t,i){var s=r.call(this,t,i)||this,o=i.options[i.selectedIndex||0];return s.value=o&&o.text||"",s}return e}(Gi),wm=function(r){Ri(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s.value=i.value,s}return e}(Gi),Cm=function(r){Ri(e,r);function e(t,i){var s=r.call(this,t,i)||this;s.src=i.src,s.width=parseInt(i.width,10)||0,s.height=parseInt(i.height,10)||0,s.backgroundColor=s.styles.backgroundColor;try{if(i.contentWindow&&i.contentWindow.document&&i.contentWindow.document.documentElement){s.tree=Em(t,i.contentWindow.document.documentElement);var o=i.contentWindow.document.documentElement?bo(t,getComputedStyle(i.contentWindow.document.documentElement).backgroundColor):ns.TRANSPARENT,a=i.contentWindow.document.body?bo(t,getComputedStyle(i.contentWindow.document.body).backgroundColor):ns.TRANSPARENT;s.backgroundColor=Cs(o)?Cs(a)?s.styles.backgroundColor:a:o}}catch{}return s}return e}(Gi),$M=["OL","UL","MENU"],ha=function(r,e,t,i){for(var s=e.firstChild,o=void 0;s;s=o)if(o=s.nextSibling,Im(s)&&s.data.trim().length>0)t.textNodes.push(new VM(r,s,t.styles));else if(yr(s))if(Dm(s)&&s.assignedNodes)s.assignedNodes().forEach(function(n){return ha(r,n,t,i)});else{var a=Mm(r,s);a.styles.isVisible()&&(ZM(s,a,i)?a.flags|=4:qM(a.styles)&&(a.flags|=2),$M.indexOf(s.tagName)!==-1&&(a.flags|=8),t.elements.push(a),s.slot,s.shadowRoot?ha(r,s.shadowRoot,a,i):!wa(s)&&!Fm(s)&&!Ca(s)&&ha(r,s,a,i))}},Mm=function(r,e){return ec(e)?new Pm(r,e):Sm(e)?new xm(r,e):Fm(e)?new ym(r,e):JM(e)?new bm(r,e):eE(e)?new qA(r,e):tE(e)?new _c(r,e):Ca(e)?new Bm(r,e):wa(e)?new wm(r,e):Tm(e)?new Cm(r,e):new Gi(r,e)},Em=function(r,e){var t=Mm(r,e);return t.flags|=4,ha(r,e,t,t),t},ZM=function(r,e,t){return e.styles.isPositionedWithZIndex()||e.styles.opacity<1||e.styles.isTransformed()||vc(r)&&t.styles.isTransparent()},qM=function(r){return r.isPositioned()||r.isFloating()},Im=function(r){return r.nodeType===Node.TEXT_NODE},yr=function(r){return r.nodeType===Node.ELEMENT_NODE},JA=function(r){return yr(r)&&typeof r.style<"u"&&!ua(r)},ua=function(r){return typeof r.className=="object"},JM=function(r){return r.tagName==="LI"},eE=function(r){return r.tagName==="OL"},tE=function(r){return r.tagName==="INPUT"},iE=function(r){return r.tagName==="HTML"},Fm=function(r){return r.tagName==="svg"},vc=function(r){return r.tagName==="BODY"},Sm=function(r){return r.tagName==="CANVAS"},sp=function(r){return r.tagName==="VIDEO"},ec=function(r){return r.tagName==="IMG"},Tm=function(r){return r.tagName==="IFRAME"},rp=function(r){return r.tagName==="STYLE"},sE=function(r){return r.tagName==="SCRIPT"},wa=function(r){return r.tagName==="TEXTAREA"},Ca=function(r){return r.tagName==="SELECT"},Dm=function(r){return r.tagName==="SLOT"},op=function(r){return r.tagName.indexOf("-")>0},rE=function(){function r(){this.counters={}}return r.prototype.getCounterValue=function(e){var t=this.counters[e];return t&&t.length?t[t.length-1]:1},r.prototype.getCounterValues=function(e){var t=this.counters[e];return t||[]},r.prototype.pop=function(e){var t=this;e.forEach(function(i){return t.counters[i].pop()})},r.prototype.parse=function(e){var t=this,i=e.counterIncrement,s=e.counterReset,o=!0;i!==null&&i.forEach(function(n){var l=t.counters[n.counter];l&&n.increment!==0&&(o=!1,l.length||l.push(1),l[Math.max(0,l.length-1)]+=n.increment)});var a=[];return o&&s.forEach(function(n){var l=t.counters[n.counter];a.push(n.counter),l||(l=t.counters[n.counter]=[]),l.push(n.reset)}),a},r}(),np={integers:[1e3,900,500,400,100,90,50,40,10,9,5,4,1],values:["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"]},ap={integers:[9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["Ք","Փ","Ւ","Ց","Ր","Տ","Վ","Ս","Ռ","Ջ","Պ","Չ","Ո","Շ","Ն","Յ","Մ","Ճ","Ղ","Ձ","Հ","Կ","Ծ","Խ","Լ","Ի","Ժ","Թ","Ը","Է","Զ","Ե","Դ","Գ","Բ","Ա"]},oE={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,400,300,200,100,90,80,70,60,50,40,30,20,19,18,17,16,15,10,9,8,7,6,5,4,3,2,1],values:["י׳","ט׳","ח׳","ז׳","ו׳","ה׳","ד׳","ג׳","ב׳","א׳","ת","ש","ר","ק","צ","פ","ע","ס","נ","מ","ל","כ","יט","יח","יז","טז","טו","י","ט","ח","ז","ו","ה","ד","ג","ב","א"]},nE={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["ჵ","ჰ","ჯ","ჴ","ხ","ჭ","წ","ძ","ც","ჩ","შ","ყ","ღ","ქ","ფ","ჳ","ტ","ს","რ","ჟ","პ","ო","ჲ","ნ","მ","ლ","კ","ი","თ","ჱ","ზ","ვ","ე","დ","გ","ბ","ა"]},hr=function(r,e,t,i,s,o){return r<e||r>t?To(r,s,o.length>0):i.integers.reduce(function(a,n,l){for(;r>=n;)r-=n,a+=i.values[l];return a},"")+o},Rm=function(r,e,t,i){var s="";do t||r--,s=i(r)+s,r/=e;while(r*e>=e);return s},Lt=function(r,e,t,i,s){var o=t-e+1;return(r<0?"-":"")+(Rm(Math.abs(r),o,i,function(a){return Ut(Math.floor(a%o)+e)})+s)},Us=function(r,e,t){t===void 0&&(t=". ");var i=e.length;return Rm(Math.abs(r),i,!1,function(s){return e[Math.floor(s%i)]})+t},vr=1,us=2,ds=4,_o=8,Ji=function(r,e,t,i,s,o){if(r<-9999||r>9999)return To(r,4,s.length>0);var a=Math.abs(r),n=s;if(a===0)return e[0]+n;for(var l=0;a>0&&l<=4;l++){var c=a%10;c===0&&Ht(o,vr)&&n!==""?n=e[c]+n:c>1||c===1&&l===0||c===1&&l===1&&Ht(o,us)||c===1&&l===1&&Ht(o,ds)&&r>100||c===1&&l>1&&Ht(o,_o)?n=e[c]+(l>0?t[l-1]:"")+n:c===1&&l>0&&(n=t[l-1]+n),a=Math.floor(a/10)}return(r<0?i:"")+n},lp="十百千萬",Ap="拾佰仟萬",cp="マイナス",cA="마이너스",To=function(r,e,t){var i=t?". ":"",s=t?"、":"",o=t?", ":"",a=t?" ":"";switch(e){case 0:return"•"+a;case 1:return"◦"+a;case 2:return"◾"+a;case 5:var n=Lt(r,48,57,!0,i);return n.length<4?"0"+n:n;case 4:return Us(r,"〇一二三四五六七八九",s);case 6:return hr(r,1,3999,np,3,i).toLowerCase();case 7:return hr(r,1,3999,np,3,i);case 8:return Lt(r,945,969,!1,i);case 9:return Lt(r,97,122,!1,i);case 10:return Lt(r,65,90,!1,i);case 11:return Lt(r,1632,1641,!0,i);case 12:case 49:return hr(r,1,9999,ap,3,i);case 35:return hr(r,1,9999,ap,3,i).toLowerCase();case 13:return Lt(r,2534,2543,!0,i);case 14:case 30:return Lt(r,6112,6121,!0,i);case 15:return Us(r,"子丑寅卯辰巳午未申酉戌亥",s);case 16:return Us(r,"甲乙丙丁戊己庚辛壬癸",s);case 17:case 48:return Ji(r,"零一二三四五六七八九",lp,"負",s,us|ds|_o);case 47:return Ji(r,"零壹貳參肆伍陸柒捌玖",Ap,"負",s,vr|us|ds|_o);case 42:return Ji(r,"零一二三四五六七八九",lp,"负",s,us|ds|_o);case 41:return Ji(r,"零壹贰叁肆伍陆柒捌玖",Ap,"负",s,vr|us|ds|_o);case 26:return Ji(r,"〇一二三四五六七八九","十百千万",cp,s,0);case 25:return Ji(r,"零壱弐参四伍六七八九","拾百千万",cp,s,vr|us|ds);case 31:return Ji(r,"영일이삼사오육칠팔구","십백천만",cA,o,vr|us|ds);case 33:return Ji(r,"零一二三四五六七八九","十百千萬",cA,o,0);case 32:return Ji(r,"零壹貳參四五六七八九","拾百千",cA,o,vr|us|ds);case 18:return Lt(r,2406,2415,!0,i);case 20:return hr(r,1,19999,nE,3,i);case 21:return Lt(r,2790,2799,!0,i);case 22:return Lt(r,2662,2671,!0,i);case 22:return hr(r,1,10999,oE,3,i);case 23:return Us(r,"あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわゐゑをん");case 24:return Us(r,"いろはにほへとちりぬるをわかよたれそつねならむうゐのおくやまけふこえてあさきゆめみしゑひもせす");case 27:return Lt(r,3302,3311,!0,i);case 28:return Us(r,"アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヰヱヲン",s);case 29:return Us(r,"イロハニホヘトチリヌルヲワカヨタレソツネナラムウヰノオクヤマケフコエテアサキユメミシヱヒモセス",s);case 34:return Lt(r,3792,3801,!0,i);case 37:return Lt(r,6160,6169,!0,i);case 38:return Lt(r,4160,4169,!0,i);case 39:return Lt(r,2918,2927,!0,i);case 40:return Lt(r,1776,1785,!0,i);case 43:return Lt(r,3046,3055,!0,i);case 44:return Lt(r,3174,3183,!0,i);case 45:return Lt(r,3664,3673,!0,i);case 46:return Lt(r,3872,3881,!0,i);case 3:default:return Lt(r,48,57,!0,i)}},Lm="data-html2canvas-ignore",hp=function(){function r(e,t,i){if(this.context=e,this.options=i,this.scrolledElements=[],this.referenceElement=t,this.counters=new rE,this.quoteDepth=0,!t.ownerDocument)throw new Error("Cloned element does not have an owner document");this.documentElement=this.cloneNode(t.ownerDocument.documentElement,!1)}return r.prototype.toIFrame=function(e,t){var i=this,s=aE(e,t);if(!s.contentWindow)return Promise.reject("Unable to find iframe window");var o=e.defaultView.pageXOffset,a=e.defaultView.pageYOffset,n=s.contentWindow,l=n.document,c=cE(s).then(function(){return Ai(i,void 0,void 0,function(){var h,d;return ii(this,function(p){switch(p.label){case 0:return this.scrolledElements.forEach(pE),n&&(n.scrollTo(t.left,t.top),/(iPad|iPhone|iPod)/g.test(navigator.userAgent)&&(n.scrollY!==t.top||n.scrollX!==t.left)&&(this.context.logger.warn("Unable to restore scroll position for cloned document"),this.context.windowBounds=this.context.windowBounds.add(n.scrollX-t.left,n.scrollY-t.top,0,0))),h=this.options.onclone,d=this.clonedReferenceElement,typeof d>"u"?[2,Promise.reject("Error finding the "+this.referenceElement.nodeName+" in the cloned document")]:l.fonts&&l.fonts.ready?[4,l.fonts.ready]:[3,2];case 1:p.sent(),p.label=2;case 2:return/(AppleWebKit)/g.test(navigator.userAgent)?[4,AE(l)]:[3,4];case 3:p.sent(),p.label=4;case 4:return typeof h=="function"?[2,Promise.resolve().then(function(){return h(l,d)}).then(function(){return s})]:[2,s]}})})});return l.open(),l.write(uE(document.doctype)+"<html></html>"),dE(this.referenceElement.ownerDocument,o,a),l.replaceChild(l.adoptNode(this.documentElement),l.documentElement),l.close(),c},r.prototype.createElementClone=function(e){if($A(e,2))debugger;if(Sm(e))return this.createCanvasClone(e);if(sp(e))return this.createVideoClone(e);if(rp(e))return this.createStyleClone(e);var t=e.cloneNode(!1);return ec(t)&&(ec(e)&&e.currentSrc&&e.currentSrc!==e.src&&(t.src=e.currentSrc,t.srcset=""),t.loading==="lazy"&&(t.loading="eager")),op(t)?this.createCustomElementClone(t):t},r.prototype.createCustomElementClone=function(e){var t=document.createElement("html2canvascustomelement");return hA(e.style,t),t},r.prototype.createStyleClone=function(e){try{var t=e.sheet;if(t&&t.cssRules){var i=[].slice.call(t.cssRules,0).reduce(function(o,a){return a&&typeof a.cssText=="string"?o+a.cssText:o},""),s=e.cloneNode(!1);return s.textContent=i,s}}catch(o){if(this.context.logger.error("Unable to access cssRules property",o),o.name!=="SecurityError")throw o}return e.cloneNode(!1)},r.prototype.createCanvasClone=function(e){var t;if(this.options.inlineImages&&e.ownerDocument){var i=e.ownerDocument.createElement("img");try{return i.src=e.toDataURL(),i}catch{this.context.logger.info("Unable to inline canvas contents, canvas is tainted",e)}}var s=e.cloneNode(!1);try{s.width=e.width,s.height=e.height;var o=e.getContext("2d"),a=s.getContext("2d");if(a)if(!this.options.allowTaint&&o)a.putImageData(o.getImageData(0,0,e.width,e.height),0,0);else{var n=(t=e.getContext("webgl2"))!==null&&t!==void 0?t:e.getContext("webgl");if(n){var l=n.getContextAttributes();(l==null?void 0:l.preserveDrawingBuffer)===!1&&this.context.logger.warn("Unable to clone WebGL context as it has preserveDrawingBuffer=false",e)}a.drawImage(e,0,0)}return s}catch{this.context.logger.info("Unable to clone canvas as it is tainted",e)}return s},r.prototype.createVideoClone=function(e){var t=e.ownerDocument.createElement("canvas");t.width=e.offsetWidth,t.height=e.offsetHeight;var i=t.getContext("2d");try{return i&&(i.drawImage(e,0,0,t.width,t.height),this.options.allowTaint||i.getImageData(0,0,t.width,t.height)),t}catch{this.context.logger.info("Unable to clone video as it is tainted",e)}var s=e.ownerDocument.createElement("canvas");return s.width=e.offsetWidth,s.height=e.offsetHeight,s},r.prototype.appendChildNode=function(e,t,i){(!yr(t)||!sE(t)&&!t.hasAttribute(Lm)&&(typeof this.options.ignoreElements!="function"||!this.options.ignoreElements(t)))&&(!this.options.copyStyles||!yr(t)||!rp(t))&&e.appendChild(this.cloneNode(t,i))},r.prototype.cloneChildNodes=function(e,t,i){for(var s=this,o=e.shadowRoot?e.shadowRoot.firstChild:e.firstChild;o;o=o.nextSibling)if(yr(o)&&Dm(o)&&typeof o.assignedNodes=="function"){var a=o.assignedNodes();a.length&&a.forEach(function(n){return s.appendChildNode(t,n,i)})}else this.appendChildNode(t,o,i)},r.prototype.cloneNode=function(e,t){if(Im(e))return document.createTextNode(e.data);if(!e.ownerDocument)return e.cloneNode(!1);var i=e.ownerDocument.defaultView;if(i&&yr(e)&&(JA(e)||ua(e))){var s=this.createElementClone(e);s.style.transitionProperty="none";var o=i.getComputedStyle(e),a=i.getComputedStyle(e,":before"),n=i.getComputedStyle(e,":after");this.referenceElement===e&&JA(s)&&(this.clonedReferenceElement=s),vc(s)&&gE(s);var l=this.counters.parse(new Hd(this.context,o)),c=this.resolvePseudoContent(e,s,a,Co.BEFORE);op(e)&&(t=!0),sp(e)||this.cloneChildNodes(e,s,t),c&&s.insertBefore(c,s.firstChild);var h=this.resolvePseudoContent(e,s,n,Co.AFTER);return h&&s.appendChild(h),this.counters.pop(l),(o&&(this.options.copyStyles||ua(e))&&!Tm(e)||t)&&hA(o,s),(e.scrollTop!==0||e.scrollLeft!==0)&&this.scrolledElements.push([s,e.scrollLeft,e.scrollTop]),(wa(e)||Ca(e))&&(wa(s)||Ca(s))&&(s.value=e.value),s}return e.cloneNode(!1)},r.prototype.resolvePseudoContent=function(e,t,i,s){var o=this;if(i){var a=i.content,n=t.ownerDocument;if(!(!n||!a||a==="none"||a==="-moz-alt-content"||i.display==="none")){this.counters.parse(new Hd(this.context,i));var l=new J1(this.context,i),c=n.createElement("html2canvaspseudoelement");hA(i,c),l.content.forEach(function(d){if(d.type===0)c.appendChild(n.createTextNode(d.value));else if(d.type===22){var p=n.createElement("img");p.src=d.value,p.style.opacity="1",c.appendChild(p)}else if(d.type===18){if(d.name==="attr"){var m=d.values.filter(bt);m.length&&c.appendChild(n.createTextNode(e.getAttribute(m[0].value)||""))}else if(d.name==="counter"){var g=d.values.filter(Fr),u=g[0],x=g[1];if(u&&bt(u)){var y=o.counters.getCounterValue(u.value),P=x&&bt(x)?YA.parse(o.context,x.value):3;c.appendChild(n.createTextNode(To(y,P,!1)))}}else if(d.name==="counters"){var _=d.values.filter(Fr),u=_[0],b=_[1],x=_[2];if(u&&bt(u)){var B=o.counters.getCounterValues(u.value),w=x&&bt(x)?YA.parse(o.context,x.value):3,C=b&&b.type===0?b.value:"",E=B.map(function(F){return To(F,w,!1)}).join(C);c.appendChild(n.createTextNode(E))}}}else if(d.type===20)switch(d.value){case"open-quote":c.appendChild(n.createTextNode(Vd(l.quotes,o.quoteDepth++,!0)));break;case"close-quote":c.appendChild(n.createTextNode(Vd(l.quotes,--o.quoteDepth,!1)));break;default:c.appendChild(n.createTextNode(d.value))}}),c.className=tc+" "+ic;var h=s===Co.BEFORE?" "+tc:" "+ic;return ua(t)?t.className.baseValue+=h:t.className+=h,c}}},r.destroy=function(e){return e.parentNode?(e.parentNode.removeChild(e),!0):!1},r}(),Co;(function(r){r[r.BEFORE=0]="BEFORE",r[r.AFTER=1]="AFTER"})(Co||(Co={}));var aE=function(r,e){var t=r.createElement("iframe");return t.className="html2canvas-container",t.style.visibility="hidden",t.style.position="fixed",t.style.left="-10000px",t.style.top="0px",t.style.border="0",t.width=e.width.toString(),t.height=e.height.toString(),t.scrolling="no",t.setAttribute(Lm,"true"),r.body.appendChild(t),t},lE=function(r){return new Promise(function(e){if(r.complete){e();return}if(!r.src){e();return}r.onload=e,r.onerror=e})},AE=function(r){return Promise.all([].slice.call(r.images,0).map(lE))},cE=function(r){return new Promise(function(e,t){var i=r.contentWindow;if(!i)return t("No window assigned for iframe");var s=i.document;i.onload=r.onload=function(){i.onload=r.onload=null;var o=setInterval(function(){s.body.childNodes.length>0&&s.readyState==="complete"&&(clearInterval(o),e(r))},50)}})},hE=["all","d","content"],hA=function(r,e){for(var t=r.length-1;t>=0;t--){var i=r.item(t);hE.indexOf(i)===-1&&e.style.setProperty(i,r.getPropertyValue(i))}return e},uE=function(r){var e="";return r&&(e+="<!DOCTYPE ",r.name&&(e+=r.name),r.internalSubset&&(e+=r.internalSubset),r.publicId&&(e+='"'+r.publicId+'"'),r.systemId&&(e+='"'+r.systemId+'"'),e+=">"),e},dE=function(r,e,t){r&&r.defaultView&&(e!==r.defaultView.pageXOffset||t!==r.defaultView.pageYOffset)&&r.defaultView.scrollTo(e,t)},pE=function(r){var e=r[0],t=r[1],i=r[2];e.scrollLeft=t,e.scrollTop=i},fE=":before",mE=":after",tc="___html2canvas___pseudoelement_before",ic="___html2canvas___pseudoelement_after",up=`{
    content: "" !important;
    display: none !important;
}`,gE=function(r){_E(r,"."+tc+fE+up+`
         .`+ic+mE+up)},_E=function(r,e){var t=r.ownerDocument;if(t){var i=t.createElement("style");i.textContent=e,r.appendChild(i)}},Um=function(){function r(){}return r.getOrigin=function(e){var t=r._link;return t?(t.href=e,t.href=t.href,t.protocol+t.hostname+t.port):"about:blank"},r.isSameOrigin=function(e){return r.getOrigin(e)===r._origin},r.setContext=function(e){r._link=e.document.createElement("a"),r._origin=r.getOrigin(e.location.href)},r._origin="about:blank",r}(),vE=function(){function r(e,t){this.context=e,this._options=t,this._cache={}}return r.prototype.addImage=function(e){var t=Promise.resolve();return this.has(e)||(dA(e)||bE(e))&&(this._cache[e]=this.loadImage(e)).catch(function(){}),t},r.prototype.match=function(e){return this._cache[e]},r.prototype.loadImage=function(e){return Ai(this,void 0,void 0,function(){var t,i,s,o,a=this;return ii(this,function(n){switch(n.label){case 0:return t=Um.isSameOrigin(e),i=!uA(e)&&this._options.useCORS===!0&&Zt.SUPPORT_CORS_IMAGES&&!t,s=!uA(e)&&!t&&!dA(e)&&typeof this._options.proxy=="string"&&Zt.SUPPORT_CORS_XHR&&!i,!t&&this._options.allowTaint===!1&&!uA(e)&&!dA(e)&&!s&&!i?[2]:(o=e,s?[4,this.proxy(o)]:[3,2]);case 1:o=n.sent(),n.label=2;case 2:return this.context.logger.debug("Added image "+e.substring(0,256)),[4,new Promise(function(l,c){var h=new Image;h.onload=function(){return l(h)},h.onerror=c,(BE(o)||i)&&(h.crossOrigin="anonymous"),h.src=o,h.complete===!0&&setTimeout(function(){return l(h)},500),a._options.imageTimeout>0&&setTimeout(function(){return c("Timed out ("+a._options.imageTimeout+"ms) loading image")},a._options.imageTimeout)})];case 3:return[2,n.sent()]}})})},r.prototype.has=function(e){return typeof this._cache[e]<"u"},r.prototype.keys=function(){return Promise.resolve(Object.keys(this._cache))},r.prototype.proxy=function(e){var t=this,i=this._options.proxy;if(!i)throw new Error("No proxy defined");var s=e.substring(0,256);return new Promise(function(o,a){var n=Zt.SUPPORT_RESPONSE_TYPE?"blob":"text",l=new XMLHttpRequest;l.onload=function(){if(l.status===200)if(n==="text")o(l.response);else{var d=new FileReader;d.addEventListener("load",function(){return o(d.result)},!1),d.addEventListener("error",function(p){return a(p)},!1),d.readAsDataURL(l.response)}else a("Failed to proxy resource "+s+" with status code "+l.status)},l.onerror=a;var c=i.indexOf("?")>-1?"&":"?";if(l.open("GET",""+i+c+"url="+encodeURIComponent(e)+"&responseType="+n),n!=="text"&&l instanceof XMLHttpRequest&&(l.responseType=n),t._options.imageTimeout){var h=t._options.imageTimeout;l.timeout=h,l.ontimeout=function(){return a("Timed out ("+h+"ms) proxying "+s)}}l.send()})},r}(),PE=/^data:image\/svg\+xml/i,xE=/^data:image\/.*;base64,/i,yE=/^data:image\/.*/i,bE=function(r){return Zt.SUPPORT_SVG_DRAWING||!wE(r)},uA=function(r){return yE.test(r)},BE=function(r){return xE.test(r)},dA=function(r){return r.substr(0,4)==="blob"},wE=function(r){return r.substr(-3).toLowerCase()==="svg"||PE.test(r)},ke=function(){function r(e,t){this.type=0,this.x=e,this.y=t}return r.prototype.add=function(e,t){return new r(this.x+e,this.y+t)},r}(),ur=function(r,e,t){return new ke(r.x+(e.x-r.x)*t,r.y+(e.y-r.y)*t)},qn=function(){function r(e,t,i,s){this.type=1,this.start=e,this.startControl=t,this.endControl=i,this.end=s}return r.prototype.subdivide=function(e,t){var i=ur(this.start,this.startControl,e),s=ur(this.startControl,this.endControl,e),o=ur(this.endControl,this.end,e),a=ur(i,s,e),n=ur(s,o,e),l=ur(a,n,e);return t?new r(this.start,i,a,l):new r(l,n,o,this.end)},r.prototype.add=function(e,t){return new r(this.start.add(e,t),this.startControl.add(e,t),this.endControl.add(e,t),this.end.add(e,t))},r.prototype.reverse=function(){return new r(this.end,this.endControl,this.startControl,this.start)},r}(),Mi=function(r){return r.type===1},CE=function(){function r(e){var t=e.styles,i=e.bounds,s=mo(t.borderTopLeftRadius,i.width,i.height),o=s[0],a=s[1],n=mo(t.borderTopRightRadius,i.width,i.height),l=n[0],c=n[1],h=mo(t.borderBottomRightRadius,i.width,i.height),d=h[0],p=h[1],m=mo(t.borderBottomLeftRadius,i.width,i.height),g=m[0],u=m[1],x=[];x.push((o+l)/i.width),x.push((g+d)/i.width),x.push((a+u)/i.height),x.push((c+p)/i.height);var y=Math.max.apply(Math,x);y>1&&(o/=y,a/=y,l/=y,c/=y,d/=y,p/=y,g/=y,u/=y);var P=i.width-l,_=i.height-p,b=i.width-d,B=i.height-u,w=t.borderTopWidth,C=t.borderRightWidth,E=t.borderBottomWidth,I=t.borderLeftWidth,R=Ct(t.paddingTop,e.bounds.width),F=Ct(t.paddingRight,e.bounds.width),z=Ct(t.paddingBottom,e.bounds.width),Q=Ct(t.paddingLeft,e.bounds.width);this.topLeftBorderDoubleOuterBox=o>0||a>0?St(i.left+I/3,i.top+w/3,o-I/3,a-w/3,xt.TOP_LEFT):new ke(i.left+I/3,i.top+w/3),this.topRightBorderDoubleOuterBox=o>0||a>0?St(i.left+P,i.top+w/3,l-C/3,c-w/3,xt.TOP_RIGHT):new ke(i.left+i.width-C/3,i.top+w/3),this.bottomRightBorderDoubleOuterBox=d>0||p>0?St(i.left+b,i.top+_,d-C/3,p-E/3,xt.BOTTOM_RIGHT):new ke(i.left+i.width-C/3,i.top+i.height-E/3),this.bottomLeftBorderDoubleOuterBox=g>0||u>0?St(i.left+I/3,i.top+B,g-I/3,u-E/3,xt.BOTTOM_LEFT):new ke(i.left+I/3,i.top+i.height-E/3),this.topLeftBorderDoubleInnerBox=o>0||a>0?St(i.left+I*2/3,i.top+w*2/3,o-I*2/3,a-w*2/3,xt.TOP_LEFT):new ke(i.left+I*2/3,i.top+w*2/3),this.topRightBorderDoubleInnerBox=o>0||a>0?St(i.left+P,i.top+w*2/3,l-C*2/3,c-w*2/3,xt.TOP_RIGHT):new ke(i.left+i.width-C*2/3,i.top+w*2/3),this.bottomRightBorderDoubleInnerBox=d>0||p>0?St(i.left+b,i.top+_,d-C*2/3,p-E*2/3,xt.BOTTOM_RIGHT):new ke(i.left+i.width-C*2/3,i.top+i.height-E*2/3),this.bottomLeftBorderDoubleInnerBox=g>0||u>0?St(i.left+I*2/3,i.top+B,g-I*2/3,u-E*2/3,xt.BOTTOM_LEFT):new ke(i.left+I*2/3,i.top+i.height-E*2/3),this.topLeftBorderStroke=o>0||a>0?St(i.left+I/2,i.top+w/2,o-I/2,a-w/2,xt.TOP_LEFT):new ke(i.left+I/2,i.top+w/2),this.topRightBorderStroke=o>0||a>0?St(i.left+P,i.top+w/2,l-C/2,c-w/2,xt.TOP_RIGHT):new ke(i.left+i.width-C/2,i.top+w/2),this.bottomRightBorderStroke=d>0||p>0?St(i.left+b,i.top+_,d-C/2,p-E/2,xt.BOTTOM_RIGHT):new ke(i.left+i.width-C/2,i.top+i.height-E/2),this.bottomLeftBorderStroke=g>0||u>0?St(i.left+I/2,i.top+B,g-I/2,u-E/2,xt.BOTTOM_LEFT):new ke(i.left+I/2,i.top+i.height-E/2),this.topLeftBorderBox=o>0||a>0?St(i.left,i.top,o,a,xt.TOP_LEFT):new ke(i.left,i.top),this.topRightBorderBox=l>0||c>0?St(i.left+P,i.top,l,c,xt.TOP_RIGHT):new ke(i.left+i.width,i.top),this.bottomRightBorderBox=d>0||p>0?St(i.left+b,i.top+_,d,p,xt.BOTTOM_RIGHT):new ke(i.left+i.width,i.top+i.height),this.bottomLeftBorderBox=g>0||u>0?St(i.left,i.top+B,g,u,xt.BOTTOM_LEFT):new ke(i.left,i.top+i.height),this.topLeftPaddingBox=o>0||a>0?St(i.left+I,i.top+w,Math.max(0,o-I),Math.max(0,a-w),xt.TOP_LEFT):new ke(i.left+I,i.top+w),this.topRightPaddingBox=l>0||c>0?St(i.left+Math.min(P,i.width-C),i.top+w,P>i.width+C?0:Math.max(0,l-C),Math.max(0,c-w),xt.TOP_RIGHT):new ke(i.left+i.width-C,i.top+w),this.bottomRightPaddingBox=d>0||p>0?St(i.left+Math.min(b,i.width-I),i.top+Math.min(_,i.height-E),Math.max(0,d-C),Math.max(0,p-E),xt.BOTTOM_RIGHT):new ke(i.left+i.width-C,i.top+i.height-E),this.bottomLeftPaddingBox=g>0||u>0?St(i.left+I,i.top+Math.min(B,i.height-E),Math.max(0,g-I),Math.max(0,u-E),xt.BOTTOM_LEFT):new ke(i.left+I,i.top+i.height-E),this.topLeftContentBox=o>0||a>0?St(i.left+I+Q,i.top+w+R,Math.max(0,o-(I+Q)),Math.max(0,a-(w+R)),xt.TOP_LEFT):new ke(i.left+I+Q,i.top+w+R),this.topRightContentBox=l>0||c>0?St(i.left+Math.min(P,i.width+I+Q),i.top+w+R,P>i.width+I+Q?0:l-I+Q,c-(w+R),xt.TOP_RIGHT):new ke(i.left+i.width-(C+F),i.top+w+R),this.bottomRightContentBox=d>0||p>0?St(i.left+Math.min(b,i.width-(I+Q)),i.top+Math.min(_,i.height+w+R),Math.max(0,d-(C+F)),p-(E+z),xt.BOTTOM_RIGHT):new ke(i.left+i.width-(C+F),i.top+i.height-(E+z)),this.bottomLeftContentBox=g>0||u>0?St(i.left+I+Q,i.top+B,Math.max(0,g-(I+Q)),u-(E+z),xt.BOTTOM_LEFT):new ke(i.left+I+Q,i.top+i.height-(E+z))}return r}(),xt;(function(r){r[r.TOP_LEFT=0]="TOP_LEFT",r[r.TOP_RIGHT=1]="TOP_RIGHT",r[r.BOTTOM_RIGHT=2]="BOTTOM_RIGHT",r[r.BOTTOM_LEFT=3]="BOTTOM_LEFT"})(xt||(xt={}));var St=function(r,e,t,i,s){var o=4*((Math.sqrt(2)-1)/3),a=t*o,n=i*o,l=r+t,c=e+i;switch(s){case xt.TOP_LEFT:return new qn(new ke(r,c),new ke(r,c-n),new ke(l-a,e),new ke(l,e));case xt.TOP_RIGHT:return new qn(new ke(r,e),new ke(r+a,e),new ke(l,c-n),new ke(l,c));case xt.BOTTOM_RIGHT:return new qn(new ke(l,e),new ke(l,e+n),new ke(r+a,c),new ke(r,c));case xt.BOTTOM_LEFT:default:return new qn(new ke(l,c),new ke(l-a,c),new ke(r,e+n),new ke(r,e))}},Ma=function(r){return[r.topLeftBorderBox,r.topRightBorderBox,r.bottomRightBorderBox,r.bottomLeftBorderBox]},ME=function(r){return[r.topLeftContentBox,r.topRightContentBox,r.bottomRightContentBox,r.bottomLeftContentBox]},Ea=function(r){return[r.topLeftPaddingBox,r.topRightPaddingBox,r.bottomRightPaddingBox,r.bottomLeftPaddingBox]},EE=function(){function r(e,t,i){this.offsetX=e,this.offsetY=t,this.matrix=i,this.type=0,this.target=6}return r}(),Jn=function(){function r(e,t){this.path=e,this.target=t,this.type=1}return r}(),IE=function(){function r(e){this.opacity=e,this.type=2,this.target=6}return r}(),FE=function(r){return r.type===0},Om=function(r){return r.type===1},SE=function(r){return r.type===2},dp=function(r,e){return r.length===e.length?r.some(function(t,i){return t===e[i]}):!1},TE=function(r,e,t,i,s){return r.map(function(o,a){switch(a){case 0:return o.add(e,t);case 1:return o.add(e+i,t);case 2:return o.add(e+i,t+s);case 3:return o.add(e,t+s)}return o})},km=function(){function r(e){this.element=e,this.inlineLevel=[],this.nonInlineLevel=[],this.negativeZIndex=[],this.zeroOrAutoZIndexOrTransformedOrOpacity=[],this.positiveZIndex=[],this.nonPositionedFloats=[],this.nonPositionedInlineLevel=[]}return r}(),Nm=function(){function r(e,t){if(this.container=e,this.parent=t,this.effects=[],this.curves=new CE(this.container),this.container.styles.opacity<1&&this.effects.push(new IE(this.container.styles.opacity)),this.container.styles.transform!==null){var i=this.container.bounds.left+this.container.styles.transformOrigin[0].number,s=this.container.bounds.top+this.container.styles.transformOrigin[1].number,o=this.container.styles.transform;this.effects.push(new EE(i,s,o))}if(this.container.styles.overflowX!==0){var a=Ma(this.curves),n=Ea(this.curves);dp(a,n)?this.effects.push(new Jn(a,6)):(this.effects.push(new Jn(a,2)),this.effects.push(new Jn(n,4)))}}return r.prototype.getEffects=function(e){for(var t=[2,3].indexOf(this.container.styles.position)===-1,i=this.parent,s=this.effects.slice(0);i;){var o=i.effects.filter(function(l){return!Om(l)});if(t||i.container.styles.position!==0||!i.parent){if(s.unshift.apply(s,o),t=[2,3].indexOf(i.container.styles.position)===-1,i.container.styles.overflowX!==0){var a=Ma(i.curves),n=Ea(i.curves);dp(a,n)||s.unshift(new Jn(n,6))}}else s.unshift.apply(s,o);i=i.parent}return s.filter(function(l){return Ht(l.target,e)})},r}(),sc=function(r,e,t,i){r.container.elements.forEach(function(s){var o=Ht(s.flags,4),a=Ht(s.flags,2),n=new Nm(s,r);Ht(s.styles.display,2048)&&i.push(n);var l=Ht(s.flags,8)?[]:i;if(o||a){var c=o||s.styles.isPositioned()?t:e,h=new km(n);if(s.styles.isPositioned()||s.styles.opacity<1||s.styles.isTransformed()){var d=s.styles.zIndex.order;if(d<0){var p=0;c.negativeZIndex.some(function(g,u){return d>g.element.container.styles.zIndex.order?(p=u,!1):p>0}),c.negativeZIndex.splice(p,0,h)}else if(d>0){var m=0;c.positiveZIndex.some(function(g,u){return d>=g.element.container.styles.zIndex.order?(m=u+1,!1):m>0}),c.positiveZIndex.splice(m,0,h)}else c.zeroOrAutoZIndexOrTransformedOrOpacity.push(h)}else s.styles.isFloating()?c.nonPositionedFloats.push(h):c.nonPositionedInlineLevel.push(h);sc(n,h,o?h:t,l)}else s.styles.isInlineLevel()?e.inlineLevel.push(n):e.nonInlineLevel.push(n),sc(n,e,t,l);Ht(s.flags,8)&&Qm(s,l)})},Qm=function(r,e){for(var t=r instanceof qA?r.start:1,i=r instanceof qA?r.reversed:!1,s=0;s<e.length;s++){var o=e[s];o.container instanceof bm&&typeof o.container.value=="number"&&o.container.value!==0&&(t=o.container.value),o.listValue=To(t,o.container.styles.listStyleType,!0),t+=i?-1:1}},DE=function(r){var e=new Nm(r,null),t=new km(e),i=[];return sc(e,t,t,i),Qm(e.container,i),t},pp=function(r,e){switch(e){case 0:return Ii(r.topLeftBorderBox,r.topLeftPaddingBox,r.topRightBorderBox,r.topRightPaddingBox);case 1:return Ii(r.topRightBorderBox,r.topRightPaddingBox,r.bottomRightBorderBox,r.bottomRightPaddingBox);case 2:return Ii(r.bottomRightBorderBox,r.bottomRightPaddingBox,r.bottomLeftBorderBox,r.bottomLeftPaddingBox);case 3:default:return Ii(r.bottomLeftBorderBox,r.bottomLeftPaddingBox,r.topLeftBorderBox,r.topLeftPaddingBox)}},RE=function(r,e){switch(e){case 0:return Ii(r.topLeftBorderBox,r.topLeftBorderDoubleOuterBox,r.topRightBorderBox,r.topRightBorderDoubleOuterBox);case 1:return Ii(r.topRightBorderBox,r.topRightBorderDoubleOuterBox,r.bottomRightBorderBox,r.bottomRightBorderDoubleOuterBox);case 2:return Ii(r.bottomRightBorderBox,r.bottomRightBorderDoubleOuterBox,r.bottomLeftBorderBox,r.bottomLeftBorderDoubleOuterBox);case 3:default:return Ii(r.bottomLeftBorderBox,r.bottomLeftBorderDoubleOuterBox,r.topLeftBorderBox,r.topLeftBorderDoubleOuterBox)}},LE=function(r,e){switch(e){case 0:return Ii(r.topLeftBorderDoubleInnerBox,r.topLeftPaddingBox,r.topRightBorderDoubleInnerBox,r.topRightPaddingBox);case 1:return Ii(r.topRightBorderDoubleInnerBox,r.topRightPaddingBox,r.bottomRightBorderDoubleInnerBox,r.bottomRightPaddingBox);case 2:return Ii(r.bottomRightBorderDoubleInnerBox,r.bottomRightPaddingBox,r.bottomLeftBorderDoubleInnerBox,r.bottomLeftPaddingBox);case 3:default:return Ii(r.bottomLeftBorderDoubleInnerBox,r.bottomLeftPaddingBox,r.topLeftBorderDoubleInnerBox,r.topLeftPaddingBox)}},UE=function(r,e){switch(e){case 0:return ea(r.topLeftBorderStroke,r.topRightBorderStroke);case 1:return ea(r.topRightBorderStroke,r.bottomRightBorderStroke);case 2:return ea(r.bottomRightBorderStroke,r.bottomLeftBorderStroke);case 3:default:return ea(r.bottomLeftBorderStroke,r.topLeftBorderStroke)}},ea=function(r,e){var t=[];return Mi(r)?t.push(r.subdivide(.5,!1)):t.push(r),Mi(e)?t.push(e.subdivide(.5,!0)):t.push(e),t},Ii=function(r,e,t,i){var s=[];return Mi(r)?s.push(r.subdivide(.5,!1)):s.push(r),Mi(t)?s.push(t.subdivide(.5,!0)):s.push(t),Mi(i)?s.push(i.subdivide(.5,!0).reverse()):s.push(i),Mi(e)?s.push(e.subdivide(.5,!1).reverse()):s.push(e),s},Vm=function(r){var e=r.bounds,t=r.styles;return e.add(t.borderLeftWidth,t.borderTopWidth,-(t.borderRightWidth+t.borderLeftWidth),-(t.borderTopWidth+t.borderBottomWidth))},Ia=function(r){var e=r.styles,t=r.bounds,i=Ct(e.paddingLeft,t.width),s=Ct(e.paddingRight,t.width),o=Ct(e.paddingTop,t.width),a=Ct(e.paddingBottom,t.width);return t.add(i+e.borderLeftWidth,o+e.borderTopWidth,-(e.borderRightWidth+e.borderLeftWidth+i+s),-(e.borderTopWidth+e.borderBottomWidth+o+a))},OE=function(r,e){return r===0?e.bounds:r===2?Ia(e):Vm(e)},kE=function(r,e){return r===0?e.bounds:r===2?Ia(e):Vm(e)},pA=function(r,e,t){var i=OE(Pr(r.styles.backgroundOrigin,e),r),s=kE(Pr(r.styles.backgroundClip,e),r),o=NE(Pr(r.styles.backgroundSize,e),t,i),a=o[0],n=o[1],l=mo(Pr(r.styles.backgroundPosition,e),i.width-a,i.height-n),c=QE(Pr(r.styles.backgroundRepeat,e),l,o,i,s),h=Math.round(i.left+l[0]),d=Math.round(i.top+l[1]);return[c,h,d,a,n]},dr=function(r){return bt(r)&&r.value===Mr.AUTO},ta=function(r){return typeof r=="number"},NE=function(r,e,t){var i=e[0],s=e[1],o=e[2],a=r[0],n=r[1];if(!a)return[0,0];if(Nt(a)&&n&&Nt(n))return[Ct(a,t.width),Ct(n,t.height)];var l=ta(o);if(bt(a)&&(a.value===Mr.CONTAIN||a.value===Mr.COVER)){if(ta(o)){var c=t.width/t.height;return c<o!=(a.value===Mr.COVER)?[t.width,t.width/o]:[t.height*o,t.height]}return[t.width,t.height]}var h=ta(i),d=ta(s),p=h||d;if(dr(a)&&(!n||dr(n))){if(h&&d)return[i,s];if(!l&&!p)return[t.width,t.height];if(p&&l){var m=h?i:s*o,g=d?s:i/o;return[m,g]}var u=h?i:t.width,x=d?s:t.height;return[u,x]}if(l){var y=0,P=0;return Nt(a)?y=Ct(a,t.width):Nt(n)&&(P=Ct(n,t.height)),dr(a)?y=P*o:(!n||dr(n))&&(P=y/o),[y,P]}var _=null,b=null;if(Nt(a)?_=Ct(a,t.width):n&&Nt(n)&&(b=Ct(n,t.height)),_!==null&&(!n||dr(n))&&(b=h&&d?_/i*s:t.height),b!==null&&dr(a)&&(_=h&&d?b/s*i:t.width),_!==null&&b!==null)return[_,b];throw new Error("Unable to calculate background-size for element")},Pr=function(r,e){var t=r[e];return typeof t>"u"?r[0]:t},QE=function(r,e,t,i,s){var o=e[0],a=e[1],n=t[0],l=t[1];switch(r){case 2:return[new ke(Math.round(i.left),Math.round(i.top+a)),new ke(Math.round(i.left+i.width),Math.round(i.top+a)),new ke(Math.round(i.left+i.width),Math.round(l+i.top+a)),new ke(Math.round(i.left),Math.round(l+i.top+a))];case 3:return[new ke(Math.round(i.left+o),Math.round(i.top)),new ke(Math.round(i.left+o+n),Math.round(i.top)),new ke(Math.round(i.left+o+n),Math.round(i.height+i.top)),new ke(Math.round(i.left+o),Math.round(i.height+i.top))];case 1:return[new ke(Math.round(i.left+o),Math.round(i.top+a)),new ke(Math.round(i.left+o+n),Math.round(i.top+a)),new ke(Math.round(i.left+o+n),Math.round(i.top+a+l)),new ke(Math.round(i.left+o),Math.round(i.top+a+l))];default:return[new ke(Math.round(s.left),Math.round(s.top)),new ke(Math.round(s.left+s.width),Math.round(s.top)),new ke(Math.round(s.left+s.width),Math.round(s.height+s.top)),new ke(Math.round(s.left),Math.round(s.height+s.top))]}},VE="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",fp="Hidden Text",HE=function(){function r(e){this._data={},this._document=e}return r.prototype.parseMetrics=function(e,t){var i=this._document.createElement("div"),s=this._document.createElement("img"),o=this._document.createElement("span"),a=this._document.body;i.style.visibility="hidden",i.style.fontFamily=e,i.style.fontSize=t,i.style.margin="0",i.style.padding="0",i.style.whiteSpace="nowrap",a.appendChild(i),s.src=VE,s.width=1,s.height=1,s.style.margin="0",s.style.padding="0",s.style.verticalAlign="baseline",o.style.fontFamily=e,o.style.fontSize=t,o.style.margin="0",o.style.padding="0",o.appendChild(this._document.createTextNode(fp)),i.appendChild(o),i.appendChild(s);var n=s.offsetTop-o.offsetTop+2;i.removeChild(o),i.appendChild(this._document.createTextNode(fp)),i.style.lineHeight="normal",s.style.verticalAlign="super";var l=s.offsetTop-i.offsetTop+2;return a.removeChild(i),{baseline:n,middle:l}},r.prototype.getMetrics=function(e,t){var i=e+" "+t;return typeof this._data[i]>"u"&&(this._data[i]=this.parseMetrics(e,t)),this._data[i]},r}(),Hm=function(){function r(e,t){this.context=e,this.options=t}return r}(),jE=1e4,zE=function(r){Ri(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s._activeEffects=[],s.canvas=i.canvas?i.canvas:document.createElement("canvas"),s.ctx=s.canvas.getContext("2d"),i.canvas||(s.canvas.width=Math.floor(i.width*i.scale),s.canvas.height=Math.floor(i.height*i.scale),s.canvas.style.width=i.width+"px",s.canvas.style.height=i.height+"px"),s.fontMetrics=new HE(document),s.ctx.scale(s.options.scale,s.options.scale),s.ctx.translate(-i.x,-i.y),s.ctx.textBaseline="bottom",s._activeEffects=[],s.context.logger.debug("Canvas renderer initialized ("+i.width+"x"+i.height+") with scale "+i.scale),s}return e.prototype.applyEffects=function(t){for(var i=this;this._activeEffects.length;)this.popEffect();t.forEach(function(s){return i.applyEffect(s)})},e.prototype.applyEffect=function(t){this.ctx.save(),SE(t)&&(this.ctx.globalAlpha=t.opacity),FE(t)&&(this.ctx.translate(t.offsetX,t.offsetY),this.ctx.transform(t.matrix[0],t.matrix[1],t.matrix[2],t.matrix[3],t.matrix[4],t.matrix[5]),this.ctx.translate(-t.offsetX,-t.offsetY)),Om(t)&&(this.path(t.path),this.ctx.clip()),this._activeEffects.push(t)},e.prototype.popEffect=function(){this._activeEffects.pop(),this.ctx.restore()},e.prototype.renderStack=function(t){return Ai(this,void 0,void 0,function(){var i;return ii(this,function(s){switch(s.label){case 0:return i=t.element.container.styles,i.isVisible()?[4,this.renderStackContent(t)]:[3,2];case 1:s.sent(),s.label=2;case 2:return[2]}})})},e.prototype.renderNode=function(t){return Ai(this,void 0,void 0,function(){return ii(this,function(i){switch(i.label){case 0:if(Ht(t.container.flags,16))debugger;return t.container.styles.isVisible()?[4,this.renderNodeBackgroundAndBorders(t)]:[3,3];case 1:return i.sent(),[4,this.renderNodeContent(t)];case 2:i.sent(),i.label=3;case 3:return[2]}})})},e.prototype.renderTextWithLetterSpacing=function(t,i,s){var o=this;if(i===0)this.ctx.fillText(t.text,t.bounds.left,t.bounds.top+s);else{var a=gc(t.text);a.reduce(function(n,l){return o.ctx.fillText(l,n,t.bounds.top+s),n+o.ctx.measureText(l).width},t.bounds.left)}},e.prototype.createFontStyle=function(t){var i=t.fontVariant.filter(function(a){return a==="normal"||a==="small-caps"}).join(""),s=YE(t.fontFamily).join(", "),o=ko(t.fontSize)?""+t.fontSize.number+t.fontSize.unit:t.fontSize.number+"px";return[[t.fontStyle,i,t.fontWeight,o,s].join(" "),s,o]},e.prototype.renderTextNode=function(t,i){return Ai(this,void 0,void 0,function(){var s,o,a,n,l,c,h,d,p=this;return ii(this,function(m){return s=this.createFontStyle(i),o=s[0],a=s[1],n=s[2],this.ctx.font=o,this.ctx.direction=i.direction===1?"rtl":"ltr",this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic",l=this.fontMetrics.getMetrics(a,n),c=l.baseline,h=l.middle,d=i.paintOrder,t.textBounds.forEach(function(g){d.forEach(function(u){switch(u){case 0:p.ctx.fillStyle=zt(i.color),p.renderTextWithLetterSpacing(g,i.letterSpacing,c);var x=i.textShadow;x.length&&g.text.trim().length&&(x.slice(0).reverse().forEach(function(y){p.ctx.shadowColor=zt(y.color),p.ctx.shadowOffsetX=y.offsetX.number*p.options.scale,p.ctx.shadowOffsetY=y.offsetY.number*p.options.scale,p.ctx.shadowBlur=y.blur.number,p.renderTextWithLetterSpacing(g,i.letterSpacing,c)}),p.ctx.shadowColor="",p.ctx.shadowOffsetX=0,p.ctx.shadowOffsetY=0,p.ctx.shadowBlur=0),i.textDecorationLine.length&&(p.ctx.fillStyle=zt(i.textDecorationColor||i.color),i.textDecorationLine.forEach(function(y){switch(y){case 1:p.ctx.fillRect(g.bounds.left,Math.round(g.bounds.top+c),g.bounds.width,1);break;case 2:p.ctx.fillRect(g.bounds.left,Math.round(g.bounds.top),g.bounds.width,1);break;case 3:p.ctx.fillRect(g.bounds.left,Math.ceil(g.bounds.top+h),g.bounds.width,1);break}}));break;case 1:i.webkitTextStrokeWidth&&g.text.trim().length&&(p.ctx.strokeStyle=zt(i.webkitTextStrokeColor),p.ctx.lineWidth=i.webkitTextStrokeWidth,p.ctx.lineJoin=window.chrome?"miter":"round",p.ctx.strokeText(g.text,g.bounds.left,g.bounds.top+c)),p.ctx.strokeStyle="",p.ctx.lineWidth=0,p.ctx.lineJoin="miter";break}})}),[2]})})},e.prototype.renderReplacedElement=function(t,i,s){if(s&&t.intrinsicWidth>0&&t.intrinsicHeight>0){var o=Ia(t),a=Ea(i);this.path(a),this.ctx.save(),this.ctx.clip(),this.ctx.drawImage(s,0,0,t.intrinsicWidth,t.intrinsicHeight,o.left,o.top,o.width,o.height),this.ctx.restore()}},e.prototype.renderNodeContent=function(t){return Ai(this,void 0,void 0,function(){var i,s,o,a,n,l,P,P,c,h,d,p,b,m,g,B,u,x,y,P,_,b,B;return ii(this,function(w){switch(w.label){case 0:this.applyEffects(t.getEffects(4)),i=t.container,s=t.curves,o=i.styles,a=0,n=i.textNodes,w.label=1;case 1:return a<n.length?(l=n[a],[4,this.renderTextNode(l,o)]):[3,4];case 2:w.sent(),w.label=3;case 3:return a++,[3,1];case 4:if(!(i instanceof Pm))return[3,8];w.label=5;case 5:return w.trys.push([5,7,,8]),[4,this.context.cache.match(i.src)];case 6:return P=w.sent(),this.renderReplacedElement(i,s,P),[3,8];case 7:return w.sent(),this.context.logger.error("Error loading image "+i.src),[3,8];case 8:if(i instanceof xm&&this.renderReplacedElement(i,s,i.canvas),!(i instanceof ym))return[3,12];w.label=9;case 9:return w.trys.push([9,11,,12]),[4,this.context.cache.match(i.svg)];case 10:return P=w.sent(),this.renderReplacedElement(i,s,P),[3,12];case 11:return w.sent(),this.context.logger.error("Error loading svg "+i.svg.substring(0,255)),[3,12];case 12:return i instanceof Cm&&i.tree?(c=new e(this.context,{scale:this.options.scale,backgroundColor:i.backgroundColor,x:0,y:0,width:i.width,height:i.height}),[4,c.render(i.tree)]):[3,14];case 13:h=w.sent(),i.width&&i.height&&this.ctx.drawImage(h,0,0,i.width,i.height,i.bounds.left,i.bounds.top,i.bounds.width,i.bounds.height),w.label=14;case 14:if(i instanceof _c&&(d=Math.min(i.bounds.width,i.bounds.height),i.type===ba?i.checked&&(this.ctx.save(),this.path([new ke(i.bounds.left+d*.39363,i.bounds.top+d*.79),new ke(i.bounds.left+d*.16,i.bounds.top+d*.5549),new ke(i.bounds.left+d*.27347,i.bounds.top+d*.44071),new ke(i.bounds.left+d*.39694,i.bounds.top+d*.5649),new ke(i.bounds.left+d*.72983,i.bounds.top+d*.23),new ke(i.bounds.left+d*.84,i.bounds.top+d*.34085),new ke(i.bounds.left+d*.39363,i.bounds.top+d*.79)]),this.ctx.fillStyle=zt(ip),this.ctx.fill(),this.ctx.restore()):i.type===Ba&&i.checked&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i.bounds.left+d/2,i.bounds.top+d/2,d/4,0,Math.PI*2,!0),this.ctx.fillStyle=zt(ip),this.ctx.fill(),this.ctx.restore())),GE(i)&&i.value.length){switch(p=this.createFontStyle(o),b=p[0],m=p[1],g=this.fontMetrics.getMetrics(b,m).baseline,this.ctx.font=b,this.ctx.fillStyle=zt(o.color),this.ctx.textBaseline="alphabetic",this.ctx.textAlign=KE(i.styles.textAlign),B=Ia(i),u=0,i.styles.textAlign){case 1:u+=B.width/2;break;case 2:u+=B.width;break}x=B.add(u,0,0,-B.height/2+1),this.ctx.save(),this.path([new ke(B.left,B.top),new ke(B.left+B.width,B.top),new ke(B.left+B.width,B.top+B.height),new ke(B.left,B.top+B.height)]),this.ctx.clip(),this.renderTextWithLetterSpacing(new wo(i.value,x),o.letterSpacing,g),this.ctx.restore(),this.ctx.textBaseline="alphabetic",this.ctx.textAlign="left"}if(!Ht(i.styles.display,2048))return[3,20];if(i.styles.listStyleImage===null)return[3,19];if(y=i.styles.listStyleImage,y.type!==0)return[3,18];P=void 0,_=y.url,w.label=15;case 15:return w.trys.push([15,17,,18]),[4,this.context.cache.match(_)];case 16:return P=w.sent(),this.ctx.drawImage(P,i.bounds.left-(P.width+10),i.bounds.top),[3,18];case 17:return w.sent(),this.context.logger.error("Error loading list-style-image "+_),[3,18];case 18:return[3,20];case 19:t.listValue&&i.styles.listStyleType!==-1&&(b=this.createFontStyle(o)[0],this.ctx.font=b,this.ctx.fillStyle=zt(o.color),this.ctx.textBaseline="middle",this.ctx.textAlign="right",B=new As(i.bounds.left,i.bounds.top+Ct(i.styles.paddingTop,i.bounds.width),i.bounds.width,Nd(o.lineHeight,o.fontSize.number)/2+1),this.renderTextWithLetterSpacing(new wo(t.listValue,B),o.letterSpacing,Nd(o.lineHeight,o.fontSize.number)/2+2),this.ctx.textBaseline="bottom",this.ctx.textAlign="left"),w.label=20;case 20:return[2]}})})},e.prototype.renderStackContent=function(t){return Ai(this,void 0,void 0,function(){var i,s,y,o,a,y,n,l,y,c,h,y,d,p,y,m,g,y,u,x,y;return ii(this,function(P){switch(P.label){case 0:if(Ht(t.element.container.flags,16))debugger;return[4,this.renderNodeBackgroundAndBorders(t.element)];case 1:P.sent(),i=0,s=t.negativeZIndex,P.label=2;case 2:return i<s.length?(y=s[i],[4,this.renderStack(y)]):[3,5];case 3:P.sent(),P.label=4;case 4:return i++,[3,2];case 5:return[4,this.renderNodeContent(t.element)];case 6:P.sent(),o=0,a=t.nonInlineLevel,P.label=7;case 7:return o<a.length?(y=a[o],[4,this.renderNode(y)]):[3,10];case 8:P.sent(),P.label=9;case 9:return o++,[3,7];case 10:n=0,l=t.nonPositionedFloats,P.label=11;case 11:return n<l.length?(y=l[n],[4,this.renderStack(y)]):[3,14];case 12:P.sent(),P.label=13;case 13:return n++,[3,11];case 14:c=0,h=t.nonPositionedInlineLevel,P.label=15;case 15:return c<h.length?(y=h[c],[4,this.renderStack(y)]):[3,18];case 16:P.sent(),P.label=17;case 17:return c++,[3,15];case 18:d=0,p=t.inlineLevel,P.label=19;case 19:return d<p.length?(y=p[d],[4,this.renderNode(y)]):[3,22];case 20:P.sent(),P.label=21;case 21:return d++,[3,19];case 22:m=0,g=t.zeroOrAutoZIndexOrTransformedOrOpacity,P.label=23;case 23:return m<g.length?(y=g[m],[4,this.renderStack(y)]):[3,26];case 24:P.sent(),P.label=25;case 25:return m++,[3,23];case 26:u=0,x=t.positiveZIndex,P.label=27;case 27:return u<x.length?(y=x[u],[4,this.renderStack(y)]):[3,30];case 28:P.sent(),P.label=29;case 29:return u++,[3,27];case 30:return[2]}})})},e.prototype.mask=function(t){this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(this.canvas.width,0),this.ctx.lineTo(this.canvas.width,this.canvas.height),this.ctx.lineTo(0,this.canvas.height),this.ctx.lineTo(0,0),this.formatPath(t.slice(0).reverse()),this.ctx.closePath()},e.prototype.path=function(t){this.ctx.beginPath(),this.formatPath(t),this.ctx.closePath()},e.prototype.formatPath=function(t){var i=this;t.forEach(function(s,o){var a=Mi(s)?s.start:s;o===0?i.ctx.moveTo(a.x,a.y):i.ctx.lineTo(a.x,a.y),Mi(s)&&i.ctx.bezierCurveTo(s.startControl.x,s.startControl.y,s.endControl.x,s.endControl.y,s.end.x,s.end.y)})},e.prototype.renderRepeat=function(t,i,s,o){this.path(t),this.ctx.fillStyle=i,this.ctx.translate(s,o),this.ctx.fill(),this.ctx.translate(-s,-o)},e.prototype.resizeImage=function(t,i,s){var o;if(t.width===i&&t.height===s)return t;var a=(o=this.canvas.ownerDocument)!==null&&o!==void 0?o:document,n=a.createElement("canvas");n.width=Math.max(1,i),n.height=Math.max(1,s);var l=n.getContext("2d");return l.drawImage(t,0,0,t.width,t.height,0,0,i,s),n},e.prototype.renderBackgroundImage=function(t){return Ai(this,void 0,void 0,function(){var i,s,o,a,n,l;return ii(this,function(c){switch(c.label){case 0:i=t.styles.backgroundImage.length-1,s=function(h){var d,p,m,R,pe,ge,Q,H,E,g,R,pe,ge,Q,H,u,x,y,P,_,b,B,w,C,E,I,R,F,z,Q,H,ae,pe,ge,fe,Me,be,Fe,Re,Te,Ne,Be;return ii(this,function(Se){switch(Se.label){case 0:if(h.type!==0)return[3,5];d=void 0,p=h.url,Se.label=1;case 1:return Se.trys.push([1,3,,4]),[4,o.context.cache.match(p)];case 2:return d=Se.sent(),[3,4];case 3:return Se.sent(),o.context.logger.error("Error loading background-image "+p),[3,4];case 4:return d&&(m=pA(t,i,[d.width,d.height,d.width/d.height]),R=m[0],pe=m[1],ge=m[2],Q=m[3],H=m[4],E=o.ctx.createPattern(o.resizeImage(d,Q,H),"repeat"),o.renderRepeat(R,E,pe,ge)),[3,6];case 5:FC(h)?(g=pA(t,i,[null,null,null]),R=g[0],pe=g[1],ge=g[2],Q=g[3],H=g[4],u=wC(h.angle,Q,H),x=u[0],y=u[1],P=u[2],_=u[3],b=u[4],B=document.createElement("canvas"),B.width=Q,B.height=H,w=B.getContext("2d"),C=w.createLinearGradient(y,_,P,b),Od(h.stops,x).forEach(function(S){return C.addColorStop(S.stop,zt(S.color))}),w.fillStyle=C,w.fillRect(0,0,Q,H),Q>0&&H>0&&(E=o.ctx.createPattern(B,"repeat"),o.renderRepeat(R,E,pe,ge))):SC(h)&&(I=pA(t,i,[null,null,null]),R=I[0],F=I[1],z=I[2],Q=I[3],H=I[4],ae=h.position.length===0?[pc]:h.position,pe=Ct(ae[0],Q),ge=Ct(ae[ae.length-1],H),fe=CC(h,pe,ge,Q,H),Me=fe[0],be=fe[1],Me>0&&be>0&&(Fe=o.ctx.createRadialGradient(F+pe,z+ge,0,F+pe,z+ge,Me),Od(h.stops,Me*2).forEach(function(S){return Fe.addColorStop(S.stop,zt(S.color))}),o.path(R),o.ctx.fillStyle=Fe,Me!==be?(Re=t.bounds.left+.5*t.bounds.width,Te=t.bounds.top+.5*t.bounds.height,Ne=be/Me,Be=1/Ne,o.ctx.save(),o.ctx.translate(Re,Te),o.ctx.transform(1,0,0,Ne,0,0),o.ctx.translate(-Re,-Te),o.ctx.fillRect(F,Be*(z-Te)+Te,Q,H*Be),o.ctx.restore()):o.ctx.fill())),Se.label=6;case 6:return i--,[2]}})},o=this,a=0,n=t.styles.backgroundImage.slice(0).reverse(),c.label=1;case 1:return a<n.length?(l=n[a],[5,s(l)]):[3,4];case 2:c.sent(),c.label=3;case 3:return a++,[3,1];case 4:return[2]}})})},e.prototype.renderSolidBorder=function(t,i,s){return Ai(this,void 0,void 0,function(){return ii(this,function(o){return this.path(pp(s,i)),this.ctx.fillStyle=zt(t),this.ctx.fill(),[2]})})},e.prototype.renderDoubleBorder=function(t,i,s,o){return Ai(this,void 0,void 0,function(){var a,n;return ii(this,function(l){switch(l.label){case 0:return i<3?[4,this.renderSolidBorder(t,s,o)]:[3,2];case 1:return l.sent(),[2];case 2:return a=RE(o,s),this.path(a),this.ctx.fillStyle=zt(t),this.ctx.fill(),n=LE(o,s),this.path(n),this.ctx.fill(),[2]}})})},e.prototype.renderNodeBackgroundAndBorders=function(t){return Ai(this,void 0,void 0,function(){var i,s,o,a,n,l,c,h,d=this;return ii(this,function(p){switch(p.label){case 0:return this.applyEffects(t.getEffects(2)),i=t.container.styles,s=!Cs(i.backgroundColor)||i.backgroundImage.length,o=[{style:i.borderTopStyle,color:i.borderTopColor,width:i.borderTopWidth},{style:i.borderRightStyle,color:i.borderRightColor,width:i.borderRightWidth},{style:i.borderBottomStyle,color:i.borderBottomColor,width:i.borderBottomWidth},{style:i.borderLeftStyle,color:i.borderLeftColor,width:i.borderLeftWidth}],a=WE(Pr(i.backgroundClip,0),t.curves),s||i.boxShadow.length?(this.ctx.save(),this.path(a),this.ctx.clip(),Cs(i.backgroundColor)||(this.ctx.fillStyle=zt(i.backgroundColor),this.ctx.fill()),[4,this.renderBackgroundImage(t.container)]):[3,2];case 1:p.sent(),this.ctx.restore(),i.boxShadow.slice(0).reverse().forEach(function(m){d.ctx.save();var g=Ma(t.curves),u=m.inset?0:jE,x=TE(g,-u+(m.inset?1:-1)*m.spread.number,(m.inset?1:-1)*m.spread.number,m.spread.number*(m.inset?-2:2),m.spread.number*(m.inset?-2:2));m.inset?(d.path(g),d.ctx.clip(),d.mask(x)):(d.mask(g),d.ctx.clip(),d.path(x)),d.ctx.shadowOffsetX=m.offsetX.number+u,d.ctx.shadowOffsetY=m.offsetY.number,d.ctx.shadowColor=zt(m.color),d.ctx.shadowBlur=m.blur.number,d.ctx.fillStyle=m.inset?zt(m.color):"rgba(0,0,0,1)",d.ctx.fill(),d.ctx.restore()}),p.label=2;case 2:n=0,l=0,c=o,p.label=3;case 3:return l<c.length?(h=c[l],h.style!==0&&!Cs(h.color)&&h.width>0?h.style!==2?[3,5]:[4,this.renderDashedDottedBorder(h.color,h.width,n,t.curves,2)]:[3,11]):[3,13];case 4:return p.sent(),[3,11];case 5:return h.style!==3?[3,7]:[4,this.renderDashedDottedBorder(h.color,h.width,n,t.curves,3)];case 6:return p.sent(),[3,11];case 7:return h.style!==4?[3,9]:[4,this.renderDoubleBorder(h.color,h.width,n,t.curves)];case 8:return p.sent(),[3,11];case 9:return[4,this.renderSolidBorder(h.color,n,t.curves)];case 10:p.sent(),p.label=11;case 11:n++,p.label=12;case 12:return l++,[3,3];case 13:return[2]}})})},e.prototype.renderDashedDottedBorder=function(t,i,s,o,a){return Ai(this,void 0,void 0,function(){var n,l,c,h,d,p,m,g,u,x,y,P,_,b,B,w,B,w;return ii(this,function(C){return this.ctx.save(),n=UE(o,s),l=pp(o,s),a===2&&(this.path(l),this.ctx.clip()),Mi(l[0])?(c=l[0].start.x,h=l[0].start.y):(c=l[0].x,h=l[0].y),Mi(l[1])?(d=l[1].end.x,p=l[1].end.y):(d=l[1].x,p=l[1].y),s===0||s===2?m=Math.abs(c-d):m=Math.abs(h-p),this.ctx.beginPath(),a===3?this.formatPath(n):this.formatPath(l.slice(0,2)),g=i<3?i*3:i*2,u=i<3?i*2:i,a===3&&(g=i,u=i),x=!0,m<=g*2?x=!1:m<=g*2+u?(y=m/(2*g+u),g*=y,u*=y):(P=Math.floor((m+u)/(g+u)),_=(m-P*g)/(P-1),b=(m-(P+1)*g)/P,u=b<=0||Math.abs(u-_)<Math.abs(u-b)?_:b),x&&(a===3?this.ctx.setLineDash([0,g+u]):this.ctx.setLineDash([g,u])),a===3?(this.ctx.lineCap="round",this.ctx.lineWidth=i):this.ctx.lineWidth=i*2+1.1,this.ctx.strokeStyle=zt(t),this.ctx.stroke(),this.ctx.setLineDash([]),a===2&&(Mi(l[0])&&(B=l[3],w=l[0],this.ctx.beginPath(),this.formatPath([new ke(B.end.x,B.end.y),new ke(w.start.x,w.start.y)]),this.ctx.stroke()),Mi(l[1])&&(B=l[1],w=l[2],this.ctx.beginPath(),this.formatPath([new ke(B.end.x,B.end.y),new ke(w.start.x,w.start.y)]),this.ctx.stroke())),this.ctx.restore(),[2]})})},e.prototype.render=function(t){return Ai(this,void 0,void 0,function(){var i;return ii(this,function(s){switch(s.label){case 0:return this.options.backgroundColor&&(this.ctx.fillStyle=zt(this.options.backgroundColor),this.ctx.fillRect(this.options.x,this.options.y,this.options.width,this.options.height)),i=DE(t),[4,this.renderStack(i)];case 1:return s.sent(),this.applyEffects([]),[2,this.canvas]}})})},e}(Hm),GE=function(r){return r instanceof wm||r instanceof Bm?!0:r instanceof _c&&r.type!==Ba&&r.type!==ba},WE=function(r,e){switch(r){case 0:return Ma(e);case 2:return ME(e);case 1:default:return Ea(e)}},KE=function(r){switch(r){case 1:return"center";case 2:return"right";case 0:default:return"left"}},XE=["-apple-system","system-ui"],YE=function(r){return/iPhone OS 15_(0|1)/.test(window.navigator.userAgent)?r.filter(function(e){return XE.indexOf(e)===-1}):r},$E=function(r){Ri(e,r);function e(t,i){var s=r.call(this,t,i)||this;return s.canvas=i.canvas?i.canvas:document.createElement("canvas"),s.ctx=s.canvas.getContext("2d"),s.options=i,s.canvas.width=Math.floor(i.width*i.scale),s.canvas.height=Math.floor(i.height*i.scale),s.canvas.style.width=i.width+"px",s.canvas.style.height=i.height+"px",s.ctx.scale(s.options.scale,s.options.scale),s.ctx.translate(-i.x,-i.y),s.context.logger.debug("EXPERIMENTAL ForeignObject renderer initialized ("+i.width+"x"+i.height+" at "+i.x+","+i.y+") with scale "+i.scale),s}return e.prototype.render=function(t){return Ai(this,void 0,void 0,function(){var i,s;return ii(this,function(o){switch(o.label){case 0:return i=ZA(this.options.width*this.options.scale,this.options.height*this.options.scale,this.options.scale,this.options.scale,t),[4,ZE(i)];case 1:return s=o.sent(),this.options.backgroundColor&&(this.ctx.fillStyle=zt(this.options.backgroundColor),this.ctx.fillRect(0,0,this.options.width*this.options.scale,this.options.height*this.options.scale)),this.ctx.drawImage(s,-this.options.x*this.options.scale,-this.options.y*this.options.scale),[2,this.canvas]}})})},e}(Hm),ZE=function(r){return new Promise(function(e,t){var i=new Image;i.onload=function(){e(i)},i.onerror=t,i.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(r))})},qE=function(){function r(e){var t=e.id,i=e.enabled;this.id=t,this.enabled=i,this.start=Date.now()}return r.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&(typeof window<"u"&&window.console&&typeof console.debug=="function"?console.debug.apply(console,Dn([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},r.prototype.getTime=function(){return Date.now()-this.start},r.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&typeof window<"u"&&window.console&&typeof console.info=="function"&&console.info.apply(console,Dn([this.id,this.getTime()+"ms"],e))},r.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&(typeof window<"u"&&window.console&&typeof console.warn=="function"?console.warn.apply(console,Dn([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},r.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&(typeof window<"u"&&window.console&&typeof console.error=="function"?console.error.apply(console,Dn([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},r.instances={},r}(),JE=function(){function r(e,t){var i;this.windowBounds=t,this.instanceName="#"+r.instanceCount++,this.logger=new qE({id:this.instanceName,enabled:e.logging}),this.cache=(i=e.cache)!==null&&i!==void 0?i:new vE(this,e)}return r.instanceCount=1,r}(),mp=function(r,e){return e===void 0&&(e={}),eI(r,e)};typeof window<"u"&&Um.setContext(window);var eI=function(r,e){return Ai(void 0,void 0,void 0,function(){var t,i,s,o,a,n,l,c,h,d,p,m,g,u,x,y,P,_,b,B,C,w,C,E,I,R,F,z,Q,H,ae,pe,ge,fe,Me,be,Fe,Re,Te,Ne;return ii(this,function(Be){switch(Be.label){case 0:if(!r||typeof r!="object")return[2,Promise.reject("Invalid element provided as first argument")];if(t=r.ownerDocument,!t)throw new Error("Element is not attached to a Document");if(i=t.defaultView,!i)throw new Error("Document is not attached to a Window");return s={allowTaint:(E=e.allowTaint)!==null&&E!==void 0?E:!1,imageTimeout:(I=e.imageTimeout)!==null&&I!==void 0?I:15e3,proxy:e.proxy,useCORS:(R=e.useCORS)!==null&&R!==void 0?R:!1},o=UA({logging:(F=e.logging)!==null&&F!==void 0?F:!0,cache:e.cache},s),a={windowWidth:(z=e.windowWidth)!==null&&z!==void 0?z:i.innerWidth,windowHeight:(Q=e.windowHeight)!==null&&Q!==void 0?Q:i.innerHeight,scrollX:(H=e.scrollX)!==null&&H!==void 0?H:i.pageXOffset,scrollY:(ae=e.scrollY)!==null&&ae!==void 0?ae:i.pageYOffset},n=new As(a.scrollX,a.scrollY,a.windowWidth,a.windowHeight),l=new JE(o,n),c=(pe=e.foreignObjectRendering)!==null&&pe!==void 0?pe:!1,h={allowTaint:(ge=e.allowTaint)!==null&&ge!==void 0?ge:!1,onclone:e.onclone,ignoreElements:e.ignoreElements,inlineImages:c,copyStyles:c},l.logger.debug("Starting document clone with size "+n.width+"x"+n.height+" scrolled to "+-n.left+","+-n.top),d=new hp(l,r,h),p=d.clonedReferenceElement,p?[4,d.toIFrame(t,n)]:[2,Promise.reject("Unable to find element in cloned iframe")];case 1:return m=Be.sent(),g=vc(p)||iE(p)?TB(p.ownerDocument):Ua(l,p),u=g.width,x=g.height,y=g.left,P=g.top,_=tI(l,p,e.backgroundColor),b={canvas:e.canvas,backgroundColor:_,scale:(Me=(fe=e.scale)!==null&&fe!==void 0?fe:i.devicePixelRatio)!==null&&Me!==void 0?Me:1,x:((be=e.x)!==null&&be!==void 0?be:0)+y,y:((Fe=e.y)!==null&&Fe!==void 0?Fe:0)+P,width:(Re=e.width)!==null&&Re!==void 0?Re:Math.ceil(u),height:(Te=e.height)!==null&&Te!==void 0?Te:Math.ceil(x)},c?(l.logger.debug("Document cloned, using foreign object rendering"),C=new $E(l,b),[4,C.render(p)]):[3,3];case 2:return B=Be.sent(),[3,5];case 3:return l.logger.debug("Document cloned, element located at "+y+","+P+" with size "+u+"x"+x+" using computed rendering"),l.logger.debug("Starting DOM parsing"),w=Em(l,p),_===w.styles.backgroundColor&&(w.styles.backgroundColor=ns.TRANSPARENT),l.logger.debug("Starting renderer for element at "+b.x+","+b.y+" with size "+b.width+"x"+b.height),C=new zE(l,b),[4,C.render(w)];case 4:B=Be.sent(),Be.label=5;case 5:return(!((Ne=e.removeContainer)!==null&&Ne!==void 0)||Ne)&&(hp.destroy(m)||l.logger.error("Cannot detach cloned iframe as it is not in the DOM anymore")),l.logger.debug("Finished rendering"),[2,B]}})})},tI=function(r,e,t){var i=e.ownerDocument,s=i.documentElement?bo(r,getComputedStyle(i.documentElement).backgroundColor):ns.TRANSPARENT,o=i.body?bo(r,getComputedStyle(i.body).backgroundColor):ns.TRANSPARENT,a=typeof t=="string"?bo(r,t):t===null?ns.TRANSPARENT:4294967295;return e===i.documentElement?Cs(s)?Cs(o)?a:o:s:a};class zF{constructor(e){this.language="en",this.localeService=e.localeService||new Jb,this.scene=new lc(this,{canvasId:e.canvasId,canvasElement:e.canvasElement,keyboardEventsElement:e.keyboardEventsElement,contextAttr:{preserveDrawingBuffer:e.preserveDrawingBuffer!==!1,premultipliedAlpha:!!e.premultipliedAlpha,antialias:e.antialias!==!1},spinnerElementId:e.spinnerElementId,transparent:e.transparent!==!1,gammaInput:!0,gammaOutput:!1,backgroundColor:e.backgroundColor,backgroundColorFromAmbientLight:e.backgroundColorFromAmbientLight,ticksPerRender:1,ticksPerOcclusionTest:20,units:e.units,scale:e.scale,origin:e.origin,saoEnabled:e.saoEnabled,alphaDepthMask:e.alphaDepthMask!==!1,entityOffsetsEnabled:!!e.entityOffsetsEnabled,readableGeometryEnabled:!!e.readableGeometryEnabled,logarithmicDepthBufferEnabled:!!e.logarithmicDepthBufferEnabled,pbrEnabled:!!e.pbrEnabled,colorTextureEnabled:e.colorTextureEnabled!==!1,dtxEnabled:!!e.dtxEnabled,markerZOffset:e.markerZOffset,numCachedSectionPlanes:e.numCachedSectionPlanes}),this.metaScene=new SB(this,this.scene),this.id=e.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new js(this.scene,{duration:.5}),this.cameraControl=new MB(this.scene,{doublePickFlyTo:!0}),this._plugins=[],this._eventSubs={}}get capabilities(){return this.scene.capabilities}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let s=0,o=i.length;s<o;s++)i[s](t)}off(e){}log(e){console.log(`[xeokit viewer ${this.id}]: ${e}`)}error(e){console.error(`[xeokit viewer ${this.id}]: ${e}`)}addPlugin(e){this._plugins.push(e)}removePlugin(e){for(let t=0,i=this._plugins.length;t<i;t++){const s=this._plugins[t];if(s===e){s.clear&&s.clear(),this._plugins.splice(t,1);return}}}sendToPlugins(e,t){for(let i=0,s=this._plugins.length;i<s;i++){const o=this._plugins[i];o.send&&o.send(e,t)}}clear(){throw`Viewer#clear() no longer implemented - use '#sendToPlugins("clear") instead`}resetView(){throw"Viewer#resetView() no longer implemented - use CameraMemento & ObjectsMemento classes instead"}beginSnapshot(){this._snapshotBegun||(this.scene._renderer.beginSnapshot(),this._snapshotBegun=!0)}getSnapshot(e={}){const t=!this._snapshotBegun,i=e.width!==void 0&&e.height!==void 0,s=this.scene.canvas.canvas,o=s.clientWidth,a=s.clientHeight,n=e.width?Math.floor(e.width):s.width,l=e.height?Math.floor(e.height):s.height;i&&(s.width=n,s.height=l),this._snapshotBegun||this.beginSnapshot({width:n,height:l}),e.includeGizmos||this.sendToPlugins("snapshotStarting");const c={};for(let d=0,p=this._plugins.length;d<p;d++){const m=this._plugins[d];if(m.getContainerElement){const g=m.getContainerElement();g!==document.body&&(c[g.id]||(c[g.id]=!0,mp(g).then(function(u){document.body.appendChild(u)})))}}this.scene.fire("rendering",{},!0),this.scene._renderer.renderSnapshot();const h=this.scene._renderer.readSnapshot(e);return i&&(s.width=o,s.height=a,this.scene.glRedraw()),e.includeGizmos||this.sendToPlugins("snapshotFinished"),t&&this.endSnapshot(),h}async getSnapshotWithPlugins(e={}){var g;const t=!this._snapshotBegun,i=e.width!==void 0&&e.height!==void 0,s=this.scene.canvas.canvas,o=s.clientWidth,a=s.clientHeight,n=e.width?Math.floor(e.width):s.width,l=e.height?Math.floor(e.height):s.height;i&&(s.width=n,s.height=l),this._snapshotBegun||this.beginSnapshot(),e.includeGizmos||this.sendToPlugins("snapshotStarting"),this.scene._renderer.renderSnapshot();const c=this.scene._renderer.readSnapshotAsCanvas();i&&(s.width=o,s.height=a,this.scene.glRedraw());const h={},d=[];for(let u=0,x=this._plugins.length;u<x;u++){const y=this._plugins[u];if(y.getContainerElement){const P=y.getContainerElement();P!==document.body&&(h[P.id]||(h[P.id]=!0,d.push(P)))}}const p=document.createElement("style");document.head.appendChild(p),(g=p.sheet)==null||g.insertRule("body > div:last-child img { display: inline-block; }");for(let u=0,x=d.length;u<x;u++){const y=d[u];await mp(y,{canvas:c,backgroundColor:null,scale:c.width/y.clientWidth}),c.getContext("2d").resetTransform()}p.remove(),e.includeGizmos||this.sendToPlugins("snapshotFinished"),t&&this.endSnapshot();let m=e.format||"png";return m!=="jpeg"&&m!=="png"&&m!=="bmp"&&(console.error("Unsupported image format: '"+m+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'png'"),m="png"),e.includeGizmos||this.sendToPlugins("snapshotFinished"),t&&this.endSnapshot(),c.toDataURL(`image/${m}`)}endSnapshot(){this._snapshotBegun&&(this.scene._renderer.endSnapshot(),this.scene._renderer.render({force:!0}),this._snapshotBegun=!1)}destroy(){const e=this._plugins.slice();for(let t=0,i=e.length;t<i;t++)e[t].destroy();this.scene.destroy()}}const iI=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),gp=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);gp&&parseFloat(gp[1]);function Do(r,e){if(!r)throw new Error("loaders.gl assertion failed.")}const _p=typeof process!="object"||String(process)!=="[object process]"||process.browser,sI=typeof window<"u"&&typeof window.orientation<"u",vp=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);vp&&parseFloat(vp[1]);function lt(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}class rI{constructor(e,t){lt(this,"name",void 0),lt(this,"workerThread",void 0),lt(this,"isRunning",!0),lt(this,"result",void 0),lt(this,"_resolve",()=>{}),lt(this,"_reject",()=>{}),this.name=e,this.workerThread=t,this.result=new Promise((i,s)=>{this._resolve=i,this._reject=s})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){Do(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){Do(this.isRunning),this.isRunning=!1,this._reject(e)}}class fA{}const mA=new Map;function oI(r){Do(r.source&&!r.url||!r.source&&r.url);let e=mA.get(r.source||r.url);return e||(r.url&&(e=nI(r.url),mA.set(r.url,e)),r.source&&(e=jm(r.source),mA.set(r.source,e))),Do(e),e}function nI(r){if(!r.startsWith("http"))return r;const e=aI(r);return jm(e)}function jm(r){const e=new Blob([r],{type:"application/javascript"});return URL.createObjectURL(e)}function aI(r){return`try {
  importScripts('`.concat(r,`');
} catch (error) {
  console.error(error);
  throw error;
}`)}function zm(r,e=!0,t){const i=t||new Set;if(r){if(Pp(r))i.add(r);else if(Pp(r.buffer))i.add(r.buffer);else if(!ArrayBuffer.isView(r)){if(e&&typeof r=="object")for(const s in r)zm(r[s],e,i)}}return t===void 0?Array.from(i):[]}function Pp(r){return r?r instanceof ArrayBuffer||typeof MessagePort<"u"&&r instanceof MessagePort||typeof ImageBitmap<"u"&&r instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&r instanceof OffscreenCanvas:!1}const gA=()=>{};class rc{static isSupported(){return typeof Worker<"u"&&_p||typeof fA!==void 0}constructor(e){lt(this,"name",void 0),lt(this,"source",void 0),lt(this,"url",void 0),lt(this,"terminated",!1),lt(this,"worker",void 0),lt(this,"onMessage",void 0),lt(this,"onError",void 0),lt(this,"_loadableURL","");const{name:t,source:i,url:s}=e;Do(i||s),this.name=t,this.source=i,this.url=s,this.onMessage=gA,this.onError=o=>console.log(o),this.worker=_p?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=gA,this.onError=gA,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||zm(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=oI({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){const i=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);e=new fA(i,{eval:!1})}else if(this.source)e=new fA(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}}class lI{static isSupported(){return rc.isSupported()}constructor(e){lt(this,"name","unnamed"),lt(this,"source",void 0),lt(this,"url",void 0),lt(this,"maxConcurrency",1),lt(this,"maxMobileConcurrency",1),lt(this,"onDebug",()=>{}),lt(this,"reuseWorkers",!0),lt(this,"props",{}),lt(this,"jobQueue",[]),lt(this,"idleQueue",[]),lt(this,"count",0),lt(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(s,o,a)=>s.done(a),i=(s,o)=>s.error(o)){const s=new Promise(o=>(this.jobQueue.push({name:e,onMessage:t,onError:i,onStart:o}),this));return this._startQueuedJob(),await s}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const i=new rI(t.name,e);e.onMessage=s=>t.onMessage(i,s.type,s.payload),e.onError=s=>t.onError(i,s),t.onStart(i);try{await i.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new rc({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return sI?this.maxMobileConcurrency:this.maxConcurrency}}const AI={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class Ns{static isSupported(){return rc.isSupported()}static getWorkerFarm(e={}){return Ns._workerFarm=Ns._workerFarm||new Ns({}),Ns._workerFarm.setProps(e),Ns._workerFarm}constructor(e){lt(this,"props",void 0),lt(this,"workerPools",new Map),this.props={...AI},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:i,url:s}=e;let o=this.workerPools.get(t);return o||(o=new lI({name:t,source:i,url:s}),o.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,o)),o}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}lt(Ns,"_workerFarm",void 0);function cI(r){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron)return!0;const t=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}function hI(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||cI()}const da={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:typeof process=="object"&&process},xp=da.window||da.self||da.global,yp=da.process||{},Gm=typeof __VERSION__<"u"?__VERSION__:"untranspiled source",Wa=hI();function uI(r){try{const e=window[r],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}class dI{constructor(e,t,i="sessionStorage"){this.storage=uI(i),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}return this}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function pI(r){let e;return r<10?e="".concat(r.toFixed(2),"ms"):r<100?e="".concat(r.toFixed(1),"ms"):r<1e3?e="".concat(r.toFixed(0),"ms"):e="".concat((r/1e3).toFixed(2),"s"),e}function fI(r,e=8){const t=Math.max(e-r.length,0);return"".concat(" ".repeat(t)).concat(r)}function _A(r,e,t,i=600){const s=r.src.replace(/\(/g,"%28").replace(/\)/g,"%29");r.width>i&&(t=Math.min(t,i/r.width));const o=r.width*t,a=r.height*t,n=["font-size:1px;","padding:".concat(Math.floor(a/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(a,"px;"),"background:url(".concat(s,");"),"background-size:".concat(o,"px ").concat(a,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),n]}const bp={BLACK:30,RED:31,GREEN:32,YELLOW:33,BLUE:34,MAGENTA:35,CYAN:36,WHITE:37,BRIGHT_BLACK:90,BRIGHT_RED:91,BRIGHT_GREEN:92,BRIGHT_YELLOW:93,BRIGHT_BLUE:94,BRIGHT_MAGENTA:95,BRIGHT_CYAN:96,BRIGHT_WHITE:97};function Bp(r){return typeof r=="string"?bp[r.toUpperCase()]||bp.WHITE:r}function mI(r,e,t){return!Wa&&typeof r=="string"&&(e&&(e=Bp(e),r="\x1B[".concat(e,"m").concat(r,"\x1B[39m")),t&&(e=Bp(t),r="\x1B[".concat(t+10,"m").concat(r,"\x1B[49m"))),r}function gI(r,e=["constructor"]){const t=Object.getPrototypeOf(r),i=Object.getOwnPropertyNames(t);for(const s of i)typeof r[s]=="function"&&(e.find(o=>s===o)||(r[s]=r[s].bind(r)))}function Fa(r,e){if(!r)throw new Error(e||"Assertion failed")}function pr(){let r;if(Wa&&xp.performance)r=xp.performance.now();else if(yp.hrtime){const e=yp.hrtime();r=e[0]*1e3+e[1]/1e6}else r=Date.now();return r}const fr={debug:Wa&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},_I={enabled:!0,level:0};function Bi(){}const wp={},Cp={once:!0};function vI(r){for(const e in r)for(const t in r[e])return t||"untitled";return"empty"}class Wm{constructor({id:e}={id:""}){this.id=e,this.VERSION=Gm,this._startTs=pr(),this._deltaTs=pr(),this.LOG_THROTTLE_TIMEOUT=0,this._storage=new dI("__probe-".concat(this.id,"__"),_I),this.userData={},this.timeStamp("".concat(this.id," started")),gI(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((pr()-this._startTs).toPrecision(10))}getDelta(){return Number((pr()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}assert(e,t){Fa(e,t)}warn(e){return this._getLogFunction(0,e,fr.warn,arguments,Cp)}error(e){return this._getLogFunction(0,e,fr.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,fr.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,fr.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,fr.debug||fr.info,arguments,Cp)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||Bi,i&&[i],{tag:vI(t)}):Bi}image({logLevel:e,priority:t,image:i,message:s="",scale:o=1}){return this._shouldLog(e||t)?Wa?yI({image:i,message:s,scale:o}):xI({image:i,message:s,scale:o}):Bi}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t})}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Bi)}group(e,t,i={collapsed:!1}){i=Mp({logLevel:e,message:t,opts:i});const{collapsed:s}=i;return i.method=(s?console.groupCollapsed:console.group)||console.info,this._getLogFunction(i)}groupCollapsed(e,t,i={}){return this.group(e,t,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Bi)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=Km(e)}_getLogFunction(e,t,i,s=[],o){if(this._shouldLog(e)){o=Mp({logLevel:e,message:t,args:s,opts:o}),i=i||o.method,Fa(i),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=pr();const a=o.tag||o.message;if(o.once)if(!wp[a])wp[a]=pr();else return Bi;return t=PI(this.id,o.message,o),i.bind(console,t,...o.args)}return Bi}}Wm.VERSION=Gm;function Km(r){if(!r)return 0;let e;switch(typeof r){case"number":e=r;break;case"object":e=r.logLevel||r.priority||0;break;default:return 0}return Fa(Number.isFinite(e)&&e>=0),e}function Mp(r){const{logLevel:e,message:t}=r;r.logLevel=Km(e);const i=r.args?Array.from(r.args):[];for(;i.length&&i.shift()!==t;);switch(r.args=i,typeof e){case"string":case"function":t!==void 0&&i.unshift(t),r.message=e;break;case"object":Object.assign(r,e);break}typeof r.message=="function"&&(r.message=r.message());const s=typeof r.message;return Fa(s==="string"||s==="object"),Object.assign(r,r.opts)}function PI(r,e,t){if(typeof e=="string"){const i=t.time?fI(pI(t.total)):"";e=t.time?"".concat(r,": ").concat(i,"  ").concat(e):"".concat(r,": ").concat(e),e=mI(e,t.color,t.background)}return e}function xI({image:r,message:e="",scale:t=1}){let i=null;try{i=module.require("asciify-image")}catch{}return i?()=>i(r,{fit:"box",width:"".concat(Math.round(80*t),"%")}).then(s=>console.log(s)):Bi}function yI({image:r,message:e="",scale:t=1}){if(typeof r=="string"){const s=new Image;return s.onload=()=>{const o=_A(s,e,t);console.log(...o)},s.src=r,Bi}const i=r.nodeName||"";if(i.toLowerCase()==="img")return console.log(..._A(r,e,t)),Bi;if(i.toLowerCase()==="canvas"){const s=new Image;return s.onload=()=>console.log(..._A(s,e,t)),s.src=r.toDataURL(),Bi}return Bi}new Wm({id:"loaders.gl"});class bI{constructor(){lt(this,"console",void 0),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}new bI;function BI(r){if(typeof window<"u"&&typeof window.process=="object"&&window.process.type==="renderer"||typeof process<"u"&&typeof process.versions=="object"&&process.versions.electron)return!0;const t=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}function No(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process.browser)||BI()}const pa={self:typeof self<"u"&&self,window:typeof window<"u"&&window,global:typeof global<"u"&&global,document:typeof document<"u"&&document,process:typeof process=="object"&&process},ia=pa.window||pa.self||pa.global,Ao=pa.process||{},Xm=typeof __VERSION__<"u"?__VERSION__:"untranspiled source";No();function wI(r){try{const e=window[r],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}class CI{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"sessionStorage";lt(this,"storage",void 0),lt(this,"id",void 0),lt(this,"config",{}),this.storage=wI(i),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}return this}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function MI(r){let e;return r<10?e="".concat(r.toFixed(2),"ms"):r<100?e="".concat(r.toFixed(1),"ms"):r<1e3?e="".concat(r.toFixed(0),"ms"):e="".concat((r/1e3).toFixed(2),"s"),e}function EI(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:8;const t=Math.max(e-r.length,0);return"".concat(" ".repeat(t)).concat(r)}function vA(r,e,t){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:600;const s=r.src.replace(/\(/g,"%28").replace(/\)/g,"%29");r.width>i&&(t=Math.min(t,i/r.width));const o=r.width*t,a=r.height*t,n=["font-size:1px;","padding:".concat(Math.floor(a/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(a,"px;"),"background:url(".concat(s,");"),"background-size:".concat(o,"px ").concat(a,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),n]}let Sa;(function(r){r[r.BLACK=30]="BLACK",r[r.RED=31]="RED",r[r.GREEN=32]="GREEN",r[r.YELLOW=33]="YELLOW",r[r.BLUE=34]="BLUE",r[r.MAGENTA=35]="MAGENTA",r[r.CYAN=36]="CYAN",r[r.WHITE=37]="WHITE",r[r.BRIGHT_BLACK=90]="BRIGHT_BLACK",r[r.BRIGHT_RED=91]="BRIGHT_RED",r[r.BRIGHT_GREEN=92]="BRIGHT_GREEN",r[r.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",r[r.BRIGHT_BLUE=94]="BRIGHT_BLUE",r[r.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",r[r.BRIGHT_CYAN=96]="BRIGHT_CYAN",r[r.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(Sa||(Sa={}));function Ep(r){return typeof r=="string"?Sa[r.toUpperCase()]||Sa.WHITE:r}function II(r,e,t){return!No&&typeof r=="string"&&(e&&(e=Ep(e),r="\x1B[".concat(e,"m").concat(r,"\x1B[39m")),t&&(e=Ep(t),r="\x1B[".concat(t+10,"m").concat(r,"\x1B[49m"))),r}function FI(r){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:["constructor"];const t=Object.getPrototypeOf(r),i=Object.getOwnPropertyNames(t);for(const s of i)typeof r[s]=="function"&&(e.find(o=>s===o)||(r[s]=r[s].bind(r)))}function Ta(r,e){if(!r)throw new Error(e||"Assertion failed")}function mr(){let r;if(No&&"performance"in ia){var e,t;r=ia==null||(e=ia.performance)===null||e===void 0||(t=e.now)===null||t===void 0?void 0:t.call(e)}else if("hrtime"in Ao){var i;const s=Ao==null||(i=Ao.hrtime)===null||i===void 0?void 0:i.call(Ao);r=s[0]*1e3+s[1]/1e6}else r=Date.now();return r}const gr={debug:No&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},SI={enabled:!0,level:0};function wi(){}const Ip={},Fp={once:!0};class Ym{constructor(){let{id:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:""};lt(this,"id",void 0),lt(this,"VERSION",Xm),lt(this,"_startTs",mr()),lt(this,"_deltaTs",mr()),lt(this,"_storage",void 0),lt(this,"userData",{}),lt(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this._storage=new CI("__probe-".concat(this.id,"__"),SI),this.userData={},this.timeStamp("".concat(this.id," started")),FI(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((mr()-this._startTs).toPrecision(10))}getDelta(){return Number((mr()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){Ta(e,t)}warn(e){return this._getLogFunction(0,e,gr.warn,arguments,Fp)}error(e){return this._getLogFunction(0,e,gr.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,gr.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,gr.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){for(var i=arguments.length,s=new Array(i>2?i-2:0),o=2;o<i;o++)s[o-2]=arguments[o];return this._getLogFunction(e,t,gr.debug||gr.info,arguments,Fp)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||wi,i&&[i],{tag:LI(t)}):wi}image(e){let{logLevel:t,priority:i,image:s,message:o="",scale:a=1}=e;return this._shouldLog(t||i)?No?RI({image:s,message:o,scale:a}):DI({image:s,message:o,scale:a}):wi}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||wi)}group(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{collapsed:!1};const s=Sp({logLevel:e,message:t,opts:i}),{collapsed:o}=i;return s.method=(o?console.groupCollapsed:console.group)||console.info,this._getLogFunction(s)}groupCollapsed(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return this.group(e,t,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||wi)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=$m(e)}_getLogFunction(e,t,i,s,o){if(this._shouldLog(e)){o=Sp({logLevel:e,message:t,args:s,opts:o}),i=i||o.method,Ta(i),o.total=this.getTotal(),o.delta=this.getDelta(),this._deltaTs=mr();const a=o.tag||o.message;if(o.once)if(!Ip[a])Ip[a]=mr();else return wi;return t=TI(this.id,o.message,o),i.bind(console,t,...o.args)}return wi}}lt(Ym,"VERSION",Xm);function $m(r){if(!r)return 0;let e;switch(typeof r){case"number":e=r;break;case"object":e=r.logLevel||r.priority||0;break;default:return 0}return Ta(Number.isFinite(e)&&e>=0),e}function Sp(r){const{logLevel:e,message:t}=r;r.logLevel=$m(e);const i=r.args?Array.from(r.args):[];for(;i.length&&i.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&i.unshift(t),r.message=e;break;case"object":Object.assign(r,e);break}typeof r.message=="function"&&(r.message=r.message());const s=typeof r.message;return Ta(s==="string"||s==="object"),Object.assign(r,{args:i},r.opts)}function TI(r,e,t){if(typeof e=="string"){const i=t.time?EI(MI(t.total)):"";e=t.time?"".concat(r,": ").concat(i,"  ").concat(e):"".concat(r,": ").concat(e),e=II(e,t.color,t.background)}return e}function DI(r){let{image:e,message:t="",scale:i=1}=r,s=null;try{s=module.require("asciify-image")}catch{}return s?()=>s(e,{fit:"box",width:"".concat(Math.round(80*i),"%")}).then(o=>console.log(o)):wi}function RI(r){let{image:e,message:t="",scale:i=1}=r;if(typeof e=="string"){const o=new Image;return o.onload=()=>{const a=vA(o,t,i);console.log(...a)},o.src=e,wi}const s=e.nodeName||"";if(s.toLowerCase()==="img")return console.log(...vA(e,t,i)),wi;if(s.toLowerCase()==="canvas"){const o=new Image;return o.onload=()=>console.log(...vA(o,t,i)),o.src=e.toDataURL(),wi}return wi}function LI(r){for(const e in r)for(const t in r[e])return t||"untitled";return"empty"}new Ym({id:"loaders.gl"});var Tp,Dp,Rp,Lp,Up,Op,kp,Np;(function(r){r[r.NONE=0]="NONE",r[r.BASISLZ=1]="BASISLZ",r[r.ZSTD=2]="ZSTD",r[r.ZLIB=3]="ZLIB"})(Tp||(Tp={})),function(r){r[r.BASICFORMAT=0]="BASICFORMAT"}(Dp||(Dp={})),function(r){r[r.UNSPECIFIED=0]="UNSPECIFIED",r[r.ETC1S=163]="ETC1S",r[r.UASTC=166]="UASTC"}(Rp||(Rp={})),function(r){r[r.UNSPECIFIED=0]="UNSPECIFIED",r[r.SRGB=1]="SRGB"}(Lp||(Lp={})),function(r){r[r.UNSPECIFIED=0]="UNSPECIFIED",r[r.LINEAR=1]="LINEAR",r[r.SRGB=2]="SRGB",r[r.ITU=3]="ITU",r[r.NTSC=4]="NTSC",r[r.SLOG=5]="SLOG",r[r.SLOG2=6]="SLOG2"}(Up||(Up={})),function(r){r[r.ALPHA_STRAIGHT=0]="ALPHA_STRAIGHT",r[r.ALPHA_PREMULTIPLIED=1]="ALPHA_PREMULTIPLIED"}(Op||(Op={})),function(r){r[r.RGB=0]="RGB",r[r.RRR=3]="RRR",r[r.GGG=4]="GGG",r[r.AAA=15]="AAA"}(kp||(kp={})),function(r){r[r.RGB=0]="RGB",r[r.RGBA=3]="RGBA",r[r.RRR=4]="RRR",r[r.RRRG=5]="RRRG"}(Np||(Np={}));const UI=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]];new Map(UI);let Qp;(function(r){r[r.NONE=0]="NONE",r[r.Null=1]="Null",r[r.Int=2]="Int",r[r.Float=3]="Float",r[r.Binary=4]="Binary",r[r.Utf8=5]="Utf8",r[r.Bool=6]="Bool",r[r.Decimal=7]="Decimal",r[r.Date=8]="Date",r[r.Time=9]="Time",r[r.Timestamp=10]="Timestamp",r[r.Interval=11]="Interval",r[r.List=12]="List",r[r.Struct=13]="Struct",r[r.Union=14]="Union",r[r.FixedSizeBinary=15]="FixedSizeBinary",r[r.FixedSizeList=16]="FixedSizeList",r[r.Map=17]="Map",r[r.Dictionary=-1]="Dictionary",r[r.Int8=-2]="Int8",r[r.Int16=-3]="Int16",r[r.Int32=-4]="Int32",r[r.Int64=-5]="Int64",r[r.Uint8=-6]="Uint8",r[r.Uint16=-7]="Uint16",r[r.Uint32=-8]="Uint32",r[r.Uint64=-9]="Uint64",r[r.Float16=-10]="Float16",r[r.Float32=-11]="Float32",r[r.Float64=-12]="Float64",r[r.DateDay=-13]="DateDay",r[r.DateMillisecond=-14]="DateMillisecond",r[r.TimestampSecond=-15]="TimestampSecond",r[r.TimestampMillisecond=-16]="TimestampMillisecond",r[r.TimestampMicrosecond=-17]="TimestampMicrosecond",r[r.TimestampNanosecond=-18]="TimestampNanosecond",r[r.TimeSecond=-19]="TimeSecond",r[r.TimeMillisecond=-20]="TimeMillisecond",r[r.TimeMicrosecond=-21]="TimeMicrosecond",r[r.TimeNanosecond=-22]="TimeNanosecond",r[r.DenseUnion=-23]="DenseUnion",r[r.SparseUnion=-24]="SparseUnion",r[r.IntervalDayTime=-25]="IntervalDayTime",r[r.IntervalYearMonth=-26]="IntervalYearMonth"})(Qp||(Qp={}));const OI={DEFAULT:{}};function kI(r,e,t={}){const i="lightgrey",s=t.hoverColor||"rgba(0,0,0,0.4)",o=t.textColor||"black",a=500,n=a+a/3,l=n/24,c=[{boundary:[6,6,6,6],color:t.frontColor||t.color||"#55FF55"},{boundary:[18,6,6,6],color:t.backColor||t.color||"#55FF55"},{boundary:[12,6,6,6],color:t.rightColor||t.color||"#FF5555"},{boundary:[0,6,6,6],color:t.leftColor||t.color||"#FF5555"},{boundary:[6,0,6,6],color:t.topColor||t.color||"#7777FF"},{boundary:[6,12,6,6],color:t.bottomColor||t.color||"#7777FF"}],h=[{label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,1,0],up:[0,0,1]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,-1,0],up:[0,0,1]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,0,1]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,0,1]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,0,1],up:[0,-1,0]},{boundaries:[[7,5,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,0,-1],up:[1,0,1]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-1,-1],up:[0,-1,1]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,0,-1],up:[-1,0,1]},{boundaries:[[7,11,4,2]],dir:[0,1,1],up:[0,-1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,0,1],up:[-1,0,1]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,-1,1],up:[0,1,1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,0,1],up:[1,0,1]},{boundaries:[[5,7,2,4]],dir:[1,1,0],up:[0,0,1]},{boundaries:[[11,7,2,4]],dir:[-1,1,0],up:[0,0,1]},{boundaries:[[17,7,2,4]],dir:[-1,-1,0],up:[0,0,1]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,-1,0],up:[0,0,1]},{boundaries:[[5,11,2,2]],dir:[1,1,1],up:[-1,-1,1]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[1,-1,1],up:[-1,1,1]},{boundaries:[[5,5,2,2]],dir:[1,1,-1],up:[1,1,1]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-1,-1,1],up:[1,1,1]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-1,-1,-1],up:[-1,-1,1]},{boundaries:[[11,11,2,2]],dir:[-1,1,1],up:[1,-1,1]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[1,-1,-1],up:[1,-1,1]},{boundaries:[[11,5,2,2]],dir:[-1,1,-1],up:[-1,1,1]}];t.frontColor||t.color,t.backColor||t.color,t.rightColor||t.color,t.leftColor||t.color,t.topColor||t.color,t.bottomColor||t.color;const d=[{yUp:"",label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,0,1],up:[0,1,0]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,1,0]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,1,0]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,-1,0],up:[0,0,-1]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,1,0],up:[0,0,1]},{boundaries:[[7,5,4,2]],dir:[0,-.7071,-.7071],up:[0,.7071,-.7071]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,-1,0],up:[1,1,0]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-.7071,.7071],up:[0,.7071,.7071]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,-1,0],up:[-1,1,0]},{boundaries:[[7,11,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,1,0],up:[-1,1,0]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,1,1],up:[0,1,-1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,1,0],up:[1,1,0]},{boundaries:[[5,7,2,4]],dir:[1,0,-1],up:[0,1,0]},{boundaries:[[11,7,2,4]],dir:[-1,0,-1],up:[0,1,0]},{boundaries:[[17,7,2,4]],dir:[-1,0,1],up:[0,1,0]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,0,1],up:[0,1,0]},{boundaries:[[5,11,2,2]],dir:[.5,.7071,-.5],up:[-.5,.7071,.5]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[.5,.7071,.5],up:[-.5,.7071,-.5]},{boundaries:[[5,5,2,2]],dir:[.5,-.7071,-.5],up:[.5,.7071,-.5]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-.5,.7071,.5],up:[.5,.7071,-.5]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-.5,-.7071,.5],up:[-.5,.7071,.5]},{boundaries:[[11,11,2,2]],dir:[-.5,.7071,-.5],up:[.5,.7071,.5]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[.5,-.7071,.5],up:[.5,.7071,.5]},{boundaries:[[11,5,2,2]],dir:[-.5,-.7071,-.5],up:[-.5,.7071,-.5]}];for(let P=0,_=h.length;P<_;P++)A.normalizeVec3(h[P].dir,h[P].dir),A.normalizeVec3(h[P].up,h[P].up);for(let P=0,_=d.length;P<_;P++)A.normalizeVec3(d[P].dir,d[P].dir),A.normalizeVec3(d[P].up,d[P].up);var p=d;this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=n,this._textureCanvas.height=a,this._textureCanvas.style.width=n+"px",this._textureCanvas.style.height=a+"px",this._textureCanvas.style.padding="0",this._textureCanvas.style.margin="0",this._textureCanvas.style.top="0",this._textureCanvas.style.background=i,this._textureCanvas.style.position="absolute",this._textureCanvas.style.opacity="1.0",this._textureCanvas.style.visibility="hidden",this._textureCanvas.style["z-index"]=2e6,document.getElementsByTagName("body")[0].appendChild(this._textureCanvas);const g=this._textureCanvas.getContext("2d");let u=!1;function x(){for(let w=0,C=c.length;w<C;w++){const E=c[w],I=E.boundary,R=Math.round(I[0]*l),F=Math.round(I[1]*l),z=Math.round(I[2]*l),Q=Math.round(I[3]*l);g.fillStyle=E.color,g.fillRect(R,F,z,Q)}for(let w=0,C=p.length;w<C;w++){let E,I,R,F;const z=p[w],Q=z.boundaries;for(var P=0,_=Q.length;P<_;P++){const H=Q[P];E=Math.round(H[0]*l),I=Math.round(H[1]*l),R=Math.round(H[2]*l),F=Math.round(H[3]*l),z.highlighted&&(g.fillStyle=z.highlighted?s:z.color||i,g.fillRect(E,I,R,F))}if(z.label){g.fillStyle=o,g.font="60px sans-serif",g.textAlign="center";var b=E+R*.5,B=I+F*.7;g.fillText(y(z.label),b,B,80)}}e.glRedraw()}const y=function(){const P={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},_={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},b={"NavCube.front":"FRONT","NavCube.back":"BACK","NavCube.right":"RIGHT","NavCube.left":"LEFT","NavCube.top":"TOP","NavCube.bottom":"BOTTOM"};return function(B){const w=u?_:P,C=w?w[B]:null;return C?r.localeService.translate(C)||b[C]||C:B}}();this.setZUp=function(){u=!0,p=h,this.clear()},this.setYUp=function(){u=!1,p=d,this.clear()},this.clear=function(){g.fillStyle=i,g.fillRect(0,0,n,a);for(var P=0,_=p.length;P<_;P++){const b=p[P];b.highlighted=!1}x()},this.getArea=function(P){const _=P[0]*n,b=a-P[1]*a;for(var B=0,w=p.length;B<w;B++){const R=p[B].boundaries;for(var C=0,E=R.length;C<E;C++){const F=R[C];if(_>=F[0]*l&&_<=(F[0]+F[2])*l&&b>=F[1]*l&&b<=(F[1]+F[3])*l)return B}}return-1},this.setAreaHighlighted=function(P,_){var b=p[P];if(!b)throw"Area not found: "+P;b.highlighted=!!_,x()},this.getAreaDir=function(P){var _=p[P];if(!_)throw"Unknown area: "+P;return _.dir},this.getAreaUp=function(P){var _=p[P];if(!_)throw"Unknown area: "+P;return _.up},this.getImage=function(){return this._textureCanvas},this.destroy=function(){this._textureCanvas&&(this._textureCanvas.parentNode.removeChild(this._textureCanvas),this._textureCanvas=null)}}const Vp=A.vec3(),Hp=A.vec3();A.mat4();class GF extends Ro{constructor(e,t={}){super("NavCube",e,t),e.navCube=this;var i=!0;try{this._navCubeScene=new lc(e,{canvasId:t.canvasId,canvasElement:t.canvasElement,transparent:!0}),this._navCubeCanvas=this._navCubeScene.canvas.canvas,this._navCubeScene.input.keyboardEnabled=!1}catch(P){this.error(P);return}const s=this._navCubeScene;s.clearLights(),new bs(s,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new bs(s,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new bs(s,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._navCubeCamera=s.camera,this._navCubeCamera.ortho.scale=7,this._navCubeCamera.ortho.near=.1,this._navCubeCamera.ortho.far=2e3,s.edgeMaterial.edgeColor=[.2,.2,.2],s.edgeMaterial.edgeAlpha=.6,this._zUp=!!e.camera.zUp;var o=this;this.setIsProjectNorth(t.isProjectNorth),this.setProjectNorthOffsetAngle(t.projectNorthOffsetAngle);const a=function(){const P=A.mat4();return function(_,b,B){return A.identityMat4(P),A.rotationMat4v(_*o._projectNorthOffsetAngle*A.DEGTORAD,[0,1,0],P),A.transformVec3(P,b,B)}}();this._synchCamera=function(){var P=A.rotationMat4c(-90*A.DEGTORAD,1,0,0),_=A.vec3(),b=A.vec3(),B=A.vec3();return function(){var w=e.camera.eye,C=e.camera.look,E=e.camera.up;_=A.mulVec3Scalar(A.normalizeVec3(A.subVec3(w,C,_)),5),o._isProjectNorth&&o._projectNorthOffsetAngle&&(_=a(-1,_,Vp),E=a(-1,E,Hp)),o._zUp?(A.transformVec3(P,_,b),A.transformVec3(P,E,B),o._navCubeCamera.look=[0,0,0],o._navCubeCamera.eye=A.transformVec3(P,_,b),o._navCubeCamera.up=A.transformPoint3(P,E,B)):(o._navCubeCamera.look=[0,0,0],o._navCubeCamera.eye=_,o._navCubeCamera.up=E)}}(),this._cubeTextureCanvas=new kI(e,s,t),this._cubeSampler=new Tv(s,{image:this._cubeTextureCanvas.getImage(),flipY:!0,wrapS:Bs,wrapT:Bs}),this._cubeMesh=new ct(s,{geometry:new ti(s,{primitive:"triangles",normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),material:new gi(s,{diffuse:[.4,.4,.4],specular:[.4,.4,.4],emissive:[.6,.6,.6],diffuseMap:this._cubeSampler,emissiveMap:this._cubeSampler}),visible:!!i,edges:!0}),this._shadow=t.shadowVisible===!1?null:new ct(s,{geometry:new ti(s,_r({center:[0,0,0],radiusTop:.001,radiusBottom:1.4,height:.01,radialSegments:20,heightSegments:1,openEnded:!0})),material:new gi(s,{diffuse:[0,0,0],specular:[0,0,0],emissive:[0,0,0],alpha:.5}),position:[0,-1.5,0],visible:!!i,pickable:!1,backfaces:!1}),this._onCameraMatrix=e.camera.on("matrix",this._synchCamera),this._onCameraWorldAxis=e.camera.on("worldAxis",()=>{e.camera.zUp?(this._zUp=!0,this._cubeTextureCanvas.setZUp(),this._repaint(),this._synchCamera()):e.camera.yUp&&(this._zUp=!1,this._cubeTextureCanvas.setYUp(),this._repaint(),this._synchCamera())}),this._onCameraFOV=e.camera.perspective.on("fov",P=>{this._synchProjection&&(this._navCubeCamera.perspective.fov=P)}),this._onCameraProjection=e.camera.on("projection",P=>{this._synchProjection&&(this._navCubeCamera.projection=P==="ortho"||P==="perspective"?P:"perspective")});var n=-1;function l(P,_){var b=(P-u)*-g,B=(_-x)*-g;e.camera.orbitYaw(b),e.camera.orbitPitch(-B),u=P,x=_}function c(P){var _=[0,0];if(!P)P=window.event,_[0]=P.x,_[1]=P.y;else{for(var b=P.target,B=0,w=0;b.offsetParent;)B+=b.offsetLeft,w+=b.offsetTop,b=b.offsetParent;_[0]=P.pageX-B,_[1]=P.pageY-w}return _}{var h=null,d=null,p=!1,m=!1,g=.5,u,x;o._navCubeCanvas.addEventListener("mouseenter",o._onMouseEnter=function(P){m=!0}),o._navCubeCanvas.addEventListener("mouseleave",o._onMouseLeave=function(P){m=!1}),o._navCubeCanvas.addEventListener("mousedown",o._onMouseDown=function(P){if(P.which===1){h=P.x,d=P.y,u=P.clientX,x=P.clientY;var _=c(P),b=s.pick({canvasPos:_});b?p=!0:p=!1}}),document.addEventListener("mouseup",o._onMouseUp=function(P){if(P.which===1&&(p=!1,h!==null)){var _=c(P),b=s.pick({canvasPos:_,pickSurface:!0});if(b&&b.uv){var B=o._cubeTextureCanvas.getArea(b.uv);if(B>=0&&(document.body.style.cursor="pointer",n>=0&&(o._cubeTextureCanvas.setAreaHighlighted(n,!1),o._repaint(),n=-1),B>=0)){if(o._cubeTextureCanvas.setAreaHighlighted(B,!0),n=B,o._repaint(),P.x<h-3||P.x>h+3||P.y<d-3||P.y>d+3)return;var w=o._cubeTextureCanvas.getAreaDir(B);if(w){var C=o._cubeTextureCanvas.getAreaUp(B);o._isProjectNorth&&o._projectNorthOffsetAngle&&(w=a(1,w,Vp),C=a(1,C,Hp)),y(w,C,function(){n>=0&&(o._cubeTextureCanvas.setAreaHighlighted(n,!1),o._repaint(),n=-1),document.body.style.cursor="pointer",n>=0&&(o._cubeTextureCanvas.setAreaHighlighted(n,!1),o._repaint(),n=-1),B>=0&&(o._cubeTextureCanvas.setAreaHighlighted(B,!1),n=-1,o._repaint())})}}}}}),document.addEventListener("mousemove",o._onMouseMove=function(P){if(n>=0&&(o._cubeTextureCanvas.setAreaHighlighted(n,!1),o._repaint(),n=-1),!(P.buttons===1&&!p)){if(p){var _=P.clientX,b=P.clientY;document.body.style.cursor="move",l(_,b);return}if(m){var B=c(P),w=s.pick({canvasPos:B,pickSurface:!0});if(w){if(w.uv){document.body.style.cursor="pointer";var C=o._cubeTextureCanvas.getArea(w.uv);if(C===n)return;n>=0&&o._cubeTextureCanvas.setAreaHighlighted(n,!1),C>=0&&(o._cubeTextureCanvas.setAreaHighlighted(C,!0),o._repaint(),n=C)}}else document.body.style.cursor="default",n>=0&&(o._cubeTextureCanvas.setAreaHighlighted(n,!1),o._repaint(),n=-1)}}});var y=function(){var P=A.vec3();return function(_,b,B){var w=o._fitVisible?e.scene.getAABB(e.scene.visibleObjectIds):e.scene.aabb,C=A.getAABB3Diag(w);A.getAABB3Center(w,P);var E=Math.abs(C/Math.tan(o._cameraFitFOV*A.DEGTORAD));e.cameraControl.pivotPos=P,o._cameraFly?e.cameraFlight.flyTo({look:P,eye:[P[0]-E*_[0],P[1]-E*_[1],P[2]-E*_[2]],up:b||[0,1,0],orthoScale:C*1.1,fitFOV:o._cameraFitFOV,duration:o._cameraFlyDuration},B):e.cameraFlight.jumpTo({look:P,eye:[P[0]-E*_[0],P[1]-E*_[1],P[2]-E*_[2]],up:b||[0,1,0],orthoScale:C*1.1,fitFOV:o._cameraFitFOV},B)}}()}this._onUpdated=e.localeService.on("updated",()=>{this._cubeTextureCanvas.clear(),this._repaint()}),this.setVisible(t.visible),this.setCameraFitFOV(t.cameraFitFOV),this.setCameraFly(t.cameraFly),this.setCameraFlyDuration(t.cameraFlyDuration),this.setFitVisible(t.fitVisible),this.setSynchProjection(t.synchProjection)}send(e,t){switch(e){case"language":this._cubeTextureCanvas.clear(),this._repaint();break}}_repaint(){const e=this._cubeTextureCanvas.getImage();this._cubeMesh.material.diffuseMap.image=e,this._cubeMesh.material.emissiveMap.image=e}setVisible(e=!0){this._navCubeCanvas&&(this._cubeMesh.visible=e,this._shadow&&(this._shadow.visible=e),this._navCubeCanvas.style.visibility=e?"visible":"hidden")}getVisible(){return this._navCubeCanvas?this._cubeMesh.visible:!1}setFitVisible(e=!1){this._fitVisible=e}getFitVisible(){return this._fitVisible}setCameraFly(e=!0){this._cameraFly=e}getCameraFly(){return this._cameraFly}setCameraFitFOV(e=45){this._cameraFitFOV=e}getCameraFitFOV(){return this._cameraFitFOV}setCameraFlyDuration(e=.5){this._cameraFlyDuration=e}getCameraFlyDuration(){return this._cameraFlyDuration}setSynchProjection(e=!1){this._synchProjection=e}getSynchProjection(){return this._synchProjection}setIsProjectNorth(e=!1){this._isProjectNorth=e}getIsProjectNorth(){return this._isProjectNorth}setProjectNorthOffsetAngle(e){this._projectNorthOffsetAngle=e}getProjectNorthOffsetAngle(){return this._projectNorthOffsetAngle}destroy(){this._navCubeCanvas&&(this.viewer.localeService.off(this._onUpdated),this.viewer.camera.off(this._onCameraMatrix),this.viewer.camera.off(this._onCameraWorldAxis),this.viewer.camera.perspective.off(this._onCameraFOV),this.viewer.camera.off(this._onCameraProjection),this._navCubeCanvas.removeEventListener("mouseenter",this._onMouseEnter),this._navCubeCanvas.removeEventListener("mouseleave",this._onMouseLeave),this._navCubeCanvas.removeEventListener("mousedown",this._onMouseDown),document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),this._navCubeCanvas=null,this._cubeTextureCanvas.destroy(),this._cubeTextureCanvas=null,this._onMouseEnter=null,this._onMouseLeave=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null),this._navCubeScene.destroy(),this._navCubeScene=null,this._cubeMesh=null,this._shadow=null,super.destroy()}}A.vec3();const NI=new Float64Array([0,0,1]),QI=new Float64Array(4);class VI{constructor(e){this.id=null,this._viewer=e.viewer,this._visible=!1,this._pos=A.vec3(),this._origin=A.vec3(),this._rtcPos=A.vec3(),this._baseDir=A.vec3(),this._rootNode=null,this._displayMeshes=null,this._affordanceMeshes=null,this._ignoreNextSectionPlaneDirUpdate=!1,this._createNodes(),this._bindEvents()}_setSectionPlane(e){this._sectionPlane&&(this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._onSectionPlanePos=null,this._onSectionPlaneDir=null,this._sectionPlane=null),e&&(this.id=e.id,this._setPos(e.pos),this._setDir(e.dir),this._sectionPlane=e,this._onSectionPlanePos=e.on("pos",()=>{this._setPos(this._sectionPlane.pos)}),this._onSectionPlaneDir=e.on("dir",()=>{this._ignoreNextSectionPlaneDirUpdate?this._ignoreNextSectionPlaneDirUpdate=!1:this._setDir(this._sectionPlane.dir)}))}get sectionPlane(){return this._sectionPlane}_setPos(e){this._pos.set(e),ma(this._pos,this._origin,this._rtcPos),this._rootNode.origin=this._origin,this._rootNode.position=this._rtcPos}_setDir(e){this._baseDir.set(e),this._rootNode.quaternion=A.vec3PairToQuaternion(NI,e,QI)}_setSectionPlaneDir(e){this._sectionPlane&&(this._ignoreNextSectionPlaneDirUpdate=!0,this._sectionPlane.dir=e)}setVisible(e=!0){if(this._visible!==e){this._visible=e;var t;for(t in this._displayMeshes)this._displayMeshes.hasOwnProperty(t)&&(this._displayMeshes[t].visible=e);if(!e)for(t in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(t)&&(this._affordanceMeshes[t].visible=e)}}getVisible(){return this._visible}setCulled(e){var t;for(t in this._displayMeshes)this._displayMeshes.hasOwnProperty(t)&&(this._displayMeshes[t].culled=e);if(!e)for(t in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(t)&&(this._affordanceMeshes[t].culled=e)}_createNodes(){const t=this._viewer.scene,i=1,s=.06,o=i-.2,a=.01,n=.07;this._rootNode=new Sv(t,{position:[0,0,0],scale:[5,5,5],isObject:!1});const l=this._rootNode,c={arrowHead:new ti(l,_r({radiusTop:.001,radiusBottom:n,radialSegments:32,heightSegments:1,height:.2,openEnded:!1})),arrowHeadBig:new ti(l,_r({radiusTop:.001,radiusBottom:.09,radialSegments:32,heightSegments:1,height:.25,openEnded:!1})),arrowHeadHandle:new ti(l,_r({radiusTop:.09,radiusBottom:.09,radialSegments:8,heightSegments:1,height:.37,openEnded:!1})),curve:new ti(l,Gr({radius:o,tube:a,radialSegments:64,tubeSegments:14,arc:Math.PI*2/4})),curveHandle:new ti(l,Gr({radius:o,tube:s,radialSegments:64,tubeSegments:14,arc:Math.PI*2/4})),hoop:new ti(l,Gr({radius:o,tube:a,radialSegments:64,tubeSegments:8,arc:Math.PI*2})),axis:new ti(l,_r({radiusTop:a,radiusBottom:a,radialSegments:20,heightSegments:1,height:i,openEnded:!1})),axisHandle:new ti(l,_r({radiusTop:.08,radiusBottom:.08,radialSegments:20,heightSegments:1,height:i,openEnded:!1}))},h={pickable:new gi(l,{diffuse:[1,1,0],alpha:0,alphaMode:"blend"}),red:new gi(l,{diffuse:[1,0,0],emissive:[1,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightRed:new _i(l,{edges:!1,fill:!0,fillColor:[1,0,0],fillAlpha:.6}),green:new gi(l,{diffuse:[0,1,0],emissive:[0,1,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightGreen:new _i(l,{edges:!1,fill:!0,fillColor:[0,1,0],fillAlpha:.6}),blue:new gi(l,{diffuse:[0,0,1],emissive:[0,0,1],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightBlue:new _i(l,{edges:!1,fill:!0,fillColor:[0,0,1],fillAlpha:.2}),center:new gi(l,{diffuse:[0,0,0],emissive:[0,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80}),highlightBall:new _i(l,{edges:!1,fill:!0,fillColor:[.5,.5,.5],fillAlpha:.5,vertices:!1}),highlightPlane:new _i(l,{edges:!0,edgeWidth:3,fill:!1,fillColor:[.5,.5,.5],fillAlpha:.5,vertices:!1})};this._displayMeshes={plane:l.addChild(new ct(l,{geometry:new ti(l,{primitive:"triangles",positions:[.5,.5,0,.5,-.5,0,-.5,-.5,0,-.5,.5,0,.5,.5,-0,.5,-.5,-0,-.5,-.5,-0,-.5,.5,-0],indices:[0,1,2,2,3,0]}),material:new gi(l,{emissive:[0,0,0],diffuse:[0,0,0],backfaces:!0}),opacity:.6,ghosted:!0,ghostMaterial:new _i(l,{edges:!1,filled:!0,fillColor:[1,1,0],edgeColor:[0,0,0],fillAlpha:.1,backfaces:!0}),pickable:!1,collidable:!0,clippable:!1,visible:!1,scale:[2.4,2.4,1],isObject:!1}),!1),planeFrame:l.addChild(new ct(l,{geometry:new ti(l,Gr({center:[0,0,0],radius:1.7,tube:a*2,radialSegments:4,tubeSegments:4,arc:Math.PI*2})),material:new gi(l,{emissive:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],shininess:0}),highlightMaterial:new _i(l,{edges:!1,edgeColor:[0,0,0],filled:!0,fillColor:[.8,.8,.8],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,.1],rotation:[0,0,45],isObject:!1}),!1),xCurve:l.addChild(new ct(l,{geometry:c.curve,material:h.red,matrix:function(){const d=A.rotationMat4v(90*A.DEGTORAD,[0,1,0],A.identityMat4()),p=A.rotationMat4v(270*A.DEGTORAD,[1,0,0],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1,isObject:!1}),!1),xCurveHandle:l.addChild(new ct(l,{geometry:c.curveHandle,material:h.pickable,matrix:function(){const d=A.rotationMat4v(90*A.DEGTORAD,[0,1,0],A.identityMat4()),p=A.rotationMat4v(270*A.DEGTORAD,[1,0,0],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,backfaces:!0,visible:!1,isObject:!1}),!1),xCurveArrow1:l.addChild(new ct(l,{geometry:c.arrowHead,material:h.red,matrix:function(){const d=A.translateMat4c(0,-.07,-.8,A.identityMat4()),p=A.scaleMat4v([.6,.6,.6],A.identityMat4()),m=A.rotationMat4v(0*A.DEGTORAD,[0,0,1],A.identityMat4());return A.mulMat4(A.mulMat4(d,p,A.identityMat4()),m,A.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),xCurveArrow2:l.addChild(new ct(l,{geometry:c.arrowHead,material:h.red,matrix:function(){const d=A.translateMat4c(0,-.8,-.07,A.identityMat4()),p=A.scaleMat4v([.6,.6,.6],A.identityMat4()),m=A.rotationMat4v(90*A.DEGTORAD,[1,0,0],A.identityMat4());return A.mulMat4(A.mulMat4(d,p,A.identityMat4()),m,A.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),yCurve:l.addChild(new ct(l,{geometry:c.curve,material:h.green,rotation:[-90,0,0],pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1,isObject:!1}),!1),yCurveHandle:l.addChild(new ct(l,{geometry:c.curveHandle,material:h.pickable,rotation:[-90,0,0],pickable:!0,collidable:!0,clippable:!1,backfaces:!0,visible:!1,isObject:!1}),!1),yCurveArrow1:l.addChild(new ct(l,{geometry:c.arrowHead,material:h.green,matrix:function(){const d=A.translateMat4c(.07,0,-.8,A.identityMat4()),p=A.scaleMat4v([.6,.6,.6],A.identityMat4()),m=A.rotationMat4v(90*A.DEGTORAD,[0,0,1],A.identityMat4());return A.mulMat4(A.mulMat4(d,p,A.identityMat4()),m,A.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),yCurveArrow2:l.addChild(new ct(l,{geometry:c.arrowHead,material:h.green,matrix:function(){const d=A.translateMat4c(.8,0,-.07,A.identityMat4()),p=A.scaleMat4v([.6,.6,.6],A.identityMat4()),m=A.rotationMat4v(90*A.DEGTORAD,[1,0,0],A.identityMat4());return A.mulMat4(A.mulMat4(d,p,A.identityMat4()),m,A.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),zCurve:l.addChild(new ct(l,{geometry:c.curve,material:h.blue,matrix:A.rotationMat4v(180*A.DEGTORAD,[1,0,0],A.identityMat4()),pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),zCurveHandle:l.addChild(new ct(l,{geometry:c.curveHandle,material:h.pickable,matrix:A.rotationMat4v(180*A.DEGTORAD,[1,0,0],A.identityMat4()),pickable:!0,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),zCurveCurveArrow1:l.addChild(new ct(l,{geometry:c.arrowHead,material:h.blue,matrix:function(){const d=A.translateMat4c(.8,-.07,0,A.identityMat4()),p=A.scaleMat4v([.6,.6,.6],A.identityMat4());return A.mulMat4(d,p,A.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),zCurveArrow2:l.addChild(new ct(l,{geometry:c.arrowHead,material:h.blue,matrix:function(){const d=A.translateMat4c(.05,-.8,0,A.identityMat4()),p=A.scaleMat4v([.6,.6,.6],A.identityMat4()),m=A.rotationMat4v(90*A.DEGTORAD,[0,0,1],A.identityMat4());return A.mulMat4(A.mulMat4(d,p,A.identityMat4()),m,A.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),center:l.addChild(new ct(l,{geometry:new ti(l,Df({radius:.05})),material:h.center,pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),xAxisArrow:l.addChild(new ct(l,{geometry:c.arrowHead,material:h.red,matrix:function(){const d=A.translateMat4c(0,i+.1,0,A.identityMat4()),p=A.rotationMat4v(-90*A.DEGTORAD,[0,0,1],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),xAxisArrowHandle:l.addChild(new ct(l,{geometry:c.arrowHeadHandle,material:h.pickable,matrix:function(){const d=A.translateMat4c(0,i+.1,0,A.identityMat4()),p=A.rotationMat4v(-90*A.DEGTORAD,[0,0,1],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),xAxis:l.addChild(new ct(l,{geometry:c.axis,material:h.red,matrix:function(){const d=A.translateMat4c(0,i/2,0,A.identityMat4()),p=A.rotationMat4v(-90*A.DEGTORAD,[0,0,1],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),xAxisHandle:l.addChild(new ct(l,{geometry:c.axisHandle,material:h.pickable,matrix:function(){const d=A.translateMat4c(0,i/2,0,A.identityMat4()),p=A.rotationMat4v(-90*A.DEGTORAD,[0,0,1],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),yAxisArrow:l.addChild(new ct(l,{geometry:c.arrowHead,material:h.green,matrix:function(){const d=A.translateMat4c(0,i+.1,0,A.identityMat4()),p=A.rotationMat4v(180*A.DEGTORAD,[1,0,0],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),yAxisArrowHandle:l.addChild(new ct(l,{geometry:c.arrowHeadHandle,material:h.pickable,matrix:function(){const d=A.translateMat4c(0,i+.1,0,A.identityMat4()),p=A.rotationMat4v(180*A.DEGTORAD,[1,0,0],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,opacity:.2,isObject:!1}),!1),yShaft:l.addChild(new ct(l,{geometry:c.axis,material:h.green,position:[0,-i/2,0],pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),yShaftHandle:l.addChild(new ct(l,{geometry:c.axisHandle,material:h.pickable,position:[0,-i/2,0],pickable:!0,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),zAxisArrow:l.addChild(new ct(l,{geometry:c.arrowHead,material:h.blue,matrix:function(){const d=A.translateMat4c(0,i+.1,0,A.identityMat4()),p=A.rotationMat4v(-90*A.DEGTORAD,[.8,0,0],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),zAxisArrowHandle:l.addChild(new ct(l,{geometry:c.arrowHeadHandle,material:h.pickable,matrix:function(){const d=A.translateMat4c(0,i+.1,0,A.identityMat4()),p=A.rotationMat4v(-90*A.DEGTORAD,[.8,0,0],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),zShaft:l.addChild(new ct(l,{geometry:c.axis,material:h.blue,matrix:function(){const d=A.translateMat4c(0,i/2,0,A.identityMat4()),p=A.rotationMat4v(-90*A.DEGTORAD,[1,0,0],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),clippable:!1,pickable:!1,collidable:!0,visible:!1,isObject:!1}),!1),zAxisHandle:l.addChild(new ct(l,{geometry:c.axisHandle,material:h.pickable,matrix:function(){const d=A.translateMat4c(0,i/2,0,A.identityMat4()),p=A.rotationMat4v(-90*A.DEGTORAD,[1,0,0],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),clippable:!1,pickable:!0,collidable:!0,visible:!1,isObject:!1}),!1)},this._affordanceMeshes={planeFrame:l.addChild(new ct(l,{geometry:new ti(l,Gr({center:[0,0,0],radius:2,tube:a,radialSegments:4,tubeSegments:4,arc:Math.PI*2})),material:new gi(l,{ambient:[1,1,1],diffuse:[0,0,0],emissive:[1,1,0]}),highlighted:!0,highlightMaterial:new _i(l,{edges:!1,filled:!0,fillColor:[1,1,0],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,1],rotation:[0,0,45],isObject:!1}),!1),xHoop:l.addChild(new ct(l,{geometry:c.hoop,material:h.red,highlighted:!0,highlightMaterial:h.highlightRed,matrix:function(){const d=A.rotationMat4v(90*A.DEGTORAD,[0,1,0],A.identityMat4()),p=A.rotationMat4v(270*A.DEGTORAD,[1,0,0],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),yHoop:l.addChild(new ct(l,{geometry:c.hoop,material:h.green,highlighted:!0,highlightMaterial:h.highlightGreen,rotation:[-90,0,0],pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),zHoop:l.addChild(new ct(l,{geometry:c.hoop,material:h.blue,highlighted:!0,highlightMaterial:h.highlightBlue,matrix:A.rotationMat4v(180*A.DEGTORAD,[1,0,0],A.identityMat4()),pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1,isObject:!1}),!1),xAxisArrow:l.addChild(new ct(l,{geometry:c.arrowHeadBig,material:h.red,matrix:function(){const d=A.translateMat4c(0,i+.1,0,A.identityMat4()),p=A.rotationMat4v(-90*A.DEGTORAD,[0,0,1],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),yAxisArrow:l.addChild(new ct(l,{geometry:c.arrowHeadBig,material:h.green,matrix:function(){const d=A.translateMat4c(0,i+.1,0,A.identityMat4()),p=A.rotationMat4v(180*A.DEGTORAD,[1,0,0],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1),zAxisArrow:l.addChild(new ct(l,{geometry:c.arrowHeadBig,material:h.blue,matrix:function(){const d=A.translateMat4c(0,i+.1,0,A.identityMat4()),p=A.rotationMat4v(-90*A.DEGTORAD,[.8,0,0],A.identityMat4());return A.mulMat4(p,d,A.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),!1)}}_bindEvents(){const e=this;var t=!1;const i={none:-1,xTranslate:0,yTranslate:1,zTranslate:2,xRotate:3,yRotate:4,zRotate:5},s=this._rootNode;var o=null,a=null;const n=A.vec2(),l=A.vec3([1,0,0]),c=A.vec3([0,1,0]),h=A.vec3([0,0,1]),d=this._viewer.scene.canvas.canvas,p=this._viewer.camera,m=this._viewer.scene;{const C=A.vec3([0,0,0]);let E=-1;this._onCameraViewMatrix=m.camera.on("viewMatrix",()=>{}),this._onCameraProjMatrix=m.camera.on("projMatrix",()=>{}),this._onSceneTick=m.on("tick",()=>{const I=Math.abs(A.lenVec3(A.subVec3(m.camera.eye,this._pos,C)));if(I!==E&&p.projection==="perspective"){const F=.07*(Math.tan(p.perspective.fov*A.DEGTORAD)*I);s.scale=[F,F,F],E=I}if(p.projection==="ortho"){const F=p.ortho.scale/10;s.scale=[F,F,F],E=I}})}const g=function(){const C=new Float64Array(2);return function(E){if(!E)E=window.event,C[0]=E.x,C[1]=E.y;else{for(var I=E.target,R=0,F=0;I.offsetParent;)R+=I.offsetLeft,F+=I.offsetTop,I=I.offsetParent;C[0]=E.pageX-R,C[1]=E.pageY-F}return C}}(),u=function(){const C=A.mat4();return function(E,I){return A.quaternionToMat4(e._rootNode.quaternion,C),A.transformVec3(C,E,I),A.normalizeVec3(I),I}}();var x=function(){const C=A.vec3();return function(E){const I=Math.abs(E[0]);return I>Math.abs(E[1])&&I>Math.abs(E[2])?A.cross3Vec3(E,[0,1,0],C):A.cross3Vec3(E,[1,0,0],C),A.cross3Vec3(C,E,C),A.normalizeVec3(C),C}}();const y=function(){const C=A.vec3(),E=A.vec3(),I=A.vec4();return function(R,F,z){u(R,I);const Q=x(I,F,z);_(F,Q,C),_(z,Q,E),A.subVec3(E,C);const H=A.dotVec3(E,I);e._pos[0]+=I[0]*H,e._pos[1]+=I[1]*H,e._pos[2]+=I[2]*H,e._rootNode.position=e._pos,e._sectionPlane&&(e._sectionPlane.pos=e._pos)}}();var P=function(){const C=A.vec4(),E=A.vec4(),I=A.vec4(),R=A.vec4();return function(F,z,Q){if(u(F,R),!(_(z,R,C)&&_(Q,R,E))){const ge=x(R,z,Q);_(z,ge,C,1),_(Q,ge,E,1);var ae=A.dotVec3(C,R);C[0]-=ae*R[0],C[1]-=ae*R[1],C[2]-=ae*R[2],ae=A.dotVec3(E,R),E[0]-=ae*R[0],E[1]-=ae*R[1],E[2]-=ae*R[2]}A.normalizeVec3(C),A.normalizeVec3(E),ae=A.dotVec3(C,E),ae=A.clamp(ae,-1,1);var pe=Math.acos(ae)*A.RADTODEG;A.cross3Vec3(C,E,I),A.dotVec3(I,R)<0&&(pe=-pe),e._rootNode.rotate(F,pe),b()}}(),_=function(){const C=A.vec4([0,0,0,1]),E=A.mat4();return function(I,R,F,z){z=z||0,C[0]=I[0]/d.width*2-1,C[1]=-(I[1]/d.height*2-1),C[2]=0,C[3]=1,A.mulMat4(p.projMatrix,p.viewMatrix,E),A.inverseMat4(E),A.transformVec4(E,C,C),A.mulVec4Scalar(C,1/C[3]);var Q=p.eye;A.subVec4(C,Q,C);const H=e._sectionPlane.pos;var ae=-A.dotVec3(H,R)-z,pe=A.dotVec3(R,C);if(Math.abs(pe)>.005){var ge=-(A.dotVec3(R,Q)+ae)/pe;return A.mulVec3Scalar(C,ge,F),A.addVec3(F,Q),A.subVec3(F,H,F),!0}return!1}}();const b=function(){const C=A.vec3(),E=A.mat4();return function(){e.sectionPlane&&(A.quaternionToMat4(s.quaternion,E),A.transformVec3(E,[0,0,1],C),e._setSectionPlaneDir(C))}}();{var B=!1,w;this._onCameraControlHover=this._viewer.cameraControl.on("hoverEnter",C=>{if(!this._visible||B)return;t=!1,w&&(w.visible=!1);var E;switch(C.entity.id){case this._displayMeshes.xAxisArrowHandle.id:E=this._affordanceMeshes.xAxisArrow,o=i.xTranslate;break;case this._displayMeshes.xAxisHandle.id:E=this._affordanceMeshes.xAxisArrow,o=i.xTranslate;break;case this._displayMeshes.yAxisArrowHandle.id:E=this._affordanceMeshes.yAxisArrow,o=i.yTranslate;break;case this._displayMeshes.yShaftHandle.id:E=this._affordanceMeshes.yAxisArrow,o=i.yTranslate;break;case this._displayMeshes.zAxisArrowHandle.id:E=this._affordanceMeshes.zAxisArrow,o=i.zTranslate;break;case this._displayMeshes.zAxisHandle.id:E=this._affordanceMeshes.zAxisArrow,o=i.zTranslate;break;case this._displayMeshes.xCurveHandle.id:E=this._affordanceMeshes.xHoop,o=i.xRotate;break;case this._displayMeshes.yCurveHandle.id:E=this._affordanceMeshes.yHoop,o=i.yRotate;break;case this._displayMeshes.zCurveHandle.id:E=this._affordanceMeshes.zHoop,o=i.zRotate;break;default:o=i.none;return}E&&(E.visible=!0),w=E,t=!0}),this._onCameraControlHoverLeave=this._viewer.cameraControl.on("hoverOutEntity",C=>{this._visible&&(w&&(w.visible=!1),w=null,o=i.none)}),d.addEventListener("mousedown",this._canvasMouseDownListener=C=>{if(C.preventDefault(),!!this._visible&&t)switch(this._viewer.cameraControl.pointerEnabled=!1,C.which){case 1:B=!0;var E=g(C);a=o,n[0]=E[0],n[1]=E[1];break}}),d.addEventListener("mousemove",this._canvasMouseMoveListener=C=>{if(!this._visible||!B)return;var E=g(C);const I=E[0],R=E[1];switch(a){case i.xTranslate:y(l,n,E);break;case i.yTranslate:y(c,n,E);break;case i.zTranslate:y(h,n,E);break;case i.xRotate:P(l,n,E);break;case i.yRotate:P(c,n,E);break;case i.zRotate:P(h,n,E);break}n[0]=I,n[1]=R}),d.addEventListener("mouseup",this._canvasMouseUpListener=C=>{if(this._visible&&(this._viewer.cameraControl.pointerEnabled=!0,!!B)){switch(C.which){}B=!1,t=!1}}),d.addEventListener("wheel",this._canvasWheelListener=C=>{if(this._visible)var E=Math.max(-1,Math.min(1,-C.deltaY*40))})}}_destroy(){this._unbindEvents(),this._destroyNodes()}_unbindEvents(){const e=this._viewer,t=e.scene,i=t.canvas.canvas,s=e.camera,o=e.cameraControl;t.off(this._onSceneTick),i.removeEventListener("mousedown",this._canvasMouseDownListener),i.removeEventListener("mousemove",this._canvasMouseMoveListener),i.removeEventListener("mouseup",this._canvasMouseUpListener),i.removeEventListener("wheel",this._canvasWheelListener),s.off(this._onCameraViewMatrix),s.off(this._onCameraProjMatrix),o.off(this._onCameraControlHover),o.off(this._onCameraControlHoverLeave)}_destroyNodes(){this._setSectionPlane(null),this._rootNode.destroy(),this._displayMeshes={},this._affordanceMeshes={}}}class HI{constructor(e,t,i){this.id=i.id,this._sectionPlane=i,this._mesh=new ct(t,{id:i.id,geometry:new ti(t,xf({xSize:.5,ySize:.5,zSize:.001})),material:new gi(t,{emissive:[1,1,1],diffuse:[0,0,0],backfaces:!1}),edgeMaterial:new yf(t,{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),highlightMaterial:new _i(t,{fill:!0,fillColor:[.5,1,.5],fillAlpha:.7,edges:!0,edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),selectedMaterial:new _i(t,{fill:!0,fillColor:[0,0,1],fillAlpha:.7,edges:!0,edgeColor:[1,0,0],edgeAlpha:1,edgeWidth:1}),highlighted:!0,scale:[3,3,3],position:[0,0,0],rotation:[0,0,0],opacity:.3,edges:!0});{const s=A.vec3([0,0,0]),o=A.vec3(),a=A.vec3([0,0,1]),n=A.vec4(4),l=A.vec3(),c=()=>{const h=this._sectionPlane.scene.center,d=[-this._sectionPlane.dir[0],-this._sectionPlane.dir[1],-this._sectionPlane.dir[2]];A.subVec3(h,this._sectionPlane.pos,s);const p=-A.dotVec3(d,s);A.normalizeVec3(d),A.mulVec3Scalar(d,p,o);const m=A.vec3PairToQuaternion(a,this._sectionPlane.dir,n);l[0]=o[0]*.1,l[1]=o[1]*.1,l[2]=o[2]*.1,this._mesh.quaternion=m,this._mesh.position=l};this._onSectionPlanePos=this._sectionPlane.on("pos",c),this._onSectionPlaneDir=this._sectionPlane.on("dir",c)}this._highlighted=!1,this._selected=!1}setHighlighted(e){this._highlighted=!!e,this._mesh.highlighted=this._highlighted,this._mesh.highlightMaterial.fillColor=e?[0,.7,0]:[0,0,0]}getHighlighted(){return this._highlighted}setSelected(e){this._selected=!!e,this._mesh.edgeMaterial.edgeWidth=e?3:1,this._mesh.highlightMaterial.edgeWidth=e?3:1}getSelected(){return this._selected}destroy(){this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._mesh.destroy()}}class jI{constructor(e,t){if(!t.onHoverEnterPlane||!t.onHoverLeavePlane||!t.onClickedNothing||!t.onClickedPlane)throw"Missing config(s): onHoverEnterPlane, onHoverLeavePlane, onClickedNothing || onClickedPlane";this.plugin=e,this._viewer=e.viewer,this._onHoverEnterPlane=t.onHoverEnterPlane,this._onHoverLeavePlane=t.onHoverLeavePlane,this._onClickedNothing=t.onClickedNothing,this._onClickedPlane=t.onClickedPlane,this._visible=!0,this._planes={},this._canvas=t.overviewCanvas,this._scene=new lc(this._viewer,{canvasId:this._canvas.id,transparent:!0}),this._scene.clearLights(),new bs(this._scene,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new bs(this._scene,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new bs(this._scene,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._scene.camera,this._scene.camera.perspective.fov=70,this._zUp=!1;{const s=this._scene.camera,o=A.rotationMat4c(-90*A.DEGTORAD,1,0,0),a=A.vec3(),n=A.vec3(),l=A.vec3();this._synchCamera=()=>{const c=this._viewer.camera.eye,h=this._viewer.camera.look,d=this._viewer.camera.up;A.mulVec3Scalar(A.normalizeVec3(A.subVec3(c,h,a)),7),this._zUp?(A.transformVec3(o,a,n),A.transformVec3(o,d,l),s.look=[0,0,0],s.eye=A.transformVec3(o,a,n),s.up=A.transformPoint3(o,d,l)):(s.look=[0,0,0],s.eye=a,s.up=d)}}this._onViewerCameraMatrix=this._viewer.camera.on("matrix",this._synchCamera),this._onViewerCameraWorldAxis=this._viewer.camera.on("worldAxis",this._synchCamera),this._onViewerCameraFOV=this._viewer.camera.perspective.on("fov",s=>{this._scene.camera.perspective.fov=s});{var i=null;this._onInputMouseMove=this._scene.input.on("mousemove",s=>{const o=this._scene.pick({canvasPos:s});o?(!i||o.entity.id!==i.id)&&(i&&this._planes[i.id]&&this._onHoverLeavePlane(i.id),i=o.entity,this._planes[i.id]&&this._onHoverEnterPlane(i.id)):i&&(this._onHoverLeavePlane(i.id),i=null)}),this._scene.canvas.canvas.addEventListener("mouseup",this._onCanvasMouseUp=()=>{i?this._planes[i.id]&&this._onClickedPlane(i.id):this._onClickedNothing()}),this._scene.canvas.canvas.addEventListener("mouseout",this._onCanvasMouseOut=()=>{i&&(this._onHoverLeavePlane(i.id),i=null)})}this.setVisible(t.overviewVisible)}addSectionPlane(e){this._planes[e.id]=new HI(this,this._scene,e)}setPlaneHighlighted(e,t){const i=this._planes[e];i&&i.setHighlighted(t)}setPlaneSelected(e,t){const i=this._planes[e];i&&i.setSelected(t)}removeSectionPlane(e){const t=this._planes[e.id];t&&(t.destroy(),delete this._planes[e.id])}setVisible(e=!0){this._visible=e,this._canvas.style.visibility=e?"visible":"hidden"}getVisible(){return this._visible}destroy(){this._viewer.camera.off(this._onViewerCameraMatrix),this._viewer.camera.off(this._onViewerCameraWorldAxis),this._viewer.camera.perspective.off(this._onViewerCameraFOV),this._scene.input.off(this._onInputMouseMove),this._scene.canvas.canvas.removeEventListener("mouseup",this._onCanvasMouseUp),this._scene.canvas.canvas.removeEventListener("mouseout",this._onCanvasMouseOut),this._scene.destroy()}}const es=A.AABB3(),Os=A.vec3();class WF extends Ro{constructor(e,t={}){if(super("SectionPlanes",e),this._freeControls=[],this._sectionPlanes=e.scene.sectionPlanes,this._controls={},this._shownControlId=null,t.overviewCanvasId!==null&&t.overviewCanvasId!==void 0){const i=document.getElementById(t.overviewCanvasId);i?this._overview=new jI(this,{overviewCanvas:i,visible:t.overviewVisible,onHoverEnterPlane:s=>{this._overview.setPlaneHighlighted(s,!0)},onHoverLeavePlane:s=>{this._overview.setPlaneHighlighted(s,!1)},onClickedPlane:s=>{if(this.getShownControl()===s){this.hideControl();return}this.showControl(s);const a=this.sectionPlanes[s].pos;es.set(this.viewer.scene.aabb),A.getAABB3Center(es,Os),es[0]+=a[0]-Os[0],es[1]+=a[1]-Os[1],es[2]+=a[2]-Os[2],es[3]+=a[0]-Os[0],es[4]+=a[1]-Os[1],es[5]+=a[2]-Os[2],this.viewer.cameraFlight.flyTo({aabb:es,fitFOV:65})},onClickedNothing:()=>{this.hideControl()}}):this.warn("Can't find overview canvas: '"+t.overviewCanvasId+"' - will create plugin without overview")}this._onSceneSectionPlaneCreated=e.scene.on("sectionPlaneCreated",i=>{this._sectionPlaneCreated(i)})}setOverviewVisible(e){this._overview&&this._overview.setVisible(e)}getOverviewVisible(){if(this._overview)return this._overview.getVisible()}get sectionPlanes(){return this._sectionPlanes}createSectionPlane(e={}){return e.id!==void 0&&e.id!==null&&this.viewer.scene.components[e.id]&&(this.error("Viewer component with this ID already exists: "+e.id),delete e.id),new Iv(this.viewer.scene,{id:e.id,pos:e.pos,dir:e.dir,active:!0})}_sectionPlaneCreated(e){const t=this._freeControls.length>0?this._freeControls.pop():new VI(this);t._setSectionPlane(e),t.setVisible(!1),this._controls[e.id]=t,this._overview&&this._overview.addSectionPlane(e),e.once("destroyed",()=>{this._sectionPlaneDestroyed(e)})}flipSectionPlanes(){const e=this.viewer.scene.sectionPlanes;for(let t in e)e[t].flipDir()}showControl(e){const t=this._controls[e];if(!t){this.error("Control not found: "+e);return}this.hideControl(),t.setVisible(!0),this._overview&&this._overview.setPlaneSelected(e,!0),this._shownControlId=e}getShownControl(){return this._shownControlId}hideControl(){for(var e in this._controls)this._controls.hasOwnProperty(e)&&(this._controls[e].setVisible(!1),this._overview&&this._overview.setPlaneSelected(e,!1));this._shownControlId=null}destroySectionPlane(e){var t=this.viewer.scene.sectionPlanes[e];if(!t){this.error("SectionPlane not found: "+e);return}this._sectionPlaneDestroyed(t),t.destroy(),e===this._shownControlId&&(this._shownControlId=null)}_sectionPlaneDestroyed(e){this._overview&&this._overview.removeSectionPlane(e);const t=this._controls[e.id];t&&(t.setVisible(!1),t._setSectionPlane(null),delete this._controls[e.id],this._freeControls.push(t))}clear(){const e=Object.keys(this._sectionPlanes);for(var t=0,i=e.length;t<i;t++)this.destroySectionPlane(e[t])}send(e,t){switch(e){case"snapshotStarting":for(let i in this._controls)this._controls.hasOwnProperty(i)&&this._controls[i].setCulled(!0);break;case"snapshotFinished":for(let i in this._controls)this._controls.hasOwnProperty(i)&&this._controls[i].setCulled(!1);break;case"clearSectionPlanes":this.clear();break}}destroy(){this.clear(),this._overview&&this._overview.destroy(),this._destroyFreeControls(),super.destroy()}_destroyFreeControls(){for(var e=this._freeControls.pop();e;)e._destroy(),e=this._freeControls.pop();this.viewer.scene.off(this._onSceneSectionPlaneCreated)}}A.vec3();A.mat4();A.AABB3();A.vec3();A.vec3();class zI{constructor(e={}){this.cacheBuster=e.cacheBuster!==!1}_cacheBusterURL(e){if(!this.cacheBuster)return e;const t=new Date().getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}getManifest(e,t,i){we.loadJSON(this._cacheBusterURL(e),s=>{t(s)},function(s){i(s)})}getMetaModel(e,t,i){we.loadJSON(this._cacheBusterURL(e),s=>{t(s)},function(s){i(s)})}getXKT(e,t,i){var s=()=>{};t=t||s,i=i||s;const o=/^data:(.*?)(;base64)?,(.*)$/,a=e.match(o);if(a){const c=!!a[2];var n=a[3];n=window.decodeURIComponent(n),c&&(n=window.atob(n));try{const h=new ArrayBuffer(n.length),d=new Uint8Array(h);for(var l=0;l<n.length;l++)d[l]=n.charCodeAt(l);t(h)}catch(h){i(h)}}else{const c=new XMLHttpRequest;c.open("GET",this._cacheBusterURL(e),!0),c.responseType="arraybuffer",c.onreadystatechange=function(){c.readyState===4&&(c.status===200?t(c.response):i("getXKT error : "+c.response))},c.send(null)}}}/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */(function(r,e){typeof exports=="object"&&typeof module<"u"?e(exports):typeof define=="function"&&define.amd?define(["exports"],e):e((r=typeof globalThis<"u"?globalThis:r||self).pako={})})(void 0,function(r){function e(f){let M=f.length;for(;--M>=0;)f[M]=0}const t=256,i=286,s=30,o=15,a=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),n=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),l=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),c=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),h=new Array(576);e(h);const d=new Array(60);e(d);const p=new Array(512);e(p);const m=new Array(256);e(m);const g=new Array(29);e(g);const u=new Array(s);function x(f,M,v,U,L){this.static_tree=f,this.extra_bits=M,this.extra_base=v,this.elems=U,this.max_length=L,this.has_stree=f&&f.length}let y,P,_;function b(f,M){this.dyn_tree=f,this.max_code=0,this.stat_desc=M}e(u);const B=f=>f<256?p[f]:p[256+(f>>>7)],w=(f,M)=>{f.pending_buf[f.pending++]=255&M,f.pending_buf[f.pending++]=M>>>8&255},C=(f,M,v)=>{f.bi_valid>16-v?(f.bi_buf|=M<<f.bi_valid&65535,w(f,f.bi_buf),f.bi_buf=M>>16-f.bi_valid,f.bi_valid+=v-16):(f.bi_buf|=M<<f.bi_valid&65535,f.bi_valid+=v)},E=(f,M,v)=>{C(f,v[2*M],v[2*M+1])},I=(f,M)=>{let v=0;do v|=1&f,f>>>=1,v<<=1;while(--M>0);return v>>>1},R=(f,M,v)=>{const U=new Array(16);let L,T,ee=0;for(L=1;L<=o;L++)ee=ee+v[L-1]<<1,U[L]=ee;for(T=0;T<=M;T++){let V=f[2*T+1];V!==0&&(f[2*T]=I(U[V]++,V))}},F=f=>{let M;for(M=0;M<i;M++)f.dyn_ltree[2*M]=0;for(M=0;M<s;M++)f.dyn_dtree[2*M]=0;for(M=0;M<19;M++)f.bl_tree[2*M]=0;f.dyn_ltree[512]=1,f.opt_len=f.static_len=0,f.sym_next=f.matches=0},z=f=>{f.bi_valid>8?w(f,f.bi_buf):f.bi_valid>0&&(f.pending_buf[f.pending++]=f.bi_buf),f.bi_buf=0,f.bi_valid=0},Q=(f,M,v,U)=>{const L=2*M,T=2*v;return f[L]<f[T]||f[L]===f[T]&&U[M]<=U[v]},H=(f,M,v)=>{const U=f.heap[v];let L=v<<1;for(;L<=f.heap_len&&(L<f.heap_len&&Q(M,f.heap[L+1],f.heap[L],f.depth)&&L++,!Q(M,U,f.heap[L],f.depth));)f.heap[v]=f.heap[L],v=L,L<<=1;f.heap[v]=U},ae=(f,M,v)=>{let U,L,T,ee,V=0;if(f.sym_next!==0)do U=255&f.pending_buf[f.sym_buf+V++],U+=(255&f.pending_buf[f.sym_buf+V++])<<8,L=f.pending_buf[f.sym_buf+V++],U===0?E(f,L,M):(T=m[L],E(f,T+t+1,M),ee=a[T],ee!==0&&(L-=g[T],C(f,L,ee)),U--,T=B(U),E(f,T,v),ee=n[T],ee!==0&&(U-=u[T],C(f,U,ee)));while(V<f.sym_next);E(f,256,M)},pe=(f,M)=>{const v=M.dyn_tree,U=M.stat_desc.static_tree,L=M.stat_desc.has_stree,T=M.stat_desc.elems;let ee,V,ve,j=-1;for(f.heap_len=0,f.heap_max=573,ee=0;ee<T;ee++)v[2*ee]!==0?(f.heap[++f.heap_len]=j=ee,f.depth[ee]=0):v[2*ee+1]=0;for(;f.heap_len<2;)ve=f.heap[++f.heap_len]=j<2?++j:0,v[2*ve]=1,f.depth[ve]=0,f.opt_len--,L&&(f.static_len-=U[2*ve+1]);for(M.max_code=j,ee=f.heap_len>>1;ee>=1;ee--)H(f,v,ee);ve=T;do ee=f.heap[1],f.heap[1]=f.heap[f.heap_len--],H(f,v,1),V=f.heap[1],f.heap[--f.heap_max]=ee,f.heap[--f.heap_max]=V,v[2*ve]=v[2*ee]+v[2*V],f.depth[ve]=(f.depth[ee]>=f.depth[V]?f.depth[ee]:f.depth[V])+1,v[2*ee+1]=v[2*V+1]=ve,f.heap[1]=ve++,H(f,v,1);while(f.heap_len>=2);f.heap[--f.heap_max]=f.heap[1],((q,it)=>{const ze=it.dyn_tree,Pe=it.max_code,Dt=it.stat_desc.static_tree,pt=it.stat_desc.has_stree,Xe=it.stat_desc.extra_bits,mt=it.stat_desc.extra_base,tt=it.stat_desc.max_length;let Ee,Je,gt,Ue,dt,st,Ye=0;for(Ue=0;Ue<=o;Ue++)q.bl_count[Ue]=0;for(ze[2*q.heap[q.heap_max]+1]=0,Ee=q.heap_max+1;Ee<573;Ee++)Je=q.heap[Ee],Ue=ze[2*ze[2*Je+1]+1]+1,Ue>tt&&(Ue=tt,Ye++),ze[2*Je+1]=Ue,Je>Pe||(q.bl_count[Ue]++,dt=0,Je>=mt&&(dt=Xe[Je-mt]),st=ze[2*Je],q.opt_len+=st*(Ue+dt),pt&&(q.static_len+=st*(Dt[2*Je+1]+dt)));if(Ye!==0){do{for(Ue=tt-1;q.bl_count[Ue]===0;)Ue--;q.bl_count[Ue]--,q.bl_count[Ue+1]+=2,q.bl_count[tt]--,Ye-=2}while(Ye>0);for(Ue=tt;Ue!==0;Ue--)for(Je=q.bl_count[Ue];Je!==0;)gt=q.heap[--Ee],gt>Pe||(ze[2*gt+1]!==Ue&&(q.opt_len+=(Ue-ze[2*gt+1])*ze[2*gt],ze[2*gt+1]=Ue),Je--)}})(f,M),R(v,j,f.bl_count)},ge=(f,M,v)=>{let U,L,T=-1,ee=M[1],V=0,ve=7,j=4;for(ee===0&&(ve=138,j=3),M[2*(v+1)+1]=65535,U=0;U<=v;U++)L=ee,ee=M[2*(U+1)+1],++V<ve&&L===ee||(V<j?f.bl_tree[2*L]+=V:L!==0?(L!==T&&f.bl_tree[2*L]++,f.bl_tree[32]++):V<=10?f.bl_tree[34]++:f.bl_tree[36]++,V=0,T=L,ee===0?(ve=138,j=3):L===ee?(ve=6,j=3):(ve=7,j=4))},fe=(f,M,v)=>{let U,L,T=-1,ee=M[1],V=0,ve=7,j=4;for(ee===0&&(ve=138,j=3),U=0;U<=v;U++)if(L=ee,ee=M[2*(U+1)+1],!(++V<ve&&L===ee)){if(V<j)do E(f,L,f.bl_tree);while(--V!=0);else L!==0?(L!==T&&(E(f,L,f.bl_tree),V--),E(f,16,f.bl_tree),C(f,V-3,2)):V<=10?(E(f,17,f.bl_tree),C(f,V-3,3)):(E(f,18,f.bl_tree),C(f,V-11,7));V=0,T=L,ee===0?(ve=138,j=3):L===ee?(ve=6,j=3):(ve=7,j=4)}};let Me=!1;const be=(f,M,v,U)=>{C(f,0+(U?1:0),3),z(f),w(f,v),w(f,~v),v&&f.pending_buf.set(f.window.subarray(M,M+v),f.pending),f.pending+=v};var Fe=(f,M,v,U)=>{let L,T,ee=0;f.level>0?(f.strm.data_type===2&&(f.strm.data_type=(V=>{let ve,j=4093624447;for(ve=0;ve<=31;ve++,j>>>=1)if(1&j&&V.dyn_ltree[2*ve]!==0)return 0;if(V.dyn_ltree[18]!==0||V.dyn_ltree[20]!==0||V.dyn_ltree[26]!==0)return 1;for(ve=32;ve<t;ve++)if(V.dyn_ltree[2*ve]!==0)return 1;return 0})(f)),pe(f,f.l_desc),pe(f,f.d_desc),ee=(V=>{let ve;for(ge(V,V.dyn_ltree,V.l_desc.max_code),ge(V,V.dyn_dtree,V.d_desc.max_code),pe(V,V.bl_desc),ve=18;ve>=3&&V.bl_tree[2*c[ve]+1]===0;ve--);return V.opt_len+=3*(ve+1)+5+5+4,ve})(f),L=f.opt_len+3+7>>>3,T=f.static_len+3+7>>>3,T<=L&&(L=T)):L=T=v+5,v+4<=L&&M!==-1?be(f,M,v,U):f.strategy===4||T===L?(C(f,2+(U?1:0),3),ae(f,h,d)):(C(f,4+(U?1:0),3),((V,ve,j,q)=>{let it;for(C(V,ve-257,5),C(V,j-1,5),C(V,q-4,4),it=0;it<q;it++)C(V,V.bl_tree[2*c[it]+1],3);fe(V,V.dyn_ltree,ve-1),fe(V,V.dyn_dtree,j-1)})(f,f.l_desc.max_code+1,f.d_desc.max_code+1,ee+1),ae(f,f.dyn_ltree,f.dyn_dtree)),F(f),U&&z(f)},Re={_tr_init:f=>{Me||((()=>{let M,v,U,L,T;const ee=new Array(16);for(U=0,L=0;L<28;L++)for(g[L]=U,M=0;M<1<<a[L];M++)m[U++]=L;for(m[U-1]=L,T=0,L=0;L<16;L++)for(u[L]=T,M=0;M<1<<n[L];M++)p[T++]=L;for(T>>=7;L<s;L++)for(u[L]=T<<7,M=0;M<1<<n[L]-7;M++)p[256+T++]=L;for(v=0;v<=o;v++)ee[v]=0;for(M=0;M<=143;)h[2*M+1]=8,M++,ee[8]++;for(;M<=255;)h[2*M+1]=9,M++,ee[9]++;for(;M<=279;)h[2*M+1]=7,M++,ee[7]++;for(;M<=287;)h[2*M+1]=8,M++,ee[8]++;for(R(h,287,ee),M=0;M<s;M++)d[2*M+1]=5,d[2*M]=I(M,5);y=new x(h,a,257,i,o),P=new x(d,n,0,s,o),_=new x(new Array(0),l,0,19,7)})(),Me=!0),f.l_desc=new b(f.dyn_ltree,y),f.d_desc=new b(f.dyn_dtree,P),f.bl_desc=new b(f.bl_tree,_),f.bi_buf=0,f.bi_valid=0,F(f)},_tr_stored_block:be,_tr_flush_block:Fe,_tr_tally:(f,M,v)=>(f.pending_buf[f.sym_buf+f.sym_next++]=M,f.pending_buf[f.sym_buf+f.sym_next++]=M>>8,f.pending_buf[f.sym_buf+f.sym_next++]=v,M===0?f.dyn_ltree[2*v]++:(f.matches++,M--,f.dyn_ltree[2*(m[v]+t+1)]++,f.dyn_dtree[2*B(M)]++),f.sym_next===f.sym_end),_tr_align:f=>{C(f,2,3),E(f,256,h),(M=>{M.bi_valid===16?(w(M,M.bi_buf),M.bi_buf=0,M.bi_valid=0):M.bi_valid>=8&&(M.pending_buf[M.pending++]=255&M.bi_buf,M.bi_buf>>=8,M.bi_valid-=8)})(f)}},Te=(f,M,v,U)=>{let L=65535&f|0,T=f>>>16&65535|0,ee=0;for(;v!==0;){ee=v>2e3?2e3:v,v-=ee;do L=L+M[U++]|0,T=T+L|0;while(--ee);L%=65521,T%=65521}return L|T<<16|0};const Ne=new Uint32Array((()=>{let f,M=[];for(var v=0;v<256;v++){f=v;for(var U=0;U<8;U++)f=1&f?3988292384^f>>>1:f>>>1;M[v]=f}return M})());var Be=(f,M,v,U)=>{const L=Ne,T=U+v;f^=-1;for(let ee=U;ee<T;ee++)f=f>>>8^L[255&(f^M[ee])];return-1^f},Se={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},S={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:k,_tr_stored_block:D,_tr_flush_block:G,_tr_tally:se,_tr_align:le}=Re,{Z_NO_FLUSH:te,Z_PARTIAL_FLUSH:oe,Z_FULL_FLUSH:Y,Z_FINISH:ne,Z_BLOCK:Ae,Z_OK:$,Z_STREAM_END:J,Z_STREAM_ERROR:_e,Z_DATA_ERROR:re,Z_BUF_ERROR:he,Z_DEFAULT_COMPRESSION:ce,Z_FILTERED:xe,Z_HUFFMAN_ONLY:De,Z_RLE:ie,Z_FIXED:de,Z_DEFAULT_STRATEGY:me,Z_UNKNOWN:ye,Z_DEFLATED:K}=S,Le=258,je=262,Z=42,qe=113,$e=666,Ke=(f,M)=>(f.msg=Se[M],M),ot=f=>2*f-(f>4?9:0),nt=f=>{let M=f.length;for(;--M>=0;)f[M]=0},ht=f=>{let M,v,U,L=f.w_size;M=f.hash_size,U=M;do v=f.head[--U],f.head[U]=v>=L?v-L:0;while(--M);M=L,U=M;do v=f.prev[--U],f.prev[U]=v>=L?v-L:0;while(--M)};let Ce=(f,M,v)=>(M<<f.hash_shift^v)&f.hash_mask;const He=f=>{const M=f.state;let v=M.pending;v>f.avail_out&&(v=f.avail_out),v!==0&&(f.output.set(M.pending_buf.subarray(M.pending_out,M.pending_out+v),f.next_out),f.next_out+=v,M.pending_out+=v,f.total_out+=v,f.avail_out-=v,M.pending-=v,M.pending===0&&(M.pending_out=0))},Qe=(f,M)=>{G(f,f.block_start>=0?f.block_start:-1,f.strstart-f.block_start,M),f.block_start=f.strstart,He(f.strm)},ue=(f,M)=>{f.pending_buf[f.pending++]=M},X=(f,M)=>{f.pending_buf[f.pending++]=M>>>8&255,f.pending_buf[f.pending++]=255&M},Ze=(f,M,v,U)=>{let L=f.avail_in;return L>U&&(L=U),L===0?0:(f.avail_in-=L,M.set(f.input.subarray(f.next_in,f.next_in+L),v),f.state.wrap===1?f.adler=Te(f.adler,M,L,v):f.state.wrap===2&&(f.adler=Be(f.adler,M,L,v)),f.next_in+=L,f.total_in+=L,L)},et=(f,M)=>{let v,U,L=f.max_chain_length,T=f.strstart,ee=f.prev_length,V=f.nice_match;const ve=f.strstart>f.w_size-je?f.strstart-(f.w_size-je):0,j=f.window,q=f.w_mask,it=f.prev,ze=f.strstart+Le;let Pe=j[T+ee-1],Dt=j[T+ee];f.prev_length>=f.good_match&&(L>>=2),V>f.lookahead&&(V=f.lookahead);do if(v=M,j[v+ee]===Dt&&j[v+ee-1]===Pe&&j[v]===j[T]&&j[++v]===j[T+1]){T+=2,v++;do;while(j[++T]===j[++v]&&j[++T]===j[++v]&&j[++T]===j[++v]&&j[++T]===j[++v]&&j[++T]===j[++v]&&j[++T]===j[++v]&&j[++T]===j[++v]&&j[++T]===j[++v]&&T<ze);if(U=Le-(ze-T),T=ze-Le,U>ee){if(f.match_start=M,ee=U,U>=V)break;Pe=j[T+ee-1],Dt=j[T+ee]}}while((M=it[M&q])>ve&&--L!=0);return ee<=f.lookahead?ee:f.lookahead},Ge=f=>{const M=f.w_size;let v,U,L;do{if(U=f.window_size-f.lookahead-f.strstart,f.strstart>=M+(M-je)&&(f.window.set(f.window.subarray(M,M+M-U),0),f.match_start-=M,f.strstart-=M,f.block_start-=M,f.insert>f.strstart&&(f.insert=f.strstart),ht(f),U+=M),f.strm.avail_in===0)break;if(v=Ze(f.strm,f.window,f.strstart+f.lookahead,U),f.lookahead+=v,f.lookahead+f.insert>=3)for(L=f.strstart-f.insert,f.ins_h=f.window[L],f.ins_h=Ce(f,f.ins_h,f.window[L+1]);f.insert&&(f.ins_h=Ce(f,f.ins_h,f.window[L+3-1]),f.prev[L&f.w_mask]=f.head[f.ins_h],f.head[f.ins_h]=L,L++,f.insert--,!(f.lookahead+f.insert<3)););}while(f.lookahead<je&&f.strm.avail_in!==0)},Bt=(f,M)=>{let v,U,L,T=f.pending_buf_size-5>f.w_size?f.w_size:f.pending_buf_size-5,ee=0,V=f.strm.avail_in;do{if(v=65535,L=f.bi_valid+42>>3,f.strm.avail_out<L||(L=f.strm.avail_out-L,U=f.strstart-f.block_start,v>U+f.strm.avail_in&&(v=U+f.strm.avail_in),v>L&&(v=L),v<T&&(v===0&&M!==ne||M===te||v!==U+f.strm.avail_in)))break;ee=M===ne&&v===U+f.strm.avail_in?1:0,D(f,0,0,ee),f.pending_buf[f.pending-4]=v,f.pending_buf[f.pending-3]=v>>8,f.pending_buf[f.pending-2]=~v,f.pending_buf[f.pending-1]=~v>>8,He(f.strm),U&&(U>v&&(U=v),f.strm.output.set(f.window.subarray(f.block_start,f.block_start+U),f.strm.next_out),f.strm.next_out+=U,f.strm.avail_out-=U,f.strm.total_out+=U,f.block_start+=U,v-=U),v&&(Ze(f.strm,f.strm.output,f.strm.next_out,v),f.strm.next_out+=v,f.strm.avail_out-=v,f.strm.total_out+=v)}while(ee===0);return V-=f.strm.avail_in,V&&(V>=f.w_size?(f.matches=2,f.window.set(f.strm.input.subarray(f.strm.next_in-f.w_size,f.strm.next_in),0),f.strstart=f.w_size,f.insert=f.strstart):(f.window_size-f.strstart<=V&&(f.strstart-=f.w_size,f.window.set(f.window.subarray(f.w_size,f.w_size+f.strstart),0),f.matches<2&&f.matches++,f.insert>f.strstart&&(f.insert=f.strstart)),f.window.set(f.strm.input.subarray(f.strm.next_in-V,f.strm.next_in),f.strstart),f.strstart+=V,f.insert+=V>f.w_size-f.insert?f.w_size-f.insert:V),f.block_start=f.strstart),f.high_water<f.strstart&&(f.high_water=f.strstart),ee?4:M!==te&&M!==ne&&f.strm.avail_in===0&&f.strstart===f.block_start?2:(L=f.window_size-f.strstart,f.strm.avail_in>L&&f.block_start>=f.w_size&&(f.block_start-=f.w_size,f.strstart-=f.w_size,f.window.set(f.window.subarray(f.w_size,f.w_size+f.strstart),0),f.matches<2&&f.matches++,L+=f.w_size,f.insert>f.strstart&&(f.insert=f.strstart)),L>f.strm.avail_in&&(L=f.strm.avail_in),L&&(Ze(f.strm,f.window,f.strstart,L),f.strstart+=L,f.insert+=L>f.w_size-f.insert?f.w_size-f.insert:L),f.high_water<f.strstart&&(f.high_water=f.strstart),L=f.bi_valid+42>>3,L=f.pending_buf_size-L>65535?65535:f.pending_buf_size-L,T=L>f.w_size?f.w_size:L,U=f.strstart-f.block_start,(U>=T||(U||M===ne)&&M!==te&&f.strm.avail_in===0&&U<=L)&&(v=U>L?L:U,ee=M===ne&&f.strm.avail_in===0&&v===U?1:0,D(f,f.block_start,v,ee),f.block_start+=v,He(f.strm)),ee?3:1)},We=(f,M)=>{let v,U;for(;;){if(f.lookahead<je){if(Ge(f),f.lookahead<je&&M===te)return 1;if(f.lookahead===0)break}if(v=0,f.lookahead>=3&&(f.ins_h=Ce(f,f.ins_h,f.window[f.strstart+3-1]),v=f.prev[f.strstart&f.w_mask]=f.head[f.ins_h],f.head[f.ins_h]=f.strstart),v!==0&&f.strstart-v<=f.w_size-je&&(f.match_length=et(f,v)),f.match_length>=3)if(U=se(f,f.strstart-f.match_start,f.match_length-3),f.lookahead-=f.match_length,f.match_length<=f.max_lazy_match&&f.lookahead>=3){f.match_length--;do f.strstart++,f.ins_h=Ce(f,f.ins_h,f.window[f.strstart+3-1]),v=f.prev[f.strstart&f.w_mask]=f.head[f.ins_h],f.head[f.ins_h]=f.strstart;while(--f.match_length!=0);f.strstart++}else f.strstart+=f.match_length,f.match_length=0,f.ins_h=f.window[f.strstart],f.ins_h=Ce(f,f.ins_h,f.window[f.strstart+1]);else U=se(f,0,f.window[f.strstart]),f.lookahead--,f.strstart++;if(U&&(Qe(f,!1),f.strm.avail_out===0))return 1}return f.insert=f.strstart<2?f.strstart:2,M===ne?(Qe(f,!0),f.strm.avail_out===0?3:4):f.sym_next&&(Qe(f,!1),f.strm.avail_out===0)?1:2},Pi=(f,M)=>{let v,U,L;for(;;){if(f.lookahead<je){if(Ge(f),f.lookahead<je&&M===te)return 1;if(f.lookahead===0)break}if(v=0,f.lookahead>=3&&(f.ins_h=Ce(f,f.ins_h,f.window[f.strstart+3-1]),v=f.prev[f.strstart&f.w_mask]=f.head[f.ins_h],f.head[f.ins_h]=f.strstart),f.prev_length=f.match_length,f.prev_match=f.match_start,f.match_length=2,v!==0&&f.prev_length<f.max_lazy_match&&f.strstart-v<=f.w_size-je&&(f.match_length=et(f,v),f.match_length<=5&&(f.strategy===xe||f.match_length===3&&f.strstart-f.match_start>4096)&&(f.match_length=2)),f.prev_length>=3&&f.match_length<=f.prev_length){L=f.strstart+f.lookahead-3,U=se(f,f.strstart-1-f.prev_match,f.prev_length-3),f.lookahead-=f.prev_length-1,f.prev_length-=2;do++f.strstart<=L&&(f.ins_h=Ce(f,f.ins_h,f.window[f.strstart+3-1]),v=f.prev[f.strstart&f.w_mask]=f.head[f.ins_h],f.head[f.ins_h]=f.strstart);while(--f.prev_length!=0);if(f.match_available=0,f.match_length=2,f.strstart++,U&&(Qe(f,!1),f.strm.avail_out===0))return 1}else if(f.match_available){if(U=se(f,0,f.window[f.strstart-1]),U&&Qe(f,!1),f.strstart++,f.lookahead--,f.strm.avail_out===0)return 1}else f.match_available=1,f.strstart++,f.lookahead--}return f.match_available&&(U=se(f,0,f.window[f.strstart-1]),f.match_available=0),f.insert=f.strstart<2?f.strstart:2,M===ne?(Qe(f,!0),f.strm.avail_out===0?3:4):f.sym_next&&(Qe(f,!1),f.strm.avail_out===0)?1:2};function wt(f,M,v,U,L){this.good_length=f,this.max_lazy=M,this.nice_length=v,this.max_chain=U,this.func=L}const Tr=[new wt(0,0,0,0,Bt),new wt(4,4,8,4,We),new wt(4,5,16,8,We),new wt(4,6,32,32,We),new wt(4,4,16,16,Pi),new wt(8,16,32,32,Pi),new wt(8,16,128,128,Pi),new wt(8,32,128,256,Pi),new wt(32,128,258,1024,Pi),new wt(32,258,258,4096,Pi)];function qm(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=K,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),nt(this.dyn_ltree),nt(this.dyn_dtree),nt(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),nt(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),nt(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Dr=f=>{if(!f)return 1;const M=f.state;return!M||M.strm!==f||M.status!==Z&&M.status!==57&&M.status!==69&&M.status!==73&&M.status!==91&&M.status!==103&&M.status!==qe&&M.status!==$e?1:0},Pc=f=>{if(Dr(f))return Ke(f,_e);f.total_in=f.total_out=0,f.data_type=ye;const M=f.state;return M.pending=0,M.pending_out=0,M.wrap<0&&(M.wrap=-M.wrap),M.status=M.wrap===2?57:M.wrap?Z:qe,f.adler=M.wrap===2?0:1,M.last_flush=-2,k(M),$},xc=f=>{const M=Pc(f);var v;return M===$&&((v=f.state).window_size=2*v.w_size,nt(v.head),v.max_lazy_match=Tr[v.level].max_lazy,v.good_match=Tr[v.level].good_length,v.nice_match=Tr[v.level].nice_length,v.max_chain_length=Tr[v.level].max_chain,v.strstart=0,v.block_start=0,v.lookahead=0,v.insert=0,v.match_length=v.prev_length=2,v.match_available=0,v.ins_h=0),M},yc=(f,M,v,U,L,T)=>{if(!f)return _e;let ee=1;if(M===ce&&(M=6),U<0?(ee=0,U=-U):U>15&&(ee=2,U-=16),L<1||L>9||v!==K||U<8||U>15||M<0||M>9||T<0||T>de||U===8&&ee!==1)return Ke(f,_e);U===8&&(U=9);const V=new qm;return f.state=V,V.strm=f,V.status=Z,V.wrap=ee,V.gzhead=null,V.w_bits=U,V.w_size=1<<V.w_bits,V.w_mask=V.w_size-1,V.hash_bits=L+7,V.hash_size=1<<V.hash_bits,V.hash_mask=V.hash_size-1,V.hash_shift=~~((V.hash_bits+3-1)/3),V.window=new Uint8Array(2*V.w_size),V.head=new Uint16Array(V.hash_size),V.prev=new Uint16Array(V.w_size),V.lit_bufsize=1<<L+6,V.pending_buf_size=4*V.lit_bufsize,V.pending_buf=new Uint8Array(V.pending_buf_size),V.sym_buf=V.lit_bufsize,V.sym_end=3*(V.lit_bufsize-1),V.level=M,V.strategy=T,V.method=v,xc(f)};var Rr={deflateInit:(f,M)=>yc(f,M,K,15,8,me),deflateInit2:yc,deflateReset:xc,deflateResetKeep:Pc,deflateSetHeader:(f,M)=>Dr(f)||f.state.wrap!==2?_e:(f.state.gzhead=M,$),deflate:(f,M)=>{if(Dr(f)||M>Ae||M<0)return f?Ke(f,_e):_e;const v=f.state;if(!f.output||f.avail_in!==0&&!f.input||v.status===$e&&M!==ne)return Ke(f,f.avail_out===0?he:_e);const U=v.last_flush;if(v.last_flush=M,v.pending!==0){if(He(f),f.avail_out===0)return v.last_flush=-1,$}else if(f.avail_in===0&&ot(M)<=ot(U)&&M!==ne)return Ke(f,he);if(v.status===$e&&f.avail_in!==0)return Ke(f,he);if(v.status===Z&&v.wrap===0&&(v.status=qe),v.status===Z){let L=K+(v.w_bits-8<<4)<<8,T=-1;if(T=v.strategy>=De||v.level<2?0:v.level<6?1:v.level===6?2:3,L|=T<<6,v.strstart!==0&&(L|=32),L+=31-L%31,X(v,L),v.strstart!==0&&(X(v,f.adler>>>16),X(v,65535&f.adler)),f.adler=1,v.status=qe,He(f),v.pending!==0)return v.last_flush=-1,$}if(v.status===57){if(f.adler=0,ue(v,31),ue(v,139),ue(v,8),v.gzhead)ue(v,(v.gzhead.text?1:0)+(v.gzhead.hcrc?2:0)+(v.gzhead.extra?4:0)+(v.gzhead.name?8:0)+(v.gzhead.comment?16:0)),ue(v,255&v.gzhead.time),ue(v,v.gzhead.time>>8&255),ue(v,v.gzhead.time>>16&255),ue(v,v.gzhead.time>>24&255),ue(v,v.level===9?2:v.strategy>=De||v.level<2?4:0),ue(v,255&v.gzhead.os),v.gzhead.extra&&v.gzhead.extra.length&&(ue(v,255&v.gzhead.extra.length),ue(v,v.gzhead.extra.length>>8&255)),v.gzhead.hcrc&&(f.adler=Be(f.adler,v.pending_buf,v.pending,0)),v.gzindex=0,v.status=69;else if(ue(v,0),ue(v,0),ue(v,0),ue(v,0),ue(v,0),ue(v,v.level===9?2:v.strategy>=De||v.level<2?4:0),ue(v,3),v.status=qe,He(f),v.pending!==0)return v.last_flush=-1,$}if(v.status===69){if(v.gzhead.extra){let L=v.pending,T=(65535&v.gzhead.extra.length)-v.gzindex;for(;v.pending+T>v.pending_buf_size;){let V=v.pending_buf_size-v.pending;if(v.pending_buf.set(v.gzhead.extra.subarray(v.gzindex,v.gzindex+V),v.pending),v.pending=v.pending_buf_size,v.gzhead.hcrc&&v.pending>L&&(f.adler=Be(f.adler,v.pending_buf,v.pending-L,L)),v.gzindex+=V,He(f),v.pending!==0)return v.last_flush=-1,$;L=0,T-=V}let ee=new Uint8Array(v.gzhead.extra);v.pending_buf.set(ee.subarray(v.gzindex,v.gzindex+T),v.pending),v.pending+=T,v.gzhead.hcrc&&v.pending>L&&(f.adler=Be(f.adler,v.pending_buf,v.pending-L,L)),v.gzindex=0}v.status=73}if(v.status===73){if(v.gzhead.name){let L,T=v.pending;do{if(v.pending===v.pending_buf_size){if(v.gzhead.hcrc&&v.pending>T&&(f.adler=Be(f.adler,v.pending_buf,v.pending-T,T)),He(f),v.pending!==0)return v.last_flush=-1,$;T=0}L=v.gzindex<v.gzhead.name.length?255&v.gzhead.name.charCodeAt(v.gzindex++):0,ue(v,L)}while(L!==0);v.gzhead.hcrc&&v.pending>T&&(f.adler=Be(f.adler,v.pending_buf,v.pending-T,T)),v.gzindex=0}v.status=91}if(v.status===91){if(v.gzhead.comment){let L,T=v.pending;do{if(v.pending===v.pending_buf_size){if(v.gzhead.hcrc&&v.pending>T&&(f.adler=Be(f.adler,v.pending_buf,v.pending-T,T)),He(f),v.pending!==0)return v.last_flush=-1,$;T=0}L=v.gzindex<v.gzhead.comment.length?255&v.gzhead.comment.charCodeAt(v.gzindex++):0,ue(v,L)}while(L!==0);v.gzhead.hcrc&&v.pending>T&&(f.adler=Be(f.adler,v.pending_buf,v.pending-T,T))}v.status=103}if(v.status===103){if(v.gzhead.hcrc){if(v.pending+2>v.pending_buf_size&&(He(f),v.pending!==0))return v.last_flush=-1,$;ue(v,255&f.adler),ue(v,f.adler>>8&255),f.adler=0}if(v.status=qe,He(f),v.pending!==0)return v.last_flush=-1,$}if(f.avail_in!==0||v.lookahead!==0||M!==te&&v.status!==$e){let L=v.level===0?Bt(v,M):v.strategy===De?((T,ee)=>{let V;for(;;){if(T.lookahead===0&&(Ge(T),T.lookahead===0)){if(ee===te)return 1;break}if(T.match_length=0,V=se(T,0,T.window[T.strstart]),T.lookahead--,T.strstart++,V&&(Qe(T,!1),T.strm.avail_out===0))return 1}return T.insert=0,ee===ne?(Qe(T,!0),T.strm.avail_out===0?3:4):T.sym_next&&(Qe(T,!1),T.strm.avail_out===0)?1:2})(v,M):v.strategy===ie?((T,ee)=>{let V,ve,j,q;const it=T.window;for(;;){if(T.lookahead<=Le){if(Ge(T),T.lookahead<=Le&&ee===te)return 1;if(T.lookahead===0)break}if(T.match_length=0,T.lookahead>=3&&T.strstart>0&&(j=T.strstart-1,ve=it[j],ve===it[++j]&&ve===it[++j]&&ve===it[++j])){q=T.strstart+Le;do;while(ve===it[++j]&&ve===it[++j]&&ve===it[++j]&&ve===it[++j]&&ve===it[++j]&&ve===it[++j]&&ve===it[++j]&&ve===it[++j]&&j<q);T.match_length=Le-(q-j),T.match_length>T.lookahead&&(T.match_length=T.lookahead)}if(T.match_length>=3?(V=se(T,1,T.match_length-3),T.lookahead-=T.match_length,T.strstart+=T.match_length,T.match_length=0):(V=se(T,0,T.window[T.strstart]),T.lookahead--,T.strstart++),V&&(Qe(T,!1),T.strm.avail_out===0))return 1}return T.insert=0,ee===ne?(Qe(T,!0),T.strm.avail_out===0?3:4):T.sym_next&&(Qe(T,!1),T.strm.avail_out===0)?1:2})(v,M):Tr[v.level].func(v,M);if(L!==3&&L!==4||(v.status=$e),L===1||L===3)return f.avail_out===0&&(v.last_flush=-1),$;if(L===2&&(M===oe?le(v):M!==Ae&&(D(v,0,0,!1),M===Y&&(nt(v.head),v.lookahead===0&&(v.strstart=0,v.block_start=0,v.insert=0))),He(f),f.avail_out===0))return v.last_flush=-1,$}return M!==ne?$:v.wrap<=0?J:(v.wrap===2?(ue(v,255&f.adler),ue(v,f.adler>>8&255),ue(v,f.adler>>16&255),ue(v,f.adler>>24&255),ue(v,255&f.total_in),ue(v,f.total_in>>8&255),ue(v,f.total_in>>16&255),ue(v,f.total_in>>24&255)):(X(v,f.adler>>>16),X(v,65535&f.adler)),He(f),v.wrap>0&&(v.wrap=-v.wrap),v.pending!==0?$:J)},deflateEnd:f=>{if(Dr(f))return _e;const M=f.state.status;return f.state=null,M===qe?Ke(f,re):$},deflateSetDictionary:(f,M)=>{let v=M.length;if(Dr(f))return _e;const U=f.state,L=U.wrap;if(L===2||L===1&&U.status!==Z||U.lookahead)return _e;if(L===1&&(f.adler=Te(f.adler,M,v,0)),U.wrap=0,v>=U.w_size){L===0&&(nt(U.head),U.strstart=0,U.block_start=0,U.insert=0);let ve=new Uint8Array(U.w_size);ve.set(M.subarray(v-U.w_size,v),0),M=ve,v=U.w_size}const T=f.avail_in,ee=f.next_in,V=f.input;for(f.avail_in=v,f.next_in=0,f.input=M,Ge(U);U.lookahead>=3;){let ve=U.strstart,j=U.lookahead-2;do U.ins_h=Ce(U,U.ins_h,U.window[ve+3-1]),U.prev[ve&U.w_mask]=U.head[U.ins_h],U.head[U.ins_h]=ve,ve++;while(--j);U.strstart=ve,U.lookahead=2,Ge(U)}return U.strstart+=U.lookahead,U.block_start=U.strstart,U.insert=U.lookahead,U.lookahead=0,U.match_length=U.prev_length=2,U.match_available=0,f.next_in=ee,f.input=V,f.avail_in=T,U.wrap=L,$},deflateInfo:"pako deflate (from Nodeca project)"};const Jm=(f,M)=>Object.prototype.hasOwnProperty.call(f,M);var bc=function(f){const M=Array.prototype.slice.call(arguments,1);for(;M.length;){const v=M.shift();if(v){if(typeof v!="object")throw new TypeError(v+"must be non-object");for(const U in v)Jm(v,U)&&(f[U]=v[U])}}return f},Bc=f=>{let M=0;for(let U=0,L=f.length;U<L;U++)M+=f[U].length;const v=new Uint8Array(M);for(let U=0,L=0,T=f.length;U<T;U++){let ee=f[U];v.set(ee,L),L+=ee.length}return v};let wc=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{wc=!1}const Lr=new Uint8Array(256);for(let f=0;f<256;f++)Lr[f]=f>=252?6:f>=248?5:f>=240?4:f>=224?3:f>=192?2:1;Lr[254]=Lr[254]=1;var Ka=f=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(f);let M,v,U,L,T,ee=f.length,V=0;for(L=0;L<ee;L++)v=f.charCodeAt(L),(64512&v)==55296&&L+1<ee&&(U=f.charCodeAt(L+1),(64512&U)==56320&&(v=65536+(v-55296<<10)+(U-56320),L++)),V+=v<128?1:v<2048?2:v<65536?3:4;for(M=new Uint8Array(V),T=0,L=0;T<V;L++)v=f.charCodeAt(L),(64512&v)==55296&&L+1<ee&&(U=f.charCodeAt(L+1),(64512&U)==56320&&(v=65536+(v-55296<<10)+(U-56320),L++)),v<128?M[T++]=v:v<2048?(M[T++]=192|v>>>6,M[T++]=128|63&v):v<65536?(M[T++]=224|v>>>12,M[T++]=128|v>>>6&63,M[T++]=128|63&v):(M[T++]=240|v>>>18,M[T++]=128|v>>>12&63,M[T++]=128|v>>>6&63,M[T++]=128|63&v);return M},eg=(f,M)=>{const v=M||f.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(f.subarray(0,M));let U,L;const T=new Array(2*v);for(L=0,U=0;U<v;){let ee=f[U++];if(ee<128){T[L++]=ee;continue}let V=Lr[ee];if(V>4)T[L++]=65533,U+=V-1;else{for(ee&=V===2?31:V===3?15:7;V>1&&U<v;)ee=ee<<6|63&f[U++],V--;V>1?T[L++]=65533:ee<65536?T[L++]=ee:(ee-=65536,T[L++]=55296|ee>>10&1023,T[L++]=56320|1023&ee)}}return((ee,V)=>{if(V<65534&&ee.subarray&&wc)return String.fromCharCode.apply(null,ee.length===V?ee:ee.subarray(0,V));let ve="";for(let j=0;j<V;j++)ve+=String.fromCharCode(ee[j]);return ve})(T,L)},tg=(f,M)=>{(M=M||f.length)>f.length&&(M=f.length);let v=M-1;for(;v>=0&&(192&f[v])==128;)v--;return v<0||v===0?M:v+Lr[f[v]]>M?v:M},Cc=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const Mc=Object.prototype.toString,{Z_NO_FLUSH:ig,Z_SYNC_FLUSH:sg,Z_FULL_FLUSH:rg,Z_FINISH:og,Z_OK:Qo,Z_STREAM_END:ng,Z_DEFAULT_COMPRESSION:ag,Z_DEFAULT_STRATEGY:lg,Z_DEFLATED:Ag}=S;function Ur(f){this.options=bc({level:ag,method:Ag,chunkSize:16384,windowBits:15,memLevel:8,strategy:lg},f||{});let M=this.options;M.raw&&M.windowBits>0?M.windowBits=-M.windowBits:M.gzip&&M.windowBits>0&&M.windowBits<16&&(M.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Cc,this.strm.avail_out=0;let v=Rr.deflateInit2(this.strm,M.level,M.method,M.windowBits,M.memLevel,M.strategy);if(v!==Qo)throw new Error(Se[v]);if(M.header&&Rr.deflateSetHeader(this.strm,M.header),M.dictionary){let U;if(U=typeof M.dictionary=="string"?Ka(M.dictionary):Mc.call(M.dictionary)==="[object ArrayBuffer]"?new Uint8Array(M.dictionary):M.dictionary,v=Rr.deflateSetDictionary(this.strm,U),v!==Qo)throw new Error(Se[v]);this._dict_set=!0}}function Xa(f,M){const v=new Ur(M);if(v.push(f,!0),v.err)throw v.msg||Se[v.err];return v.result}Ur.prototype.push=function(f,M){const v=this.strm,U=this.options.chunkSize;let L,T;if(this.ended)return!1;for(T=M===~~M?M:M===!0?og:ig,typeof f=="string"?v.input=Ka(f):Mc.call(f)==="[object ArrayBuffer]"?v.input=new Uint8Array(f):v.input=f,v.next_in=0,v.avail_in=v.input.length;;)if(v.avail_out===0&&(v.output=new Uint8Array(U),v.next_out=0,v.avail_out=U),(T===sg||T===rg)&&v.avail_out<=6)this.onData(v.output.subarray(0,v.next_out)),v.avail_out=0;else{if(L=Rr.deflate(v,T),L===ng)return v.next_out>0&&this.onData(v.output.subarray(0,v.next_out)),L=Rr.deflateEnd(this.strm),this.onEnd(L),this.ended=!0,L===Qo;if(v.avail_out!==0){if(T>0&&v.next_out>0)this.onData(v.output.subarray(0,v.next_out)),v.avail_out=0;else if(v.avail_in===0)break}else this.onData(v.output)}return!0},Ur.prototype.onData=function(f){this.chunks.push(f)},Ur.prototype.onEnd=function(f){f===Qo&&(this.result=Bc(this.chunks)),this.chunks=[],this.err=f,this.msg=this.strm.msg};var cg={Deflate:Ur,deflate:Xa,deflateRaw:function(f,M){return(M=M||{}).raw=!0,Xa(f,M)},gzip:function(f,M){return(M=M||{}).gzip=!0,Xa(f,M)},constants:S};const Vo=16209;var hg=function(f,M){let v,U,L,T,ee,V,ve,j,q,it,ze,Pe,Dt,pt,Xe,mt,tt,Ee,Je,gt,Ue,dt,st,Ye;const At=f.state;v=f.next_in,st=f.input,U=v+(f.avail_in-5),L=f.next_out,Ye=f.output,T=L-(M-f.avail_out),ee=L+(f.avail_out-257),V=At.dmax,ve=At.wsize,j=At.whave,q=At.wnext,it=At.window,ze=At.hold,Pe=At.bits,Dt=At.lencode,pt=At.distcode,Xe=(1<<At.lenbits)-1,mt=(1<<At.distbits)-1;e:do{Pe<15&&(ze+=st[v++]<<Pe,Pe+=8,ze+=st[v++]<<Pe,Pe+=8),tt=Dt[ze&Xe];t:for(;;){if(Ee=tt>>>24,ze>>>=Ee,Pe-=Ee,Ee=tt>>>16&255,Ee===0)Ye[L++]=65535&tt;else{if(!(16&Ee)){if(!(64&Ee)){tt=Dt[(65535&tt)+(ze&(1<<Ee)-1)];continue t}if(32&Ee){At.mode=16191;break e}f.msg="invalid literal/length code",At.mode=Vo;break e}Je=65535&tt,Ee&=15,Ee&&(Pe<Ee&&(ze+=st[v++]<<Pe,Pe+=8),Je+=ze&(1<<Ee)-1,ze>>>=Ee,Pe-=Ee),Pe<15&&(ze+=st[v++]<<Pe,Pe+=8,ze+=st[v++]<<Pe,Pe+=8),tt=pt[ze&mt];i:for(;;){if(Ee=tt>>>24,ze>>>=Ee,Pe-=Ee,Ee=tt>>>16&255,!(16&Ee)){if(!(64&Ee)){tt=pt[(65535&tt)+(ze&(1<<Ee)-1)];continue i}f.msg="invalid distance code",At.mode=Vo;break e}if(gt=65535&tt,Ee&=15,Pe<Ee&&(ze+=st[v++]<<Pe,Pe+=8,Pe<Ee&&(ze+=st[v++]<<Pe,Pe+=8)),gt+=ze&(1<<Ee)-1,gt>V){f.msg="invalid distance too far back",At.mode=Vo;break e}if(ze>>>=Ee,Pe-=Ee,Ee=L-T,gt>Ee){if(Ee=gt-Ee,Ee>j&&At.sane){f.msg="invalid distance too far back",At.mode=Vo;break e}if(Ue=0,dt=it,q===0){if(Ue+=ve-Ee,Ee<Je){Je-=Ee;do Ye[L++]=it[Ue++];while(--Ee);Ue=L-gt,dt=Ye}}else if(q<Ee){if(Ue+=ve+q-Ee,Ee-=q,Ee<Je){Je-=Ee;do Ye[L++]=it[Ue++];while(--Ee);if(Ue=0,q<Je){Ee=q,Je-=Ee;do Ye[L++]=it[Ue++];while(--Ee);Ue=L-gt,dt=Ye}}}else if(Ue+=q-Ee,Ee<Je){Je-=Ee;do Ye[L++]=it[Ue++];while(--Ee);Ue=L-gt,dt=Ye}for(;Je>2;)Ye[L++]=dt[Ue++],Ye[L++]=dt[Ue++],Ye[L++]=dt[Ue++],Je-=3;Je&&(Ye[L++]=dt[Ue++],Je>1&&(Ye[L++]=dt[Ue++]))}else{Ue=L-gt;do Ye[L++]=Ye[Ue++],Ye[L++]=Ye[Ue++],Ye[L++]=Ye[Ue++],Je-=3;while(Je>2);Je&&(Ye[L++]=Ye[Ue++],Je>1&&(Ye[L++]=Ye[Ue++]))}break}}break}}while(v<U&&L<ee);Je=Pe>>3,v-=Je,Pe-=Je<<3,ze&=(1<<Pe)-1,f.next_in=v,f.next_out=L,f.avail_in=v<U?U-v+5:5-(v-U),f.avail_out=L<ee?ee-L+257:257-(L-ee),At.hold=ze,At.bits=Pe};const Ho=15,ug=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),dg=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),pg=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),fg=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Or=(f,M,v,U,L,T,ee,V)=>{const ve=V.bits;let j,q,it,ze,Pe,Dt,pt=0,Xe=0,mt=0,tt=0,Ee=0,Je=0,gt=0,Ue=0,dt=0,st=0,Ye=null;const At=new Uint16Array(16),ri=new Uint16Array(16);let Qr,Xo,Yo,$o=null;for(pt=0;pt<=Ho;pt++)At[pt]=0;for(Xe=0;Xe<U;Xe++)At[M[v+Xe]]++;for(Ee=ve,tt=Ho;tt>=1&&At[tt]===0;tt--);if(Ee>tt&&(Ee=tt),tt===0)return L[T++]=20971520,L[T++]=20971520,V.bits=1,0;for(mt=1;mt<tt&&At[mt]===0;mt++);for(Ee<mt&&(Ee=mt),Ue=1,pt=1;pt<=Ho;pt++)if(Ue<<=1,Ue-=At[pt],Ue<0)return-1;if(Ue>0&&(f===0||tt!==1))return-1;for(ri[1]=0,pt=1;pt<Ho;pt++)ri[pt+1]=ri[pt]+At[pt];for(Xe=0;Xe<U;Xe++)M[v+Xe]!==0&&(ee[ri[M[v+Xe]]++]=Xe);if(f===0?(Ye=$o=ee,Dt=20):f===1?(Ye=ug,$o=dg,Dt=257):(Ye=pg,$o=fg,Dt=0),st=0,Xe=0,pt=mt,Pe=T,Je=Ee,gt=0,it=-1,dt=1<<Ee,ze=dt-1,f===1&&dt>852||f===2&&dt>592)return 1;for(;;){Qr=pt-gt,ee[Xe]+1<Dt?(Xo=0,Yo=ee[Xe]):ee[Xe]>=Dt?(Xo=$o[ee[Xe]-Dt],Yo=Ye[ee[Xe]-Dt]):(Xo=96,Yo=0),j=1<<pt-gt,q=1<<Je,mt=q;do q-=j,L[Pe+(st>>gt)+q]=Qr<<24|Xo<<16|Yo|0;while(q!==0);for(j=1<<pt-1;st&j;)j>>=1;if(j!==0?(st&=j-1,st+=j):st=0,Xe++,--At[pt]==0){if(pt===tt)break;pt=M[v+ee[Xe]]}if(pt>Ee&&(st&ze)!==it){for(gt===0&&(gt=Ee),Pe+=mt,Je=pt-gt,Ue=1<<Je;Je+gt<tt&&(Ue-=At[Je+gt],!(Ue<=0));)Je++,Ue<<=1;if(dt+=1<<Je,f===1&&dt>852||f===2&&dt>592)return 1;it=st&ze,L[it]=Ee<<24|Je<<16|Pe-T|0}}return st!==0&&(L[Pe+st]=pt-gt<<24|64<<16|0),V.bits=Ee,0};const{Z_FINISH:Ec,Z_BLOCK:mg,Z_TREES:jo,Z_OK:Is,Z_STREAM_END:gg,Z_NEED_DICT:_g,Z_STREAM_ERROR:xi,Z_DATA_ERROR:Ic,Z_MEM_ERROR:Fc,Z_BUF_ERROR:vg,Z_DEFLATED:Sc}=S,zo=16180,Go=16190,Ki=16191,Ya=16192,$a=16194,Wo=16199,Ko=16200,Za=16206,Ft=16209,Tc=f=>(f>>>24&255)+(f>>>8&65280)+((65280&f)<<8)+((255&f)<<24);function Pg(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Fs=f=>{if(!f)return 1;const M=f.state;return!M||M.strm!==f||M.mode<zo||M.mode>16211?1:0},Dc=f=>{if(Fs(f))return xi;const M=f.state;return f.total_in=f.total_out=M.total=0,f.msg="",M.wrap&&(f.adler=1&M.wrap),M.mode=zo,M.last=0,M.havedict=0,M.flags=-1,M.dmax=32768,M.head=null,M.hold=0,M.bits=0,M.lencode=M.lendyn=new Int32Array(852),M.distcode=M.distdyn=new Int32Array(592),M.sane=1,M.back=-1,Is},Rc=f=>{if(Fs(f))return xi;const M=f.state;return M.wsize=0,M.whave=0,M.wnext=0,Dc(f)},Lc=(f,M)=>{let v;if(Fs(f))return xi;const U=f.state;return M<0?(v=0,M=-M):(v=5+(M>>4),M<48&&(M&=15)),M&&(M<8||M>15)?xi:(U.window!==null&&U.wbits!==M&&(U.window=null),U.wrap=v,U.wbits=M,Rc(f))},Uc=(f,M)=>{if(!f)return xi;const v=new Pg;f.state=v,v.strm=f,v.window=null,v.mode=zo;const U=Lc(f,M);return U!==Is&&(f.state=null),U};let qa,Ja,Oc=!0;const xg=f=>{if(Oc){qa=new Int32Array(512),Ja=new Int32Array(32);let M=0;for(;M<144;)f.lens[M++]=8;for(;M<256;)f.lens[M++]=9;for(;M<280;)f.lens[M++]=7;for(;M<288;)f.lens[M++]=8;for(Or(1,f.lens,0,288,qa,0,f.work,{bits:9}),M=0;M<32;)f.lens[M++]=5;Or(2,f.lens,0,32,Ja,0,f.work,{bits:5}),Oc=!1}f.lencode=qa,f.lenbits=9,f.distcode=Ja,f.distbits=5},kc=(f,M,v,U)=>{let L;const T=f.state;return T.window===null&&(T.wsize=1<<T.wbits,T.wnext=0,T.whave=0,T.window=new Uint8Array(T.wsize)),U>=T.wsize?(T.window.set(M.subarray(v-T.wsize,v),0),T.wnext=0,T.whave=T.wsize):(L=T.wsize-T.wnext,L>U&&(L=U),T.window.set(M.subarray(v-U,v-U+L),T.wnext),(U-=L)?(T.window.set(M.subarray(v-U,v),0),T.wnext=U,T.whave=T.wsize):(T.wnext+=L,T.wnext===T.wsize&&(T.wnext=0),T.whave<T.wsize&&(T.whave+=L))),0};var Xi={inflateReset:Rc,inflateReset2:Lc,inflateResetKeep:Dc,inflateInit:f=>Uc(f,15),inflateInit2:Uc,inflate:(f,M)=>{let v,U,L,T,ee,V,ve,j,q,it,ze,Pe,Dt,pt,Xe,mt,tt,Ee,Je,gt,Ue,dt,st=0;const Ye=new Uint8Array(4);let At,ri;const Qr=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Fs(f)||!f.output||!f.input&&f.avail_in!==0)return xi;v=f.state,v.mode===Ki&&(v.mode=Ya),ee=f.next_out,L=f.output,ve=f.avail_out,T=f.next_in,U=f.input,V=f.avail_in,j=v.hold,q=v.bits,it=V,ze=ve,dt=Is;e:for(;;)switch(v.mode){case zo:if(v.wrap===0){v.mode=Ya;break}for(;q<16;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}if(2&v.wrap&&j===35615){v.wbits===0&&(v.wbits=15),v.check=0,Ye[0]=255&j,Ye[1]=j>>>8&255,v.check=Be(v.check,Ye,2,0),j=0,q=0,v.mode=16181;break}if(v.head&&(v.head.done=!1),!(1&v.wrap)||(((255&j)<<8)+(j>>8))%31){f.msg="incorrect header check",v.mode=Ft;break}if((15&j)!==Sc){f.msg="unknown compression method",v.mode=Ft;break}if(j>>>=4,q-=4,Ue=8+(15&j),v.wbits===0&&(v.wbits=Ue),Ue>15||Ue>v.wbits){f.msg="invalid window size",v.mode=Ft;break}v.dmax=1<<v.wbits,v.flags=0,f.adler=v.check=1,v.mode=512&j?16189:Ki,j=0,q=0;break;case 16181:for(;q<16;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}if(v.flags=j,(255&v.flags)!==Sc){f.msg="unknown compression method",v.mode=Ft;break}if(57344&v.flags){f.msg="unknown header flags set",v.mode=Ft;break}v.head&&(v.head.text=j>>8&1),512&v.flags&&4&v.wrap&&(Ye[0]=255&j,Ye[1]=j>>>8&255,v.check=Be(v.check,Ye,2,0)),j=0,q=0,v.mode=16182;case 16182:for(;q<32;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}v.head&&(v.head.time=j),512&v.flags&&4&v.wrap&&(Ye[0]=255&j,Ye[1]=j>>>8&255,Ye[2]=j>>>16&255,Ye[3]=j>>>24&255,v.check=Be(v.check,Ye,4,0)),j=0,q=0,v.mode=16183;case 16183:for(;q<16;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}v.head&&(v.head.xflags=255&j,v.head.os=j>>8),512&v.flags&&4&v.wrap&&(Ye[0]=255&j,Ye[1]=j>>>8&255,v.check=Be(v.check,Ye,2,0)),j=0,q=0,v.mode=16184;case 16184:if(1024&v.flags){for(;q<16;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}v.length=j,v.head&&(v.head.extra_len=j),512&v.flags&&4&v.wrap&&(Ye[0]=255&j,Ye[1]=j>>>8&255,v.check=Be(v.check,Ye,2,0)),j=0,q=0}else v.head&&(v.head.extra=null);v.mode=16185;case 16185:if(1024&v.flags&&(Pe=v.length,Pe>V&&(Pe=V),Pe&&(v.head&&(Ue=v.head.extra_len-v.length,v.head.extra||(v.head.extra=new Uint8Array(v.head.extra_len)),v.head.extra.set(U.subarray(T,T+Pe),Ue)),512&v.flags&&4&v.wrap&&(v.check=Be(v.check,U,Pe,T)),V-=Pe,T+=Pe,v.length-=Pe),v.length))break e;v.length=0,v.mode=16186;case 16186:if(2048&v.flags){if(V===0)break e;Pe=0;do Ue=U[T+Pe++],v.head&&Ue&&v.length<65536&&(v.head.name+=String.fromCharCode(Ue));while(Ue&&Pe<V);if(512&v.flags&&4&v.wrap&&(v.check=Be(v.check,U,Pe,T)),V-=Pe,T+=Pe,Ue)break e}else v.head&&(v.head.name=null);v.length=0,v.mode=16187;case 16187:if(4096&v.flags){if(V===0)break e;Pe=0;do Ue=U[T+Pe++],v.head&&Ue&&v.length<65536&&(v.head.comment+=String.fromCharCode(Ue));while(Ue&&Pe<V);if(512&v.flags&&4&v.wrap&&(v.check=Be(v.check,U,Pe,T)),V-=Pe,T+=Pe,Ue)break e}else v.head&&(v.head.comment=null);v.mode=16188;case 16188:if(512&v.flags){for(;q<16;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}if(4&v.wrap&&j!==(65535&v.check)){f.msg="header crc mismatch",v.mode=Ft;break}j=0,q=0}v.head&&(v.head.hcrc=v.flags>>9&1,v.head.done=!0),f.adler=v.check=0,v.mode=Ki;break;case 16189:for(;q<32;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}f.adler=v.check=Tc(j),j=0,q=0,v.mode=Go;case Go:if(v.havedict===0)return f.next_out=ee,f.avail_out=ve,f.next_in=T,f.avail_in=V,v.hold=j,v.bits=q,_g;f.adler=v.check=1,v.mode=Ki;case Ki:if(M===mg||M===jo)break e;case Ya:if(v.last){j>>>=7&q,q-=7&q,v.mode=Za;break}for(;q<3;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}switch(v.last=1&j,j>>>=1,q-=1,3&j){case 0:v.mode=16193;break;case 1:if(xg(v),v.mode=Wo,M===jo){j>>>=2,q-=2;break e}break;case 2:v.mode=16196;break;case 3:f.msg="invalid block type",v.mode=Ft}j>>>=2,q-=2;break;case 16193:for(j>>>=7&q,q-=7&q;q<32;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}if((65535&j)!=(j>>>16^65535)){f.msg="invalid stored block lengths",v.mode=Ft;break}if(v.length=65535&j,j=0,q=0,v.mode=$a,M===jo)break e;case $a:v.mode=16195;case 16195:if(Pe=v.length,Pe){if(Pe>V&&(Pe=V),Pe>ve&&(Pe=ve),Pe===0)break e;L.set(U.subarray(T,T+Pe),ee),V-=Pe,T+=Pe,ve-=Pe,ee+=Pe,v.length-=Pe;break}v.mode=Ki;break;case 16196:for(;q<14;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}if(v.nlen=257+(31&j),j>>>=5,q-=5,v.ndist=1+(31&j),j>>>=5,q-=5,v.ncode=4+(15&j),j>>>=4,q-=4,v.nlen>286||v.ndist>30){f.msg="too many length or distance symbols",v.mode=Ft;break}v.have=0,v.mode=16197;case 16197:for(;v.have<v.ncode;){for(;q<3;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}v.lens[Qr[v.have++]]=7&j,j>>>=3,q-=3}for(;v.have<19;)v.lens[Qr[v.have++]]=0;if(v.lencode=v.lendyn,v.lenbits=7,At={bits:v.lenbits},dt=Or(0,v.lens,0,19,v.lencode,0,v.work,At),v.lenbits=At.bits,dt){f.msg="invalid code lengths set",v.mode=Ft;break}v.have=0,v.mode=16198;case 16198:for(;v.have<v.nlen+v.ndist;){for(;st=v.lencode[j&(1<<v.lenbits)-1],Xe=st>>>24,mt=st>>>16&255,tt=65535&st,!(Xe<=q);){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}if(tt<16)j>>>=Xe,q-=Xe,v.lens[v.have++]=tt;else{if(tt===16){for(ri=Xe+2;q<ri;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}if(j>>>=Xe,q-=Xe,v.have===0){f.msg="invalid bit length repeat",v.mode=Ft;break}Ue=v.lens[v.have-1],Pe=3+(3&j),j>>>=2,q-=2}else if(tt===17){for(ri=Xe+3;q<ri;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}j>>>=Xe,q-=Xe,Ue=0,Pe=3+(7&j),j>>>=3,q-=3}else{for(ri=Xe+7;q<ri;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}j>>>=Xe,q-=Xe,Ue=0,Pe=11+(127&j),j>>>=7,q-=7}if(v.have+Pe>v.nlen+v.ndist){f.msg="invalid bit length repeat",v.mode=Ft;break}for(;Pe--;)v.lens[v.have++]=Ue}}if(v.mode===Ft)break;if(v.lens[256]===0){f.msg="invalid code -- missing end-of-block",v.mode=Ft;break}if(v.lenbits=9,At={bits:v.lenbits},dt=Or(1,v.lens,0,v.nlen,v.lencode,0,v.work,At),v.lenbits=At.bits,dt){f.msg="invalid literal/lengths set",v.mode=Ft;break}if(v.distbits=6,v.distcode=v.distdyn,At={bits:v.distbits},dt=Or(2,v.lens,v.nlen,v.ndist,v.distcode,0,v.work,At),v.distbits=At.bits,dt){f.msg="invalid distances set",v.mode=Ft;break}if(v.mode=Wo,M===jo)break e;case Wo:v.mode=Ko;case Ko:if(V>=6&&ve>=258){f.next_out=ee,f.avail_out=ve,f.next_in=T,f.avail_in=V,v.hold=j,v.bits=q,hg(f,ze),ee=f.next_out,L=f.output,ve=f.avail_out,T=f.next_in,U=f.input,V=f.avail_in,j=v.hold,q=v.bits,v.mode===Ki&&(v.back=-1);break}for(v.back=0;st=v.lencode[j&(1<<v.lenbits)-1],Xe=st>>>24,mt=st>>>16&255,tt=65535&st,!(Xe<=q);){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}if(mt&&!(240&mt)){for(Ee=Xe,Je=mt,gt=tt;st=v.lencode[gt+((j&(1<<Ee+Je)-1)>>Ee)],Xe=st>>>24,mt=st>>>16&255,tt=65535&st,!(Ee+Xe<=q);){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}j>>>=Ee,q-=Ee,v.back+=Ee}if(j>>>=Xe,q-=Xe,v.back+=Xe,v.length=tt,mt===0){v.mode=16205;break}if(32&mt){v.back=-1,v.mode=Ki;break}if(64&mt){f.msg="invalid literal/length code",v.mode=Ft;break}v.extra=15&mt,v.mode=16201;case 16201:if(v.extra){for(ri=v.extra;q<ri;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}v.length+=j&(1<<v.extra)-1,j>>>=v.extra,q-=v.extra,v.back+=v.extra}v.was=v.length,v.mode=16202;case 16202:for(;st=v.distcode[j&(1<<v.distbits)-1],Xe=st>>>24,mt=st>>>16&255,tt=65535&st,!(Xe<=q);){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}if(!(240&mt)){for(Ee=Xe,Je=mt,gt=tt;st=v.distcode[gt+((j&(1<<Ee+Je)-1)>>Ee)],Xe=st>>>24,mt=st>>>16&255,tt=65535&st,!(Ee+Xe<=q);){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}j>>>=Ee,q-=Ee,v.back+=Ee}if(j>>>=Xe,q-=Xe,v.back+=Xe,64&mt){f.msg="invalid distance code",v.mode=Ft;break}v.offset=tt,v.extra=15&mt,v.mode=16203;case 16203:if(v.extra){for(ri=v.extra;q<ri;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}v.offset+=j&(1<<v.extra)-1,j>>>=v.extra,q-=v.extra,v.back+=v.extra}if(v.offset>v.dmax){f.msg="invalid distance too far back",v.mode=Ft;break}v.mode=16204;case 16204:if(ve===0)break e;if(Pe=ze-ve,v.offset>Pe){if(Pe=v.offset-Pe,Pe>v.whave&&v.sane){f.msg="invalid distance too far back",v.mode=Ft;break}Pe>v.wnext?(Pe-=v.wnext,Dt=v.wsize-Pe):Dt=v.wnext-Pe,Pe>v.length&&(Pe=v.length),pt=v.window}else pt=L,Dt=ee-v.offset,Pe=v.length;Pe>ve&&(Pe=ve),ve-=Pe,v.length-=Pe;do L[ee++]=pt[Dt++];while(--Pe);v.length===0&&(v.mode=Ko);break;case 16205:if(ve===0)break e;L[ee++]=v.length,ve--,v.mode=Ko;break;case Za:if(v.wrap){for(;q<32;){if(V===0)break e;V--,j|=U[T++]<<q,q+=8}if(ze-=ve,f.total_out+=ze,v.total+=ze,4&v.wrap&&ze&&(f.adler=v.check=v.flags?Be(v.check,L,ze,ee-ze):Te(v.check,L,ze,ee-ze)),ze=ve,4&v.wrap&&(v.flags?j:Tc(j))!==v.check){f.msg="incorrect data check",v.mode=Ft;break}j=0,q=0}v.mode=16207;case 16207:if(v.wrap&&v.flags){for(;q<32;){if(V===0)break e;V--,j+=U[T++]<<q,q+=8}if(4&v.wrap&&j!==(4294967295&v.total)){f.msg="incorrect length check",v.mode=Ft;break}j=0,q=0}v.mode=16208;case 16208:dt=gg;break e;case Ft:dt=Ic;break e;case 16210:return Fc;default:return xi}return f.next_out=ee,f.avail_out=ve,f.next_in=T,f.avail_in=V,v.hold=j,v.bits=q,(v.wsize||ze!==f.avail_out&&v.mode<Ft&&(v.mode<Za||M!==Ec))&&kc(f,f.output,f.next_out,ze-f.avail_out),it-=f.avail_in,ze-=f.avail_out,f.total_in+=it,f.total_out+=ze,v.total+=ze,4&v.wrap&&ze&&(f.adler=v.check=v.flags?Be(v.check,L,ze,f.next_out-ze):Te(v.check,L,ze,f.next_out-ze)),f.data_type=v.bits+(v.last?64:0)+(v.mode===Ki?128:0)+(v.mode===Wo||v.mode===$a?256:0),(it===0&&ze===0||M===Ec)&&dt===Is&&(dt=vg),dt},inflateEnd:f=>{if(Fs(f))return xi;let M=f.state;return M.window&&(M.window=null),f.state=null,Is},inflateGetHeader:(f,M)=>{if(Fs(f))return xi;const v=f.state;return 2&v.wrap?(v.head=M,M.done=!1,Is):xi},inflateSetDictionary:(f,M)=>{const v=M.length;let U,L,T;return Fs(f)?xi:(U=f.state,U.wrap!==0&&U.mode!==Go?xi:U.mode===Go&&(L=1,L=Te(L,M,v,0),L!==U.check)?Ic:(T=kc(f,M,v,v),T?(U.mode=16210,Fc):(U.havedict=1,Is)))},inflateInfo:"pako inflate (from Nodeca project)"},yg=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const Nc=Object.prototype.toString,{Z_NO_FLUSH:bg,Z_FINISH:Bg,Z_OK:kr,Z_STREAM_END:el,Z_NEED_DICT:tl,Z_STREAM_ERROR:wg,Z_DATA_ERROR:Qc,Z_MEM_ERROR:Cg}=S;function Nr(f){this.options=bc({chunkSize:65536,windowBits:15,to:""},f||{});const M=this.options;M.raw&&M.windowBits>=0&&M.windowBits<16&&(M.windowBits=-M.windowBits,M.windowBits===0&&(M.windowBits=-15)),!(M.windowBits>=0&&M.windowBits<16)||f&&f.windowBits||(M.windowBits+=32),M.windowBits>15&&M.windowBits<48&&!(15&M.windowBits)&&(M.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Cc,this.strm.avail_out=0;let v=Xi.inflateInit2(this.strm,M.windowBits);if(v!==kr)throw new Error(Se[v]);if(this.header=new yg,Xi.inflateGetHeader(this.strm,this.header),M.dictionary&&(typeof M.dictionary=="string"?M.dictionary=Ka(M.dictionary):Nc.call(M.dictionary)==="[object ArrayBuffer]"&&(M.dictionary=new Uint8Array(M.dictionary)),M.raw&&(v=Xi.inflateSetDictionary(this.strm,M.dictionary),v!==kr)))throw new Error(Se[v])}function il(f,M){const v=new Nr(M);if(v.push(f),v.err)throw v.msg||Se[v.err];return v.result}Nr.prototype.push=function(f,M){const v=this.strm,U=this.options.chunkSize,L=this.options.dictionary;let T,ee,V;if(this.ended)return!1;for(ee=M===~~M?M:M===!0?Bg:bg,Nc.call(f)==="[object ArrayBuffer]"?v.input=new Uint8Array(f):v.input=f,v.next_in=0,v.avail_in=v.input.length;;){for(v.avail_out===0&&(v.output=new Uint8Array(U),v.next_out=0,v.avail_out=U),T=Xi.inflate(v,ee),T===tl&&L&&(T=Xi.inflateSetDictionary(v,L),T===kr?T=Xi.inflate(v,ee):T===Qc&&(T=tl));v.avail_in>0&&T===el&&v.state.wrap>0&&f[v.next_in]!==0;)Xi.inflateReset(v),T=Xi.inflate(v,ee);switch(T){case wg:case Qc:case tl:case Cg:return this.onEnd(T),this.ended=!0,!1}if(V=v.avail_out,v.next_out&&(v.avail_out===0||T===el))if(this.options.to==="string"){let ve=tg(v.output,v.next_out),j=v.next_out-ve,q=eg(v.output,ve);v.next_out=j,v.avail_out=U-j,j&&v.output.set(v.output.subarray(ve,ve+j),0),this.onData(q)}else this.onData(v.output.length===v.next_out?v.output:v.output.subarray(0,v.next_out));if(T!==kr||V!==0){if(T===el)return T=Xi.inflateEnd(this.strm),this.onEnd(T),this.ended=!0,!0;if(v.avail_in===0)break}}return!0},Nr.prototype.onData=function(f){this.chunks.push(f)},Nr.prototype.onEnd=function(f){f===kr&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Bc(this.chunks)),this.chunks=[],this.err=f,this.msg=this.strm.msg};var Mg={Inflate:Nr,inflate:il,inflateRaw:function(f,M){return(M=M||{}).raw=!0,il(f,M)},ungzip:il,constants:S};const{Deflate:Eg,deflate:Ig,deflateRaw:Fg,gzip:Sg}=cg,{Inflate:Tg,inflate:Dg,inflateRaw:Rg,ungzip:Lg}=Mg;var Vc=Eg,Hc=Ig,jc=Fg,zc=Sg,Gc=Tg,Wc=Dg,Kc=Rg,Xc=Lg,Yc=S,Ug={Deflate:Vc,deflate:Hc,deflateRaw:jc,gzip:zc,Inflate:Gc,inflate:Wc,inflateRaw:Kc,ungzip:Xc,constants:Yc};r.Deflate=Vc,r.Inflate=Gc,r.constants=Yc,r.default=Ug,r.deflate=Hc,r.deflateRaw=jc,r.gzip=zc,r.inflate=Wc,r.inflateRaw=Kc,r.ungzip=Xc,Object.defineProperty(r,"__esModule",{value:!0})});var Wi=Object.freeze({__proto__:null});let li=window.pako||Wi;li.inflate||(li=li.default);const GI=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function WI(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],meshPositions:r[4],meshIndices:r[5],meshEdgesIndices:r[6],meshColors:r[7],entityIDs:r[8],entityMeshes:r[9],entityIsObjects:r[10],positionsDecodeMatrix:r[11]}}function KI(r){return{positions:new Uint16Array(li.inflate(r.positions).buffer),normals:new Int8Array(li.inflate(r.normals).buffer),indices:new Uint32Array(li.inflate(r.indices).buffer),edgeIndices:new Uint32Array(li.inflate(r.edgeIndices).buffer),meshPositions:new Uint32Array(li.inflate(r.meshPositions).buffer),meshIndices:new Uint32Array(li.inflate(r.meshIndices).buffer),meshEdgesIndices:new Uint32Array(li.inflate(r.meshEdgesIndices).buffer),meshColors:new Uint8Array(li.inflate(r.meshColors).buffer),entityIDs:li.inflate(r.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(li.inflate(r.entityMeshes).buffer),entityIsObjects:new Uint8Array(li.inflate(r.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(li.inflate(r.positionsDecodeMatrix).buffer)}}function XI(r,e,t,i,s,o){o.getNextId(),i.positionsCompression="precompressed",i.normalsCompression="precompressed";const a=t.positions,n=t.normals,l=t.indices,c=t.edgeIndices,h=t.meshPositions,d=t.meshIndices,p=t.meshEdgesIndices,m=t.meshColors,g=JSON.parse(t.entityIDs),u=t.entityMeshes,x=t.entityIsObjects,y=h.length,P=u.length;for(let _=0;_<P;_++){const b=g[_],B=e.globalizeObjectIds?A.globalizeObjectId(i.id,b):b,w=r.metaScene.metaObjects[B],C={},E={};if(w){if(e.excludeTypesMap&&w.type&&e.excludeTypesMap[w.type]||e.includeTypesMap&&w.type&&!e.includeTypesMap[w.type])continue;const F=e.objectDefaults?e.objectDefaults[w.type]||e.objectDefaults.DEFAULT:null;F&&(F.visible===!1&&(C.visible=!1),F.pickable===!1&&(C.pickable=!1),F.colorize&&(E.color=F.colorize),F.opacity!==void 0&&F.opacity!==null&&(E.opacity=F.opacity))}else if(e.excludeUnclassifiedObjects)continue;const I=_===P-1,R=[];for(let F=u[_],z=I?u.length:u[_+1];F<z;F++){const Q=F===y-1,H=B+".mesh."+F,ae=GI(m.subarray(F*4,F*4+3)),pe=m[F*4+3]/255;i.createMesh(we.apply(E,{id:H,primitive:"triangles",positionsCompressed:a.subarray(h[F],Q?a.length:h[F+1]),normalsCompressed:n.subarray(h[F],Q?a.length:h[F+1]),indices:l.subarray(d[F],Q?l.length:d[F+1]),edgeIndices:c.subarray(p[F],Q?c.length:p[F+1]),positionsDecodeMatrix:t.positionsDecodeMatrix,color:ae,opacity:pe})),R.push(H)}i.createEntity(we.apply(C,{id:B,isObject:x[_]===1,meshIds:R}))}}const jp={version:1,parse:function(r,e,t,i,s,o){const a=WI(t),n=KI(a);XI(r,e,n,i,s,o)}};let Gt=window.pako||Wi;Gt.inflate||(Gt=Gt.default);function YI(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],meshPositions:r[4],meshIndices:r[5],meshEdgesIndices:r[6],meshColors:r[7],entityIDs:r[8],entityMeshes:r[9],entityIsObjects:r[10],positionsDecodeMatrix:r[11],entityMeshIds:r[12],entityMatrices:r[13],entityUsesInstancing:r[14]}}function $I(r){return{positions:new Uint16Array(Gt.inflate(r.positions).buffer),normals:new Int8Array(Gt.inflate(r.normals).buffer),indices:new Uint32Array(Gt.inflate(r.indices).buffer),edgeIndices:new Uint32Array(Gt.inflate(r.edgeIndices).buffer),meshPositions:new Uint32Array(Gt.inflate(r.meshPositions).buffer),meshIndices:new Uint32Array(Gt.inflate(r.meshIndices).buffer),meshEdgesIndices:new Uint32Array(Gt.inflate(r.meshEdgesIndices).buffer),meshColors:new Uint8Array(Gt.inflate(r.meshColors).buffer),entityIDs:Gt.inflate(r.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(Gt.inflate(r.entityMeshes).buffer),entityIsObjects:new Uint8Array(Gt.inflate(r.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(Gt.inflate(r.positionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(Gt.inflate(r.entityMeshIds).buffer),entityMatrices:new Float32Array(Gt.inflate(r.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(Gt.inflate(r.entityUsesInstancing).buffer)}}const ZI=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function qI(r,e,t,i,s,o){const a=o.getNextId();i.positionsCompression="precompressed",i.normalsCompression="precompressed";const n=t.positions,l=t.normals,c=t.indices,h=t.edgeIndices,d=t.meshPositions,p=t.meshIndices,m=t.meshEdgesIndices,g=t.meshColors,u=JSON.parse(t.entityIDs),x=t.entityMeshes,y=t.entityIsObjects,P=t.entityMeshIds,_=t.entityMatrices,b=t.entityUsesInstancing,B=d.length,w=x.length,C={};for(let E=0;E<w;E++){const I=u[E],R=e.globalizeObjectIds?A.globalizeObjectId(i.id,I):I,F=r.metaScene.metaObjects[R],z={},Q={},H=_.subarray(E*16,E*16+16);if(F){if(e.excludeTypesMap&&F.type&&e.excludeTypesMap[F.type]||e.includeTypesMap&&F.type&&!e.includeTypesMap[F.type])continue;const ge=e.objectDefaults?e.objectDefaults[F.type]||e.objectDefaults.DEFAULT:null;ge&&(ge.visible===!1&&(z.visible=!1),ge.pickable===!1&&(z.pickable=!1),ge.colorize&&(Q.color=ge.colorize),ge.opacity!==void 0&&ge.opacity!==null&&(Q.opacity=ge.opacity))}else if(e.excludeUnclassifiedObjects)continue;const ae=E===w-1,pe=[];for(let ge=x[E],fe=ae?P.length:x[E+1];ge<fe;ge++){const Me=P[ge],be=Me===B-1,Fe=o.getNextId(),Re=ZI(g.subarray(Me*4,Me*4+3)),Te=g[Me*4+3]/255,Ne=n.subarray(d[Me],be?n.length:d[Me+1]),Be=l.subarray(d[Me],be?n.length:d[Me+1]),Se=c.subarray(p[Me],be?c.length:p[Me+1]),S=h.subarray(m[Me],be?h.length:m[Me+1]);if(b[E]===1){const k=`${a}.geometry.${Fe}.${Me}`;k in C||(i.createGeometry({id:k,positionsCompressed:Ne,normalsCompressed:Be,indices:Se,edgeIndices:S,primitive:"triangles",positionsDecodeMatrix:t.positionsDecodeMatrix}),C[k]=!0),i.createMesh(we.apply(Q,{id:Fe,color:Re,opacity:Te,matrix:H,geometryId:k})),pe.push(Fe)}else i.createMesh(we.apply(Q,{id:Fe,primitive:"triangles",positionsCompressed:Ne,normalsCompressed:Be,indices:Se,edgeIndices:S,positionsDecodeMatrix:t.positionsDecodeMatrix,color:Re,opacity:Te})),pe.push(Fe)}pe.length&&i.createEntity(we.apply(z,{id:R,isObject:y[E]===1,meshIds:pe}))}}const zp={version:2,parse:function(r,e,t,i,s,o){const a=YI(t),n=$I(a);qI(r,e,n,i,s,o)}};let Qt=window.pako||Wi;Qt.inflate||(Qt=Qt.default);function JI(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],meshPositions:r[4],meshIndices:r[5],meshEdgesIndices:r[6],meshColors:r[7],entityIDs:r[8],entityMeshes:r[9],entityIsObjects:r[10],instancedPositionsDecodeMatrix:r[11],batchedPositionsDecodeMatrix:r[12],entityMeshIds:r[13],entityMatrices:r[14],entityUsesInstancing:r[15]}}function eF(r){return{positions:new Uint16Array(Qt.inflate(r.positions).buffer),normals:new Int8Array(Qt.inflate(r.normals).buffer),indices:new Uint32Array(Qt.inflate(r.indices).buffer),edgeIndices:new Uint32Array(Qt.inflate(r.edgeIndices).buffer),meshPositions:new Uint32Array(Qt.inflate(r.meshPositions).buffer),meshIndices:new Uint32Array(Qt.inflate(r.meshIndices).buffer),meshEdgesIndices:new Uint32Array(Qt.inflate(r.meshEdgesIndices).buffer),meshColors:new Uint8Array(Qt.inflate(r.meshColors).buffer),entityIDs:Qt.inflate(r.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(Qt.inflate(r.entityMeshes).buffer),entityIsObjects:new Uint8Array(Qt.inflate(r.entityIsObjects).buffer),instancedPositionsDecodeMatrix:new Float32Array(Qt.inflate(r.instancedPositionsDecodeMatrix).buffer),batchedPositionsDecodeMatrix:new Float32Array(Qt.inflate(r.batchedPositionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(Qt.inflate(r.entityMeshIds).buffer),entityMatrices:new Float32Array(Qt.inflate(r.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(Qt.inflate(r.entityUsesInstancing).buffer)}}const tF=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function iF(r,e,t,i,s,o){const a=o.getNextId();i.positionsCompression="precompressed",i.normalsCompression="precompressed";const n=t.positions,l=t.normals,c=t.indices,h=t.edgeIndices,d=t.meshPositions,p=t.meshIndices,m=t.meshEdgesIndices,g=t.meshColors,u=JSON.parse(t.entityIDs),x=t.entityMeshes,y=t.entityIsObjects,P=t.entityMeshIds,_=t.entityMatrices,b=t.entityUsesInstancing,B=d.length,w=x.length,C={};for(let Q=0;Q<w;Q++){const H=u[Q],ae=e.globalizeObjectIds?A.globalizeObjectId(i.id,H):H,pe=r.metaScene.metaObjects[ae],ge={},fe={},Me=_.subarray(Q*16,Q*16+16);if(pe){if(e.excludeTypesMap&&pe.type&&e.excludeTypesMap[pe.type]||e.includeTypesMap&&pe.type&&!e.includeTypesMap[pe.type])continue;const Re=e.objectDefaults?e.objectDefaults[pe.type]||e.objectDefaults.DEFAULT:null;Re&&(Re.visible===!1&&(ge.visible=!1),Re.pickable===!1&&(ge.pickable=!1),Re.colorize&&(fe.color=Re.colorize),Re.opacity!==void 0&&Re.opacity!==null&&(fe.opacity=Re.opacity))}else if(e.excludeUnclassifiedObjects)continue;const be=Q===w-1,Fe=[];for(let Re=x[Q],Te=be?P.length:x[Q+1];Re<Te;Re++){var E=P[Re];const Ne=E===B-1,Be=`${a}.${ae}.mesh.${E}`,Se=tF(g.subarray(E*4,E*4+3)),S=g[E*4+3]/255;var I=n.subarray(d[E],Ne?n.length:d[E+1]),R=l.subarray(d[E],Ne?n.length:d[E+1]),F=c.subarray(p[E],Ne?c.length:p[E+1]),z=h.subarray(m[E],Ne?h.length:m[E+1]);if(b[Q]===1){const k=`${a}.geometry.${Be}.${E}`;k in C||(i.createGeometry({id:k,positionsCompressed:I,normalsCompressed:R,indices:F,edgeIndices:z,primitive:"triangles",positionsDecodeMatrix:t.instancedPositionsDecodeMatrix}),C[k]=!0),i.createMesh(we.apply(fe,{id:Be,color:Se,opacity:S,matrix:Me,geometryId:k})),Fe.push(Be)}else i.createMesh(we.apply(fe,{id:Be,primitive:"triangles",positionsCompressed:I,normalsCompressed:R,indices:F,edgeIndices:z,positionsDecodeMatrix:t.batchedPositionsDecodeMatrix,color:Se,opacity:S})),Fe.push(Be)}Fe.length&&i.createEntity(we.apply(ge,{id:ae,isObject:y[Q]===1,meshIds:Fe}))}}const Gp={version:3,parse:function(r,e,t,i,s,o){const a=JI(t),n=eF(a);iF(r,e,n,i,s,o)}};let Wt=window.pako||Wi;Wt.inflate||(Wt=Wt.default);function sF(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],decodeMatrices:r[4],matrices:r[5],eachPrimitivePositionsAndNormalsPortion:r[6],eachPrimitiveIndicesPortion:r[7],eachPrimitiveEdgeIndicesPortion:r[8],eachPrimitiveDecodeMatricesPortion:r[9],eachPrimitiveColor:r[10],primitiveInstances:r[11],eachEntityId:r[12],eachEntityPrimitiveInstancesPortion:r[13],eachEntityMatricesPortion:r[14],eachEntityMatrix:r[15]}}function rF(r){return{positions:new Uint16Array(Wt.inflate(r.positions).buffer),normals:new Int8Array(Wt.inflate(r.normals).buffer),indices:new Uint32Array(Wt.inflate(r.indices).buffer),edgeIndices:new Uint32Array(Wt.inflate(r.edgeIndices).buffer),decodeMatrices:new Float32Array(Wt.inflate(r.decodeMatrices).buffer),matrices:new Float32Array(Wt.inflate(r.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(Wt.inflate(r.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(Wt.inflate(r.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(Wt.inflate(r.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveDecodeMatricesPortion:new Uint32Array(Wt.inflate(r.eachPrimitiveDecodeMatricesPortion).buffer),eachPrimitiveColor:new Uint8Array(Wt.inflate(r.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(Wt.inflate(r.primitiveInstances).buffer),eachEntityId:Wt.inflate(r.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(Wt.inflate(r.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(Wt.inflate(r.eachEntityMatricesPortion).buffer)}}const oF=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function nF(r,e,t,i,s,o){const a=o.getNextId();i.positionsCompression="precompressed",i.normalsCompression="precompressed";const n=t.positions,l=t.normals,c=t.indices,h=t.edgeIndices,d=t.decodeMatrices,p=t.matrices,m=t.eachPrimitivePositionsAndNormalsPortion,g=t.eachPrimitiveIndicesPortion,u=t.eachPrimitiveEdgeIndicesPortion,x=t.eachPrimitiveDecodeMatricesPortion,y=t.eachPrimitiveColor,P=t.primitiveInstances,_=JSON.parse(t.eachEntityId),b=t.eachEntityPrimitiveInstancesPortion,B=t.eachEntityMatricesPortion,w=m.length,C=P.length,E=new Uint8Array(w),I=new Uint32Array(w),R=_.length;for(let Q=0;Q<w;Q++)I[Q]=Q;I.sort((Q,H)=>x[Q]<x[H]?-1:x[Q]>x[H]?1:0);for(let Q=0;Q<C;Q++){const H=P[Q];E[H]++}const F={};for(let Q=0;Q<R;Q++){const H=R-1,ae=Q===H,pe=b[Q],ge=ae?b[H]:b[Q+1];for(let fe=pe;fe<ge;fe++){const Me=P[fe];E[Me]>1||(F[Me]=Q)}}for(let Q=0;Q<w;Q++){const H=I[Q],ae=H===w-1,ge=E[H]>1,fe=oF(y.subarray(H*4,H*4+3)),Me=y[H*4+3]/255,be=n.subarray(m[H],ae?n.length:m[H+1]),Fe=l.subarray(m[H],ae?l.length:m[H+1]),Re=c.subarray(g[H],ae?c.length:g[H+1]),Te=h.subarray(u[H],ae?h.length:u[H+1]),Ne=d.subarray(x[H],x[H]+16);if(ge){const Be=`${a}-geometry.${H}`;i.createGeometry({id:Be,primitive:"triangles",positionsCompressed:be,normalsCompressed:Fe,indices:Re,edgeIndices:Te,positionsDecodeMatrix:Ne})}else{const Be=`${a}-${H}`,Se=F[H];_[Se];const S={};i.createMesh(we.apply(S,{id:Be,primitive:"triangles",positionsCompressed:be,normalsCompressed:Fe,indices:Re,edgeIndices:Te,positionsDecodeMatrix:Ne,color:fe,opacity:Me}))}}let z=0;for(let Q=0;Q<R;Q++){const H=R-1,ae=Q===H,pe=_[Q],ge=b[Q],fe=ae?b[H]:b[Q+1],Me=[];for(let be=ge;be<fe;be++){const Fe=P[be];if(E[Fe]>1){const Ne={},Be=`${a}-instance.${z++}`,Se=`${a}-geometry.${Fe}`,S=B[Q]*16,k=p.subarray(S,S+16);i.createMesh(we.apply(Ne,{id:Be,geometryId:Se,matrix:k})),Me.push(Be)}else Me.push(Fe)}if(Me.length>0){const be={};i.createEntity(we.apply(be,{id:pe,isObject:!0,meshIds:Me}))}}}const Wp={version:4,parse:function(r,e,t,i,s,o){const a=sF(t),n=rF(a);nF(r,e,n,i,s,o)}};let ei=window.pako||Wi;ei.inflate||(ei=ei.default);function aF(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],matrices:r[4],eachPrimitivePositionsAndNormalsPortion:r[5],eachPrimitiveIndicesPortion:r[6],eachPrimitiveEdgeIndicesPortion:r[7],eachPrimitiveColor:r[8],primitiveInstances:r[9],eachEntityId:r[10],eachEntityPrimitiveInstancesPortion:r[11],eachEntityMatricesPortion:r[12]}}function lF(r){return{positions:new Float32Array(ei.inflate(r.positions).buffer),normals:new Int8Array(ei.inflate(r.normals).buffer),indices:new Uint32Array(ei.inflate(r.indices).buffer),edgeIndices:new Uint32Array(ei.inflate(r.edgeIndices).buffer),matrices:new Float32Array(ei.inflate(r.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(ei.inflate(r.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(ei.inflate(r.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(ei.inflate(r.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveColor:new Uint8Array(ei.inflate(r.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(ei.inflate(r.primitiveInstances).buffer),eachEntityId:ei.inflate(r.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(ei.inflate(r.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(ei.inflate(r.eachEntityMatricesPortion).buffer)}}const AF=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function cF(r,e,t,i,s,o){const a=o.getNextId();i.positionsCompression="disabled",i.normalsCompression="precompressed";const n=t.positions,l=t.normals,c=t.indices,h=t.edgeIndices,d=t.matrices,p=t.eachPrimitivePositionsAndNormalsPortion,m=t.eachPrimitiveIndicesPortion,g=t.eachPrimitiveEdgeIndicesPortion,u=t.eachPrimitiveColor,x=t.primitiveInstances,y=JSON.parse(t.eachEntityId),P=t.eachEntityPrimitiveInstancesPortion,_=t.eachEntityMatricesPortion,b=p.length,B=x.length,w=new Uint8Array(b),C=y.length;for(let R=0;R<B;R++){const F=x[R];w[F]++}const E={};for(let R=0;R<C;R++){const F=C-1,z=R===F,Q=P[R],H=z?P[F]:P[R+1];for(let ae=Q;ae<H;ae++){const pe=x[ae];w[pe]>1||(E[pe]=R)}}for(let R=0;R<b;R++){const F=R===b-1,Q=w[R]>1,H=AF(u.subarray(R*4,R*4+3)),ae=u[R*4+3]/255,pe=n.subarray(p[R],F?n.length:p[R+1]),ge=l.subarray(p[R],F?l.length:p[R+1]),fe=c.subarray(m[R],F?c.length:m[R+1]),Me=h.subarray(g[R],F?h.length:g[R+1]);if(Q){const be=`${a}-geometry.${R}`;i.createGeometry({id:be,primitive:"triangles",positionsCompressed:pe,normalsCompressed:ge,indices:fe,edgeIndices:Me})}else{const be=R,Fe=E[R];y[Fe];const Re={};i.createMesh(we.apply(Re,{id:be,primitive:"triangles",positionsCompressed:pe,normalsCompressed:ge,indices:fe,edgeIndices:Me,color:H,opacity:ae}))}}let I=0;for(let R=0;R<C;R++){const F=C-1,z=R===F,Q=y[R],H=P[R],ae=z?P[F]:P[R+1],pe=[];for(let ge=H;ge<ae;ge++){const fe=x[ge];if(w[fe]>1){const Fe={},Re="instance."+I++,Te="geometry"+fe,Ne=_[R]*16,Be=d.subarray(Ne,Ne+16);i.createMesh(we.apply(Fe,{id:Re,geometryId:Te,matrix:Be})),pe.push(Re)}else pe.push(fe)}if(pe.length>0){const ge={};i.createEntity(we.apply(ge,{id:Q,isObject:!0,meshIds:pe}))}}}const Kp={version:5,parse:function(r,e,t,i,s,o){const a=aF(t),n=lF(a);cF(r,e,n,i,s,o)}};let Mo=window.pako||Wi;Mo.inflate||(Mo=Mo.default);function hF(r){return{positions:r[0],normals:r[1],indices:r[2],edgeIndices:r[3],matrices:r[4],reusedPrimitivesDecodeMatrix:r[5],eachPrimitivePositionsAndNormalsPortion:r[6],eachPrimitiveIndicesPortion:r[7],eachPrimitiveEdgeIndicesPortion:r[8],eachPrimitiveColorAndOpacity:r[9],primitiveInstances:r[10],eachEntityId:r[11],eachEntityPrimitiveInstancesPortion:r[12],eachEntityMatricesPortion:r[13],eachTileAABB:r[14],eachTileEntitiesPortion:r[15]}}function uF(r){function e(t,i){return t.length===0?[]:Mo.inflate(t,i).buffer}return{positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),matrices:new Float32Array(e(r.matrices)),reusedPrimitivesDecodeMatrix:new Float32Array(e(r.reusedPrimitivesDecodeMatrix)),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(e(r.eachPrimitivePositionsAndNormalsPortion)),eachPrimitiveIndicesPortion:new Uint32Array(e(r.eachPrimitiveIndicesPortion)),eachPrimitiveEdgeIndicesPortion:new Uint32Array(e(r.eachPrimitiveEdgeIndicesPortion)),eachPrimitiveColorAndOpacity:new Uint8Array(e(r.eachPrimitiveColorAndOpacity)),primitiveInstances:new Uint32Array(e(r.primitiveInstances)),eachEntityId:Mo.inflate(r.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(e(r.eachEntityPrimitiveInstancesPortion)),eachEntityMatricesPortion:new Uint32Array(e(r.eachEntityMatricesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const dF=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function pF(r,e,t,i,s,o){const a=o.getNextId(),n=t.positions,l=t.normals,c=t.indices,h=t.edgeIndices,d=t.matrices,p=t.reusedPrimitivesDecodeMatrix,m=t.eachPrimitivePositionsAndNormalsPortion,g=t.eachPrimitiveIndicesPortion,u=t.eachPrimitiveEdgeIndicesPortion,x=t.eachPrimitiveColorAndOpacity,y=t.primitiveInstances,P=JSON.parse(t.eachEntityId),_=t.eachEntityPrimitiveInstancesPortion,b=t.eachEntityMatricesPortion,B=t.eachTileAABB,w=t.eachTileEntitiesPortion,C=m.length,E=y.length,I=P.length,R=w.length,F=new Uint32Array(C);for(let H=0;H<E;H++){const ae=y[H];F[ae]!==void 0?F[ae]++:F[ae]=1}const z=A.vec3(),Q=A.AABB3();for(let H=0;H<R;H++){const ae=R-1,pe=H===ae,ge=w[H],fe=pe?I:w[H+1],Me=H*6,be=B.subarray(Me,Me+6);A.getAABB3Center(be,z),Q[0]=be[0]-z[0],Q[1]=be[1]-z[1],Q[2]=be[2]-z[2],Q[3]=be[3]-z[0],Q[4]=be[4]-z[1],Q[5]=be[5]-z[2];const Fe=at.createPositionsDecodeMatrix(Q),Re={};for(let Te=ge;Te<fe;Te++){const Ne=P[Te],Be=e.globalizeObjectIds?A.globalizeObjectId(i.id,Ne):Ne,Se=b[Te],S=d.slice(Se,Se+16),k=I-1,D=Te===k,G=_[Te],se=D?y.length:_[Te+1],le=[],te=r.metaScene.metaObjects[Be],oe={},Y={};if(te){if(e.excludeTypesMap&&te.type&&e.excludeTypesMap[te.type]||e.includeTypesMap&&te.type&&!e.includeTypesMap[te.type])continue;const ne=e.objectDefaults?e.objectDefaults[te.type]||e.objectDefaults.DEFAULT:null;ne&&(ne.visible===!1&&(oe.visible=!1),ne.pickable===!1&&(oe.pickable=!1),ne.colorize&&(Y.color=ne.colorize),ne.opacity!==void 0&&ne.opacity!==null&&(Y.opacity=ne.opacity))}else if(e.excludeUnclassifiedObjects)continue;for(let ne=G;ne<se;ne++){const Ae=y[ne],J=F[Ae]>1,_e=Ae===C-1,re=n.subarray(m[Ae],_e?n.length:m[Ae+1]),he=l.subarray(m[Ae],_e?l.length:m[Ae+1]),ce=c.subarray(g[Ae],_e?c.length:g[Ae+1]),xe=h.subarray(u[Ae],_e?h.length:u[Ae+1]),De=dF(x.subarray(Ae*4,Ae*4+3)),ie=x[Ae*4+3]/255,de=o.getNextId();if(J){const me=`${a}-geometry.${H}.${Ae}`;Re[me]||(i.createGeometry({id:me,primitive:"triangles",positionsCompressed:re,indices:ce,edgeIndices:xe,positionsDecodeMatrix:p}),Re[me]=!0),i.createMesh(we.apply(Y,{id:de,geometryId:me,origin:z,matrix:S,color:De,opacity:ie})),le.push(de)}else i.createMesh(we.apply(Y,{id:de,origin:z,primitive:"triangles",positionsCompressed:re,normalsCompressed:he,indices:ce,edgeIndices:xe,positionsDecodeMatrix:Fe,color:De,opacity:ie})),le.push(de)}le.length>0&&i.createEntity(we.apply(oe,{id:Be,isObject:!0,meshIds:le}))}}}const Xp={version:6,parse:function(r,e,t,i,s,o){const a=hF(t),n=uF(a);pF(r,e,n,i,s,o)}};let Eo=window.pako||Wi;Eo.inflate||(Eo=Eo.default);function fF(r){return{positions:r[0],normals:r[1],colors:r[2],indices:r[3],edgeIndices:r[4],matrices:r[5],reusedGeometriesDecodeMatrix:r[6],eachGeometryPrimitiveType:r[7],eachGeometryPositionsPortion:r[8],eachGeometryNormalsPortion:r[9],eachGeometryColorsPortion:r[10],eachGeometryIndicesPortion:r[11],eachGeometryEdgeIndicesPortion:r[12],eachMeshGeometriesPortion:r[13],eachMeshMatricesPortion:r[14],eachMeshMaterial:r[15],eachEntityId:r[16],eachEntityMeshesPortion:r[17],eachTileAABB:r[18],eachTileEntitiesPortion:r[19]}}function mF(r){function e(t,i){return t.length===0?[]:Eo.inflate(t,i).buffer}return{positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),colors:new Uint8Array(e(r.colors)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),matrices:new Float32Array(e(r.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(r.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(r.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(r.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(r.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(r.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(r.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(r.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(r.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(r.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(r.eachMeshMaterial)),eachEntityId:Eo.inflate(r.eachEntityId,{to:"string"}),eachEntityMeshesPortion:new Uint32Array(e(r.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const gF=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function Yp(r){const e=[];for(let t=0,i=r.length;t<i;t+=3)e.push(r[t]),e.push(r[t+1]),e.push(r[t+2]),e.push(1);return e}function _F(r,e,t,i,s,o){const a=o.getNextId(),n=t.positions,l=t.normals,c=t.colors,h=t.indices,d=t.edgeIndices,p=t.matrices,m=t.reusedGeometriesDecodeMatrix,g=t.eachGeometryPrimitiveType,u=t.eachGeometryPositionsPortion,x=t.eachGeometryNormalsPortion,y=t.eachGeometryColorsPortion,P=t.eachGeometryIndicesPortion,_=t.eachGeometryEdgeIndicesPortion,b=t.eachMeshGeometriesPortion,B=t.eachMeshMatricesPortion,w=t.eachMeshMaterial,C=JSON.parse(t.eachEntityId),E=t.eachEntityMeshesPortion,I=t.eachTileAABB,R=t.eachTileEntitiesPortion,F=u.length,z=b.length,Q=C.length,H=R.length,ae=new Uint32Array(F);for(let fe=0;fe<z;fe++){const Me=b[fe];ae[Me]!==void 0?ae[Me]++:ae[Me]=1}const pe=A.vec3(),ge=A.AABB3();for(let fe=0;fe<H;fe++){const Me=H-1,be=fe===Me,Fe=R[fe],Re=be?Q:R[fe+1],Te=fe*6,Ne=I.subarray(Te,Te+6);A.getAABB3Center(Ne,pe),ge[0]=Ne[0]-pe[0],ge[1]=Ne[1]-pe[1],ge[2]=Ne[2]-pe[2],ge[3]=Ne[3]-pe[0],ge[4]=Ne[4]-pe[1],ge[5]=Ne[5]-pe[2];const Be=at.createPositionsDecodeMatrix(ge),Se={};for(let S=Fe;S<Re;S++){const k=C[S],D=e.globalizeObjectIds?A.globalizeObjectId(i.id,k):k,G=Q-1,se=S===G,le=E[S],te=se?b.length:E[S+1],oe=[],Y=r.metaScene.metaObjects[D],ne={},Ae={};if(Y){if(e.excludeTypesMap&&Y.type&&e.excludeTypesMap[Y.type]||e.includeTypesMap&&Y.type&&!e.includeTypesMap[Y.type])continue;const $=e.objectDefaults?e.objectDefaults[Y.type]||e.objectDefaults.DEFAULT:null;$&&($.visible===!1&&(ne.visible=!1),$.pickable===!1&&(ne.pickable=!1),$.colorize&&(Ae.color=$.colorize),$.opacity!==void 0&&$.opacity!==null&&(Ae.opacity=$.opacity),$.metallic!==void 0&&$.metallic!==null&&(Ae.metallic=$.metallic),$.roughness!==void 0&&$.roughness!==null&&(Ae.roughness=$.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let $=le;$<te;$++){const J=b[$],re=ae[J]>1,he=J===F-1,ce=gF(w.subarray($*6,$*6+3)),xe=w[$*6+3]/255,De=w[$*6+4]/255,ie=w[$*6+5]/255,de=o.getNextId();if(re){const me=B[$],ye=p.slice(me,me+16),K=`${a}-geometry.${fe}.${J}`;if(!Se[K]){const Le=g[J];let je,Z,qe,$e,Ke,ot;switch(Le){case 0:je="solid",Z=n.subarray(u[J],he?n.length:u[J+1]),qe=l.subarray(x[J],he?l.length:x[J+1]),Ke=h.subarray(P[J],he?h.length:P[J+1]),ot=d.subarray(_[J],he?d.length:_[J+1]);break;case 1:je="surface",Z=n.subarray(u[J],he?n.length:u[J+1]),qe=l.subarray(x[J],he?l.length:x[J+1]),Ke=h.subarray(P[J],he?h.length:P[J+1]),ot=d.subarray(_[J],he?d.length:_[J+1]);break;case 2:je="points",Z=n.subarray(u[J],he?n.length:u[J+1]),$e=Yp(c.subarray(y[J],he?c.length:y[J+1]));break;case 3:je="lines",Z=n.subarray(u[J],he?n.length:u[J+1]),Ke=h.subarray(P[J],he?h.length:P[J+1]);break;default:continue}i.createGeometry({id:K,primitive:je,positionsCompressed:Z,normalsCompressed:qe,colors:$e,indices:Ke,edgeIndices:ot,positionsDecodeMatrix:m}),Se[K]=!0}i.createMesh(we.apply(Ae,{id:de,geometryId:K,origin:pe,matrix:ye,color:ce,metallic:De,roughness:ie,opacity:xe})),oe.push(de)}else{const me=g[J];let ye,K,Le,je,Z,qe;switch(me){case 0:ye="solid",K=n.subarray(u[J],he?n.length:u[J+1]),Le=l.subarray(x[J],he?l.length:x[J+1]),Z=h.subarray(P[J],he?h.length:P[J+1]),qe=d.subarray(_[J],he?d.length:_[J+1]);break;case 1:ye="surface",K=n.subarray(u[J],he?n.length:u[J+1]),Le=l.subarray(x[J],he?l.length:x[J+1]),Z=h.subarray(P[J],he?h.length:P[J+1]),qe=d.subarray(_[J],he?d.length:_[J+1]);break;case 2:ye="points",K=n.subarray(u[J],he?n.length:u[J+1]),je=Yp(c.subarray(y[J],he?c.length:y[J+1]));break;case 3:ye="lines",K=n.subarray(u[J],he?n.length:u[J+1]),Z=h.subarray(P[J],he?h.length:P[J+1]);break;default:continue}i.createMesh(we.apply(Ae,{id:de,origin:pe,primitive:ye,positionsCompressed:K,normalsCompressed:Le,colors:je,indices:Z,edgeIndices:qe,positionsDecodeMatrix:Be,color:ce,metallic:De,roughness:ie,opacity:xe})),oe.push(de)}}oe.length>0&&i.createEntity(we.apply(ne,{id:D,isObject:!0,meshIds:oe}))}}}const $p={version:7,parse:function(r,e,t,i,s,o){const a=fF(t),n=mF(a);_F(r,e,n,i,s,o)}};let Hs=window.pako||Wi;Hs.inflate||(Hs=Hs.default);const ts=A.vec4(),Zp=A.vec4();function vF(r){return{types:r[0],eachMetaObjectId:r[1],eachMetaObjectType:r[2],eachMetaObjectName:r[3],eachMetaObjectParent:r[4],positions:r[5],normals:r[6],colors:r[7],indices:r[8],edgeIndices:r[9],matrices:r[10],reusedGeometriesDecodeMatrix:r[11],eachGeometryPrimitiveType:r[12],eachGeometryPositionsPortion:r[13],eachGeometryNormalsPortion:r[14],eachGeometryColorsPortion:r[15],eachGeometryIndicesPortion:r[16],eachGeometryEdgeIndicesPortion:r[17],eachMeshGeometriesPortion:r[18],eachMeshMatricesPortion:r[19],eachMeshMaterial:r[20],eachEntityMetaObject:r[21],eachEntityMeshesPortion:r[22],eachTileAABB:r[23],eachTileEntitiesPortion:r[24]}}function PF(r){function e(t,i){return t.length===0?[]:Hs.inflate(t,i).buffer}return{types:Hs.inflate(r.types,{to:"string"}),eachMetaObjectId:Hs.inflate(r.eachMetaObjectId,{to:"string"}),eachMetaObjectType:new Uint32Array(e(r.eachMetaObjectType)),eachMetaObjectName:Hs.inflate(r.eachMetaObjectName,{to:"string"}),eachMetaObjectParent:new Uint32Array(e(r.eachMetaObjectParent)),positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),colors:new Uint8Array(e(r.colors)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),matrices:new Float32Array(e(r.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(r.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(r.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(r.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(r.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(r.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(r.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(r.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(r.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(r.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(r.eachMeshMaterial)),eachEntityMetaObject:new Uint32Array(e(r.eachEntityMetaObject)),eachEntityMeshesPortion:new Uint32Array(e(r.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const xF=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function qp(r){const e=[];for(let t=0,i=r.length;t<i;t+=3)e.push(r[t]),e.push(r[t+1]),e.push(r[t+2]),e.push(1);return e}function yF(r,e,t,i,s,o){const a=o.getNextId(),n=JSON.parse(t.types),l=JSON.parse(t.eachMetaObjectId),c=t.eachMetaObjectType,h=JSON.parse(t.eachMetaObjectName),d=t.eachMetaObjectParent,p=t.positions,m=t.normals,g=t.colors,u=t.indices,x=t.edgeIndices,y=t.matrices,P=t.reusedGeometriesDecodeMatrix,_=t.eachGeometryPrimitiveType,b=t.eachGeometryPositionsPortion,B=t.eachGeometryNormalsPortion,w=t.eachGeometryColorsPortion,C=t.eachGeometryIndicesPortion,E=t.eachGeometryEdgeIndicesPortion,I=t.eachMeshGeometriesPortion,R=t.eachMeshMatricesPortion,F=t.eachMeshMaterial,z=t.eachEntityMetaObject,Q=t.eachEntityMeshesPortion,H=t.eachTileAABB,ae=t.eachTileEntitiesPortion,pe=l.length,ge=b.length,fe=I.length,Me=z.length,be=ae.length;if(s){const Be={metaObjects:[]};for(let Se=0;Se<pe;Se++){const S=l[Se],k=c[Se],D=n[k]||"default",G=h[Se],se=d[Se],le=se!==Se?l[se]:null;Be.metaObjects.push({id:S,type:D,name:G,parent:le})}s.loadData(Be,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds})}const Fe=new Uint32Array(ge);for(let Be=0;Be<fe;Be++){const Se=I[Be];Fe[Se]!==void 0?Fe[Se]++:Fe[Se]=1}const Re=A.vec3(),Te=A.AABB3(),Ne={};for(let Be=0;Be<be;Be++){const Se=be-1,S=Be===Se,k=ae[Be],D=S?Me:ae[Be+1],G=Be*6,se=H.subarray(G,G+6);A.getAABB3Center(se,Re),Te[0]=se[0]-Re[0],Te[1]=se[1]-Re[1],Te[2]=se[2]-Re[2],Te[3]=se[3]-Re[0],Te[4]=se[4]-Re[1],Te[5]=se[5]-Re[2];const le=at.createPositionsDecodeMatrix(Te),te={};for(let oe=k;oe<D;oe++){const Y=z[oe],Ae=l[Y],$=e.globalizeObjectIds?A.globalizeObjectId(i.id,Ae):Ae,J=Me-1,_e=oe===J,re=Q[oe],he=_e?I.length:Q[oe+1],ce=[],xe=r.metaScene.metaObjects[$],De={},ie={};if(xe){if(e.excludeTypesMap&&xe.type&&e.excludeTypesMap[xe.type]||e.includeTypesMap&&xe.type&&!e.includeTypesMap[xe.type])continue;const de=e.objectDefaults?e.objectDefaults[xe.type]||e.objectDefaults.DEFAULT:null;de&&(de.visible===!1&&(De.visible=!1),de.pickable===!1&&(De.pickable=!1),de.colorize&&(ie.color=de.colorize),de.opacity!==void 0&&de.opacity!==null&&(ie.opacity=de.opacity),de.metallic!==void 0&&de.metallic!==null&&(ie.metallic=de.metallic),de.roughness!==void 0&&de.roughness!==null&&(ie.roughness=de.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let de=re;de<he;de++){const me=I[de],K=Fe[me]>1,Le=me===ge-1,je=xF(F.subarray(de*6,de*6+3)),Z=F[de*6+3]/255,qe=F[de*6+4]/255,$e=F[de*6+5]/255,Ke=o.getNextId();if(K){const ot=R[de],nt=y.slice(ot,ot+16),ht=`${a}-geometry.${Be}.${me}`;let Ce=Ne[ht];if(!Ce){Ce={batchThisMesh:!e.reuseGeometries};const He=_[me];let Qe=!1;switch(He){case 0:Ce.primitiveName="solid",Ce.geometryPositions=p.subarray(b[me],Le?p.length:b[me+1]),Ce.geometryNormals=m.subarray(B[me],Le?m.length:B[me+1]),Ce.geometryIndices=u.subarray(C[me],Le?u.length:C[me+1]),Ce.geometryEdgeIndices=x.subarray(E[me],Le?x.length:E[me+1]),Qe=Ce.geometryPositions.length>0&&Ce.geometryIndices.length>0;break;case 1:Ce.primitiveName="surface",Ce.geometryPositions=p.subarray(b[me],Le?p.length:b[me+1]),Ce.geometryNormals=m.subarray(B[me],Le?m.length:B[me+1]),Ce.geometryIndices=u.subarray(C[me],Le?u.length:C[me+1]),Ce.geometryEdgeIndices=x.subarray(E[me],Le?x.length:E[me+1]),Qe=Ce.geometryPositions.length>0&&Ce.geometryIndices.length>0;break;case 2:Ce.primitiveName="points",Ce.geometryPositions=p.subarray(b[me],Le?p.length:b[me+1]),Ce.geometryColors=qp(g.subarray(w[me],Le?g.length:w[me+1])),Qe=Ce.geometryPositions.length>0;break;case 3:Ce.primitiveName="lines",Ce.geometryPositions=p.subarray(b[me],Le?p.length:b[me+1]),Ce.geometryIndices=u.subarray(C[me],Le?u.length:C[me+1]),Qe=Ce.geometryPositions.length>0&&Ce.geometryIndices.length>0;break;default:continue}if(Qe||(Ce=null),Ce&&(Ce.geometryPositions.length>1e3,Ce.batchThisMesh)){Ce.decompressedPositions=new Float32Array(Ce.geometryPositions.length);const ue=Ce.geometryPositions,X=Ce.decompressedPositions;for(let Ze=0,et=ue.length;Ze<et;Ze+=3)X[Ze+0]=ue[Ze+0]*P[0]+P[12],X[Ze+1]=ue[Ze+1]*P[5]+P[13],X[Ze+2]=ue[Ze+2]*P[10]+P[14];Ce.geometryPositions=null,Ne[ht]=Ce}}if(Ce)if(Ce.batchThisMesh){const He=Ce.decompressedPositions,Qe=new Uint16Array(He.length);for(let ue=0,X=He.length;ue<X;ue+=3)ts[0]=He[ue+0],ts[1]=He[ue+1],ts[2]=He[ue+2],ts[3]=1,A.transformVec4(nt,ts,Zp),at.compressPosition(Zp,Te,ts),Qe[ue+0]=ts[0],Qe[ue+1]=ts[1],Qe[ue+2]=ts[2];i.createMesh(we.apply(ie,{id:Ke,origin:Re,primitive:Ce.primitiveName,positionsCompressed:Qe,normalsCompressed:Ce.geometryNormals,colorsCompressed:Ce.geometryColors,indices:Ce.geometryIndices,edgeIndices:Ce.geometryEdgeIndices,positionsDecodeMatrix:le,color:je,metallic:qe,roughness:$e,opacity:Z})),ce.push(Ke)}else te[ht]||(i.createGeometry({id:ht,primitive:Ce.primitiveName,positionsCompressed:Ce.geometryPositions,normalsCompressed:Ce.geometryNormals,colorsCompressed:Ce.geometryColors,indices:Ce.geometryIndices,edgeIndices:Ce.geometryEdgeIndices,positionsDecodeMatrix:P}),te[ht]=!0),i.createMesh(we.apply(ie,{id:Ke,geometryId:ht,origin:Re,matrix:nt,color:je,metallic:qe,roughness:$e,opacity:Z})),ce.push(Ke)}else{const ot=_[me];let nt,ht,Ce,He,Qe,ue,X=!1;switch(ot){case 0:nt="solid",ht=p.subarray(b[me],Le?p.length:b[me+1]),Ce=m.subarray(B[me],Le?m.length:B[me+1]),Qe=u.subarray(C[me],Le?u.length:C[me+1]),ue=x.subarray(E[me],Le?x.length:E[me+1]),X=ht.length>0&&Qe.length>0;break;case 1:nt="surface",ht=p.subarray(b[me],Le?p.length:b[me+1]),Ce=m.subarray(B[me],Le?m.length:B[me+1]),Qe=u.subarray(C[me],Le?u.length:C[me+1]),ue=x.subarray(E[me],Le?x.length:E[me+1]),X=ht.length>0&&Qe.length>0;break;case 2:nt="points",ht=p.subarray(b[me],Le?p.length:b[me+1]),He=qp(g.subarray(w[me],Le?g.length:w[me+1])),X=ht.length>0;break;case 3:nt="lines",ht=p.subarray(b[me],Le?p.length:b[me+1]),Qe=u.subarray(C[me],Le?u.length:C[me+1]),X=ht.length>0&&Qe.length>0;break;default:continue}X&&(i.createMesh(we.apply(ie,{id:Ke,origin:Re,primitive:nt,positionsCompressed:ht,normalsCompressed:Ce,colorsCompressed:He,indices:Qe,edgeIndices:ue,positionsDecodeMatrix:le,color:je,metallic:qe,roughness:$e,opacity:Z})),ce.push(Ke))}}ce.length>0&&i.createEntity(we.apply(De,{id:$,isObject:!0,meshIds:ce}))}}}const Jp={version:8,parse:function(r,e,t,i,s,o){const a=vF(t),n=PF(a);yF(r,e,n,i,s,o)}};let Er=window.pako||Wi;Er.inflate||(Er=Er.default);const is=A.vec4(),ef=A.vec4();function bF(r){return{metadata:r[0],positions:r[1],normals:r[2],colors:r[3],indices:r[4],edgeIndices:r[5],matrices:r[6],reusedGeometriesDecodeMatrix:r[7],eachGeometryPrimitiveType:r[8],eachGeometryPositionsPortion:r[9],eachGeometryNormalsPortion:r[10],eachGeometryColorsPortion:r[11],eachGeometryIndicesPortion:r[12],eachGeometryEdgeIndicesPortion:r[13],eachMeshGeometriesPortion:r[14],eachMeshMatricesPortion:r[15],eachMeshMaterial:r[16],eachEntityId:r[17],eachEntityMeshesPortion:r[18],eachTileAABB:r[19],eachTileEntitiesPortion:r[20]}}function BF(r){function e(t,i){return t.length===0?[]:Er.inflate(t,i).buffer}return{metadata:JSON.parse(Er.inflate(r.metadata,{to:"string"})),positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),colors:new Uint8Array(e(r.colors)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),matrices:new Float32Array(e(r.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(r.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(r.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(r.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(r.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(r.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(r.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(r.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(r.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(r.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(r.eachMeshMaterial)),eachEntityId:JSON.parse(Er.inflate(r.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(e(r.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const wF=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();function CF(r,e,t,i,s,o){const a=o.getNextId(),n=t.metadata,l=t.positions,c=t.normals,h=t.colors,d=t.indices,p=t.edgeIndices,m=t.matrices,g=t.reusedGeometriesDecodeMatrix,u=t.eachGeometryPrimitiveType,x=t.eachGeometryPositionsPortion,y=t.eachGeometryNormalsPortion,P=t.eachGeometryColorsPortion,_=t.eachGeometryIndicesPortion,b=t.eachGeometryEdgeIndicesPortion,B=t.eachMeshGeometriesPortion,w=t.eachMeshMatricesPortion,C=t.eachMeshMaterial,E=t.eachEntityId,I=t.eachEntityMeshesPortion,R=t.eachTileAABB,F=t.eachTileEntitiesPortion,z=x.length,Q=B.length,H=I.length,ae=F.length;s&&s.loadData(n,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds});const pe=new Uint32Array(z);for(let be=0;be<Q;be++){const Fe=B[be];pe[Fe]!==void 0?pe[Fe]++:pe[Fe]=1}const ge=A.vec3(),fe=A.AABB3(),Me={};for(let be=0;be<ae;be++){const Fe=ae-1,Re=be===Fe,Te=F[be],Ne=Re?H-1:F[be+1]-1,Be=be*6,Se=R.subarray(Be,Be+6);A.getAABB3Center(Se,ge),fe[0]=Se[0]-ge[0],fe[1]=Se[1]-ge[1],fe[2]=Se[2]-ge[2],fe[3]=Se[3]-ge[0],fe[4]=Se[4]-ge[1],fe[5]=Se[5]-ge[2];const S=at.createPositionsDecodeMatrix(fe),k={};for(let D=Te;D<=Ne;D++){const G=E[D],se=e.globalizeObjectIds?A.globalizeObjectId(i.id,G):G,le=H-1,te=D===le,oe=I[D],Y=te?B.length-1:I[D+1]-1,ne=[],Ae=r.metaScene.metaObjects[se],$={},J={};if(Ae){if(e.excludeTypesMap&&Ae.type&&e.excludeTypesMap[Ae.type]||e.includeTypesMap&&Ae.type&&!e.includeTypesMap[Ae.type])continue;const _e=e.objectDefaults?e.objectDefaults[Ae.type]||e.objectDefaults.DEFAULT:null;_e&&(_e.visible===!1&&($.visible=!1),_e.pickable===!1&&($.pickable=!1),_e.colorize&&(J.color=_e.colorize),_e.opacity!==void 0&&_e.opacity!==null&&(J.opacity=_e.opacity),_e.metallic!==void 0&&_e.metallic!==null&&(J.metallic=_e.metallic),_e.roughness!==void 0&&_e.roughness!==null&&(J.roughness=_e.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let _e=oe;_e<=Y;_e++){const re=B[_e],ce=pe[re]>1,xe=re===z-1,De=wF(C.subarray(_e*6,_e*6+3)),ie=C[_e*6+3]/255,de=C[_e*6+4]/255,me=C[_e*6+5]/255,ye=o.getNextId();if(ce){const K=w[_e],Le=m.slice(K,K+16),je=`${a}-geometry.${be}.${re}`;let Z=Me[je];if(!Z){Z={batchThisMesh:!e.reuseGeometries};const qe=u[re];let $e=!1;switch(qe){case 0:Z.primitiveName="solid",Z.geometryPositions=l.subarray(x[re],xe?l.length:x[re+1]),Z.geometryNormals=c.subarray(y[re],xe?c.length:y[re+1]),Z.geometryIndices=d.subarray(_[re],xe?d.length:_[re+1]),Z.geometryEdgeIndices=p.subarray(b[re],xe?p.length:b[re+1]),$e=Z.geometryPositions.length>0&&Z.geometryIndices.length>0;break;case 1:Z.primitiveName="surface",Z.geometryPositions=l.subarray(x[re],xe?l.length:x[re+1]),Z.geometryNormals=c.subarray(y[re],xe?c.length:y[re+1]),Z.geometryIndices=d.subarray(_[re],xe?d.length:_[re+1]),Z.geometryEdgeIndices=p.subarray(b[re],xe?p.length:b[re+1]),$e=Z.geometryPositions.length>0&&Z.geometryIndices.length>0;break;case 2:Z.primitiveName="points",Z.geometryPositions=l.subarray(x[re],xe?l.length:x[re+1]),Z.geometryColors=h.subarray(P[re],xe?h.length:P[re+1]),$e=Z.geometryPositions.length>0;break;case 3:Z.primitiveName="lines",Z.geometryPositions=l.subarray(x[re],xe?l.length:x[re+1]),Z.geometryIndices=d.subarray(_[re],xe?d.length:_[re+1]),$e=Z.geometryPositions.length>0&&Z.geometryIndices.length>0;break;default:continue}if($e||(Z=null),Z&&(Z.geometryPositions.length>1e3,Z.batchThisMesh)){Z.decompressedPositions=new Float32Array(Z.geometryPositions.length),Z.transformedAndRecompressedPositions=new Uint16Array(Z.geometryPositions.length);const Ke=Z.geometryPositions,ot=Z.decompressedPositions;for(let nt=0,ht=Ke.length;nt<ht;nt+=3)ot[nt+0]=Ke[nt+0]*g[0]+g[12],ot[nt+1]=Ke[nt+1]*g[5]+g[13],ot[nt+2]=Ke[nt+2]*g[10]+g[14];Z.geometryPositions=null,Me[je]=Z}}if(Z)if(Z.batchThisMesh){const qe=Z.decompressedPositions,$e=Z.transformedAndRecompressedPositions;for(let Ke=0,ot=qe.length;Ke<ot;Ke+=3)is[0]=qe[Ke+0],is[1]=qe[Ke+1],is[2]=qe[Ke+2],is[3]=1,A.transformVec4(Le,is,ef),at.compressPosition(ef,fe,is),$e[Ke+0]=is[0],$e[Ke+1]=is[1],$e[Ke+2]=is[2];i.createMesh(we.apply(J,{id:ye,origin:ge,primitive:Z.primitiveName,positionsCompressed:$e,normalsCompressed:Z.geometryNormals,colorsCompressed:Z.geometryColors,indices:Z.geometryIndices,edgeIndices:Z.geometryEdgeIndices,positionsDecodeMatrix:S,color:De,metallic:de,roughness:me,opacity:ie})),ne.push(ye)}else k[je]||(i.createGeometry({id:je,primitive:Z.primitiveName,positionsCompressed:Z.geometryPositions,normalsCompressed:Z.geometryNormals,colorsCompressed:Z.geometryColors,indices:Z.geometryIndices,edgeIndices:Z.geometryEdgeIndices,positionsDecodeMatrix:g}),k[je]=!0),i.createMesh(we.apply(J,{id:ye,geometryId:je,origin:ge,matrix:Le,color:De,metallic:de,roughness:me,opacity:ie})),ne.push(ye)}else{const K=u[re];let Le,je,Z,qe,$e,Ke,ot=!1;switch(K){case 0:Le="solid",je=l.subarray(x[re],xe?l.length:x[re+1]),Z=c.subarray(y[re],xe?c.length:y[re+1]),$e=d.subarray(_[re],xe?d.length:_[re+1]),Ke=p.subarray(b[re],xe?p.length:b[re+1]),ot=je.length>0&&$e.length>0;break;case 1:Le="surface",je=l.subarray(x[re],xe?l.length:x[re+1]),Z=c.subarray(y[re],xe?c.length:y[re+1]),$e=d.subarray(_[re],xe?d.length:_[re+1]),Ke=p.subarray(b[re],xe?p.length:b[re+1]),ot=je.length>0&&$e.length>0;break;case 2:Le="points",je=l.subarray(x[re],xe?l.length:x[re+1]),qe=h.subarray(P[re],xe?h.length:P[re+1]),ot=je.length>0;break;case 3:Le="lines",je=l.subarray(x[re],xe?l.length:x[re+1]),$e=d.subarray(_[re],xe?d.length:_[re+1]),ot=je.length>0&&$e.length>0;break;default:continue}ot&&(i.createMesh(we.apply(J,{id:ye,origin:ge,primitive:Le,positionsCompressed:je,normalsCompressed:Z,colorsCompressed:qe,indices:$e,edgeIndices:Ke,positionsDecodeMatrix:S,color:De,metallic:de,roughness:me,opacity:ie})),ne.push(ye))}}ne.length>0&&i.createEntity(we.apply($,{id:se,isObject:!0,meshIds:ne}))}}}const tf={version:9,parse:function(r,e,t,i,s,o){const a=bF(t),n=BF(a);CF(r,e,n,i,s,o)}};let Ir=window.pako||Wi;Ir.inflate||(Ir=Ir.default);const ss=A.vec4(),sf=A.vec4(),MF=9;function EF(r){let e=0;return{metadata:r[e++],textureData:r[e++],eachTextureDataPortion:r[e++],eachTextureAttributes:r[e++],positions:r[e++],normals:r[e++],colors:r[e++],uvs:r[e++],indices:r[e++],edgeIndices:r[e++],eachTextureSetTextures:r[e++],matrices:r[e++],reusedGeometriesDecodeMatrix:r[e++],eachGeometryPrimitiveType:r[e++],eachGeometryPositionsPortion:r[e++],eachGeometryNormalsPortion:r[e++],eachGeometryColorsPortion:r[e++],eachGeometryUVsPortion:r[e++],eachGeometryIndicesPortion:r[e++],eachGeometryEdgeIndicesPortion:r[e++],eachMeshGeometriesPortion:r[e++],eachMeshMatricesPortion:r[e++],eachMeshTextureSet:r[e++],eachMeshMaterialAttributes:r[e++],eachEntityId:r[e++],eachEntityMeshesPortion:r[e++],eachTileAABB:r[e++],eachTileEntitiesPortion:r[e++]}}function IF(r){function e(t,i){return t.length===0?[]:Ir.inflate(t,i).buffer}return{metadata:JSON.parse(Ir.inflate(r.metadata,{to:"string"})),textureData:new Uint8Array(e(r.textureData)),eachTextureDataPortion:new Uint32Array(e(r.eachTextureDataPortion)),eachTextureAttributes:new Uint16Array(e(r.eachTextureAttributes)),positions:new Uint16Array(e(r.positions)),normals:new Int8Array(e(r.normals)),colors:new Uint8Array(e(r.colors)),uvs:new Float32Array(e(r.uvs)),indices:new Uint32Array(e(r.indices)),edgeIndices:new Uint32Array(e(r.edgeIndices)),eachTextureSetTextures:new Int32Array(e(r.eachTextureSetTextures)),matrices:new Float32Array(e(r.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(r.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(r.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(r.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(r.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(r.eachGeometryColorsPortion)),eachGeometryUVsPortion:new Uint32Array(e(r.eachGeometryUVsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(r.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(r.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(r.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(r.eachMeshMatricesPortion)),eachMeshTextureSet:new Int32Array(e(r.eachMeshTextureSet)),eachMeshMaterialAttributes:new Uint8Array(e(r.eachMeshMaterialAttributes)),eachEntityId:JSON.parse(Ir.inflate(r.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(e(r.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(r.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(r.eachTileEntitiesPortion))}}const FF=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();(function(){const r=document.createElement("canvas"),e=r.getContext("2d");return function(t){return r.width=t.width,r.height=t.height,e.putImageData(t,0,0),r.toDataURL()}})();function SF(r,e,t,i,s,o){const a=o.getNextId(),n=t.metadata,l=t.textureData,c=t.eachTextureDataPortion,h=t.eachTextureAttributes,d=t.positions,p=t.normals,m=t.colors,g=t.uvs,u=t.indices,x=t.edgeIndices,y=t.eachTextureSetTextures,P=t.matrices,_=t.reusedGeometriesDecodeMatrix,b=t.eachGeometryPrimitiveType,B=t.eachGeometryPositionsPortion,w=t.eachGeometryNormalsPortion,C=t.eachGeometryColorsPortion,E=t.eachGeometryUVsPortion,I=t.eachGeometryIndicesPortion,R=t.eachGeometryEdgeIndicesPortion,F=t.eachMeshGeometriesPortion,z=t.eachMeshMatricesPortion,Q=t.eachMeshTextureSet,H=t.eachMeshMaterialAttributes,ae=t.eachEntityId,pe=t.eachEntityMeshesPortion,ge=t.eachTileAABB,fe=t.eachTileEntitiesPortion,Me=c.length,be=y.length/5,Fe=B.length,Re=F.length,Te=pe.length,Ne=fe.length;s&&s.loadData(n,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds});for(let D=0;D<Me;D++){const G=D===Me-1,se=c[D],le=G?l.length:c[D+1],oe=le-se>0,Y=D*MF,ne=h[Y+0]===1,Ae=h[Y+1];h[Y+2],h[Y+3];const $=h[Y+4],J=h[Y+5],_e=h[Y+6],re=h[Y+7],he=h[Y+8];if(oe){const xe=new Uint8Array(l.subarray(se,le)).buffer,De=`${a}-texture-${D}`;if(ne)i.createTexture({id:De,buffers:[xe],minFilter:$,magFilter:J,wrapS:_e,wrapT:re,wrapR:he});else{const ie=Ae===wf?"image/jpeg":Ae===Cf?"image/png":"image/gif",de=new Blob([xe],{type:ie}),ye=(window.URL||window.webkitURL).createObjectURL(de),K=document.createElement("img");K.src=ye,i.createTexture({id:De,image:K,minFilter:$,magFilter:J,wrapS:_e,wrapT:re,wrapR:he})}}}for(let D=0;D<be;D++){const G=D*5,se=`${a}-textureSet-${D}`,le=y[G+0],te=y[G+1],oe=y[G+2],Y=y[G+3],ne=y[G+4];i.createTextureSet({id:se,colorTextureId:le>=0?`${a}-texture-${le}`:null,normalsTextureId:oe>=0?`${a}-texture-${oe}`:null,metallicRoughnessTextureId:te>=0?`${a}-texture-${te}`:null,emissiveTextureId:Y>=0?`${a}-texture-${Y}`:null,occlusionTextureId:ne>=0?`${a}-texture-${ne}`:null})}const Be=new Uint32Array(Fe);for(let D=0;D<Re;D++){const G=F[D];Be[G]!==void 0?Be[G]++:Be[G]=1}const Se=A.vec3(),S=A.AABB3(),k={};for(let D=0;D<Ne;D++){const G=Ne-1,se=D===G,le=fe[D],te=se?Te-1:fe[D+1]-1,oe=D*6,Y=ge.subarray(oe,oe+6);A.getAABB3Center(Y,Se),S[0]=Y[0]-Se[0],S[1]=Y[1]-Se[1],S[2]=Y[2]-Se[2],S[3]=Y[3]-Se[0],S[4]=Y[4]-Se[1],S[5]=Y[5]-Se[2];const ne=at.createPositionsDecodeMatrix(S),Ae={};for(let $=le;$<=te;$++){const J=ae[$],_e=e.globalizeObjectIds?A.globalizeObjectId(i.id,J):J,re=Te-1,he=$===re,ce=pe[$],xe=he?F.length-1:pe[$+1]-1,De=[],ie=r.metaScene.metaObjects[_e],de={},me={};if(ie){if(e.excludeTypesMap&&ie.type&&e.excludeTypesMap[ie.type]||e.includeTypesMap&&ie.type&&!e.includeTypesMap[ie.type])continue;const ye=e.objectDefaults?e.objectDefaults[ie.type]||e.objectDefaults.DEFAULT:null;ye&&(ye.visible===!1&&(de.visible=!1),ye.pickable===!1&&(de.pickable=!1),ye.colorize&&(me.color=ye.colorize),ye.opacity!==void 0&&ye.opacity!==null&&(me.opacity=ye.opacity),ye.metallic!==void 0&&ye.metallic!==null&&(me.metallic=ye.metallic),ye.roughness!==void 0&&ye.roughness!==null&&(me.roughness=ye.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let ye=ce;ye<=xe;ye++){const K=F[ye],je=Be[K]>1,Z=K===Fe-1,qe=Q[ye],$e=qe>=0?`${a}-textureSet-${qe}`:null,Ke=FF(H.subarray(ye*6,ye*6+3)),ot=H[ye*6+3]/255,nt=H[ye*6+4]/255,ht=H[ye*6+5]/255,Ce=o.getNextId();if(je){const He=z[ye],Qe=P.slice(He,He+16),ue=`${a}-geometry.${D}.${K}`;let X=k[ue];if(!X){X={batchThisMesh:!e.reuseGeometries};const Ze=b[K];let et=!1;switch(Ze){case 0:X.primitiveName="solid",X.geometryPositions=d.subarray(B[K],Z?d.length:B[K+1]),X.geometryNormals=p.subarray(w[K],Z?p.length:w[K+1]),X.geometryUVs=g.subarray(E[K],Z?g.length:E[K+1]),X.geometryIndices=u.subarray(I[K],Z?u.length:I[K+1]),X.geometryEdgeIndices=x.subarray(R[K],Z?x.length:R[K+1]),et=X.geometryPositions.length>0&&X.geometryIndices.length>0;break;case 1:X.primitiveName="surface",X.geometryPositions=d.subarray(B[K],Z?d.length:B[K+1]),X.geometryNormals=p.subarray(w[K],Z?p.length:w[K+1]),X.geometryUVs=g.subarray(E[K],Z?g.length:E[K+1]),X.geometryIndices=u.subarray(I[K],Z?u.length:I[K+1]),X.geometryEdgeIndices=x.subarray(R[K],Z?x.length:R[K+1]),et=X.geometryPositions.length>0&&X.geometryIndices.length>0;break;case 2:X.primitiveName="points",X.geometryPositions=d.subarray(B[K],Z?d.length:B[K+1]),X.geometryColors=m.subarray(C[K],Z?m.length:C[K+1]),et=X.geometryPositions.length>0;break;case 3:X.primitiveName="lines",X.geometryPositions=d.subarray(B[K],Z?d.length:B[K+1]),X.geometryIndices=u.subarray(I[K],Z?u.length:I[K+1]),et=X.geometryPositions.length>0&&X.geometryIndices.length>0;break;case 4:X.primitiveName="lines",X.geometryPositions=d.subarray(B[K],Z?d.length:B[K+1]),X.geometryIndices=rf(X.geometryPositions,u.subarray(I[K],Z?u.length:I[K+1])),et=X.geometryPositions.length>0&&X.geometryIndices.length>0;break;default:continue}if(et||(X=null),X&&(X.geometryPositions.length>1e3,X.batchThisMesh)){X.decompressedPositions=new Float32Array(X.geometryPositions.length),X.transformedAndRecompressedPositions=new Uint16Array(X.geometryPositions.length);const Ge=X.geometryPositions,Bt=X.decompressedPositions;for(let We=0,Pi=Ge.length;We<Pi;We+=3)Bt[We+0]=Ge[We+0]*_[0]+_[12],Bt[We+1]=Ge[We+1]*_[5]+_[13],Bt[We+2]=Ge[We+2]*_[10]+_[14];X.geometryPositions=null,k[ue]=X}}if(X)if(X.batchThisMesh){const Ze=X.decompressedPositions,et=X.transformedAndRecompressedPositions;for(let Ge=0,Bt=Ze.length;Ge<Bt;Ge+=3)ss[0]=Ze[Ge+0],ss[1]=Ze[Ge+1],ss[2]=Ze[Ge+2],ss[3]=1,A.transformVec4(Qe,ss,sf),at.compressPosition(sf,S,ss),et[Ge+0]=ss[0],et[Ge+1]=ss[1],et[Ge+2]=ss[2];i.createMesh(we.apply(me,{id:Ce,textureSetId:$e,origin:Se,primitive:X.primitiveName,positionsCompressed:et,normalsCompressed:X.geometryNormals,uv:X.geometryUVs,colorsCompressed:X.geometryColors,indices:X.geometryIndices,edgeIndices:X.geometryEdgeIndices,positionsDecodeMatrix:ne,color:Ke,metallic:nt,roughness:ht,opacity:ot})),De.push(Ce)}else Ae[ue]||(i.createGeometry({id:ue,primitive:X.primitiveName,positionsCompressed:X.geometryPositions,normalsCompressed:X.geometryNormals,uv:X.geometryUVs,colorsCompressed:X.geometryColors,indices:X.geometryIndices,edgeIndices:X.geometryEdgeIndices,positionsDecodeMatrix:_}),Ae[ue]=!0),i.createMesh(we.apply(me,{id:Ce,geometryId:ue,textureSetId:$e,matrix:Qe,color:Ke,metallic:nt,roughness:ht,opacity:ot,origin:Se})),De.push(Ce)}else{const He=b[K];let Qe,ue,X,Ze,et,Ge,Bt,We=!1;switch(He){case 0:Qe="solid",ue=d.subarray(B[K],Z?d.length:B[K+1]),X=p.subarray(w[K],Z?p.length:w[K+1]),Ze=g.subarray(E[K],Z?g.length:E[K+1]),Ge=u.subarray(I[K],Z?u.length:I[K+1]),Bt=x.subarray(R[K],Z?x.length:R[K+1]),We=ue.length>0&&Ge.length>0;break;case 1:Qe="surface",ue=d.subarray(B[K],Z?d.length:B[K+1]),X=p.subarray(w[K],Z?p.length:w[K+1]),Ze=g.subarray(E[K],Z?g.length:E[K+1]),Ge=u.subarray(I[K],Z?u.length:I[K+1]),Bt=x.subarray(R[K],Z?x.length:R[K+1]),We=ue.length>0&&Ge.length>0;break;case 2:Qe="points",ue=d.subarray(B[K],Z?d.length:B[K+1]),et=m.subarray(C[K],Z?m.length:C[K+1]),We=ue.length>0;break;case 3:Qe="lines",ue=d.subarray(B[K],Z?d.length:B[K+1]),Ge=u.subarray(I[K],Z?u.length:I[K+1]),We=ue.length>0&&Ge.length>0;break;case 4:Qe="lines",ue=d.subarray(B[K],Z?d.length:B[K+1]),Ge=rf(ue,u.subarray(I[K],Z?u.length:I[K+1])),We=ue.length>0&&Ge.length>0;break;default:continue}We&&(i.createMesh(we.apply(me,{id:Ce,textureSetId:$e,origin:Se,primitive:Qe,positionsCompressed:ue,normalsCompressed:X,uv:Ze&&Ze.length>0?Ze:null,colorsCompressed:et,indices:Ge,edgeIndices:Bt,positionsDecodeMatrix:ne,color:Ke,metallic:nt,roughness:ht,opacity:ot})),De.push(Ce))}}De.length>0&&i.createEntity(we.apply(de,{id:_e,isObject:!0,meshIds:De}))}}}function rf(r,e){const t=[];if(e.length>1)for(let i=0,s=e.length-1;i<s;i++)t.push(e[i]),t.push(e[i+1]);else if(r.length>1)for(let i=0,s=r.length/3-1;i<s;i++)t.push(i),t.push(i+1);return t}const of={version:10,parse:function(r,e,t,i,s,o){const a=EF(t),n=IF(a);SF(r,e,n,i,s,o)}},rs=A.vec4(),nf=A.vec4(),TF=9;function DF(r){const e=function(){const s=new ArrayBuffer(2);return new Uint16Array(s)[0]=1,new Uint8Array(s)[0]!==1}(),t=function(){let s=0;const o=new DataView(r);return function(a){const n=1+2*s++,l=o.getUint32(n*4,!0),c=o.getUint32((n+1)*4,!0),h=a.BYTES_PER_ELEMENT;if(e&&h>1){const d=new Uint8Array(r,l,c),p=h/2,m=d.length/h;for(let g=0;g<m;g++){const u=g*h;for(let x=0;x<p;x++){const y=u+x,P=u-x+h-1,_=d[y];d[y]=d[P],d[P]=_}}}return new a(r,l,c/h)}}(),i=function(){const s=new TextDecoder;return()=>JSON.parse(s.decode(t(Uint8Array)))}();return{metadata:i(),textureData:t(Uint8Array),eachTextureDataPortion:t(Uint32Array),eachTextureAttributes:t(Uint16Array),positions:t(Uint16Array),normals:t(Int8Array),colors:t(Uint8Array),uvs:t(Float32Array),indices:t(Uint32Array),edgeIndices:t(Uint32Array),eachTextureSetTextures:t(Int32Array),matrices:t(Float32Array),reusedGeometriesDecodeMatrix:t(Float32Array),eachGeometryPrimitiveType:t(Uint8Array),eachGeometryPositionsPortion:t(Uint32Array),eachGeometryNormalsPortion:t(Uint32Array),eachGeometryColorsPortion:t(Uint32Array),eachGeometryUVsPortion:t(Uint32Array),eachGeometryIndicesPortion:t(Uint32Array),eachGeometryEdgeIndicesPortion:t(Uint32Array),eachMeshGeometriesPortion:t(Uint32Array),eachMeshMatricesPortion:t(Uint32Array),eachMeshTextureSet:t(Int32Array),eachMeshMaterialAttributes:t(Uint8Array),eachEntityId:i(),eachEntityMeshesPortion:t(Uint32Array),eachTileAABB:t(Float64Array),eachTileEntitiesPortion:t(Uint32Array)}}const RF=function(){const r=new Float32Array(3);return function(e){return r[0]=e[0]/255,r[1]=e[1]/255,r[2]=e[2]/255,r}}();(function(){const r=document.createElement("canvas"),e=r.getContext("2d");return function(t){return r.width=t.width,r.height=t.height,e.putImageData(t,0,0),r.toDataURL()}})();function LF(r,e,t,i,s,o){const a=o.getNextId(),n=t.metadata,l=t.textureData,c=t.eachTextureDataPortion,h=t.eachTextureAttributes,d=t.positions,p=t.normals,m=t.colors,g=t.uvs,u=t.indices,x=t.edgeIndices,y=t.eachTextureSetTextures,P=t.matrices,_=t.reusedGeometriesDecodeMatrix,b=t.eachGeometryPrimitiveType,B=t.eachGeometryPositionsPortion,w=t.eachGeometryNormalsPortion,C=t.eachGeometryColorsPortion,E=t.eachGeometryUVsPortion,I=t.eachGeometryIndicesPortion,R=t.eachGeometryEdgeIndicesPortion,F=t.eachMeshGeometriesPortion,z=t.eachMeshMatricesPortion,Q=t.eachMeshTextureSet,H=t.eachMeshMaterialAttributes,ae=t.eachEntityId,pe=t.eachEntityMeshesPortion,ge=t.eachTileAABB,fe=t.eachTileEntitiesPortion,Me=c.length,be=y.length/5,Fe=B.length,Re=F.length,Te=pe.length,Ne=fe.length;s&&s.loadData(n,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds});for(let D=0;D<Me;D++){const G=D===Me-1,se=c[D],le=G?l.length:c[D+1],oe=le-se>0,Y=D*TF,ne=h[Y+0]===1,Ae=h[Y+1];h[Y+2],h[Y+3];const $=h[Y+4],J=h[Y+5],_e=h[Y+6],re=h[Y+7],he=h[Y+8];if(oe){const xe=new Uint8Array(l.subarray(se,le)).buffer,De=`${a}-texture-${D}`;if(ne)i.createTexture({id:De,buffers:[xe],minFilter:$,magFilter:J,wrapS:_e,wrapT:re,wrapR:he});else{const ie=Ae===wf?"image/jpeg":Ae===Cf?"image/png":"image/gif",de=new Blob([xe],{type:ie}),ye=(window.URL||window.webkitURL).createObjectURL(de),K=document.createElement("img");K.src=ye,i.createTexture({id:De,image:K,minFilter:$,magFilter:J,wrapS:_e,wrapT:re,wrapR:he})}}}for(let D=0;D<be;D++){const G=D*5,se=`${a}-textureSet-${D}`,le=y[G+0],te=y[G+1],oe=y[G+2],Y=y[G+3],ne=y[G+4];i.createTextureSet({id:se,colorTextureId:le>=0?`${a}-texture-${le}`:null,normalsTextureId:oe>=0?`${a}-texture-${oe}`:null,metallicRoughnessTextureId:te>=0?`${a}-texture-${te}`:null,emissiveTextureId:Y>=0?`${a}-texture-${Y}`:null,occlusionTextureId:ne>=0?`${a}-texture-${ne}`:null})}const Be=new Uint32Array(Fe);for(let D=0;D<Re;D++){const G=F[D];Be[G]!==void 0?Be[G]++:Be[G]=1}const Se=A.vec3(),S=A.AABB3(),k={};for(let D=0;D<Ne;D++){const G=Ne-1,se=D===G,le=fe[D],te=se?Te-1:fe[D+1]-1,oe=D*6,Y=ge.subarray(oe,oe+6);A.getAABB3Center(Y,Se),S[0]=Y[0]-Se[0],S[1]=Y[1]-Se[1],S[2]=Y[2]-Se[2],S[3]=Y[3]-Se[0],S[4]=Y[4]-Se[1],S[5]=Y[5]-Se[2];const ne=at.createPositionsDecodeMatrix(S),Ae={};for(let $=le;$<=te;$++){const J=ae[$],_e=e.globalizeObjectIds?A.globalizeObjectId(i.id,J):J,re=Te-1,he=$===re,ce=pe[$],xe=he?F.length-1:pe[$+1]-1,De=[],ie=r.metaScene.metaObjects[_e],de={},me={};if(ie){if(e.excludeTypesMap&&ie.type&&e.excludeTypesMap[ie.type]||e.includeTypesMap&&ie.type&&!e.includeTypesMap[ie.type])continue;const ye=e.objectDefaults?e.objectDefaults[ie.type]||e.objectDefaults.DEFAULT:null;ye&&(ye.visible===!1&&(de.visible=!1),ye.pickable===!1&&(de.pickable=!1),ye.colorize&&(me.color=ye.colorize),ye.opacity!==void 0&&ye.opacity!==null&&(me.opacity=ye.opacity),ye.metallic!==void 0&&ye.metallic!==null&&(me.metallic=ye.metallic),ye.roughness!==void 0&&ye.roughness!==null&&(me.roughness=ye.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let ye=ce;ye<=xe;ye++){const K=F[ye],je=Be[K]>1,Z=K===Fe-1,qe=Q[ye],$e=qe>=0?`${a}-textureSet-${qe}`:null,Ke=RF(H.subarray(ye*6,ye*6+3)),ot=H[ye*6+3]/255,nt=H[ye*6+4]/255,ht=H[ye*6+5]/255,Ce=o.getNextId();if(je){const He=z[ye],Qe=P.slice(He,He+16),ue=`${a}-geometry.${D}.${K}`;let X=k[ue];if(!X){X={batchThisMesh:!e.reuseGeometries};const Ze=b[K];let et=!1;switch(Ze){case 0:X.primitiveName="solid",X.geometryPositions=d.subarray(B[K],Z?d.length:B[K+1]),X.geometryNormals=p.subarray(w[K],Z?p.length:w[K+1]),X.geometryUVs=g.subarray(E[K],Z?g.length:E[K+1]),X.geometryIndices=u.subarray(I[K],Z?u.length:I[K+1]),X.geometryEdgeIndices=x.subarray(R[K],Z?x.length:R[K+1]),et=X.geometryPositions.length>0&&X.geometryIndices.length>0;break;case 1:X.primitiveName="surface",X.geometryPositions=d.subarray(B[K],Z?d.length:B[K+1]),X.geometryNormals=p.subarray(w[K],Z?p.length:w[K+1]),X.geometryUVs=g.subarray(E[K],Z?g.length:E[K+1]),X.geometryIndices=u.subarray(I[K],Z?u.length:I[K+1]),X.geometryEdgeIndices=x.subarray(R[K],Z?x.length:R[K+1]),et=X.geometryPositions.length>0&&X.geometryIndices.length>0;break;case 2:X.primitiveName="points",X.geometryPositions=d.subarray(B[K],Z?d.length:B[K+1]),X.geometryColors=m.subarray(C[K],Z?m.length:C[K+1]),et=X.geometryPositions.length>0;break;case 3:X.primitiveName="lines",X.geometryPositions=d.subarray(B[K],Z?d.length:B[K+1]),X.geometryIndices=u.subarray(I[K],Z?u.length:I[K+1]),et=X.geometryPositions.length>0&&X.geometryIndices.length>0;break;case 4:X.primitiveName="lines",X.geometryPositions=d.subarray(B[K],Z?d.length:B[K+1]),X.geometryIndices=af(X.geometryPositions,u.subarray(I[K],Z?u.length:I[K+1])),et=X.geometryPositions.length>0&&X.geometryIndices.length>0;break;default:continue}if(et||(X=null),X&&(X.geometryPositions.length>1e3,X.batchThisMesh)){X.decompressedPositions=new Float32Array(X.geometryPositions.length),X.transformedAndRecompressedPositions=new Uint16Array(X.geometryPositions.length);const Ge=X.geometryPositions,Bt=X.decompressedPositions;for(let We=0,Pi=Ge.length;We<Pi;We+=3)Bt[We+0]=Ge[We+0]*_[0]+_[12],Bt[We+1]=Ge[We+1]*_[5]+_[13],Bt[We+2]=Ge[We+2]*_[10]+_[14];X.geometryPositions=null,k[ue]=X}}if(X)if(X.batchThisMesh){const Ze=X.decompressedPositions,et=X.transformedAndRecompressedPositions;for(let Ge=0,Bt=Ze.length;Ge<Bt;Ge+=3)rs[0]=Ze[Ge+0],rs[1]=Ze[Ge+1],rs[2]=Ze[Ge+2],rs[3]=1,A.transformVec4(Qe,rs,nf),at.compressPosition(nf,S,rs),et[Ge+0]=rs[0],et[Ge+1]=rs[1],et[Ge+2]=rs[2];i.createMesh(we.apply(me,{id:Ce,textureSetId:$e,origin:Se,primitive:X.primitiveName,positionsCompressed:et,normalsCompressed:X.geometryNormals,uv:X.geometryUVs,colorsCompressed:X.geometryColors,indices:X.geometryIndices,edgeIndices:X.geometryEdgeIndices,positionsDecodeMatrix:ne,color:Ke,metallic:nt,roughness:ht,opacity:ot})),De.push(Ce)}else Ae[ue]||(i.createGeometry({id:ue,primitive:X.primitiveName,positionsCompressed:X.geometryPositions,normalsCompressed:X.geometryNormals,uv:X.geometryUVs,colorsCompressed:X.geometryColors,indices:X.geometryIndices,edgeIndices:X.geometryEdgeIndices,positionsDecodeMatrix:_}),Ae[ue]=!0),i.createMesh(we.apply(me,{id:Ce,geometryId:ue,textureSetId:$e,matrix:Qe,color:Ke,metallic:nt,roughness:ht,opacity:ot,origin:Se})),De.push(Ce)}else{const He=b[K];let Qe,ue,X,Ze,et,Ge,Bt,We=!1;switch(He){case 0:Qe="solid",ue=d.subarray(B[K],Z?d.length:B[K+1]),X=p.subarray(w[K],Z?p.length:w[K+1]),Ze=g.subarray(E[K],Z?g.length:E[K+1]),Ge=u.subarray(I[K],Z?u.length:I[K+1]),Bt=x.subarray(R[K],Z?x.length:R[K+1]),We=ue.length>0&&Ge.length>0;break;case 1:Qe="surface",ue=d.subarray(B[K],Z?d.length:B[K+1]),X=p.subarray(w[K],Z?p.length:w[K+1]),Ze=g.subarray(E[K],Z?g.length:E[K+1]),Ge=u.subarray(I[K],Z?u.length:I[K+1]),Bt=x.subarray(R[K],Z?x.length:R[K+1]),We=ue.length>0&&Ge.length>0;break;case 2:Qe="points",ue=d.subarray(B[K],Z?d.length:B[K+1]),et=m.subarray(C[K],Z?m.length:C[K+1]),We=ue.length>0;break;case 3:Qe="lines",ue=d.subarray(B[K],Z?d.length:B[K+1]),Ge=u.subarray(I[K],Z?u.length:I[K+1]),We=ue.length>0&&Ge.length>0;break;case 4:Qe="lines",ue=d.subarray(B[K],Z?d.length:B[K+1]),Ge=af(ue,u.subarray(I[K],Z?u.length:I[K+1])),We=ue.length>0&&Ge.length>0;break;default:continue}We&&(i.createMesh(we.apply(me,{id:Ce,textureSetId:$e,origin:Se,primitive:Qe,positionsCompressed:ue,normalsCompressed:X,uv:Ze&&Ze.length>0?Ze:null,colorsCompressed:et,indices:Ge,edgeIndices:Bt,positionsDecodeMatrix:ne,color:Ke,metallic:nt,roughness:ht,opacity:ot})),De.push(Ce))}}De.length>0&&i.createEntity(we.apply(de,{id:_e,isObject:!0,meshIds:De}))}}}function af(r,e){const t=[];if(e.length>1)for(let i=0,s=e.length-1;i<s;i++)t.push(e[i]),t.push(e[i+1]);else if(r.length>1)for(let i=0,s=r.length/3-1;i<s;i++)t.push(i),t.push(i+1);return t}const lf={version:11,parseArrayBuffer:function(r,e,t,i,s,o){const a=DF(t);LF(r,e,a,i,s,o)}},di={};di[jp.version]=jp;di[zp.version]=zp;di[Gp.version]=Gp;di[Wp.version]=Wp;di[Kp.version]=Kp;di[Xp.version]=Xp;di[$p.version]=$p;di[Jp.version]=Jp;di[tf.version]=tf;di[of.version]=of;di[lf.version]=lf;class KF extends Ro{constructor(e,t={}){super("XKTLoader",e,t),this._maxGeometryBatchSize=t.maxGeometryBatchSize,this.textureTranscoder=t.textureTranscoder,this.dataSource=t.dataSource,this.objectDefaults=t.objectDefaults,this.includeTypes=t.includeTypes,this.excludeTypes=t.excludeTypes,this.excludeUnclassifiedObjects=t.excludeUnclassifiedObjects,this.reuseGeometries=t.reuseGeometries}get supportedVersions(){return Object.keys(di)}get textureTranscoder(){return this._textureTranscoder}set textureTranscoder(e){this._textureTranscoder=e}get dataSource(){return this._dataSource}set dataSource(e){this._dataSource=e||new zI}get objectDefaults(){return this._objectDefaults}set objectDefaults(e){this._objectDefaults=e||OI}get includeTypes(){return this._includeTypes}set includeTypes(e){this._includeTypes=e}get excludeTypes(){return this._excludeTypes}set excludeTypes(e){this._excludeTypes=e}get excludeUnclassifiedObjects(){return this._excludeUnclassifiedObjects}set excludeUnclassifiedObjects(e){this._excludeUnclassifiedObjects=!!e}get globalizeObjectIds(){return this._globalizeObjectIds}set globalizeObjectIds(e){this._globalizeObjectIds=!!e}get reuseGeometries(){return this._reuseGeometries}set reuseGeometries(e){this._reuseGeometries=e!==!1}load(e={}){if(e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id),!e.src&&!e.xkt&&!e.manifestSrc&&!e.manifest)throw new Error("XKTLoaderPlugin: load() param expected: src, xkt, manifestSrc or manifestData");const t={},i=e.includeTypes||this._includeTypes,s=e.excludeTypes||this._excludeTypes,o=e.objectDefaults||this._objectDefaults;if(t.reuseGeometries=e.reuseGeometries!==null&&e.reuseGeometries!==void 0?e.reuseGeometries:this._reuseGeometries!==!1,i){t.includeTypesMap={};for(let m=0,g=i.length;m<g;m++)t.includeTypesMap[i[m]]=!0}if(s){t.excludeTypesMap={};for(let m=0,g=s.length;m<g;m++)t.excludeTypesMap[s[m]]=!0}o&&(t.objectDefaults=o),t.excludeUnclassifiedObjects=e.excludeUnclassifiedObjects!==void 0?!!e.excludeUnclassifiedObjects:this._excludeUnclassifiedObjects,t.globalizeObjectIds=e.globalizeObjectIds!==void 0&&e.globalizeObjectIds!==null?!!e.globalizeObjectIds:this._globalizeObjectIds;const a=new Xb(this.viewer.scene,we.apply(e,{isModel:!0,textureTranscoder:this._textureTranscoder,maxGeometryBatchSize:this._maxGeometryBatchSize,origin:e.origin,disableVertexWelding:e.disableVertexWelding||!1,disableIndexRebucketing:e.disableIndexRebucketing||!1,dtxEnabled:e.dtxEnabled,renderOrder:e.renderOrder})),n=a.id,l=new Nf({metaScene:this.viewer.metaScene,id:n});this.viewer.scene.canvas.spinner.processes++;const c=()=>{a.destroyed||(a.finalize(),l.finalize(),this.viewer.scene.canvas.spinner.processes--,a.once("destroyed",()=>{this.viewer.metaScene.destroyMetaModel(l.id)}),this.scheduleTask(()=>{a.destroyed||(a.scene.fire("modelLoaded",a.id),a.fire("loaded",!0,!1))}))},h=m=>{this.viewer.scene.canvas.spinner.processes--,this.error(m),a.fire("error",m)};let d=0;const p={getNextId:()=>`${n}.${d++}`};if(e.metaModelSrc||e.metaModelData)if(e.metaModelSrc){const m=e.metaModelSrc;this._dataSource.getMetaModel(m,g=>{a.destroyed||(l.loadData(g,{includeTypes:i,excludeTypes:s,globalizeObjectIds:t.globalizeObjectIds}),e.src?this._loadModel(e.src,t,a,null,p,c,h):(this._parseModel(e.xkt,t,a,null,p),c()))},g=>{h(`load(): Failed to load model metadata for model '${n} from  '${m}' - ${g}`)})}else e.metaModelData&&(l.loadData(e.metaModelData,{includeTypes:i,excludeTypes:s,globalizeObjectIds:t.globalizeObjectIds}),e.src?this._loadModel(e.src,t,a,null,p,c,h):(this._parseModel(e.xkt,t,a,null,p),c()));else if(e.src)this._loadModel(e.src,t,a,l,p,c,h);else if(e.xkt)this._parseModel(e.xkt,t,a,l,p),c();else if(e.manifestSrc||e.manifest){const m=e.manifestSrc?UF(e.manifestSrc):"",g=(y,P,_)=>{let b=0;const B=()=>{a.destroyed||b>=y.length?P():this._dataSource.getMetaModel(`${m}${y[b]}`,w=>{l.loadData(w,{includeTypes:i,excludeTypes:s,globalizeObjectIds:t.globalizeObjectIds}),b++,this.scheduleTask(B,200)},_)};B()},u=(y,P,_)=>{let b=0;const B=()=>{a.destroyed||b>=y.length?P():this._dataSource.getXKT(`${m}${y[b]}`,w=>{this._parseModel(w,t,a,null,p),a.preFinalize(),b++,this.scheduleTask(B,200)},_)};B()},x=(y,P,_)=>{let b=0;const B=()=>{a.destroyed||b>=y.length?P():this._dataSource.getXKT(`${m}${y[b]}`,w=>{this._parseModel(w,t,a,l,p),a.preFinalize(),b++,this.scheduleTask(B,200)},_)};B()};if(e.manifest){const y=e.manifest,P=y.xktFiles;if(!P||P.length===0){h("load(): Failed to load model manifest - manifest not valid");return}const _=y.metaModelFiles;_?g(_,()=>{u(P,c,h)},h):x(P,c,h)}else this._dataSource.getManifest(e.manifestSrc,y=>{if(a.destroyed)return;const P=y.xktFiles;if(!P||P.length===0){h("load(): Failed to load model manifest - manifest not valid");return}const _=y.metaModelFiles;_?g(_,()=>{u(P,c,h)},h):x(P,c,h)},h)}return a}_loadModel(e,t,i,s,o,a,n){this._dataSource.getXKT(e,l=>{this._parseModel(l,t,i,s,o),i.preFinalize(),a()},n)}async _parseModel(e,t,i,s,o){if(i.destroyed)return;const a=new DataView(e),n=new Uint8Array(e),l=a.getUint32(0,!0),c=di[l];if(!c){this.error("Unsupported .XKT file version: "+l+" - this XKTLoaderPlugin supports versions "+Object.keys(di));return}if(c.parseArrayBuffer){c.parseArrayBuffer(this.viewer,t,e,i,s,o);return}const h=a.getUint32(4,!0),d=[];let p=(h+2)*4;for(let m=0;m<h;m++){const g=a.getUint32((m+2)*4,!0);d.push(n.subarray(p,p+g)),p+=g}c.parse(this.viewer,t,d,i,s,o)}}function UF(r){r.indexOf("?")>-1&&(r=r.split("?")[0]);const e=r.split("/");return e.pop(),e.join("/")+"/"}var Zm={};(function(r){var e="File format is not recognized.",t="CRC failed.",i="File contains encrypted entry.",s="File is using Zip64 (4gb+ file size).",o="Error while reading zip file.",a="Error while writing zip file.",n="Error while writing file data.",l="Error while reading file data.",c="File already exists.",h=524288,d="text/plain",p;try{p=new Blob([new DataView(new ArrayBuffer(0))]).size===0}catch{}function m(){this.crc=-1}m.prototype.append=function(k){for(var D=this.crc|0,G=this.table,se=0,le=k.length|0;se<le;se++)D=D>>>8^G[(D^k[se])&255];this.crc=D},m.prototype.get=function(){return~this.crc},m.prototype.table=function(){var S,k,D,G=[];for(S=0;S<256;S++){for(D=S,k=0;k<8;k++)D&1?D=D>>>1^3988292384:D=D>>>1;G[S]=D}return G}();function g(){}g.prototype.append=function(k,D){return k},g.prototype.flush=function(){};function u(S,k,D){if(k<0||D<0||k+D>S.size)throw new RangeError("offset:"+k+", length:"+D+", size:"+S.size);if(S.slice)return S.slice(k,k+D);if(S.webkitSlice)return S.webkitSlice(k,k+D);if(S.mozSlice)return S.mozSlice(k,k+D);if(S.msSlice)return S.msSlice(k,k+D)}function x(S,k){var D,G;return D=new ArrayBuffer(S),G=new Uint8Array(D),k&&G.set(k,0),{buffer:D,array:G,view:new DataView(D)}}function y(){}function P(S){var k=this,D;function G(le,te){var oe=new Blob([S],{type:d});D=new b(oe),D.init(function(){k.size=D.size,le()},te)}function se(le,te,oe,Y){D.readUint8Array(le,te,oe,Y)}k.size=0,k.init=G,k.readUint8Array=se}P.prototype=new y,P.prototype.constructor=P;function _(S){var k=this,D;function G(le){for(var te=S.length;S.charAt(te-1)=="=";)te--;D=S.indexOf(",")+1,k.size=Math.floor((te-D)*.75),le()}function se(le,te,oe){var Y,ne=x(te),Ae=Math.floor(le/3)*4,$=Math.ceil((le+te)/3)*4,J=r.atob(S.substring(Ae+D,$+D)),_e=le-Math.floor(Ae/4)*3;for(Y=_e;Y<_e+te;Y++)ne.array[Y-_e]=J.charCodeAt(Y);oe(ne.array)}k.size=0,k.init=G,k.readUint8Array=se}_.prototype=new y,_.prototype.constructor=_;function b(S){var k=this;function D(se){k.size=S.size,se()}function G(se,le,te,oe){var Y=new FileReader;Y.onload=function(ne){te(new Uint8Array(ne.target.result))},Y.onerror=oe;try{Y.readAsArrayBuffer(u(S,se,le))}catch(ne){oe(ne)}}k.size=0,k.init=D,k.readUint8Array=G}b.prototype=new y,b.prototype.constructor=b;function B(){}B.prototype.getData=function(S){S(this.data)};function w(S){var k=this,D;function G(te){D=new Blob([],{type:d}),te()}function se(te,oe){D=new Blob([D,p?te:te.buffer],{type:d}),oe()}function le(te,oe){var Y=new FileReader;Y.onload=function(ne){te(ne.target.result)},Y.onerror=oe,Y.readAsText(D,S)}k.init=G,k.writeUint8Array=se,k.getData=le}w.prototype=new B,w.prototype.constructor=w;function C(S){var k=this,D="",G="";function se(oe){D+="data:"+(S||"")+";base64,",oe()}function le(oe,Y){var ne,Ae=G.length,$=G;for(G="",ne=0;ne<Math.floor((Ae+oe.length)/3)*3-Ae;ne++)$+=String.fromCharCode(oe[ne]);for(;ne<oe.length;ne++)G+=String.fromCharCode(oe[ne]);$.length>2?D+=r.btoa($):G=$,Y()}function te(oe){oe(D+r.btoa(G))}k.init=se,k.writeUint8Array=le,k.getData=te}C.prototype=new B,C.prototype.constructor=C;function E(S){var k,D=this;function G(te){k=new Blob([],{type:S}),te()}function se(te,oe){k=new Blob([k,p?te:te.buffer],{type:S}),oe()}function le(te){te(k)}D.init=G,D.writeUint8Array=se,D.getData=le}E.prototype=new B,E.prototype.constructor=E;function I(S,k,D,G,se,le,te,oe,Y,ne){var Ae=0,$,J,_e=k.sn,re;function he(){S.removeEventListener("message",ce,!1),oe(J,re)}function ce(De){var ie=De.data,de=ie.data,me=ie.error;if(me){me.toString=function(){return"Error: "+this.message},Y(me);return}if(ie.sn===_e)switch(typeof ie.codecTime=="number"&&(S.codecTime+=ie.codecTime),typeof ie.crcTime=="number"&&(S.crcTime+=ie.crcTime),ie.type){case"append":de?(J+=de.length,G.writeUint8Array(de,function(){xe()},ne)):xe();break;case"flush":re=ie.crc,de?(J+=de.length,G.writeUint8Array(de,function(){he()},ne)):he();break;case"progress":te&&te($+ie.loaded,le);break;case"importScripts":case"newTask":case"echo":break;default:console.warn("zip.js:launchWorkerProcess: unknown message: ",ie)}}function xe(){$=Ae*h,$<=le?D.readUint8Array(se+$,Math.min(h,le-$),function(De){te&&te($,le);var ie=$===0?k:{sn:_e};ie.type="append",ie.data=De;try{S.postMessage(ie,[De.buffer])}catch{S.postMessage(ie)}Ae++},Y):S.postMessage({sn:_e,type:"flush"})}J=0,S.addEventListener("message",ce,!1),xe()}function R(S,k,D,G,se,le,te,oe,Y,ne){var Ae=0,$,J=0,_e=le==="input",re=le==="output",he=new m;function ce(){var xe;if($=Ae*h,$<se)k.readUint8Array(G+$,Math.min(h,se-$),function(De){var ie;try{ie=S.append(De,function(de){te&&te($+de,se)})}catch(de){Y(de);return}ie?(J+=ie.length,D.writeUint8Array(ie,function(){Ae++,setTimeout(ce,1)},ne),re&&he.append(ie)):(Ae++,setTimeout(ce,1)),_e&&he.append(De),te&&te($,se)},Y);else{try{xe=S.flush()}catch(De){Y(De);return}xe?(re&&he.append(xe),J+=xe.length,D.writeUint8Array(xe,function(){oe(J,he.get())},ne)):oe(J,he.get())}}ce()}function F(S,k,D,G,se,le,te,oe,Y,ne,Ae){var $=te?"output":"none";if(r.zip.useWebWorkers){var J={sn:k,codecClass:"Inflater",crcType:$};I(S,J,D,G,se,le,Y,oe,ne,Ae)}else R(new r.zip.Inflater,D,G,se,le,$,Y,oe,ne,Ae)}function z(S,k,D,G,se,le,te,oe,Y){var ne="input";if(r.zip.useWebWorkers){var Ae={sn:k,options:{level:se},codecClass:"Deflater",crcType:ne};I(S,Ae,D,G,0,D.size,te,le,oe,Y)}else R(new r.zip.Deflater,D,G,0,D.size,ne,te,le,oe,Y)}function Q(S,k,D,G,se,le,te,oe,Y,ne,Ae){var $="input";if(r.zip.useWebWorkers&&te){var J={sn:k,codecClass:"NOOP",crcType:$};I(S,J,D,G,se,le,Y,oe,ne,Ae)}else R(new g,D,G,se,le,$,Y,oe,ne,Ae)}function H(S){var k,D="",G,se=["Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","ø","£","Ø","×","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","®","¬","½","¼","¡","«","»","_","_","_","¦","¦","Á","Â","À","©","¦","¦","+","+","¢","¥","+","+","-","-","+","-","+","ã","Ã","+","+","-","-","¦","-","+","¤","ð","Ð","Ê","Ë","È","i","Í","Î","Ï","+","+","_","_","¦","Ì","_","Ó","ß","Ô","Ò","õ","Õ","µ","þ","Þ","Ú","Û","Ù","ý","Ý","¯","´","­","±","_","¾","¶","§","÷","¸","°","¨","·","¹","³","²","_"," "];for(k=0;k<S.length;k++)G=S.charCodeAt(k)&255,G>127?D+=se[G-128]:D+=String.fromCharCode(G);return D}function ae(S){return decodeURIComponent(escape(S))}function pe(S){var k,D="";for(k=0;k<S.length;k++)D+=String.fromCharCode(S[k]);return D}function ge(S){var k=(S&4294901760)>>16,D=S&65535;try{return new Date(1980+((k&65024)>>9),((k&480)>>5)-1,k&31,(D&63488)>>11,(D&2016)>>5,(D&31)*2,0)}catch{}}function fe(S,k,D,G,se){if(S.version=k.view.getUint16(D,!0),S.bitFlag=k.view.getUint16(D+2,!0),S.compressionMethod=k.view.getUint16(D+4,!0),S.lastModDateRaw=k.view.getUint32(D+6,!0),S.lastModDate=ge(S.lastModDateRaw),(S.bitFlag&1)===1){se(i);return}if((G||(S.bitFlag&8)!=8)&&(S.crc32=k.view.getUint32(D+10,!0),S.compressedSize=k.view.getUint32(D+14,!0),S.uncompressedSize=k.view.getUint32(D+18,!0)),S.compressedSize===4294967295||S.uncompressedSize===4294967295){se(s);return}S.filenameLength=k.view.getUint16(D+22,!0),S.extraFieldLength=k.view.getUint16(D+24,!0)}function Me(S,k,D){var G=0;function se(){}se.prototype.getData=function(oe,Y,ne,Ae){var $=this;function J(ce){var xe=x(4);return xe.view.setUint32(0,ce),$.crc32==xe.view.getUint32(0)}function _e(ce,xe){Ae&&!J(xe)?D(t):oe.getData(function(De){Y(De)})}function re(ce){D(ce||l)}function he(ce){D(ce||n)}S.readUint8Array($.offset,30,function(ce){var xe=x(ce.length,ce),De;if(xe.view.getUint32(0)!=1347093252){D(e);return}fe($,xe,4,!1,D),De=$.offset+30+$.filenameLength+$.extraFieldLength,oe.init(function(){$.compressionMethod===0?Q($._worker,G++,S,oe,De,$.compressedSize,Ae,_e,ne,re,he):F($._worker,G++,S,oe,De,$.compressedSize,Ae,_e,ne,re,he)},he)},re)};function le(oe){var Y=22;if(S.size<Y){D(e);return}var ne=256*256,Ae=Y+ne;$(Y,function(){$(Math.min(Ae,S.size),function(){D(e)})});function $(J,_e){S.readUint8Array(S.size-J,J,function(re){for(var he=re.length-Y;he>=0;he--)if(re[he]===80&&re[he+1]===75&&re[he+2]===5&&re[he+3]===6){oe(new DataView(re.buffer,he,Y));return}_e()},function(){D(o)})}}var te={getEntries:function(oe){var Y=this._worker;le(function(ne){var Ae,$;if(Ae=ne.getUint32(16,!0),$=ne.getUint16(8,!0),Ae<0||Ae>=S.size){D(e);return}S.readUint8Array(Ae,S.size-Ae,function(J){var _e,re=0,he=[],ce,xe,De,ie=x(J.length,J);for(_e=0;_e<$;_e++){if(ce=new se,ce._worker=Y,ie.view.getUint32(re)!=1347092738){D(e);return}fe(ce,ie,re+6,!0,D),ce.commentLength=ie.view.getUint16(re+32,!0),ce.directory=(ie.view.getUint8(re+38)&16)==16,ce.offset=ie.view.getUint32(re+42,!0),xe=pe(ie.array.subarray(re+46,re+46+ce.filenameLength)),ce.filename=(ce.bitFlag&2048)===2048?ae(xe):H(xe),!ce.directory&&ce.filename.charAt(ce.filename.length-1)=="/"&&(ce.directory=!0),De=pe(ie.array.subarray(re+46+ce.filenameLength+ce.extraFieldLength,re+46+ce.filenameLength+ce.extraFieldLength+ce.commentLength)),ce.comment=(ce.bitFlag&2048)===2048?ae(De):H(De),he.push(ce),re+=46+ce.filenameLength+ce.extraFieldLength+ce.commentLength}oe(he)},function(){D(o)})})},close:function(oe){this._worker&&(this._worker.terminate(),this._worker=null),oe&&oe()},_worker:null};r.zip.useWebWorkers?Be("inflater",function(oe){te._worker=oe,k(te)},function(oe){D(oe)}):k(te)}function be(S){return unescape(encodeURIComponent(S))}function Fe(S){var k,D=[];for(k=0;k<S.length;k++)D.push(S.charCodeAt(k));return D}function Re(S,k,D,G){var se={},le=[],te=0,oe=0;function Y($){D($||a)}function ne($){D($||l)}var Ae={add:function($,J,_e,re,he){var ce,xe,De,ie=this._worker;function de(K){var Le;De=he.lastModDate||new Date,ce=x(26),se[$]={headerArray:ce.array,directory:he.directory,filename:xe,offset:te,comment:Fe(be(he.comment||""))},ce.view.setUint32(0,335546376),he.version&&ce.view.setUint8(0,he.version),!G&&he.level!==0&&!he.directory&&ce.view.setUint16(4,2048),ce.view.setUint16(6,(De.getHours()<<6|De.getMinutes())<<5|De.getSeconds()/2,!0),ce.view.setUint16(8,(De.getFullYear()-1980<<4|De.getMonth()+1)<<5|De.getDate(),!0),ce.view.setUint16(22,xe.length,!0),Le=x(30+xe.length),Le.view.setUint32(0,1347093252),Le.array.set(ce.array,4),Le.array.set(xe,30),te+=Le.array.length,S.writeUint8Array(Le.array,K,Y)}function me(K,Le){var je=x(16);te+=K||0,je.view.setUint32(0,1347094280),typeof Le<"u"&&(ce.view.setUint32(10,Le,!0),je.view.setUint32(4,Le,!0)),J&&(je.view.setUint32(8,K,!0),ce.view.setUint32(14,K,!0),je.view.setUint32(12,J.size,!0),ce.view.setUint32(18,J.size,!0)),S.writeUint8Array(je.array,function(){te+=16,_e()},Y)}function ye(){if(he=he||{},$=$.trim(),he.directory&&$.charAt($.length-1)!="/"&&($+="/"),se.hasOwnProperty($)){D(c);return}xe=Fe(be($)),le.push($),de(function(){J?G||he.level===0?Q(ie,oe++,J,S,0,J.size,!0,me,re,ne,Y):z(ie,oe++,J,S,he.level,me,re,ne,Y):me()})}J?J.init(ye,ne):ye()},close:function($){this._worker&&(this._worker.terminate(),this._worker=null);var J,_e=0,re=0,he,ce;for(he=0;he<le.length;he++)ce=se[le[he]],_e+=46+ce.filename.length+ce.comment.length;for(J=x(_e+22),he=0;he<le.length;he++)ce=se[le[he]],J.view.setUint32(re,1347092738),J.view.setUint16(re+4,5120),J.array.set(ce.headerArray,re+6),J.view.setUint16(re+32,ce.comment.length,!0),ce.directory&&J.view.setUint8(re+38,16),J.view.setUint32(re+42,ce.offset,!0),J.array.set(ce.filename,re+46),J.array.set(ce.comment,re+46+ce.filename.length),re+=46+ce.filename.length+ce.comment.length;J.view.setUint32(re,1347093766),J.view.setUint16(re+8,le.length,!0),J.view.setUint16(re+10,le.length,!0),J.view.setUint32(re+12,_e,!0),J.view.setUint32(re+16,te,!0),S.writeUint8Array(J.array,function(){S.getData($)},Y)},_worker:null};r.zip.useWebWorkers?Be("deflater",function($){Ae._worker=$,k(Ae)},function($){D($)}):k(Ae)}function Te(S){var k=document.createElement("a");return S.map(function(D){return k.href=D,k.href})}var Ne={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};function Be(S,k,D){if(r.zip.workerScripts!==null&&r.zip.workerScriptsPath!==null){D(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));return}var G;if(r.zip.workerScripts){if(G=r.zip.workerScripts[S],!Array.isArray(G)){D(new Error("zip.workerScripts."+S+" is not an array!"));return}G=Te(G)}else G=Ne[S].slice(0),G[0]=(r.zip.workerScriptsPath||"")+G[0];var se=new Worker(G[0]);se.codecTime=se.crcTime=0,se.postMessage({type:"importScripts",scripts:G.slice(1)}),se.addEventListener("message",le);function le(oe){var Y=oe.data;if(Y.error){se.terminate(),D(Y.error);return}Y.type==="importScripts"&&(se.removeEventListener("message",le),se.removeEventListener("error",te),k(se))}se.addEventListener("error",te);function te(oe){se.terminate(),D(oe)}}function Se(S){console.error(S)}r.zip={Reader:y,Writer:B,BlobReader:b,Data64URIReader:_,TextReader:P,BlobWriter:E,Data64URIWriter:C,TextWriter:w,createReader:function(S,k,D){D=D||Se,S.init(function(){Me(S,k,D)},D)},createWriter:function(S,k,D,G){D=D||Se,G=!!G,S.init(function(){Re(S,k,D,G)},D)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}})(Zm);const OF=function(r){var e="HTTP Range not supported.",t=r.Reader,i=r.Writer,s,o;try{o=new Blob([new DataView(new ArrayBuffer(0))]).size===0}catch{}function a(p){var m=document.createElement("a");return m.href=p,m.protocol==="http:"||m.protocol==="https:"}function n(p){var m=this;function g(y,P){var _;m.data?y():(_=new XMLHttpRequest,_.addEventListener("load",function(){m.size||(m.size=Number(_.getResponseHeader("Content-Length"))||Number(_.response.byteLength)),m.data=new Uint8Array(_.response),y()},!1),_.addEventListener("error",P,!1),_.open("GET",p),_.responseType="arraybuffer",_.send())}function u(y,P){if(!a(p)){g(y,P);return}var _=new XMLHttpRequest;_.addEventListener("load",function(){m.size=Number(_.getResponseHeader("Content-Length")),m.size?y():g(y,P)},!1),_.addEventListener("error",P,!1),_.open("HEAD",p),_.send()}function x(y,P,_,b){g(function(){_(new Uint8Array(m.data.subarray(y,y+P)))},b)}m.size=0,m.init=u,m.readUint8Array=x}n.prototype=new t,n.prototype.constructor=n;function l(p){var m=this;function g(y,P){var _=new XMLHttpRequest;_.addEventListener("load",function(){m.size=Number(_.getResponseHeader("Content-Length")),_.getResponseHeader("Accept-Ranges")=="bytes"?y():P(e)},!1),_.addEventListener("error",P,!1),_.open("HEAD",p),_.send()}function u(y,P,_,b){var B=new XMLHttpRequest;B.open("GET",p),B.responseType="arraybuffer",B.setRequestHeader("Range","bytes="+y+"-"+(y+P-1)),B.addEventListener("load",function(){_(B.response)},!1),B.addEventListener("error",b,!1),B.send()}function x(y,P,_,b){u(y,P,function(B){_(new Uint8Array(B))},b)}m.size=0,m.init=g,m.readUint8Array=x}l.prototype=new t,l.prototype.constructor=l;function c(p){var m=this;function g(x,y){m.size=p.byteLength,x()}function u(x,y,P,_){P(new Uint8Array(p.slice(x,x+y)))}m.size=0,m.init=g,m.readUint8Array=u}c.prototype=new t,c.prototype.constructor=c;function h(){var p,m=this;function g(y,P){p=new Uint8Array,y()}function u(y,P,_){var b=new Uint8Array(p.length+y.length);b.set(p),b.set(y,p.length),p=b,P()}function x(y){y(p.buffer)}m.init=g,m.writeUint8Array=u,m.getData=x}h.prototype=new i,h.prototype.constructor=h;function d(p,m){var g,u=this;function x(_,b){p.createWriter(function(B){g=B,_()},b)}function y(_,b,B){var w=new Blob([o?_:_.buffer],{type:m});g.onwrite=function(){g.onwrite=null,b()},g.onerror=B,g.write(w)}function P(_){p.file(_)}u.init=x,u.writeUint8Array=y,u.getData=P}d.prototype=new i,d.prototype.constructor=d,r.FileWriter=d,r.HttpReader=n,r.HttpRangeReader=l,r.ArrayBufferReader=c,r.ArrayBufferWriter=h,r.fs&&(s=r.fs.ZipDirectoryEntry,s.prototype.addHttpContent=function(p,m,g){function u(x,y,P,_){if(x.directory)return _?new s(x.fs,y,P,x):new r.fs.ZipFileEntry(x.fs,y,P,x);throw"Parent entry is not a directory."}return u(this,p,{data:m,Reader:g?l:n})},s.prototype.importHttpContent=function(p,m,g,u){this.importZip(m?new l(p):new n(p),g,u)},r.fs.FS.prototype.importHttpContent=function(p,m,g,u){this.entries=[],this.root=new s(this),this.root.importHttpContent(p,m,g,u)})},kF=Zm.zip;OF(kF);A.vec2();A.vec3();A.vec3();A.vec3();export{QF as A,NF as C,VF as D,jF as M,GF as N,HF as P,WF as S,zF as V,KF as X,qb as a,I_ as b,o0 as c,bs as d,A as m};
